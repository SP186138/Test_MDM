/***********************************************************************************************************
SCRIPT:               PRSNA_TRT_STG_VAL.BTEQ 
DESCRIPTION:          This script validates the records received from ETL Staging.
DEPENDENCY:           
INPUT:                ETL Staging
OUTPUT:               MST Staging
ERRORS:
SPECIAL INSTRUCTIONS:

CHANGE LOG:
VERSION              DATE                 AUTHOR                          CHANGES
1.00                 01/21/2011           TERADATA                        INITIAL VERSION
2.00                 08/22/2011           TERADATA                        Change OF Failure-BadFile
3.00                 10/31/2011           TERADATA                        Removal of Deletes as  part of ||elism
4.00                 03/26/2012		  TERADATA                        Made change in insert to LOAD_INFO to
                                                                          manipulate LA data
***********************************************************************************************************/

.logon $TDPID/$TDUSER,$TDPWD
 
.SET ERROROUT STDOUT;
.SET SESSION CHARSET 'UTF8';
.SET ERRORLEVEL 3624 SEVERITY 0



CREATE VOLATILE TABLE V_PRSNA_TRT_STG
AS
(
SELECT A.* FROM $ETL_DB.PRSNA_TRT_STG  A 
JOIN
 VALIDATION_$BTCH B
ON A.LOAD_ID = B.LOAD_ID)
WITH DATA
PRIMARY INDEX (MKTNG_PGM_NBR ,REGIS_CNSMR_ID_VAL )
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE

/* VALIDATION TO CHECK DUPLICATE RECORDS */


INSERT INTO VALIDATION_ERR_$BTCH 
SELECT
DER1.MKTNG_PGM_NBR,
DER1.REGIS_CNSMR_ID_VAL,
DER1.LOAD_ID,
'DUPLICATE TRAIT INFORMATION ON SOURCE FILE' SYS_ERR_CODE,
'PRSNA_TRT_STG'
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
TRT_NBR,
PRSNA_TRT_SEQ_NBR,
STG.LOAD_ID,
RECORD_IND
FROM
V_PRSNA_TRT_STG STG
GROUP BY 1,2,3,4,5,6
HAVING COUNT(*) >1
)DER1;

/* NEW VALIDATION FOR MARKETING PROGRAM - TRAIT ASSOCIATION && INVALID TRAIT VALUES*/
/*
INSERT INTO VALIDATION_ERR_$BTCH 
(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, LOAD_ID, SYS_ERR_CODE,RECORD_SOURCE)
SELECT
DISTINCT
DER2.MKTNG_PGM_NBR,
DER2.REGIS_CNSMR_ID_VAL,
DER2.LOAD_ID,
'Not a Valid Trait number for Marketing Program' SYS_ERR_CODE,
'PRSNA_TRT_STG'
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
E.LOAD_ID
FROM
V_PRSNA_TRT_STG E
WHERE (E.MKTNG_PGM_NBR, E.TRT_NBR) NOT IN
(
SEL MKTNG_PGM_NBR,TRT_NBR 
FROM MKTNG_PGM_TRAIT_MAP 
)
)DER2;
.IF ERRORLEVEL > 0 THEN .GOTO FAIL
*/
/*
INSERT INTO VALIDATION_ERR_$BTCH
 (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, LOAD_ID, SYS_ERR_CODE,RECORD_SOURCE)
SELECT
DISTINCT
DER2.MKTNG_PGM_NBR,
DER2.REGIS_CNSMR_ID_VAL,
DER2.LOAD_ID,
'NOT A VALID TRAIT TEXT' SYS_ERR_CODE,
'PRSNA_TRT_STG'
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
E.LOAD_ID
FROM
V_PRSNA_TRT_STG E

WHERE (COALESCE(E.PRSNA_TRT_TXT,TRIM(CAST(E.PRSNA_TRT_INTEGER AS VARCHAR(100)))),E.TRT_NBR) NOT IN
(
SEL PREDFND_TRT_TXT,TRT_NBR 
FROM PREDFND_TRT_VAL 
)AND E.PRSNA_TRT_DATE IS NULL
)DER2;
.IF ERRORLEVEL > 0 THEN .GOTO FAIL
*/
/*
INSERT INTO VALIDATION_ERR_$BTCH 
(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, LOAD_ID, SYS_ERR_CODE,RECORD_SOURCE)
SELECT
DISTINCT
DER2.MKTNG_PGM_NBR,
DER2.REGIS_CNSMR_ID_VAL,
DER2.LOAD_ID,
'NOT A VALID TRAIT INTEGER' SYS_ERR_CODE,
'PRSNA_TRT_STG'
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
E.LOAD_ID
FROM
V_PRSNA_TRT_STG E

WHERE (TRIM(CAST(E.PRSNA_TRT_INTEGER AS VARCHAR(100))),E.TRT_NBR) NOT IN
(
SEL PREDFND_TRT_TXT,TRT_NBR 
FROM PREDFND_TRT_VAL 
)
)DER2;
.IF ERRORLEVEL > 0 THEN .GOTO FAIL

*/


/*
INSERT INTO VALIDATION_ERR_$BTCH 
(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, LOAD_ID, SYS_ERR_CODE,RECORD_SOURCE)
SELECT
DISTINCT
DER2.MKTNG_PGM_NBR,
DER2.REGIS_CNSMR_ID_VAL,
DER2.LOAD_ID,
'NOT A VALID TRAIT DATE' SYS_ERR_CODE,
'PRSNA_TRT_STG'
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
E.LOAD_ID
FROM
V_PRSNA_TRT_STG E

WHERE (E.PRSNA_TRT_DATE,E.TRT_NBR) NOT IN
(
SEL PREDFND_TRT_DATE,TRT_NBR 
FROM PREDFND_TRT_VAL 
)
)DER2;
.IF ERRORLEVEL > 0 THEN .GOTO FAIL


*/

.EXIT

