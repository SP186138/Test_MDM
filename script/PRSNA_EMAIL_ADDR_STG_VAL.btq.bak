/***********************************************************************************************************
SCRIPT:               PRSNA_EMAIL_ADDR_STG_VAL.BTEQ 
DESCRIPTION:          This script validates the records received from ETL Staging.
DEPENDENCY:           
INPUT:                ETL Staging
OUTPUT:               MST Staging
ERRORS:
SPECIAL INSTRUCTIONS:

CHANGE LOG:
VERSION              DATE                 AUTHOR                          CHANGES
1.00                 01/21/2011           TERADATA                        INITIAL VERSION
2.00                 08/22/2011           TERADATA                        Change OF Failure-BadFile
3.00                 10/31/2011           TERADATA                        Removal of Deletes as  part of ||elism
4.00                 03/26/2012		  TERADATA                        Made change in insert to LOAD_INFO to
                                                                          manipulate LA data
***********************************************************************************************************/

.logon $TDPID/$TDUSER,$TDPWD
 
.SET ERROROUT STDOUT;
.SET SESSION CHARSET 'UTF8';
.SET ERRORLEVEL 3624 SEVERITY 0


CREATE VOLATILE TABLE V_PRSNA_EMAIL_ADDR
AS
(
SELECT A.* FROM 
$ETL_DB.PRSNA_EMAIL_ADDR_STG  A 
JOIN
 VALIDATION_$BTCH B
ON A.LOAD_ID = B.LOAD_ID)
WITH DATA
PRIMARY INDEX ( MKTNG_PGM_NBR ,REGIS_CNSMR_ID_VAL, LOAD_ID )
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE

CREATE VOLATILE TABLE V_CNTCT_OPTN_CHCE AS
(
SELECT A.* FROM $ETL_DB.CNTCT_OPTN_CHCE_STG  A 
JOIN
 VALIDATION_$BTCH B
ON A.LOAD_ID = B.LOAD_ID)
WITH DATA
PRIMARY INDEX ( MKTNG_PGM_NBR ,REGIS_CNSMR_ID_VAL, LOAD_ID )
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE

/* VALIDATION FOR SAME CATEG CODE COMING TWICE */ 

/*
INSERT INTO VALIDATION_ERR_$BTCH 
SELECT
DER.MKTNG_PGM_NBR,
DER.REGIS_CNSMR_ID_VAL,
DER.LOAD_ID,
'EMAIL ADDRESS HAVING SAME CATEGORY CODE',
'PRSNA_EMAIL_ADDR_STG' 
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
STG.LOAD_ID,
RECORD_IND
FROM
V_PRSNA_EMAIL_ADDR STG
GROUP BY 1,2,3,4,5
HAVING COUNT(*) >1
)DER;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE
*/

/* VALIDATION FOR CHECKING CATEG CODE VALUES FROM ATT VALUES TABLE */

INSERT INTO VALIDATION_ERR_$BTCH (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
LOAD_ID, SYS_ERR_CODE,RECORD_SOURCE)
SELECT
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
LOAD_ID,
'NOT A VALID CATEGORY CODE VALUE FOR EMAIL' SYS_ERR_CODE,
'PRSNA_EMAIL_ADDR_STG'
FROM
V_PRSNA_EMAIL_ADDR 
where
(CNTCT_POINT_CATEG_CODE) not in
(
SEL A.AV_CODE  FROM ATTRIBUTE_VALUES A
INNER JOIN ATTRIBUTE_VALUES_HIERARCHY C
ON A.AV_ID = C.AV_ID_CHILD
INNER JOIN ATTRIBUTE_VALUES B
ON C.AV_ID_PARENT = B.AV_ID
AND B.AV_DESCRIPTION='Email Address'
) ;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE


INSERT INTO VALIDATION_ERR_$BTCH 
SELECT
TEMP3.MKTNG_PGM_NBR,
TEMP3.REGIS_CNSMR_ID_VAL,
TEMP3.LOAD_ID,
'TOO MANY VALUES IN EMAIL' SYS_ERR_CODE,
'PRSNA_EMAIL_ADDR_STG'
FROM
(SELECT  MKTNG_PGM_NBR
       ,REGIS_CNSMR_ID_VAL
       ,STG.LOAD_ID
       ,RECORD_IND
FROM V_PRSNA_EMAIL_ADDR STG
GROUP BY 1,2,3,4
HAVING COUNT(*) > 3)TEMP3;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE

/*
INSERT INTO ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DISTINCT
DER2.MKTNG_PGM_NBR,
DER2.REGIS_CNSMR_ID_VAL,
DER2.SOURCE_ID,
der2.LOAD_ID,
'Not a Valid Email Option number for Marketing Program' SYS_ERR_CODE
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
e.LOAD_ID,
LOAD.SOURCE_ID
FROM
V_PRSNA_EMAIL_ADDR E
INNER JOIN
V_CNTCT_OPTN_CHCE C
ON
E.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
E.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
E.CNTCT_POINT_CATEG_CODE = C.CNTCT_POINT_CATEG_CODE
AND
E.LOAD_ID = C.LOAD_ID
AND
C.CNTCT_POINT_TYPE_CODE='E'
INNER JOIN
$DBNAME.VALIDATIONS_LOAD_NBR LOAD
ON E.LOAD_ID = LOAD.LOAD_ID

WHERE (E.MKTNG_PGM_NBR, C.CNTCT_OPTN_NBR)NOT IN
(
SEL MKTNG_PGM_NBR,SUBSCRPTN_OPT_NBR 
FROM SUBSCRPTN_OPT_TYPE
WHERE CNTCT_CHANL_TYPE_CODE='E'
))DER2;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE
*/


.EXIT


