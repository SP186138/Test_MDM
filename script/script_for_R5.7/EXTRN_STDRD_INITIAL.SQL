.logon $TDPID/$TDUSER,$TDPWD


.SET ERROROUT STDOUT ;
 .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.SET SESSION CHARSET 'UTF8' ;
 .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.GOTO $Step

.LABEL L0

CREATE VOLATILE TABLE V_INPUT AS
(
SELECT DISTINCT
COALESCE(TRIM(STG.ADDR_LINE_1_TXT),'') ADDR_LINE_1_TXT1,
COALESCE(TRIM(STG.ADDR_LINE_2_TXT),'') ADDR_LINE_2_TXT1, 
COALESCE(TRIM(STG.ADDR_LINE_3_TXT),'') ADDR_LINE_3_TXT1, 
COALESCE(TRIM(STG.STRET_NUM),'') STRET_NUM1, 
COALESCE(TRIM(STG.STRET_NAME),'') STRET_NAME1, 
COALESCE(TRIM(STG.APT_NUM),'') APT_NUM1, 
COALESCE(TRIM(STG.PO_BOX_NUM),'') PO_BOX_NUM1, 
COALESCE(TRIM(STG.CITY_NAME),'') CITY_NAME1, 
COALESCE(TRIM(STG.TERR_NAME),'') TERR_NAME1,
COALESCE(TRIM(STG.POSTL_AREA_CODE),'') POSTL_AREA_CODE1, 
COALESCE(D.CNTRY_RECODE,TRIM(STG.CNTRY_INFO_TXT),
SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3),'') CNTRY_NAME1,
SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3) CNTRY_NAME2,
STG.SYS_SOURCE, 
STG.SYS_LAST_MODIFIED_DATE
FROM 
PRSNA_POSTL_ADDR_ORIG STG
JOIN MKTNG_PGM MP
ON STG.MKTNG_PGM_NBR=MP.MKTNG_PGM_NBR
LEFT JOIN CNTRY_RECODE D
ON TRIM(STG.CNTRY_INFO_TXT)=D.CNTRY
WHERE (MP.LEGAL_ENT_NBR IN (SEL AV_CODE    
FROM ATTRIBUTE_VALUES
 WHERE ATTRIBUTE_TYPE_ID IN
 (SEL ATTRIBUTE_TYPE_ID 
 FROM ATTRIBUTE_TYPES
 WHERE ATTRIBUTE_TYPE='External Standardization')
 AND SYS_ENT_STATE='Active'))
 AND MP.LEGAL_ENT_NBR IN ($LE)
)
WITH DATA
PRIMARY INDEX (ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,STRET_NUM1, 
STRET_NAME1,APT_NUM1,PO_BOX_NUM1,CITY_NAME1,TERR_NAME1,POSTL_AREA_CODE1,CNTRY_NAME1)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L1
COLLECT STATS V_INPUT
COLUMN ADDR_LINE_1_TXT1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS V_INPUT
COLUMN CITY_NAME1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS V_INPUT
COLUMN CNTRY_NAME1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L2
MERGE INTO POSTL_ADDR_ID_GEN A
USING
(SELECT DISTINCT * FROM V_INPUT
QUALIFY ROW_NUMBER() OVER (PARTITION BY ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,STRET_NUM1, 
STRET_NAME1,APT_NUM1,PO_BOX_NUM1,CITY_NAME1,TERR_NAME1,POSTL_AREA_CODE1,CNTRY_NAME1
ORDER BY SYS_SOURCE DESC,SYS_LAST_MODIFIED_DATE DESC)=1)
AS SRC
(
 V_ADDR_LINE_1_TXT1,
 V_ADDR_LINE_2_TXT1,
 V_ADDR_LINE_3_TXT1,
 V_STRET_NUM1, 
 V_STRET_NAME1,
 V_APT_NUM1,
 V_PO_BOX_NUM1,
 V_CITY_NAME1,
 V_TERR_NAME1,
 V_POSTL_AREA_CODE1,
 V_CNTRY_NAME1,
  V_CNTRY_NAME2,
 V_LOAD_ID,
V_LOAD_TS
)

ON ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT1
AND ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT1
AND ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT1
AND STRET_NUM=V_STRET_NUM1
AND STRET_NAME=V_STRET_NAME1
AND APT_NUM=V_APT_NUM1
AND PO_BOX_NUM=V_PO_BOX_NUM1
AND CITY_NAME=V_CITY_NAME1
AND TERR_NAME=V_TERR_NAME1
AND POSTL_AREA_CODE=V_POSTL_AREA_CODE1
AND CNTRY_INFO_TXT=V_CNTRY_NAME1

WHEN NOT MATCHED THEN 
INSERT
(ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT1,
ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT1,
ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT1,
STRET_NUM=V_STRET_NUM1, 
STRET_NAME=V_STRET_NAME1,
APT_NUM=V_APT_NUM1,
PO_BOX_NUM=V_PO_BOX_NUM1,
CITY_NAME=V_CITY_NAME1,
TERR_NAME=V_TERR_NAME1,
POSTL_AREA_CODE=V_POSTL_AREA_CODE1,
CNTRY_INFO_TXT=V_CNTRY_NAME1,
CNTRY_CODE=V_CNTRY_NAME2,
SYS_SOURCE=TRIM(CAST(V_LOAD_ID AS INTEGER)),
SYS_CREATION_DATE=V_LOAD_TS
);

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L3
MERGE INTO POSTL_ADDR A
USING
(SELECT DISTINCT POSTL_ADDR_ID                 ,
ADDR_LINE_1_TXT               ,
ADDR_LINE_2_TXT               ,
ADDR_LINE_3_TXT               ,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
CITY_NAME                     ,
POSTL_AREA_CODE               ,
TERR_NAME                     ,
CNTRY_INFO_TXT                ,
CNTRY_CODE                    ,
SYS_SOURCE                    
FROM POSTL_ADDR_ID_GEN)
AS SRC
(
 V_POSTL_ADDR_ID                 ,
 V_ADDR_LINE_1_TXT               ,
 V_ADDR_LINE_2_TXT               ,
 V_ADDR_LINE_3_TXT               ,
 V_STRET_NUM                     ,
 V_STRET_NAME                    ,
 V_APT_NUM                       ,
 V_PO_BOX_NUM                    ,
 V_CITY_NAME                     ,
 V_POSTL_AREA_CODE               ,
 V_TERR_NAME                     ,
 V_CNTRY_INFO_TXT                ,
 V_CNTRY_CODE                    ,
V_SYS_SOURCE                    
)

ON POSTL_ADDR_ID=V_POSTL_ADDR_ID

WHEN NOT MATCHED THEN 
INSERT
(POSTL_ADDR_ID=V_POSTL_ADDR_ID,
ORIG_ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT,
ORIG_ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT,
ORIG_ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT,
ORIG_STRET_NUM=V_STRET_NUM, 
ORIG_STRET_NAME=V_STRET_NAME,
ORIG_APT_NUM=V_APT_NUM,
ORIG_PO_BOX_NUM=V_PO_BOX_NUM,
ORIG_CITY_NAME=V_CITY_NAME,
ORIG_TERR_NAME=V_TERR_NAME,
ORIG_POSTL_AREA_CODE=V_POSTL_AREA_CODE,
ORIG_CNTRY_INFO_TXT=V_CNTRY_INFO_TXT,
CNTRY_CODE=V_CNTRY_CODE,
LOG_SOURCE_ID=CAST(V_SYS_SOURCE AS INTEGER),
LOG_UPDATE_USER='I2',
POSTL_STRD_STATUS_CD='NS'
);

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L4
DROP TABLE V_INPUT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L5
CREATE VOLATILE TABLE V_INPUT AS
(
SELECT DISTINCT
COALESCE(TRIM(STG.NEW_ADDRESS1),'') ADDR_LINE_1_TXT1,
COALESCE(TRIM(STG.NEW_ADDRESS2),'') ADDR_LINE_2_TXT1, 
' ' ADDR_LINE_3_TXT1, 
' ' STRET_NUM1, 
' ' STRET_NAME1, 
' ' APT_NUM1, 
' ' PO_BOX_NUM1, 
COALESCE(TRIM(STG.NEW_CITY),'') CITY_NAME1, 
COALESCE(TRIM(STG.NEW_STATE),'') TERR_NAME1,
COALESCE(TRIM(STG.NEW_ZIP),'') POSTL_AREA_CODE1, 
COALESCE(D.CNTRY_RECODE,TRIM(STG.NEW_COUNTRY),
SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3),'') CNTRY_NAME1,
SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3) CNTRY_NAME2,
STG.LOAD_ID, 
STG.LOAD_TS
FROM ICRM_STAGE.NCOA_ADDR_STG STG
JOIN MKTNG_PGM MP
ON STG.MKTNG_PGM_NBR=MP.MKTNG_PGM_NBR  
LEFT JOIN CNTRY_RECODE D
ON TRIM(STG.NEW_COUNTRY)=D.CNTRY
WHERE (MP.LEGAL_ENT_NBR IN (SEL AV_CODE    
FROM ATTRIBUTE_VALUES
 WHERE ATTRIBUTE_TYPE_ID IN
 (SEL ATTRIBUTE_TYPE_ID 
 FROM ATTRIBUTE_TYPES
 WHERE ATTRIBUTE_TYPE='External Standardization')
 AND SYS_ENT_STATE='Active'))
 AND MP.LEGAL_ENT_NBR IN ($LE)
 UNION
SELECT DISTINCT
COALESCE(TRIM(STG.NEW_ADDRESS1),'') ADDR_LINE_1_TXT1,
COALESCE(TRIM(STG.NEW_ADDRESS2),'') ADDR_LINE_2_TXT1, 
' ' ADDR_LINE_3_TXT1, 
' ' STRET_NUM1, 
' ' STRET_NAME1, 
' ' APT_NUM1, 
' ' PO_BOX_NUM1, 
COALESCE(TRIM(STG.NEW_CITY),'') CITY_NAME1, 
COALESCE(TRIM(STG.NEW_STATE),'') TERR_NAME1,
COALESCE(TRIM(STG.NEW_ZIP),'') POSTL_AREA_CODE1, 
COALESCE(D.CNTRY_RECODE,TRIM(STG.NEW_COUNTRY),
SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3),'') CNTRY_NAME1,
SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3) CNTRY_NAME2,
STG.LOAD_ID, 
STG.LOAD_TS
FROM ICRM_STAGE.NCOA_ADDR_STG_HIST STG
JOIN MKTNG_PGM MP
ON STG.MKTNG_PGM_NBR=MP.MKTNG_PGM_NBR  
LEFT JOIN CNTRY_RECODE D
ON TRIM(STG.NEW_COUNTRY)=D.CNTRY
WHERE (MP.LEGAL_ENT_NBR IN (SEL AV_CODE    
FROM ATTRIBUTE_VALUES
 WHERE ATTRIBUTE_TYPE_ID IN
 (SEL ATTRIBUTE_TYPE_ID 
 FROM ATTRIBUTE_TYPES
 WHERE ATTRIBUTE_TYPE='External Standardization')
 AND SYS_ENT_STATE='Active')) 
 AND MP.LEGAL_ENT_NBR IN ($LE)
)
WITH DATA
PRIMARY INDEX (ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,STRET_NUM1, 
STRET_NAME1,APT_NUM1,PO_BOX_NUM1,CITY_NAME1,TERR_NAME1,POSTL_AREA_CODE1,CNTRY_NAME1)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L6
COLLECT STATS V_INPUT
COLUMN ADDR_LINE_1_TXT1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS V_INPUT
COLUMN CITY_NAME1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS V_INPUT
COLUMN CNTRY_NAME1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L7
MERGE INTO POSTL_ADDR_ID_GEN A
USING
(SELECT DISTINCT * FROM V_INPUT
QUALIFY ROW_NUMBER() OVER (PARTITION BY ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,STRET_NUM1, 
STRET_NAME1,APT_NUM1,PO_BOX_NUM1,CITY_NAME1,TERR_NAME1,POSTL_AREA_CODE1,CNTRY_NAME1
ORDER BY LOAD_ID DESC,LOAD_TS DESC)=1)
AS SRC
(
 V_ADDR_LINE_1_TXT1,
 V_ADDR_LINE_2_TXT1,
 V_ADDR_LINE_3_TXT1,
 V_STRET_NUM1, 
 V_STRET_NAME1,
 V_APT_NUM1,
 V_PO_BOX_NUM1,
 V_CITY_NAME1,
 V_TERR_NAME1,
 V_POSTL_AREA_CODE1,
 V_CNTRY_NAME1,
  V_CNTRY_NAME2,
 V_LOAD_ID,
V_LOAD_TS
)

ON ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT1
AND ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT1
AND ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT1
AND STRET_NUM=V_STRET_NUM1
AND STRET_NAME=V_STRET_NAME1
AND APT_NUM=V_APT_NUM1
AND PO_BOX_NUM=V_PO_BOX_NUM1
AND CITY_NAME=V_CITY_NAME1
AND TERR_NAME=V_TERR_NAME1
AND POSTL_AREA_CODE=V_POSTL_AREA_CODE1
AND CNTRY_INFO_TXT=V_CNTRY_NAME1

WHEN NOT MATCHED THEN 
INSERT
(ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT1,
ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT1,
ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT1,
STRET_NUM=V_STRET_NUM1, 
STRET_NAME=V_STRET_NAME1,
APT_NUM=V_APT_NUM1,
PO_BOX_NUM=V_PO_BOX_NUM1,
CITY_NAME=V_CITY_NAME1,
TERR_NAME=V_TERR_NAME1,
POSTL_AREA_CODE=V_POSTL_AREA_CODE1,
CNTRY_INFO_TXT=V_CNTRY_NAME1,
CNTRY_CODE=V_CNTRY_NAME2,
SYS_SOURCE=TRIM(CAST(V_LOAD_ID AS INTEGER)),
SYS_CREATION_DATE=V_LOAD_TS
);

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L8
MERGE INTO POSTL_ADDR A
USING
(SELECT DISTINCT POSTL_ADDR_ID                 ,
ADDR_LINE_1_TXT               ,
ADDR_LINE_2_TXT               ,
ADDR_LINE_3_TXT               ,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
CITY_NAME                     ,
POSTL_AREA_CODE               ,
TERR_NAME                     ,
CNTRY_INFO_TXT                ,
CNTRY_CODE                    ,
SYS_SOURCE                    
FROM POSTL_ADDR_ID_GEN)
AS SRC
(
 V_POSTL_ADDR_ID                 ,
 V_ADDR_LINE_1_TXT               ,
 V_ADDR_LINE_2_TXT               ,
 V_ADDR_LINE_3_TXT               ,
 V_STRET_NUM                     ,
 V_STRET_NAME                    ,
 V_APT_NUM                       ,
 V_PO_BOX_NUM                    ,
 V_CITY_NAME                     ,
 V_POSTL_AREA_CODE               ,
 V_TERR_NAME                     ,
 V_CNTRY_INFO_TXT                    ,
 V_CNTRY_CODE                    ,
V_SYS_SOURCE                    
)

ON POSTL_ADDR_ID=V_POSTL_ADDR_ID

WHEN NOT MATCHED THEN 
INSERT
(POSTL_ADDR_ID=V_POSTL_ADDR_ID,
ORIG_ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT,
ORIG_ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT,
ORIG_ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT,
ORIG_STRET_NUM=V_STRET_NUM, 
ORIG_STRET_NAME=V_STRET_NAME,
ORIG_APT_NUM=V_APT_NUM,
ORIG_PO_BOX_NUM=V_PO_BOX_NUM,
ORIG_CITY_NAME=V_CITY_NAME,
ORIG_TERR_NAME=V_TERR_NAME,
ORIG_POSTL_AREA_CODE=V_POSTL_AREA_CODE,
ORIG_CNTRY_INFO_TXT=V_CNTRY_INFO_TXT,
CNTRY_CODE=V_CNTRY_CODE,
LOG_SOURCE_ID=CAST(V_SYS_SOURCE AS INTEGER),
LOG_UPDATE_USER='I25c',
POSTL_STRD_STATUS_CD='NS'
);

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L9
DROP TABLE V_INPUT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L10
CREATE VOLATILE TABLE V_INPUT AS
(
SELECT DISTINCT
COALESCE(TRIM(STG.SRC_ADDR_LINE_1_TXT),'') ADDR_LINE_1_TXT1,
COALESCE(TRIM(STG.SRC_ADDR_LINE_2_TXT),'') ADDR_LINE_2_TXT1, 
COALESCE(TRIM(STG.SRC_ADDR_LINE_3_TXT),'') ADDR_LINE_3_TXT1, 
' ' STRET_NUM1, 
' ' STRET_NAME1, 
' ' APT_NUM1, 
' ' PO_BOX_NUM1, 
COALESCE(TRIM(STG.SRC_CITY_NAME),'') CITY_NAME1, 
COALESCE(TRIM(STG.SRC_STATE),'') TERR_NAME1,
COALESCE(TRIM(STG.SRC_ZIP),'') POSTL_AREA_CODE1, 
COALESCE(D.CNTRY_RECODE,TRIM(STG.SRC_CNTRY_NAME),
SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3),'') CNTRY_NAME1,
SUBSTR(LEGAL_ENT_SHORT_NAME,1,3) CNTRY_NAME2,
CAST(STG.LOG_SOURCE_ID AS INTEGER) LOAD_ID,  
CURRENT_TIMESTAMP(0) LOAD_TS
FROM 
REGIS_PRSNA_OPT_HIST STG
LEFT JOIN MKTNG_PGM MP
ON STG.MKTNG_PGM_NBR=MP.MKTNG_PGM_NBR  
LEFT JOIN LEGAL_ENT LE1
ON STG.LEGAL_ENT_NBR=LE1.LEGAL_ENT_NBR  
LEFT JOIN CNTRY_RECODE D
ON TRIM(STG.SRC_CNTRY_NAME)=D.CNTRY
WHERE STG.REGIS_PRSNA_ID < 0
AND (STG.LEGAL_ENT_NBR IN (SEL AV_CODE    
FROM ATTRIBUTE_VALUES
 WHERE ATTRIBUTE_TYPE_ID IN
 (SEL ATTRIBUTE_TYPE_ID 
 FROM ATTRIBUTE_TYPES
 WHERE ATTRIBUTE_TYPE='External Standardization')
 AND SYS_ENT_STATE='Active'))
 AND STG.LEGAL_ENT_NBR IN ($LE)
QUALIFY RANK() OVER (PARTITION BY ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,STRET_NUM1, 
STRET_NAME1,APT_NUM1,PO_BOX_NUM1,CITY_NAME1,TERR_NAME1,POSTL_AREA_CODE1,CNTRY_NAME1
ORDER BY LOAD_ID DESC)=1
)
WITH DATA
PRIMARY INDEX (ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,STRET_NUM1, 
STRET_NAME1,APT_NUM1,PO_BOX_NUM1,CITY_NAME1,TERR_NAME1,POSTL_AREA_CODE1,CNTRY_NAME1)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L11
COLLECT STATS V_INPUT
COLUMN ADDR_LINE_1_TXT1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS V_INPUT
COLUMN CITY_NAME1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS V_INPUT
COLUMN CNTRY_NAME1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L12
MERGE INTO POSTL_ADDR_ID_GEN A
USING
(
SEL DISTINCT A.*,B.CNTRY_NAME2,B.LOAD_ID,CURRENT_TIMESTAMP(0) LOAD_TS FROM (
SEL ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,STRET_NUM1, 
STRET_NAME1,APT_NUM1,PO_BOX_NUM1,CITY_NAME1,TERR_NAME1,POSTL_AREA_CODE1,CNTRY_NAME1 FROM V_INPUT
MINUS
SEL ADDR_LINE_1_TXT,ADDR_LINE_2_TXT,ADDR_LINE_3_TXT,STRET_NUM, 
STRET_NAME,APT_NUM,PO_BOX_NUM,CITY_NAME,TERR_NAME,POSTL_AREA_CODE,CNTRY_INFO_TXT 
FROM POSTL_ADDR_ID_GEN) A
JOIN V_INPUT B
ON B.ADDR_LINE_1_TXT1=A.ADDR_LINE_1_TXT1
AND B.ADDR_LINE_2_TXT1=A.ADDR_LINE_2_TXT1
AND B.ADDR_LINE_3_TXT1=A.ADDR_LINE_3_TXT1
AND B.STRET_NUM1=A.STRET_NUM1
AND B.STRET_NAME1=A.STRET_NAME1
AND B.APT_NUM1=A.APT_NUM1
AND B.PO_BOX_NUM1=A.PO_BOX_NUM1
AND B.CITY_NAME1=A.CITY_NAME1
AND B.TERR_NAME1=A.TERR_NAME1
AND B.POSTL_AREA_CODE1=A.POSTL_AREA_CODE1
AND B.CNTRY_NAME1=A.CNTRY_NAME1
QUALIFY RANK() OVER (PARTITION BY A.ADDR_LINE_1_TXT1,A.ADDR_LINE_2_TXT1,A.ADDR_LINE_3_TXT1,A.STRET_NUM1, 
A.STRET_NAME1,A.APT_NUM1,A.PO_BOX_NUM1,A.CITY_NAME1,A.TERR_NAME1,A.POSTL_AREA_CODE1,A.CNTRY_NAME1
ORDER BY CHAR(CNTRY_NAME2) ASC)=1)
AS SRC
(
 V_ADDR_LINE_1_TXT1,
 V_ADDR_LINE_2_TXT1,
 V_ADDR_LINE_3_TXT1,
 V_STRET_NUM1, 
 V_STRET_NAME1,
 V_APT_NUM1,
 V_PO_BOX_NUM1,
 V_CITY_NAME1,
 V_TERR_NAME1,
 V_POSTL_AREA_CODE1,
 V_CNTRY_NAME1,
  V_CNTRY_NAME2,
 V_LOAD_ID,
V_LOAD_TS
)

ON ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT1
AND ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT1
AND ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT1
AND STRET_NUM=V_STRET_NUM1
AND STRET_NAME=V_STRET_NAME1
AND APT_NUM=V_APT_NUM1
AND PO_BOX_NUM=V_PO_BOX_NUM1
AND CITY_NAME=V_CITY_NAME1
AND TERR_NAME=V_TERR_NAME1
AND POSTL_AREA_CODE=V_POSTL_AREA_CODE1
AND CNTRY_INFO_TXT=V_CNTRY_NAME1

WHEN NOT MATCHED THEN 
INSERT
(ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT1,
ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT1,
ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT1,
STRET_NUM=V_STRET_NUM1, 
STRET_NAME=V_STRET_NAME1,
APT_NUM=V_APT_NUM1,
PO_BOX_NUM=V_PO_BOX_NUM1,
CITY_NAME=V_CITY_NAME1,
TERR_NAME=V_TERR_NAME1,
POSTL_AREA_CODE=V_POSTL_AREA_CODE1,
CNTRY_INFO_TXT=V_CNTRY_NAME1,
CNTRY_CODE=V_CNTRY_NAME2,
SYS_SOURCE=TRIM(CAST(V_LOAD_ID AS INTEGER)),
SYS_CREATION_DATE=V_LOAD_TS
);

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L13
MERGE INTO POSTL_ADDR A
USING
(SELECT DISTINCT POSTL_ADDR_ID                 ,
ADDR_LINE_1_TXT               ,
ADDR_LINE_2_TXT               ,
ADDR_LINE_3_TXT               ,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
CITY_NAME                     ,
POSTL_AREA_CODE               ,
TERR_NAME                     ,
CNTRY_INFO_TXT                ,
CNTRY_CODE                    ,
SYS_SOURCE                    
FROM POSTL_ADDR_ID_GEN)
AS SRC
(
 V_POSTL_ADDR_ID                 ,
 V_ADDR_LINE_1_TXT               ,
 V_ADDR_LINE_2_TXT               ,
 V_ADDR_LINE_3_TXT               ,
 V_STRET_NUM                     ,
 V_STRET_NAME                    ,
 V_APT_NUM                       ,
 V_PO_BOX_NUM                    ,
 V_CITY_NAME                     ,
 V_POSTL_AREA_CODE               ,
 V_TERR_NAME                     ,
 V_CNTRY_INFO_TXT                ,
 V_CNTRY_CODE                    ,
V_SYS_SOURCE                    
)

ON POSTL_ADDR_ID=V_POSTL_ADDR_ID

WHEN NOT MATCHED THEN 
INSERT
(POSTL_ADDR_ID=V_POSTL_ADDR_ID,
ORIG_ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT,
ORIG_ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT,
ORIG_ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT,
ORIG_STRET_NUM=V_STRET_NUM, 
ORIG_STRET_NAME=V_STRET_NAME,
ORIG_APT_NUM=V_APT_NUM,
ORIG_PO_BOX_NUM=V_PO_BOX_NUM,
ORIG_CITY_NAME=V_CITY_NAME,
ORIG_TERR_NAME=V_TERR_NAME,
ORIG_POSTL_AREA_CODE=V_POSTL_AREA_CODE,
ORIG_CNTRY_INFO_TXT=V_CNTRY_INFO_TXT,
CNTRY_CODE=V_CNTRY_CODE,
LOG_SOURCE_ID=CAST(V_SYS_SOURCE AS INTEGER),
LOG_UPDATE_USER='I60',
POSTL_STRD_STATUS_CD='NS'
);

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L14
DROP TABLE V_INPUT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L15
CREATE VOLATILE TABLE V_INPUT AS
(
SELECT DISTINCT
COALESCE(TRIM(STG.ADDR_LINE_1),'') ADDR_LINE_1_TXT1,
COALESCE(TRIM(STG.ADDR_LINE_2),'') ADDR_LINE_2_TXT1, 
COALESCE(TRIM(STG.ADDR_LINE_3),'') ADDR_LINE_3_TXT1, 
' ' STRET_NUM1, 
' ' STRET_NAME1, 
' ' APT_NUM1, 
' ' PO_BOX_NUM1, 
COALESCE(TRIM(STG.CITY),'') CITY_NAME1, 
COALESCE(TRIM(STG.TERR),'') TERR_NAME1,
COALESCE(TRIM(STG.POSTL_AREA_CD),'') POSTL_AREA_CODE1, 
COALESCE(D.CNTRY_RECODE,TRIM(STG.CNTRY_CD),'') CNTRY_NAME1,
STG.LOAD_ID, 
STG.LOAD_TS
FROM ICRM_STAGE.STORE_STG STG
LEFT JOIN CNTRY_RECODE D
ON TRIM(STG.CNTRY_CD)=D.CNTRY
WHERE COALESCE(D.CNTRY_RECODE,TRIM(STG.CNTRY_CD),'') IN (SEL AV_CODE    
FROM ATTRIBUTE_VALUES
 WHERE ATTRIBUTE_TYPE_ID IN
 (SEL ATTRIBUTE_TYPE_ID 
 FROM ATTRIBUTE_TYPES
 WHERE ATTRIBUTE_TYPE='External Standardization-Country')
 AND SYS_ENT_STATE='Active') 
 AND COALESCE(D.CNTRY_RECODE,TRIM(STG.CNTRY_CD),'') IN ($CNTRY)
UNION
SELECT DISTINCT
COALESCE(TRIM(STG.ADDR_LINE_1),'') ADDR_LINE_1_TXT1,
COALESCE(TRIM(STG.ADDR_LINE_2),'') ADDR_LINE_2_TXT1, 
COALESCE(TRIM(STG.ADDR_LINE_3),'') ADDR_LINE_3_TXT1, 
' ' STRET_NUM1, 
' ' STRET_NAME1, 
' ' APT_NUM1, 
' ' PO_BOX_NUM1, 
COALESCE(TRIM(STG.CITY),'') CITY_NAME1, 
COALESCE(TRIM(STG.TERR),'') TERR_NAME1,
COALESCE(TRIM(STG.POSTL_AREA_CD),'') POSTL_AREA_CODE1, 
COALESCE(D.CNTRY_RECODE,TRIM(STG.CNTRY_CD),'') CNTRY_NAME1,
STG.LOAD_ID, 
STG.LOAD_TS
FROM ICRM_STAGE.STORE_STG_HIST STG
LEFT JOIN CNTRY_RECODE D
ON TRIM(STG.CNTRY_CD)=D.CNTRY
WHERE COALESCE(D.CNTRY_RECODE,TRIM(STG.CNTRY_CD),'') IN (SEL AV_CODE    
FROM ATTRIBUTE_VALUES
 WHERE ATTRIBUTE_TYPE_ID IN
 (SEL ATTRIBUTE_TYPE_ID 
 FROM ATTRIBUTE_TYPES
 WHERE ATTRIBUTE_TYPE='External Standardization-Country')
 AND SYS_ENT_STATE='Active')
 AND COALESCE(D.CNTRY_RECODE,TRIM(STG.CNTRY_CD),'') IN ($CNTRY)
)
WITH DATA
PRIMARY INDEX (ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,STRET_NUM1, 
STRET_NAME1,APT_NUM1,PO_BOX_NUM1,CITY_NAME1,TERR_NAME1,POSTL_AREA_CODE1,CNTRY_NAME1)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L16
COLLECT STATS V_INPUT
COLUMN ADDR_LINE_1_TXT1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS V_INPUT
COLUMN CITY_NAME1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS V_INPUT
COLUMN CNTRY_NAME1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L17
MERGE INTO POSTL_ADDR_ID_GEN A
USING
(SELECT DISTINCT * FROM V_INPUT
QUALIFY ROW_NUMBER() OVER (PARTITION BY ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,STRET_NUM1, 
STRET_NAME1,APT_NUM1,PO_BOX_NUM1,CITY_NAME1,TERR_NAME1,POSTL_AREA_CODE1,CNTRY_NAME1
ORDER BY LOAD_ID DESC,LOAD_TS DESC)=1)
AS SRC
(
 V_ADDR_LINE_1_TXT1,
 V_ADDR_LINE_2_TXT1,
 V_ADDR_LINE_3_TXT1,
 V_STRET_NUM1, 
 V_STRET_NAME1,
 V_APT_NUM1,
 V_PO_BOX_NUM1,
 V_CITY_NAME1,
 V_TERR_NAME1,
 V_POSTL_AREA_CODE1,
 V_CNTRY_NAME1,
 V_LOAD_ID,
V_LOAD_TS
)

ON ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT1
AND ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT1
AND ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT1
AND STRET_NUM=V_STRET_NUM1
AND STRET_NAME=V_STRET_NAME1
AND APT_NUM=V_APT_NUM1
AND PO_BOX_NUM=V_PO_BOX_NUM1
AND CITY_NAME=V_CITY_NAME1
AND TERR_NAME=V_TERR_NAME1
AND POSTL_AREA_CODE=V_POSTL_AREA_CODE1
AND CNTRY_INFO_TXT=V_CNTRY_NAME1

WHEN NOT MATCHED THEN 
INSERT
(ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT1,
ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT1,
ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT1,
STRET_NUM=V_STRET_NUM1, 
STRET_NAME=V_STRET_NAME1,
APT_NUM=V_APT_NUM1,
PO_BOX_NUM=V_PO_BOX_NUM1,
CITY_NAME=V_CITY_NAME1,
TERR_NAME=V_TERR_NAME1,
POSTL_AREA_CODE=V_POSTL_AREA_CODE1,
CNTRY_INFO_TXT=V_CNTRY_NAME1,
CNTRY_CODE=V_CNTRY_NAME1,
SYS_SOURCE=TRIM(CAST(V_LOAD_ID AS INTEGER)),
SYS_CREATION_DATE=V_LOAD_TS
);

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L18
MERGE INTO POSTL_ADDR A
USING
(SELECT DISTINCT POSTL_ADDR_ID                 ,
ADDR_LINE_1_TXT               ,
ADDR_LINE_2_TXT               ,
ADDR_LINE_3_TXT               ,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
CITY_NAME                     ,
POSTL_AREA_CODE               ,
TERR_NAME                     ,
CNTRY_INFO_TXT                ,
CNTRY_CODE                    ,
SYS_SOURCE                    
FROM POSTL_ADDR_ID_GEN)
AS SRC
(
 V_POSTL_ADDR_ID                 ,
 V_ADDR_LINE_1_TXT               ,
 V_ADDR_LINE_2_TXT               ,
 V_ADDR_LINE_3_TXT               ,
 V_STRET_NUM                     ,
 V_STRET_NAME                    ,
 V_APT_NUM                       ,
 V_PO_BOX_NUM                    ,
 V_CITY_NAME                     ,
 V_POSTL_AREA_CODE               ,
 V_TERR_NAME                     ,
 V_CNTRY_INFO_TXT                ,
 V_CNTRY_CODE                    ,
V_SYS_SOURCE                    
)

ON POSTL_ADDR_ID=V_POSTL_ADDR_ID

WHEN NOT MATCHED THEN 
INSERT
(POSTL_ADDR_ID=V_POSTL_ADDR_ID,
ORIG_ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT,
ORIG_ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT,
ORIG_ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT,
ORIG_STRET_NUM=V_STRET_NUM, 
ORIG_STRET_NAME=V_STRET_NAME,
ORIG_APT_NUM=V_APT_NUM,
ORIG_PO_BOX_NUM=V_PO_BOX_NUM,
ORIG_CITY_NAME=V_CITY_NAME,
ORIG_TERR_NAME=V_TERR_NAME,
ORIG_POSTL_AREA_CODE=V_POSTL_AREA_CODE,
ORIG_CNTRY_INFO_TXT=V_CNTRY_INFO_TXT,
CNTRY_CODE=V_CNTRY_CODE,
LOG_SOURCE_ID=CAST(V_SYS_SOURCE AS INTEGER),
LOG_UPDATE_USER='I4b',
POSTL_STRD_STATUS_CD='NS'
);

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L19

UPDATE REGIS_PRSNA_POSTL_ADDR
FROM (
SEL DISTINCT STG.MKTNG_PGM_NBR,
STG.REGIS_PRSNA_ID,
STG.CNTCT_POINT_CATEG_CODE,
D.POSTL_ADDR_ID,
D.ORIG_ADDR_LINE_1_TXT,
D.ORIG_ADDR_LINE_2_TXT,
D.ORIG_ADDR_LINE_3_TXT,
D.ORIG_STRET_NUM,
D.ORIG_STRET_NAME,
D.ORIG_APT_NUM,
D.ORIG_PO_BOX_NUM,
D.ORIG_CITY_NAME,
D.ORIG_TERR_NAME,
D.ORIG_POSTL_AREA_CODE
FROM PRSNA_POSTL_ADDR_ORIG STG
JOIN MKTNG_PGM MP
ON STG.MKTNG_PGM_NBR=MP.MKTNG_PGM_NBR
LEFT JOIN CNTRY_RECODE D1
ON TRIM(STG.CNTRY_INFO_TXT)=D1.CNTRY
LEFT JOIN POSTL_ADDR D
ON COALESCE(TRIM(STG.ADDR_LINE_1_TXT),'')=D.ORIG_ADDR_LINE_1_TXT
AND COALESCE(TRIM(STG.ADDR_LINE_2_TXT),'')=D.ORIG_ADDR_LINE_2_TXT
AND COALESCE(TRIM(STG.ADDR_LINE_3_TXT),'')=D.ORIG_ADDR_LINE_3_TXT
AND COALESCE(TRIM(STG.STRET_NUM),'')=D.ORIG_STRET_NUM
AND COALESCE(TRIM(STG.STRET_NAME),'')=D.ORIG_STRET_NAME
AND COALESCE(TRIM(STG.APT_NUM),'')=D.ORIG_APT_NUM
AND COALESCE(TRIM(STG.PO_BOX_NUM),'')=D.ORIG_PO_BOX_NUM
AND COALESCE(TRIM(STG.CITY_NAME),'')=D.ORIG_CITY_NAME
AND COALESCE(TRIM(STG.TERR_NAME),'')=D.ORIG_TERR_NAME
AND COALESCE(TRIM(STG.POSTL_AREA_CODE),'')=D.ORIG_POSTL_AREA_CODE
AND COALESCE(D1.CNTRY_RECODE,TRIM(STG.CNTRY_INFO_TXT),
SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3),'')=D.ORIG_CNTRY_INFO_TXT
WHERE POSTL_ADDR_ID IS NOT NULL
AND (MP.LEGAL_ENT_NBR IN (SEL AV_CODE    
FROM ATTRIBUTE_VALUES
 WHERE ATTRIBUTE_TYPE_ID IN
 (SEL ATTRIBUTE_TYPE_ID 
 FROM ATTRIBUTE_TYPES
 WHERE ATTRIBUTE_TYPE='External Standardization')
 AND SYS_ENT_STATE='Active'))
 AND MP.LEGAL_ENT_NBR IN ($LE)) B
SET POSTL_ADDR_ID=B.POSTL_ADDR_ID,
ADDR_LINE_1_TXT=B.ORIG_ADDR_LINE_1_TXT,
ADDR_LINE_2_TXT=B.ORIG_ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT=B.ORIG_ADDR_LINE_3_TXT,
STRET_NUM=B.ORIG_STRET_NUM,
STRET_NAME=B.ORIG_STRET_NAME,
APT_NUM=B.ORIG_APT_NUM,
PO_BOX_NUM=B.ORIG_PO_BOX_NUM,
CITY_NAME=B.ORIG_CITY_NAME,
TERR_NAME=B.ORIG_TERR_NAME,
POSTL_AREA_CODE=B.ORIG_POSTL_AREA_CODE
WHERE REGIS_PRSNA_POSTL_ADDR.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR
AND REGIS_PRSNA_POSTL_ADDR.REGIS_PRSNA_ID=B.REGIS_PRSNA_ID
AND REGIS_PRSNA_POSTL_ADDR.CNTCT_POINT_CATEG_CODE=B.CNTCT_POINT_CATEG_CODE;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
.LABEL L19A

UPDATE REGIS_PRSNA_POSTL_ADDR
FROM TERR B
SET TERR_NAME=B.TERR_NAME
WHERE REGIS_PRSNA_POSTL_ADDR.CNTRY_CODE=B.CNTRY_CODE
AND REGIS_PRSNA_POSTL_ADDR.TERR_CODE=B.TERR_CODE
AND B.CNTRY_CODE IN ($CNTRY);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL L19B

UPDATE REGIS_PRSNA_POSTL_ADDR
FROM CITY B
SET CITY_NAME=B.CITY_NAME
WHERE REGIS_PRSNA_POSTL_ADDR.CITY_CODE=B.CITY_CODE
AND REGIS_PRSNA_POSTL_ADDR.TERR_CODE=B.TERR_CODE
AND B.TERR_CODE IN (SEL TERR_CODE FROM TERR
WHERE CNTRY_CODE IN ($CNTRY));
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL L20
UPDATE MATCHD_CNSMR_POSTL_ADDR
FROM (
SEL DISTINCT A.LEGAL_ENT_NBR,
A.MATCHD_CNSMR_PRSNA_ID,
STG.CNTCT_POINT_CATEG_CODE,
STG.SYS_SOURCE,
D.POSTL_ADDR_ID,
D.ORIG_ADDR_LINE_1_TXT,
D.ORIG_ADDR_LINE_2_TXT,
D.ORIG_ADDR_LINE_3_TXT,
D.ORIG_STRET_NUM,
D.ORIG_STRET_NAME,
D.ORIG_APT_NUM,
D.ORIG_PO_BOX_NUM,
D.ORIG_CITY_NAME,
D.ORIG_TERR_NAME,
D.ORIG_POSTL_AREA_CODE
FROM PRSNA_POSTL_ADDR_ORIG STG
JOIN MKTNG_PGM MP
ON STG.MKTNG_PGM_NBR=MP.MKTNG_PGM_NBR
JOIN REGIS_PRSNA A
ON STG.MKTNG_PGM_NBR=A.MKTNG_PGM_NBR
AND STG.REGIS_PRSNA_ID=A.REGIS_PRSNA_ID
LEFT JOIN CNTRY_RECODE D1
ON TRIM(STG.CNTRY_INFO_TXT)=D1.CNTRY
LEFT JOIN POSTL_ADDR D
ON COALESCE(TRIM(STG.ADDR_LINE_1_TXT),'')=D.ORIG_ADDR_LINE_1_TXT
AND COALESCE(TRIM(STG.ADDR_LINE_2_TXT),'')=D.ORIG_ADDR_LINE_2_TXT
AND COALESCE(TRIM(STG.ADDR_LINE_3_TXT),'')=D.ORIG_ADDR_LINE_3_TXT
AND COALESCE(TRIM(STG.STRET_NUM),'')=D.ORIG_STRET_NUM
AND COALESCE(TRIM(STG.STRET_NAME),'')=D.ORIG_STRET_NAME
AND COALESCE(TRIM(STG.APT_NUM),'')=D.ORIG_APT_NUM
AND COALESCE(TRIM(STG.PO_BOX_NUM),'')=D.ORIG_PO_BOX_NUM
AND COALESCE(TRIM(STG.CITY_NAME),'')=D.ORIG_CITY_NAME
AND COALESCE(TRIM(STG.TERR_NAME),'')=D.ORIG_TERR_NAME
AND COALESCE(TRIM(STG.POSTL_AREA_CODE),'')=D.ORIG_POSTL_AREA_CODE
AND COALESCE(D1.CNTRY_RECODE,TRIM(STG.CNTRY_INFO_TXT),
SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3),'')=D.ORIG_CNTRY_INFO_TXT
WHERE POSTL_ADDR_ID IS NOT NULL
AND (MP.LEGAL_ENT_NBR IN (SEL AV_CODE    
FROM ATTRIBUTE_VALUES
 WHERE ATTRIBUTE_TYPE_ID IN
 (SEL ATTRIBUTE_TYPE_ID 
 FROM ATTRIBUTE_TYPES
 WHERE ATTRIBUTE_TYPE='External Standardization')
 AND SYS_ENT_STATE='Active'))
 AND MP.LEGAL_ENT_NBR IN ($LE)
QUALIFY RANK() OVER (PARTITION BY A.LEGAL_ENT_NBR,
A.MATCHD_CNSMR_PRSNA_ID,
STG.CNTCT_POINT_CATEG_CODE
ORDER BY STG.SYS_LAST_MODIFIED_DATE DESC, STG.SYS_SOURCE DESC,A.SYS_SOURCE DESC
, A.LATST_ACTVY_DATE DESC, A.REGIS_DATE DESC,A.MKTNG_PGM_NBR DESC,A.REGIS_PRSNA_ID DESC)=1) B
SET POSTL_ADDR_ID=B.POSTL_ADDR_ID,
ADDR_LINE_1_TXT=B.ORIG_ADDR_LINE_1_TXT,
ADDR_LINE_2_TXT=B.ORIG_ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT=B.ORIG_ADDR_LINE_3_TXT,
STRET_NUM=B.ORIG_STRET_NUM,
STRET_NAME=B.ORIG_STRET_NAME,
APT_NUM=B.ORIG_APT_NUM,
PO_BOX_NUM=B.ORIG_PO_BOX_NUM,
CITY_NAME=B.ORIG_CITY_NAME,
TERR_NAME=B.ORIG_TERR_NAME,
POSTL_AREA_CODE=B.ORIG_POSTL_AREA_CODE
WHERE MATCHD_CNSMR_POSTL_ADDR.LEGAL_ENT_NBR=B.LEGAL_ENT_NBR
AND MATCHD_CNSMR_POSTL_ADDR.MATCHD_CNSMR_PRSNA_ID=B.MATCHD_CNSMR_PRSNA_ID
AND MATCHD_CNSMR_POSTL_ADDR.CNTCT_POINT_CATEG_CODE=B.CNTCT_POINT_CATEG_CODE;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL L21
UPDATE REGIS_PRSNA_OPT_HIST
FROM (SELECT DISTINCT
STG.MKTNG_PGM_NBR,
STG.REGIS_PRSNA_ID,
COALESCE(TRIM(STG.SRC_ADDR_LINE_1_TXT),'') ADDR_LINE_1_TXT1,
COALESCE(TRIM(STG.SRC_ADDR_LINE_2_TXT),'') ADDR_LINE_2_TXT1, 
COALESCE(TRIM(STG.SRC_ADDR_LINE_3_TXT),'') ADDR_LINE_3_TXT1, 
COALESCE(TRIM(STG.SRC_CITY_NAME),'') CITY_NAME1, 
COALESCE(TRIM(STG.SRC_STATE),'') TERR_NAME1,
COALESCE(TRIM(STG.SRC_ZIP),'') POSTL_AREA_CODE1, 
COALESCE(TRIM(STG.SRC_CNTRY_NAME),'') CNTRY_NAME1,
D.POSTL_ADDR_ID,
D.ORIG_ADDR_LINE_1_TXT,
D.ORIG_ADDR_LINE_2_TXT,
D.ORIG_ADDR_LINE_3_TXT,
D.ORIG_CITY_NAME,
D.ORIG_TERR_NAME,
D.ORIG_POSTL_AREA_CODE
FROM 
REGIS_PRSNA_OPT_HIST STG
LEFT JOIN CNTRY_RECODE D1
ON TRIM(STG.SRC_CNTRY_NAME)=D1.CNTRY
JOIN POSTL_ADDR D
ON COALESCE(TRIM(STG.SRC_ADDR_LINE_1_TXT),'')=D.ORIG_ADDR_LINE_1_TXT
AND COALESCE(TRIM(STG.SRC_ADDR_LINE_2_TXT),'')=D.ORIG_ADDR_LINE_2_TXT
AND COALESCE(TRIM(STG.SRC_ADDR_LINE_3_TXT),'')=D.ORIG_ADDR_LINE_3_TXT
AND COALESCE(TRIM(STG.SRC_CITY_NAME),'')=D.ORIG_CITY_NAME
AND COALESCE(TRIM(STG.SRC_STATE),'')=D.ORIG_TERR_NAME
AND COALESCE(TRIM(STG.SRC_ZIP),'')=D.ORIG_POSTL_AREA_CODE
AND COALESCE(D1.CNTRY_RECODE,TRIM(STG.SRC_CNTRY_NAME),'')=D.ORIG_CNTRY_INFO_TXT
AND (STG.LEGAL_ENT_NBR IN (SEL AV_CODE    
FROM ATTRIBUTE_VALUES
 WHERE ATTRIBUTE_TYPE_ID IN
 (SEL ATTRIBUTE_TYPE_ID 
 FROM ATTRIBUTE_TYPES
 WHERE ATTRIBUTE_TYPE='External Standardization')
 AND SYS_ENT_STATE='Active'))
 AND STG.LEGAL_ENT_NBR IN ($LE)
QUALIFY RANK() OVER (PARTITION BY STG.MKTNG_PGM_NBR,
STG.REGIS_PRSNA_ID,ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,
CITY_NAME1,TERR_NAME1,POSTL_AREA_CODE1,CNTRY_NAME1
ORDER BY D.LOG_SOURCE_ID DESC,D.POSTL_ADDR_ID DESC)=1) D
SET POSTL_ADDR_ID=D.POSTL_ADDR_ID,
ADDR_LINE_1_TXT=D.ORIG_ADDR_LINE_1_TXT,
ADDR_LINE_2_TXT=D.ORIG_ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT=D.ORIG_ADDR_LINE_3_TXT,
CITY_NAME=D.ORIG_CITY_NAME,
TERR_NAME=D.ORIG_TERR_NAME,
POSTL_AREA_CODE=D.ORIG_POSTL_AREA_CODE
WHERE REGIS_PRSNA_OPT_HIST.MKTNG_PGM_NBR=D.MKTNG_PGM_NBR
AND REGIS_PRSNA_OPT_HIST.REGIS_PRSNA_ID=D.REGIS_PRSNA_ID
AND COALESCE(TRIM(REGIS_PRSNA_OPT_HIST.SRC_ADDR_LINE_1_TXT),'')=D.ADDR_LINE_1_TXT1
AND COALESCE(TRIM(REGIS_PRSNA_OPT_HIST.SRC_ADDR_LINE_2_TXT),'')=D.ADDR_LINE_2_TXT1
AND COALESCE(TRIM(REGIS_PRSNA_OPT_HIST.SRC_ADDR_LINE_3_TXT),'')=D.ADDR_LINE_3_TXT1
AND COALESCE(TRIM(REGIS_PRSNA_OPT_HIST.SRC_CITY_NAME),'')=D.CITY_NAME1
AND COALESCE(TRIM(REGIS_PRSNA_OPT_HIST.SRC_STATE),'')=D.TERR_NAME1
AND COALESCE(TRIM(REGIS_PRSNA_OPT_HIST.SRC_ZIP),'')=D.POSTL_AREA_CODE1
AND COALESCE(TRIM(REGIS_PRSNA_OPT_HIST.SRC_CNTRY_NAME),'')=D.CNTRY_NAME1
AND (REGIS_PRSNA_OPT_HIST.LEGAL_ENT_NBR IN (SEL AV_CODE    
FROM ATTRIBUTE_VALUES
 WHERE ATTRIBUTE_TYPE_ID IN
 (SEL ATTRIBUTE_TYPE_ID 
 FROM ATTRIBUTE_TYPES
 WHERE ATTRIBUTE_TYPE='External Standardization')
 AND SYS_ENT_STATE='Active'))
 AND REGIS_PRSNA_OPT_HIST.LEGAL_ENT_NBR IN ($LE);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL L22
UPDATE STORE
FROM (SELECT DISTINCT
R.RETLR_NBR RETLR_NBR,
STG.STORE_NAME STORE_NAME,
STG.DATA_SRCE_NBR DATA_SRCE_NBR,
STG.LOAD_ID,
D.POSTL_ADDR_ID,
D.ORIG_ADDR_LINE_1_TXT,
D.ORIG_ADDR_LINE_2_TXT,
D.ORIG_ADDR_LINE_3_TXT,
D.ORIG_CITY_NAME,
D.ORIG_TERR_NAME,
D.ORIG_POSTL_AREA_CODE
FROM ICRM_STAGE.STORE_STG STG
LEFT JOIN CNTRY_RECODE D1
ON TRIM(STG.CNTRY_CD)=D1.CNTRY
INNER JOIN MDM.RETLR R
ON STG.RETLR_NAME=R.RETLR_NAME
AND STG.DATA_SRCE_NBR=R.DATA_SRCE_NBR
AND STG.PARENT_RETLR_NAME IS NOT NULL
JOIN POSTL_ADDR D
ON COALESCE(TRIM(STG.ADDR_LINE_1),'')=D.ORIG_ADDR_LINE_1_TXT
AND COALESCE(TRIM(STG.ADDR_LINE_2),'')=D.ORIG_ADDR_LINE_2_TXT
AND COALESCE(TRIM(STG.ADDR_LINE_3),'')=D.ORIG_ADDR_LINE_3_TXT
AND COALESCE(TRIM(STG.CITY),'')=D.ORIG_CITY_NAME
AND COALESCE(TRIM(STG.TERR),'')=D.ORIG_TERR_NAME
AND COALESCE(TRIM(STG.POSTL_AREA_CD),'')=D.ORIG_POSTL_AREA_CODE
AND COALESCE(D1.CNTRY_RECODE,TRIM(STG.CNTRY_CD),'')=D.ORIG_CNTRY_INFO_TXT
WHERE COALESCE(D1.CNTRY_RECODE,TRIM(STG.CNTRY_CD),'') IN (SEL AV_CODE    
FROM ATTRIBUTE_VALUES
 WHERE ATTRIBUTE_TYPE_ID IN
 (SEL ATTRIBUTE_TYPE_ID 
 FROM ATTRIBUTE_TYPES
 WHERE ATTRIBUTE_TYPE='External Standardization-Country')
 AND SYS_ENT_STATE='Active') 
 AND COALESCE(D1.CNTRY_RECODE,TRIM(STG.CNTRY_CD),'') IN ($CNTRY)
 QUALIFY RANK() OVER (PARTITION BY R.RETLR_NBR,
STG.STORE_NAME,
STG.DATA_SRCE_NBR ORDER BY STG.LOAD_ID DESC,D.ORIG_STRET_NUM DESC,D.ORIG_STRET_NAME DESC
,D.ORIG_APT_NUM DESC,D.ORIG_PO_BOX_NUM DESC)=1
UNION
SELECT DISTINCT
R.RETLR_NBR RETLR_NBR,
STG.STORE_NAME STORE_NAME,
STG.DATA_SRCE_NBR DATA_SRCE_NBR,
STG.LOAD_ID,
D.POSTL_ADDR_ID,
D.ORIG_ADDR_LINE_1_TXT,
D.ORIG_ADDR_LINE_2_TXT,
D.ORIG_ADDR_LINE_3_TXT,
D.ORIG_CITY_NAME,
D.ORIG_TERR_NAME,
D.ORIG_POSTL_AREA_CODE
FROM ICRM_STAGE.STORE_STG_HIST STG
LEFT JOIN CNTRY_RECODE D1
ON TRIM(STG.CNTRY_CD)=D1.CNTRY
INNER JOIN MDM.RETLR R
ON STG.RETLR_NAME=R.RETLR_NAME
AND STG.DATA_SRCE_NBR=R.DATA_SRCE_NBR
AND STG.PARENT_RETLR_NAME IS NOT NULL
JOIN POSTL_ADDR D
ON COALESCE(TRIM(STG.ADDR_LINE_1),'')=D.ORIG_ADDR_LINE_1_TXT
AND COALESCE(TRIM(STG.ADDR_LINE_2),'')=D.ORIG_ADDR_LINE_2_TXT
AND COALESCE(TRIM(STG.ADDR_LINE_3),'')=D.ORIG_ADDR_LINE_3_TXT
AND COALESCE(TRIM(STG.CITY),'')=D.ORIG_CITY_NAME
AND COALESCE(TRIM(STG.TERR),'')=D.ORIG_TERR_NAME
AND COALESCE(TRIM(STG.POSTL_AREA_CD),'')=D.ORIG_POSTL_AREA_CODE
AND COALESCE(D1.CNTRY_RECODE,TRIM(STG.CNTRY_CD),'')=D.ORIG_CNTRY_INFO_TXT
WHERE COALESCE(D1.CNTRY_RECODE,TRIM(STG.CNTRY_CD),'') IN (SEL AV_CODE    
FROM ATTRIBUTE_VALUES
 WHERE ATTRIBUTE_TYPE_ID IN
 (SEL ATTRIBUTE_TYPE_ID 
 FROM ATTRIBUTE_TYPES
 WHERE ATTRIBUTE_TYPE='External Standardization-Country')
 AND SYS_ENT_STATE='Active')
 AND COALESCE(D1.CNTRY_RECODE,TRIM(STG.CNTRY_CD),'') IN ($CNTRY)
 QUALIFY RANK() OVER (PARTITION BY R.RETLR_NBR,
STG.STORE_NAME,
STG.DATA_SRCE_NBR ORDER BY STG.LOAD_ID DESC,D.ORIG_STRET_NUM DESC,D.ORIG_STRET_NAME DESC
,D.ORIG_APT_NUM DESC,D.ORIG_PO_BOX_NUM DESC)=1 ) B
SET POSTL_ADDR_ID=B.POSTL_ADDR_ID,
ADDR_LINE_1_TXT=B.ORIG_ADDR_LINE_1_TXT,
ADDR_LINE_2_TXT=B.ORIG_ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT=B.ORIG_ADDR_LINE_3_TXT,
CITY_NAME=B.ORIG_CITY_NAME,
TERR_NAME=B.ORIG_TERR_NAME,
POSTL_AREA_CODE=B.ORIG_POSTL_AREA_CODE
WHERE STORE.RETLR_NBR=B.RETLR_NBR
AND STORE.STORE_NAME=B.STORE_NAME
AND STORE.DATA_SRCE_NBR=B.DATA_SRCE_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL L23