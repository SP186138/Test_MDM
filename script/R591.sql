CREATE TABLE ICRM_TBL.DPEND_TRT_R591_BKP AS ICRM_TBL.DPEND_TRT WITH NO DATA AND STATS;

NONTEMPORAL
INSERT INTO ICRM_TBL.DPEND_TRT_R591_BKP
(REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
DPEND_SEQ_NBR                 ,
DPEND_TRT_SEQ_NBR             ,
TRT_NBR                       ,
DPEND_TRT_DATE                ,
DPEND_TRT_TXT                 ,
LEGAL_ENT_NBR                 ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 ,
Temporal_time                 )
SEL DISTINCT 
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
DPEND_SEQ_NBR                 ,
DPEND_TRT_SEQ_NBR             ,
TRT_NBR                       ,
DPEND_TRT_DATE                ,
DPEND_TRT_TXT                 ,
LEGAL_ENT_NBR                 ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 ,
Temporal_time                  
FROM ICRM_TBL.DPEND_TRT
WHERE End(TEMPORAL_TIME) = TIMESTAMP '9999-12-31 23:59:59.999999+00:00';

RENAME TABLE ICRM_TBL.DPEND_TRT AS ICRM_TBL.DPEND_TRT_R591;

RENAME TABLE ICRM_TBL.DPEND_TRT_R591_BKP AS ICRM_TBL.DPEND_TRT;

COLLECT STATS ON ICRM_TBL.DPEND_TRT;

CREATE MULTISET TABLE icrm_tbl.PET_TRT_R591 ,NO FALLBACK ,
     NO BEFORE JOURNAL,
     NO AFTER JOURNAL,
     CHECKSUM = DEFAULT,
     DEFAULT MERGEBLOCKRATIO
     (
      REGIS_PRSNA_ID INTEGER NOT NULL,
      MKTNG_PGM_NBR INTEGER NOT NULL,
      PET_SEQ_NBR SMALLINT NOT NULL COMPRESS (1 ,2 ,3 ,4 ,5 ,6 ,7 ),
      PET_TRT_SEQ_NBR SMALLINT DEFAULT 1  COMPRESS 1 ,
      TRT_NBR SMALLINT NOT NULL COMPRESS (530 ,532 ,32 ,33 ,579 ,485 ,486 ),
      PET_TRT_DATE DATE FORMAT 'yyyy-mm-dd' COMPRESS ,
      PET_TRT_TXT VARCHAR(1000) CHARACTER SET UNICODE NOT CASESPECIFIC,
      LEGAL_ENT_NBR SMALLINT COMPRESS (6 ,15 ,16 ,20 ,23 ,28 ,29 ),
      SYS_SOURCE VARCHAR(20) CHARACTER SET LATIN NOT CASESPECIFIC,
      SYS_TARGET_ID INTEGER COMPRESS (0 ,7787 ,1164 ,1453 ,1225 ,1233 ,1500 ),
      SYS_AUTH_ID VARCHAR(20) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ,
      SYS_CREATED_BY VARCHAR(70) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ,
      SYS_CREATION_DATE TIMESTAMP(0) COMPRESS (TIMESTAMP '2015-02-28 07:52:00',TIMESTAMP '2012-07-26 17:08:12',TIMESTAMP '2014-10-10 05:55:12',TIMESTAMP '2015-05-13 06:30:20',TIMESTAMP '2014-11-18 08:26:48',TIMESTAMP '2015-05-14 08:14:13',TIMESTAMP '2015-05-29 08:39:13',TIMESTAMP '2012-08-06 08:07:17',TIMESTAMP '2015-03-31 11:15:21',TIMESTAMP '2015-04-22 18:23:21',TIMESTAMP '2012-08-20 16:57:25',TIMESTAMP '2012-08-01 05:53:29',TIMESTAMP '2014-09-21 08:39:33',TIMESTAMP '2015-08-02 11:03:49',TIMESTAMP '2012-07-31 19:37:57',TIMESTAMP '2015-03-24 13:21:57',TIMESTAMP '2015-02-26 00:39:14',TIMESTAMP '2014-11-17 15:29:18',TIMESTAMP '2015-01-24 17:57:18',TIMESTAMP '2015-02-25 12:48:18',TIMESTAMP '2015-07-20 10:42:18',TIMESTAMP '2014-09-22 05:49:50',TIMESTAMP '2012-07-26 15:56:54',TIMESTAMP '2015-03-04 00:17:54',TIMESTAMP '2014-10-30 12:37:51',TIMESTAMP '2015-03-24 22:16:51',TIMESTAMP '2015-05-13 11:55:51',TIMESTAMP '2015-02-26 03:52:03',TIMESTAMP '2015-05-12 22:02:03',TIMESTAMP '2012-03-06 23:33:07',TIMESTAMP '2015-05-05 10:39:23'),
      SYS_LAST_MODIFIED_DATE TIMESTAMP(0) COMPRESS (TIMESTAMP '2015-02-28 07:52:00',TIMESTAMP '2012-07-26 17:08:12',TIMESTAMP '2014-10-10 05:55:12',TIMESTAMP '2015-05-13 06:30:20',TIMESTAMP '2014-11-18 08:26:48',TIMESTAMP '2015-05-14 08:14:13',TIMESTAMP '2015-05-29 08:39:13',TIMESTAMP '2012-08-06 08:07:17',TIMESTAMP '2015-03-31 11:15:21',TIMESTAMP '2015-04-22 18:23:21',TIMESTAMP '2012-08-20 16:57:25',TIMESTAMP '2012-08-01 05:53:29',TIMESTAMP '2014-09-21 08:39:33',TIMESTAMP '2015-08-02 11:03:49',TIMESTAMP '2012-07-31 19:37:57',TIMESTAMP '2015-03-24 13:21:57',TIMESTAMP '2015-02-26 00:39:14',TIMESTAMP '2014-11-17 15:29:18',TIMESTAMP '2015-01-24 17:57:18',TIMESTAMP '2015-02-25 12:48:18',TIMESTAMP '2015-07-20 10:42:18',TIMESTAMP '2014-09-22 05:49:50',TIMESTAMP '2012-07-26 15:56:54',TIMESTAMP '2015-03-04 00:17:54',TIMESTAMP '2014-10-30 12:37:51',TIMESTAMP '2015-03-24 22:16:51',TIMESTAMP '2015-05-13 11:55:51',TIMESTAMP '2015-02-26 03:52:03',TIMESTAMP '2015-05-12 22:02:03',TIMESTAMP '2012-03-06 23:33:07',TIMESTAMP '2015-05-05 10:39:23'),
      SYS_ENT_STATE VARCHAR(20) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ,
      SYS_LAST_MODIFIED_BY VARCHAR(20) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ,
      SYS_NC_TYPE VARCHAR(20) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS 'INSERT',
      SYS_ERR_CODE VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ,
      SYS_ERR_SVRTY VARCHAR(30) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ,
      PREDFND_TRT_VAL_NBR SMALLINT COMPRESS )
PRIMARY INDEX PET_TRT_NUPI ( REGIS_PRSNA_ID ,MKTNG_PGM_NBR )
PARTITION BY MKTNG_PGM_NBR ;


INSERT INTO ICRM_TBL.PET_TRT_R591
(REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
PET_SEQ_NBR                   ,
PET_TRT_SEQ_NBR               ,
TRT_NBR                       ,
PET_TRT_DATE                  ,
PET_TRT_TXT                   ,
LEGAL_ENT_NBR                 ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 ,
PREDFND_TRT_VAL_NBR           )
SEL DISTINCT 
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
PET_SEQ_NBR                   ,
PET_TRT_SEQ_NBR               ,
TRT_NBR                       ,
PET_TRT_DATE                  ,
PET_TRT_TXT                   ,
LEGAL_ENT_NBR                 ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 ,
PREDFND_TRT_VAL_NBR           
FROM icrm_tbl.PET_TRT
WHERE (REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
PET_SEQ_NBR                 ,
PET_TRT_SEQ_NBR             ,
TRT_NBR                      ) IN
(SEL REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
PET_SEQ_NBR                 ,
PET_TRT_SEQ_NBR             ,
TRT_NBR                       
FROM icrm_tbl.PET_TRT
GROUP BY REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
PET_SEQ_NBR                 ,
PET_TRT_SEQ_NBR             ,
TRT_NBR                      
HAVING COUNT(*)>1);


DELETE FROM icrm_tbl.PET_TRT
WHERE (REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
PET_SEQ_NBR                 ,
PET_TRT_SEQ_NBR             ,
TRT_NBR                      ) IN
(SEL REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
PET_SEQ_NBR                 ,
PET_TRT_SEQ_NBR             ,
TRT_NBR                       
FROM ICRM_TBL.PET_TRT_R591);


INSERT INTO ICRM_TBL.PET_TRT
(REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
PET_SEQ_NBR                   ,
PET_TRT_SEQ_NBR               ,
TRT_NBR                       ,
PET_TRT_DATE                  ,
PET_TRT_TXT                   ,
LEGAL_ENT_NBR                 ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 ,
PREDFND_TRT_VAL_NBR           )
SEL DISTINCT 
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
PET_SEQ_NBR                   ,
PET_TRT_SEQ_NBR               ,
TRT_NBR                       ,
PET_TRT_DATE                  ,
PET_TRT_TXT                   ,
LEGAL_ENT_NBR                 ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 ,
PREDFND_TRT_VAL_NBR           
FROM icrm_tbl.PET_TRT_R591
QUALIFY RANK() OVER (PARTITION BY REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
PET_SEQ_NBR                 ,
PET_TRT_SEQ_NBR             ,
TRT_NBR 
ORDER BY SYS_SOURCE DESC)=1;