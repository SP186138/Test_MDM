/***********************************************************************************************************
SCRIPT:               PRSNA_SOCIAL_NETWK_ACCT_STG_VAL.BTEQ 
DESCRIPTION:          This script validates the records received from ETL Staging.
DEPENDENCY:           
INPUT:                ETL Staging
OUTPUT:               MST Staging
ERRORS:
SPECIAL INSTRUCTIONS:

CHANGE LOG:
VERSION              DATE                 AUTHOR                          CHANGES
1.00                 01/21/2011           TERADATA                        INITIAL VERSION
2.00                 08/22/2011           TERADATA                        Change OF Failure-BadFile
3.00                 10/31/2011           TERADATA                        Removal of Deletes as  part of ||elism
4.00                 03/26/2012		  TERADATA                        Made change in insert to LOAD_INFO to
                                                                          manipulate LA data
***********************************************************************************************************/

.logon $TDPID/$TDUSER,$TDPWD
 
.SET ERROROUT STDOUT;
.SET SESSION CHARSET 'UTF8';
.SET ERRORLEVEL 3624 SEVERITY 0


CREATE VOLATILE TABLE V_PRSNA_SOCNET
AS
(
SELECT A.* FROM 
$ETL_DB.PRSNA_SOCIAL_NETWK_ACCT_STG  A 
JOIN
 VALIDATION_$BTCH B
ON A.LOAD_ID = B.LOAD_ID)
WITH DATA
PRIMARY INDEX ( MKTNG_PGM_NBR ,REGIS_CNSMR_ID_VAL, LOAD_ID )
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE

CREATE VOLATILE TABLE V_CNTCT_OPTN_CHCE AS
(
SELECT A.* FROM $ETL_DB.CNTCT_OPTN_CHCE_STG  A 
JOIN
 VALIDATION_$BTCH B
ON A.LOAD_ID = B.LOAD_ID)
WITH DATA
PRIMARY INDEX ( MKTNG_PGM_NBR ,REGIS_CNSMR_ID_VAL, LOAD_ID )
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE


INSERT INTO VALIDATION_ERR_$BTCH 
SELECT
DER1.MKTNG_PGM_NBR,
DER1.REGIS_CNSMR_ID_VAL,
DER1.LOAD_ID,
'SOCIAL HAVING SAME CATEGORY CODE' SYS_ERR_CODE,
'PRSNA_SOCIAL_NETWK_ACCT_STG'
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
STG.LOAD_ID,
RECORD_IND
FROM
V_PRSNA_SOCNET STG
GROUP BY 1,2,3,4,5
HAVING COUNT(*) >1
)DER1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE


INSERT INTO VALIDATION_ERR_$BTCH 
SELECT
DER4.MKTNG_PGM_NBR,
DER4.REGIS_CNSMR_ID_VAL,
DER4.LOAD_ID,
'NOT A VALID CATEGORY CODE VALUE FOR SOCIAL' SYS_ERR_CODE,
'PRSNA_SOCIAL_NETWK_ACCT_STG'
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
STG.LOAD_ID
FROM
V_PRSNA_SOCNET STG
LEFT OUTER JOIN (
SEL A.AV_CODE  FROM ATTRIBUTE_VALUES A
INNER JOIN ATTRIBUTE_VALUES_HIERARCHY C
ON A.AV_ID = C.AV_ID_CHILD
INNER JOIN ATTRIBUTE_VALUES B
ON C.AV_ID_PARENT = B.AV_ID
AND B.AV_DESCRIPTION='Social Network Account'
) A
ON STG.CNTCT_POINT_CATEG_CODE = A.AV_CODE
WHERE A.AV_CODE IS NULL
)DER4;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE
/*
INSERT INTO VALIDATION_ERR_$BTCH (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, LOAD_ID, SYS_ERR_CODE,RECORD_SOURCE)
SELECT
DISTINCT
DER5.MKTNG_PGM_NBR,
DER5.REGIS_CNSMR_ID_VAL,
DER5.LOAD_ID,
'NOT A VALID SOCIAL OPTION NUMBER FOR MARKETING PROGRAM' SYS_ERR_CODE,
'PRSNA_SOCIAL_NETWK_ACCT_STG'
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
E.LOAD_ID
FROM
V_PRSNA_SOCNET E
INNER JOIN
V_CNTCT_OPTN_CHCE C
ON
E.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
E.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
E.CNTCT_POINT_CATEG_CODE = C.CNTCT_POINT_CATEG_CODE
AND
E.LOAD_ID = C.LOAD_ID
AND
C.CNTCT_POINT_TYPE_CODE='S'

WHERE (E.MKTNG_PGM_NBR, C.CNTCT_OPTN_NBR)NOT IN
(
SEL MKTNG_PGM_NBR,SUBSCRPTN_OPT_NBR 
FROM SUBSCRPTN_OPT_TYPE
WHERE CNTCT_CHANL_TYPE_CODE='S'
)
)DER5;

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE
*/
.EXIT