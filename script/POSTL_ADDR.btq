/***********************************************************************************************************
SCRIPT:               POSTAL_ADDR.BTEQ  
DESCRIPTION:          THIS SCRIPT LOADS EDW TABLES -- This scripts takes data friom ICRM_STAGE.EXTRN_POSTL_ADDR_STG 
                                                      and loads POSTL_ADDR and the following tables 
                                                      a.	REGIS_PRSNA_POSTL_ADDR
						      b.	MATCHD_CNSMR_POSTL_ADDR
						      c.	REGIS_PRSNA_OPT_HIST
						      d.	STORE

DEPENDENCY:           
INPUT:                ICRM_STAGE.EXTRN_POSTL_ADDR_STG
OUTPUT:               EDW
ERRORS:
SPECIAL INSTRUCTIONS:

CHANGE LOG:
VERSION              DATE                 AUTHOR                          CHANGES
5.7                  03/24/2016           TERADATA                        Release 5.7 - Update standardized address
                                                                          in case of external standardization
5.9                  02/06/2017           TERADATA                        Release 5.9 BR#595
                                                                          Add opt out process for address change in opt history
6.1                  12/06/2017           TERADATA                        Release 6.1 - Opt History Data Model Change                                                                          
***********************************************************************************************************/

.logon $TDPID/$TDUSER,$TDPWD


.SET ERROROUT STDOUT;      
.SET SESSION CHARSET 'UTF8';
.SET ERRORLEVEL 3624 SEVERITY 0
SET QUERY_BAND = 'WorkFlow=MDM;Interface=i20bMDM;Country=$CNTRY;Stage=ExtrnStdrdPostlUpdate;Step=Step01;' FOR SESSION; 
DATABASE $DATABASENAME;

INSERT INTO $DATABASENAME.LOAD_INFO
(
LOAD_ID,
PROCESS_NAME,
PROCESS_START_TIME,
PROCESS_END_TIME,
STATUS,
SYS_CREATION_DATE,
SYS_LAST_MODIFIED_DATE,
BATCH_ID) 
SELECT
LOAD.LOAD_ID,
'ExtrnStdrd Postl Update',
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
'In Progress',
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
LI.BATCH_ID
FROM $DATABASENAME.MDM_LOAD_CONTROL LOAD
LEFT OUTER JOIN LOAD_INFO LI
ON LOAD.LOAD_ID = LI.LOAD_ID

WHERE LI.LOAD_ID IS NULL
AND LOAD.LOAD_ID=$LOADID
GROUP BY
LOAD.LOAD_ID,
LI.BATCH_ID
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE

CREATE VOLATILE TABLE V_PRSNA_POSTL_ADDR
AS
(
SELECT DISTINCT
A.POSTL_ADDR_ID                 ,
A.EXTRACT_ID                    ,
A.ADDR_LINE_1_TXT               ,
A.ADDR_LINE_2_TXT               ,
A.ADDR_LINE_3_TXT               ,
A.STRET_NUM                     ,
A.STRET_NAME                    ,
A.APT_NUM                       ,
A.PO_BOX_NUM                    ,
A.CITY_NAME                     ,
A.POSTL_AREA_CODE               ,
A.CNTRY_CODE                    ,
A.PR_GEOCODE_FAIL               ,
A.DR_CLEANSE_LVL                ,
A.LAT_MEAS                      ,
A.LONG_MEAS                     ,
A.GL_ACCURACY                   ,
A.GL_MATCH_FLG                  ,
A.Filler1                       ,
A.Filler2                       ,
A.Filler3                       ,
A.Filler4                       ,
A.Filler5                       ,
A.Filler6                       ,
A.Filler7                       ,
A.Filler8                       ,
A.Filler9                       ,
A.Filler10                      ,
A.VALID_ADDR_IND                ,
A.SOURCE_ID                     ,
A.LOAD_ID                       ,
A.LOAD_TS                       ,
A.MDM_LOAD_IND                  
,CASE WHEN TR.TERR_RECODE IS NOT NULL
            THEN TR.TERR_RECODE
            ELSE A.TERR_NAME
  END AS TERR_NAME_INITIAL
,TERR_NAME_INITIAL AS TERR_CODE
,TERR_NAME_INITIAL AS TERR_NAME
,CAST('' AS VARCHAR(50)) AS CITY_CODE 
,CAST('' AS VARCHAR(1)) AS TQ_GOUT_MATCH_LEVEL 
,CAST('' AS VARCHAR(1)) AS PR_REV_GROUP 
FROM 
$ETL_DB.EXTRN_POSTL_ADDR_STG  A 
  INNER JOIN LOAD_INFO B
  ON A.LOAD_ID=B.LOAD_ID
  AND B.PROCESS_NAME='ExtrnStdrd Postl Update'
  AND B.STATUS = 'In Progress'
LEFT OUTER JOIN TERR_RECODE TR
ON A.TERR_NAME = TR.TERR
AND A.CNTRY_CODE = TR.CNTRY  )
WITH DATA
PRIMARY INDEX ( POSTL_ADDR_ID )
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE

COLLECT STATS V_PRSNA_POSTL_ADDR
COLUMN POSTL_ADDR_ID;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE
COLLECT STATS V_PRSNA_POSTL_ADDR
COLUMN POSTL_AREA_CODE;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE
COLLECT STATS V_PRSNA_POSTL_ADDR
COLUMN CNTRY_CODE;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE
COLLECT STATS V_PRSNA_POSTL_ADDR
COLUMN CITY_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE
COLLECT STATS V_PRSNA_POSTL_ADDR
COLUMN TERR_CODE;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE

/*********************************************************************************************
Update TERR_CODE from POSTL_AREA for Europe - RUS,POL,HUN,LUX,FRA,BEL,NLD,ITA,GRC,
AUT,CHE,DEU,ESP,IRL,DNK,FIN,NOR,SWE,GBR,PRT if TERR_CODE not sent by Trillium
**********************************************************************************************/
UPDATE V_PRSNA_POSTL_ADDR FROM 
(SEL T.POSTL_AREA_CODE,T.CNTRY_CODE,
--T.TERR_CODE,T.CITY_CODE,C.CITY_NAME --PRB0041004
T.TERR_CODE,T.CITY_CODE,COALESCE( NULLIF(C.CITY_NAME_NTV,''),C.CITY_NAME) AS CITY_NAME --PRB0041004
FROM
POSTL_AREA T
INNER JOIN CITY C
ON T.CITY_CODE=C.CITY_CODE
AND T.TERR_CODE=C.TERR_CODE
WHERE T.CNTRY_CODE IN(
'RUS','POL','HUN','LUX','FRA','BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK','FIN','NOR','SWE','GBR','PRT',
'TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM','EGY',
'ISR','KEN','MAR','NGA','ROU','ZAF','ARG','BOL','COL','CRI',
'DOM','ECU','GTM','HND','IDN','JAM','MYS','NIC','PAN','PER',
'PHL','SLV','VEN','BGR','UKR','HRV','CZE','PAK')
AND (T.POSTL_AREA_CODE,T.CNTRY_CODE) NOT IN (SEL POSTL_AREA_CODE,CNTRY_CODE FROM
(SEL CNTRY_CODE,TERR_CODE,POSTL_AREA_CODE,CITY_CODE
FROM POSTL_AREA
WHERE CNTRY_CODE IN(
'RUS','POL','HUN','LUX','FRA','BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK','FIN','NOR','SWE','GBR','PRT',
'TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM','EGY',
'ISR','KEN','MAR','NGA','ROU','ZAF','ARG','BOL','COL','CRI',
'DOM','ECU','GTM','HND','IDN','JAM','MYS','NIC','PAN','PER',
'PHL','SLV','VEN','BGR','UKR','HRV','CZE','PAK')
GROUP BY 1,2,3,4) B
GROUP BY 1,2
HAVING COUNT(*) >1)
GROUP BY 1,2,3,4,5
) T
SET TERR_CODE = CASE WHEN COALESCE(TRIM(V_PRSNA_POSTL_ADDR.TERR_CODE),'')=''
                     THEN T.TERR_CODE
                     ELSE V_PRSNA_POSTL_ADDR.TERR_CODE
                 END
,CITY_CODE = CASE WHEN COALESCE(TRIM(V_PRSNA_POSTL_ADDR.CITY_CODE),'')=''
                     THEN T.CITY_CODE
                     ELSE V_PRSNA_POSTL_ADDR.CITY_CODE
                 END
,CITY_NAME = CASE WHEN COALESCE(TRIM(V_PRSNA_POSTL_ADDR.CITY_NAME),'')=''
                     THEN T.CITY_NAME
                     ELSE V_PRSNA_POSTL_ADDR.CITY_NAME
                 END                 
WHERE V_PRSNA_POSTL_ADDR.POSTL_AREA_CODE = T.POSTL_AREA_CODE
AND V_PRSNA_POSTL_ADDR.CNTRY_CODE = T.CNTRY_CODE
AND V_PRSNA_POSTL_ADDR.CNTRY_CODE IN(
'RUS','POL','HUN','LUX','FRA','BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK','FIN','NOR','SWE','GBR','PRT',
'TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM','EGY',
'ISR','KEN','MAR','NGA','ROU','ZAF','ARG','BOL','COL','CRI',
'DOM','ECU','GTM','HND','IDN','JAM','MYS','NIC','PAN','PER',
'PHL','SLV','VEN','BGR','UKR','HRV','CZE','PAK');

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
Update TERR_CODE from POSTL_AREA for GBR - if TERR_CODE sent by Trillium does not exist
in TERR.
**********************************************************************************************/
UPDATE V_PRSNA_POSTL_ADDR FROM 
(SEL T.POSTL_AREA_CODE,T.CNTRY_CODE,
--T.TERR_CODE,T.CITY_CODE,C.CITY_NAME --PRB0041004
T.TERR_CODE,T.CITY_CODE,COALESCE( NULLIF(C.CITY_NAME_NTV,''),C.CITY_NAME) AS CITY_NAME --PRB0041004
FROM
POSTL_AREA T
INNER JOIN CITY C
ON T.CITY_CODE=C.CITY_CODE
AND T.TERR_CODE=C.TERR_CODE
WHERE T.CNTRY_CODE IN(
'RUS','POL','HUN','LUX','FRA','BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK','FIN','NOR','SWE','GBR','PRT',
'TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM','EGY',
'ISR','KEN','MAR','NGA','ROU','ZAF','ARG','BOL','COL','CRI',
'DOM','ECU','GTM','HND','IDN','JAM','MYS','NIC','PAN','PER',
'PHL','SLV','VEN','BGR','UKR','HRV','CZE','PAK')
AND (T.POSTL_AREA_CODE,T.CNTRY_CODE) NOT IN (SEL POSTL_AREA_CODE,CNTRY_CODE FROM
(SEL CNTRY_CODE,TERR_CODE,POSTL_AREA_CODE,CITY_CODE
FROM POSTL_AREA
WHERE CNTRY_CODE IN(
'RUS','POL','HUN','LUX','FRA','BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK','FIN','NOR','SWE','GBR','PRT',
'TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM','EGY',
'ISR','KEN','MAR','NGA','ROU','ZAF','ARG','BOL','COL','CRI',
'DOM','ECU','GTM','HND','IDN','JAM','MYS','NIC','PAN','PER',
'PHL','SLV','VEN','BGR','UKR','HRV','CZE','PAK')
GROUP BY 1,2,3,4) B
GROUP BY 1,2
HAVING COUNT(*) >1)
GROUP BY 1,2,3,4,5
) T
SET TERR_CODE = T.TERR_CODE
,CITY_CODE = T.CITY_CODE
,CITY_NAME = T.CITY_NAME           
WHERE V_PRSNA_POSTL_ADDR.POSTL_AREA_CODE = T.POSTL_AREA_CODE
AND V_PRSNA_POSTL_ADDR.CNTRY_CODE = T.CNTRY_CODE
AND V_PRSNA_POSTL_ADDR.TERR_CODE NOT IN 
(SEL TERR_CODE FROM TERR WHERE CNTRY_CODE IN 
('RUS','POL','HUN','LUX','FRA','BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK','FIN','NOR','SWE','GBR','PRT',
'TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM','EGY',
'ISR','KEN','MAR','NGA','ROU','ZAF','ARG','BOL','COL','CRI',
'DOM','ECU','GTM','HND','IDN','JAM','MYS','NIC','PAN','PER',
'PHL','SLV','VEN','BGR','UKR','HRV','CZE','PAK')) 
AND V_PRSNA_POSTL_ADDR.CNTRY_CODE IN ('RUS','POL','HUN','LUX','FRA','BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK','FIN','NOR','SWE','GBR','PRT',
'TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM','EGY',
'ISR','KEN','MAR','NGA','ROU','ZAF','ARG','BOL','COL','CRI',
'DOM','ECU','GTM','HND','IDN','JAM','MYS','NIC','PAN','PER',
'PHL','SLV','VEN','BGR','UKR','HRV','CZE','PAK');

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
This update is to populate the CITY_CODE from the CITY reference table FOR USA and CAN
Europe Included - RUS,POL,HUN,LUX,FRA,BEL,NLD,ITA,GRC,
AUT,CHE,DEU,ESP,IRL,DNK,FIN,NOR,SWE,GBR,PRT
**********************************************************************************************/
UPDATE V_PRSNA_POSTL_ADDR FROM CITY C
SET CITY_CODE = C.CITY_CODE
--WHERE V_PRSNA_POSTL_ADDR.CITY_NAME = C.CITY_NAME --PRB0041004
WHERE (V_PRSNA_POSTL_ADDR.CITY_NAME = C.CITY_NAME--PRB0041004
OR V_PRSNA_POSTL_ADDR.CITY_NAME = C.CITY_NAME_NTV)--PRB0041004
AND V_PRSNA_POSTL_ADDR.TERR_CODE = C.TERR_CODE 
AND NULLIF(TRIM(V_PRSNA_POSTL_ADDR.CITY_CODE),'') IS NULL
AND V_PRSNA_POSTL_ADDR.CNTRY_CODE IN('USA','CAN',
'RUS','POL','HUN','LUX','FRA','BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK','FIN','NOR','SWE','GBR','PRT',
'TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM','EGY',
'ISR','KEN','MAR','NGA','ROU','ZAF','ARG','BOL','COL','CRI',
'DOM','ECU','GTM','HND','IDN','JAM','MYS','NIC','PAN','PER',
'PHL','SLV','VEN','BGR','UKR','HRV','CZE','PAK');

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
This update is to populate the TERR_NAME from the TERR reference table FOR USA and CAN
Europe Included - RUS,POL,HUN,LUX,FRA,BEL,NLD,ITA,GRC,
AUT,CHE,DEU,ESP,IRL,DNK,FIN,NOR,SWE,GBR,PRT
**********************************************************************************************/

UPDATE V_PRSNA_POSTL_ADDR FROM TERR T
--SET TERR_NAME = T.TERR_NAME --PRB0041004
SET TERR_NAME = COALESCE( NULLIF(T.TERR_NAME_NTV,''),T.TERR_NAME) --PRB0041004
WHERE V_PRSNA_POSTL_ADDR.TERR_CODE = T.TERR_CODE
AND V_PRSNA_POSTL_ADDR.CNTRY_CODE IN('USA','CAN',
'RUS','POL','HUN','LUX','FRA','BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK','FIN','NOR','SWE','GBR','PRT',
'TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM','EGY',
'ISR','KEN','MAR','NGA','ROU','ZAF','ARG','BOL','COL','CRI',
'DOM','ECU','GTM','HND','IDN','JAM','MYS','NIC','PAN','PER',
'PHL','SLV','VEN','BGR','UKR','HRV','CZE','PAK');

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;


MERGE INTO POSTL_ADDR A
USING
(SELECT DISTINCT POSTL_ADDR_ID                 ,
ADDR_LINE_1_TXT               ,
ADDR_LINE_2_TXT               ,
ADDR_LINE_3_TXT               ,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
CITY_NAME                     ,
POSTL_AREA_CODE               ,
TERR_NAME                     ,
CNTRY_CODE                    ,
PR_GEOCODE_FAIL,
TQ_GOUT_MATCH_LEVEL,
PR_REV_GROUP,
LAT_MEAS,
LONG_MEAS,
GL_ACCURACY,
GL_MATCH_FLG,
DR_CLEANSE_LVL,
VALID_ADDR_IND,
TERR_CODE,
CITY_CODE,
TRIM(CAST(LOAD_ID AS INTEGER)) SYS_SOURCE                    
FROM V_PRSNA_POSTL_ADDR)
AS SRC
(
 V_POSTL_ADDR_ID                 ,
 V_ADDR_LINE_1_TXT               ,
 V_ADDR_LINE_2_TXT               ,
 V_ADDR_LINE_3_TXT               ,
 V_STRET_NUM                     ,
 V_STRET_NAME                    ,
 V_APT_NUM                       ,
 V_PO_BOX_NUM                    ,
 V_CITY_NAME                     ,
 V_POSTL_AREA_CODE               ,
 V_TERR_NAME                     ,
 V_CNTRY_CODE                    ,
V_PR_GEOCODE_FAIL,
V_TQ_GOUT_MATCH_LEVEL,
V_PR_REV_GROUP,
V_LAT_MEAS,
V_LONG_MEAS,
V_GL_ACCURACY,
V_GL_MATCH_FLG,
V_DR_CLEANSE_LVL,
V_VALID_ADDR_IND,
V_TERR_CODE,
V_CITY_CODE,
V_SYS_SOURCE                    
)

ON POSTL_ADDR_ID=V_POSTL_ADDR_ID

WHEN MATCHED THEN 
UPDATE
SET
ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT,
ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT,
STRET_NUM=V_STRET_NUM, 
STRET_NAME=V_STRET_NAME,
APT_NUM=V_APT_NUM,
PO_BOX_NUM=V_PO_BOX_NUM,
CITY_NAME=V_CITY_NAME,
TERR_NAME=V_TERR_NAME,
POSTL_AREA_CODE=V_POSTL_AREA_CODE,
CNTRY_CODE=V_CNTRY_CODE,
PR_GEOCODE_FAIL=V_PR_GEOCODE_FAIL,
TQ_GOUT_MATCH_LEVEL=V_TQ_GOUT_MATCH_LEVEL,
PR_REV_GROUP=V_PR_REV_GROUP,
LAT_MEAS=V_LAT_MEAS,
LONG_MEAS=V_LONG_MEAS,
GL_ACCURACY=V_GL_ACCURACY,
GL_MATCH_FLG=V_GL_MATCH_FLG,
DR_CLEANSE_LVL=V_DR_CLEANSE_LVL,
VALID_ADDR_IND=V_VALID_ADDR_IND,
TERR_CODE=V_TERR_CODE,
CITY_CODE=V_CITY_CODE,
LOG_SOURCE_ID=CAST(V_SYS_SOURCE AS INTEGER),
LOG_UPDATE_USER='I20B',
POSTL_STRD_STATUS_CD='SD'
;

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE V_PRSNA_POSTL_ADDR1
AS
(
SELECT  
B.MKTNG_PGM_NBR,
B.REGIS_PRSNA_ID,
B.CNTCT_POINT_CATEG_CODE,
A.POSTL_ADDR_ID                 ,
A.ADDR_LINE_1_TXT               ,
A.ADDR_LINE_2_TXT               ,
A.ADDR_LINE_3_TXT               ,
A.STRET_NUM                     ,
A.STRET_NAME                    ,
A.APT_NUM                       ,
A.PO_BOX_NUM                    ,
A.CITY_NAME                     ,
A.POSTL_AREA_CODE               ,
A.TERR_NAME                     ,
A.CNTRY_CODE                    ,
A.PR_GEOCODE_FAIL,
A.TQ_GOUT_MATCH_LEVEL,
A.PR_REV_GROUP,
A.LAT_MEAS,
A.LONG_MEAS,
A.GL_ACCURACY,
A.GL_MATCH_FLG,
A.DR_CLEANSE_LVL,
A.VALID_ADDR_IND,
A.TERR_CODE,
A.CITY_CODE,
TRIM(CAST(A.LOAD_ID AS INTEGER)) SYS_SOURCE                    
FROM V_PRSNA_POSTL_ADDR A
INNER JOIN REGIS_PRSNA_POSTL_ADDR B
ON A.POSTL_ADDR_ID=B.POSTL_ADDR_ID
GROUP BY 
B.MKTNG_PGM_NBR,
B.REGIS_PRSNA_ID,
B.CNTCT_POINT_CATEG_CODE,
A.POSTL_ADDR_ID                 ,
A.ADDR_LINE_1_TXT               ,
A.ADDR_LINE_2_TXT               ,
A.ADDR_LINE_3_TXT               ,
A.STRET_NUM                     ,
A.STRET_NAME                    ,
A.APT_NUM                       ,
A.PO_BOX_NUM                    ,
A.CITY_NAME                     ,
A.POSTL_AREA_CODE               ,
A.TERR_NAME                     ,
A.CNTRY_CODE                    ,
A.PR_GEOCODE_FAIL,
A.TQ_GOUT_MATCH_LEVEL,
A.PR_REV_GROUP,
A.LAT_MEAS,
A.LONG_MEAS,
A.GL_ACCURACY,
A.GL_MATCH_FLG,
A.DR_CLEANSE_LVL,
A.VALID_ADDR_IND,
A.TERR_CODE,
A.CITY_CODE,
TRIM(CAST(A.LOAD_ID AS INTEGER)))
WITH DATA
PRIMARY INDEX ( MKTNG_PGM_NBR, REGIS_PRSNA_ID )
PARTITION BY MKTNG_PGM_NBR
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE

COLLECT STATS V_PRSNA_POSTL_ADDR1
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE
COLLECT STATS V_PRSNA_POSTL_ADDR1
COLUMN REGIS_PRSNA_ID;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE

MERGE INTO REGIS_PRSNA_POSTL_ADDR A
USING
(SELECT  
MKTNG_PGM_NBR,
REGIS_PRSNA_ID,
CNTCT_POINT_CATEG_CODE,
POSTL_ADDR_ID                 ,
ADDR_LINE_1_TXT               ,
ADDR_LINE_2_TXT               ,
ADDR_LINE_3_TXT               ,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
CITY_NAME                     ,
POSTL_AREA_CODE               ,
TERR_NAME                     ,
CNTRY_CODE                    ,
PR_GEOCODE_FAIL,
TQ_GOUT_MATCH_LEVEL,
PR_REV_GROUP,
LAT_MEAS,
LONG_MEAS,
GL_ACCURACY,
GL_MATCH_FLG,
DR_CLEANSE_LVL,
VALID_ADDR_IND,
TERR_CODE,
CITY_CODE,
SYS_SOURCE                    
FROM V_PRSNA_POSTL_ADDR1)
AS SRC
(
V_MKTNG_PGM_NBR,
V_REGIS_PRSNA_ID,
V_CNTCT_POINT_CATEG_CODE,
 V_POSTL_ADDR_ID                 ,
 V_ADDR_LINE_1_TXT               ,
 V_ADDR_LINE_2_TXT               ,
 V_ADDR_LINE_3_TXT               ,
 V_STRET_NUM                     ,
 V_STRET_NAME                    ,
 V_APT_NUM                       ,
 V_PO_BOX_NUM                    ,
 V_CITY_NAME                     ,
 V_POSTL_AREA_CODE               ,
 V_TERR_NAME                     ,
 V_CNTRY_CODE                    ,
V_PR_GEOCODE_FAIL,
V_TQ_GOUT_MATCH_LEVEL,
V_PR_REV_GROUP,
V_LAT_MEAS,
V_LONG_MEAS,
V_GL_ACCURACY,
V_GL_MATCH_FLG,
V_DR_CLEANSE_LVL,
V_VALID_ADDR_IND,
V_TERR_CODE,
V_CITY_CODE,
V_SYS_SOURCE                    
)

ON MKTNG_PGM_NBR=V_MKTNG_PGM_NBR
AND REGIS_PRSNA_ID=V_REGIS_PRSNA_ID
AND CNTCT_POINT_CATEG_CODE=V_CNTCT_POINT_CATEG_CODE
AND POSTL_ADDR_ID=V_POSTL_ADDR_ID

WHEN MATCHED THEN 
UPDATE
SET
ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT,
ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT,
STRET_NUM=V_STRET_NUM, 
STRET_NAME=V_STRET_NAME,
APT_NUM=V_APT_NUM,
PO_BOX_NUM=V_PO_BOX_NUM,
CITY_NAME=V_CITY_NAME,
TERR_NAME=V_TERR_NAME,
POSTL_AREA_CODE=V_POSTL_AREA_CODE,
CNTRY_CODE=V_CNTRY_CODE,
PR_GEOCODE_FAIL=V_PR_GEOCODE_FAIL,
TQ_GOUT_MATCH_LEVEL=V_TQ_GOUT_MATCH_LEVEL,
PR_REV_GROUP=V_PR_REV_GROUP,
LAT_MEAS=V_LAT_MEAS,
LONG_MEAS=V_LONG_MEAS,
GL_ACCURACY=V_GL_ACCURACY,
GL_MATCH_FLG=V_GL_MATCH_FLG,
DR_CLEANSE_LVL=V_DR_CLEANSE_LVL,
VALID_CNTCT_POINT_IND=V_VALID_ADDR_IND,
TERR_CODE=V_TERR_CODE,
CITY_CODE=V_CITY_CODE,
SYS_SOURCE=V_SYS_SOURCE,
SYS_LAST_MODIFIED_BY='I20B',
SYS_LAST_MODIFIED_DATE=CURRENT_TIMESTAMP(0)
;

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT EXTRN_PRSNA_IDS 
(MKTNG_PGM_NBR,
REGIS_PRSNA_ID,
SYS_SOURCE,
CNTRY_CODE)
SELECT DISTINCT 
MKTNG_PGM_NBR,
REGIS_PRSNA_ID,
SYS_SOURCE,
CNTRY_CODE                  
FROM V_PRSNA_POSTL_ADDR1
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE V_PRSNA_POSTL_ADDR2
AS
(
SELECT  
B.LEGAL_ENT_NBR,
B.MATCHD_CNSMR_PRSNA_ID,
B.CNTCT_POINT_CATEG_CODE,
A.POSTL_ADDR_ID                 ,
A.ADDR_LINE_1_TXT               ,
A.ADDR_LINE_2_TXT               ,
A.ADDR_LINE_3_TXT               ,
A.STRET_NUM                     ,
A.STRET_NAME                    ,
A.APT_NUM                       ,
A.PO_BOX_NUM                    ,
A.CITY_NAME                     ,
A.POSTL_AREA_CODE               ,
A.TERR_NAME                     ,
A.CNTRY_CODE                    ,
A.PR_GEOCODE_FAIL,
A.TQ_GOUT_MATCH_LEVEL,
A.PR_REV_GROUP,
A.LAT_MEAS,
A.LONG_MEAS,
A.GL_ACCURACY,
A.GL_MATCH_FLG,
A.DR_CLEANSE_LVL,
A.VALID_ADDR_IND,
A.TERR_CODE,
A.CITY_CODE,
TRIM(CAST(A.LOAD_ID AS INTEGER)) SYS_SOURCE                    
FROM V_PRSNA_POSTL_ADDR A
INNER JOIN MATCHD_CNSMR_POSTL_ADDR B
ON A.POSTL_ADDR_ID=B.POSTL_ADDR_ID
GROUP BY
B.LEGAL_ENT_NBR,
B.MATCHD_CNSMR_PRSNA_ID,
B.CNTCT_POINT_CATEG_CODE,
A.POSTL_ADDR_ID                 ,
A.ADDR_LINE_1_TXT               ,
A.ADDR_LINE_2_TXT               ,
A.ADDR_LINE_3_TXT               ,
A.STRET_NUM                     ,
A.STRET_NAME                    ,
A.APT_NUM                       ,
A.PO_BOX_NUM                    ,
A.CITY_NAME                     ,
A.POSTL_AREA_CODE               ,
A.TERR_NAME                     ,
A.CNTRY_CODE                    ,
A.PR_GEOCODE_FAIL,
A.TQ_GOUT_MATCH_LEVEL,
A.PR_REV_GROUP,
A.LAT_MEAS,
A.LONG_MEAS,
A.GL_ACCURACY,
A.GL_MATCH_FLG,
A.DR_CLEANSE_LVL,
A.VALID_ADDR_IND,
A.TERR_CODE,
A.CITY_CODE,
TRIM(CAST(A.LOAD_ID AS INTEGER)))
WITH DATA
PRIMARY INDEX ( LEGAL_ENT_NBR, MATCHD_CNSMR_PRSNA_ID )
PARTITION BY LEGAL_ENT_NBR
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE

MERGE INTO MATCHD_CNSMR_POSTL_ADDR A
USING
(SELECT  
LEGAL_ENT_NBR,
MATCHD_CNSMR_PRSNA_ID,
CNTCT_POINT_CATEG_CODE,
POSTL_ADDR_ID                 ,
ADDR_LINE_1_TXT               ,
ADDR_LINE_2_TXT               ,
ADDR_LINE_3_TXT               ,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
CITY_NAME                     ,
POSTL_AREA_CODE               ,
TERR_NAME                     ,
CNTRY_CODE                    ,
PR_GEOCODE_FAIL,
TQ_GOUT_MATCH_LEVEL,
PR_REV_GROUP,
LAT_MEAS,
LONG_MEAS,
GL_ACCURACY,
GL_MATCH_FLG,
DR_CLEANSE_LVL,
VALID_ADDR_IND,
TERR_CODE,
CITY_CODE,
SYS_SOURCE                    
FROM V_PRSNA_POSTL_ADDR2)
AS SRC
(
 V_LEGAL_ENT_NBR,
 V_MATCHD_CNSMR_PRSNA_ID,
 V_CNTCT_POINT_CATEG_CODE,
 V_POSTL_ADDR_ID                 ,
 V_ADDR_LINE_1_TXT               ,
 V_ADDR_LINE_2_TXT               ,
 V_ADDR_LINE_3_TXT               ,
 V_STRET_NUM                     ,
 V_STRET_NAME                    ,
 V_APT_NUM                       ,
 V_PO_BOX_NUM                    ,
 V_CITY_NAME                     ,
 V_POSTL_AREA_CODE               ,
 V_TERR_NAME                     ,
 V_CNTRY_CODE                    ,
V_PR_GEOCODE_FAIL,
V_TQ_GOUT_MATCH_LEVEL,
V_PR_REV_GROUP,
V_LAT_MEAS,
V_LONG_MEAS,
V_GL_ACCURACY,
V_GL_MATCH_FLG,
V_DR_CLEANSE_LVL,
V_VALID_ADDR_IND,
V_TERR_CODE,
V_CITY_CODE,
V_SYS_SOURCE                    
)

ON  LEGAL_ENT_NBR=V_LEGAL_ENT_NBR
AND MATCHD_CNSMR_PRSNA_ID=V_MATCHD_CNSMR_PRSNA_ID
AND CNTCT_POINT_CATEG_CODE=V_CNTCT_POINT_CATEG_CODE
AND POSTL_ADDR_ID=V_POSTL_ADDR_ID

WHEN MATCHED THEN 
UPDATE
SET
ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT,
ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT,
STRET_NUM=V_STRET_NUM, 
STRET_NAME=V_STRET_NAME,
APT_NUM=V_APT_NUM,
PO_BOX_NUM=V_PO_BOX_NUM,
CITY_NAME=V_CITY_NAME,
TERR_NAME=V_TERR_NAME,
POSTL_AREA_CODE=V_POSTL_AREA_CODE,
CNTRY_CODE=V_CNTRY_CODE,
LAT_MEAS=V_LAT_MEAS,
LONG_MEAS=V_LONG_MEAS,
VALID_CNTCT_POINT_IND=V_VALID_ADDR_IND,
TERR_CODE=V_TERR_CODE,
CITY_CODE=V_CITY_CODE,
SYS_SOURCE=V_SYS_SOURCE,
SYS_LAST_MODIFIED_BY='I20B',
SYS_LAST_MODIFIED_DATE=CURRENT_TIMESTAMP(0)
;

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE V_PRSNA_POSTL_ADDR3
AS
(
SELECT DISTINCT 
B.MKTNG_PGM_NBR,
B.OPT_OUT_DRCTV_ID REGIS_PRSNA_ID,
B.LEGAL_ENT_NBR,
B.SUBSCRIPTION_NBR,
B.CHANNEL_IND,
B.OPT_LEVEL_IND, 
B.OPT_TIME ,
A.POSTL_ADDR_ID                 ,
A.ADDR_LINE_1_TXT               ,
A.ADDR_LINE_2_TXT               ,
A.ADDR_LINE_3_TXT               ,
A.STRET_NUM                     ,
A.STRET_NAME                    ,
A.APT_NUM                       ,
A.PO_BOX_NUM                    ,
A.CITY_NAME                     ,
A.POSTL_AREA_CODE               ,
A.TERR_NAME                     ,
A.CNTRY_CODE                    ,
A.PR_GEOCODE_FAIL,
A.TQ_GOUT_MATCH_LEVEL,
A.PR_REV_GROUP,
A.LAT_MEAS,
A.LONG_MEAS,
A.GL_ACCURACY,
A.GL_MATCH_FLG,
A.DR_CLEANSE_LVL,
A.VALID_ADDR_IND,
A.TERR_CODE,
A.CITY_CODE,
Trim(Cast(A.LOAD_ID AS INTEGER)) SYS_SOURCE                    
FROM V_PRSNA_POSTL_ADDR A
INNER JOIN OPT_OUT_DIRECTIVE B
ON A.POSTL_ADDR_ID=B.POSTL_ADDR_ID)
WITH DATA
PRIMARY INDEX ( MKTNG_PGM_NBR, REGIS_PRSNA_ID )
PARTITION BY MKTNG_PGM_NBR
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE

MERGE INTO OPT_OUT_DIRECTIVE A
USING
(SELECT 
REGIS_PRSNA_ID,
MKTNG_PGM_NBR,
LEGAL_ENT_NBR,
SUBSCRIPTION_NBR,
CHANNEL_IND,
OPT_LEVEL_IND, 
OPT_TIME ,
POSTL_ADDR_ID                 ,
ADDR_LINE_1_TXT               ,
ADDR_LINE_2_TXT               ,
ADDR_LINE_3_TXT               ,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
CITY_NAME                     ,
POSTL_AREA_CODE               ,
TERR_NAME                     ,
CNTRY_CODE                    ,
PR_GEOCODE_FAIL,
TQ_GOUT_MATCH_LEVEL,
PR_REV_GROUP,
LAT_MEAS,
LONG_MEAS,
GL_ACCURACY,
GL_MATCH_FLG,
DR_CLEANSE_LVL,
VALID_ADDR_IND,
TERR_CODE,
CITY_CODE,
SYS_SOURCE                    
FROM V_PRSNA_POSTL_ADDR3)
AS SRC
(
 V_REGIS_PRSNA_ID,
 V_MKTNG_PGM_NBR,
 V_LEGAL_ENT_NBR,
 V_SUBSCRIPTION_NBR,
 V_CHANNEL_IND,
 V_OPT_LEVEL_IND, 
 V_OPT_TIME ,
 V_POSTL_ADDR_ID                 ,
 V_ADDR_LINE_1_TXT               ,
 V_ADDR_LINE_2_TXT               ,
 V_ADDR_LINE_3_TXT               ,
 V_STRET_NUM                     ,
 V_STRET_NAME                    ,
 V_APT_NUM                       ,
 V_PO_BOX_NUM                    ,
 V_CITY_NAME                     ,
 V_POSTL_AREA_CODE               ,
 V_TERR_NAME                     ,
 V_CNTRY_CODE                    ,
V_PR_GEOCODE_FAIL,
V_TQ_GOUT_MATCH_LEVEL,
V_PR_REV_GROUP,
V_LAT_MEAS,
V_LONG_MEAS,
V_GL_ACCURACY,
V_GL_MATCH_FLG,
V_DR_CLEANSE_LVL,
V_VALID_ADDR_IND,
V_TERR_CODE,
V_CITY_CODE,
V_SYS_SOURCE                    
)

ON POSTL_ADDR_ID=V_POSTL_ADDR_ID
AND OPT_OUT_DRCTV_ID=V_REGIS_PRSNA_ID
AND MKTNG_PGM_NBR=V_MKTNG_PGM_NBR
AND LEGAL_ENT_NBR=V_LEGAL_ENT_NBR
AND SUBSCRIPTION_NBR=V_SUBSCRIPTION_NBR
AND CHANNEL_IND=V_CHANNEL_IND
AND OPT_LEVEL_IND=V_OPT_LEVEL_IND
AND OPT_TIME=V_OPT_TIME 

WHEN MATCHED THEN 
UPDATE
SET
ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT,
ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT,
CITY_NAME=V_CITY_NAME,
TERR_NAME=V_TERR_NAME,
POSTL_AREA_CODE=V_POSTL_AREA_CODE,
CNTRY_NAME=V_CNTRY_CODE,
LOG_SOURCE_ID=CAST(V_SYS_SOURCE AS INTEGER),
LOG_UPDATE_USER='I20B'
;

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL OPTPROCESS

CREATE VOLATILE TABLE OPT_OUT_HIST AS (
SELECT
B.REGIS_PRSNA_ID                ,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.DATA_SRCE_NBR                 ,
B.SUBSCRIPTION_NBR              ,
B.FIRST_NAME                    ,
B.LAST_NAME                     ,
B.EMAIL_ADDR_TEXT              ,
B.CONTACT_PHONE_NBR             ,
B.SRC_ADDR_LINE_1_TXT           ,
B.SRC_ADDR_LINE_2_TXT           ,
B.SRC_ADDR_LINE_3_TXT           ,
B.SRC_CITY_NAME                 ,
B.SRC_STATE                     ,
B.SRC_ZIP                       ,
B.SRC_CNTRY_NAME                ,
COALESCE(TRIM(B.ADDR_LINE_1_TXT),'') ADDR_LINE_1_TXT              ,
COALESCE(TRIM(B.ADDR_LINE_2_TXT),'') ADDR_LINE_2_TXT              ,
COALESCE(TRIM(B.ADDR_LINE_3_TXT),'') ADDR_LINE_3_TXT              ,
COALESCE(TRIM(B.CITY_NAME      ),'') CITY_NAME              ,
COALESCE(TRIM(B.TERR_NAME      ),'') TERR_NAME              ,
COALESCE(TRIM(B.POSTL_AREA_CODE),'') POSTL_AREA_CODE              ,
COALESCE(TRIM(B.CNTRY_NAME     ),'') CNTRY_NAME              ,
B.OPT_IND                       ,
B.OPT_TIME                  ,
B.OPT_REASN_TXT             ,
B.OPT_TYPE_CODE,
B.LAST_ACTIVITY_TM              ,
B.LOG_SOURCE_ID                 ,
B.LOG_UPDATE_USER               ,
B.LOG_LOAD_ID             ,
B.PE_OPTOUT_ID   ,
B.NATIONAL_ID_NBR	,
B.CHANNEL_IND    ,
B.OPT_LEVEL_IND  
FROM REGIS_PRSNA_OPT_OUT_HIST  B
INNER JOIN V_PRSNA_POSTL_ADDR A
ON A.POSTL_ADDR_ID=B.POSTL_ADDR_ID
WHERE B.OPT_LEVEL_IND IS NOT NULL 
AND B.OPT_IND='O' 
AND COALESCE(TRIM(B.ADDR_LINE_1_TXT),TRIM(B.ADDR_LINE_2_TXT),TRIM(B.ADDR_LINE_3_TXT),'') <> ''
QUALIFY RANK() OVER(PARTITION BY COALESCE(TRIM(B.ADDR_LINE_1_TXT),'') ,
COALESCE(TRIM(B.ADDR_LINE_2_TXT),'') ,
COALESCE(TRIM(B.ADDR_LINE_3_TXT),'') ,
COALESCE(TRIM(B.CITY_NAME      ),'') ,
COALESCE(TRIM(B.TERR_NAME      ),'') ,
COALESCE(TRIM(B.POSTL_AREA_CODE),'') ,
COALESCE(TRIM(B.CNTRY_NAME     ),'') ,
COALESCE(TRIM(B.LAST_NAME     ),'')
,B.MKTNG_PGM_NBR,B.LEGAL_ENT_NBR,B.SUBSCRIPTION_NBR,B.CHANNEL_IND,B.OPT_LEVEL_IND  
ORDER BY B.OPT_TIME DESC,B.LOG_SOURCE_ID DESC,B.REGIS_PRSNA_ID DESC)=1
)
WITH DATA
PRIMARY INDEX (CNTRY_NAME,ADDR_LINE_1_TXT,ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT,CITY_NAME,TERR_NAME,POSTL_AREA_CODE,MKTNG_PGM_NBR,OPT_TIME,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS OPT_OUT_HIST
COLUMN ADDR_LINE_1_TXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN ADDR_LINE_2_TXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN ADDR_LINE_3_TXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN CITY_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN TERR_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN POSTL_AREA_CODE;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN CNTRY_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN LAST_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN OPT_TIME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
CREATE VOLATILE TABLE POSTL AS (
SELECT	
COALESCE(TRIM(ADJ.CNTRY_CODE),'') CNTRY_NAME, 
COALESCE(TRIM(ADJ.ADDR_LINE_1_TXT),'') ADDR_LINE_1_TXT, 
COALESCE(TRIM(ADJ.ADDR_LINE_2_TXT),'') ADDR_LINE_2_TXT,
COALESCE(TRIM(ADJ.ADDR_LINE_3_TXT),'') ADDR_LINE_3_TXT,
COALESCE(TRIM(ADJ.CITY_NAME),'') CITY_NAME,
COALESCE(TRIM(ADJ.TERR_NAME),'') TERR_NAME,
COALESCE(TRIM(ADJ.POSTL_AREA_CODE),'') POSTL_AREA_CODE,
ADJ.MKTNG_PGM_NBR, 
ADJ.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR,
ADJ.LEGAL_ENT_NBR,
ADJ.SYS_TARGET_ID,
ADJ.REGIS_PRSNA_ID,
ADJ.CNSMR_CHCE_DATETM,
CAST(ADJ.SYS_SOURCE AS INTEGER) SYS_SOURCE
FROM REGIS_PRSNA_POSTL_ADDR ADJ
WHERE COALESCE(TRIM(ADDR_LINE_1_TXT),TRIM(ADDR_LINE_2_TXT),TRIM(ADDR_LINE_3_TXT),'') <> ''
AND COALESCE(TRIM(ADDR_LINE_1_TXT),'') IN (SEL ADDR_LINE_1_TXT FROM OPT_OUT_HIST)
)
WITH DATA
PRIMARY INDEX (CNTRY_NAME,ADDR_LINE_1_TXT,ADDR_LINE_2_TXT,ADDR_LINE_3_TXT,
CITY_NAME,TERR_NAME,POSTL_AREA_CODE,MKTNG_PGM_NBR,CNSMR_CHCE_DATETM,REGIS_PRSNA_ID)
INDEX (MKTNG_PGM_NBR,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS POSTL
COLUMN ADDR_LINE_1_TXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN ADDR_LINE_2_TXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN ADDR_LINE_3_TXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN CITY_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN TERR_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN POSTL_AREA_CODE;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN CNTRY_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN CNSMR_CHCE_DATETM;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN REGIS_PRSNA_ID;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE TEMP1 AS (
SEL MATCHD_CNSMR_PRSNA_ID,LEGAL_ENT_NBR,
HSHLD_PRSNA_ID FROM
MATCHD_CNSMR_PRSNA 
)
WITH DATA
PRIMARY INDEX (MATCHD_CNSMR_PRSNA_ID,LEGAL_ENT_NBR)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE TEMP2 AS (
SEL HSHLD_PRSNA_ID,LEGAL_ENT_NBR,
MATCHD_CNSMR_PRSNA_ID FROM
MATCHD_CNSMR_PRSNA 
)
WITH DATA
PRIMARY INDEX (HSHLD_PRSNA_ID,LEGAL_ENT_NBR, MATCHD_CNSMR_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE TEMP3 AS (
SEL MATCHD_CNSMR_PRSNA_ID,LEGAL_ENT_NBR,
REGIS_PRSNA_ID,
MKTNG_PGM_NBR,DATA_SRCE_NBR FROM
REGIS_PRSNA 
WHERE MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM)
)
WITH DATA
PRIMARY INDEX (MATCHD_CNSMR_PRSNA_ID,LEGAL_ENT_NBR)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE PRSNA_ID AS (
SEL 
RP.REGIS_PRSNA_ID,
RP.MKTNG_PGM_NBR
FROM REGIS_PRSNA RP

INNER JOIN POSTL A
ON A.MKTNG_PGM_NBR=RP.MKTNG_PGM_NBR
AND A.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID
)
WITH DATA
PRIMARY INDEX (REGIS_PRSNA_ID,MKTNG_PGM_NBR)
PARTITION BY MKTNG_PGM_NBR
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;


CREATE VOLATILE TABLE OPT_OUT_PRSNA_ID AS (
SEL 
RP.REGIS_PRSNA_ID,
RP.MKTNG_PGM_NBR,
RP2.REGIS_PRSNA_ID RP2_REGIS_PRSNA_ID,
RP2.MKTNG_PGM_NBR RP2_MKTNG_PGM_NBR,
RP2.LEGAL_ENT_NBR RP2_LEGAL_ENT_NBR,
RP2.DATA_SRCE_NBR RP2_DATA_SRCE_NBR
FROM REGIS_PRSNA RP

INNER JOIN TEMP3 RP2
ON RP2.MATCHD_CNSMR_PRSNA_ID=RP.MATCHD_CNSMR_PRSNA_ID 
AND RP2.LEGAL_ENT_NBR = RP.LEGAL_ENT_NBR

INNER JOIN PRSNA_ID A
ON A.MKTNG_PGM_NBR=RP.MKTNG_PGM_NBR
AND A.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID
)
WITH DATA
PRIMARY INDEX (REGIS_PRSNA_ID,MKTNG_PGM_NBR)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE OPT_OUT_PRSNA_ID2 AS (
SEL 
RP.REGIS_PRSNA_ID,
RP.MKTNG_PGM_NBR,
RP2.REGIS_PRSNA_ID RP2_REGIS_PRSNA_ID,
RP2.MKTNG_PGM_NBR RP2_MKTNG_PGM_NBR,
RP2.LEGAL_ENT_NBR RP2_LEGAL_ENT_NBR,
RP2.DATA_SRCE_NBR RP2_DATA_SRCE_NBR
FROM REGIS_PRSNA RP

INNER JOIN TEMP3 RP2
ON RP2.MATCHD_CNSMR_PRSNA_ID=RP.MATCHD_CNSMR_PRSNA_ID 
AND RP2.LEGAL_ENT_NBR = RP.LEGAL_ENT_NBR
AND RP2.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

INNER JOIN PRSNA_ID A
ON A.MKTNG_PGM_NBR=RP.MKTNG_PGM_NBR
AND A.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID
)
WITH DATA
PRIMARY INDEX (REGIS_PRSNA_ID,MKTNG_PGM_NBR)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE TEMP4 AS (
SEL 
RP.REGIS_PRSNA_ID,
RP.MKTNG_PGM_NBR,
MC.HSHLD_PRSNA_ID,
MC.LEGAL_ENT_NBR,
MC.MATCHD_CNSMR_PRSNA_ID
FROM REGIS_PRSNA RP

INNER JOIN TEMP1 MC
ON RP.MATCHD_CNSMR_PRSNA_ID=MC.MATCHD_CNSMR_PRSNA_ID 
AND RP.LEGAL_ENT_NBR = MC.LEGAL_ENT_NBR

INNER JOIN PRSNA_ID A
ON A.MKTNG_PGM_NBR=RP.MKTNG_PGM_NBR
AND A.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID
)
WITH DATA
PRIMARY INDEX (MKTNG_PGM_NBR,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE OPT_OUT_HSHLD_ID AS (
SEL 
RP.REGIS_PRSNA_ID,
RP.MKTNG_PGM_NBR,
RP3.REGIS_PRSNA_ID RP3_REGIS_PRSNA_ID,
RP3.MKTNG_PGM_NBR RP3_MKTNG_PGM_NBR,
RP3.LEGAL_ENT_NBR RP3_LEGAL_ENT_NBR,
RP3.DATA_SRCE_NBR RP3_DATA_SRCE_NBR
FROM TEMP4 RP

INNER JOIN TEMP2 MC1
ON MC1.HSHLD_PRSNA_ID=RP.HSHLD_PRSNA_ID 
AND MC1.LEGAL_ENT_NBR = RP.LEGAL_ENT_NBR

INNER JOIN TEMP3 RP3
ON MC1.MATCHD_CNSMR_PRSNA_ID=RP3.MATCHD_CNSMR_PRSNA_ID 
AND MC1.LEGAL_ENT_NBR = RP3.LEGAL_ENT_NBR
)
WITH DATA
PRIMARY INDEX (REGIS_PRSNA_ID,MKTNG_PGM_NBR,RP3_REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

DELETE FROM I20B_OPT_OUT_LOG_TEMP ALL;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'1'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'
 
INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

INNER JOIN OPT_OUT_PRSNA_ID RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'1'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;


INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'2'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'2'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'3'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

INNER JOIN REGIS_PRSNA RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'3'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;


INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'4'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'4'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'5'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

INNER JOIN REGIS_PRSNA RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'5'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'6'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

INNER JOIN REGIS_PRSNA RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'6'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP3_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'7'					EDW_OPT_TYPE_CODE,
RP.RP3_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP3_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP3_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'H'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'H'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

INNER JOIN OPT_OUT_HSHLD_ID RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP3_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'7'					EDW_OPT_TYPE_CODE,
RP.RP3_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP3_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP3_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'H'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'H'

INNER JOIN OPT_OUT_HSHLD_ID RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'8'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'A'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'A'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM )

INNER JOIN OPT_OUT_PRSNA_ID RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO I20B_OPT_OUT_LOG_TEMP
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'8'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'A'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'A'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

SEL DISTINCT 1 FROM I20B_OPT_OUT_LOG_TEMP;
.IF ACTIVITYCOUNT > 0 THEN .GOTO UPD
.IF ACTIVITYCOUNT = 0 THEN .GOTO UPDT

.GOTO EXIT

.LABEL UPD

UPDATE OPT_OUT_NOT_FOUND
SET MATCH_FLG='Y'
WHERE PE_OPTOUT_ID IN 
(SELECT STG_PE_OPTOUT_ID
FROM I20B_OPT_OUT_LOG_TEMP
WHERE STG_REGIS_PRSNA_ID>0
OR EDW_REGIS_PRSNA_ID>0);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

MERGE INTO OPT_OUT_NOT_FOUND_XREF
USING
(SELECT STG_PE_OPTOUT_ID,EDW_REGIS_PRSNA_ID
FROM I20B_OPT_OUT_LOG_TEMP
WHERE EDW_REGIS_PRSNA_ID>0
AND STG_PE_OPTOUT_ID IS NOT NULL
AND STG_PE_OPTOUT_ID >0)
AS SRC
(STG_PE_OPTOUT_ID,
EDW_REGIS_PRSNA_ID)
ON  PE_OPTOUT_ID = STG_PE_OPTOUT_ID
AND REGIS_PRSNA_ID= EDW_REGIS_PRSNA_ID

WHEN NOT MATCHED THEN 
INSERT
(PE_OPTOUT_ID = STG_PE_OPTOUT_ID
,REGIS_PRSNA_ID= EDW_REGIS_PRSNA_ID
);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	REGIS_PRSNA_POSTL_ADDR
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	I20B_OPT_OUT_LOG_TEMP TEMP1  
WHERE EDW_CHANNEL_IND IN ('A','ALL')
AND EDW_SUBSCRIPTION_NBR = 9999
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I20B OPT OUT USER'
,CNSMR_CHCE_DATETM=TEMP.STG_OPT_TIME
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
WHERE REGIS_PRSNA_POSTL_ADDR.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND REGIS_PRSNA_POSTL_ADDR.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND REGIS_PRSNA_POSTL_ADDR.CNSMR_CHCE_DATETM<=TEMP.STG_OPT_TIME
AND REGIS_PRSNA_POSTL_ADDR.SUBSCRPTN_OPT_IND = 'I'
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	REGIS_PRSNA_POSTL_ADDR
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,EDW_SUBSCRIPTION_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	I20B_OPT_OUT_LOG_TEMP TEMP1  
WHERE EDW_CHANNEL_IND IN ('A','ALL')
AND EDW_SUBSCRIPTION_NBR <> 9999
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,EDW_SUBSCRIPTION_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I20B OPT OUT USER'
,CNSMR_CHCE_DATETM=TEMP.STG_OPT_TIME
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
WHERE REGIS_PRSNA_POSTL_ADDR.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND REGIS_PRSNA_POSTL_ADDR.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND REGIS_PRSNA_POSTL_ADDR.SUBSCRPTN_OPT_NBR=TEMP.EDW_SUBSCRIPTION_NBR
AND REGIS_PRSNA_POSTL_ADDR.CNSMR_CHCE_DATETM<=TEMP.STG_OPT_TIME
AND REGIS_PRSNA_POSTL_ADDR.SUBSCRPTN_OPT_IND = 'I'
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	REGIS_PRSNA_EMAIL_ADDR
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	I20B_OPT_OUT_LOG_TEMP TEMP1  
WHERE EDW_CHANNEL_IND IN ('E','ALL')
AND EDW_SUBSCRIPTION_NBR = 9999
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I20B OPT OUT USER'
,CNSMR_CHCE_DATETM=TEMP.STG_OPT_TIME
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
WHERE REGIS_PRSNA_EMAIL_ADDR.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND REGIS_PRSNA_EMAIL_ADDR.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND REGIS_PRSNA_EMAIL_ADDR.CNSMR_CHCE_DATETM<=TEMP.STG_OPT_TIME
AND REGIS_PRSNA_EMAIL_ADDR.SUBSCRPTN_OPT_IND = 'I'
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	REGIS_PRSNA_EMAIL_ADDR
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,EDW_SUBSCRIPTION_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	I20B_OPT_OUT_LOG_TEMP TEMP1  
WHERE EDW_CHANNEL_IND IN ('E','ALL')
AND EDW_SUBSCRIPTION_NBR <> 9999
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,EDW_SUBSCRIPTION_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I20B OPT OUT USER'
,CNSMR_CHCE_DATETM=TEMP.STG_OPT_TIME
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
WHERE REGIS_PRSNA_EMAIL_ADDR.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND REGIS_PRSNA_EMAIL_ADDR.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND REGIS_PRSNA_EMAIL_ADDR.SUBSCRPTN_OPT_NBR=TEMP.EDW_SUBSCRIPTION_NBR
AND REGIS_PRSNA_EMAIL_ADDR.CNSMR_CHCE_DATETM<=TEMP.STG_OPT_TIME
AND REGIS_PRSNA_EMAIL_ADDR.SUBSCRPTN_OPT_IND = 'I'
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	REGIS_PRSNA
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	I20B_OPT_OUT_LOG_TEMP TEMP1  
WHERE EDW_OPT_TYPE_CODE IN ('8')
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
)  TEMP
SET POSTL_SUPRSN_IND= 'Y'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I20B OPT OUT USER'
,LATST_ACTVY_DATE=CAST(TEMP.STG_OPT_TIME AS DATE FORMAT 'YYYY-MM-DD')
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER)) 
WHERE	
REGIS_PRSNA.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND REGIS_PRSNA.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND REGIS_PRSNA.LATST_ACTVY_DATE<=CAST(TEMP.STG_OPT_TIME AS DATE FORMAT 'YYYY-MM-DD');
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	REGIS_PRSNA
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	I20B_OPT_OUT_LOG_TEMP TEMP1  
WHERE EDW_OPT_TYPE_CODE IN ('7','9')
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
)  TEMP
SET POSTL_SUPRSN_IND= 'Y'
,EMAIL_SUPRSN_IND= 'Y'
,PHONE_SUPRSN_IND= 'Y'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I20B OPT OUT USER'
,LATST_ACTVY_DATE=CAST(TEMP.STG_OPT_TIME AS DATE FORMAT 'YYYY-MM-DD')
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER)) 
WHERE	
REGIS_PRSNA.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND REGIS_PRSNA.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND REGIS_PRSNA.LATST_ACTVY_DATE<=CAST(TEMP.STG_OPT_TIME AS DATE FORMAT 'YYYY-MM-DD');
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	REGIS_PRSNA
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	I20B_OPT_OUT_LOG_TEMP TEMP1  
WHERE EDW_OPT_TYPE_CODE NOT IN ('7','8','9')
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
)  TEMP
SET POSTL_SUPRSN_IND= 'Y'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I20B OPT OUT USER'
,LATST_ACTVY_DATE=CAST(TEMP.STG_OPT_TIME AS DATE FORMAT 'YYYY-MM-DD')
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER)) 
WHERE	
REGIS_PRSNA.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND REGIS_PRSNA.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND REGIS_PRSNA.LATST_ACTVY_DATE<=CAST(TEMP.STG_OPT_TIME AS DATE FORMAT 'YYYY-MM-DD');
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	REGIS_PRSNA_PHONE
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	I20B_OPT_OUT_LOG_TEMP TEMP1  
WHERE EDW_CHANNEL_IND IN ('P','ALL')
AND EDW_SUBSCRIPTION_NBR = 9999
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I20B OPT OUT USER'
,CNSMR_CHCE_DATETM=TEMP.STG_OPT_TIME
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
WHERE REGIS_PRSNA_PHONE.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND REGIS_PRSNA_PHONE.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND REGIS_PRSNA_PHONE.CNSMR_CHCE_DATETM<=TEMP.STG_OPT_TIME
AND REGIS_PRSNA_PHONE.SUBSCRPTN_OPT_IND = 'I'
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	REGIS_PRSNA_PHONE
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,EDW_SUBSCRIPTION_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	I20B_OPT_OUT_LOG_TEMP TEMP1  
WHERE EDW_CHANNEL_IND IN ('P','ALL')
AND EDW_SUBSCRIPTION_NBR <> 9999
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,EDW_SUBSCRIPTION_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I20B OPT OUT USER'
,CNSMR_CHCE_DATETM=TEMP.STG_OPT_TIME
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
WHERE REGIS_PRSNA_PHONE.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND REGIS_PRSNA_PHONE.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND REGIS_PRSNA_PHONE.SUBSCRPTN_OPT_NBR=TEMP.EDW_SUBSCRIPTION_NBR
AND REGIS_PRSNA_PHONE.CNSMR_CHCE_DATETM<=TEMP.STG_OPT_TIME
AND REGIS_PRSNA_PHONE.SUBSCRPTN_OPT_IND = 'I'
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	REGIS_PRSNA_SOC_NET_ACCT
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	I20B_OPT_OUT_LOG_TEMP TEMP1  
WHERE EDW_CHANNEL_IND IN ('ALL')
AND EDW_SUBSCRIPTION_NBR = 9999
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I20B OPT OUT USER'
,CNSMR_CHCE_DATETM=TEMP.STG_OPT_TIME
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
WHERE REGIS_PRSNA_SOC_NET_ACCT.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND REGIS_PRSNA_SOC_NET_ACCT.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND REGIS_PRSNA_SOC_NET_ACCT.CNSMR_CHCE_DATETM<=TEMP.STG_OPT_TIME
AND REGIS_PRSNA_SOC_NET_ACCT.SUBSCRPTN_OPT_IND = 'I'
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	REGIS_PRSNA_SOC_NET_ACCT
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,EDW_SUBSCRIPTION_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	I20B_OPT_OUT_LOG_TEMP TEMP1  
WHERE EDW_CHANNEL_IND IN ('ALL')
AND EDW_SUBSCRIPTION_NBR <> 9999
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,EDW_SUBSCRIPTION_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I20B OPT OUT USER'
,CNSMR_CHCE_DATETM=TEMP.STG_OPT_TIME
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
WHERE REGIS_PRSNA_SOC_NET_ACCT.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND REGIS_PRSNA_SOC_NET_ACCT.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND REGIS_PRSNA_SOC_NET_ACCT.SUBSCRPTN_OPT_NBR=TEMP.EDW_SUBSCRIPTION_NBR
AND REGIS_PRSNA_SOC_NET_ACCT.CNSMR_CHCE_DATETM<=TEMP.STG_OPT_TIME
AND REGIS_PRSNA_SOC_NET_ACCT.SUBSCRPTN_OPT_IND = 'I'
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE MATCHD_CNSMR_PRSNA
FROM 
(SELECT	DISTINCT MATCHD_CNSMR_PRSNA_ID,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	I20B_OPT_OUT_LOG_TEMP TEMP1  
INNER JOIN REGIS_PRSNA RP
ON TEMP1.EDW_REGIS_PRSNA_ID = RP.REGIS_PRSNA_ID
AND TEMP1.EDW_MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
WHERE EDW_OPT_LEVEL_IND IN ('H','M')
QUALIFY RANK() OVER (PARTITION BY MATCHD_CNSMR_PRSNA_ID
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC,RP.REGIS_PRSNA_ID DESC) = 1
) TEMP
SET UNIVERSAL_OPT_OUT= 'Y'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I20B OPT OUT USER'
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
,LATST_ACTVY_DATE=CAST(STG_OPT_TIME AS DATE)
WHERE MATCHD_CNSMR_PRSNA.MATCHD_CNSMR_PRSNA_ID=TEMP.MATCHD_CNSMR_PRSNA_ID 
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE MATCHD_CNSMR_PRSNA
FROM 
(SELECT	DISTINCT MATCHD_CNSMR_PRSNA_ID,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	I20B_OPT_OUT_LOG_TEMP TEMP1  
INNER JOIN REGIS_PRSNA RP
ON TEMP1.EDW_REGIS_PRSNA_ID = RP.REGIS_PRSNA_ID
AND TEMP1.EDW_MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
WHERE EDW_OPT_LEVEL_IND NOT IN ('H','M')
QUALIFY RANK() OVER (PARTITION BY MATCHD_CNSMR_PRSNA_ID
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC,RP.REGIS_PRSNA_ID DESC) = 1
) TEMP
SET SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I20B OPT OUT USER'
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
,LATST_ACTVY_DATE=CAST(STG_OPT_TIME AS DATE)
WHERE MATCHD_CNSMR_PRSNA.MATCHD_CNSMR_PRSNA_ID=TEMP.MATCHD_CNSMR_PRSNA_ID 
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO REGIS_PRSNA_OPT_HIST
(
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
LOG_SOURCE_ID                 ,
LOG_UPDATE_USER               ,
LOG_LOAD_ID                 ,
OPT_OUT_DRCTV_ID
)
SELECT DISTINCT 
B.EDW_REGIS_PRSNA_ID                ,
B.EDW_MKTNG_PGM_NBR                 ,
B.EDW_LEGAL_ENT_NBR                 ,
A.LOG_SOURCE_ID                 ,
A.LOG_UPDATE_USER               ,
A.LOG_LOAD_ID       ,
A.REGIS_PRSNA_ID
FROM REGIS_PRSNA_OPT_OUT_HIST A
INNER JOIN I20B_OPT_OUT_LOG_TEMP B
ON A.REGIS_PRSNA_ID=B.STG_REGIS_PRSNA_ID
WHERE (B.EDW_REGIS_PRSNA_ID                ,
A.REGIS_PRSNA_ID    
)
NOT IN (SELECT 
REGIS_PRSNA_ID                ,
OPT_OUT_DRCTV_ID                 	    
FROM REGIS_PRSNA_OPT_HIST)
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL UPDT

CREATE VOLATILE TABLE V_PRSNA_POSTL_ADDR4
AS
(
SELECT  
B.STORE_NBR,
A.POSTL_ADDR_ID                 ,
A.ADDR_LINE_1_TXT               ,
A.ADDR_LINE_2_TXT               ,
A.ADDR_LINE_3_TXT               ,
A.STRET_NUM                     ,
A.STRET_NAME                    ,
A.APT_NUM                       ,
A.PO_BOX_NUM                    ,
A.CITY_NAME                     ,
A.POSTL_AREA_CODE               ,
A.TERR_NAME                     ,
A.CNTRY_CODE                    ,
A.PR_GEOCODE_FAIL,
A.TQ_GOUT_MATCH_LEVEL,
A.PR_REV_GROUP,
A.LAT_MEAS,
A.LONG_MEAS,
A.GL_ACCURACY,
A.GL_MATCH_FLG,
A.DR_CLEANSE_LVL,
A.VALID_ADDR_IND,
A.TERR_CODE,
A.CITY_CODE,
TRIM(CAST(A.LOAD_ID AS INTEGER)) SYS_SOURCE                    
FROM V_PRSNA_POSTL_ADDR A
INNER JOIN STORE B
ON A.POSTL_ADDR_ID=B.POSTL_ADDR_ID
GROUP BY
B.STORE_NBR,
A.POSTL_ADDR_ID                 ,
A.ADDR_LINE_1_TXT               ,
A.ADDR_LINE_2_TXT               ,
A.ADDR_LINE_3_TXT               ,
A.STRET_NUM                     ,
A.STRET_NAME                    ,
A.APT_NUM                       ,
A.PO_BOX_NUM                    ,
A.CITY_NAME                     ,
A.POSTL_AREA_CODE               ,
A.TERR_NAME                     ,
A.CNTRY_CODE                    ,
A.PR_GEOCODE_FAIL,
A.TQ_GOUT_MATCH_LEVEL,
A.PR_REV_GROUP,
A.LAT_MEAS,
A.LONG_MEAS,
A.GL_ACCURACY,
A.GL_MATCH_FLG,
A.DR_CLEANSE_LVL,
A.VALID_ADDR_IND,
A.TERR_CODE,
A.CITY_CODE,
TRIM(CAST(A.LOAD_ID AS INTEGER)))
WITH DATA
PRIMARY INDEX ( STORE_NBR )
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE

MERGE INTO STORE A
USING
(SELECT  
STORE_NBR,
POSTL_ADDR_ID                 ,
ADDR_LINE_1_TXT               ,
ADDR_LINE_2_TXT               ,
ADDR_LINE_3_TXT               ,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
CITY_NAME                     ,
POSTL_AREA_CODE               ,
TERR_NAME                     ,
CNTRY_CODE                    ,
PR_GEOCODE_FAIL,
TQ_GOUT_MATCH_LEVEL,
PR_REV_GROUP,
LAT_MEAS,
LONG_MEAS,
GL_ACCURACY,
GL_MATCH_FLG,
DR_CLEANSE_LVL,
VALID_ADDR_IND,
TERR_CODE,
CITY_CODE,
SYS_SOURCE                    
FROM V_PRSNA_POSTL_ADDR4)
AS SRC
(
V_STORE_NBR,
 V_POSTL_ADDR_ID                 ,
 V_ADDR_LINE_1_TXT               ,
 V_ADDR_LINE_2_TXT               ,
 V_ADDR_LINE_3_TXT               ,
 V_STRET_NUM                     ,
 V_STRET_NAME                    ,
 V_APT_NUM                       ,
 V_PO_BOX_NUM                    ,
 V_CITY_NAME                     ,
 V_POSTL_AREA_CODE               ,
 V_TERR_NAME                     ,
 V_CNTRY_CODE                    ,
V_PR_GEOCODE_FAIL,
V_TQ_GOUT_MATCH_LEVEL,
V_PR_REV_GROUP,
V_LAT_MEAS,
V_LONG_MEAS,
V_GL_ACCURACY,
V_GL_MATCH_FLG,
V_DR_CLEANSE_LVL,
V_VALID_ADDR_IND,
V_TERR_CODE,
V_CITY_CODE,
V_SYS_SOURCE                    
)

ON STORE_NBR=V_STORE_NBR
AND POSTL_ADDR_ID=V_POSTL_ADDR_ID

WHEN MATCHED THEN 
UPDATE
SET
ADDR_LINE_1_TXT=V_ADDR_LINE_1_TXT,
ADDR_LINE_2_TXT=V_ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT=V_ADDR_LINE_3_TXT,
STRET_NUM=V_STRET_NUM, 
STRET_NAME=V_STRET_NAME,
APT_NUM=V_APT_NUM,
PO_BOX_NUM=V_PO_BOX_NUM,
CITY_NAME=V_CITY_NAME,
TERR_NAME=V_TERR_NAME,
POSTL_AREA_CODE=V_POSTL_AREA_CODE,
CNTRY_CODE=V_CNTRY_CODE,
PR_GEOCODE_FAIL=V_PR_GEOCODE_FAIL,
TQ_GOUT_MATCH_LEVEL=V_TQ_GOUT_MATCH_LEVEL,
PR_REV_GROUP=V_PR_REV_GROUP,
LAT_MEAS=V_LAT_MEAS,
LONG_MEAS=V_LONG_MEAS,
GL_ACCURACY=V_GL_ACCURACY,
GL_MATCH_FLG=V_GL_MATCH_FLG,
DR_CLEANSE_LVL=V_DR_CLEANSE_LVL,
VALID_CNTCT_POINT_IND=V_VALID_ADDR_IND,
TERR_CODE=V_TERR_CODE,
CITY_CODE=V_CITY_CODE,
LOG_SOURCE_ID=CAST(V_SYS_SOURCE AS INTEGER),
LOG_UPDATE_USER='I20B'
;

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO $DATABASENAME.LOAD_INFO
(
LOAD_ID,
PROCESS_NAME,
PROCESS_START_TIME,
PROCESS_END_TIME,
STATUS,
SYS_CREATION_DATE,
SYS_LAST_MODIFIED_DATE,
CNTRY_NAME,
BATCH_ID) 
SELECT
CAST(TRIM(ERR1.SYS_SOURCE) AS INTEGER),
'Trillium',
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
'Ready to Process',
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
CASE WHEN SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3) IN ('IDN','THA','VNM')
THEN 'OTH'
WHEN MP.LEGAL_ENT_NBR=17
THEN 'LA'
WHEN MP.LEGAL_ENT_NBR=60
THEN 'ARB'
WHEN MP.LEGAL_ENT_NBR=46
THEN 'AFR'
ELSE SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3)
END AS CNTRY,
LI.BATCH_ID
FROM EXTRN_PRSNA_IDS ERR1
INNER JOIN MKTNG_PGM MP
ON ERR1.MKTNG_PGM_NBR = MP.MKTNG_PGM_NBR
INNER JOIN LOAD_INFO LI
ON CAST(TRIM(ERR1.SYS_SOURCE) AS INTEGER) = LI.LOAD_ID
AND LI.PROCESS_NAME='ExtrnStdrd Postl Update'
AND LI.STATUS = 'In Progress'
LEFT OUTER JOIN LOAD_INFO LII
ON CAST(TRIM(ERR1.SYS_SOURCE) AS INTEGER) = LII.LOAD_ID
AND LII.PROCESS_NAME='Trillium'

WHERE LII.LOAD_ID IS NULL
GROUP BY
CAST(TRIM(ERR1.SYS_SOURCE) AS INTEGER),
CNTRY,
LI.BATCH_ID
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE $DATABASENAME.LOAD_INFO
SET STATUS = 'Success'
,PROCESS_END_TIME=CURRENT_TIMESTAMP(0)
where 
PROCESS_NAME = 'ExtrnStdrd Postl Update' 
AND STATUS = 'In Progress';
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;


.exit