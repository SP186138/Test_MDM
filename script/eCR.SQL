.logon $TDPID/$TDUSER,$TDPWD


.SET ERROROUT STDOUT;
.SET SESSION CHARSET 'UTF8';

DATABASE MDM;
.GOTO $Step

.LABEL L0
INSERT INTO REGIS_PRSNA_OPT_HIST
(							     
REGIS_PRSNA_ID                ,				     
MKTNG_PGM_NBR                 ,				     				     
LEGAL_ENT_NBR                 ,				     
DATA_SRCE_NBR                 ,				     
SUBSCRIPTION_NBR              ,				     
FIRST_NAME                    ,				     
LAST_NAME                     ,				     
EMAIL_ADDR_TEXT               ,				     
CONTACT_PHONE_NBR             ,				     
SRC_ADDR_LINE_1_TXT           ,				     
SRC_ADDR_LINE_2_TXT           ,				     
SRC_ADDR_LINE_3_TXT           ,				     
SRC_CITY_NAME                 ,				     
SRC_STATE                     ,				     
SRC_ZIP                       ,				     
SRC_CNTRY_NAME                ,				     
ADDR_LINE_1_TXT               ,				     
ADDR_LINE_2_TXT               ,				     
ADDR_LINE_3_TXT               ,				     
CITY_NAME                     ,				     
TERR_NAME                     ,				     
POSTL_AREA_CODE               ,				     
CNTRY_NAME                    ,				     
OPT_IND                       ,				     
OPT_TIME                  ,				     
LAST_ACTIVITY_TM              ,				     
LOG_SOURCE_ID                 ,				     
LOG_UPDATE_USER               ,				     
PE_OPTOUT_ID              ,				     
NATIONAL_ID_NBR           ,				     
CHANNEL_IND               ,				     
OPT_LEVEL_IND             				     
)							   
SELECT DISTINCT
-1*OPTOUT_ID,
A.MKTNG_PGM_NBR,    			
-1 AS LEGAL_ENT_NBR,
-1 AS  DATA_SRCE_NBR,
A.SUBSCRPTN_OPT_NBR,
A.FNAME,
A.LNAME,
A.EMAIL,
A.PHONE,
A.S_ADD1,
A.S_ADD2,
A.S_ADD3,
A.S_CITY,
A.S_STATE,
A.S_ZIP,
A.S_COUNTRY,
A.ADDR_LINE_1_TXT,
A.ADDR_LINE_2_TXT,
A.ADDR_LINE_3_TXT,
A.CITY_NAME,
A.TERR_NAME,
A.POSTL_AREA_CODE,
A.CNTRY_CODE,
'O' AS OPT_IND,
A.OPT_OUT_DTTIME,
A.OPT_OUT_DTTIME,
A.LOAD_ID,
'ETLUSER' AS LOG_UPDATE_USER,
A.PE_OPTOUT_ID,
A.NATIONAL_ID_NBR,
A.CHANNEL_IND,
A.OPT_LEVEL_IND
FROM 
(SELECT  *   FROM 
ICRM_STAGE.REG_OPT_OUT_STGHIST_DONTDEL STG 
WHERE (COALESCE(TRIM(STG.ADDR_LINE_1_TXT),'')<> ''
     OR COALESCE(TRIM(STG.ADDR_LINE_2_TXT),'')<> ''
     OR COALESCE(TRIM(STG.ADDR_LINE_3_TXT),'')<> '') 
AND OPT_OUT_DTTIME IS NOT NULL 
AND LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN))  A
LEFT JOIN 
(SELECT 
MKTNG_PGM_NBR, 
ADDR_LINE_1_TXT,
ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT,
CITY_NAME,
TERR_NAME,
POSTL_AREA_CODE,
CNTRY_NAME,
OPT_TIME 
 FROM MDM.REGIS_PRSNA_OPT_HIST 
 WHERE REGIS_PRSNA_ID < 0 
AND OPT_LEVEL_IND IS NOT NULL
AND (COALESCE(TRIM(ADDR_LINE_1_TXT),'')<> ''
     OR COALESCE(TRIM(ADDR_LINE_2_TXT),'')<> ''
     OR COALESCE(TRIM(ADDR_LINE_3_TXT),'')<> '') )  B
ON A.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR 
AND COALESCE(TRIM(A.ADDR_LINE_1_TXT),'')=  COALESCE(TRIM(B.ADDR_LINE_1_TXT),'')
AND COALESCE(TRIM(A.ADDR_LINE_2_TXT),'')= COALESCE(TRIM(B.ADDR_LINE_2_TXT),'')
AND COALESCE(TRIM(A.ADDR_LINE_3_TXT),'')= COALESCE(TRIM(B.ADDR_LINE_3_TXT),'')
AND COALESCE(TRIM(A.CITY_NAME),'')= COALESCE(TRIM(B.CITY_NAME),'')
AND COALESCE(TRIM(A.TERR_NAME),'')= COALESCE(TRIM(B.TERR_NAME),'')
AND COALESCE(TRIM(A.POSTL_AREA_CODE),'')= COALESCE(TRIM(B.POSTL_AREA_CODE),'')
AND A.CNTRY_CODE= COALESCE(TRIM(B.CNTRY_NAME),'')
AND A.OPT_OUT_DTTIME = B.OPT_TIME
WHERE B.MKTNG_PGM_NBR IS NULL;
 .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L1
UPDATE MDM.REGIS_PRSNA_POSTL_ADDR
FROM (
SELECT DISTINCT
EM.MKTNG_PGM_NBR,
EM.REGIS_PRSNA_ID,
EM.RESP_DATETM,
EM.LOAD_ID
FROM ICRM_STAGE.POSTLCLT_STG_HIST EM 
INNER JOIN MDM.REGIS_PRSNA_POSTL_ADDR A
ON EM.MKTNG_PGM_NBR=A.MKTNG_PGM_NBR
AND EM.REGIS_PRSNA_ID=A.REGIS_PRSNA_ID
AND EM.RESP_DATETM>=CNSMR_CHCE_DATETM 
AND A.SUBSCRPTN_OPT_IND = 'I'  
AND EM.MKTNG_PGM_NBR IS NOT NULL
AND EM.REGIS_PRSNA_ID IS NOT NULL
AND EM.RESP_REC_TYPE_CODE IN ('04','07','05')
AND LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN)
QUALIFY RANK() OVER (PARTITION BY EM.MKTNG_PGM_NBR,
EM.REGIS_PRSNA_ID ORDER BY EM.RESP_DATETM DESC,
EM.LOAD_ID DESC) = 1) A
SET SUBSCRPTN_OPT_IND = 'O'
,SYS_SOURCE=TRIM(A.LOAD_ID) 
,SYS_LAST_MODIFIED_DATE=CURRENT_TIMESTAMP(0)
,CNSMR_CHCE_DATETM=A.RESP_DATETM
WHERE A.MKTNG_PGM_NBR=MDM.REGIS_PRSNA_POSTL_ADDR.MKTNG_PGM_NBR
AND	A.REGIS_PRSNA_ID=MDM.REGIS_PRSNA_POSTL_ADDR.REGIS_PRSNA_ID
AND A.RESP_DATETM >=MDM.REGIS_PRSNA_POSTL_ADDR.CNSMR_CHCE_DATETM;
 .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L2
UPDATE MDM.REGIS_PRSNA_POSTL_ADDR
FROM (
SELECT DISTINCT
A.MKTNG_PGM_NBR,
A.REGIS_PRSNA_ID,
EM.RESP_DATETM,
EM.LOAD_ID
FROM ICRM_STAGE.POSTLCLT_STG_HIST EM 
INNER JOIN MDM.REGIS_PRSNA_POSTL_ADDR A
ON EM.MKTNG_PGM_NBR=A.MKTNG_PGM_NBR
AND COALESCE(TRIM(EM.ADDR_LINE_1_TXT),'')=COALESCE(TRIM(A.ADDR_LINE_1_TXT),'')
AND COALESCE(TRIM(EM.ADDR_LINE_2_TXT),'')=COALESCE(TRIM(A.ADDR_LINE_2_TXT),'')
AND COALESCE(TRIM(EM.ADDR_LINE_3_TXT),'')=COALESCE(TRIM(A.ADDR_LINE_3_TXT),'')
AND COALESCE(TRIM(EM.TERR_NAME),'')=COALESCE(TRIM(A.TERR_NAME),'')
AND COALESCE(TRIM(EM.CITY_NAME),'')=COALESCE(TRIM(A.CITY_NAME),'')
AND COALESCE(TRIM(EM.CNTRY_NAME),'')=COALESCE(TRIM(A.CNTRY_CODE),'')
AND COALESCE(TRIM(EM.POSTL_AREA_CODE),'')=COALESCE(TRIM(A.POSTL_AREA_CODE),'')
AND EM.RESP_DATETM>=CNSMR_CHCE_DATETM 
AND A.SUBSCRPTN_OPT_IND = 'I'  
AND EM.MKTNG_PGM_NBR IS NOT NULL
AND EM.REGIS_PRSNA_ID IS NULL
AND EM.RESP_REC_TYPE_CODE IN ('04','07','05')
AND (COALESCE(TRIM(EM.ADDR_LINE_1_TXT),'')<> ''
     OR COALESCE(TRIM(EM.ADDR_LINE_2_TXT),'')<> ''
     OR COALESCE(TRIM(EM.ADDR_LINE_3_TXT),'')<> '')
AND LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN)
QUALIFY RANK() OVER (PARTITION BY A.MKTNG_PGM_NBR,
A.REGIS_PRSNA_ID ORDER BY EM.RESP_DATETM DESC,
EM.LOAD_ID DESC) = 1 ) A
SET SUBSCRPTN_OPT_IND = 'O'
,SYS_SOURCE=TRIM(A.LOAD_ID) 
,SYS_LAST_MODIFIED_DATE=CURRENT_TIMESTAMP(0)
,CNSMR_CHCE_DATETM=A.RESP_DATETM
WHERE A.MKTNG_PGM_NBR=MDM.REGIS_PRSNA_POSTL_ADDR.MKTNG_PGM_NBR
AND	A.REGIS_PRSNA_ID=MDM.REGIS_PRSNA_POSTL_ADDR.REGIS_PRSNA_ID
AND A.RESP_DATETM >=MDM.REGIS_PRSNA_POSTL_ADDR.CNSMR_CHCE_DATETM;
 .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L3
UPDATE MDM.REGIS_PRSNA_PHONE
FROM (
SELECT DISTINCT
A.MKTNG_PGM_NBR,
A.REGIS_PRSNA_ID,
EM.LAST_ACTIVITY_TM,
EM.LOAD_ID
FROM ICRM_STAGE.MOBILE_CAMP_STG_HIST EM 
INNER JOIN MDM.REGIS_PRSNA_PHONE A
ON EM.MKTNG_PGM_NBR=A.MKTNG_PGM_NBR
AND EM.FULL_PHONE_NBR=A.FULL_PHONE_NUM
AND EM.LAST_ACTIVITY_TM>=CNSMR_CHCE_DATETM 
AND A.SUBSCRPTN_OPT_IND = 'I'  
AND EM.MKTNG_PGM_NBR IS NOT NULL
AND EM.UNSUB='Y'
AND COALESCE(TRIM(EM.FULL_PHONE_NBR),'')<>''
AND LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN)
QUALIFY RANK() OVER (PARTITION BY A.MKTNG_PGM_NBR,
A.REGIS_PRSNA_ID ORDER BY EM.LAST_ACTIVITY_TM DESC,
EM.LOAD_ID DESC) = 1 ) A
SET SUBSCRPTN_OPT_IND = 'O'
,SYS_SOURCE=TRIM(A.LOAD_ID) 
,SYS_LAST_MODIFIED_DATE=CURRENT_TIMESTAMP(0)
,CNSMR_CHCE_DATETM=A.LAST_ACTIVITY_TM
WHERE A.MKTNG_PGM_NBR=MDM.REGIS_PRSNA_PHONE.MKTNG_PGM_NBR
AND	A.REGIS_PRSNA_ID=MDM.REGIS_PRSNA_PHONE.REGIS_PRSNA_ID
AND A.LAST_ACTIVITY_TM >=MDM.REGIS_PRSNA_PHONE.CNSMR_CHCE_DATETM;
 .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L4
UPDATE MDM.REGIS_PRSNA_EMAIL_ADDR
FROM (
SELECT DISTINCT
A.MKTNG_PGM_NBR,
A.REGIS_PRSNA_ID,
EM.ACTION_TIMESTAMP,
EM.LOAD_ID
FROM ICRM_STAGE.MAIL_CAMP_RSP_STG_R2_HIST EM 
INNER JOIN MDM.REGIS_PRSNA_EMAIL_ADDR A
ON EM.MKTNG_PGM_NBR=A.MKTNG_PGM_NBR
AND EM.EMAIL_ADDR_TXT=A.EMAIL_ADDR_TXT
AND EM.ACTION_TIMESTAMP>=CNSMR_CHCE_DATETM 
AND A.SUBSCRPTN_OPT_IND = 'I'  
AND EM.MKTNG_PGM_NBR IS NOT NULL
AND RECORD_TYPE='OO'
AND COALESCE(TRIM(EM.EMAIL_ADDR_TXT),'')<>''
AND LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN)
QUALIFY RANK() OVER (PARTITION BY A.MKTNG_PGM_NBR,
A.REGIS_PRSNA_ID ORDER BY EM.ACTION_TIMESTAMP DESC,
EM.LOAD_ID DESC) = 1) A
SET SUBSCRPTN_OPT_IND = 'O'
,SYS_SOURCE=TRIM(A.LOAD_ID) 
,SYS_LAST_MODIFIED_DATE=CURRENT_TIMESTAMP(0)
,CNSMR_CHCE_DATETM=A.ACTION_TIMESTAMP
WHERE A.MKTNG_PGM_NBR=MDM.REGIS_PRSNA_EMAIL_ADDR.MKTNG_PGM_NBR
AND	A.REGIS_PRSNA_ID=MDM.REGIS_PRSNA_EMAIL_ADDR.REGIS_PRSNA_ID
AND A.ACTION_TIMESTAMP >=MDM.REGIS_PRSNA_EMAIL_ADDR.CNSMR_CHCE_DATETM;
 .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L5
UPDATE MDM.REGIS_PRSNA_POSTL_ADDR
FROM (
SELECT DISTINCT
A1.MKTNG_PGM_NBR,
A1.REGIS_PRSNA_ID,
CAST(EM.CNTCT_OPTN_NBR AS INTEGER) AS SUBSCRPTN_OPT_NBR,
EM.CNTCT_POINT_CATEG_CODE,
EM.CNSMR_CHCE_DATETM,
EM.LOAD_ID
FROM ICRM_STAGE.CNTCT_OPTN_CHCE_STG_HIST EM 
INNER JOIN ETL_CTRL.LOAD_CONTROL EM1
ON EM.LOAD_ID=EM1.LOAD_ID
AND EM1.LOAD_TYPE='ETL'
INNER JOIN MDM.REGIS_PRSNA A1
ON EM.MKTNG_PGM_NBR=A1.MKTNG_PGM_NBR
AND EM.REGIS_CNSMR_ID_VAL=A1.REGIS_CNSMR_ID_VAL
AND EM1.SOURCE_ID=A1.SYS_TARGET_ID
INNER JOIN MDM.REGIS_PRSNA_POSTL_ADDR A
ON A1.MKTNG_PGM_NBR=A.MKTNG_PGM_NBR
AND A1.REGIS_PRSNA_ID=A.REGIS_PRSNA_ID
AND EM.CNTCT_POINT_CATEG_CODE=A.CNTCT_POINT_CATEG_CODE
AND EM.CNTCT_OPTN_NBR=A.SUBSCRPTN_OPT_NBR
AND EM.CNSMR_CHCE_DATETM>=A.CNSMR_CHCE_DATETM 
AND A.SUBSCRPTN_OPT_IND = 'I'  
AND EM.CNTCT_OPTN_IND='O'
AND EM.LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN)
QUALIFY RANK() OVER (PARTITION BY A1.MKTNG_PGM_NBR,
A1.REGIS_PRSNA_ID,EM.CNTCT_POINT_CATEG_CODE,SUBSCRPTN_OPT_NBR
ORDER BY EM.CNSMR_CHCE_DATETM DESC,
EM.LOAD_ID DESC) = 1) A
SET SUBSCRPTN_OPT_IND = 'O'
,SYS_SOURCE=TRIM(A.LOAD_ID) 
,SYS_LAST_MODIFIED_DATE=CURRENT_TIMESTAMP(0)
,CNSMR_CHCE_DATETM=A.CNSMR_CHCE_DATETM
WHERE A.MKTNG_PGM_NBR=MDM.REGIS_PRSNA_POSTL_ADDR.MKTNG_PGM_NBR
AND A.REGIS_PRSNA_ID=MDM.REGIS_PRSNA_POSTL_ADDR.REGIS_PRSNA_ID
AND A.CNTCT_POINT_CATEG_CODE=MDM.REGIS_PRSNA_POSTL_ADDR.CNTCT_POINT_CATEG_CODE
AND A.SUBSCRPTN_OPT_NBR=MDM.REGIS_PRSNA_POSTL_ADDR.SUBSCRPTN_OPT_NBR
AND A.CNSMR_CHCE_DATETM >=MDM.REGIS_PRSNA_POSTL_ADDR.CNSMR_CHCE_DATETM;
 .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L6
UPDATE MDM.REGIS_PRSNA_PHONE
FROM (
SELECT DISTINCT
A1.MKTNG_PGM_NBR,
A1.REGIS_PRSNA_ID,
CAST(EM.CNTCT_OPTN_NBR AS INTEGER) AS SUBSCRPTN_OPT_NBR,
EM.CNTCT_POINT_CATEG_CODE,
EM.CNSMR_CHCE_DATETM,
EM.LOAD_ID
FROM ICRM_STAGE.CNTCT_OPTN_CHCE_STG_HIST EM 
INNER JOIN ETL_CTRL.LOAD_CONTROL EM1
ON EM.LOAD_ID=EM1.LOAD_ID
AND EM1.LOAD_TYPE='ETL'
INNER JOIN MDM.REGIS_PRSNA A1
ON EM.MKTNG_PGM_NBR=A1.MKTNG_PGM_NBR
AND EM.REGIS_CNSMR_ID_VAL=A1.REGIS_CNSMR_ID_VAL
AND EM1.SOURCE_ID=A1.SYS_TARGET_ID
INNER JOIN MDM.REGIS_PRSNA_PHONE A
ON A1.MKTNG_PGM_NBR=A.MKTNG_PGM_NBR
AND A1.REGIS_PRSNA_ID=A.REGIS_PRSNA_ID
AND EM.CNTCT_POINT_CATEG_CODE=A.CNTCT_POINT_CATEG_CODE
AND EM.CNTCT_OPTN_NBR=A.SUBSCRPTN_OPT_NBR
AND EM.CNSMR_CHCE_DATETM>=A.CNSMR_CHCE_DATETM 
AND A.SUBSCRPTN_OPT_IND = 'I'  
AND EM.CNTCT_OPTN_IND='O'
AND EM.LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN)
QUALIFY RANK() OVER (PARTITION BY A1.MKTNG_PGM_NBR,
A1.REGIS_PRSNA_ID,EM.CNTCT_POINT_CATEG_CODE,SUBSCRPTN_OPT_NBR
ORDER BY EM.CNSMR_CHCE_DATETM DESC,
EM.LOAD_ID DESC) = 1) A
SET SUBSCRPTN_OPT_IND = 'O'
,SYS_SOURCE=TRIM(A.LOAD_ID) 
,SYS_LAST_MODIFIED_DATE=CURRENT_TIMESTAMP(0)
,CNSMR_CHCE_DATETM=A.CNSMR_CHCE_DATETM
WHERE A.MKTNG_PGM_NBR=MDM.REGIS_PRSNA_PHONE.MKTNG_PGM_NBR
AND A.REGIS_PRSNA_ID=MDM.REGIS_PRSNA_PHONE.REGIS_PRSNA_ID
AND A.CNTCT_POINT_CATEG_CODE=MDM.REGIS_PRSNA_PHONE.CNTCT_POINT_CATEG_CODE
AND A.SUBSCRPTN_OPT_NBR=MDM.REGIS_PRSNA_PHONE.SUBSCRPTN_OPT_NBR
AND A.CNSMR_CHCE_DATETM >=MDM.REGIS_PRSNA_PHONE.CNSMR_CHCE_DATETM;
 .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L7
UPDATE MDM.REGIS_PRSNA_EMAIL_ADDR
FROM (
SELECT DISTINCT
A1.MKTNG_PGM_NBR,
A1.REGIS_PRSNA_ID,
CAST(EM.CNTCT_OPTN_NBR AS INTEGER) AS SUBSCRPTN_OPT_NBR,
EM.CNTCT_POINT_CATEG_CODE,
EM.CNSMR_CHCE_DATETM,
EM.LOAD_ID
FROM ICRM_STAGE.CNTCT_OPTN_CHCE_STG_HIST EM 
INNER JOIN ETL_CTRL.LOAD_CONTROL EM1
ON EM.LOAD_ID=EM1.LOAD_ID
AND EM1.LOAD_TYPE='ETL'
INNER JOIN MDM.REGIS_PRSNA A1
ON EM.MKTNG_PGM_NBR=A1.MKTNG_PGM_NBR
AND EM.REGIS_CNSMR_ID_VAL=A1.REGIS_CNSMR_ID_VAL
AND EM1.SOURCE_ID=A1.SYS_TARGET_ID
INNER JOIN MDM.REGIS_PRSNA_EMAIL_ADDR A
ON A1.MKTNG_PGM_NBR=A.MKTNG_PGM_NBR
AND A1.REGIS_PRSNA_ID=A.REGIS_PRSNA_ID
AND EM.CNTCT_POINT_CATEG_CODE=A.CNTCT_POINT_CATEG_CODE
AND EM.CNTCT_OPTN_NBR=A.SUBSCRPTN_OPT_NBR
AND EM.CNSMR_CHCE_DATETM>=A.CNSMR_CHCE_DATETM 
AND A.SUBSCRPTN_OPT_IND = 'I'  
AND EM.CNTCT_OPTN_IND='O'
AND EM.LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN)
QUALIFY RANK() OVER (PARTITION BY A1.MKTNG_PGM_NBR,
A1.REGIS_PRSNA_ID,EM.CNTCT_POINT_CATEG_CODE,SUBSCRPTN_OPT_NBR
ORDER BY EM.CNSMR_CHCE_DATETM DESC,
EM.LOAD_ID DESC) = 1) A
SET SUBSCRPTN_OPT_IND = 'O'
,SYS_SOURCE=TRIM(A.LOAD_ID) 
,SYS_LAST_MODIFIED_DATE=CURRENT_TIMESTAMP(0)
,CNSMR_CHCE_DATETM=A.CNSMR_CHCE_DATETM
WHERE A.MKTNG_PGM_NBR=MDM.REGIS_PRSNA_EMAIL_ADDR.MKTNG_PGM_NBR
AND A.REGIS_PRSNA_ID=MDM.REGIS_PRSNA_EMAIL_ADDR.REGIS_PRSNA_ID
AND A.CNTCT_POINT_CATEG_CODE=MDM.REGIS_PRSNA_EMAIL_ADDR.CNTCT_POINT_CATEG_CODE
AND A.SUBSCRPTN_OPT_NBR=MDM.REGIS_PRSNA_EMAIL_ADDR.SUBSCRPTN_OPT_NBR
AND A.CNSMR_CHCE_DATETM >=MDM.REGIS_PRSNA_EMAIL_ADDR.CNSMR_CHCE_DATETM;
 .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L8
INSERT INTO REGIS_PRSNA_OPT_HIST
(							     
REGIS_PRSNA_ID                ,				     
MKTNG_PGM_NBR                 ,				     				     
LEGAL_ENT_NBR                 ,				     
DATA_SRCE_NBR                 ,				     
SUBSCRIPTION_NBR              ,				     
FIRST_NAME                    ,				     
LAST_NAME                     ,				     
EMAIL_ADDR_TEXT               ,				     
CONTACT_PHONE_NBR             ,				     
SRC_ADDR_LINE_1_TXT           ,				     
SRC_ADDR_LINE_2_TXT           ,				     
SRC_ADDR_LINE_3_TXT           ,				     
SRC_CITY_NAME                 ,				     
SRC_STATE                     ,				     
SRC_ZIP                       ,				     
SRC_CNTRY_NAME                ,				     
ADDR_LINE_1_TXT               ,				     
ADDR_LINE_2_TXT               ,				     
ADDR_LINE_3_TXT               ,				     
CITY_NAME                     ,				     
TERR_NAME                     ,				     
POSTL_AREA_CODE               ,				     
CNTRY_NAME                    ,				     
OPT_IND                       ,				     
OPT_TIME                  ,				     
LAST_ACTIVITY_TM              ,				     
LOG_SOURCE_ID                 ,				     
LOG_UPDATE_USER               ,				     
PE_OPTOUT_ID              ,				     
NATIONAL_ID_NBR           ,				     
CHANNEL_IND               ,				     
OPT_LEVEL_IND             				     
)							   
SELECT DISTINCT
-1*OPTOUT_ID,
A.MKTNG_PGM_NBR,    			
A.LEGAL_ENT_NBR,
-1 AS  DATA_SRCE_NBR,
A.SUBSCRPTN_OPT_NBR,
A.FNAME,
A.LNAME,
A.EMAIL,
A.PHONE,
A.S_ADD1,
A.S_ADD2,
A.S_ADD3,
A.S_CITY,
A.S_STATE,
A.S_ZIP,
A.S_COUNTRY,
A.ADDR_LINE_1_TXT,
A.ADDR_LINE_2_TXT,
A.ADDR_LINE_3_TXT,
A.CITY_NAME,
A.TERR_NAME,
A.POSTL_AREA_CODE,
A.CNTRY_CODE,
'O' AS OPT_IND,
A.OPT_OUT_DTTIME,
A.OPT_OUT_DTTIME,
A.LOAD_ID,
'ETLUSER' AS LOG_UPDATE_USER,
A.PE_OPTOUT_ID,
A.NATIONAL_ID_NBR,
A.CHANNEL_IND,
A.OPT_LEVEL_IND
FROM  
(SELECT  STG.*  FROM 
ICRM_STAGE.REG_OPT_OUT_STG_HIST STG 
JOIN MDM.I60_USE_CASES TMP
ON   COALESCE(CASE WHEN STG.MKTNG_PGM_NBR<> 9999 THEN NULL ELSE 9999 END,-1) =COALESCE(TMP.MKTNG_PGM_NBR ,-1)
AND  COALESCE(CASE WHEN STG.SUBSCRPTN_OPT_NBR<> 9999 THEN NULL ELSE 9999 END,-1) =COALESCE(TMP.SUBSCRPTN_OPT_NBR ,-1)
AND  COALESCE(CASE WHEN STG.CHANNEL_IND<> 'ALL' THEN NULL ELSE 'ALL' END,-1) =COALESCE(TMP.CHANNEL_IND ,-1)
AND STG.OPT_LEVEL_IND=TMP.OPT_LEVEL_IND
WHERE PHONE IS NOT NULL 
AND LOAD_TS > DATE '2014-06-29' 
AND OPT_OUT_DTTIME IS NOT NULL 
AND LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN))  A
LEFT JOIN 
(SELECT 
MKTNG_PGM_NBR, 
CONTACT_PHONE_NBR, 
OPT_TIME 
 FROM MDM.REGIS_PRSNA_OPT_HIST 
 WHERE REGIS_PRSNA_ID < 0 
AND OPT_LEVEL_IND IS NOT NULL 
AND CONTACT_PHONE_NBR IS NOT NULL)  B
ON A.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR 
AND A.PHONE = B.CONTACT_PHONE_NBR 
AND A.OPT_OUT_DTTIME = B.OPT_TIME
WHERE B.MKTNG_PGM_NBR IS NULL ;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL L9
INSERT INTO REGIS_PRSNA_OPT_HIST
(							     
REGIS_PRSNA_ID                ,				     
MKTNG_PGM_NBR                 ,				     				     
LEGAL_ENT_NBR                 ,				     
DATA_SRCE_NBR                 ,				     
SUBSCRIPTION_NBR              ,				     
FIRST_NAME                    ,				     
LAST_NAME                     ,				     
EMAIL_ADDR_TEXT               ,				     
CONTACT_PHONE_NBR             ,				     
SRC_ADDR_LINE_1_TXT           ,				     
SRC_ADDR_LINE_2_TXT           ,				     
SRC_ADDR_LINE_3_TXT           ,				     
SRC_CITY_NAME                 ,				     
SRC_STATE                     ,				     
SRC_ZIP                       ,				     
SRC_CNTRY_NAME                ,				     
ADDR_LINE_1_TXT               ,				     
ADDR_LINE_2_TXT               ,				     
ADDR_LINE_3_TXT               ,				     
CITY_NAME                     ,				     
TERR_NAME                     ,				     
POSTL_AREA_CODE               ,				     
CNTRY_NAME                    ,				     
OPT_IND                       ,				     
OPT_TIME                  ,				     
LAST_ACTIVITY_TM              ,				     
LOG_SOURCE_ID                 ,				     
LOG_UPDATE_USER               ,				     
PE_OPTOUT_ID              ,				     
NATIONAL_ID_NBR           ,				     
CHANNEL_IND               ,				     
OPT_LEVEL_IND             				     
)							   
SELECT DISTINCT
-1*OPTOUT_ID,
A.MKTNG_PGM_NBR,    			
A.LEGAL_ENT_NBR,
-1 AS  DATA_SRCE_NBR,
A.SUBSCRPTN_OPT_NBR,
A.FNAME,
A.LNAME,
A.EMAIL,
A.PHONE,
A.S_ADD1,
A.S_ADD2,
A.S_ADD3,
A.S_CITY,
A.S_STATE,
A.S_ZIP,
A.S_COUNTRY,
A.ADDR_LINE_1_TXT,
A.ADDR_LINE_2_TXT,
A.ADDR_LINE_3_TXT,
A.CITY_NAME,
A.TERR_NAME,
A.POSTL_AREA_CODE,
A.CNTRY_CODE,
'O' AS OPT_IND,
A.OPT_OUT_DTTIME,
A.OPT_OUT_DTTIME,
A.LOAD_ID,
'ETLUSER' AS LOG_UPDATE_USER,
A.PE_OPTOUT_ID,
A.NATIONAL_ID_NBR,
A.CHANNEL_IND,
A.OPT_LEVEL_IND
FROM 
(SELECT  *   FROM 
ICRM_STAGE.REG_OPT_OUT_STG_HIST STG 
WHERE (COALESCE(TRIM(STG.ADDR_LINE_1_TXT),'')<> ''
     OR COALESCE(TRIM(STG.ADDR_LINE_2_TXT),'')<> ''
     OR COALESCE(TRIM(STG.ADDR_LINE_3_TXT),'')<> '') 
AND OPT_OUT_DTTIME IS NOT NULL 
AND LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN))  A
LEFT JOIN 
(SELECT 
MKTNG_PGM_NBR, 
ADDR_LINE_1_TXT,
ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT,
CITY_NAME,
TERR_NAME,
POSTL_AREA_CODE,
CNTRY_NAME,
OPT_TIME 
 FROM MDM.REGIS_PRSNA_OPT_HIST 
 WHERE REGIS_PRSNA_ID < 0 
AND OPT_LEVEL_IND IS NOT NULL
AND (COALESCE(TRIM(ADDR_LINE_1_TXT),'')<> ''
     OR COALESCE(TRIM(ADDR_LINE_2_TXT),'')<> ''
     OR COALESCE(TRIM(ADDR_LINE_3_TXT),'')<> '') )  B
ON A.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR 
AND COALESCE(TRIM(A.ADDR_LINE_1_TXT),'')=  COALESCE(TRIM(B.ADDR_LINE_1_TXT),'')
AND COALESCE(TRIM(A.ADDR_LINE_2_TXT),'')= COALESCE(TRIM(B.ADDR_LINE_2_TXT),'')
AND COALESCE(TRIM(A.ADDR_LINE_3_TXT),'')= COALESCE(TRIM(B.ADDR_LINE_3_TXT),'')
AND COALESCE(TRIM(A.CITY_NAME),'')= COALESCE(TRIM(B.CITY_NAME),'')
AND COALESCE(TRIM(A.TERR_NAME),'')= COALESCE(TRIM(B.TERR_NAME),'')
AND COALESCE(TRIM(A.POSTL_AREA_CODE),'')= COALESCE(TRIM(B.POSTL_AREA_CODE),'')
AND A.CNTRY_CODE= COALESCE(TRIM(B.CNTRY_NAME),'')
AND A.OPT_OUT_DTTIME = B.OPT_TIME
WHERE B.MKTNG_PGM_NBR IS NULL;
  .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
  
  .LABEL L10
 UPDATE MDM.REGIS_PRSNA_PHONE
 FROM (
 SELECT DISTINCT
 A.MKTNG_PGM_NBR,
 A.REGIS_PRSNA_ID,
 EM.LAST_ACTIVITY_TM,
 EM.LOAD_ID
 FROM ICRM_STAGE.MOBILE_CAMP_STG_HIST EM 
 INNER JOIN MDM.REGIS_PRSNA_PHONE A
 ON EM.FULL_PHONE_NBR=A.FULL_PHONE_NUM
 AND EM.LAST_ACTIVITY_TM>=CNSMR_CHCE_DATETM 
 AND A.SUBSCRPTN_OPT_IND = 'I'  
 AND EM.MKTNG_PGM_NBR IS NULL
 AND EM.UNSUB='Y'
 AND COALESCE(TRIM(EM.FULL_PHONE_NBR),'')<>''
 AND LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN)
 QUALIFY RANK() OVER (PARTITION BY A.MKTNG_PGM_NBR,
 A.REGIS_PRSNA_ID ORDER BY EM.LAST_ACTIVITY_TM DESC,
 EM.LOAD_ID DESC) = 1 ) A
 SET SUBSCRPTN_OPT_IND = 'O'
 ,SYS_SOURCE=TRIM(A.LOAD_ID) 
 ,SYS_LAST_MODIFIED_DATE=CURRENT_TIMESTAMP(0)
 ,CNSMR_CHCE_DATETM=A.LAST_ACTIVITY_TM
 WHERE A.MKTNG_PGM_NBR=MDM.REGIS_PRSNA_PHONE.MKTNG_PGM_NBR
 AND	A.REGIS_PRSNA_ID=MDM.REGIS_PRSNA_PHONE.REGIS_PRSNA_ID
 AND A.LAST_ACTIVITY_TM >=MDM.REGIS_PRSNA_PHONE.CNSMR_CHCE_DATETM;
 .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
  .LABEL L11
 UPDATE MDM.REGIS_PRSNA_POSTL_ADDR
 FROM (
 SELECT DISTINCT
 A1.MKTNG_PGM_NBR,
 A1.REGIS_PRSNA_ID,
 CAST(EM.CNTCT_OPTN_NBR AS INTEGER) AS SUBSCRPTN_OPT_NBR,
 EM.CNTCT_POINT_CATEG_CODE,
 EM.CNSMR_CHCE_DATETM,
 EM.LOAD_ID
 FROM ICRM_STAGE.CNTCT_OPTN_CHCE_STG EM 
 INNER JOIN ETL_CTRL.LOAD_CONTROL EM1
 ON EM.LOAD_ID=EM1.LOAD_ID
 AND EM1.LOAD_TYPE='ETL'
 INNER JOIN MDM.REGIS_PRSNA A1
 ON EM.MKTNG_PGM_NBR=A1.MKTNG_PGM_NBR
 AND EM.REGIS_CNSMR_ID_VAL=A1.REGIS_CNSMR_ID_VAL
 AND EM1.SOURCE_ID=A1.SYS_TARGET_ID
 INNER JOIN MDM.REGIS_PRSNA_POSTL_ADDR A
 ON A1.MKTNG_PGM_NBR=A.MKTNG_PGM_NBR
 AND A1.REGIS_PRSNA_ID=A.REGIS_PRSNA_ID
 AND EM.CNTCT_POINT_CATEG_CODE=A.CNTCT_POINT_CATEG_CODE
 AND EM.CNTCT_OPTN_NBR=A.SUBSCRPTN_OPT_NBR
 AND EM.CNSMR_CHCE_DATETM>=A.CNSMR_CHCE_DATETM 
 AND A.SUBSCRPTN_OPT_IND = 'I'  
 AND EM.CNTCT_OPTN_IND='O'
 AND EM.LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN)
 QUALIFY RANK() OVER (PARTITION BY A1.MKTNG_PGM_NBR,
 A1.REGIS_PRSNA_ID,EM.CNTCT_POINT_CATEG_CODE,SUBSCRPTN_OPT_NBR
 ORDER BY EM.CNSMR_CHCE_DATETM DESC,
 EM.LOAD_ID DESC) = 1) A
 SET SUBSCRPTN_OPT_IND = 'O'
 ,SYS_SOURCE=TRIM(A.LOAD_ID) 
 ,SYS_LAST_MODIFIED_DATE=CURRENT_TIMESTAMP(0)
 ,CNSMR_CHCE_DATETM=A.CNSMR_CHCE_DATETM
 WHERE A.MKTNG_PGM_NBR=MDM.REGIS_PRSNA_POSTL_ADDR.MKTNG_PGM_NBR
 AND A.REGIS_PRSNA_ID=MDM.REGIS_PRSNA_POSTL_ADDR.REGIS_PRSNA_ID
 AND A.CNTCT_POINT_CATEG_CODE=MDM.REGIS_PRSNA_POSTL_ADDR.CNTCT_POINT_CATEG_CODE
 AND A.SUBSCRPTN_OPT_NBR=MDM.REGIS_PRSNA_POSTL_ADDR.SUBSCRPTN_OPT_NBR
 AND A.CNSMR_CHCE_DATETM >=MDM.REGIS_PRSNA_POSTL_ADDR.CNSMR_CHCE_DATETM;
  .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
  
  .LABEL L12
 UPDATE MDM.REGIS_PRSNA_PHONE
 FROM (
 SELECT DISTINCT
 A1.MKTNG_PGM_NBR,
 A1.REGIS_PRSNA_ID,
 CAST(EM.CNTCT_OPTN_NBR AS INTEGER) AS SUBSCRPTN_OPT_NBR,
 EM.CNTCT_POINT_CATEG_CODE,
 EM.CNSMR_CHCE_DATETM,
 EM.LOAD_ID
 FROM ICRM_STAGE.CNTCT_OPTN_CHCE_STG EM 
 INNER JOIN ETL_CTRL.LOAD_CONTROL EM1
 ON EM.LOAD_ID=EM1.LOAD_ID
 AND EM1.LOAD_TYPE='ETL'
 INNER JOIN MDM.REGIS_PRSNA A1
 ON EM.MKTNG_PGM_NBR=A1.MKTNG_PGM_NBR
 AND EM.REGIS_CNSMR_ID_VAL=A1.REGIS_CNSMR_ID_VAL
 AND EM1.SOURCE_ID=A1.SYS_TARGET_ID
 INNER JOIN MDM.REGIS_PRSNA_PHONE A
 ON A1.MKTNG_PGM_NBR=A.MKTNG_PGM_NBR
 AND A1.REGIS_PRSNA_ID=A.REGIS_PRSNA_ID
 AND EM.CNTCT_POINT_CATEG_CODE=A.CNTCT_POINT_CATEG_CODE
 AND EM.CNTCT_OPTN_NBR=A.SUBSCRPTN_OPT_NBR
 AND EM.CNSMR_CHCE_DATETM>=A.CNSMR_CHCE_DATETM 
 AND A.SUBSCRPTN_OPT_IND = 'I'  
 AND EM.CNTCT_OPTN_IND='O'
 AND EM.LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN)
 QUALIFY RANK() OVER (PARTITION BY A1.MKTNG_PGM_NBR,
 A1.REGIS_PRSNA_ID,EM.CNTCT_POINT_CATEG_CODE,SUBSCRPTN_OPT_NBR
 ORDER BY EM.CNSMR_CHCE_DATETM DESC,
 EM.LOAD_ID DESC) = 1) A
 SET SUBSCRPTN_OPT_IND = 'O'
 ,SYS_SOURCE=TRIM(A.LOAD_ID) 
 ,SYS_LAST_MODIFIED_DATE=CURRENT_TIMESTAMP(0)
 ,CNSMR_CHCE_DATETM=A.CNSMR_CHCE_DATETM
 WHERE A.MKTNG_PGM_NBR=MDM.REGIS_PRSNA_PHONE.MKTNG_PGM_NBR
 AND A.REGIS_PRSNA_ID=MDM.REGIS_PRSNA_PHONE.REGIS_PRSNA_ID
 AND A.CNTCT_POINT_CATEG_CODE=MDM.REGIS_PRSNA_PHONE.CNTCT_POINT_CATEG_CODE
 AND A.SUBSCRPTN_OPT_NBR=MDM.REGIS_PRSNA_PHONE.SUBSCRPTN_OPT_NBR
 AND A.CNSMR_CHCE_DATETM >=MDM.REGIS_PRSNA_PHONE.CNSMR_CHCE_DATETM;
  .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
  
  .LABEL L13
 UPDATE MDM.REGIS_PRSNA_EMAIL_ADDR
 FROM (
 SELECT DISTINCT
 A1.MKTNG_PGM_NBR,
 A1.REGIS_PRSNA_ID,
 CAST(EM.CNTCT_OPTN_NBR AS INTEGER) AS SUBSCRPTN_OPT_NBR,
 EM.CNTCT_POINT_CATEG_CODE,
 EM.CNSMR_CHCE_DATETM,
 EM.LOAD_ID
 FROM ICRM_STAGE.CNTCT_OPTN_CHCE_STG EM 
 INNER JOIN ETL_CTRL.LOAD_CONTROL EM1
 ON EM.LOAD_ID=EM1.LOAD_ID
 AND EM1.LOAD_TYPE='ETL'
 INNER JOIN MDM.REGIS_PRSNA A1
 ON EM.MKTNG_PGM_NBR=A1.MKTNG_PGM_NBR
 AND EM.REGIS_CNSMR_ID_VAL=A1.REGIS_CNSMR_ID_VAL
 AND EM1.SOURCE_ID=A1.SYS_TARGET_ID
 INNER JOIN MDM.REGIS_PRSNA_EMAIL_ADDR A
 ON A1.MKTNG_PGM_NBR=A.MKTNG_PGM_NBR
 AND A1.REGIS_PRSNA_ID=A.REGIS_PRSNA_ID
 AND EM.CNTCT_POINT_CATEG_CODE=A.CNTCT_POINT_CATEG_CODE
 AND EM.CNTCT_OPTN_NBR=A.SUBSCRPTN_OPT_NBR
 AND EM.CNSMR_CHCE_DATETM>=A.CNSMR_CHCE_DATETM 
 AND A.SUBSCRPTN_OPT_IND = 'I'  
 AND EM.CNTCT_OPTN_IND='O'
 AND EM.LOAD_ID NOT IN ( SEL LOG_SOURCE_ID FROM MDM.OPT_OUT_CHK_LOAD_ID_IGN)
 QUALIFY RANK() OVER (PARTITION BY A1.MKTNG_PGM_NBR,
 A1.REGIS_PRSNA_ID,EM.CNTCT_POINT_CATEG_CODE,SUBSCRPTN_OPT_NBR
 ORDER BY EM.CNSMR_CHCE_DATETM DESC,
 EM.LOAD_ID DESC) = 1) A
 SET SUBSCRPTN_OPT_IND = 'O'
 ,SYS_SOURCE=TRIM(A.LOAD_ID) 
 ,SYS_LAST_MODIFIED_DATE=CURRENT_TIMESTAMP(0)
 ,CNSMR_CHCE_DATETM=A.CNSMR_CHCE_DATETM
 WHERE A.MKTNG_PGM_NBR=MDM.REGIS_PRSNA_EMAIL_ADDR.MKTNG_PGM_NBR
 AND A.REGIS_PRSNA_ID=MDM.REGIS_PRSNA_EMAIL_ADDR.REGIS_PRSNA_ID
 AND A.CNTCT_POINT_CATEG_CODE=MDM.REGIS_PRSNA_EMAIL_ADDR.CNTCT_POINT_CATEG_CODE
 AND A.SUBSCRPTN_OPT_NBR=MDM.REGIS_PRSNA_EMAIL_ADDR.SUBSCRPTN_OPT_NBR
 AND A.CNSMR_CHCE_DATETM >=MDM.REGIS_PRSNA_EMAIL_ADDR.CNSMR_CHCE_DATETM;
 .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 