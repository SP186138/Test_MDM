.logon $TDPID/$TDUSER,$TDPWD


.SET ERROROUT STDOUT;
.SET SESSION CHARSET 'UTF8';
.SET ERRORLEVEL 3807 SEVERITY 0

DATABASE MDM;
.GOTO $Step

.LABEL L0
REPLACE VIEW MDM.MDM_LOAD_CONTROL_SCHEDULER  AS 
/***************************New Change********************************
To pick countries at the scheduled time
*********************************************************************/
LOCKING ROW FOR ACCESS
SELECT A.LOAD_ID,
SCHDL_ID,
A.SOURCE_ID,
C.CNTRY
FROM MDM.MDM_LOAD_CONTROL A
INNER JOIN (
SELECT
LOAD_ID,
CASE WHEN SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3) IN ('IDN','THA','VNM')
THEN 'OTH'
WHEN MP.LEGAL_ENT_NBR=17
THEN 'LA'
WHEN MP.LEGAL_ENT_NBR=41
THEN 'ARB'
WHEN MP.LEGAL_ENT_NBR=46
THEN 'AFR'
ELSE SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3)
END AS CNTRY,
COUNT(*) AS RCRD_CNT
FROM ICRM_STAGE.PRSNA_STG C
INNER JOIN MKTNG_PGM MP
ON C.MKTNG_PGM_NBR = MP.MKTNG_PGM_NBR
GROUP BY 1,2) C
ON A.LOAD_ID=C.LOAD_ID
INNER JOIN SCHDL_ID_CNTRY D
ON CNTRY=D.CNTRY_NM
WHERE NOT EXISTS(SEL 1 FROM MDM.LOAD_INFO A WHERE STATUS IN ('In Progress','Ready to Process')
AND A.CNTRY_NAME=D.CNTRY_NM GROUP BY 1)
AND TIME BETWEEN D.SCHDL_STRT_TM AND D.SCHDL_END_TM;

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;