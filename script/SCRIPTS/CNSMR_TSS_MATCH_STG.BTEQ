/***********************************************************************************************************
SCRIPT:               CNSMR_TSS_MATCH_STG.BTEQ 
DESCRIPTION:          THIS SCRIPT UPDATES THE HOUSEHOLD ID WHEN A CONSUMER HAS TWO EMAILS / PHONE NOS.
DEPENDENCY:           CNSMR_TSS_MATCH_STG.FLD
INPUT:                TRILLIUM OUTPUT
OUTPUT:               TRILLIUM OUTPUT
ERRORS:
SPECIAL INSTRUCTIONS:

CHANGE LOG:
VERSION              DATE                 AUTHOR                          CHANGES
1.00                 01/21/2011           TERADATA                        INITIAL VERSION
***********************************************************************************************************/

.RUN FILE \\10.36.32.4\Teradata\MDM\3.04.01.00\custom\pngrelease3\logon\LOGON.txt;
.SET ERROROUT STDOUT;
.SET SESSION CHARSET 'UTF8';

DATABASE MDM;

COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(RECORD_IND);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(RECENT_IND);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,REGIS_DATE,SYS_SOURCE,SYS_CREATION_DATE,SYS_NC_TYPE);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(REFERENCE_REGISTRATIONKEY);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(REFERENCE_LEGALENTITYKEY);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(REGIS_PRSNA_ID);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(REFERENCE_HOUSEHOLD_ID);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(DR_COUNTRY_NAME);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(REGIS_CNSMR_ID_VAL);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(LEGAL_ENT_NBR);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LEGAL_ENT_NBR);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,DR_ALIAS_CONTACT,DR_FIRST_NAME,DR_MIDDLE_NAME,DR_LAST_NAME,DR_MRMRS,DR_NAME_GENER,DR_NAME_SUFFIX,DR_NAME_GENDER,DR_COUNTRY_NAME,DR_REGION_NAME,DR_CITY_NAME,DR_POSTAL_CODE,DR_STREET_NAME,DR_HOUSE_NUMBER1,DR_HOUSE_NUMBER2,DR_POBOX_NUMBER,DR_ADDRESS,DR_ADDRESS2,DR_ADDRESS3,PR_REV_GROUP,GOUT_MATCH_LEVEL,WINDOW_KEY_01,REFERENCE_HOUSEHOLD_ID,REFERENCE_LEGALENTITYKEY,REFERENCE_REGISTRATIONKEY,LEGAL_ENT_NBR,BRTH_DATE,LANG_CODE,CNSMR_USER_NAME,STATUS,FULL_NAME,PR_NAME_FORM_01,DR_ALIAS_ACCOUNT,DR_BUSINESS_NAME,REGIS_DATE,RECORD_IND,RECENT_IND,REGIS_PRSNA_ID,HH_FLAG,LE_FLAG,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_CREATION_DATE,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_LAST_MODIFIED_DATE,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LEGAL_ENT_NBR,SYS_SOURCE,SYS_NC_TYPE);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,DR_FIRST_NAME,DR_MIDDLE_NAME,DR_LAST_NAME,DR_MRMRS,DR_NAME_SUFFIX,DR_COUNTRY_NAME,DR_REGION_NAME,DR_CITY_NAME,DR_POSTAL_CODE,DR_STREET_NAME,DR_HOUSE_NUMBER1,DR_HOUSE_NUMBER2,DR_POBOX_NUMBER,DR_ADDRESS,DR_ADDRESS2,DR_ADDRESS3,LEGAL_ENT_NBR,BRTH_DATE,LANG_CODE,CNSMR_USER_NAME,FULL_NAME,PR_NAME_FORM_01,REGIS_DATE,SYS_SOURCE,SYS_CREATION_DATE,SYS_NC_TYPE);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LEGAL_ENT_NBR,REGIS_DATE,SYS_SOURCE,SYS_CREATION_DATE,SYS_NC_TYPE);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LEGAL_ENT_NBR,SYS_SOURCE);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,DR_ALIAS_CONTACT,DR_FIRST_NAME,DR_MIDDLE_NAME,DR_LAST_NAME,DR_MRMRS,DR_NAME_GENER,DR_NAME_SUFFIX,DR_NAME_GENDER,DR_COUNTRY_NAME,DR_REGION_NAME,DR_CITY_NAME,DR_POSTAL_CODE,DR_STREET_NAME,DR_HOUSE_NUMBER1,DR_HOUSE_NUMBER2,DR_POBOX_NUMBER,DR_ADDRESS,DR_ADDRESS2,DR_ADDRESS3,CLEANSED_PHONE_1,CLEANSED_EMAIL_1,PR_REV_GROUP,GOUT_MATCH_LEVEL,WINDOW_KEY_01,REFERENCE_HOUSEHOLD_ID,REFERENCE_LEGALENTITYKEY,REFERENCE_REGISTRATIONKEY,LEGAL_ENT_NBR,BRTH_DATE,LANG_CODE,CNSMR_USER_NAME,STATUS,FULL_NAME,DPEND_NAME,PET_NAME,PR_NAME_FORM_01,DR_ALIAS_ACCOUNT,REFERENCE_MATCHED_LEV1_PATTERN,REFERENCE_MATCHED_LEV2_PATTERN,DR_BUSINESS_NAME,EMAIL_IND,REGIS_DATE,RECORD_IND,RECENT_IND,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_LAST_MODIFIED_DATE,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REFERENCE_REGISTRATIONKEY,LEGAL_ENT_NBR);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,REFERENCE_REGISTRATIONKEY,LEGAL_ENT_NBR,REGIS_DATE,SYS_NC_TYPE);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(REFERENCE_HOUSEHOLD_ID,LEGAL_ENT_NBR,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,DR_FIRST_NAME,DR_MIDDLE_NAME,DR_LAST_NAME,DR_MRMRS,DR_NAME_SUFFIX,DR_COUNTRY_NAME,REFERENCE_LEGALENTITYKEY,LEGAL_ENT_NBR,BRTH_DATE,LANG_CODE,CNSMR_USER_NAME,REGIS_PRSNA_ID,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(DR_COUNTRY_NAME,DR_REGION_NAME,DR_CITY_NAME,DR_POSTAL_CODE,DR_STREET_NAME,DR_HOUSE_NUMBER1,DR_HOUSE_NUMBER2,DR_POBOX_NUMBER,DR_ADDRESS,DR_ADDRESS2,DR_ADDRESS3,REFERENCE_LEGALENTITYKEY,LEGAL_ENT_NBR);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(DR_COUNTRY_NAME,DR_REGION_NAME,REFERENCE_LEGALENTITYKEY,LEGAL_ENT_NBR);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,DR_COUNTRY_NAME,DR_REGION_NAME,DR_CITY_NAME,DR_POSTAL_CODE,DR_STREET_NAME,DR_HOUSE_NUMBER1,DR_HOUSE_NUMBER2,DR_POBOX_NUMBER,DR_ADDRESS,DR_ADDRESS2,DR_ADDRESS3,PR_REV_GROUP,GOUT_MATCH_LEVEL,WINDOW_KEY_01,LEGAL_ENT_NBR);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,LEGAL_ENT_NBR,REGIS_PRSNA_ID);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,DR_COUNTRY_NAME,DR_REGION_NAME,PR_REV_GROUP,GOUT_MATCH_LEVEL,WINDOW_KEY_01,LEGAL_ENT_NBR);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,CLEANSED_PHONE_1,LEGAL_ENT_NBR);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,CLEANSED_EMAIL_1,EMAIL_IND,SYS_SOURCE);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,CLEANSED_EMAIL_1,SYS_SOURCE);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,CLEANSED_EMAIL_1,LEGAL_ENT_NBR);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,LEGAL_ENT_NBR);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(RECORD_IND,RECENT_IND);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(DR_COUNTRY_NAME,RECORD_IND,RECENT_IND);
COLLECT STATS ON RPT_LOAD_NBR COLUMN(LOAD_ID);
COLLECT STATS ON RPT_LOAD_NBR COLUMN(LOAD_ID,MKTNG_PGM_NBR);
COLLECT STATS LOAD_INFO1 COLUMN(LOAD_ID);
COLLECT STATS LOAD_INFO1 COLUMN(PROCESS_NAME);
COLLECT STATS LOAD_INFO1 COLUMN(STATUS);
COLLECT STATS LOAD_INFO1 COLUMN(LOAD_ID,STATUS);
COLLECT STATS LOAD_INFO1 COLUMN(LOAD_ID,PROCESS_NAME,STATUS);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO ERR_PRSNA_STG
(
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
LOAD_ID,
SYS_NC_TYPE,
SYS_ERROR_TIME,
SYS_ERR_CODE
)
SELECT
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
TRIM(SYS_SOURCE),
SYS_NC_TYPE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)),
'RECORD DROPPED FROM TRILLIUM OUTPUT DUE TO CHARACTER ENCODING ISSUE'
FROM
(SELECT 
LEGAL_ENT_NBR,
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
SYS_SOURCE,
SYS_NC_TYPE
FROM
CNSMR_TSS_CLEANSE_INPUT1
GROUP BY 1,2,3,4,5
MINUS
SELECT 
LEGAL_ENT_NBR,
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
SYS_SOURCE,
SYS_NC_TYPE
FROM
TRILLIUM_OUTPUT1
GROUP BY 1,2,3,4,5
) A;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

SELECT DISTINCT 
1
FROM 
TRILLIUM_OUTPUT1 A
GROUP BY 
COALESCE(MKTNG_PGM_NBR,''),
COALESCE(CAST(REGIS_CNSMR_ID_VAL AS CHAR(20)),''),
COALESCE(DR_FIRST_NAME,''),
COALESCE(DR_MIDDLE_NAME,''),
COALESCE(DR_LAST_NAME,''),
COALESCE(DR_MRMRS,''),
COALESCE(DR_NAME_SUFFIX,''),
COALESCE(DR_COUNTRY_NAME,''),
COALESCE(DR_REGION_NAME,''),
COALESCE(DR_CITY_NAME,''),
COALESCE(DR_POSTAL_CODE,''),
COALESCE(DR_STREET_NAME,''),
COALESCE(DR_HOUSE_NUMBER1,''),
COALESCE(DR_HOUSE_NUMBER2,''),
COALESCE(DR_POBOX_NUMBER,''),
COALESCE(DR_ADDRESS,''),
COALESCE(DR_ADDRESS2,''),
COALESCE(DR_ADDRESS3,''),
COALESCE(LEGAL_ENT_NBR,''),
COALESCE(CAST(CAST(BRTH_DATE AS DATE FORMAT 'YYYY-MM-DD') AS VARCHAR(10)),''),
COALESCE(LANG_CODE,''),
COALESCE(CNSMR_USER_NAME,''),
COALESCE(FULL_NAME,''),
COALESCE(PR_NAME_FORM_01,''),
COALESCE(CAST(CAST(SYS_SOURCE AS INTEGER) AS CHAR(20)),''),
COALESCE(SYS_NC_TYPE,''),
COALESCE(CAST(CAST(SYS_CREATION_DATE AS TIMESTAMP(0)) AS VARCHAR(20)),''),
COALESCE(REGIS_DATE,'')
HAVING COUNT(*) > 1
;

.IF ACTIVITYCOUNT = 0 THEN .GOTO PROCESS

UPDATE A
FROM TRILLIUM_OUTPUT1 A,
(
SELECT
COALESCE(MKTNG_PGM_NBR,'')						 AS MKTNG_PGM_NBR                 ,
COALESCE(CAST(REGIS_CNSMR_ID_VAL AS CHAR(20)),'')	 AS REGIS_CNSMR_ID_VAL            ,
COALESCE(DR_FIRST_NAME,'')						 AS DR_FIRST_NAME                 ,
COALESCE(DR_MIDDLE_NAME,'')						 AS DR_MIDDLE_NAME                ,
COALESCE(DR_LAST_NAME,'')						 AS DR_LAST_NAME                  ,
COALESCE(DR_MRMRS,'')							 AS DR_MRMRS                      ,
COALESCE(DR_NAME_SUFFIX,'')						 AS DR_NAME_SUFFIX                ,
COALESCE(DR_COUNTRY_NAME,'')						 AS DR_COUNTRY_NAME               ,
COALESCE(DR_REGION_NAME,'')						 AS DR_REGION_NAME                ,
COALESCE(DR_CITY_NAME,'')						 AS DR_CITY_NAME                  ,
COALESCE(DR_POSTAL_CODE,'')						 AS DR_POSTAL_CODE                ,
COALESCE(DR_STREET_NAME,'')						 AS DR_STREET_NAME                ,
COALESCE(DR_HOUSE_NUMBER1,'')						 AS DR_HOUSE_NUMBER1              ,
COALESCE(DR_HOUSE_NUMBER2,'')						 AS DR_HOUSE_NUMBER2              ,
COALESCE(DR_POBOX_NUMBER,'')						 AS DR_POBOX_NUMBER               ,
COALESCE(DR_ADDRESS,'')							 AS DR_ADDRESS                    ,
COALESCE(DR_ADDRESS2,'')						 AS DR_ADDRESS2                   ,
COALESCE(DR_ADDRESS3,'')						 AS DR_ADDRESS3                   ,
COALESCE(LEGAL_ENT_NBR,'')						 AS LEGAL_ENT_NBR                 ,
COALESCE(CAST(CAST(BRTH_DATE AS DATE FORMAT 'YYYY-MM-DD') AS VARCHAR(10)),'')	   AS BRTH_DATE                     ,
COALESCE(LANG_CODE,'')								   AS LANG_CODE                     ,
COALESCE(CNSMR_USER_NAME,'')							   AS CNSMR_USER_NAME               ,
COALESCE(FULL_NAME,'')								   AS FULL_NAME                     ,
COALESCE(PR_NAME_FORM_01,'')							   AS PR_NAME_FORM_01               ,
COALESCE(CAST(CAST(SYS_SOURCE AS INTEGER) AS CHAR(20)),'')			   AS SYS_SOURCE                    ,
COALESCE(SYS_NC_TYPE,'')							   AS SYS_NC_TYPE                   ,
COALESCE(CAST(CAST(SYS_CREATION_DATE AS TIMESTAMP(0)) AS VARCHAR(20)),'')	   AS SYS_CREATION_DATE             ,
COALESCE(REGIS_DATE,'')                                                            AS REGIS_DATE                    ,
MIN(REFERENCE_HOUSEHOLD_ID) AS REFERENCE_HOUSEHOLD_ID,
MIN(REFERENCE_LEGALENTITYKEY)						   AS REFERENCE_LEGALENTITYKEY      ,
MIN(REFERENCE_REGISTRATIONKEY)						   AS REFERENCE_REGISTRATIONKEY     ,
MIN(WINDOW_KEY_01) WINDOW_KEY_01,
MIN(GOUT_MATCH_LEVEL) GOUT_MATCH_LEVEL
FROM 
TRILLIUM_OUTPUT1 A
GROUP BY 
COALESCE(MKTNG_PGM_NBR,''),
COALESCE(CAST(REGIS_CNSMR_ID_VAL AS CHAR(20)),''),
COALESCE(DR_FIRST_NAME,''),
COALESCE(DR_MIDDLE_NAME,''),
COALESCE(DR_LAST_NAME,''),
COALESCE(DR_MRMRS,''),
COALESCE(DR_NAME_SUFFIX,''),
COALESCE(DR_COUNTRY_NAME,''),
COALESCE(DR_REGION_NAME,''),
COALESCE(DR_CITY_NAME,''),
COALESCE(DR_POSTAL_CODE,''),
COALESCE(DR_STREET_NAME,''),
COALESCE(DR_HOUSE_NUMBER1,''),
COALESCE(DR_HOUSE_NUMBER2,''),
COALESCE(DR_POBOX_NUMBER,''),
COALESCE(DR_ADDRESS,''),
COALESCE(DR_ADDRESS2,''),
COALESCE(DR_ADDRESS3,''),
COALESCE(LEGAL_ENT_NBR,''),
COALESCE(CAST(CAST(BRTH_DATE AS DATE FORMAT 'YYYY-MM-DD') AS VARCHAR(10)),''),
COALESCE(LANG_CODE,''),
COALESCE(CNSMR_USER_NAME,''),
COALESCE(FULL_NAME,''),
COALESCE(PR_NAME_FORM_01,''),
COALESCE(CAST(CAST(SYS_SOURCE AS INTEGER) AS CHAR(20)),''),
COALESCE(SYS_NC_TYPE,''),
COALESCE(CAST(CAST(SYS_CREATION_DATE AS TIMESTAMP(0)) AS VARCHAR(20)),''),
COALESCE(REGIS_DATE,'')
HAVING COUNT(*) > 1
) B
SET REFERENCE_HOUSEHOLD_ID = B.REFERENCE_HOUSEHOLD_ID
,REFERENCE_LEGALENTITYKEY = B.REFERENCE_LEGALENTITYKEY
,REFERENCE_REGISTRATIONKEY = B.REFERENCE_REGISTRATIONKEY
,WINDOW_KEY_01 = B.WINDOW_KEY_01 
,GOUT_MATCH_LEVEL = B.GOUT_MATCH_LEVEL
WHERE COALESCE(A.MKTNG_PGM_NBR,'')							       =COALESCE(B.MKTNG_PGM_NBR,'')
  AND COALESCE(CAST(A.REGIS_CNSMR_ID_VAL AS CHAR(20)),'')	       =COALESCE(CAST(B.REGIS_CNSMR_ID_VAL AS CHAR(20)),'')
  AND COALESCE(A.DR_FIRST_NAME,'')						       =COALESCE(B.DR_FIRST_NAME,'')
  AND COALESCE(A.DR_MIDDLE_NAME,'')						       =COALESCE(B.DR_MIDDLE_NAME,'')
  AND COALESCE(A.DR_LAST_NAME,'')						       =COALESCE(B.DR_LAST_NAME,'')
  AND COALESCE(A.DR_MRMRS,'')							       =COALESCE(B.DR_MRMRS,'')
  AND COALESCE(A.DR_NAME_SUFFIX,'')						       =COALESCE(B.DR_NAME_SUFFIX,'')
  AND COALESCE(A.DR_COUNTRY_NAME,'')						       =COALESCE(B.DR_COUNTRY_NAME,'')
  AND COALESCE(A.DR_REGION_NAME,'')						       =COALESCE(B.DR_REGION_NAME,'')
  AND COALESCE(A.DR_CITY_NAME,'')						       =COALESCE(B.DR_CITY_NAME,'')
  AND COALESCE(A.DR_POSTAL_CODE,'')						       =COALESCE(B.DR_POSTAL_CODE,'')
  AND COALESCE(A.DR_STREET_NAME,'')						       =COALESCE(B.DR_STREET_NAME,'')
  AND COALESCE(A.DR_HOUSE_NUMBER1,'')						       =COALESCE(B.DR_HOUSE_NUMBER1,'')
  AND COALESCE(A.DR_HOUSE_NUMBER2,'')						       =COALESCE(B.DR_HOUSE_NUMBER2,'')
  AND COALESCE(A.DR_POBOX_NUMBER,'')						       =COALESCE(B.DR_POBOX_NUMBER,'')
  AND COALESCE(A.DR_ADDRESS,'')							       =COALESCE(B.DR_ADDRESS,'')
  AND COALESCE(A.DR_ADDRESS2,'')						       =COALESCE(B.DR_ADDRESS2,'')
  AND COALESCE(A.DR_ADDRESS3,'')						       =COALESCE(B.DR_ADDRESS3,'')
  AND COALESCE(A.LEGAL_ENT_NBR,'')						       =COALESCE(B.LEGAL_ENT_NBR,'')
  AND COALESCE(CAST(CAST(A.BRTH_DATE AS DATE FORMAT 'YYYY-MM-DD') AS VARCHAR(10)),'')  =B.BRTH_DATE
  AND COALESCE(A.LANG_CODE,'')							       =COALESCE(B.LANG_CODE,'')
  AND COALESCE(A.CNSMR_USER_NAME,'')						       =COALESCE(B.CNSMR_USER_NAME,'')
  AND COALESCE(A.FULL_NAME,'')							       =COALESCE(B.FULL_NAME,'')
  AND COALESCE(A.PR_NAME_FORM_01,'')						       =COALESCE(B.PR_NAME_FORM_01,'')
  AND COALESCE(CAST(CAST(A.SYS_SOURCE AS INTEGER) AS CHAR(20)),'')		       =B.SYS_SOURCE
  AND COALESCE(A.SYS_NC_TYPE,'')						       =COALESCE(B.SYS_NC_TYPE,'')
  AND COALESCE(CAST(CAST(A.SYS_CREATION_DATE AS TIMESTAMP(0)) AS VARCHAR(20)),'')      =B.SYS_CREATION_DATE
  AND COALESCE(A.REGIS_DATE,'')                                                          =COALESCE(B.REGIS_DATE,'')
; 

.LABEL PROCESS

UPDATE TRILLIUM_OUTPUT1 SET RECORD_IND='NNN'
WHERE REFERENCE_HOUSEHOLD_ID LIKE 'HH%';
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE TRILLIUM_OUTPUT1 SET RECORD_IND='NNY'
WHERE REFERENCE_REGISTRATIONKEY LIKE 'RG%' AND
REFERENCE_LEGALENTITYKEY LIKE 'LE%' AND REFERENCE_HOUSEHOLD_ID NOT LIKE 'HH%';
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE TRILLIUM_OUTPUT1 SET RECORD_IND='NYY'
WHERE REFERENCE_REGISTRATIONKEY LIKE 'RG%' AND
REFERENCE_LEGALENTITYKEY NOT LIKE 'LE%' AND REFERENCE_HOUSEHOLD_ID NOT LIKE 'HH%';
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE TRILLIUM_OUTPUT1 SET RECORD_IND='Y'
WHERE REFERENCE_REGISTRATIONKEY NOT LIKE 'RG%' AND
REFERENCE_LEGALENTITYKEY NOT LIKE 'LE%' AND REFERENCE_HOUSEHOLD_ID NOT LIKE 'HH%';
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE TRILLIUM_OUTPUT1 SET RECORD_IND='Y'
WHERE (LEGAL_ENT_NBR
,MKTNG_PGM_NBR   
,REGIS_CNSMR_ID_VAL)
IN
(SELECT
LEGAL_ENT_NBR
,MKTNG_PGM_NBR   
,REGIS_CNSMR_ID_VAL
FROM
REGIS_PRSNA
);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE TRILLIUM_OUTPUT1 
FROM 
(SELECT
LEGAL_ENT_NBR
,MKTNG_PGM_NBR   
,REGIS_CNSMR_ID_VAL
,REGIS_DATE
FROM
REGIS_PRSNA
WHERE PRSNA_STATUS_CODE = 'AC'
GROUP BY 1,2,3,4
) B
SET RECORD_IND = NULL
WHERE TRILLIUM_OUTPUT1.LEGAL_ENT_NBR=B.LEGAL_ENT_NBR
AND TRILLIUM_OUTPUT1.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR
AND TRILLIUM_OUTPUT1.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
AND CAST(TRIM(SUBSTR(TRILLIUM_OUTPUT1.REGIS_DATE,1,10)) AS DATE FORMAT 'YYYY-MM-DD') < CAST(B.REGIS_DATE AS DATE FORMAT 'MM/DD/YYYY')
; 
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE TRILLIUM_OUTPUT1
FROM
(
SELECT * FROM
(
SELECT 
 LEGAL_ENT_NBR
,MKTNG_PGM_NBR   
,REGIS_CNSMR_ID_VAL
,REGIS_DATE
,SYS_SOURCE
,SYS_CREATION_DATE
,SYS_NC_TYPE
,RANK() OVER (PARTITION BY LEGAL_ENT_NBR
,MKTNG_PGM_NBR   
,REGIS_CNSMR_ID_VAL 
ORDER BY LEGAL_ENT_NBR
,MKTNG_PGM_NBR   
,REGIS_CNSMR_ID_VAL
,REGIS_DATE DESC 
,SYS_SOURCE DESC
,SYS_CREATION_DATE DESC
,SYS_NC_TYPE DESC
) AS RNK
GROUP BY LEGAL_ENT_NBR
,MKTNG_PGM_NBR   
,REGIS_CNSMR_ID_VAL
,REGIS_DATE
,SYS_SOURCE
,SYS_CREATION_DATE
,SYS_NC_TYPE
FROM TRILLIUM_OUTPUT1
) B
WHERE RNK = 1
) B

SET RECENT_IND = 'Y'
WHERE TRILLIUM_OUTPUT1.LEGAL_ENT_NBR=B.LEGAL_ENT_NBR
AND TRILLIUM_OUTPUT1.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR
AND TRILLIUM_OUTPUT1.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
AND TRILLIUM_OUTPUT1.REGIS_DATE=B.REGIS_DATE
AND TRILLIUM_OUTPUT1.SYS_CREATION_DATE=B.SYS_CREATION_DATE
AND TRILLIUM_OUTPUT1.SYS_NC_TYPE=B.SYS_NC_TYPE
AND TRILLIUM_OUTPUT1.SYS_SOURCE=B.SYS_SOURCE
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(RECORD_IND);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(RECENT_IND);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,DR_ALIAS_CONTACT,DR_FIRST_NAME,DR_MIDDLE_NAME,DR_LAST_NAME,DR_MRMRS,DR_NAME_GENER,DR_NAME_SUFFIX,DR_NAME_GENDER,DR_COUNTRY_NAME,DR_REGION_NAME,DR_CITY_NAME,DR_POSTAL_CODE,DR_STREET_NAME,DR_HOUSE_NUMBER1,DR_HOUSE_NUMBER2,DR_POBOX_NUMBER,DR_ADDRESS,DR_ADDRESS2,DR_ADDRESS3,PR_REV_GROUP,GOUT_MATCH_LEVEL,WINDOW_KEY_01,REFERENCE_HOUSEHOLD_ID,REFERENCE_LEGALENTITYKEY,REFERENCE_REGISTRATIONKEY,LEGAL_ENT_NBR,BRTH_DATE,LANG_CODE,CNSMR_USER_NAME,STATUS,FULL_NAME,PR_NAME_FORM_01,DR_ALIAS_ACCOUNT,DR_BUSINESS_NAME,REGIS_DATE,RECORD_IND,RECENT_IND,REGIS_PRSNA_ID,HH_FLAG,LE_FLAG,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_CREATION_DATE,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_LAST_MODIFIED_DATE,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,DR_ALIAS_CONTACT,DR_FIRST_NAME,DR_MIDDLE_NAME,DR_LAST_NAME,DR_MRMRS,DR_NAME_GENER,DR_NAME_SUFFIX,DR_NAME_GENDER,DR_COUNTRY_NAME,DR_REGION_NAME,DR_CITY_NAME,DR_POSTAL_CODE,DR_STREET_NAME,DR_HOUSE_NUMBER1,DR_HOUSE_NUMBER2,DR_POBOX_NUMBER,DR_ADDRESS,DR_ADDRESS2,DR_ADDRESS3,CLEANSED_PHONE_1,CLEANSED_EMAIL_1,PR_REV_GROUP,GOUT_MATCH_LEVEL,WINDOW_KEY_01,REFERENCE_HOUSEHOLD_ID,REFERENCE_LEGALENTITYKEY,REFERENCE_REGISTRATIONKEY,LEGAL_ENT_NBR,BRTH_DATE,LANG_CODE,CNSMR_USER_NAME,STATUS,FULL_NAME,DPEND_NAME,PET_NAME,PR_NAME_FORM_01,DR_ALIAS_ACCOUNT,REFERENCE_MATCHED_LEV1_PATTERN,REFERENCE_MATCHED_LEV2_PATTERN,DR_BUSINESS_NAME,EMAIL_IND,REGIS_DATE,RECORD_IND,RECENT_IND,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_LAST_MODIFIED_DATE,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(RECORD_IND,RECENT_IND);
COLLECT STATS ON TRILLIUM_OUTPUT1 COLUMN(DR_COUNTRY_NAME,RECORD_IND,RECENT_IND);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DEL FROM TRILLIUM_MDM_REFERENCE ALL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT TRILLIUM_MDM_REFERENCE 
(
 LEGAL_ENT_NBR
,MKTNG_PGM_NBR                 
,REGIS_CNSMR_ID_VAL            
,REFERENCE_HOUSEHOLD_ID        
,REFERENCE_LEGALENTITYKEY      
,NEW_HOUSEHOLD_ID              
,NEW_LEGAL_ENTITY_KEY          
,REFERENCE_REGISTRATIONKEY     
,NEW_REGISTRATION_KEY          
,SYS_CREATION_DATE             
,SYS_ENT_STATE                 
,SYS_NC_TYPE     
,SYS_LAST_MODIFIED_BY
,SYS_SOURCE
)
SELECT
 LEGAL_ENT_NBR
,MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL            
,REFERENCE_HOUSEHOLD_ID        
,REFERENCE_LEGALENTITYKEY      
,CASE WHEN SUBSTR(TRIM(REFERENCE_HOUSEHOLD_ID),1,2)='HH'
      THEN TRIM(D.HSHLD_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY REFERENCE_HOUSEHOLD_ID))
      ELSE REFERENCE_HOUSEHOLD_ID
  END
,CASE WHEN SUBSTR(TRIM(REFERENCE_LEGALENTITYKEY),1,2)='LE'
      THEN TRIM(C.MATCHD_CNSMR_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY REFERENCE_LEGALENTITYKEY))
      ELSE REFERENCE_LEGALENTITYKEY
  END         
,REFERENCE_REGISTRATIONKEY     
,CASE WHEN SUBSTR(TRIM(REFERENCE_REGISTRATIONKEY),1,2)='RG'
      THEN TRIM(B.REGIS_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY REFERENCE_REGISTRATIONKEY))
      ELSE REFERENCE_REGISTRATIONKEY
  END         
,SYS_CREATION_DATE             
,'ACTIVE'                 
,SYS_NC_TYPE 
,CASE WHEN SUBSTR(TRIM(REFERENCE_HOUSEHOLD_ID),1,2)='HH'
        OR SUBSTR(TRIM(REFERENCE_LEGALENTITYKEY),1,2)='LE'
        OR SUBSTR(TRIM(REFERENCE_REGISTRATIONKEY),1,2)='RG'
      THEN 'TRILLIUM'
  END AS SYS_LAST_MODIFIED_BY1
,SYS_SOURCE
FROM
TRILLIUM_OUTPUT1 A
INNER JOIN (SEL COALESCE(MAX(REGIS_PRSNA_ID),0) AS REGIS_PRSNA_ID
FROM REGIS_PRSNA) B
ON 1=1
INNER JOIN (SEL COALESCE(MAX(MATCHD_CNSMR_PRSNA_ID),0) AS MATCHD_CNSMR_PRSNA_ID
FROM MATCHD_CNSMR_PRSNA) C
ON 1=1
INNER JOIN (SEL COALESCE(MAX(HSHLD_PRSNA_ID),0) AS HSHLD_PRSNA_ID
FROM HSHLD_PRSNA) D
ON 1=1
WHERE SYS_LAST_MODIFIED_BY1 = 'TRILLIUM'
AND RECENT_IND = 'Y'
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

COLLECT STATS ON MDM.TRILLIUM_MDM_REFERENCE
COLUMN (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LEGAL_ENT_NBR,SYS_SOURCE);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;


UPDATE TRILLIUM_OUTPUT1
FROM 
(SELECT MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
LEGAL_ENT_NBR,
SYS_SOURCE,
MIN(NEW_HOUSEHOLD_ID) NEW_HOUSEHOLD_ID,
MIN(NEW_LEGAL_ENTITY_KEY) NEW_LEGAL_ENTITY_KEY,
MIN(NEW_REGISTRATION_KEY) NEW_REGISTRATION_KEY
FROM
TRILLIUM_MDM_REFERENCE
GROUP BY 1,2,3,4
) B
SET REFERENCE_HOUSEHOLD_ID = B.NEW_HOUSEHOLD_ID
,REFERENCE_LEGALENTITYKEY = B.NEW_LEGAL_ENTITY_KEY
,REFERENCE_REGISTRATIONKEY = B.NEW_REGISTRATION_KEY
WHERE TRILLIUM_OUTPUT1.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND TRILLIUM_OUTPUT1.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
AND TRILLIUM_OUTPUT1.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND TRILLIUM_OUTPUT1.SYS_SOURCE = B.SYS_SOURCE
AND TRILLIUM_OUTPUT1.RECENT_IND = 'Y'
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS TRILLIUM_OUTPUT_DUP
(
  MKTNG_PGM_NBR                                                                 
 ,REGIS_CNSMR_ID_VAL                                                            
 ,DR_ALIAS_CONTACT                                                              
 ,DR_FIRST_NAME                                                                 
 ,DR_MIDDLE_NAME                                                                
 ,DR_LAST_NAME                                                                  
 ,DR_MRMRS                                                                      
 ,DR_NAME_GENER                                                                 
 ,DR_NAME_SUFFIX                                                                
 ,DR_NAME_GENDER                                                                
 ,DR_COUNTRY_NAME                                                               
 ,DR_REGION_NAME                                                                
 ,DR_CITY_NAME                                                                  
 ,DR_POSTAL_CODE                                                                
 ,DR_STREET_NAME                                                                
 ,DR_HOUSE_NUMBER1                                                              
 ,DR_HOUSE_NUMBER2                                                              
 ,DR_POBOX_NUMBER                                                               
 ,DR_ADDRESS                                                                    
 ,DR_ADDRESS2                                                                   
 ,DR_ADDRESS3                                                                   
 ,CLEANSED_PHONE_1                                                              
 ,CLEANSED_EMAIL_1                                                              
 ,PR_REV_GROUP                                                                  
 ,GOUT_MATCH_LEVEL                                                              
 ,WINDOW_KEY_01                                                                 
 ,REFERENCE_HOUSEHOLD_ID                                                        
 ,REFERENCE_LEGALENTITYKEY                                                      
 ,REFERENCE_REGISTRATIONKEY                                                     
 ,LEGAL_ENT_NBR                                                                 
 ,BRTH_DATE                                                                     
 ,LANG_CODE                                                                     
 ,CNSMR_USER_NAME                                                               
 ,STATUS                                                                        
 ,FULL_NAME                                                                     
 ,DPEND_NAME                                                                    
 ,PET_NAME                                                                      
 ,PR_NAME_FORM_01                                                               
 ,DR_ALIAS_ACCOUNT                                                              
 ,REFERENCE_MATCHED_LEV1_PATTERN                                                
 ,REFERENCE_MATCHED_LEV2_PATTERN                                                
 ,DR_BUSINESS_NAME                                                              
 ,EMAIL_IND     
 ,REGIS_DATE
 ,RECORD_IND
 ,RECENT_IND 
 ,SYS_TARGET_ID                                                                 
 ,SYS_AUTH_ID                                                                   
 ,SYS_SOURCE                                                                    
 ,SYS_CREATED_BY                                                                
 ,SYS_CREATION_DATE                                                             
 ,SYS_ENT_STATE                                                                 
 ,SYS_LAST_MODIFIED_BY                                                          
 ,SYS_LAST_MODIFIED_DATE                                                        
 ,SYS_NC_TYPE                                                                   
 ,SYS_ERR_CODE                                                                  
 ,SYS_ERR_SVRTY
) 
SEL  
  A.MKTNG_PGM_NBR                                                                 
 ,A.REGIS_CNSMR_ID_VAL                                                            
 ,DR_ALIAS_CONTACT                                                              
 ,DR_FIRST_NAME                                                                 
 ,DR_MIDDLE_NAME                                                                
 ,DR_LAST_NAME                                                                  
 ,DR_MRMRS                                                                      
 ,DR_NAME_GENER                                                                 
 ,DR_NAME_SUFFIX                                                                
 ,DR_NAME_GENDER                                                                
 ,DR_COUNTRY_NAME                                                               
 ,DR_REGION_NAME                                                                
 ,DR_CITY_NAME                                                                  
 ,DR_POSTAL_CODE                                                                
 ,DR_STREET_NAME                                                                
 ,DR_HOUSE_NUMBER1                                                              
 ,DR_HOUSE_NUMBER2                                                              
 ,DR_POBOX_NUMBER                                                               
 ,DR_ADDRESS                                                                    
 ,DR_ADDRESS2                                                                   
 ,DR_ADDRESS3                                                                   
 ,CLEANSED_PHONE_1                                                              
 ,CLEANSED_EMAIL_1                                                              
 ,PR_REV_GROUP                                                                  
 ,GOUT_MATCH_LEVEL                                                              
 ,WINDOW_KEY_01                                                                 
 ,REFERENCE_HOUSEHOLD_ID                                                        
 ,REFERENCE_LEGALENTITYKEY                                                      
 ,REFERENCE_REGISTRATIONKEY                                                     
 ,A.LEGAL_ENT_NBR                                                                 
 ,A.BRTH_DATE                                                                     
 ,A.LANG_CODE                                                                     
 ,A.CNSMR_USER_NAME                                                               
 ,STATUS                                                                        
 ,A.FULL_NAME                                                                     
 ,DPEND_NAME                                                                    
 ,PET_NAME                                                                      
 ,PR_NAME_FORM_01                                                               
 ,DR_ALIAS_ACCOUNT                                                              
 ,REFERENCE_MATCHED_LEV1_PATTERN                                                
 ,REFERENCE_MATCHED_LEV2_PATTERN                                                
 ,DR_BUSINESS_NAME                                                              
 ,EMAIL_IND     
 ,A.REGIS_DATE
 ,RECORD_IND
 ,RECENT_IND 
 ,A.SYS_TARGET_ID                                                                 
 ,A.SYS_AUTH_ID                                                                   
 ,A.SYS_SOURCE                                                                    
 ,A.SYS_CREATED_BY                                                                
 ,CAST(CAST(CURRENT_TIMESTAMP AS TIMESTAMP(6)) AS VARCHAR(19))                                                             
 ,A.SYS_ENT_STATE                                                                 
 ,A.SYS_LAST_MODIFIED_BY                                                          
 ,A.SYS_LAST_MODIFIED_DATE                                                        
 ,A.SYS_NC_TYPE                                                                   
 ,A.SYS_ERR_CODE                                                                  
 ,A.SYS_ERR_SVRTY
 FROM TRILLIUM_OUTPUT1 A
 LEFT OUTER JOIN REGIS_PRSNA B
 ON A.LEGAL_ENT_NBR=B.LEGAL_ENT_NBR
AND A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR
AND A.REFERENCE_REGISTRATIONKEY=B.REGIS_PRSNA_ID
AND B.PRSNA_STATUS_CODE = 'AC'
WHERE A.RECENT_IND = 'Y'
AND A.REGIS_CNSMR_ID_VAL <> B.REGIS_CNSMR_ID_VAL
GROUP BY 1,2,3,4,5,6,7,8,9,10,
11,12,13,14,15,16,17,18,19,20,
21,22,23,24,25,26,27,28,29,30,
31,32,33,34,35,36,37,38,39,40,
41,42,43,44,45,46,47,48,49,50,
51,52,53,54,55,56,57
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS TRILLIUM_OUTPUT_DUP
(
  MKTNG_PGM_NBR                                                                 
 ,REGIS_CNSMR_ID_VAL                                                            
 ,DR_ALIAS_CONTACT                                                              
 ,DR_FIRST_NAME                                                                 
 ,DR_MIDDLE_NAME                                                                
 ,DR_LAST_NAME                                                                  
 ,DR_MRMRS                                                                      
 ,DR_NAME_GENER                                                                 
 ,DR_NAME_SUFFIX                                                                
 ,DR_NAME_GENDER                                                                
 ,DR_COUNTRY_NAME                                                               
 ,DR_REGION_NAME                                                                
 ,DR_CITY_NAME                                                                  
 ,DR_POSTAL_CODE                                                                
 ,DR_STREET_NAME                                                                
 ,DR_HOUSE_NUMBER1                                                              
 ,DR_HOUSE_NUMBER2                                                              
 ,DR_POBOX_NUMBER                                                               
 ,DR_ADDRESS                                                                    
 ,DR_ADDRESS2                                                                   
 ,DR_ADDRESS3                                                                   
 ,CLEANSED_PHONE_1                                                              
 ,CLEANSED_EMAIL_1                                                              
 ,PR_REV_GROUP                                                                  
 ,GOUT_MATCH_LEVEL                                                              
 ,WINDOW_KEY_01                                                                 
 ,REFERENCE_HOUSEHOLD_ID                                                        
 ,REFERENCE_LEGALENTITYKEY                                                      
 ,REFERENCE_REGISTRATIONKEY                                                     
 ,LEGAL_ENT_NBR                                                                 
 ,BRTH_DATE                                                                     
 ,LANG_CODE                                                                     
 ,CNSMR_USER_NAME                                                               
 ,STATUS                                                                        
 ,FULL_NAME                                                                     
 ,DPEND_NAME                                                                    
 ,PET_NAME                                                                      
 ,PR_NAME_FORM_01                                                               
 ,DR_ALIAS_ACCOUNT                                                              
 ,REFERENCE_MATCHED_LEV1_PATTERN                                                
 ,REFERENCE_MATCHED_LEV2_PATTERN                                                
 ,DR_BUSINESS_NAME                                                              
 ,EMAIL_IND     
 ,REGIS_DATE
 ,RECORD_IND
 ,RECENT_IND 
 ,SYS_TARGET_ID                                                                 
 ,SYS_AUTH_ID                                                                   
 ,SYS_SOURCE                                                                    
 ,SYS_CREATED_BY                                                                
 ,SYS_CREATION_DATE                                                             
 ,SYS_ENT_STATE                                                                 
 ,SYS_LAST_MODIFIED_BY                                                          
 ,SYS_LAST_MODIFIED_DATE                                                        
 ,SYS_NC_TYPE                                                                   
 ,SYS_ERR_CODE                                                                  
 ,SYS_ERR_SVRTY
) 
SEL DISTINCT
  A.MKTNG_PGM_NBR                                                                 
 ,A.REGIS_CNSMR_ID_VAL                                                            
 ,DR_ALIAS_CONTACT                                                              
 ,DR_FIRST_NAME                                                                 
 ,DR_MIDDLE_NAME                                                                
 ,DR_LAST_NAME                                                                  
 ,DR_MRMRS                                                                      
 ,DR_NAME_GENER                                                                 
 ,DR_NAME_SUFFIX                                                                
 ,DR_NAME_GENDER                                                                
 ,DR_COUNTRY_NAME                                                               
 ,DR_REGION_NAME                                                                
 ,DR_CITY_NAME                                                                  
 ,DR_POSTAL_CODE                                                                
 ,DR_STREET_NAME                                                                
 ,DR_HOUSE_NUMBER1                                                              
 ,DR_HOUSE_NUMBER2                                                              
 ,DR_POBOX_NUMBER                                                               
 ,DR_ADDRESS                                                                    
 ,DR_ADDRESS2                                                                   
 ,DR_ADDRESS3                                                                   
 ,CLEANSED_PHONE_1                                                              
 ,CLEANSED_EMAIL_1                                                              
 ,PR_REV_GROUP                                                                  
 ,GOUT_MATCH_LEVEL                                                              
 ,WINDOW_KEY_01                                                                 
 ,REFERENCE_HOUSEHOLD_ID                                                        
 ,REFERENCE_LEGALENTITYKEY                                                      
 ,REFERENCE_REGISTRATIONKEY                                                     
 ,A.LEGAL_ENT_NBR                                                                 
 ,A.BRTH_DATE                                                                     
 ,A.LANG_CODE                                                                     
 ,A.CNSMR_USER_NAME                                                               
 ,STATUS                                                                        
 ,A.FULL_NAME                                                                     
 ,DPEND_NAME                                                                    
 ,PET_NAME                                                                      
 ,PR_NAME_FORM_01                                                               
 ,DR_ALIAS_ACCOUNT                                                              
 ,REFERENCE_MATCHED_LEV1_PATTERN                                                
 ,REFERENCE_MATCHED_LEV2_PATTERN                                                
 ,DR_BUSINESS_NAME                                                              
 ,EMAIL_IND     
 ,A.REGIS_DATE
 ,RECORD_IND
 ,RECENT_IND 
 ,A.SYS_TARGET_ID                                                                 
 ,A.SYS_AUTH_ID                                                                   
 ,A.SYS_SOURCE                                                                    
 ,A.SYS_CREATED_BY                                                                
 ,CAST(CAST(CURRENT_TIMESTAMP AS TIMESTAMP(6)) AS VARCHAR(19))                                                            
 ,A.SYS_ENT_STATE                                                                 
 ,A.SYS_LAST_MODIFIED_BY                                                          
 ,A.SYS_LAST_MODIFIED_DATE                                                        
 ,A.SYS_NC_TYPE                                                                   
 ,A.SYS_ERR_CODE                                                                  
 ,A.SYS_ERR_SVRTY
 FROM TRILLIUM_OUTPUT1 A
 WHERE A.RECENT_IND = 'Y'
 QUALIFY RANK() OVER (PARTITION BY REFERENCE_REGISTRATIONKEY
 ORDER BY A.LEGAL_ENT_NBR
 ,A.MKTNG_PGM_NBR   
 ,REFERENCE_REGISTRATIONKEY
 ,A.REGIS_DATE DESC
 ,A.REGIS_CNSMR_ID_VAL DESC
 ,A.SYS_CREATION_DATE DESC
 ,A.SYS_NC_TYPE DESC
) <> 1
;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

COLLECT STATS ON MDM.TRILLIUM_OUTPUT_DUP1
COLUMN (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE TRILLIUM_OUTPUT1
FROM 
(
SEL A.LEGAL_ENT_NBR
,A.MKTNG_PGM_NBR
,A.REGIS_CNSMR_ID_VAL
,MAX(A.REGIS_PRSNA_ID) REGIS_PRSNA_ID
FROM
REGIS_PRSNA A
GROUP BY 1,2,3) B
SET REGIS_PRSNA_ID = TRIM(B.REGIS_PRSNA_ID)
WHERE TRILLIUM_OUTPUT1.LEGAL_ENT_NBR=B.LEGAL_ENT_NBR
AND TRILLIUM_OUTPUT1.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR
AND TRILLIUM_OUTPUT1.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS TRILLIUM_OUTPUT_DUP
(
  MKTNG_PGM_NBR                                                                 
 ,REGIS_CNSMR_ID_VAL                                                            
 ,DR_ALIAS_CONTACT                                                              
 ,DR_FIRST_NAME                                                                 
 ,DR_MIDDLE_NAME                                                                
 ,DR_LAST_NAME                                                                  
 ,DR_MRMRS                                                                      
 ,DR_NAME_GENER                                                                 
 ,DR_NAME_SUFFIX                                                                
 ,DR_NAME_GENDER                                                                
 ,DR_COUNTRY_NAME                                                               
 ,DR_REGION_NAME                                                                
 ,DR_CITY_NAME                                                                  
 ,DR_POSTAL_CODE                                                                
 ,DR_STREET_NAME                                                                
 ,DR_HOUSE_NUMBER1                                                              
 ,DR_HOUSE_NUMBER2                                                              
 ,DR_POBOX_NUMBER                                                               
 ,DR_ADDRESS                                                                    
 ,DR_ADDRESS2                                                                   
 ,DR_ADDRESS3                                                                   
 ,CLEANSED_PHONE_1                                                              
 ,CLEANSED_EMAIL_1                                                              
 ,PR_REV_GROUP                                                                  
 ,GOUT_MATCH_LEVEL                                                              
 ,WINDOW_KEY_01                                                                 
 ,REFERENCE_HOUSEHOLD_ID                                                        
 ,REFERENCE_LEGALENTITYKEY                                                      
 ,REFERENCE_REGISTRATIONKEY                                                     
 ,LEGAL_ENT_NBR                                                                 
 ,BRTH_DATE                                                                     
 ,LANG_CODE                                                                     
 ,CNSMR_USER_NAME                                                               
 ,STATUS                                                                        
 ,FULL_NAME                                                                     
 ,DPEND_NAME                                                                    
 ,PET_NAME                                                                      
 ,PR_NAME_FORM_01                                                               
 ,DR_ALIAS_ACCOUNT                                                              
 ,REFERENCE_MATCHED_LEV1_PATTERN                                                
 ,REFERENCE_MATCHED_LEV2_PATTERN                                                
 ,DR_BUSINESS_NAME                                                              
 ,EMAIL_IND     
 ,REGIS_DATE
 ,RECORD_IND
 ,RECENT_IND 
 ,DUP_REGIS_PRSNA_ID
 ,SYS_TARGET_ID                                                                 
 ,SYS_AUTH_ID                                                                   
 ,SYS_SOURCE                                                                    
 ,SYS_CREATED_BY                                                                
 ,SYS_CREATION_DATE                                                             
 ,SYS_ENT_STATE                                                                 
 ,SYS_LAST_MODIFIED_BY                                                          
 ,SYS_LAST_MODIFIED_DATE                                                        
 ,SYS_NC_TYPE                                                                   
 ,SYS_ERR_CODE                                                                  
 ,SYS_ERR_SVRTY
) 
SEL  
  A.MKTNG_PGM_NBR                                                                 
 ,A.REGIS_CNSMR_ID_VAL                                                            
 ,DR_ALIAS_CONTACT                                                              
 ,DR_FIRST_NAME                                                                 
 ,DR_MIDDLE_NAME                                                                
 ,DR_LAST_NAME                                                                  
 ,DR_MRMRS                                                                      
 ,DR_NAME_GENER                                                                 
 ,DR_NAME_SUFFIX                                                                
 ,DR_NAME_GENDER                                                                
 ,DR_COUNTRY_NAME                                                               
 ,DR_REGION_NAME                                                                
 ,DR_CITY_NAME                                                                  
 ,DR_POSTAL_CODE                                                                
 ,DR_STREET_NAME                                                                
 ,DR_HOUSE_NUMBER1                                                              
 ,DR_HOUSE_NUMBER2                                                              
 ,DR_POBOX_NUMBER                                                               
 ,DR_ADDRESS                                                                    
 ,DR_ADDRESS2                                                                   
 ,DR_ADDRESS3                                                                   
 ,CLEANSED_PHONE_1                                                              
 ,CLEANSED_EMAIL_1                                                              
 ,PR_REV_GROUP                                                                  
 ,GOUT_MATCH_LEVEL                                                              
 ,WINDOW_KEY_01                                                                 
 ,REFERENCE_HOUSEHOLD_ID                                                        
 ,REFERENCE_LEGALENTITYKEY                                                      
 ,REFERENCE_REGISTRATIONKEY                                                     
 ,A.LEGAL_ENT_NBR                                                                 
 ,A.BRTH_DATE                                                                     
 ,A.LANG_CODE                                                                     
 ,A.CNSMR_USER_NAME                                                               
 ,STATUS                                                                        
 ,A.FULL_NAME                                                                     
 ,DPEND_NAME                                                                    
 ,PET_NAME                                                                      
 ,PR_NAME_FORM_01                                                               
 ,DR_ALIAS_ACCOUNT                                                              
 ,REFERENCE_MATCHED_LEV1_PATTERN                                                
 ,REFERENCE_MATCHED_LEV2_PATTERN                                                
 ,DR_BUSINESS_NAME                                                              
 ,EMAIL_IND     
 ,A.REGIS_DATE
 ,RECORD_IND
 ,RECENT_IND 
 ,TRIM(A.REGIS_PRSNA_ID)
 ,A.SYS_TARGET_ID                                                                 
 ,A.SYS_AUTH_ID                                                                   
 ,A.SYS_SOURCE                                                                    
 ,A.SYS_CREATED_BY                                                                
 ,CAST(CAST(CURRENT_TIMESTAMP AS TIMESTAMP(6)) AS VARCHAR(19))                                                              
 ,A.SYS_ENT_STATE                                                                 
 ,A.SYS_LAST_MODIFIED_BY                                                          
 ,A.SYS_LAST_MODIFIED_DATE                                                        
 ,A.SYS_NC_TYPE                                                                   
 ,A.SYS_ERR_CODE                                                                  
 ,A.SYS_ERR_SVRTY
 FROM TRILLIUM_OUTPUT1 A
WHERE A.RECENT_IND = 'Y'
AND CAST(A.REFERENCE_REGISTRATIONKEY AS INTEGER) <> A.REGIS_PRSNA_ID
AND CAST(A.REFERENCE_REGISTRATIONKEY AS INTEGER) IN (SELECT REGIS_PRSNA_ID
FROM REGIS_PRSNA
GROUP BY 1)
AND CAST(A.REFERENCE_LEGALENTITYKEY AS INTEGER) IN (SELECT MATCHD_CNSMR_PRSNA_ID
FROM MATCHD_CNSMR_PRSNA
GROUP BY 1)
AND CAST(A.REFERENCE_HOUSEHOLD_ID AS INTEGER) IN (SELECT HSHLD_PRSNA_ID
FROM HSHLD_PRSNA
GROUP BY 1)
GROUP BY 1,2,3,4,5,6,7,8,9,10,
11,12,13,14,15,16,17,18,19,20,
21,22,23,24,25,26,27,28,29,30,
31,32,33,34,35,36,37,38,39,40,
41,42,43,44,45,46,47,48,49,50,
51,52,53,54,55,56,57,58
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE TRILLIUM_OUTPUT1
FROM 
(
SEL DISTINCT A.LEGAL_ENT_NBR
,A.MKTNG_PGM_NBR
,A.REGIS_DATE
,A.REFERENCE_REGISTRATIONKEY
,A.REGIS_CNSMR_ID_VAL
--,A.SYS_CREATION_DATE
,A.SYS_NC_TYPE,TRIM(CASE WHEN D.REGIS_PRSNA_ID > C.REGIS_PRSNA_ID
                  THEN D.REGIS_PRSNA_ID
                  ELSE C.REGIS_PRSNA_ID
              END + RANK() OVER (PARTITION BY 1 ORDER BY A.REGIS_CNSMR_ID_VAL))
AS REGIS_PRSNA_ID FROM
TRILLIUM_OUTPUT_DUP A
INNER JOIN TRILLIUM_OUTPUT1 B
 ON A.LEGAL_ENT_NBR=B.LEGAL_ENT_NBR
AND A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR
AND A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
AND B.RECENT_IND = 'Y'
INNER JOIN (SEL COALESCE(MAX(CAST(REFERENCE_REGISTRATIONKEY AS INTEGER)),0
) AS REGIS_PRSNA_ID
FROM TRILLIUM_OUTPUT1
WHERE RECENT_IND = 'Y') C
ON 1=1
INNER JOIN (SEL COALESCE(MAX(CAST(NEW_REGISTRATION_KEY AS INTEGER)),0) AS REGIS_PRSNA_ID
FROM TRILLIUM_MDM_REFERENCE) D
ON 1=1
WHERE DUP_REGIS_PRSNA_ID IS NULL
AND B.REGIS_PRSNA_ID IS NULL) B
SET REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
WHERE TRILLIUM_OUTPUT1.LEGAL_ENT_NBR=B.LEGAL_ENT_NBR
AND TRILLIUM_OUTPUT1.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR
AND TRILLIUM_OUTPUT1.REGIS_DATE=B.REGIS_DATE
AND TRILLIUM_OUTPUT1.REFERENCE_REGISTRATIONKEY=B.REFERENCE_REGISTRATIONKEY
AND TRILLIUM_OUTPUT1.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
--AND TRILLIUM_OUTPUT1.SYS_CREATION_DATE=B.SYS_CREATION_DATE
AND TRILLIUM_OUTPUT1.SYS_NC_TYPE=B.SYS_NC_TYPE
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE TRILLIUM_OUTPUT_DUP
FROM 
(
SEL A.LEGAL_ENT_NBR
,A.MKTNG_PGM_NBR
,A.REGIS_DATE
,A.REFERENCE_REGISTRATIONKEY
,A.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE
,A.SYS_NC_TYPE,B.REGIS_PRSNA_ID FROM
TRILLIUM_OUTPUT_DUP A
INNER JOIN TRILLIUM_OUTPUT1 B
 ON A.LEGAL_ENT_NBR=B.LEGAL_ENT_NBR
AND A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR
AND A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
AND B.RECENT_IND = 'Y'
AND A.DUP_REGIS_PRSNA_ID IS NULL
GROUP BY 1,2,3,4,5,6,7,8
) B
SET DUP_REGIS_PRSNA_ID = TRIM(B.REGIS_PRSNA_ID)
WHERE TRILLIUM_OUTPUT_DUP.LEGAL_ENT_NBR=B.LEGAL_ENT_NBR
AND TRILLIUM_OUTPUT_DUP.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR
AND TRILLIUM_OUTPUT_DUP.REGIS_DATE=B.REGIS_DATE
AND TRILLIUM_OUTPUT_DUP.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
AND TRILLIUM_OUTPUT_DUP.SYS_CREATION_DATE=B.SYS_CREATION_DATE
AND TRILLIUM_OUTPUT_DUP.SYS_NC_TYPE=B.SYS_NC_TYPE
AND TRILLIUM_OUTPUT_DUP.DUP_REGIS_PRSNA_ID IS NULL
;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DEL FROM TRILLIUM_OUTPUT1 
WHERE RECENT_IND IS NULL
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS CNSMR_AFFLTN 
(
CNSMR_GRP_NBR                         ,
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
AFFLTN_START_DATE             ,
AFFLTN_END_DATE               ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT DISTINCT
A.CNSMR_GRP_NBR                         ,
COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.AFFLTN_START_DATE             ,
A.AFFLTN_END_DATE             ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)),
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)),
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM CNSMR_AFFLTN_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
WHERE 
RECENT_IND = 'Y'
AND REFERENCE_REGISTRATIONKEY1 NOT IN (SELECT TRIM(REGIS_PRSNA_ID)
FROM CNSMR_AFFLTN GROUP BY 1)	
QUALIFY RANK() OVER(PARTITION BY REFERENCE_REGISTRATIONKEY1,A.CNSMR_GRP_NBR
ORDER BY B.SYS_NC_TYPE DESC, B.SYS_SOURCE DESC  ) = 1
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO HSHLD_PRSNA  
(HSHLD_PRSNA_ID
,LEGAL_ENT_NBR
,PRSNA_STATUS_CODE
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE                                                                  
,SYS_ERR_SVRTY) 
SELECT *
FROM
(SELECT
REFERENCE_HOUSEHOLD_ID
,LEGAL_ENT_NBR
,'ACTIVATED' PRSNA_STATUS_CODE
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE                                                                  
,SYS_ERR_SVRTY
FROM
TRILLIUM_OUTPUT1
WHERE 
RECENT_IND = 'Y'
AND REFERENCE_HOUSEHOLD_ID NOT IN (SELECT TRIM(HSHLD_PRSNA_ID)
FROM HSHLD_PRSNA GROUP BY 1)
QUALIFY RANK() OVER(PARTITION BY REFERENCE_HOUSEHOLD_ID
ORDER BY LEGAL_ENT_NBR, MKTNG_PGM_NBR, REGIS_DATE DESC, REFERENCE_REGISTRATIONKEY DESC, REGIS_CNSMR_ID_VAL DESC, SYS_CREATION_DATE DESC, SYS_SOURCE DESC, SYS_NC_TYPE DESC  ) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO MATCHD_CNSMR_PRSNA  
(MATCHD_CNSMR_PRSNA_ID
,LEGAL_ENT_NBR
,HSHLD_PRSNA_ID
,HEAD_OF_HSHLD_IND
,UNIVERSAL_OPT_OUT
,NAME_PREFX_TXT
,GVN_NAME
,MID_NAME
,FAMLY_NAME
,NAME_SUFFX_TXT
,FULL_NAME
,GENDR_IND
,BRTH_DATE
,NOTE_TXT
,LATST_ACTVY_DATE
,PRSNA_STATUS_CODE
,CNSMR_USER_NAME
,LANG_CODE
,REGIS_DATE
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE                                                                  
,SYS_ERR_SVRTY) 
SELECT *
FROM
(SELECT
TOUT.REFERENCE_LEGALENTITYKEY
,TOUT.LEGAL_ENT_NBR
,TOUT.REFERENCE_HOUSEHOLD_ID
,CASE WHEN RANK() OVER (PARTITION BY REFERENCE_HOUSEHOLD_ID ORDER BY REFERENCE_HOUSEHOLD_ID,REFERENCE_LEGALENTITYKEY) = 1
           AND A.HSHLD_PRSNA_ID IS NULL
      THEN 'Y'
      ELSE 'N'
  END AS HEAD_OF_HSHLD_IND
,'' AS UNIVERSAL_OPT_OUT
,TOUT.DR_MRMRS
,TOUT.DR_FIRST_NAME
,TOUT.DR_MIDDLE_NAME
,TOUT.DR_LAST_NAME
,TOUT.DR_NAME_SUFFIX
,STG.FULL_NAME
,STG.GENDR_IND
,TOUT.BRTH_DATE
,'' AS NOTE_TXT
,STG.PRSNA_REG_DT LATST_ACTVY_DATE
,'ACTIVATED' AS PRSNA_STATUS_CODE
,TOUT.CNSMR_USER_NAME
,TOUT.LANG_CODE
,STG.PRSNA_REG_DT
,TOUT.SYS_SOURCE
,TOUT.SYS_TARGET_ID
,TOUT.SYS_AUTH_ID
,TOUT.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,TOUT.SYS_ENT_STATE
,TOUT.SYS_LAST_MODIFIED_BY
,TOUT.SYS_NC_TYPE
,TOUT.SYS_ERR_CODE                                                                  
,TOUT.SYS_ERR_SVRTY
FROM
TRILLIUM_OUTPUT1 TOUT
JOIN
PRSNA_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND 
TOUT.REGIS_DATE = STG.PRSNA_REG_DT
AND
TOUT.SYS_CREATION_DATE = STG.SYS_CREATION_DATE
AND
TOUT.SYS_NC_TYPE = STG.SYS_NC_TYPE
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND RECENT_IND = 'Y'
AND REFERENCE_LEGALENTITYKEY NOT IN (SELECT TRIM(MATCHD_CNSMR_PRSNA_ID)
FROM MATCHD_CNSMR_PRSNA GROUP BY 1)
LEFT OUTER JOIN (SELECT TRIM(HSHLD_PRSNA_ID) AS HSHLD_PRSNA_ID
FROM MATCHD_CNSMR_PRSNA GROUP BY 1) A
ON TOUT.REFERENCE_HOUSEHOLD_ID = A.HSHLD_PRSNA_ID
QUALIFY RANK() OVER(PARTITION BY REFERENCE_LEGALENTITYKEY, REFERENCE_HOUSEHOLD_ID 
ORDER BY LEGAL_ENT_NBR, STG.PRSNA_REG_DT DESC, REFERENCE_HOUSEHOLD_ID DESC, TOUT.SYS_CREATION_DATE DESC, TOUT.SYS_SOURCE DESC,TOUT.SYS_NC_TYPE DESC, TOUT.CNSMR_USER_NAME DESC  ) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO REGIS_PRSNA  
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,MATCHD_CNSMR_PRSNA_ID
,REFERAL_MKTNG_PGM_NBR
,TRM_LEAD_KEY
,NAME_PREFX_TXT
,GVN_NAME
,MID_NAME
,FAMLY_NAME
,NAME_SUFFX_TXT
,FULL_NAME
,GENDR_IND
,BRTH_DATE
,LANG_CODE
,CNTRY_CODE
,EMAIL_SUPRSN_IND
,PHONE_SUPRSN_IND
,POSTL_SUPRSN_IND
,SOCL_NETWK_SUPRSN_IND
,LATST_ACTVY_DATE
,REGIS_CNSMR_ID_VAL
,CNSMR_USER_NAME
,REGIS_DATE
,PRSNA_STATUS_CODE
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE                                                                  
,SYS_ERR_SVRTY) 
SELECT *
FROM
(SELECT
COALESCE(TOUT.REGIS_PRSNA_ID,CAST(TOUT.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.REFERENCE_LEGALENTITYKEY
,'' REFERAL_MKTNG_PGM_NBR
,'' TRM_LEAD_KEY
,TOUT.DR_MRMRS
,TOUT.DR_FIRST_NAME
,TOUT.DR_MIDDLE_NAME
,TOUT.DR_LAST_NAME
,TOUT.DR_NAME_SUFFIX
,STG.FULL_NAME
,STG.GENDR_IND
,TOUT.BRTH_DATE
,TOUT.LANG_CODE
,TOUT.DR_COUNTRY_NAME
,'' EMAIL_SUPRSN_IND
,'' PHONE_SUPRSN_IND
,'' POSTL_SUPRSN_IND
,'' SOCL_NETWK_SUPRSN_IND
,STG.PRSNA_REG_DT LATST_ACTVY_DATE
,TOUT.REGIS_CNSMR_ID_VAL
,TOUT.CNSMR_USER_NAME
,STG.PRSNA_REG_DT
,'ACTIVATED' PRSNA_STATUS_CODE
,TOUT.SYS_SOURCE
,TOUT.SYS_TARGET_ID
,TOUT.SYS_AUTH_ID
,TOUT.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,TOUT.SYS_ENT_STATE
,TOUT.SYS_LAST_MODIFIED_BY
,TOUT.SYS_NC_TYPE
,TOUT.SYS_ERR_CODE                                                                  
,TOUT.SYS_ERR_SVRTY
FROM
TRILLIUM_OUTPUT1 TOUT
JOIN
PRSNA_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND 
TOUT.REGIS_DATE = STG.PRSNA_REG_DT
AND
TOUT.SYS_CREATION_DATE = STG.SYS_CREATION_DATE
AND
TOUT.SYS_NC_TYPE = STG.SYS_NC_TYPE
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND REFERENCE_REGISTRATIONKEY1 NOT IN (SELECT REGIS_PRSNA_ID
FROM REGIS_PRSNA
GROUP BY 1)
AND RECENT_IND = 'Y'
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO MATCHD_CNSMR_POSTL_ADDR
(MATCHD_CNSMR_PRSNA_ID
,LEGAL_ENT_NBR
,CNTCT_POINT_CATEG_CODE
,VALID_CNTCT_POINT_IND
,PREF_CNTCT_POINT_IND
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,LAT_MEAS
,LONG_MEAS
,TERR_CODE
,CNTRY_CODE
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE
,SYS_ERR_SVRTY)
SELECT *
FROM
(SELECT 
TOUT.REFERENCE_LEGALENTITYKEY
,TOUT.LEGAL_ENT_NBR
,STG.CNTCT_POINT_CATEG_CODE
,CASE WHEN TOUT.PR_REV_GROUP > 0
THEN 'N'
ELSE 'Y'
END VALID_CNTCT_POINT_IND
,STG.PREFR_IND
,TOUT.DR_ADDRESS
,TOUT.DR_ADDRESS2
,TOUT.DR_ADDRESS3
,TOUT.DR_HOUSE_NUMBER1
,TOUT.DR_STREET_NAME
,TOUT.DR_HOUSE_NUMBER2
,TOUT.DR_POBOX_NUMBER
,TOUT.DR_CITY_NAME
,TOUT.DR_POSTAL_CODE
,'' LAT_MEAS
,'' LONG_MEAS
,CASE WHEN TR.TERR_RECODE IS NOT NULL
            THEN TR.TERR_RECODE
            ELSE TOUT.DR_REGION_NAME
  END AS DR_REGION_NAME
,CASE WHEN CR.CNTRY_RECODE IS NOT NULL
      THEN CR.CNTRY_RECODE 
      ELSE TOUT.DR_COUNTRY_NAME
  END AS DR_COUNTRY_NAME
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TRILLIUM_OUTPUT1 TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND TOUT.DR_COUNTRY_NAME <> 'IND'
AND RECENT_IND = 'Y'
AND (REFERENCE_LEGALENTITYKEY,CNTCT_POINT_CATEG_CODE) NOT IN (SELECT TRIM(MATCHD_CNSMR_PRSNA_ID),CNTCT_POINT_CATEG_CODE
FROM MATCHD_CNSMR_POSTL_ADDR GROUP BY 1,2)
LEFT OUTER JOIN TERR_RECODE TR
ON TOUT.DR_REGION_NAME = TR.TERR
LEFT OUTER JOIN CNTRY_RECODE CR
ON TOUT.DR_COUNTRY_NAME = CR.CNTRY
QUALIFY RANK() OVER(PARTITION BY REFERENCE_LEGALENTITYKEY,STG.CNTCT_POINT_CATEG_CODE
ORDER BY LEGAL_ENT_NBR, TOUT.REGIS_DATE DESC, REFERENCE_HOUSEHOLD_ID DESC, TOUT.SYS_CREATION_DATE DESC, TOUT.SYS_SOURCE DESC,TOUT.SYS_NC_TYPE DESC  ) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO MATCHD_CNSMR_POSTL_ADDR
(MATCHD_CNSMR_PRSNA_ID
,LEGAL_ENT_NBR
,CNTCT_POINT_CATEG_CODE
,VALID_CNTCT_POINT_IND
,PREF_CNTCT_POINT_IND
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,LAT_MEAS
,LONG_MEAS
,TERR_CODE
,CNTRY_CODE
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE
,SYS_ERR_SVRTY)
SELECT *
FROM
(SELECT 
TOUT.REFERENCE_LEGALENTITYKEY
,TOUT.LEGAL_ENT_NBR
,STG.CNTCT_POINT_CATEG_CODE
,STG.VALID_IND  VALID_CNTCT_POINT_IND
,STG.PREFR_IND
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.STRET_NUM
,STG.STRET_NAME
,STG.APT_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,'' LAT_MEAS
,'' LONG_MEAS
,CASE WHEN TR.TERR_RECODE IS NOT NULL
            THEN TR.TERR_RECODE
            ELSE TOUT.DR_REGION_NAME
  END AS DR_REGION_NAME
,CASE WHEN CR.CNTRY_RECODE IS NOT NULL
      THEN CR.CNTRY_RECODE 
      ELSE TOUT.DR_COUNTRY_NAME
  END AS DR_COUNTRY_NAME
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TRILLIUM_OUTPUT1 TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND TOUT.DR_COUNTRY_NAME = 'IND'
AND RECENT_IND = 'Y'
AND (REFERENCE_LEGALENTITYKEY,CNTCT_POINT_CATEG_CODE) NOT IN (SELECT TRIM(MATCHD_CNSMR_PRSNA_ID),CNTCT_POINT_CATEG_CODE
FROM MATCHD_CNSMR_POSTL_ADDR GROUP BY 1,2)
LEFT OUTER JOIN TERR_RECODE TR
ON TOUT.DR_REGION_NAME = TR.TERR
LEFT OUTER JOIN CNTRY_RECODE CR
ON TOUT.DR_COUNTRY_NAME = CR.CNTRY
QUALIFY RANK() OVER(PARTITION BY REFERENCE_LEGALENTITYKEY,STG.CNTCT_POINT_CATEG_CODE
ORDER BY LEGAL_ENT_NBR, TOUT.REGIS_DATE DESC, REFERENCE_HOUSEHOLD_ID DESC, TOUT.SYS_CREATION_DATE DESC, TOUT.SYS_SOURCE DESC,TOUT.SYS_NC_TYPE DESC  ) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PRSNA_EMAIL_ADDR_STG
FROM
(
SELECT
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
SYS_SOURCE,
EMAIL_IND,
CLEANSED_EMAIL_1
FROM TRILLIUM_OUTPUT1
GROUP BY 1,2,3,4,5
) B

SET VALID_IND = B.EMAIL_IND
WHERE PRSNA_EMAIL_ADDR_STG.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
AND	PRSNA_EMAIL_ADDR_STG.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
AND     PRSNA_EMAIL_ADDR_STG.SYS_SOURCE = B.SYS_SOURCE
AND PRSNA_EMAIL_ADDR_STG.EMAIL_ADDR_TXT = B.CLEANSED_EMAIL_1
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM REGIS_PRSNA_POSTL_ADDR WHERE
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR)
IN
(
SELECT 
COALESCE(TOUT.REGIS_PRSNA_ID,CAST(TOUT.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
FROM
TRILLIUM_OUTPUT1 TOUT
GROUP BY 1,2,3);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM REGIS_PRSNA_PHONE WHERE
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR)
IN
(
SELECT 
COALESCE(TOUT.REGIS_PRSNA_ID,CAST(TOUT.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
FROM
TRILLIUM_OUTPUT1 TOUT
GROUP BY 1,2,3);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM REGIS_PRSNA_EMAIL_ADDR WHERE
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR)
IN
(
SELECT 
COALESCE(TOUT.REGIS_PRSNA_ID,CAST(TOUT.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
FROM
TRILLIUM_OUTPUT1 TOUT
GROUP BY 1,2,3);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM REGIS_PRSNA_SOC_NET_ACCT WHERE
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR)
IN
(
SELECT 
COALESCE(TOUT.REGIS_PRSNA_ID,CAST(TOUT.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
FROM
TRILLIUM_OUTPUT1 TOUT
GROUP BY 1,2,3);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO REGIS_PRSNA_POSTL_ADDR
(
 CNTCT_POINT_CATEG_CODE
,REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,WIN_KEY
,SUBSCRPTN_OPT_NBR
,SUBSCRPTN_OPT_IND
,CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,TERR_CODE
,CNTRY_CODE
,LAT_MEAS
,LONG_MEAS
,VALID_CNTCT_POINT_IND
,GUARDN_NAME
,GUARDN_EMAIL_ADDR_TXT
,GUARDN_CNSNT_IND
,ACNLGMT_DATE
,PR_REV_GROUP
,PR_GEOCODE_FAIL
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE 
,SYS_ERR_SVRTY)
SELECT *
FROM
(SELECT
STG.CNTCT_POINT_CATEG_CODE
,COALESCE(TOUT.REGIS_PRSNA_ID,CAST(TOUT.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.WINDOW_KEY_01
,STG.CNTCT_OPTN_NBR
,STG.CNTCT_OPTN_IND
,STG.CNSMR_CHCE_DATETM
,STG.PREFR_IND
,TOUT.DR_ADDRESS
,TOUT.DR_ADDRESS2
,TOUT.DR_ADDRESS3
,TOUT.DR_HOUSE_NUMBER1
,TOUT.DR_STREET_NAME
,TOUT.DR_HOUSE_NUMBER2
,TOUT.DR_POBOX_NUMBER
,TOUT.DR_CITY_NAME
,TOUT.DR_POSTAL_CODE
,CASE WHEN TR.TERR_RECODE IS NOT NULL
            THEN TR.TERR_RECODE
            ELSE TOUT.DR_REGION_NAME
  END AS DR_REGION_NAME
,CASE WHEN CR.CNTRY_RECODE IS NOT NULL
      THEN CR.CNTRY_RECODE 
      ELSE TOUT.DR_COUNTRY_NAME
  END AS DR_COUNTRY_NAME
,'' LAT_MEAS
,'' LONG_MEAS
,CASE WHEN TOUT.PR_REV_GROUP > 0
THEN 'N'
ELSE 'Y'
END VALID_CNTCT_POINT_IND
,STG.GUARDN_NAME
,STG.GUARDN_EMAIL_ADDR_TXT
,STG.GUARDN_CNSNT_IND
,STG.ACNLGMT_DATE
,TRIM(TOUT.PR_REV_GROUP) PR_REV_GROUP
,TOUT.GOUT_MATCH_LEVEL
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TRILLIUM_OUTPUT1 TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND TOUT.ADDRESS_CONTACT = STG.CNTCT_POINT_CATEG_CODE
AND TOUT.ADDRESS_SUBSCRPTN = STG.CNTCT_OPTN_NBR
AND TOUT.DR_COUNTRY_NAME <> 'IND'
AND RECENT_IND = 'Y'
LEFT OUTER JOIN TERR_RECODE TR
ON TOUT.DR_REGION_NAME = TR.TERR
LEFT OUTER JOIN CNTRY_RECODE CR
ON TOUT.DR_COUNTRY_NAME = CR.CNTRY
QUALIFY RANK() OVER (PARTITION BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR,REFERENCE_REGISTRATIONKEY1,STG.CNTCT_OPTN_NBR
ORDER BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR   
,TOUT.REGIS_CNSMR_ID_VAL
,STG.SYS_CREATION_DATE DESC
,STG.SYS_SOURCE DESC
,STG.SYS_NC_TYPE DESC
,TOUT.DR_ADDRESS DESC
,STG.CNTCT_POINT_CATEG_CODE DESC
,TOUT.WINDOW_KEY_01 DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36,37,38,39,40;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO REGIS_PRSNA_POSTL_ADDR
(
 CNTCT_POINT_CATEG_CODE
,REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,WIN_KEY
,SUBSCRPTN_OPT_NBR
,SUBSCRPTN_OPT_IND
,CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,TERR_CODE
,CNTRY_CODE
,LAT_MEAS
,LONG_MEAS
,VALID_CNTCT_POINT_IND
,GUARDN_NAME
,GUARDN_EMAIL_ADDR_TXT
,GUARDN_CNSNT_IND
,ACNLGMT_DATE
,PR_REV_GROUP
,PR_GEOCODE_FAIL
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE 
,SYS_ERR_SVRTY)
SELECT *
FROM
(SELECT
STG.CNTCT_POINT_CATEG_CODE
,COALESCE(TOUT.REGIS_PRSNA_ID,CAST(TOUT.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.WINDOW_KEY_01
,STG.CNTCT_OPTN_NBR
,STG.CNTCT_OPTN_IND
,STG.CNSMR_CHCE_DATETM
,STG.PREFR_IND
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.STRET_NUM
,STG.STRET_NAME
,STG.APT_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,CASE WHEN TR.TERR_RECODE IS NOT NULL
            THEN TR.TERR_RECODE
            ELSE TOUT.DR_REGION_NAME
  END AS DR_REGION_NAME
,CASE WHEN CR.CNTRY_RECODE IS NOT NULL
      THEN CR.CNTRY_RECODE 
      ELSE TOUT.DR_COUNTRY_NAME
  END AS DR_COUNTRY_NAME
,'' LAT_MEAS
,'' LONG_MEAS
,STG.VALID_IND  VALID_CNTCT_POINT_IND
,STG.GUARDN_NAME
,STG.GUARDN_EMAIL_ADDR_TXT
,STG.GUARDN_CNSNT_IND
,STG.ACNLGMT_DATE
,TRIM(TOUT.PR_REV_GROUP) PR_REV_GROUP
,TOUT.GOUT_MATCH_LEVEL
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TRILLIUM_OUTPUT1 TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND TOUT.ADDRESS_CONTACT = STG.CNTCT_POINT_CATEG_CODE
AND TOUT.ADDRESS_SUBSCRPTN = STG.CNTCT_OPTN_NBR
AND TOUT.DR_COUNTRY_NAME = 'IND'
AND RECENT_IND = 'Y'
LEFT OUTER JOIN TERR_RECODE TR
ON TOUT.DR_REGION_NAME = TR.TERR
LEFT OUTER JOIN CNTRY_RECODE CR
ON TOUT.DR_COUNTRY_NAME = CR.CNTRY
QUALIFY RANK() OVER (PARTITION BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR,REFERENCE_REGISTRATIONKEY1,STG.CNTCT_OPTN_NBR
ORDER BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR   
,TOUT.REGIS_CNSMR_ID_VAL
,STG.SYS_CREATION_DATE DESC
,STG.SYS_SOURCE DESC
,STG.SYS_NC_TYPE DESC
,TOUT.DR_ADDRESS DESC
,STG.CNTCT_POINT_CATEG_CODE DESC
,TOUT.WINDOW_KEY_01 DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36,37,38,39,40;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS REGIS_PRSNA_PHONE 
(
CNTCT_POINT_CATEG_CODE        ,
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
SUBSCRPTN_OPT_NBR             ,
SUBSCRPTN_OPT_IND             ,
CNSMR_CHCE_DATETM             ,
PREF_CNTCT_POINT_IND          ,
PHONE_CNTRY_NBR               ,
PHONE_AREA_NBR                ,
PHONE_EXCHG_NBR               ,
PHONE_LINE_NBR                ,
PHONE_EXTSN_NUM               ,
FULL_PHONE_NUM                ,
SMS_PREFR_IND                 ,
SMS_AVAIL_START_TIME          ,
SMS_AVAIL_END_TIME            ,
VALID_CNTCT_POINT_IND         ,
GUARDN_NAME                   ,
GUARDN_EMAIL_ADDR_TXT         ,
GUARDN_CNSNT_IND              ,
ACNLGMT_DATE                  ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM
(SELECT
A.CNTCT_POINT_CATEG_CODE        ,
--B.REFERENCE_REGISTRATIONKEY                ,
COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.CNTCT_OPTN_NBR             ,
A.CNTCT_OPTN_IND             ,
CAST(A.CNSMR_CHCE_DATETM   AS TIMESTAMP(6))     CNSMR_CHCE_DATETM    ,
A.PREFR_IND          ,
A.PHONE_CNTRY_NBR               ,
A.PHONE_AREA_NBR                ,
A.PHONE_EXCHG_NBR               ,
A.PHONE_LINE_NBR                ,
A.PHONE_EXTSN_NUM               ,
A.FULL_PHONE_NUM                ,
A.SMS_PREFR_IND                 ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_START_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)     SMS_AVAIL_START_TIME     ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_END_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)      SMS_AVAIL_END_TIME    ,
A.VALID_IND         ,
A.GUARDN_NAME                   ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.GUARDN_CNSNT_IND              ,
A.ACNLGMT_DATE                  ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_PHONE_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE,A.CNTCT_OPTN_NBR     
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS REGIS_PRSNA_EMAIL_ADDR 
(
CNTCT_POINT_CATEG_CODE        ,
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
SUBSCRPTN_OPT_NBR             ,
SUBSCRPTN_OPT_IND             ,
CNSMR_CHCE_DATETM             ,
PREF_CNTCT_POINT_IND          ,
EMAIL_ADDR_TXT                ,
EMAIL_FORMT_CODE              ,
VALID_CNTCT_POINT_IND         ,
GUARDN_NAME                   ,
GUARDN_EMAIL_ADDR_TXT         ,
GUARDN_CNSNT_IND              ,
ACNLGMT_DATE                  ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM
(SELECT 
A.CNTCT_POINT_CATEG_CODE        ,
--B.REFERENCE_REGISTRATIONKEY                ,
COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.CNTCT_OPTN_NBR             ,
A.CNTCT_OPTN_IND             ,
CAST(A.CNSMR_CHCE_DATETM   AS TIMESTAMP(6))  CNSMR_CHCE_DATETM       ,
A.PREFR_IND          ,
A.EMAIL_ADDR_TXT                ,
A.EMAIL_FORMT_CODE              ,
A.VALID_IND         ,
A.GUARDN_NAME                   ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.GUARDN_CNSNT_IND              ,
A.ACNLGMT_DATE                  ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_EMAIL_ADDR_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE,A.CNTCT_OPTN_NBR  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS REGIS_PRSNA_SOC_NET_ACCT 
(
CNTCT_POINT_CATEG_CODE        ,
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
SUBSCRPTN_OPT_NBR             ,
SUBSCRPTN_OPT_IND             ,
CNSMR_CHCE_DATETM             ,
PREF_CNTCT_POINT_IND          ,
SOCIAL_NETWK_ACCT_ID_VAL      ,
VALID_CNTCT_POINT_IND         ,
GUARDN_NAME                   ,
GUARDN_EMAIL_ADDR_TXT         ,
GUARDN_CNSNT_IND              ,
ACNLGMT_DATE                  ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM 
(SELECT
A.CNTCT_POINT_CATEG_CODE        ,
--B.REFERENCE_REGISTRATIONKEY                ,
COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.CNTCT_OPTN_NBR             ,
A.CNTCT_OPTN_IND             ,
CAST(A.CNSMR_CHCE_DATETM   AS TIMESTAMP(6))  CNSMR_CHCE_DATETM       ,
A.PREFR_IND          ,
A.SOCIAL_NETWK_ACCT_ID_VAL      ,
A.VALID_IND         ,
A.GUARDN_NAME                   ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.GUARDN_CNSNT_IND              ,
A.ACNLGMT_DATE                  ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_SOC_NETWK_ACCT_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE,A.CNTCT_OPTN_NBR  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DEL FROM PRSNA_TRT_WORK ALL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PRSNA_TRT_WORK 
(
      REGIS_PRSNA_ID ,
      PRSNA_TRT_SEQ_NBR ,
      TRT_NBR ,
      PRSNA_TRT_DATE ,
      PRSNA_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT
      REGIS_PRSNA_ID ,
      PRSNA_TRT_SEQ_NBR ,
      TRT_NBR ,
      PRSNA_TRT_DATE ,
      PRSNA_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
FROM
PRSNA_TRT
WHERE (MKTNG_PGM_NBR,LEGAL_ENT_NBR,REGIS_PRSNA_ID) IN
(SELECT MKTNG_PGM_NBR,LEGAL_ENT_NBR,COALESCE(REGIS_PRSNA_ID,CAST(REFERENCE_REGISTRATIONKEY AS INTEGER))
FROM
TRILLIUM_OUTPUT1
GROUP BY 1,2,3
)
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

COLLECT STATS PRSNA_TRT_WORK
COLUMN (LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,TRT_NBR,PRSNA_TRT_SEQ_NBR);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;  

INS PRSNA_TRT 
(
      REGIS_PRSNA_ID ,
      PRSNA_TRT_SEQ_NBR ,
      TRT_NBR ,
      PRSNA_TRT_DATE ,
      PRSNA_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1,
      A.PRSNA_TRT_SEQ_NBR,
      A.TRT_NBR,
      A.PRSNA_TRT_DATE,
     CASE WHEN A.PRSNA_TRT_TXT= '' OR A.PRSNA_TRT_TXT IS NULL
     THEN A.PRSNA_TRT_INTEGER
     ELSE A.PRSNA_TRT_TXT
     END PRSNA_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PRSNA_TRT_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REFERENCE_REGISTRATIONKEY1,A.TRT_NBR,A.PRSNA_TRT_SEQ_NBR) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,TRT_NBR,PRSNA_TRT_SEQ_NBR
FROM PRSNA_TRT_WORK
GROUP BY 1,2,3,4,5
)
AND RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.TRT_NBR,A.PRSNA_TRT_SEQ_NBR  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.PRSNA_TRT_TXT DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PET
(
      REGIS_PRSNA_ID ,
      PET_NAME ,
      PET_GENDR_IND ,
      PET_BRTH_DATE ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      PET_SEQ_NBR,
      PET_AGE_NBR,
--      DECEASED_IND,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1,
      A.PET_NAME,
      A.PET_GENDR_IND,
      A.PET_BRTH_DATE,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.PET_SEQ_NBR,
      A.PET_AGE_NBR,
--      A.DECEASED_IND,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PET_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REFERENCE_REGISTRATIONKEY1,A.PET_NAME) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,PET_NAME
FROM PET
GROUP BY 1,2,3,4
)
AND RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.PET_NAME
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.PET_NAME DESC
,B.PET_NAME DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PET_TRT 
(
      REGIS_PRSNA_ID ,
      PET_TRT_SEQ_NBR ,
      TRT_NBR ,
      PET_TRT_DATE ,
      PET_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      PET_SEQ_NBR,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM
(SELECT 
      --B.REFERENCE_REGISTRATIONKEY,
      COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1,
      A.PET_TRT_SEQ_NBR,
      A.TRT_ID,
      A.PET_TRT_DATE,
      A.PET_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.PET_SEQ_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PET_TRT_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REFERENCE_REGISTRATIONKEY1,A.PET_SEQ_NBR,A.PET_TRT_SEQ_NBR,A.TRT_ID) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,PET_SEQ_NBR,PET_TRT_SEQ_NBR,TRT_NBR
FROM PET_TRT
GROUP BY 1,2,3,4,5,6
)
AND RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.PET_SEQ_NBR,A.PET_TRT_SEQ_NBR,A.TRT_ID  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS DPEND
(
      REGIS_PRSNA_ID ,
      DPEND_TYPE_CODE ,
      DPEND_NAME ,
      DPEND_GENDR_IND ,
      DPEND_BRTH_DATE ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      DPEND_SEQ_NBR,
      DPEND_AGE_NBR,
--      DECEASED_IND,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM 
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1,
      A.DPEND_TYPE_CODE,
      A.DPEND_NAME,
      A.DPEND_GENDR_IND,
      A.DPEND_BRTH_DATE,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.DPEND_SEQ_NBR,
      A.DPEND_AGE_NBR,
--      A.DECEASED_IND,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM DPEND_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REFERENCE_REGISTRATIONKEY1,A.DPEND_NAME) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,DPEND_NAME
FROM DPEND
GROUP BY 1,2,3,4
)
AND RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.DPEND_NAME  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.DPEND_NAME DESC
,B.DPEND_NAME DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS DPEND_TRT 
(
      REGIS_PRSNA_ID ,
      DPEND_TRT_SEQ_NBR ,
      TRT_NBR ,
      DPEND_TRT_DATE ,
      DPEND_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      DPEND_SEQ_NBR,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1,
      A.DPEND_TRT_SEQ_NBR,
      A.TRT_NBR,
      A.DPEND_TRT_DATE,
      A.DPEND_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.DPEND_SEQ_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM DPEND_TRT_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REFERENCE_REGISTRATIONKEY1,A.DPEND_TRT_SEQ_NBR,A.TRT_NBR,A.DPEND_SEQ_NBR) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,DPEND_TRT_SEQ_NBR,TRT_NBR,DPEND_SEQ_NBR
FROM DPEND_TRT
GROUP BY 1,2,3,4,5,6
)
AND RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.DPEND_TRT_SEQ_NBR,A.TRT_NBR,A.DPEND_SEQ_NBR  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PRSNA_TRT 
FROM 
(SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY,
      A.PRSNA_TRT_SEQ_NBR,
      A.TRT_NBR,
      A.PRSNA_TRT_DATE,
      CASE WHEN A.PRSNA_TRT_TXT= '' OR A.PRSNA_TRT_TXT IS NULL
     THEN A.PRSNA_TRT_INTEGER
     ELSE A.PRSNA_TRT_TXT
     END PRSNA_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PRSNA_TRT_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE B.RECORD_IND IN ('Y')
AND RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REFERENCE_REGISTRATIONKEY,A.PRSNA_TRT_SEQ_NBR,A.TRT_NBR
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.PRSNA_TRT_TXT DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18
) B
SET   PRSNA_TRT_DATE=B.PRSNA_TRT_DATE ,
PRSNA_TRT_TXT=B.PRSNA_TRT_TXT ,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE PRSNA_TRT.REGIS_PRSNA_ID = B.REFERENCE_REGISTRATIONKEY
AND PRSNA_TRT.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PRSNA_TRT.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PRSNA_TRT.PRSNA_TRT_SEQ_NBR = B.PRSNA_TRT_SEQ_NBR
AND PRSNA_TRT.TRT_NBR = B.TRT_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PET
FROM
(SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY,
      A.PET_NAME,
      A.PET_GENDR_IND,
      A.PET_BRTH_DATE,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.PET_SEQ_NBR,
      A.PET_AGE_NBR,
--      A.DECEASED_IND,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PET_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE B.RECORD_IND IN ('Y')
AND RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REFERENCE_REGISTRATIONKEY,A.PET_NAME  
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
) B
SET   PET_SEQ_NBR=B.PET_SEQ_NBR ,
PET_GENDR_IND=B.PET_GENDR_IND ,
PET_BRTH_DATE=B.PET_BRTH_DATE ,
PET_AGE_NBR=B.PET_AGE_NBR,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE PET.REGIS_PRSNA_ID = B.REFERENCE_REGISTRATIONKEY
AND PET.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PET.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PET.PET_NAME = B.PET_NAME
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PET_TRT 
FROM
(
SELECT *
FROM
(SELECT 
      --B.REFERENCE_REGISTRATIONKEY,
      COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY,
      A.PET_TRT_SEQ_NBR,
      A.TRT_ID,
      A.PET_TRT_DATE,
      A.PET_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.PET_SEQ_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PET_TRT_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE B.RECORD_IND IN ('Y')
AND RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REFERENCE_REGISTRATIONKEY,A.PET_TRT_SEQ_NBR,A.TRT_ID,A.PET_SEQ_NBR  
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
) B
SET   PET_TRT_DATE=B.PET_TRT_DATE ,
PET_TRT_TXT=B.PET_TRT_TXT ,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE PET_TRT.REGIS_PRSNA_ID = B.REFERENCE_REGISTRATIONKEY
AND PET_TRT.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PET_TRT.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PET_TRT.PET_SEQ_NBR = B.PET_SEQ_NBR
AND PET_TRT.PET_TRT_SEQ_NBR = B.PET_TRT_SEQ_NBR
AND PET_TRT.TRT_NBR = B.TRT_ID
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE DPEND
FROM
(
SELECT *
FROM 
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY,
      A.DPEND_TYPE_CODE,
      A.DPEND_NAME,
      A.DPEND_GENDR_IND,
      A.DPEND_BRTH_DATE,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.DPEND_SEQ_NBR,
      A.DPEND_AGE_NBR,
--      A.DECEASED_IND,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM DPEND_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE B.RECORD_IND IN ('Y')
AND RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REFERENCE_REGISTRATIONKEY,A.DPEND_NAME
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
) B
SET   DPEND_TYPE_CODE=B.DPEND_TYPE_CODE ,
DPEND_NAME = B.DPEND_NAME ,
DPEND_GENDR_IND=B.DPEND_GENDR_IND ,
DPEND_BRTH_DATE=B.DPEND_BRTH_DATE ,
DPEND_AGE_NBR=B.DPEND_AGE_NBR,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE DPEND.REGIS_PRSNA_ID = B.REFERENCE_REGISTRATIONKEY
AND DPEND.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND DPEND.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND DPEND.DPEND_SEQ_NBR=B.DPEND_SEQ_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE DPEND_TRT 
FROM
(
SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY,
      A.DPEND_TRT_SEQ_NBR,
      A.TRT_NBR,
      A.DPEND_TRT_DATE,
      A.DPEND_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.DPEND_SEQ_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM DPEND_TRT_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE B.RECORD_IND IN ('Y')
AND RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REFERENCE_REGISTRATIONKEY,A.DPEND_TRT_SEQ_NBR,A.TRT_NBR,A.DPEND_SEQ_NBR  
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
) B
SET   DPEND_TRT_DATE=B.DPEND_TRT_DATE ,
DPEND_TRT_TXT=B.DPEND_TRT_TXT ,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE DPEND_TRT.REGIS_PRSNA_ID = B.REFERENCE_REGISTRATIONKEY
AND DPEND_TRT.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND DPEND_TRT.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND DPEND_TRT.DPEND_SEQ_NBR = B.DPEND_SEQ_NBR
AND DPEND_TRT.DPEND_TRT_SEQ_NBR = B.DPEND_TRT_SEQ_NBR
AND DPEND_TRT.TRT_NBR = B.TRT_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE CNSMR_AFFLTN 
FROM
(
SELECT DISTINCT
A.CNSMR_GRP_NBR                         ,
COALESCE(B.REGIS_PRSNA_ID,CAST(B.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.AFFLTN_START_DATE             ,
A.AFFLTN_END_DATE             ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM CNSMR_AFFLTN_STG A
INNER JOIN TRILLIUM_OUTPUT1 B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
WHERE 
RECENT_IND = 'Y'
AND B.RECORD_IND='Y'	
QUALIFY RANK() OVER(PARTITION BY REFERENCE_REGISTRATIONKEY1,A.CNSMR_GRP_NBR
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC  ) = 1
) B
SET   AFFLTN_START_DATE=B.AFFLTN_START_DATE             ,
AFFLTN_END_DATE=B.AFFLTN_END_DATE               ,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE CNSMR_AFFLTN.REGIS_PRSNA_ID = B.REFERENCE_REGISTRATIONKEY1
AND CNSMR_AFFLTN.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND CNSMR_AFFLTN.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND CNSMR_AFFLTN.CNSMR_GRP_NBR = B.CNSMR_GRP_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE MATCHD_CNSMR_POSTL_ADDR
FROM
(
SELECT *
FROM
(SELECT 
TOUT.REFERENCE_LEGALENTITYKEY
,TOUT.LEGAL_ENT_NBR
,STG.CNTCT_POINT_CATEG_CODE
,CASE WHEN TOUT.PR_REV_GROUP > 0
THEN 'N'
ELSE 'Y'
END VALID_CNTCT_POINT_IND
,STG.PREFR_IND
,TOUT.DR_ADDRESS
,TOUT.DR_ADDRESS2
,TOUT.DR_ADDRESS3
,TOUT.DR_HOUSE_NUMBER1
,TOUT.DR_STREET_NAME
,TOUT.DR_HOUSE_NUMBER2
,TOUT.DR_POBOX_NUMBER
,TOUT.DR_CITY_NAME
,TOUT.DR_POSTAL_CODE
,'' LAT_MEAS
,'' LONG_MEAS
,CASE WHEN TR.TERR_RECODE IS NOT NULL
            THEN TR.TERR_RECODE
            ELSE TOUT.DR_REGION_NAME
  END AS DR_REGION_NAME
,CASE WHEN CR.CNTRY_RECODE IS NOT NULL
      THEN CR.CNTRY_RECODE 
      ELSE TOUT.DR_COUNTRY_NAME
  END AS DR_COUNTRY_NAME
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TRILLIUM_OUTPUT1 TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND TOUT.DR_COUNTRY_NAME <> 'IND'
AND RECENT_IND = 'Y'
AND TOUT.RECORD_IND='Y'
LEFT OUTER JOIN TERR_RECODE TR
ON TOUT.DR_REGION_NAME = TR.TERR
LEFT OUTER JOIN CNTRY_RECODE CR
ON TOUT.DR_COUNTRY_NAME = CR.CNTRY
QUALIFY RANK() OVER(PARTITION BY REFERENCE_LEGALENTITYKEY,STG.CNTCT_POINT_CATEG_CODE
ORDER BY LEGAL_ENT_NBR, TOUT.REGIS_DATE DESC, REFERENCE_HOUSEHOLD_ID DESC, 
TOUT.SYS_CREATION_DATE DESC, TOUT.SYS_SOURCE DESC,TOUT.SYS_NC_TYPE DESC,
DR_ADDRESS DESC,TOUT.DR_HOUSE_NUMBER1 DESC
,VALID_CNTCT_POINT_IND DESC) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29
) B
SET VALID_CNTCT_POINT_IND=B.VALID_CNTCT_POINT_IND
,PREF_CNTCT_POINT_IND=B.PREFR_IND
,ADDR_LINE_1_TXT=B.DR_ADDRESS
,ADDR_LINE_2_TXT=B.DR_ADDRESS2
,ADDR_LINE_3_TXT=B.DR_ADDRESS3
,STRET_NUM=B.DR_HOUSE_NUMBER1
,STRET_NAME=B.DR_STREET_NAME
,APT_NUM=B.DR_HOUSE_NUMBER2
,PO_BOX_NUM=B.DR_POBOX_NUMBER
,CITY_NAME=B.DR_CITY_NAME
,POSTL_AREA_CODE=B.DR_POSTAL_CODE
,LAT_MEAS=B.LAT_MEAS
,LONG_MEAS=B.LONG_MEAS
,TERR_CODE=B.DR_REGION_NAME
,CNTRY_CODE=B.DR_COUNTRY_NAME,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE MATCHD_CNSMR_POSTL_ADDR.MATCHD_CNSMR_PRSNA_ID = B.REFERENCE_LEGALENTITYKEY
AND MATCHD_CNSMR_POSTL_ADDR.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND MATCHD_CNSMR_POSTL_ADDR.CNTCT_POINT_CATEG_CODE=B.CNTCT_POINT_CATEG_CODE;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE MATCHD_CNSMR_POSTL_ADDR
FROM
(
SELECT *
FROM
(SELECT 
TOUT.REFERENCE_LEGALENTITYKEY
,TOUT.LEGAL_ENT_NBR
,STG.CNTCT_POINT_CATEG_CODE
,STG.VALID_IND VALID_CNTCT_POINT_IND
,STG.PREFR_IND
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.APT_NUM
,STG.STRET_NAME
,STG.STRET_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,'' LAT_MEAS
,'' LONG_MEAS
,CASE WHEN TR.TERR_RECODE IS NOT NULL
            THEN TR.TERR_RECODE
            ELSE TOUT.DR_REGION_NAME
  END AS DR_REGION_NAME
,CASE WHEN CR.CNTRY_RECODE IS NOT NULL
      THEN CR.CNTRY_RECODE 
      ELSE TOUT.DR_COUNTRY_NAME
  END AS DR_COUNTRY_NAME
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TRILLIUM_OUTPUT1 TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND TOUT.DR_COUNTRY_NAME = 'IND'
AND RECENT_IND = 'Y'
AND TOUT.RECORD_IND='Y'
LEFT OUTER JOIN TERR_RECODE TR
ON TOUT.DR_REGION_NAME = TR.TERR
LEFT OUTER JOIN CNTRY_RECODE CR
ON TOUT.DR_COUNTRY_NAME = CR.CNTRY
QUALIFY RANK() OVER(PARTITION BY REFERENCE_LEGALENTITYKEY,STG.CNTCT_POINT_CATEG_CODE
ORDER BY LEGAL_ENT_NBR, TOUT.REGIS_DATE DESC, REFERENCE_HOUSEHOLD_ID DESC,
TOUT.SYS_CREATION_DATE DESC, TOUT.SYS_SOURCE DESC,TOUT.SYS_NC_TYPE DESC,
DR_ADDRESS DESC,TOUT.DR_HOUSE_NUMBER1 DESC 
,VALID_CNTCT_POINT_IND DESC) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29
) B
SET VALID_CNTCT_POINT_IND=B.VALID_CNTCT_POINT_IND
,PREF_CNTCT_POINT_IND=B.PREFR_IND
,ADDR_LINE_1_TXT=B.ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT=B.ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT=B.ADDR_LINE_3_TXT
,STRET_NUM=B.STRET_NUM
,STRET_NAME=B.STRET_NAME
,APT_NUM=B.APT_NUM
,PO_BOX_NUM=B.PO_BOX_NUM
,CITY_NAME=B.CITY_NAME
,POSTL_AREA_CODE=B.POSTL_AREA_CODE
,LAT_MEAS=B.LAT_MEAS
,LONG_MEAS=B.LONG_MEAS
,TERR_CODE=B.DR_REGION_NAME
,CNTRY_CODE=B.DR_COUNTRY_NAME,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE MATCHD_CNSMR_POSTL_ADDR.MATCHD_CNSMR_PRSNA_ID = B.REFERENCE_LEGALENTITYKEY
AND MATCHD_CNSMR_POSTL_ADDR.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND MATCHD_CNSMR_POSTL_ADDR.CNTCT_POINT_CATEG_CODE=B.CNTCT_POINT_CATEG_CODE;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE MATCHD_CNSMR_PRSNA  
FROM
(SELECT *
FROM
(SELECT
TRIM(TOUT.REFERENCE_LEGALENTITYKEY) REFERENCE_LEGALENTITYKEY
,TOUT.LEGAL_ENT_NBR
,TRIM(TOUT.REFERENCE_HOUSEHOLD_ID) REFERENCE_HOUSEHOLD_ID
,CASE WHEN RANK() OVER (PARTITION BY REFERENCE_HOUSEHOLD_ID ORDER BY REFERENCE_HOUSEHOLD_ID,REFERENCE_LEGALENTITYKEY) = 1
           AND A.HSHLD_PRSNA_ID IS NULL
      THEN 'Y'
      ELSE 'N'
  END AS HEAD_OF_HSHLD_IND
,'' AS UNIVERSAL_OPT_OUT
,TOUT.DR_MRMRS
,TOUT.DR_FIRST_NAME
,TOUT.DR_MIDDLE_NAME
,TOUT.DR_LAST_NAME
,TOUT.DR_NAME_SUFFIX
,STG.FULL_NAME
,STG.GENDR_IND
,TOUT.BRTH_DATE
,'' AS NOTE_TXT
,STG.PRSNA_REG_DT LATST_ACTVY_DATE
,'ACTIVATED' AS PRSNA_STATUS_CODE
,TOUT.CNSMR_USER_NAME
,TOUT.LANG_CODE
,STG.PRSNA_REG_DT
,TOUT.SYS_SOURCE
,TOUT.SYS_TARGET_ID
,TOUT.SYS_AUTH_ID
,TOUT.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,TOUT.SYS_ENT_STATE
,TOUT.SYS_LAST_MODIFIED_BY
,TOUT.SYS_NC_TYPE
,TOUT.SYS_ERR_CODE                                                                  
,TOUT.SYS_ERR_SVRTY
FROM
TRILLIUM_OUTPUT1 TOUT
JOIN
PRSNA_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND 
TOUT.REGIS_DATE = STG.PRSNA_REG_DT
AND
TOUT.SYS_CREATION_DATE = STG.SYS_CREATION_DATE
AND
TOUT.SYS_NC_TYPE = STG.SYS_NC_TYPE
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND RECENT_IND = 'Y'
AND TOUT.RECORD_IND = 'Y'
LEFT OUTER JOIN (SELECT TRIM(HSHLD_PRSNA_ID) AS HSHLD_PRSNA_ID
FROM MATCHD_CNSMR_PRSNA GROUP BY 1) A
ON TOUT.REFERENCE_HOUSEHOLD_ID = A.HSHLD_PRSNA_ID
QUALIFY RANK() OVER(PARTITION BY REFERENCE_LEGALENTITYKEY, REFERENCE_HOUSEHOLD_ID ,LEGAL_ENT_NBR
ORDER BY LEGAL_ENT_NBR, STG.PRSNA_REG_DT DESC, TOUT.REFERENCE_REGISTRATIONKEY DESC,
REFERENCE_HOUSEHOLD_ID DESC, TOUT.SYS_CREATION_DATE DESC, TOUT.SYS_SOURCE DESC, 
TOUT.SYS_NC_TYPE DESC, TOUT.CNSMR_USER_NAME DESC 
,STG.FULL_NAME DESC) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
) B
SET HEAD_OF_HSHLD_IND=B.HEAD_OF_HSHLD_IND
,UNIVERSAL_OPT_OUT=B.UNIVERSAL_OPT_OUT
,NAME_PREFX_TXT=B.DR_MRMRS
,GVN_NAME=B.DR_FIRST_NAME
,MID_NAME=B.DR_MIDDLE_NAME
,FAMLY_NAME=B.DR_LAST_NAME
,NAME_SUFFX_TXT=B.DR_NAME_SUFFIX
,FULL_NAME=B.FULL_NAME
,GENDR_IND=B.GENDR_IND
,BRTH_DATE=B.BRTH_DATE
,NOTE_TXT=B.NOTE_TXT
,LATST_ACTVY_DATE=B.LATST_ACTVY_DATE
,PRSNA_STATUS_CODE=B.PRSNA_STATUS_CODE
,CNSMR_USER_NAME=B.CNSMR_USER_NAME
,LANG_CODE=B.LANG_CODE
,REGIS_DATE=B.PRSNA_REG_DT,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE MATCHD_CNSMR_PRSNA.MATCHD_CNSMR_PRSNA_ID = B.REFERENCE_LEGALENTITYKEY
AND MATCHD_CNSMR_PRSNA.HSHLD_PRSNA_ID = B.REFERENCE_HOUSEHOLD_ID
AND MATCHD_CNSMR_PRSNA.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE REGIS_PRSNA
FROM
( 
SELECT *
FROM
(SELECT
COALESCE(TOUT.REGIS_PRSNA_ID,CAST(TOUT.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.REFERENCE_LEGALENTITYKEY
,'' REFERAL_MKTNG_PGM_NBR
,'' TRM_LEAD_KEY
,TOUT.DR_MRMRS
,TOUT.DR_FIRST_NAME
,TOUT.DR_MIDDLE_NAME
,TOUT.DR_LAST_NAME
,TOUT.DR_NAME_SUFFIX
,STG.FULL_NAME
,STG.GENDR_IND
,TOUT.BRTH_DATE
,TOUT.LANG_CODE
,TOUT.DR_COUNTRY_NAME
,'' EMAIL_SUPRSN_IND
,'' PHONE_SUPRSN_IND
,'' POSTL_SUPRSN_IND
,'' SOCL_NETWK_SUPRSN_IND
,STG.PRSNA_REG_DT LATST_ACTVY_DATE
,TOUT.REGIS_CNSMR_ID_VAL
,TOUT.CNSMR_USER_NAME
,STG.PRSNA_REG_DT
,'ACTIVATED' PRSNA_STATUS_CODE
,TOUT.SYS_SOURCE
,TOUT.SYS_TARGET_ID
,TOUT.SYS_AUTH_ID
,TOUT.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,TOUT.SYS_ENT_STATE
,TOUT.SYS_LAST_MODIFIED_BY
,TOUT.SYS_NC_TYPE
,TOUT.SYS_ERR_CODE                                                                  
,TOUT.SYS_ERR_SVRTY
FROM
TRILLIUM_OUTPUT1 TOUT
JOIN
PRSNA_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND 
TOUT.REGIS_DATE = STG.PRSNA_REG_DT
AND
TOUT.SYS_CREATION_DATE = STG.SYS_CREATION_DATE
AND
TOUT.SYS_NC_TYPE = STG.SYS_NC_TYPE
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND TOUT.RECORD_IND='Y'
AND RECENT_IND = 'Y'
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36
) B
SET MATCHD_CNSMR_PRSNA_ID=B.REFERENCE_LEGALENTITYKEY
,REFERAL_MKTNG_PGM_NBR=B.REFERAL_MKTNG_PGM_NBR
,TRM_LEAD_KEY=B.TRM_LEAD_KEY
,NAME_PREFX_TXT=B.DR_MRMRS
,GVN_NAME=B.DR_FIRST_NAME
,MID_NAME=B.DR_MIDDLE_NAME
,FAMLY_NAME=B.DR_LAST_NAME
,NAME_SUFFX_TXT=B.DR_NAME_SUFFIX
,FULL_NAME=B.FULL_NAME
,GENDR_IND=B.GENDR_IND
,BRTH_DATE=B.BRTH_DATE
,LANG_CODE=B.LANG_CODE
,CNTRY_CODE=B.DR_COUNTRY_NAME
,EMAIL_SUPRSN_IND=B.EMAIL_SUPRSN_IND
,PHONE_SUPRSN_IND=B.PHONE_SUPRSN_IND
,POSTL_SUPRSN_IND=B.POSTL_SUPRSN_IND
,SOCL_NETWK_SUPRSN_IND=B.SOCL_NETWK_SUPRSN_IND
,LATST_ACTVY_DATE=B.LATST_ACTVY_DATE
,REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
,CNSMR_USER_NAME=B.CNSMR_USER_NAME
,PRSNA_STATUS_CODE=B.PRSNA_STATUS_CODE,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE REGIS_PRSNA.REGIS_PRSNA_ID = B.REFERENCE_REGISTRATIONKEY1
AND REGIS_PRSNA.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND REGIS_PRSNA.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND REGIS_PRSNA.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS TRILLIUM_OUTPUT2
SEL * FROM TRILLIUM_OUTPUT1;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
/* LOAD MISSING RECORDS */
DELETE FROM TSS_ERR_PRCS ALL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO TSS_ERR_PRCS
(
LEGAL_ENT_NBR,
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
SYS_SOURCE,
REGIS_PRSNA_ID,
HSHLD_PRSNA_ID,
MATCHD_CNSMR_PRSNA_ID
)
SELECT
A.LEGAL_ENT_NBR,
A.MKTNG_PGM_NBR,
A.REGIS_CNSMR_ID_VAL,
TRIM(A.SYS_SOURCE),
B.REGIS_PRSNA_ID,
C.HSHLD_PRSNA_ID,
B.MATCHD_CNSMR_PRSNA_ID
FROM
(SELECT 
LEGAL_ENT_NBR,
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
SYS_SOURCE,
SYS_NC_TYPE
FROM
CNSMR_TSS_CLEANSE_INPUT1
GROUP BY 1,2,3,4,5
MINUS
SELECT 
LEGAL_ENT_NBR,
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
SYS_SOURCE,
SYS_NC_TYPE
FROM
TRILLIUM_OUTPUT1
GROUP BY 1,2,3,4,5
) A
LEFT OUTER JOIN REGIS_PRSNA B
ON A.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND A.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND A.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
AND B.PRSNA_STATUS_CODE = 'AC'
LEFT OUTER JOIN MATCHD_CNSMR_PRSNA C
ON B.MATCHD_CNSMR_PRSNA_ID = C.MATCHD_CNSMR_PRSNA_ID
AND C.PRSNA_STATUS_CODE = 'AC'
GROUP BY 1,2,3,4,5,6,7;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

COLLECT STATS TSS_ERR_PRCS
COLUMN (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

SELECT DISTINCT 
1
FROM 
TSS_ERR_PRCS
;

.IF ACTIVITYCOUNT = 0 THEN .GOTO STATUSUPDATE

DEL FROM TRILLIUM_MDM_REFERENCE ALL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT TRILLIUM_MDM_REFERENCE 
(
 LEGAL_ENT_NBR
,MKTNG_PGM_NBR                 
,REGIS_CNSMR_ID_VAL            
,NEW_HOUSEHOLD_ID              
,NEW_LEGAL_ENTITY_KEY          
,NEW_REGISTRATION_KEY  
,SYS_SOURCE
,REFERENCE_HOUSEHOLD_ID        
,REFERENCE_LEGALENTITYKEY 
,REFERENCE_REGISTRATIONKEY  
)
SELECT
 LEGAL_ENT_NBR
,MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL            
,CASE WHEN A.HSHLD_PRSNA_ID IS NULL
      THEN TRIM(D.HSHLD_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL))
      ELSE A.HSHLD_PRSNA_ID
  END
,CASE WHEN A.MATCHD_CNSMR_PRSNA_ID IS NULL
      THEN TRIM(C.MATCHD_CNSMR_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL))
      ELSE A.MATCHD_CNSMR_PRSNA_ID
  END         
,CASE WHEN A.REGIS_PRSNA_ID IS NULL
      THEN TRIM(B.REGIS_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL))
      ELSE A.REGIS_PRSNA_ID
  END   
,SYS_SOURCE  
,CASE WHEN A.HSHLD_PRSNA_ID IS NULL
      THEN TRIM(D.HSHLD_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL))
      ELSE A.HSHLD_PRSNA_ID
  END
,CASE WHEN A.MATCHD_CNSMR_PRSNA_ID IS NULL
      THEN TRIM(C.MATCHD_CNSMR_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL))
      ELSE A.MATCHD_CNSMR_PRSNA_ID
  END         
,CASE WHEN A.REGIS_PRSNA_ID IS NULL
      THEN TRIM(B.REGIS_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL))
      ELSE A.REGIS_PRSNA_ID
  END
FROM
TSS_ERR_PRCS A
INNER JOIN (SEL COALESCE(MAX(REGIS_PRSNA_ID),0) AS REGIS_PRSNA_ID
FROM REGIS_PRSNA) B
ON 1=1
INNER JOIN (SEL COALESCE(MAX(MATCHD_CNSMR_PRSNA_ID),0) AS MATCHD_CNSMR_PRSNA_ID
FROM MATCHD_CNSMR_PRSNA) C
ON 1=1
INNER JOIN (SEL COALESCE(MAX(HSHLD_PRSNA_ID),0) AS HSHLD_PRSNA_ID
FROM HSHLD_PRSNA) D
ON 1=1
WHERE A.REGIS_PRSNA_ID IS NULL
OR A.MATCHD_CNSMR_PRSNA_ID IS NULL
OR A.HSHLD_PRSNA_ID IS NULL
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

COLLECT STATS ON TRILLIUM_MDM_REFERENCE
COLUMN (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LEGAL_ENT_NBR,SYS_SOURCE);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;


UPDATE TSS_ERR_PRCS
FROM 
(SELECT MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
LEGAL_ENT_NBR,
SYS_SOURCE,
TRIM(MIN(NEW_HOUSEHOLD_ID)) NEW_HOUSEHOLD_ID,
TRIM(MIN(NEW_LEGAL_ENTITY_KEY)) NEW_LEGAL_ENTITY_KEY,
TRIM(MIN(NEW_REGISTRATION_KEY)) NEW_REGISTRATION_KEY
FROM
TRILLIUM_MDM_REFERENCE
GROUP BY 1,2,3,4
) B
SET HSHLD_PRSNA_ID = B.NEW_HOUSEHOLD_ID
,MATCHD_CNSMR_PRSNA_ID = B.NEW_LEGAL_ENTITY_KEY
,REGIS_PRSNA_ID = B.NEW_REGISTRATION_KEY
WHERE TSS_ERR_PRCS.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND TSS_ERR_PRCS.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
AND TSS_ERR_PRCS.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND TSS_ERR_PRCS.SYS_SOURCE = B.SYS_SOURCE
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS CNSMR_AFFLTN 
(
CNSMR_GRP_NBR                         ,
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
AFFLTN_START_DATE             ,
AFFLTN_END_DATE               ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT DISTINCT
A.CNSMR_GRP_NBR                         ,
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.AFFLTN_START_DATE             ,
A.AFFLTN_END_DATE             ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)),
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)),
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM CNSMR_AFFLTN_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE (B.REGIS_PRSNA_ID,A.CNSMR_GRP_NBR) NOT IN
(SEL REGIS_PRSNA_ID,CNSMR_GRP_NBR
FROM CNSMR_AFFLTN
GROUP BY 1,2
)
QUALIFY RANK() OVER(PARTITION BY B.REGIS_PRSNA_ID,A.CNSMR_GRP_NBR
ORDER BY A.SYS_NC_TYPE DESC, A.SYS_SOURCE DESC  ) = 1
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO HSHLD_PRSNA  
(HSHLD_PRSNA_ID
,LEGAL_ENT_NBR
,PRSNA_STATUS_CODE
,SYS_SOURCE
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
) 
SELECT *
FROM
(SELECT
HSHLD_PRSNA_ID
,LEGAL_ENT_NBR
,'ACTIVATED' PRSNA_STATUS_CODE
,SYS_SOURCE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
FROM
TSS_ERR_PRCS
WHERE HSHLD_PRSNA_ID NOT IN (SELECT TRIM(HSHLD_PRSNA_ID)
FROM HSHLD_PRSNA GROUP BY 1)
) A
GROUP BY 1,2,3,4,5,6
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO MATCHD_CNSMR_PRSNA  
(MATCHD_CNSMR_PRSNA_ID
,LEGAL_ENT_NBR
,HSHLD_PRSNA_ID
,HEAD_OF_HSHLD_IND
,UNIVERSAL_OPT_OUT
,NAME_PREFX_TXT
,GVN_NAME
,MID_NAME
,FAMLY_NAME
,NAME_SUFFX_TXT
,FULL_NAME
,GENDR_IND
,BRTH_DATE
,NOTE_TXT
,LATST_ACTVY_DATE
,PRSNA_STATUS_CODE
,CNSMR_USER_NAME
,LANG_CODE
,REGIS_DATE
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE                                                                  
,SYS_ERR_SVRTY) 
SELECT *
FROM
(SELECT
TOUT.MATCHD_CNSMR_PRSNA_ID
,TOUT.LEGAL_ENT_NBR
,TOUT.HSHLD_PRSNA_ID
,CASE WHEN RANK() OVER (PARTITION BY TOUT.HSHLD_PRSNA_ID ORDER BY TOUT.HSHLD_PRSNA_ID,TOUT.MATCHD_CNSMR_PRSNA_ID) = 1
           AND A.HSHLD_PRSNA_ID IS NULL
      THEN 'Y'
      ELSE 'N'
  END AS HEAD_OF_HSHLD_IND
,'' AS UNIVERSAL_OPT_OUT
,STG.NAME_PREFX_TXT
,STG.GVN_NAME
,STG.MID_NAME
,STG.FAMLY_NAME
,STG.NAME_SUFFX_TXT
,STG.FULL_NAME
,STG.GENDR_IND
,STG.BRTH_DATE
,'' AS NOTE_TXT
,STG.PRSNA_REG_DT LATST_ACTVY_DATE
,'ACTIVATED' AS PRSNA_STATUS_CODE
,STG.USER_NAME
,STG.LANG_CODE
,STG.PRSNA_REG_DT
,TOUT.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE                                                                  
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND TOUT.MATCHD_CNSMR_PRSNA_ID NOT IN (SELECT TRIM(MATCHD_CNSMR_PRSNA_ID)
FROM MATCHD_CNSMR_PRSNA GROUP BY 1)
LEFT OUTER JOIN (SELECT TRIM(HSHLD_PRSNA_ID) AS HSHLD_PRSNA_ID
FROM MATCHD_CNSMR_PRSNA GROUP BY 1) A
ON TOUT.HSHLD_PRSNA_ID = A.HSHLD_PRSNA_ID
QUALIFY RANK() OVER(PARTITION BY TOUT.MATCHD_CNSMR_PRSNA_ID, TOUT.HSHLD_PRSNA_ID 
ORDER BY LEGAL_ENT_NBR, STG.PRSNA_REG_DT DESC, TOUT.HSHLD_PRSNA_ID DESC, STG.SYS_CREATION_DATE DESC, STG.SYS_SOURCE DESC,STG.SYS_NC_TYPE DESC, STG.USER_NAME DESC  ) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO REGIS_PRSNA  
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,MATCHD_CNSMR_PRSNA_ID
,REFERAL_MKTNG_PGM_NBR
,TRM_LEAD_KEY
,NAME_PREFX_TXT
,GVN_NAME
,MID_NAME
,FAMLY_NAME
,NAME_SUFFX_TXT
,FULL_NAME
,GENDR_IND
,BRTH_DATE
,LANG_CODE
,CNTRY_CODE
,EMAIL_SUPRSN_IND
,PHONE_SUPRSN_IND
,POSTL_SUPRSN_IND
,SOCL_NETWK_SUPRSN_IND
,LATST_ACTVY_DATE
,REGIS_CNSMR_ID_VAL
,CNSMR_USER_NAME
,REGIS_DATE
,PRSNA_STATUS_CODE
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE                                                                  
,SYS_ERR_SVRTY) 
SELECT *
FROM
(SELECT
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.MATCHD_CNSMR_PRSNA_ID
,'' REFERAL_MKTNG_PGM_NBR
,'' TRM_LEAD_KEY
,STG.NAME_PREFX_TXT
,STG.GVN_NAME
,STG.MID_NAME
,STG.FAMLY_NAME
,STG.NAME_SUFFX_TXT
,STG.FULL_NAME
,STG.GENDR_IND
,STG.BRTH_DATE
,STG.LANG_CODE
,STG.CNTRY_CODE
,'' EMAIL_SUPRSN_IND
,'' PHONE_SUPRSN_IND
,'' POSTL_SUPRSN_IND
,'' SOCL_NETWK_SUPRSN_IND
,STG.PRSNA_REG_DT LATST_ACTVY_DATE
,TOUT.REGIS_CNSMR_ID_VAL
,STG.USER_NAME
,STG.PRSNA_REG_DT
,'ACTIVATED' PRSNA_STATUS_CODE
,TOUT.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE                                                                  
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND REGIS_PRSNA_ID NOT IN (SELECT REGIS_PRSNA_ID
FROM REGIS_PRSNA
GROUP BY 1)
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO MATCHD_CNSMR_POSTL_ADDR
(MATCHD_CNSMR_PRSNA_ID
,LEGAL_ENT_NBR
,CNTCT_POINT_CATEG_CODE
,VALID_CNTCT_POINT_IND
,PREF_CNTCT_POINT_IND
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,LAT_MEAS
,LONG_MEAS
,TERR_CODE
,CNTRY_CODE
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE
,SYS_ERR_SVRTY)
SELECT *
FROM
(SELECT 
TOUT.MATCHD_CNSMR_PRSNA_ID
,TOUT.LEGAL_ENT_NBR
,STG.CNTCT_POINT_CATEG_CODE
,STG.VALID_IND  VALID_CNTCT_POINT_IND
,STG.PREFR_IND
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.STRET_NUM
,STG.STRET_NAME
,STG.APT_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,'' LAT_MEAS
,'' LONG_MEAS
,CASE WHEN TR.TERR_RECODE IS NOT NULL
            THEN TR.TERR_RECODE
            ELSE STG.TERR_NAME
  END AS TERR_NAME
,CASE WHEN CR.CNTRY_RECODE IS NOT NULL
      THEN CR.CNTRY_RECODE 
      ELSE STG.CNTRY_NAME
  END AS CNTRY_NAME
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND (TOUT.MATCHD_CNSMR_PRSNA_ID,CNTCT_POINT_CATEG_CODE) NOT IN (SELECT TRIM(MATCHD_CNSMR_PRSNA_ID),CNTCT_POINT_CATEG_CODE
FROM MATCHD_CNSMR_POSTL_ADDR GROUP BY 1,2)
LEFT OUTER JOIN TERR_RECODE TR
ON STG.TERR_NAME = TR.TERR
LEFT OUTER JOIN CNTRY_RECODE CR
ON STG.CNTRY_NAME = CR.CNTRY
QUALIFY RANK() OVER(PARTITION BY TOUT.MATCHD_CNSMR_PRSNA_ID,STG.CNTCT_POINT_CATEG_CODE
ORDER BY LEGAL_ENT_NBR, TOUT.HSHLD_PRSNA_ID DESC, STG.SYS_CREATION_DATE DESC, STG.SYS_SOURCE DESC,STG.SYS_NC_TYPE DESC  ) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM REGIS_PRSNA_POSTL_ADDR WHERE
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR)
IN
(
SELECT 
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
FROM
TSS_ERR_PRCS TOUT
GROUP BY 1,2,3);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM REGIS_PRSNA_PHONE WHERE
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR)
IN
(
SELECT 
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
FROM
TSS_ERR_PRCS TOUT
GROUP BY 1,2,3);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM REGIS_PRSNA_EMAIL_ADDR WHERE
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR)
IN
(
SELECT 
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
FROM
TSS_ERR_PRCS TOUT
GROUP BY 1,2,3);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM REGIS_PRSNA_SOC_NET_ACCT WHERE
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR)
IN
(
SELECT 
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
FROM
TSS_ERR_PRCS TOUT
GROUP BY 1,2,3);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO REGIS_PRSNA_POSTL_ADDR
(
 CNTCT_POINT_CATEG_CODE
,REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,WIN_KEY
,SUBSCRPTN_OPT_NBR
,SUBSCRPTN_OPT_IND
,CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,TERR_CODE
,CNTRY_CODE
,LAT_MEAS
,LONG_MEAS
,VALID_CNTCT_POINT_IND
,GUARDN_NAME
,GUARDN_EMAIL_ADDR_TXT
,GUARDN_CNSNT_IND
,ACNLGMT_DATE
,PR_REV_GROUP
,PR_GEOCODE_FAIL
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE 
,SYS_ERR_SVRTY)
SELECT *
FROM
(SELECT
STG.CNTCT_POINT_CATEG_CODE
,TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,'' WINDOW_KEY_01
,STG.CNTCT_OPTN_NBR
,STG.CNTCT_OPTN_IND
,STG.CNSMR_CHCE_DATETM
,STG.PREFR_IND
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.STRET_NUM
,STG.STRET_NAME
,STG.APT_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,CASE WHEN TR.TERR_RECODE IS NOT NULL
            THEN TR.TERR_RECODE
            ELSE STG.TERR_NAME
  END AS TERR_NAME
,CASE WHEN CR.CNTRY_RECODE IS NOT NULL
      THEN CR.CNTRY_RECODE 
      ELSE STG.CNTRY_NAME
  END AS CNTRY_NAME
,'' LAT_MEAS
,'' LONG_MEAS
,STG.VALID_IND  VALID_CNTCT_POINT_IND
,STG.GUARDN_NAME
,STG.GUARDN_EMAIL_ADDR_TXT
,STG.GUARDN_CNSNT_IND
,STG.ACNLGMT_DATE
,'' PR_REV_GROUP
,'' PR_REV_GROUP1
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
LEFT OUTER JOIN TERR_RECODE TR
ON STG.TERR_NAME = TR.TERR
LEFT OUTER JOIN CNTRY_RECODE CR
ON STG.CNTRY_NAME = CR.CNTRY
QUALIFY RANK() OVER (PARTITION BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR,TOUT.REGIS_PRSNA_ID,STG.CNTCT_OPTN_NBR
ORDER BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR   
,TOUT.REGIS_CNSMR_ID_VAL
,STG.SYS_CREATION_DATE DESC
,STG.SYS_SOURCE DESC
,STG.SYS_NC_TYPE DESC
,STG.CNTCT_POINT_CATEG_CODE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36,37,38,39,40;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS REGIS_PRSNA_PHONE 
(
CNTCT_POINT_CATEG_CODE        ,
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
SUBSCRPTN_OPT_NBR             ,
SUBSCRPTN_OPT_IND             ,
CNSMR_CHCE_DATETM             ,
PREF_CNTCT_POINT_IND          ,
PHONE_CNTRY_NBR               ,
PHONE_AREA_NBR                ,
PHONE_EXCHG_NBR               ,
PHONE_LINE_NBR                ,
PHONE_EXTSN_NUM               ,
FULL_PHONE_NUM                ,
SMS_PREFR_IND                 ,
SMS_AVAIL_START_TIME          ,
SMS_AVAIL_END_TIME            ,
VALID_CNTCT_POINT_IND         ,
GUARDN_NAME                   ,
GUARDN_EMAIL_ADDR_TXT         ,
GUARDN_CNSNT_IND              ,
ACNLGMT_DATE                  ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM
(SELECT
A.CNTCT_POINT_CATEG_CODE        ,
--B.REFERENCE_REGISTRATIONKEY                ,
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.CNTCT_OPTN_NBR             ,
A.CNTCT_OPTN_IND             ,
CAST(A.CNSMR_CHCE_DATETM   AS TIMESTAMP(6))     CNSMR_CHCE_DATETM    ,
A.PREFR_IND          ,
A.PHONE_CNTRY_NBR               ,
A.PHONE_AREA_NBR                ,
A.PHONE_EXCHG_NBR               ,
A.PHONE_LINE_NBR                ,
A.PHONE_EXTSN_NUM               ,
A.FULL_PHONE_NUM                ,
A.SMS_PREFR_IND                 ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_START_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)     SMS_AVAIL_START_TIME     ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_END_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)      SMS_AVAIL_END_TIME    ,
A.VALID_IND         ,
A.GUARDN_NAME                   ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.GUARDN_CNSNT_IND              ,
A.ACNLGMT_DATE                  ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_PHONE_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE,A.CNTCT_OPTN_NBR     
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS REGIS_PRSNA_EMAIL_ADDR 
(
CNTCT_POINT_CATEG_CODE        ,
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
SUBSCRPTN_OPT_NBR             ,
SUBSCRPTN_OPT_IND             ,
CNSMR_CHCE_DATETM             ,
PREF_CNTCT_POINT_IND          ,
EMAIL_ADDR_TXT                ,
EMAIL_FORMT_CODE              ,
VALID_CNTCT_POINT_IND         ,
GUARDN_NAME                   ,
GUARDN_EMAIL_ADDR_TXT         ,
GUARDN_CNSNT_IND              ,
ACNLGMT_DATE                  ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM
(SELECT 
A.CNTCT_POINT_CATEG_CODE        ,
--B.REFERENCE_REGISTRATIONKEY                ,
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.CNTCT_OPTN_NBR             ,
A.CNTCT_OPTN_IND             ,
CAST(A.CNSMR_CHCE_DATETM   AS TIMESTAMP(6))  CNSMR_CHCE_DATETM       ,
A.PREFR_IND          ,
A.EMAIL_ADDR_TXT                ,
A.EMAIL_FORMT_CODE              ,
A.VALID_IND         ,
A.GUARDN_NAME                   ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.GUARDN_CNSNT_IND              ,
A.ACNLGMT_DATE                  ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_EMAIL_ADDR_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE,A.CNTCT_OPTN_NBR  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS REGIS_PRSNA_SOC_NET_ACCT 
(
CNTCT_POINT_CATEG_CODE        ,
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
SUBSCRPTN_OPT_NBR             ,
SUBSCRPTN_OPT_IND             ,
CNSMR_CHCE_DATETM             ,
PREF_CNTCT_POINT_IND          ,
SOCIAL_NETWK_ACCT_ID_VAL      ,
VALID_CNTCT_POINT_IND         ,
GUARDN_NAME                   ,
GUARDN_EMAIL_ADDR_TXT         ,
GUARDN_CNSNT_IND              ,
ACNLGMT_DATE                  ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM 
(SELECT
A.CNTCT_POINT_CATEG_CODE        ,
--B.REFERENCE_REGISTRATIONKEY                ,
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.CNTCT_OPTN_NBR             ,
A.CNTCT_OPTN_IND             ,
CAST(A.CNSMR_CHCE_DATETM   AS TIMESTAMP(6))  CNSMR_CHCE_DATETM       ,
A.PREFR_IND          ,
A.SOCIAL_NETWK_ACCT_ID_VAL      ,
A.VALID_IND         ,
A.GUARDN_NAME                   ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.GUARDN_CNSNT_IND              ,
A.ACNLGMT_DATE                  ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_SOC_NETWK_ACCT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE,A.CNTCT_OPTN_NBR  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

/*
INSERT INTO PRSNA_POSTL_ADDR_ORIG
(
 REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,REGIS_CNSMR_ID_VAL
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,TERR_CODE
,CNTRY_CODE
,GUARDN_EMAIL_ADDR_TXT
,CNTCT_POINT_CATEG_CODE
,GUARDN_NAME
,GUARDN_CNSNT_IND
,ACNLGMT_DATE
,SUBSCRPTN_OPT_NBR
,SUBSCRPTN_OPT_IND
,CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND
,VALID_CNTCT_POINT_IND
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE 
,SYS_ERR_SVRTY)
SELECT *
FROM
(SELECT
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.REGIS_CNSMR_ID_VAL
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.STRET_NUM
,STG.STRET_NAME
,STG.APT_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,STG.TERR_NAME
,STG.CNTRY_NAME
,STG.GUARDN_EMAIL_ADDR_TXT
,STG.CNTCT_POINT_CATEG_CODE
,STG.GUARDN_NAME
,STG.GUARDN_CNSNT_IND
,STG.ACNLGMT_DATE
,STG.CNTCT_OPTN_NBR
,STG.CNTCT_OPTN_IND
,STG.CNSMR_CHCE_DATETM
,STG.PREFR_IND
,STG.VALID_IND
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND REGIS_PRSNA_ID NOT IN (SELECT REGIS_PRSNA_ID
FROM PRSNA_POSTL_ADDR_ORIG
GROUP BY 1)
QUALIFY RANK() OVER (PARTITION BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR,TOUT.REGIS_CNSMR_ID_VAL,STG.CNTCT_POINT_CATEG_CODE  
ORDER BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR   
,TOUT.REGIS_CNSMR_ID_VAL
,STG.SYS_CREATION_DATE DESC
,STG.SYS_SOURCE DESC
,STG.SYS_NC_TYPE DESC
,STG.CNTCT_OPTN_NBR DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PRSNA_PHONE_ORIG 
(
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
REGIS_CNSMR_ID_VAL            ,
PHONE_CNTRY_NBR               ,
PHONE_AREA_NBR                ,
PHONE_EXCHG_NBR               ,
PHONE_LINE_NBR                ,
PHONE_EXTSN_NUM               ,
FULL_PHONE_NUM                ,
GUARDN_EMAIL_ADDR_TXT         ,
CNTCT_POINT_CATEG_CODE,
GUARDN_NAME,
GUARDN_CNSNT_IND,
ACNLGMT_DATE,
SUBSCRPTN_OPT_NBR,
SUBSCRPTN_OPT_IND,
CNSMR_CHCE_DATETM,
PREF_CNTCT_POINT_IND,
VALID_CNTCT_POINT_IND,
SMS_PREFR_IND                 ,
SMS_AVAIL_START_TIME          ,
SMS_AVAIL_END_TIME            ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM
(SELECT
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.PHONE_CNTRY_NBR               ,
A.PHONE_AREA_NBR                ,
A.PHONE_EXCHG_NBR               ,
A.PHONE_LINE_NBR                ,
A.PHONE_EXTSN_NUM               ,
A.FULL_PHONE_NUM              ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
A.GUARDN_NAME,
A.GUARDN_CNSNT_IND,
A.ACNLGMT_DATE,
A.CNTCT_OPTN_NBR,
A.CNTCT_OPTN_IND,
A.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.SMS_PREFR_IND                 ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_START_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)     SMS_AVAIL_START_TIME     ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_END_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)      SMS_AVAIL_END_TIME    ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_PHONE_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(REGIS_PRSNA_ID,FULL_PHONE_NUM) NOT IN (SELECT REGIS_PRSNA_ID,FULL_PHONE_NUM
FROM PRSNA_PHONE_ORIG
GROUP BY 1,2)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE 
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.FULL_PHONE_NUM DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PRSNA_EMAIL_ADDR_ORIG 
(
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
REGIS_CNSMR_ID_VAL             ,
EMAIL_ADDR_TXT                ,
GUARDN_EMAIL_ADDR_TXT         ,
CNTCT_POINT_CATEG_CODE,
GUARDN_NAME,
GUARDN_CNSNT_IND,
ACNLGMT_DATE,
SUBSCRPTN_OPT_NBR,
SUBSCRPTN_OPT_IND,
CNSMR_CHCE_DATETM,
PREF_CNTCT_POINT_IND,
VALID_CNTCT_POINT_IND,
EMAIL_FORMT_CODE              ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM
(SELECT 
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.EMAIL_ADDR_TXT                ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
A.GUARDN_NAME,
A.GUARDN_CNSNT_IND,
A.ACNLGMT_DATE,
A.CNTCT_OPTN_NBR,
A.CNTCT_OPTN_IND,
A.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.EMAIL_FORMT_CODE              ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_EMAIL_ADDR_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(REGIS_PRSNA_ID,EMAIL_ADDR_TXT) NOT IN (SELECT REGIS_PRSNA_ID,EMAIL_ADDR_TXT
FROM PRSNA_EMAIL_ADDR_ORIG
GROUP BY 1,2)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE     
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.EMAIL_ADDR_TXT DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PRSNA_SOC_NET_ACCT_ORIG 
(
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
REGIS_CNSMR_ID_VAL             ,
SOCIAL_NETWK_ACCT_ID_VAL      ,
GUARDN_EMAIL_ADDR_TXT         ,
CNTCT_POINT_CATEG_CODE,
GUARDN_NAME,
GUARDN_CNSNT_IND,
ACNLGMT_DATE,
SUBSCRPTN_OPT_NBR,
SUBSCRPTN_OPT_IND,
CNSMR_CHCE_DATETM,
PREF_CNTCT_POINT_IND,
VALID_CNTCT_POINT_IND,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM 
(SELECT
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.SOCIAL_NETWK_ACCT_ID_VAL      ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
A.GUARDN_NAME,
A.GUARDN_CNSNT_IND,
A.ACNLGMT_DATE,
A.CNTCT_OPTN_NBR,
A.CNTCT_OPTN_IND,
A.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_SOC_NETWK_ACCT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(REGIS_PRSNA_ID,SOCIAL_NETWK_ACCT_ID_VAL) NOT IN (SELECT REGIS_PRSNA_ID,SOCIAL_NETWK_ACCT_ID_VAL
FROM PRSNA_SOC_NET_ACCT_ORIG
GROUP BY 1,2)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE   
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.SOCIAL_NETWK_ACCT_ID_VAL DESC
) = 1
) A

GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PRSNA_POSTL_ADDR_ORIG
FROM 
(SELECT *
FROM
(SELECT
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.REGIS_CNSMR_ID_VAL
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.STRET_NUM
,STG.STRET_NAME
,STG.APT_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,STG.TERR_NAME
,STG.CNTRY_NAME
,STG.GUARDN_EMAIL_ADDR_TXT
,STG.CNTCT_POINT_CATEG_CODE
,STG.GUARDN_NAME
,STG.GUARDN_CNSNT_IND
,STG.ACNLGMT_DATE
,STG.CNTCT_OPTN_NBR
,STG.CNTCT_OPTN_IND
,STG.CNSMR_CHCE_DATETM
,STG.PREFR_IND
,STG.VALID_IND
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR,TOUT.REGIS_CNSMR_ID_VAL  
ORDER BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR   
,TOUT.REGIS_CNSMR_ID_VAL
,STG.SYS_CREATION_DATE DESC
,STG.SYS_SOURCE DESC
,STG.SYS_NC_TYPE DESC
,STG.CNTCT_OPTN_NBR DESC
,STG.CNTCT_POINT_CATEG_CODE DESC
) = 1
) A 
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36) B
SET ADDR_LINE_1_TXT = B.ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT = B.ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT = B.ADDR_LINE_3_TXT
,STRET_NUM = B.STRET_NUM
,STRET_NAME = B.STRET_NAME
,APT_NUM = B.APT_NUM
,PO_BOX_NUM = B.PO_BOX_NUM
,CITY_NAME = B.CITY_NAME
,POSTL_AREA_CODE = B.POSTL_AREA_CODE
,TERR_CODE = B.TERR_NAME
,CNTRY_CODE = B.CNTRY_NAME
,GUARDN_EMAIL_ADDR_TXT = B.GUARDN_EMAIL_ADDR_TXT
,CNTCT_POINT_CATEG_CODE = B.CNTCT_POINT_CATEG_CODE
,GUARDN_NAME = B.GUARDN_NAME
,GUARDN_CNSNT_IND = B.GUARDN_CNSNT_IND
,ACNLGMT_DATE = B.ACNLGMT_DATE
,SUBSCRPTN_OPT_NBR = B.CNTCT_OPTN_NBR
,SUBSCRPTN_OPT_IND = B.CNTCT_OPTN_IND
,CNSMR_CHCE_DATETM = B.CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND = B.PREFR_IND
,VALID_CNTCT_POINT_IND = B.VALID_IND
,SYS_SOURCE = B.SYS_SOURCE
,SYS_TARGET_ID = B.SYS_TARGET_ID
,SYS_AUTH_ID = B.SYS_AUTH_ID
,SYS_CREATED_BY = B.SYS_CREATED_BY
,SYS_LAST_MODIFIED_DATE = B.SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE = B.SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY = B.SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE = B.SYS_NC_TYPE
,SYS_ERR_CODE  = B.SYS_ERR_CODE
,SYS_ERR_SVRTY = B.SYS_ERR_SVRTY

WHERE PRSNA_POSTL_ADDR_ORIG.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PRSNA_POSTL_ADDR_ORIG.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PRSNA_POSTL_ADDR_ORIG.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PRSNA_POSTL_ADDR_ORIG.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PRSNA_PHONE_ORIG 
FROM
(
SELECT *
FROM
(SELECT
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.PHONE_CNTRY_NBR               ,
A.PHONE_AREA_NBR                ,
A.PHONE_EXCHG_NBR               ,
A.PHONE_LINE_NBR                ,
A.PHONE_EXTSN_NUM               ,
A.FULL_PHONE_NUM              ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
A.GUARDN_NAME,
A.GUARDN_CNSNT_IND,
A.ACNLGMT_DATE,
A.CNTCT_OPTN_NBR,
A.CNTCT_OPTN_IND,
A.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.SMS_PREFR_IND                 ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_START_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)     SMS_AVAIL_START_TIME     ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_END_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)      SMS_AVAIL_END_TIME    ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_PHONE_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.FULL_PHONE_NUM   
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.CNTCT_POINT_CATEG_CODE DESC
,A.CNTCT_OPTN_NBR DESC
,A.FULL_PHONE_NUM DESC
) = 1
) A GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34) B
SET PHONE_CNTRY_NBR = B.PHONE_CNTRY_NBR        
,PHONE_AREA_NBR = B.PHONE_AREA_NBR             
,PHONE_EXCHG_NBR = B.PHONE_EXCHG_NBR            
,PHONE_LINE_NBR = B.PHONE_LINE_NBR             
,PHONE_EXTSN_NUM = B.PHONE_EXTSN_NUM            
,GUARDN_EMAIL_ADDR_TXT = B.GUARDN_EMAIL_ADDR_TXT
,CNTCT_POINT_CATEG_CODE = B.CNTCT_POINT_CATEG_CODE
,GUARDN_NAME = B.GUARDN_NAME
,GUARDN_CNSNT_IND = B.GUARDN_CNSNT_IND
,ACNLGMT_DATE = B.ACNLGMT_DATE
,SUBSCRPTN_OPT_NBR = B.CNTCT_OPTN_NBR
,SUBSCRPTN_OPT_IND = B.CNTCT_OPTN_IND
,CNSMR_CHCE_DATETM = B.CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND = B.PREFR_IND
,VALID_CNTCT_POINT_IND = B.VALID_IND
,SMS_PREFR_IND = B.SMS_PREFR_IND                 
,SMS_AVAIL_START_TIME = B.SMS_AVAIL_START_TIME          
,SMS_AVAIL_END_TIME = B.SMS_AVAIL_END_TIME            
,SYS_SOURCE = B.SYS_SOURCE
,SYS_TARGET_ID = B.SYS_TARGET_ID
,SYS_AUTH_ID = B.SYS_AUTH_ID
,SYS_CREATED_BY = B.SYS_CREATED_BY
,SYS_LAST_MODIFIED_DATE = B.SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE = B.SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY = B.SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE = B.SYS_NC_TYPE
,SYS_ERR_CODE  = B.SYS_ERR_CODE
,SYS_ERR_SVRTY = B.SYS_ERR_SVRTY

WHERE PRSNA_PHONE_ORIG.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PRSNA_PHONE_ORIG.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PRSNA_PHONE_ORIG.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PRSNA_PHONE_ORIG.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
AND PRSNA_PHONE_ORIG.FULL_PHONE_NUM = B.FULL_PHONE_NUM  
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PRSNA_EMAIL_ADDR_ORIG 
FROM
(
SELECT *
FROM
(SELECT 
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.EMAIL_ADDR_TXT                ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
A.GUARDN_NAME,
A.GUARDN_CNSNT_IND,
A.ACNLGMT_DATE,
A.CNTCT_OPTN_NBR,
A.CNTCT_OPTN_IND,
A.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.EMAIL_FORMT_CODE              ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_EMAIL_ADDR_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.EMAIL_ADDR_TXT    
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.CNTCT_POINT_CATEG_CODE DESC
,A.CNTCT_OPTN_NBR DESC
,A.EMAIL_ADDR_TXT DESC
) = 1
) A 
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27) B
SET GUARDN_EMAIL_ADDR_TXT = B.GUARDN_EMAIL_ADDR_TXT
,CNTCT_POINT_CATEG_CODE = B.CNTCT_POINT_CATEG_CODE
,GUARDN_NAME = B.GUARDN_NAME
,GUARDN_CNSNT_IND = B.GUARDN_CNSNT_IND
,ACNLGMT_DATE = B.ACNLGMT_DATE
,SUBSCRPTN_OPT_NBR = B.CNTCT_OPTN_NBR
,SUBSCRPTN_OPT_IND = B.CNTCT_OPTN_IND
,CNSMR_CHCE_DATETM = B.CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND = B.PREFR_IND
,VALID_CNTCT_POINT_IND = B.VALID_IND
,EMAIL_FORMT_CODE = B.EMAIL_FORMT_CODE
,SYS_SOURCE = B.SYS_SOURCE
,SYS_TARGET_ID = B.SYS_TARGET_ID
,SYS_AUTH_ID = B.SYS_AUTH_ID
,SYS_CREATED_BY = B.SYS_CREATED_BY
,SYS_LAST_MODIFIED_DATE = B.SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE = B.SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY = B.SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE = B.SYS_NC_TYPE
,SYS_ERR_CODE  = B.SYS_ERR_CODE
,SYS_ERR_SVRTY = B.SYS_ERR_SVRTY

WHERE PRSNA_EMAIL_ADDR_ORIG.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PRSNA_EMAIL_ADDR_ORIG.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PRSNA_EMAIL_ADDR_ORIG.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PRSNA_EMAIL_ADDR_ORIG.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
AND PRSNA_EMAIL_ADDR_ORIG.EMAIL_ADDR_TXT = B.EMAIL_ADDR_TXT        
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PRSNA_SOC_NET_ACCT_ORIG 
FROM
(
SELECT *
FROM 
(SELECT
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.SOCIAL_NETWK_ACCT_ID_VAL      ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
A.GUARDN_NAME,
A.GUARDN_CNSNT_IND,
A.ACNLGMT_DATE,
A.CNTCT_OPTN_NBR,
A.CNTCT_OPTN_IND,
A.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_SOC_NETWK_ACCT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.SOCIAL_NETWK_ACCT_ID_VAL   
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.CNTCT_POINT_CATEG_CODE DESC
,A.CNTCT_OPTN_NBR DESC
,A.SOCIAL_NETWK_ACCT_ID_VAL DESC
) = 1
) A 
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26) B
SET GUARDN_EMAIL_ADDR_TXT = B.GUARDN_EMAIL_ADDR_TXT
,CNTCT_POINT_CATEG_CODE = B.CNTCT_POINT_CATEG_CODE
,GUARDN_NAME = B.GUARDN_NAME
,GUARDN_CNSNT_IND = B.GUARDN_CNSNT_IND
,ACNLGMT_DATE = B.ACNLGMT_DATE
,SUBSCRPTN_OPT_NBR = B.CNTCT_OPTN_NBR
,SUBSCRPTN_OPT_IND = B.CNTCT_OPTN_IND
,CNSMR_CHCE_DATETM = B.CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND = B.PREFR_IND
,VALID_CNTCT_POINT_IND = B.VALID_IND
,SYS_SOURCE = B.SYS_SOURCE
,SYS_TARGET_ID = B.SYS_TARGET_ID
,SYS_AUTH_ID = B.SYS_AUTH_ID
,SYS_CREATED_BY = B.SYS_CREATED_BY
,SYS_LAST_MODIFIED_DATE = B.SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE = B.SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY = B.SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE = B.SYS_NC_TYPE
,SYS_ERR_CODE  = B.SYS_ERR_CODE
,SYS_ERR_SVRTY = B.SYS_ERR_SVRTY

WHERE PRSNA_SOC_NET_ACCT_ORIG.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PRSNA_SOC_NET_ACCT_ORIG.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PRSNA_SOC_NET_ACCT_ORIG.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PRSNA_SOC_NET_ACCT_ORIG.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
AND PRSNA_SOC_NET_ACCT_ORIG.SOCIAL_NETWK_ACCT_ID_VAL = B.SOCIAL_NETWK_ACCT_ID_VAL         
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
*/
DEL FROM PRSNA_TRT_WORK ALL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PRSNA_TRT_WORK 
(
      REGIS_PRSNA_ID ,
      PRSNA_TRT_SEQ_NBR ,
      TRT_NBR ,
      PRSNA_TRT_DATE ,
      PRSNA_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT
      REGIS_PRSNA_ID ,
      PRSNA_TRT_SEQ_NBR ,
      TRT_NBR ,
      PRSNA_TRT_DATE ,
      PRSNA_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
FROM
PRSNA_TRT
WHERE (MKTNG_PGM_NBR,LEGAL_ENT_NBR,REGIS_PRSNA_ID) IN
(SELECT MKTNG_PGM_NBR,LEGAL_ENT_NBR,REGIS_PRSNA_ID
FROM
TSS_ERR_PRCS
GROUP BY 1,2,3
)
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

COLLECT STATS PRSNA_TRT_WORK
COLUMN (LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,TRT_NBR,PRSNA_TRT_SEQ_NBR);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;  

INS PRSNA_TRT 
(
      REGIS_PRSNA_ID ,
      PRSNA_TRT_SEQ_NBR ,
      TRT_NBR ,
      PRSNA_TRT_DATE ,
      PRSNA_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.PRSNA_TRT_SEQ_NBR,
      A.TRT_NBR,
      A.PRSNA_TRT_DATE,
     CASE WHEN A.PRSNA_TRT_TXT= '' OR A.PRSNA_TRT_TXT IS NULL
     THEN A.PRSNA_TRT_INTEGER
     ELSE A.PRSNA_TRT_TXT
     END PRSNA_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PRSNA_TRT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.TRT_NBR,A.PRSNA_TRT_SEQ_NBR) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,TRT_NBR,PRSNA_TRT_SEQ_NBR
FROM PRSNA_TRT_WORK
GROUP BY 1,2,3,4,5
)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.TRT_NBR,A.PRSNA_TRT_SEQ_NBR  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.PRSNA_TRT_TXT DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PET
(
      REGIS_PRSNA_ID ,
      PET_NAME ,
      PET_GENDR_IND ,
      PET_BRTH_DATE ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      PET_SEQ_NBR,
      PET_AGE_NBR,
--      DECEASED_IND,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.PET_NAME,
      A.PET_GENDR_IND,
      A.PET_BRTH_DATE,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.PET_SEQ_NBR,
      A.PET_AGE_NBR,
--      A.DECEASED_IND,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PET_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.PET_NAME) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,PET_NAME
FROM PET
GROUP BY 1,2,3,4
)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.PET_NAME
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.PET_NAME DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PET_TRT 
(
      REGIS_PRSNA_ID ,
      PET_TRT_SEQ_NBR ,
      TRT_NBR ,
      PET_TRT_DATE ,
      PET_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      PET_SEQ_NBR,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM
(SELECT 
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.PET_TRT_SEQ_NBR,
      A.TRT_ID,
      A.PET_TRT_DATE,
      A.PET_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.PET_SEQ_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PET_TRT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.PET_SEQ_NBR,A.PET_TRT_SEQ_NBR,A.TRT_ID) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,PET_SEQ_NBR,PET_TRT_SEQ_NBR,TRT_NBR
FROM PET_TRT
GROUP BY 1,2,3,4,5,6
)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.PET_SEQ_NBR,A.PET_TRT_SEQ_NBR,A.TRT_ID  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS DPEND
(
      REGIS_PRSNA_ID ,
      DPEND_TYPE_CODE ,
      DPEND_NAME ,
      DPEND_GENDR_IND ,
      DPEND_BRTH_DATE ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      DPEND_SEQ_NBR,
      DPEND_AGE_NBR,
--      DECEASED_IND,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM 
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.DPEND_TYPE_CODE,
      A.DPEND_NAME,
      A.DPEND_GENDR_IND,
      A.DPEND_BRTH_DATE,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.DPEND_SEQ_NBR,
      A.DPEND_AGE_NBR,
--      A.DECEASED_IND,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM DPEND_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.DPEND_NAME) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,DPEND_NAME
FROM DPEND
GROUP BY 1,2,3,4
)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.DPEND_NAME  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.DPEND_NAME DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS DPEND_TRT 
(
      REGIS_PRSNA_ID ,
      DPEND_TRT_SEQ_NBR ,
      TRT_NBR ,
      DPEND_TRT_DATE ,
      DPEND_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      DPEND_SEQ_NBR,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.DPEND_TRT_SEQ_NBR,
      A.TRT_NBR,
      A.DPEND_TRT_DATE,
      A.DPEND_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.DPEND_SEQ_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM DPEND_TRT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.DPEND_TRT_SEQ_NBR,A.TRT_NBR,A.DPEND_SEQ_NBR) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,DPEND_TRT_SEQ_NBR,TRT_NBR,DPEND_SEQ_NBR
FROM DPEND_TRT
GROUP BY 1,2,3,4,5,6
)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.DPEND_TRT_SEQ_NBR,A.TRT_NBR,A.DPEND_SEQ_NBR  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PRSNA_TRT 
FROM 
(SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.PRSNA_TRT_SEQ_NBR,
      A.TRT_NBR,
      A.PRSNA_TRT_DATE,
      CASE WHEN A.PRSNA_TRT_TXT= '' OR A.PRSNA_TRT_TXT IS NULL
     THEN A.PRSNA_TRT_INTEGER
     ELSE A.PRSNA_TRT_TXT
     END PRSNA_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PRSNA_TRT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.PRSNA_TRT_SEQ_NBR,A.TRT_NBR
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.PRSNA_TRT_TXT DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18
) B
SET   PRSNA_TRT_DATE=B.PRSNA_TRT_DATE ,
PRSNA_TRT_TXT=B.PRSNA_TRT_TXT ,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE PRSNA_TRT.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PRSNA_TRT.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PRSNA_TRT.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PRSNA_TRT.PRSNA_TRT_SEQ_NBR = B.PRSNA_TRT_SEQ_NBR
AND PRSNA_TRT.TRT_NBR = B.TRT_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PET
FROM
(SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.PET_NAME,
      A.PET_GENDR_IND,
      A.PET_BRTH_DATE,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.PET_SEQ_NBR,
      A.PET_AGE_NBR,
--      A.DECEASED_IND,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PET_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.PET_NAME  
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
) B
SET   PET_SEQ_NBR=B.PET_SEQ_NBR ,
PET_GENDR_IND=B.PET_GENDR_IND ,
PET_BRTH_DATE=B.PET_BRTH_DATE ,
PET_AGE_NBR=B.PET_AGE_NBR,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE PET.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PET.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PET.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PET.PET_NAME = B.PET_NAME
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PET_TRT 
FROM
(
SELECT *
FROM
(SELECT 
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.PET_TRT_SEQ_NBR,
      A.TRT_ID,
      A.PET_TRT_DATE,
      A.PET_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.PET_SEQ_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PET_TRT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.PET_TRT_SEQ_NBR,A.TRT_ID,A.PET_SEQ_NBR  
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
) B
SET   PET_TRT_DATE=B.PET_TRT_DATE ,
PET_TRT_TXT=B.PET_TRT_TXT ,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE PET_TRT.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PET_TRT.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PET_TRT.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PET_TRT.PET_SEQ_NBR = B.PET_SEQ_NBR
AND PET_TRT.PET_TRT_SEQ_NBR = B.PET_TRT_SEQ_NBR
AND PET_TRT.TRT_NBR = B.TRT_ID
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE DPEND
FROM
(
SELECT *
FROM 
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.DPEND_TYPE_CODE,
      A.DPEND_NAME,
      A.DPEND_GENDR_IND,
      A.DPEND_BRTH_DATE,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.DPEND_SEQ_NBR,
      A.DPEND_AGE_NBR,
--      A.DECEASED_IND,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM DPEND_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.DPEND_NAME
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
) B
SET   DPEND_TYPE_CODE=B.DPEND_TYPE_CODE ,
DPEND_NAME = B.DPEND_NAME ,
DPEND_GENDR_IND=B.DPEND_GENDR_IND ,
DPEND_BRTH_DATE=B.DPEND_BRTH_DATE ,
DPEND_AGE_NBR=B.DPEND_AGE_NBR,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE DPEND.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND DPEND.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND DPEND.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND DPEND.DPEND_SEQ_NBR=B.DPEND_SEQ_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE DPEND_TRT 
FROM
(
SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.DPEND_TRT_SEQ_NBR,
      A.TRT_NBR,
      A.DPEND_TRT_DATE,
      A.DPEND_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.DPEND_SEQ_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM DPEND_TRT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.DPEND_TRT_SEQ_NBR,A.TRT_NBR,A.DPEND_SEQ_NBR  
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
) B
SET   DPEND_TRT_DATE=B.DPEND_TRT_DATE ,
DPEND_TRT_TXT=B.DPEND_TRT_TXT ,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE DPEND_TRT.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND DPEND_TRT.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND DPEND_TRT.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND DPEND_TRT.DPEND_SEQ_NBR = B.DPEND_SEQ_NBR
AND DPEND_TRT.DPEND_TRT_SEQ_NBR = B.DPEND_TRT_SEQ_NBR
AND DPEND_TRT.TRT_NBR = B.TRT_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE CNSMR_AFFLTN 
FROM
(
SELECT DISTINCT
A.CNSMR_GRP_NBR                         ,
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.AFFLTN_START_DATE             ,
A.AFFLTN_END_DATE             ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM CNSMR_AFFLTN_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER(PARTITION BY REGIS_PRSNA_ID,A.CNSMR_GRP_NBR
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC  ) = 1
) B
SET   AFFLTN_START_DATE=B.AFFLTN_START_DATE             ,
AFFLTN_END_DATE=B.AFFLTN_END_DATE               ,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE CNSMR_AFFLTN.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND CNSMR_AFFLTN.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND CNSMR_AFFLTN.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND CNSMR_AFFLTN.CNSMR_GRP_NBR = B.CNSMR_GRP_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE MATCHD_CNSMR_POSTL_ADDR
FROM
(
SELECT *
FROM
(SELECT 
TOUT.MATCHD_CNSMR_PRSNA_ID
,TOUT.LEGAL_ENT_NBR
,STG.CNTCT_POINT_CATEG_CODE
,STG.VALID_IND VALID_CNTCT_POINT_IND
,STG.PREFR_IND
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.APT_NUM
,STG.STRET_NAME
,STG.STRET_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,'' LAT_MEAS
,'' LONG_MEAS
,CASE WHEN TR.TERR_RECODE IS NOT NULL
            THEN TR.TERR_RECODE
            ELSE STG.TERR_NAME
  END AS TERR_NAME
,CASE WHEN CR.CNTRY_RECODE IS NOT NULL
      THEN CR.CNTRY_RECODE 
      ELSE STG.CNTRY_NAME
  END AS CNTRY_NAME
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
LEFT OUTER JOIN TERR_RECODE TR
ON STG.TERR_NAME = TR.TERR
LEFT OUTER JOIN CNTRY_RECODE CR
ON STG.CNTRY_NAME = CR.CNTRY
QUALIFY RANK() OVER(PARTITION BY MATCHD_CNSMR_PRSNA_ID,STG.CNTCT_POINT_CATEG_CODE
ORDER BY LEGAL_ENT_NBR, HSHLD_PRSNA_ID DESC,
STG.SYS_CREATION_DATE DESC, STG.SYS_SOURCE DESC,STG.SYS_NC_TYPE DESC
,VALID_CNTCT_POINT_IND DESC) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29
) B
SET VALID_CNTCT_POINT_IND=B.VALID_CNTCT_POINT_IND
,PREF_CNTCT_POINT_IND=B.PREFR_IND
,ADDR_LINE_1_TXT=B.ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT=B.ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT=B.ADDR_LINE_3_TXT
,STRET_NUM=B.STRET_NUM
,STRET_NAME=B.STRET_NAME
,APT_NUM=B.APT_NUM
,PO_BOX_NUM=B.PO_BOX_NUM
,CITY_NAME=B.CITY_NAME
,POSTL_AREA_CODE=B.POSTL_AREA_CODE
,LAT_MEAS=B.LAT_MEAS
,LONG_MEAS=B.LONG_MEAS
,TERR_CODE=B.TERR_NAME
,CNTRY_CODE=B.CNTRY_NAME,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE MATCHD_CNSMR_POSTL_ADDR.MATCHD_CNSMR_PRSNA_ID = B.MATCHD_CNSMR_PRSNA_ID
AND MATCHD_CNSMR_POSTL_ADDR.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND MATCHD_CNSMR_POSTL_ADDR.CNTCT_POINT_CATEG_CODE=B.CNTCT_POINT_CATEG_CODE;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE MATCHD_CNSMR_PRSNA  
FROM
(SELECT *
FROM
(SELECT
TRIM(TOUT.MATCHD_CNSMR_PRSNA_ID) MATCHD_CNSMR_PRSNA_ID
,TOUT.LEGAL_ENT_NBR
,TRIM(TOUT.HSHLD_PRSNA_ID) HSHLD_PRSNA_ID
,CASE WHEN RANK() OVER (PARTITION BY TOUT.HSHLD_PRSNA_ID ORDER BY TOUT.HSHLD_PRSNA_ID,MATCHD_CNSMR_PRSNA_ID) = 1
           AND A.HSHLD_PRSNA_ID IS NULL
      THEN 'Y'
      ELSE 'N'
  END AS HEAD_OF_HSHLD_IND
,'' AS UNIVERSAL_OPT_OUT
,STG.NAME_PREFX_TXT
,STG.GVN_NAME
,STG.MID_NAME
,STG.FAMLY_NAME
,STG.NAME_SUFFX_TXT
,STG.FULL_NAME
,STG.GENDR_IND
,STG.BRTH_DATE
,'' AS NOTE_TXT
,STG.PRSNA_REG_DT LATST_ACTVY_DATE
,'ACTIVATED' AS PRSNA_STATUS_CODE
,STG.USER_NAME
,STG.LANG_CODE
,STG.PRSNA_REG_DT
,TOUT.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE                                                                  
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
LEFT OUTER JOIN (SELECT TRIM(HSHLD_PRSNA_ID) AS HSHLD_PRSNA_ID
FROM MATCHD_CNSMR_PRSNA GROUP BY 1) A
ON TOUT.HSHLD_PRSNA_ID = A.HSHLD_PRSNA_ID
QUALIFY RANK() OVER(PARTITION BY MATCHD_CNSMR_PRSNA_ID, TOUT.HSHLD_PRSNA_ID ,LEGAL_ENT_NBR
ORDER BY LEGAL_ENT_NBR, STG.PRSNA_REG_DT DESC, TOUT.REGIS_PRSNA_ID DESC,
TOUT.HSHLD_PRSNA_ID DESC, STG.SYS_CREATION_DATE DESC, STG.SYS_SOURCE DESC, 
STG.SYS_NC_TYPE DESC, STG.USER_NAME DESC 
,STG.FULL_NAME DESC) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
) B
SET HEAD_OF_HSHLD_IND=B.HEAD_OF_HSHLD_IND
,UNIVERSAL_OPT_OUT=B.UNIVERSAL_OPT_OUT
,NAME_PREFX_TXT=B.NAME_PREFX_TXT
,GVN_NAME=B.GVN_NAME
,MID_NAME=B.MID_NAME
,FAMLY_NAME=B.FAMLY_NAME
,NAME_SUFFX_TXT=B.NAME_SUFFX_TXT
,FULL_NAME=B.FULL_NAME
,GENDR_IND=B.GENDR_IND
,BRTH_DATE=B.BRTH_DATE
,NOTE_TXT=B.NOTE_TXT
,LATST_ACTVY_DATE=B.LATST_ACTVY_DATE
,PRSNA_STATUS_CODE=B.PRSNA_STATUS_CODE
,CNSMR_USER_NAME=B.USER_NAME
,LANG_CODE=B.LANG_CODE
,REGIS_DATE=B.PRSNA_REG_DT,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE MATCHD_CNSMR_PRSNA.MATCHD_CNSMR_PRSNA_ID = B.MATCHD_CNSMR_PRSNA_ID
AND MATCHD_CNSMR_PRSNA.HSHLD_PRSNA_ID = B.HSHLD_PRSNA_ID
AND MATCHD_CNSMR_PRSNA.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE REGIS_PRSNA
FROM
( 
SELECT *
FROM
(SELECT
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.MATCHD_CNSMR_PRSNA_ID
,'' REFERAL_MKTNG_PGM_NBR
,'' TRM_LEAD_KEY
,STG.NAME_PREFX_TXT
,STG.GVN_NAME
,STG.MID_NAME
,STG.FAMLY_NAME
,STG.NAME_SUFFX_TXT
,STG.FULL_NAME
,STG.GENDR_IND
,STG.BRTH_DATE
,STG.LANG_CODE
,STG.CNTRY_CODE
,'' EMAIL_SUPRSN_IND
,'' PHONE_SUPRSN_IND
,'' POSTL_SUPRSN_IND
,'' SOCL_NETWK_SUPRSN_IND
,STG.PRSNA_REG_DT LATST_ACTVY_DATE
,TOUT.REGIS_CNSMR_ID_VAL
,STG.USER_NAME
,STG.PRSNA_REG_DT
,'ACTIVATED' PRSNA_STATUS_CODE
,TOUT.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE                                                                  
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36
) B
SET MATCHD_CNSMR_PRSNA_ID=B.MATCHD_CNSMR_PRSNA_ID
,REFERAL_MKTNG_PGM_NBR=B.REFERAL_MKTNG_PGM_NBR
,TRM_LEAD_KEY=B.TRM_LEAD_KEY
,NAME_PREFX_TXT=B.NAME_PREFX_TXT
,GVN_NAME=B.GVN_NAME
,MID_NAME=B.MID_NAME
,FAMLY_NAME=B.FAMLY_NAME
,NAME_SUFFX_TXT=B.NAME_SUFFX_TXT
,FULL_NAME=B.FULL_NAME
,GENDR_IND=B.GENDR_IND
,BRTH_DATE=B.BRTH_DATE
,LANG_CODE=B.LANG_CODE
,CNTRY_CODE=B.CNTRY_CODE
,EMAIL_SUPRSN_IND=B.EMAIL_SUPRSN_IND
,PHONE_SUPRSN_IND=B.PHONE_SUPRSN_IND
,POSTL_SUPRSN_IND=B.POSTL_SUPRSN_IND
,SOCL_NETWK_SUPRSN_IND=B.SOCL_NETWK_SUPRSN_IND
,LATST_ACTVY_DATE=B.LATST_ACTVY_DATE
,REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
,CNSMR_USER_NAME=B.USER_NAME
,PRSNA_STATUS_CODE=B.PRSNA_STATUS_CODE,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE REGIS_PRSNA.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND REGIS_PRSNA.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND REGIS_PRSNA.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND REGIS_PRSNA.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

.LABEL STATUSUPDATE

UPDATE	REGIS_PRSNA 
FROM	(
SELECT	* 
FROM	(
SELECT	A.LEGAL_ENT_NBR,A.MKTNG_PGM_NBR,COALESCE(B.REFERENCE_REGISTRATIONKEY,
		CAST(TRIM(A.REGIS_PRSNA_ID) AS VARCHAR(20))) AS PRSNA,A.REGIS_PRSNA_ID,
		A.REGIS_CNSMR_ID_VAL,A.REGIS_DATE,A.SYS_CREATION_DATE,A.SYS_NC_TYPE,
		RANK() OVER (PARTITION BY PRSNA 
ORDER	BY A.LEGAL_ENT_NBR,A.MKTNG_PGM_NBR,PRSNA,A.REGIS_DATE DESC,
		A.REGIS_CNSMR_ID_VAL DESC,A.SYS_CREATION_DATE DESC,A.SYS_NC_TYPE DESC) AS RNK 
FROM	REGIS_PRSNA A LEFT OUTER JOIN TRILLIUM_OUTPUT B 
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR 
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL 
	AND	A.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR 
	AND	B.RECENT_IND = 'Y') B 
WHERE	RNK <> 1
GROUP BY 1,2,3,4,5,6,7,8,9
) B 
SET	PRSNA_STATUS_CODE = 'IN' 
WHERE	REGIS_PRSNA.LEGAL_ENT_NBR=B.LEGAL_ENT_NBR 
	AND	REGIS_PRSNA.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR 
	AND	REGIS_PRSNA.REGIS_PRSNA_ID=B.REGIS_PRSNA_ID 
	AND	REGIS_PRSNA.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL 
	AND	REGIS_PRSNA.REGIS_DATE=B.REGIS_DATE 
	AND	REGIS_PRSNA.SYS_CREATION_DATE=B.SYS_CREATION_DATE 
	AND	REGIS_PRSNA.SYS_NC_TYPE=B.SYS_NC_TYPE
	AND     REGIS_PRSNA.PRSNA_STATUS_CODE = 'AC';
 
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE REGIS_PRSNA 
FROM	(
SELECT	* 
FROM	(
SELECT	LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,REGIS_CNSMR_ID_VAL,
		REGIS_DATE,SYS_CREATION_DATE,SYS_NC_TYPE,RANK() OVER (PARTITION BY LEGAL_ENT_NBR,
		MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL 
ORDER	BY LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,REGIS_DATE DESC,
		REGIS_PRSNA_ID DESC,SYS_CREATION_DATE DESC,SYS_NC_TYPE DESC) AS RNK 
GROUP	BY LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,REGIS_DATE,
		REGIS_CNSMR_ID_VAL,SYS_CREATION_DATE,SYS_NC_TYPE 
FROM	REGIS_PRSNA) B 
WHERE	RNK <> 1
GROUP BY 1,2,3,4,5,6,7,8
) B 
SET	PRSNA_STATUS_CODE = 'IN' 
WHERE	REGIS_PRSNA.LEGAL_ENT_NBR=B.LEGAL_ENT_NBR 
	AND	REGIS_PRSNA.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR 
	AND	REGIS_PRSNA.REGIS_DATE=B.REGIS_DATE 
	AND	REGIS_PRSNA.REGIS_PRSNA_ID=B.REGIS_PRSNA_ID 
	AND	REGIS_PRSNA.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL 
	AND	REGIS_PRSNA.SYS_CREATION_DATE=B.SYS_CREATION_DATE 
	AND	REGIS_PRSNA.SYS_NC_TYPE=B.SYS_NC_TYPE
	AND     REGIS_PRSNA.PRSNA_STATUS_CODE = 'AC';

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE REGIS_PRSNA_POSTL_ADDR FROM TERR a
SET TERR_CODE = a.TERR_CODE
WHERE REGIS_PRSNA_POSTL_ADDR.TERR_CODE = a.TERR_CODE_NTV
AND a.CNTRY_CODE = 'IND' and REGIS_PRSNA_POSTL_ADDR.CNTRY_CODE = 'IND';
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE REGIS_PRSNA_POSTL_ADDR FROM TERR a
SET TERR_CODE = a.TERR_CODE
WHERE REGIS_PRSNA_POSTL_ADDR.TERR_CODE = a.TERR_CODE_NTV
AND a.CNTRY_CODE = 'JPN' and REGIS_PRSNA_POSTL_ADDR.CNTRY_CODE = 'JPN';
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PA
FROM REGIS_PRSNA_POSTL_ADDR PA, CITY XR
SET CITY_CODE = XR.CITY_CODE
WHERE PA.TERR_CODE = XR.TERR_CODE
AND PA.CITY_NAME = XR.CITY_NAME_NTV
AND MKTNG_PGM_NBR = 2 AND PA.CNTRY_CODE = 'JPN';
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PA
FROM REGIS_PRSNA_POSTL_ADDR PA, CITY XR
SET CITY_CODE = XR.CITY_CODE
WHERE PA.TERR_CODE = XR.TERR_CODE
AND PA.CITY_NAME = XR.CITY_NAME
AND MKTNG_PGM_NBR = 1 AND PA.CNTRY_CODE = 'IND';
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;


INSERT INTO RPT_LOAD_NBR
(
LOAD_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,STAGING_NBR
,ERROR_NBR
,ACTIVE_NBR
,DUPLICATE_NBR
,PHONE_OPT_IN
,PHONE_OPT_OUT
,EMAIL_OPT_IN
,EMAIL_OPT_OUT
,POSTAL_OPT_IN
,POSTAL_OPT_OUT
,SOCIAL_OPT_IN
,SOCIAL_OPT_OUT
)
SELECT 
A.LOAD_ID
,COALESCE(B.MKTNG_PGM_NBR,0)
,COALESCE(C.LEGAL_ENT_NBR,0)
,COALESCE(B.STAGING_NBR,0)
,COALESCE(N.ERROR_NBR,0)
,COALESCE(D.ACTIVE_NBR,0)
,COALESCE(E.DUPLICATE_NBR,0)
,COALESCE(F.PHONE_OPT_IN,0)
,COALESCE(G.PHONE_OPT_OUT,0)
,COALESCE(H.EMAIL_OPT_IN,0)
,COALESCE(I.EMAIL_OPT_OUT,0)
,COALESCE(J.POSTAL_OPT_IN,0)
,COALESCE(K.POSTAL_OPT_OUT,0)
,COALESCE(L.SOCIAL_OPT_IN,0)
,COALESCE(M.SOCIAL_OPT_OUT,0)
FROM
LOAD_CONTROL A
INNER JOIN 
MDM_LOAD_CONTROL LC
ON 
A.LOAD_ID = LC.LOAD_ID

INNER JOIN LOAD_INFO LI
ON A.LOAD_ID = LI.LOAD_ID
AND LI.PROCESS_NAME='VALIDATIONS'
AND LI.STATUS = 'SUCCESS'

LEFT OUTER JOIN
(SELECT LOAD_ID,
MKTNG_PGM_NBR,
COUNT(DISTINCT REGIS_CNSMR_ID_VAL) STAGING_NBR
FROM PRSNA_STG_CNT
GROUP BY 1,2
) B
ON A.LOAD_ID = B.LOAD_ID
LEFT OUTER JOIN
MKTNG_PGM C
ON 
B.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR

LEFT OUTER JOIN 
(SEL CAST(SYS_SOURCE AS INTEGER) SYS_SOURCE,
MKTNG_PGM_NBR,
COUNT(DISTINCT REGIS_PRSNA_ID) ACTIVE_NBR
FROM REGIS_PRSNA
WHERE PRSNA_STATUS_CODE = 'AC'
GROUP BY 1,2
) D
ON B.LOAD_ID = D.SYS_SOURCE
AND B.MKTNG_PGM_NBR = D.MKTNG_PGM_NBR 

LEFT OUTER JOIN 
(SEL CAST(SYS_SOURCE AS INTEGER) SYS_SOURCE,
MKTNG_PGM_NBR,
COUNT(DISTINCT REGIS_PRSNA_ID) DUPLICATE_NBR
FROM REGIS_PRSNA
WHERE PRSNA_STATUS_CODE = 'IN'
GROUP BY 1,2
) E
ON B.LOAD_ID = E.SYS_SOURCE
AND B.MKTNG_PGM_NBR = E.MKTNG_PGM_NBR 

LEFT OUTER JOIN 
(SEL CAST(SYS_SOURCE AS INTEGER) SYS_SOURCE,
MKTNG_PGM_NBR,
COUNT(REGIS_PRSNA_ID) PHONE_OPT_IN
FROM REGIS_PRSNA_PHONE
WHERE SUBSCRPTN_OPT_IND IN ('Y','I')
AND PHONE_STATUS_CODE = 'AC'
GROUP BY 1,2
) F
ON B.LOAD_ID = F.SYS_SOURCE
AND B.MKTNG_PGM_NBR = F.MKTNG_PGM_NBR 

LEFT OUTER JOIN 
(SEL CAST(SYS_SOURCE AS INTEGER) SYS_SOURCE,
MKTNG_PGM_NBR,
COUNT(REGIS_PRSNA_ID) PHONE_OPT_OUT
FROM REGIS_PRSNA_PHONE
WHERE SUBSCRPTN_OPT_IND IN ('N','O')
AND PHONE_STATUS_CODE = 'AC'
GROUP BY 1,2
) G
ON B.LOAD_ID = G.SYS_SOURCE
AND B.MKTNG_PGM_NBR = G.MKTNG_PGM_NBR 

LEFT OUTER JOIN 
(SEL CAST(SYS_SOURCE AS INTEGER) SYS_SOURCE,
MKTNG_PGM_NBR,
COUNT(REGIS_PRSNA_ID) EMAIL_OPT_IN
FROM REGIS_PRSNA_EMAIL_ADDR
WHERE SUBSCRPTN_OPT_IND IN ('Y','I')
AND EMAIL_STATUS_CODE = 'AC'
GROUP BY 1,2
) H
ON B.LOAD_ID = H.SYS_SOURCE
AND B.MKTNG_PGM_NBR = H.MKTNG_PGM_NBR 

LEFT OUTER JOIN 
(SEL CAST(SYS_SOURCE AS INTEGER) SYS_SOURCE,
MKTNG_PGM_NBR,
COUNT(REGIS_PRSNA_ID) EMAIL_OPT_OUT
FROM REGIS_PRSNA_EMAIL_ADDR
WHERE SUBSCRPTN_OPT_IND IN ('N','O')
AND EMAIL_STATUS_CODE = 'AC'
GROUP BY 1,2
) I
ON B.LOAD_ID = I.SYS_SOURCE
AND B.MKTNG_PGM_NBR = I.MKTNG_PGM_NBR 

LEFT OUTER JOIN 
(SEL CAST(SYS_SOURCE AS INTEGER) SYS_SOURCE,
MKTNG_PGM_NBR,
COUNT(REGIS_PRSNA_ID) POSTAL_OPT_IN
FROM REGIS_PRSNA_POSTL_ADDR
WHERE SUBSCRPTN_OPT_IND IN ('Y','I')
AND POSTL_STATUS_CODE = 'AC'
GROUP BY 1,2
) J
ON B.LOAD_ID = J.SYS_SOURCE
AND B.MKTNG_PGM_NBR = J.MKTNG_PGM_NBR 

LEFT OUTER JOIN 
(SEL CAST(SYS_SOURCE AS INTEGER) SYS_SOURCE,
MKTNG_PGM_NBR,
COUNT(REGIS_PRSNA_ID) POSTAL_OPT_OUT
FROM REGIS_PRSNA_POSTL_ADDR
WHERE SUBSCRPTN_OPT_IND IN ('N','O')
AND POSTL_STATUS_CODE = 'AC'
GROUP BY 1,2
) K
ON B.LOAD_ID = K.SYS_SOURCE
AND B.MKTNG_PGM_NBR = K.MKTNG_PGM_NBR 

LEFT OUTER JOIN 
(SEL CAST(SYS_SOURCE AS INTEGER) SYS_SOURCE,
MKTNG_PGM_NBR,
COUNT(REGIS_PRSNA_ID) SOCIAL_OPT_IN
FROM REGIS_PRSNA_SOC_NET_ACCT
WHERE SUBSCRPTN_OPT_IND IN ('Y','I')
AND SOC_NET_STATUS_CODE = 'AC'
GROUP BY 1,2
) L
ON B.LOAD_ID = L.SYS_SOURCE
AND B.MKTNG_PGM_NBR = L.MKTNG_PGM_NBR 

LEFT OUTER JOIN 
(SEL CAST(SYS_SOURCE AS INTEGER) SYS_SOURCE,
MKTNG_PGM_NBR,
COUNT(REGIS_PRSNA_ID) SOCIAL_OPT_OUT
FROM REGIS_PRSNA_SOC_NET_ACCT
WHERE SUBSCRPTN_OPT_IND IN ('N','O')
AND SOC_NET_STATUS_CODE = 'AC'
GROUP BY 1,2
) M
ON B.LOAD_ID = M.SYS_SOURCE
AND B.MKTNG_PGM_NBR = M.MKTNG_PGM_NBR

LEFT OUTER JOIN (SEL LOAD_ID,
MKTNG_PGM_NBR,
COUNT(DISTINCT REGIS_CNSMR_ID_VAL) ERROR_NBR
FROM ERR_PRSNA_STG
GROUP BY 1,2
) N
ON B.LOAD_ID = N.LOAD_ID
AND B.MKTNG_PGM_NBR = N.MKTNG_PGM_NBR

WHERE A.LOAD_TYPE = 'ETL'
AND A.LOADSTATUS = 'SUCCESS'
AND A.FORMAT_ID = 1
AND A.MDM_PROCESS_DESC='COMPLETED'
AND A.TARGETCNT > 0
GROUP BY 1,2,3,4,5,6,7,8,9,10,
11,12,13,14,15
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

.LABEL EXIT

.IF ERRORLEVEL > 4 THEN .GOTO ERR ;
.IF ERRORLEVEL <= 4 THEN .GOTO WARN;

.LABEL ERR
.QUIT 1

.LABEL WARN
.QUIT 0

