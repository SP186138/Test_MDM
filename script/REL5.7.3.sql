.logon $TDPID/$TDUSER,$TDPWD


.SET ERROROUT STDOUT;
.SET SESSION CHARSET 'UTF8';
.SET ERRORLEVEL 3807 SEVERITY 0

DATABASE MDM;
.GOTO $Step



.LABEL L0
DEL FROM DATA_SUPLR WHERE TRIM(DATA_SUPLR_NAME) IN
(SEL TRIM(DATA_SUPLR_NAME) FROM DATA_SUPLR
GROUP BY 1
HAVING COUNT(*) > 1);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL L1
INSERT  INTO MDM.DATA_SUPLR 
(DATA_SUPLR_NBR,DATA_SUPLR_NAME,LOG_SOURCE_ID,LOG_UPDATE_USER,LOG_LOAD_ID)
SELECT
MIN(SOURCE_ID) AS SOURCE_ID
,TRIM(DATA_SOURCE) AS DATA_SOURCE
,1 AS LOG_SOURCE_ID
,'ETLUSER' AS LOG_UPDATE_USER
,1 AS LOG_LOAD_ID
FROM ETL_CTRL.SOURCE_CONTROL
WHERE TRIM(DATA_SOURCE) NOT IN (SELECT TRIM(DATA_SUPLR_NAME) FROM MDM.DATA_SUPLR GROUP BY 1) 
AND SOURCE_ID NOT IN (SELECT DATA_SUPLR_NBR FROM MDM.DATA_SUPLR GROUP BY 1) 
AND SOURCE_ID IS NOT NULL
AND DATA_SOURCE IS NOT NULL
GROUP BY 2;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL L2
DEL FROM DATA_SRCE WHERE TRIM(DATA_SRCE_NBR) IN
(SEL TRIM(DATA_SRCE_NBR) FROM DATA_SRCE
GROUP BY 1
HAVING COUNT(*) > 1);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL L3
INSERT INTO MDM.DATA_SRCE
(
DATA_SRCE_NBR   
,DATA_SRCE_NAME
,DATA_SUPLR_NBR
,DATA_SOURCE_TYPE
,LOG_SOURCE_ID
,LOG_UPDATE_USER
,LOG_LOAD_ID
,SRC_BUS_NM
,SYS_ENT_STATE
,PII_DATA_IND
)
SELECT DISTINCT
A.SOURCE_ID
,CASE WHEN C.DATA_SRCE_NAME IS NULL THEN A.DATA_SOURCE
ELSE C.DATA_SRCE_NAME
END 
,COALESCE(B.DATA_SUPLR_NBR,0)
,CASE WHEN C.DATA_SOURCE_TYPE IS NULL THEN A.DATA_SOURCE_TYPE
ELSE C.DATA_SOURCE_TYPE
END 
,C.LOG_SOURCE_ID
,C.LOG_UPDATE_USER
,C.LOG_LOAD_ID
,C.SRC_BUS_NM
,CASE WHEN C.SYS_ENT_STATE IS NULL THEN 'ACTIVE'
ELSE C.SYS_ENT_STATE
END 
,CASE WHEN C.PII_DATA_IND IS NULL THEN 'N'
ELSE C.PII_DATA_IND
END
FROM ETL_CTRL.SOURCE_CONTROL A
LEFT JOIN MDM.DATA_SUPLR B
ON TRIM(A.DATA_SOURCE)=TRIM(B.DATA_SUPLR_NAME)
LEFT JOIN DEPLOY_WORK.DATA_SRCE_573 C
ON A.SOURCE_ID=C.DATA_SRCE_NBR
WHERE A.SOURCE_ID NOT IN (SELECT DATA_SRCE_NBR FROM MDM.DATA_SRCE)
QUALIFY RANK() OVER (PARTITION BY A.SOURCE_ID
ORDER BY B.DATA_SUPLR_NBR ASC, C.DATA_SRCE_NAME ASC)=1;

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL L4
CREATE MULTISET TABLE MDM.I60_OPT_OUT_CHK_RPT ,NO FALLBACK ,
     NO BEFORE JOURNAL,
     NO AFTER JOURNAL,
     CHECKSUM = DEFAULT,
     DEFAULT MERGEBLOCKRATIO
     (
      RECORD_ID INTEGER GENERATED ALWAYS AS IDENTITY
           (START WITH 1 
            INCREMENT BY 1 
            MINVALUE -2147483647 
            MAXVALUE 2147483647 
            NO CYCLE),
      IMPCT_REGIS_PRSNA_ID INTEGER ,
      IMPCT_MKTNG_PGM_NBR INTEGER,
      IMPCT_CNTCT_POINT_CATEG_CODE CHAR(2) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS,
      IMPCT_SUBSCRPTN_OPT_NBR INTEGER COMPRESS,
      MKTNG_PGM_NBR INTEGER,
      SUBSCRIPTION_NBR INTEGER,
      LAST_NAME VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS,
      EMAIL_ADDR_TEXT VARCHAR(50) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
      CONTACT_PHONE_NBR VARCHAR(20) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
      ADDR_LINE_1_TXT VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
      ADDR_LINE_2_TXT VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
      ADDR_LINE_3_TXT VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
      CITY_NAME VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
      TERR_NAME VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
      POSTL_AREA_CODE VARCHAR(20) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
      CNTRY_NAME VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS,
      OPT_TIME TIMESTAMP(0),
      LAST_ACTIVITY_TM TIMESTAMP(0),
      NATIONAL_ID_NBR VARCHAR(20) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
      CHANNEL_IND VARCHAR(3) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('ALL','E','A'),
      OPT_LEVEL_IND CHAR(1) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('H','M','R'),
      PE_OPTOUT_ID BIGINT COMPRESS 0 ,
      POSTL_ADDR_ID INTEGER COMPRESS 0 ,
      LOG_SOURCE_ID DECIMAL(18,0) COMPRESS ,
      RPT_DATE DATE FORMAT 'YY/MM/DD' NOT NULL,
      OPT_CHK_DESC VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC      
      )
PRIMARY INDEX I60_OPT_OUT_CHK_RPT ( RECORD_ID );
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L5
 CREATE SET TABLE MDM.I10A_OPT_OUT_CHK_RPT ,NO FALLBACK ,
      NO BEFORE JOURNAL,
      NO AFTER JOURNAL,
      CHECKSUM = DEFAULT,
      DEFAULT MERGEBLOCKRATIO
      (
       IMPCT_REGIS_PRSNA_ID INTEGER NOT NULL,
       IMPCT_MKTNG_PGM_NBR INTEGER NOT NULL,
       IMPCT_CNTCT_POINT_CATEG_CODE CHAR(2) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS,
       IMPCT_SUBSCRPTN_OPT_NBR INTEGER COMPRESS,   
       MKTNG_PGM_NBR DECIMAL(18,0) COMPRESS,
       EMAIL_ADDR_TXT VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC,
       ACTION_TIMESTAMP TIMESTAMP(0),
       RECORD_TYPE VARCHAR(20) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ,
       LOAD_ID DECIMAL(18,0) COMPRESS ,
       RPT_DATE DATE FORMAT 'YY/MM/DD' NOT NULL,
       OPT_CHK_DESC VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC )
 PRIMARY INDEX I10A_OPT_OUT_CHK_RPT ( IMPCT_REGIS_PRSNA_ID ,IMPCT_MKTNG_PGM_NBR )
PARTITION BY IMPCT_MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L6
 CREATE SET TABLE MDM.I10B_OPT_OUT_CHK_RPT ,NO FALLBACK ,
      NO BEFORE JOURNAL,
      NO AFTER JOURNAL,
      CHECKSUM = DEFAULT,
      DEFAULT MERGEBLOCKRATIO
      (
       IMPCT_REGIS_PRSNA_ID INTEGER NOT NULL,
       IMPCT_MKTNG_PGM_NBR INTEGER NOT NULL,
       IMPCT_CNTCT_POINT_CATEG_CODE CHAR(2) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS,
       IMPCT_SUBSCRPTN_OPT_NBR INTEGER COMPRESS,   
       MKTNG_PGM_NBR DECIMAL(18,0) COMPRESS,
       FULL_PHONE_NBR VARCHAR(20) CHARACTER SET UNICODE NOT CASESPECIFIC,
       LAST_ACTIVITY_TM TIMESTAMP(0),
       UNSUB CHAR(1) CHARACTER SET LATIN NOT CASESPECIFIC,
       LOAD_ID DECIMAL(18,0) COMPRESS ,
       RPT_DATE DATE FORMAT 'YY/MM/DD' NOT NULL,
       OPT_CHK_DESC VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC )
 PRIMARY INDEX I10B_OPT_OUT_CHK_RPT ( IMPCT_REGIS_PRSNA_ID ,IMPCT_MKTNG_PGM_NBR )
PARTITION BY IMPCT_MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L7
 CREATE SET TABLE MDM.I10C_OPT_OUT_CHK_RPT ,NO FALLBACK ,
      NO BEFORE JOURNAL,
      NO AFTER JOURNAL,
      CHECKSUM = DEFAULT,
      DEFAULT MERGEBLOCKRATIO
      (
       IMPCT_REGIS_PRSNA_ID INTEGER NOT NULL,
       IMPCT_MKTNG_PGM_NBR INTEGER NOT NULL,
       IMPCT_CNTCT_POINT_CATEG_CODE CHAR(2) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS,
       IMPCT_SUBSCRPTN_OPT_NBR INTEGER COMPRESS,   
       REGIS_PRSNA_ID INTEGER COMPRESS ,
       RESP_REC_TYPE_CODE CHAR(5) CHARACTER SET LATIN NOT CASESPECIFIC NOT NULL,
       RESP_DATETM TIMESTAMP(6),
       MKTNG_PGM_NBR INTEGER COMPRESS ,
       ADDR_LINE_1_TXT VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
       ADDR_LINE_2_TXT VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
       ADDR_LINE_3_TXT VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
       STRET_NUM VARCHAR(20) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
       STRET_NAME VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
       APT_NUM VARCHAR(20) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
       PO_BOX_NUM VARCHAR(20) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
       CITY_NAME VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
       POSTL_AREA_CODE VARCHAR(20) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
       TERR_NAME VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
       CNTRY_NAME VARCHAR(100) CHARACTER SET UNICODE NOT CASESPECIFIC COMPRESS ,
       LOAD_ID DECIMAL(18,0) COMPRESS ,
       RPT_DATE DATE FORMAT 'YY/MM/DD' NOT NULL,
       OPT_CHK_DESC VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC )
 PRIMARY INDEX I10C_OPT_OUT_CHK_RPT ( IMPCT_REGIS_PRSNA_ID ,IMPCT_MKTNG_PGM_NBR )
PARTITION BY IMPCT_MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L8
 CREATE SET TABLE MDM.I2_OPT_OUT_CHK_RPT ,NO FALLBACK ,
      NO BEFORE JOURNAL,
      NO AFTER JOURNAL,
      CHECKSUM = DEFAULT,
      DEFAULT MERGEBLOCKRATIO
      (
       IMPCT_REGIS_PRSNA_ID INTEGER NOT NULL,
       IMPCT_MKTNG_PGM_NBR INTEGER NOT NULL,
       IMPCT_CNTCT_POINT_CATEG_CODE CHAR(2) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS,
       IMPCT_SUBSCRPTN_OPT_NBR INTEGER COMPRESS,   
       MKTNG_PGM_NBR INTEGER TITLE 'MKTNG_PGM_NBR' ,
       REGIS_CNSMR_ID_VAL VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC TITLE 'REGIS_CNSMR_ID_VAL' ,
       CNTCT_OPTN_NBR DECIMAL(4,2) TITLE 'CNTCT_OPTN_NBR' ,
       CNTCT_OPTN_IND CHAR(1) CHARACTER SET LATIN NOT CASESPECIFIC TITLE 'CNTCT_OPTN_IND' ,
       CNSMR_CHCE_DATETM TIMESTAMP(6) TITLE 'CNSMR_CHCE_DATETM' ,
       CNTCT_POINT_CATEG_CODE CHAR(2) CHARACTER SET LATIN NOT CASESPECIFIC TITLE 'CNTCT_POINT_CATEG_CODE',
       LOAD_ID DECIMAL(18,0) COMPRESS ,
       RPT_DATE DATE FORMAT 'YY/MM/DD' NOT NULL,
       OPT_CHK_DESC VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC )
 PRIMARY INDEX I2_OPT_OUT_CHK_RPT ( IMPCT_REGIS_PRSNA_ID ,IMPCT_MKTNG_PGM_NBR )
PARTITION BY IMPCT_MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L9
 CREATE SET TABLE MDM.I25C_OPT_OUT_CHK_RPT ,NO FALLBACK ,
      NO BEFORE JOURNAL,
      NO AFTER JOURNAL,
      CHECKSUM = DEFAULT,
      DEFAULT MERGEBLOCKRATIO
      (
       IMPCT_REGIS_PRSNA_ID INTEGER NOT NULL,
       IMPCT_MKTNG_PGM_NBR INTEGER NOT NULL,
       IMPCT_CNTCT_POINT_CATEG_CODE CHAR(2) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS,
       IMPCT_SUBSCRPTN_OPT_NBR INTEGER COMPRESS,   
       MATCHD_CNSMR_PRSNA_ID INTEGER COMPRESS (71721728 ,83394560 ,76448512 ,72920832 ,47682817 ,79253251 ,71971844 ,77438468 ,67984902 ,72782343 ,78635271 ,81558280 ,66821128 ,73728777 ,74395145 ,72378121 ,47648010 ,76092170 ,78333194 ,72606987 ,66772749 ,69021710 ,73508367 ,80887312 ,78356496 ,71878672 ,79502609 ,67212049 ,68466706 ,72442387 ,67347993 ,83766555 ,69224219 ,76165917 ,70969117 ,79799838 ,81996063 ,67883295 ,78017824 ,73829408 ,68551457 ,66808865 ,83389985 ,84190756 ,73998374 ,70972967 ,71638312 ,77293096 ,67080745 ,75125292 ,77854510 ,67106862 ,45280815 ,78219824 ,69002800 ,67893552 ,76941873 ,83919410 ,80196658 ,73195058 ,84555572 ,80293685 ,72630069 ,74599477 ,70471478 ,69475383 ,77489463 ,82171191 ,81267257 ,79891257 ,80110394 ,81442876 ,79709758 ,76841793 ,83135554 ,82783555 ,84558405 ,79971909 ,70254150 ,71799626 ,81308234 ,80527434 ,44653645 ,68125261 ,81520975 ,82921298 ,84160851 ,83340884 ,78610262 ,73782102 ,80205398 ,77738071 ,83432537 ,68815706 ,66807130 ,80263770 ,67184476 ,71615581 ,75944285 ,70551902 ,76783198 ,73247583 ,84608609 ,74369889 ,72823906 ,84993122 ,76316004 ,73915492 ,83686500 ,82499685 ,75492965 ,68286567 ,71869544 ,67202921 ,79164009 ,74537322 ,72269930 ,80871532 ,71805293 ,84274797 ,72013167 ,68363888 ,70484594 ,77320051 ,74189941 ,79016054 ,79050359 ,84765047 ,82287993 ,71665788 ,79957629 ,73245057 ,68594562 ,38357380 ,74871940 ,68763270 ,84820615 ,82616968 ,71234697 ,76452494 ,77599888 ,81117328 ,85003666 ,67997842 ,84432275 ,77487251 ,47717268 ,79753364 ,82398613 ,68160662 ,70920599 ,69375895 ,66528667 ,79458204 ,80060828 ,74438558 ,71526815 ,74899103 ,71848098 ,73898658 ,45084066 ,69517732 ,68231591 ,79654824 ,79741610 ,81988011 ,69538731 ,44853419 ,47744430 ,77983150 ,76593583 ,81122223 ,74386867 ,77761204 ,78451125 ,69254583 ,73304761 ,80243386 ,74357181 ,81010110 ,69263294 ,75931839 ,79433669 ,80296389 ,81751749 ,81916101 ,69318598 ,68089542 ,79610567 ,80567240 ,66855625 ,84008137 ,83657419 ,75949004 ,72411085 ,83520206 ,71435986 ,74386642 ,84426195 ,75672531 ,84724180 ,83537877 ,76630744 ,84312793 ,71677657 ,66583001 ,83393243 ,80160220 ,74759388 ,76152028 ,70790365 ,84401629 ,68052190 ,78910943 ,70220255 ,83802079 ,44101087 ,81003232 ,72228576 ,45024995 ,82115555 ,47720677 ,76457445 ,83291621 ,67260650 ,82294251 ,76836334 ,80590830 ,83212782 ,77198575 ,72455664 ,32581105 ,78746354 ,78309619 ,69137395 ,32383988 ,82323188 ,82067700 ,79382516 ,44825077 ,77680887 ,83843319 ,47724281 ,84237050 ,75068410 ,75525115 ,75181564 ,82476540 ,72581628 ,74169597 ),
       MKTNG_PGM_NBR INTEGER NOT NULL,
       REGIS_PRSNA_ID INTEGER NOT NULL,
       DECEASED VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('N','Y'),
       DMA_DO_NOT_MAIL VARCHAR(100) CHARACTER SET LATIN NOT CASESPECIFIC COMPRESS ('N','Y'),
       LOAD_ID DECIMAL(18,0) COMPRESS ,
       RPT_DATE DATE FORMAT 'YY/MM/DD' NOT NULL,
       OPT_CHK_DESC VARCHAR(200) CHARACTER SET LATIN NOT CASESPECIFIC )
 PRIMARY INDEX I25C_OPT_OUT_CHK_RPT ( IMPCT_REGIS_PRSNA_ID ,IMPCT_MKTNG_PGM_NBR )
PARTITION BY IMPCT_MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L10
 CREATE VOLATILE TABLE TEMP1 AS
 (SELECT 
 A.MKTNG_PGM_NBR, 
 A.S_ADD1,
 A.S_ADD2,
 A.S_ADD3,
 A.S_CITY,
 A.S_STATE,
 A.S_ZIP,
 A.S_COUNTRY,
 A.OPT_OUT_DTTIME,
 A.LOAD_ID
 FROM 
 (SELECT  DISTINCT 
 STG.MKTNG_PGM_NBR, 
 STG.S_ADD1,
 STG.S_ADD2,
 STG.S_ADD3,
 STG.S_CITY,
 STG.S_STATE,
 STG.S_ZIP,
 STG.S_COUNTRY,
 STG.OPT_OUT_DTTIME,
 STG.LOAD_ID   FROM 
 ICRM_STAGE.REG_OPT_OUT_STGHIST_DONTDEL STG 
 WHERE (COALESCE(TRIM(STG.S_ADD1),'')<> ''
      OR COALESCE(TRIM(STG.S_ADD2),'')<> ''
      OR COALESCE(TRIM(STG.S_ADD3),'')<> '')  
 AND OPT_OUT_DTTIME IS NOT NULL 
 )  A
 LEFT JOIN 
 (SELECT 
 MKTNG_PGM_NBR, 
 SRC_ADDR_LINE_1_TXT,
 SRC_ADDR_LINE_2_TXT,
 SRC_ADDR_LINE_3_TXT,
 SRC_CITY_NAME,
 SRC_STATE,
 SRC_ZIP,
 SRC_CNTRY_NAME,
 OPT_TIME 
  FROM MDM.REGIS_PRSNA_OPT_HIST 
  WHERE REGIS_PRSNA_ID < 0 
 AND OPT_LEVEL_IND IS NOT NULL
 AND (COALESCE(TRIM(SRC_ADDR_LINE_1_TXT),'')<> ''
      OR COALESCE(TRIM(SRC_ADDR_LINE_2_TXT),'')<> ''
      OR COALESCE(TRIM(SRC_ADDR_LINE_3_TXT),'')<> '') )  B
 ON A.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR 
 AND COALESCE(TRIM(A.S_ADD1),'')=  COALESCE(TRIM(B.SRC_ADDR_LINE_1_TXT),'')
 AND COALESCE(TRIM(A.S_ADD2),'')= COALESCE(TRIM(B.SRC_ADDR_LINE_2_TXT),'')
 AND COALESCE(TRIM(A.S_ADD3),'')= COALESCE(TRIM(B.SRC_ADDR_LINE_3_TXT),'')
 AND COALESCE(TRIM(A.S_CITY),'')= COALESCE(TRIM(B.SRC_CITY_NAME),'')
 AND COALESCE(TRIM(A.S_STATE),'')= COALESCE(TRIM(B.SRC_STATE),'')
 AND COALESCE(TRIM(A.S_ZIP),'')= COALESCE(TRIM(B.SRC_ZIP),'')
 AND COALESCE(TRIM(A.S_COUNTRY),'')= COALESCE(TRIM(B.SRC_CNTRY_NAME),'')
 AND A.OPT_OUT_DTTIME = B.OPT_TIME
 WHERE B.MKTNG_PGM_NBR IS NULL
 QUALIFY RANK() OVER (PARTITION BY A.MKTNG_PGM_NBR, 
 A.S_ADD1,
 A.S_ADD2,
 A.S_ADD3,
 A.S_CITY,
 A.S_STATE,
 A.S_COUNTRY,
 A.OPT_OUT_DTTIME,
 A.LOAD_ID
 ORDER BY A.S_ZIP DESC)=1)
 WITH DATA
 PRIMARY INDEX (MKTNG_PGM_NBR, 
 S_ADD1,
 S_ADD2,
 S_ADD3,
 S_CITY,
 S_STATE,
 S_COUNTRY,
 OPT_OUT_DTTIME,
 LOAD_ID)
ON COMMIT PRESERVE ROWS;

COLLECT STATS TEMP1
COLUMN MKTNG_PGM_NBR;
COLLECT STATS TEMP1
COLUMN S_ADD1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
 .LABEL L11
 UPDATE MDM.REGIS_PRSNA_OPT_HIST
 FROM TEMP1 A
 SET SRC_ZIP=A.S_ZIP
 WHERE A.MKTNG_PGM_NBR = MDM.REGIS_PRSNA_OPT_HIST.MKTNG_PGM_NBR 
 AND COALESCE(TRIM(A.S_ADD1),'')=  COALESCE(TRIM(MDM.REGIS_PRSNA_OPT_HIST.SRC_ADDR_LINE_1_TXT),'')
 AND COALESCE(TRIM(A.S_ADD2),'')= COALESCE(TRIM(MDM.REGIS_PRSNA_OPT_HIST.SRC_ADDR_LINE_2_TXT),'')
 AND COALESCE(TRIM(A.S_ADD3),'')= COALESCE(TRIM(MDM.REGIS_PRSNA_OPT_HIST.SRC_ADDR_LINE_3_TXT),'')
 AND COALESCE(TRIM(A.S_CITY),'')= COALESCE(TRIM(MDM.REGIS_PRSNA_OPT_HIST.SRC_CITY_NAME),'')
 AND COALESCE(TRIM(A.S_STATE),'')= COALESCE(TRIM(MDM.REGIS_PRSNA_OPT_HIST.SRC_STATE),'')
 AND COALESCE(TRIM(A.S_COUNTRY),'')= COALESCE(TRIM(MDM.REGIS_PRSNA_OPT_HIST.SRC_CNTRY_NAME),'')
 AND A.OPT_OUT_DTTIME = MDM.REGIS_PRSNA_OPT_HIST.OPT_TIME
AND A.LOAD_ID = MDM.REGIS_PRSNA_OPT_HIST.LOG_SOURCE_ID;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;