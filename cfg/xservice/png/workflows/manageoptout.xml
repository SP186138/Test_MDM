<?xml version="1.0" encoding="UTF-8"?>
<workflow mgcCount="4" ShowInBreadCrumbs="true" Version="1.0" Name="manageoptout" Description="" Type="" PrimaryDocument="" IsStartAllowed="Yes">
  <variables Name="manageoptout">
    <variable Name="selectedMatchCnsmrId" Type="string" Comment=""/>
    <variable Name="selectedHshldId" Type="string" Comment=""/>
    <variable Name="selectedLegalEnt" Type="string" Comment=""/>
    <variable Name="msg" Type="string" Comment=""/>
    <variable Name="recMktngPgm" Type="xml" Comment=""/>
    <variable Name="recSubscrptnOpt" Type="xml" Comment=""/>
    <variable Name="recRegisPrsna" Type="xml" Comment=""/>
    <variable Name="mktngPgmDetails" Type="xml" Comment=""/>
    <variable Name="subscrptnDetails" Type="xml" Comment=""/>
    <variable Name="matchdCnsmrDetails" Type="xml" Comment=""/>
    <variable Name="regisCnsmrDetails" Type="xml" Comment=""/>
    <variable Name="searchResultOpt" Type="xml" Comment=""/>
    <variable Name="rec" Type="xml" Comment=""/>
    <variable Name="var1" Type="string" Comment=""/>
    <variable Name="varMC" Type="string" Comment=""/>
    <variable Name="varRG" Type="string" Comment=""/>
    <variable Name="prsnaIdsFinal2" Type="string" Comment=""/>
    <variable Name="mktngIdsFinal2" Type="string" Comment=""/>
    <variable Name="ManageOpts" Type="xml" Comment=""/>
    <variable Name="LEGAL_ENT_num" Type="string" Comment=""/>
    <variable Name="LEGAL_ENT" Type="string" Comment=""/>
    <variable Name="thisParamBack" Type="xml" Comment=""/>
  </variables>
  <nodes>
    <start Name="start0">
      <actions>
        <action>
          <IF_TEST Test="$userAction='ManageOpts'">
            <THEN>
              <TO_DOCVAR AssignToVar="thisParamBack">
                <ROOT>
                  <TO_XML SelectList="$thisParam/PARAMETERS/*"/>
                  <TO_XML SelectList="$thisParam/RESPONSE/*"/>
                </ROOT>
              </TO_DOCVAR>
              <EXECUTE_SQL_QUERY AssignToVar="StartTimeWf" Value="SELECT current_timestamp as StartTime"/>
              <TO_DOCVAR AssignToVar="ManageOpts">
                <ManageOpts>
                  <Start_time Value="{$workflowName}:{$StartTimeWf/SQL_RESULT/StartTime/@Value}, user Id:{$userName}"/>
                </ManageOpts>
              </TO_DOCVAR>
            </THEN>
          </IF_TEST>
          <SET Var="selectedMatchCnsmrId" FromValue="{$thisParam/Match_Consumer_Id/@Value}"/>
          <SET Var="selectedHshldId" FromValue="{$thisParam/HouseHoldId/@Value}"/>
          <SET Var="selectedLegalEnt" FromValue="{$thisParam/LegalNbr/@Value}"/>
          <!--<EXECUTE_SQL_QUERY Value="{concat('LOCK ROW FOR ACCESS SELECT DISTINCT MKTNG_PGM_NBR,MKTNG_PGM_NAME FROM  V_MATCHD_CNSMR_PRSNA WHERE HSHLD_PRSNA_ID=', $selectedHshldId,' ORDER BY MKTNG_PGM_NAME')}" AssignToVar="recMktngPgm" ReturnRowCount="yes" MaxRows="5000"/>-->
          <EXECUTE_SQL_QUERY Value="{concat('LOCK ROW FOR ACCESS SEL MKTNG_PGM_1.MKTNG_PGM_NBR,MKTNG_PGM_NAME FROM REGIS_PRSNA REGIS_PRSNA_1 JOIN MKTNG_PGM MKTNG_PGM_1 ON REGIS_PRSNA_1.MKTNG_PGM_NBR = MKTNG_PGM_1.MKTNG_PGM_NBR WHERE    REGIS_PRSNA_1.MATCHD_CNSMR_PRSNA_ID=', $selectedMatchCnsmrId,' GROUP BY MKTNG_PGM_1.MKTNG_PGM_NBR,MKTNG_PGM_NAME ORDER BY MKTNG_PGM_NAME')}" AssignToVar="recMktngPgm" ReturnRowCount="yes" MaxRows="5000"/>
          <TO_DOCVAR AssignToVar="mktngPgmDetails">
            <mktngDetails>
              <TO_XML SelectList="$recMktngPgm/*"/>
            </mktngDetails>
          </TO_DOCVAR>
          <EXECUTE_SQL_QUERY Value="{concat('LOCK ROW FOR ACCESS SEL MKTNG_PGM_1.MKTNG_PGM_NBR,REGIS_PRSNA_1.REGIS_PRSNA_ID FROM    REGIS_PRSNA REGIS_PRSNA_1 JOIN MKTNG_PGM MKTNG_PGM_1 ON REGIS_PRSNA_1.MKTNG_PGM_NBR = MKTNG_PGM_1.MKTNG_PGM_NBR WHERE    REGIS_PRSNA_1.MATCHD_CNSMR_PRSNA_ID=', $selectedMatchCnsmrId,'GROUP BY MKTNG_PGM_1.MKTNG_PGM_NBR,REGIS_PRSNA_1.REGIS_PRSNA_ID ORDER BY REGIS_PRSNA_ID')}" AssignToVar="recRegisPrsna" ReturnRowCount="yes" MaxRows="5000"/>
          <!--<EXECUTE_SQL_QUERY Value="{concat('LOCK ROW FOR ACCESS SELECT DISTINCT SUBSCRPTN_OPT_NBR,SUBSCRPTN_OPT_NAME FROM  V_MATCHD_CNSMR_PRSNA WHERE HSHLD_PRSNA_ID=', $selectedHshldId,' ORDER BY SUBSCRPTN_OPT_NAME ')}" AssignToVar="recSubscrptnOpt" ReturnRowCount="yes" MaxRows="5000"/>-->
          <FOR_EACH SelectList="$recRegisPrsna/SQL_RESULT" CurrentElement="regisDetails">
            <SET Var="prsnaIds" FromValue="{concat($regisDetails/REGIS_PRSNA_ID/@Value,',')}"/>
            <SET Var="prsnaIdsFinal1" FromValue="{concat($prsnaIdsFinal1,$prsnaIds)}"/>
            <SET Var="mktngIds" FromValue="{concat($regisDetails/MKTNG_PGM_NBR/@Value,',')}"/>
            <SET Var="mktngIdsFinal1" FromValue="{concat($mktngIdsFinal1,$mktngIds)}"/>
          </FOR_EACH>
          <SET Var="prsnaIdsFinal2" FromValue="{subString($prsnaIdsFinal1,0,strlen($prsnaIdsFinal1)-1)}"/>
          <SET Var="mktngIdsFinal2" FromValue="{subString($mktngIdsFinal1,0,strlen($mktngIdsFinal1)-1)}"/>
          <!--GET_DOCUMENT Name="V_MATCHD_CNSMR_PRSNA" AssignToVar="recSubscrptnOpt" DirtyRead="true" MaxRows="5000" HandleException="true" ReturnRowCount="yes">
            <OR>
              <TO_XML SelectList="$recRegisPrsna/SQL_RESULT/REGIS_PRSNA_ID" />
            </OR>
            <OR>
              <TO_XML SelectList="$recRegisPrsna/SQL_RESULT/MKTNG_PGM_NBR" />
            </SELECT>
            <ORDER_BY>
              <SUBSCRPTN_OPT_NBR Sort="Ascending" />
            </ORDER_BY>
          </GET_DOCUMENT-->
          <!--EXECUTE_SQL_QUERY Value="{concat('LOCK ROW FOR ACCESS SELECT DISTINCT SUBSCRPTN_OPT_NBR,SUBSCRPTN_OPT_NAME  FROM  V_MATCHD_CNSMR_PRSNA WHERE REGIS_PRSNA_ID IN (',$prsnaIdsFinal2,') AND MKTNG_PGM_NBR IN (',$mktngIdsFinal2,') ORDER BY SUBSCRPTN_OPT_NBR')}" AssignToVar="recSubscrptnOpt" ReturnRowCount="yes" MaxRows="5000"/-->
          <EXECUTE_SQL_QUERY Value="{concat('LOCKING ROW FOR ACCESS SELECT  REGIS_PRSNA_1.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR ,SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NAME FROM REGIS_PRSNA_POSTL_ADDR REGIS_PRSNA_1 JOIN SUBSCRPTN_OPT SUBSCRPTN_OPT_1 ON REGIS_PRSNA_1.SUBSCRPTN_OPT_NBR=SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NBR AND REGIS_PRSNA_1.MKTNG_PGM_NBR = SUBSCRPTN_OPT_1.MKTNG_PGM_NBR WHERE REGIS_PRSNA_1.REGIS_PRSNA_ID IN (',$prsnaIdsFinal2,') AND REGIS_PRSNA_1.MKTNG_PGM_NBR IN (',$mktngIdsFinal2,') UNION SELECT  REGIS_PRSNA_1.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR ,SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NAME FROM REGIS_PRSNA_PHONE REGIS_PRSNA_1 JOIN SUBSCRPTN_OPT SUBSCRPTN_OPT_1 ON REGIS_PRSNA_1.SUBSCRPTN_OPT_NBR=SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NBR AND REGIS_PRSNA_1.MKTNG_PGM_NBR = SUBSCRPTN_OPT_1.MKTNG_PGM_NBR WHERE REGIS_PRSNA_1.REGIS_PRSNA_ID IN (',$prsnaIdsFinal2,') AND REGIS_PRSNA_1.MKTNG_PGM_NBR IN (',$mktngIdsFinal2,') UNION SELECT  REGIS_PRSNA_1.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR ,SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NAME FROM REGIS_PRSNA_EMAIL_ADDR REGIS_PRSNA_1 JOIN SUBSCRPTN_OPT SUBSCRPTN_OPT_1 ON REGIS_PRSNA_1.SUBSCRPTN_OPT_NBR=SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NBR AND REGIS_PRSNA_1.MKTNG_PGM_NBR = SUBSCRPTN_OPT_1.MKTNG_PGM_NBR WHERE REGIS_PRSNA_1.REGIS_PRSNA_ID IN (',$prsnaIdsFinal2,') AND REGIS_PRSNA_1.MKTNG_PGM_NBR IN (',$mktngIdsFinal2,')')}" AssignToVar="recSubscrptnOpt" ReturnRowCount="yes" MaxRows="5000"/>
          <TO_DOCVAR AssignToVar="subscrptnDetails">
            <subDetails>
              <TO_XML SelectList="$recSubscrptnOpt/*"/>
            </subDetails>
          </TO_DOCVAR>
        </action>
      </actions>
      <next_nodes>
        <next_node Name="Manage Opt"/>
      </next_nodes>
    </start>
    <ui_form2 Name="Manage Opt" ShowInBreadCrumbs="HIDE" Template="manageoptout.pgl" InputFormVar="pglFormInput" OutputFormVar="pglFormOutput">
      <pre_actions>
        <action>
          <SET Var="startRow" FromValue="{$thisParam/START_COUNT/@Value}"/>
          <IF_TEST Test="$thisParam/BUTTON_ID/@Value ='LOAD_DETAILS_INDIVIDUAL' or $thisParam/BUTTON_ID/@Value ='SEARCH'">
            <THEN/>
            <ELSE>
              <!--<EXECUTE_SQL_QUERY Value="{concat('LOCK ROW FOR ACCESS SELECT REGIS_PRSNA_1.MATCHD_CNSMR_PRSNA_ID ,MATCHD_CNSMR_PRSNA_1.HSHLD_PRSNA_ID ,REGIS_PRSNA_1.REGIS_PRSNA_ID ,REGIS_PRSNA_1.MKTNG_PGM_NBR ,REGIS_PRSNA_1.GVN_NAME ,REGIS_PRSNA_1.FAMLY_NAME ,REGIS_PRSNA_1.NATIONAL_ID_NBR ,COALESCE(CHANNEL.ADDR_LINE_1_TXT,'') ||  ' ' || COALESCE(CHANNEL.ADDR_LINE_2_TXT,'') ||   ' ' || COALESCE(CHANNEL.CITY_NAME,'') ||  ' ' || COALESCE(CHANNEL.POSTL_AREA_CODE,'') AS FULL_ADDRESS ,CHANNEL.MKTNG_PGM_NAME ,CHANNEL.EMAIL_ADDR_TXT_1  AS EMAIL_ADDR_TXT_1 ,CHANNEL.FULL_PHONE_NUM_1  AS FULL_PHONE_NUM_1 ,CHANNEL.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR ,CHANNEL.SUBSCRPTN_OPT_IND AS SUBSCRPTN_OPT_IND ,CHANNEL.CNSMR_CHCE_DATETM  AS CNSMR_CHCE_DATETM ,CHANNEL.CNTCT_POINT_TYPE_CODE ,CHANNEL.CNTCT_POINT_TYPE ,CHANNEL.CNTCT_POINT_CATEG_CODE  AS CNTCT_POINT_CATEG_CODE ,CHANNEL.CNTCT_POINT_CATEG_NAME  AS CNTCT_POINT_CATEG_NAME ,CHANNEL.SUBSCRPTN_OPT_NAME FROM REGIS_PRSNA REGIS_PRSNA_1 JOIN MATCHD_CNSMR_PRSNA MATCHD_CNSMR_PRSNA_1 ON REGIS_PRSNA_1.MATCHD_CNSMR_PRSNA_ID=MATCHD_CNSMR_PRSNA_1.MATCHD_CNSMR_PRSNA_ID AND REGIS_PRSNA_1.LEGAL_ENT_NBR=MATCHD_CNSMR_PRSNA_1.LEGAL_ENT_NBR AND   REGIS_PRSNA_1.REGIS_PRSNA_ID IN (',$prsnaIdsFinal2,') AND REGIS_PRSNA_1.MKTNG_PGM_NBR IN  (',$mktngIdsFinal2,')  JOIN  (SELECT PRSNA_POSTL_ADDR_1.REGIS_PRSNA_ID ,PRSNA_POSTL_ADDR_1.MKTNG_PGM_NBR ,PRSNA_POSTL_ADDR_1.ADDR_LINE_1_TXT ,PRSNA_POSTL_ADDR_1.ADDR_LINE_2_TXT ,PRSNA_POSTL_ADDR_1.ADDR_LINE_3_TXT ,PRSNA_POSTL_ADDR_1.STRET_NUM ,PRSNA_POSTL_ADDR_1.STRET_NAME ,PRSNA_POSTL_ADDR_1.APT_NUM ,PRSNA_POSTL_ADDR_1.PO_BOX_NUM ,PRSNA_POSTL_ADDR_1.CITY_NAME ,PRSNA_POSTL_ADDR_1.TERR_CODE ,PRSNA_POSTL_ADDR_1.TERR_CODE AS TERR_NAME ,PRSNA_POSTL_ADDR_1.POSTL_AREA_CODE ,PRSNA_POSTL_ADDR_1.WIN_KEY ,COALESCE(PRSNA_POSTL_ADDR_1.ADDR_LINE_1_TXT,'') ||  ' ' || COALESCE(PRSNA_POSTL_ADDR_1.ADDR_LINE_2_TXT,'') ||   ' ' || COALESCE(PRSNA_POSTL_ADDR_1.CITY_NAME,'') ||  ' ' || COALESCE(PRSNA_POSTL_ADDR_1.POSTL_AREA_CODE,'') AS FULL_ADDRESS ,MKTNG_PGM_1.MKTNG_PGM_NAME ,NULL (INTEGER)   AS  SYS_TARGET_ID ,NULL (VARCHAR(25))  AS SYS_AUTH_ID ,NULL (VARCHAR(25))  AS SYS_SOURCE ,NULL (VARCHAR(70))  AS SYS_CREATED_BY ,NULL (TIMESTAMP(0))  AS SYS_CREATION_DATE ,'ACTIVE'  (VARCHAR(25))  AS  SYS_ENT_STATE ,NULL (VARCHAR(70))  AS SYS_LAST_MODIFIED_BY ,NULL (TIMESTAMP(0))  AS SYS_LAST_MODIFIED_DATE ,NULL (VARCHAR(25))  AS SYS_NC_TYPE ,NULL (VARCHAR(10000))  AS SYS_ERR_CODE ,NULL (VARCHAR(30))  AS SYS_ERR_SVRTY ,NULL (VARCHAR(200))  AS EMAIL_ADDR_TXT_1 ,NULL (SMALLINT) AS PHONE_CNTRY_NBR_1 ,NULL (SMALLINT) AS PHONE_AREA_NBR_1 ,NULL (SMALLINT) AS PHONE_EXCHG_NBR_1 ,NULL  (BIGINT) AS PHONE_LINE_NBR_1 ,NULL (VARCHAR(20)) AS PHONE_EXTSN_NUM_1 ,NULL  (VARCHAR(20))  AS FULL_PHONE_NUM_1 ,PRSNA_POSTL_ADDR_1.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR ,PRSNA_POSTL_ADDR_1.SUBSCRPTN_OPT_IND AS SUBSCRPTN_OPT_IND ,PRSNA_POSTL_ADDR_1.CNSMR_CHCE_DATETM  AS CNSMR_CHCE_DATETM ,'A'  CNTCT_POINT_TYPE_CODE ,'ADDRESS'  CNTCT_POINT_TYPE ,PRSNA_POSTL_ADDR_1.CNTCT_POINT_CATEG_CODE  AS CNTCT_POINT_CATEG_CODE ,CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_NAME  AS CNTCT_POINT_CATEG_NAME ,SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NAME FROM REGIS_PRSNA_POSTL_ADDR PRSNA_POSTL_ADDR_1 JOIN MKTNG_PGM MKTNG_PGM_1 ON PRSNA_POSTL_ADDR_1.MKTNG_PGM_NBR = MKTNG_PGM_1.MKTNG_PGM_NBR JOIN SUBSCRPTN_OPT SUBSCRPTN_OPT_1 ON PRSNA_POSTL_ADDR_1.SUBSCRPTN_OPT_NBR=SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NBR AND PRSNA_POSTL_ADDR_1.MKTNG_PGM_NBR = SUBSCRPTN_OPT_1.MKTNG_PGM_NBR JOIN CNTCT_POINT_CATEG CNTCT_POINT_CATEG_1 ON PRSNA_POSTL_ADDR_1.CNTCT_POINT_CATEG_CODE=CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_CODE WHERE    PRSNA_POSTL_ADDR_1.REGIS_PRSNA_ID IN (',$prsnaIdsFinal2,') AND PRSNA_POSTL_ADDR_1.MKTNG_PGM_NBR IN  (',$mktngIdsFinal2,')  UNION ALL SELECT PRSNA_PHONE_1.REGIS_PRSNA_ID ,PRSNA_PHONE_1.MKTNG_PGM_NBR ,NULL (VARCHAR(500) ) AS ADDR_LINE_1_TXT ,NULL  (VARCHAR(500) )AS ADDR_LINE_2_TXT ,NULL  (VARCHAR(500) )AS ADDR_LINE_3_TXT ,NULL (VARCHAR(20))AS STRET_NUM ,NULL ( VARCHAR(100) )AS STRET_NAME ,NULL (VARCHAR(20) )AS APT_NUM ,NULL (VARCHAR(20) )AS PO_BOX_NUM ,NULL ( VARCHAR(100) )AS CITY_NAME ,NULL ( CHAR(8) )AS TERR_CODE ,NULL ( VARCHAR(100))AS  TERR_NAME ,NULL (VARCHAR(20)) AS POSTL_AREA_CODE ,NULL ( VARCHAR(100) )AS WIN_KEY ,NULL  (VARCHAR(10000))  AS FULL_ADDRESS ,MKTNG_PGM_1.MKTNG_PGM_NAME ,NULL (INTEGER)   AS  SYS_TARGET_ID ,NULL (VARCHAR(25))  AS SYS_AUTH_ID ,NULL (VARCHAR(25))  AS SYS_SOURCE ,NULL (VARCHAR(70))  AS SYS_CREATED_BY ,NULL (TIMESTAMP(0))  AS SYS_CREATION_DATE ,'ACTIVE'  (VARCHAR(25))  AS  SYS_ENT_STATE ,NULL (VARCHAR(70))  AS SYS_LAST_MODIFIED_BY ,NULL (TIMESTAMP(0))  AS SYS_LAST_MODIFIED_DATE ,NULL (VARCHAR(25))  AS SYS_NC_TYPE ,NULL (VARCHAR(10000))  AS SYS_ERR_CODE ,NULL (VARCHAR(30))  AS SYS_ERR_SVRTY ,NULL (VARCHAR(200))  AS EMAIL_ADDR_TXT_1 ,PRSNA_PHONE_1.PHONE_CNTRY_NBR AS PHONE_CNTRY_NBR_1 ,PRSNA_PHONE_1.PHONE_AREA_NBR  AS PHONE_AREA_NBR_1 ,PRSNA_PHONE_1.PHONE_EXCHG_NBR AS PHONE_EXCHG_NBR_1 ,PRSNA_PHONE_1.PHONE_LINE_NBR  AS PHONE_LINE_NBR_1 ,PRSNA_PHONE_1.PHONE_EXTSN_NUM AS PHONE_EXTSN_NUM_1 ,PRSNA_PHONE_1.FULL_PHONE_NUM  AS FULL_PHONE_NUM_1 ,PRSNA_PHONE_1.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR ,PRSNA_PHONE_1.SUBSCRPTN_OPT_IND AS SUBSCRPTN_OPT_IND ,PRSNA_PHONE_1.CNSMR_CHCE_DATETM  AS CNSMR_CHCE_DATETM ,'P'  CNTCT_POINT_TYPE_CODE ,'PHONE'  CNTCT_POINT_TYPE ,PRSNA_PHONE_1.CNTCT_POINT_CATEG_CODE  AS CNTCT_POINT_CATEG_CODE ,CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_NAME  AS CNTCT_POINT_CATEG_NAME ,SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NAME FROM REGIS_PRSNA_PHONE PRSNA_PHONE_1 JOIN MKTNG_PGM MKTNG_PGM_1 ON PRSNA_PHONE_1.MKTNG_PGM_NBR = MKTNG_PGM_1.MKTNG_PGM_NBR JOIN SUBSCRPTN_OPT SUBSCRPTN_OPT_1 ON PRSNA_PHONE_1.SUBSCRPTN_OPT_NBR=SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NBR AND PRSNA_PHONE_1.MKTNG_PGM_NBR = SUBSCRPTN_OPT_1.MKTNG_PGM_NBR JOIN CNTCT_POINT_CATEG CNTCT_POINT_CATEG_1 ON PRSNA_PHONE_1.CNTCT_POINT_CATEG_CODE=CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_CODE WHERE    PRSNA_PHONE_1.REGIS_PRSNA_ID IN (',$prsnaIdsFinal2,') AND PRSNA_PHONE_1.MKTNG_PGM_NBR IN (',$mktngIdsFinal2,') UNION ALL SELECT PRSNA_EMAIL_ADDR_1.REGIS_PRSNA_ID ,PRSNA_EMAIL_ADDR_1.MKTNG_PGM_NBR ,NULL (VARCHAR(500) ) AS ADDR_LINE_1_TXT ,NULL  (VARCHAR(500) )AS ADDR_LINE_2_TXT ,NULL  (VARCHAR(500) )AS ADDR_LINE_3_TXT ,NULL (VARCHAR(20))AS STRET_NUM ,NULL ( VARCHAR(100) )AS STRET_NAME ,NULL (VARCHAR(20) )AS APT_NUM ,NULL (VARCHAR(20) )AS PO_BOX_NUM ,NULL ( VARCHAR(100) )AS CITY_NAME ,NULL ( CHAR(8) )AS TERR_CODE ,NULL ( VARCHAR(100))AS  TERR_NAME ,NULL (VARCHAR(20)) AS POSTL_AREA_CODE ,NULL ( VARCHAR(100) )AS WIN_KEY ,NULL  (VARCHAR(10000))  AS FULL_ADDRESS ,MKTNG_PGM_1.MKTNG_PGM_NAME ,NULL (INTEGER)   AS  SYS_TARGET_ID ,NULL (VARCHAR(25))  AS SYS_AUTH_ID ,NULL (VARCHAR(25))  AS SYS_SOURCE ,NULL (VARCHAR(70))  AS SYS_CREATED_BY ,NULL (TIMESTAMP(0))  AS SYS_CREATION_DATE ,'ACTIVE'  (VARCHAR(25))  AS  SYS_ENT_STATE ,NULL (VARCHAR(70))  AS SYS_LAST_MODIFIED_BY ,NULL (TIMESTAMP(0))  AS SYS_LAST_MODIFIED_DATE ,NULL (VARCHAR(25))  AS SYS_NC_TYPE ,NULL (VARCHAR(10000))  AS SYS_ERR_CODE ,NULL (VARCHAR(30))  AS SYS_ERR_SVRTY ,PRSNA_EMAIL_ADDR_1.EMAIL_ADDR_TXT AS EMAIL_ADDR_TXT_1 ,NULL (SMALLINT) AS PHONE_CNTRY_NBR_1 ,NULL (SMALLINT) AS PHONE_AREA_NBR_1 ,NULL (SMALLINT) AS PHONE_EXCHG_NBR_1 ,NULL  (BIGINT) AS PHONE_LINE_NBR_1 ,NULL (VARCHAR(20)) AS PHONE_EXTSN_NUM_1 ,NULL  (VARCHAR(20))  AS FULL_PHONE_NUM_1 ,PRSNA_EMAIL_ADDR_1.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR ,PRSNA_EMAIL_ADDR_1.SUBSCRPTN_OPT_IND AS SUBSCRPTN_OPT_IND ,PRSNA_EMAIL_ADDR_1.CNSMR_CHCE_DATETM  AS CNSMR_CHCE_DATETM ,'E'  CNTCT_POINT_TYPE_CODE ,'EMAIL'  CNTCT_POINT_TYPE ,PRSNA_EMAIL_ADDR_1.CNTCT_POINT_CATEG_CODE  AS CNTCT_POINT_CATEG_CODE ,CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_NAME  AS CNTCT_POINT_CATEG_NAME ,SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NAME FROM REGIS_PRSNA_EMAIL_ADDR PRSNA_EMAIL_ADDR_1 JOIN MKTNG_PGM MKTNG_PGM_1 ON PRSNA_EMAIL_ADDR_1.MKTNG_PGM_NBR = MKTNG_PGM_1.MKTNG_PGM_NBR JOIN SUBSCRPTN_OPT SUBSCRPTN_OPT_1 ON PRSNA_EMAIL_ADDR_1.SUBSCRPTN_OPT_NBR=SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NBR AND PRSNA_EMAIL_ADDR_1.MKTNG_PGM_NBR = SUBSCRPTN_OPT_1.MKTNG_PGM_NBR JOIN CNTCT_POINT_CATEG CNTCT_POINT_CATEG_1 ON PRSNA_EMAIL_ADDR_1.CNTCT_POINT_CATEG_CODE=CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_CODE WHERE    PRSNA_EMAIL_ADDR_1.REGIS_PRSNA_ID IN (',$prsnaIdsFinal2,') AND PRSNA_EMAIL_ADDR_1.MKTNG_PGM_NBR IN (',$mktngIdsFinal2,')  UNION ALL SELECT PRSNA_SOC_NET_ACCT_1.REGIS_PRSNA_ID ,PRSNA_SOC_NET_ACCT_1.MKTNG_PGM_NBR ,NULL (VARCHAR(500) ) AS ADDR_LINE_1_TXT ,NULL  (VARCHAR(500) )AS ADDR_LINE_2_TXT ,NULL  (VARCHAR(500) )AS ADDR_LINE_3_TXT ,NULL (VARCHAR(20))AS STRET_NUM ,NULL ( VARCHAR(100) )AS STRET_NAME ,NULL (VARCHAR(20) )AS APT_NUM ,NULL (VARCHAR(20) )AS PO_BOX_NUM ,NULL ( VARCHAR(100) )AS CITY_NAME ,NULL ( CHAR(8) )AS TERR_CODE ,NULL ( VARCHAR(100))AS  TERR_NAME ,NULL (VARCHAR(20)) AS POSTL_AREA_CODE ,NULL ( VARCHAR(100) )AS WIN_KEY ,NULL  (VARCHAR(10000))  AS FULL_ADDRESS ,MKTNG_PGM_1.MKTNG_PGM_NAME ,NULL (INTEGER)   AS  SYS_TARGET_ID ,NULL (VARCHAR(25))  AS SYS_AUTH_ID ,NULL (VARCHAR(25))  AS SYS_SOURCE ,NULL (VARCHAR(70))  AS SYS_CREATED_BY ,NULL (TIMESTAMP(0))  AS SYS_CREATION_DATE ,'ACTIVE'  (VARCHAR(25))  AS  SYS_ENT_STATE ,NULL (VARCHAR(70))  AS SYS_LAST_MODIFIED_BY ,NULL (TIMESTAMP(0))  AS SYS_LAST_MODIFIED_DATE ,NULL (VARCHAR(25))  AS SYS_NC_TYPE ,NULL (VARCHAR(10000))  AS SYS_ERR_CODE ,NULL (VARCHAR(30))  AS SYS_ERR_SVRTY ,NULL (VARCHAR(200))  AS EMAIL_ADDR_TXT_1 ,NULL (SMALLINT) AS PHONE_CNTRY_NBR_1 ,NULL (SMALLINT) AS PHONE_AREA_NBR_1 ,NULL (SMALLINT) AS PHONE_EXCHG_NBR_1 ,NULL  (BIGINT) AS PHONE_LINE_NBR_1 ,NULL (VARCHAR(20)) AS PHONE_EXTSN_NUM_1 ,NULL  (VARCHAR(20))  AS FULL_PHONE_NUM_1 ,PRSNA_SOC_NET_ACCT_1.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR ,PRSNA_SOC_NET_ACCT_1.SUBSCRPTN_OPT_IND AS SUBSCRPTN_OPT_IND ,PRSNA_SOC_NET_ACCT_1.CNSMR_CHCE_DATETM  AS CNSMR_CHCE_DATETM ,'S'  CNTCT_POINT_TYPE_CODE ,'Social'  CNTCT_POINT_TYPE ,PRSNA_SOC_NET_ACCT_1.CNTCT_POINT_CATEG_CODE  AS CNTCT_POINT_CATEG_CODE ,CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_NAME  AS CNTCT_POINT_CATEG_NAME ,SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NAME FROM REGIS_PRSNA_SOC_NET_ACCT  PRSNA_SOC_NET_ACCT_1 JOIN MKTNG_PGM MKTNG_PGM_1 ON PRSNA_SOC_NET_ACCT_1.MKTNG_PGM_NBR = MKTNG_PGM_1.MKTNG_PGM_NBR JOIN SUBSCRPTN_OPT SUBSCRPTN_OPT_1 ON PRSNA_SOC_NET_ACCT_1.SUBSCRPTN_OPT_NBR=SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NBR AND PRSNA_SOC_NET_ACCT_1.MKTNG_PGM_NBR = SUBSCRPTN_OPT_1.MKTNG_PGM_NBR JOIN CNTCT_POINT_CATEG CNTCT_POINT_CATEG_1 ON PRSNA_SOC_NET_ACCT_1.CNTCT_POINT_CATEG_CODE=CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_CODE WHERE    PRSNA_SOC_NET_ACCT_1.REGIS_PRSNA_ID IN (',$prsnaIdsFinal2,') AND PRSNA_SOC_NET_ACCT_1.MKTNG_PGM_NBR IN (',$mktngIdsFinal2,') )CHANNEL ON CHANNEL.REGIS_PRSNA_ID=REGIS_PRSNA_1.REGIS_PRSNA_ID AND CHANNEL.MKTNG_PGM_NBR=REGIS_PRSNA_1.MKTNG_PGM_NBR')}" AssignToVar="rec" ReturnRowCount="yes" MaxRows="5000"/>-->
              <EXECUTE_SQL_QUERY Value="LOCK ROW FOR ACCESS SELECT REGIS_PRSNA_1.MATCHD_CNSMR_PRSNA_ID ,MATCHD_CNSMR_PRSNA_1.HSHLD_PRSNA_ID , REGIS_PRSNA_1.REGIS_PRSNA_ID ,REGIS_PRSNA_1.MKTNG_PGM_NBR ,REGIS_PRSNA_1.GVN_NAME , REGIS_PRSNA_1.FAMLY_NAME ,REGIS_PRSNA_1.NATIONAL_ID_NBR ,COALESCE(CHANNEL.ADDR_LINE_1_TXT, '') ||  ' ' || COALESCE(CHANNEL.ADDR_LINE_2_TXT,'') ||   ' ' || COALESCE(CHANNEL.CITY_NAME, '') ||  ' ' || COALESCE(CHANNEL.POSTL_AREA_CODE,'') AS FULL_ADDRESS , CHANNEL.MKTNG_PGM_NAME ,CHANNEL.EMAIL_ADDR_TXT_1  AS EMAIL_ADDR_TXT_1 , CHANNEL.FULL_PHONE_NUM_1  AS FULL_PHONE_NUM_1 ,CHANNEL.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR , CHANNEL.SUBSCRPTN_OPT_IND AS SUBSCRPTN_OPT_IND ,CHANNEL.CNSMR_CHCE_DATETM  AS CNSMR_CHCE_DATETM , CHANNEL.CNTCT_POINT_TYPE_CODE ,CHANNEL.CNTCT_POINT_TYPE ,CHANNEL.CNTCT_POINT_CATEG_CODE  AS CNTCT_POINT_CATEG_CODE , CHANNEL.CNTCT_POINT_CATEG_NAME  AS CNTCT_POINT_CATEG_NAME ,CHANNEL.SUBSCRPTN_OPT_NAME FROM REGIS_PRSNA REGIS_PRSNA_1 JOIN MATCHD_CNSMR_PRSNA MATCHD_CNSMR_PRSNA_1 ON REGIS_PRSNA_1.MATCHD_CNSMR_PRSNA_ID=MATCHD_CNSMR_PRSNA_1.MATCHD_CNSMR_PRSNA_ID AND REGIS_PRSNA_1.LEGAL_ENT_NBR=MATCHD_CNSMR_PRSNA_1.LEGAL_ENT_NBR AND   REGIS_PRSNA_1.REGIS_PRSNA_ID IN ({$prsnaIdsFinal2}) AND REGIS_PRSNA_1.MKTNG_PGM_NBR IN  ({$mktngIdsFinal2})  JOIN  ( SELECT PRSNA_POSTL_ADDR_1.REGIS_PRSNA_ID ,PRSNA_POSTL_ADDR_1.MKTNG_PGM_NBR , PRSNA_POSTL_ADDR_1.ADDR_LINE_1_TXT ,PRSNA_POSTL_ADDR_1.ADDR_LINE_2_TXT , PRSNA_POSTL_ADDR_1.ADDR_LINE_3_TXT ,PRSNA_POSTL_ADDR_1.STRET_NUM , PRSNA_POSTL_ADDR_1.STRET_NAME ,PRSNA_POSTL_ADDR_1.APT_NUM ,PRSNA_POSTL_ADDR_1.PO_BOX_NUM , PRSNA_POSTL_ADDR_1.CITY_NAME ,PRSNA_POSTL_ADDR_1.TERR_CODE , PRSNA_POSTL_ADDR_1.TERR_CODE AS TERR_NAME ,PRSNA_POSTL_ADDR_1.POSTL_AREA_CODE , PRSNA_POSTL_ADDR_1.WIN_KEY ,COALESCE(PRSNA_POSTL_ADDR_1.ADDR_LINE_1_TXT, '') ||  ' ' || COALESCE(PRSNA_POSTL_ADDR_1.ADDR_LINE_2_TXT,'') ||   ' ' || COALESCE(PRSNA_POSTL_ADDR_1.CITY_NAME, '') ||  ' ' || COALESCE(PRSNA_POSTL_ADDR_1.POSTL_AREA_CODE,'') AS FULL_ADDRESS , MKTNG_PGM_1.MKTNG_PGM_NAME ,NULL (INTEGER)   AS  SYS_TARGET_ID , NULL (VARCHAR(25))  AS SYS_AUTH_ID ,NULL (VARCHAR(25))  AS SYS_SOURCE , NULL (VARCHAR(70))  AS SYS_CREATED_BY ,NULL (TIMESTAMP(0))  AS SYS_CREATION_DATE , 'ACTIVE'  (VARCHAR(25))  AS  SYS_ENT_STATE ,NULL (VARCHAR(70))  AS SYS_LAST_MODIFIED_BY , NULL (TIMESTAMP(0))  AS SYS_LAST_MODIFIED_DATE ,NULL (VARCHAR(25))  AS SYS_NC_TYPE , NULL (VARCHAR(10000))  AS SYS_ERR_CODE ,NULL (VARCHAR(30))  AS SYS_ERR_SVRTY , NULL (VARCHAR(200))  AS EMAIL_ADDR_TXT_1 ,NULL (SMALLINT) AS PHONE_CNTRY_NBR_1 , NULL (SMALLINT) AS PHONE_AREA_NBR_1 ,NULL (SMALLINT) AS PHONE_EXCHG_NBR_1 , NULL  (BIGINT) AS PHONE_LINE_NBR_1 ,NULL (VARCHAR(20)) AS PHONE_EXTSN_NUM_1 , NULL  (VARCHAR(20))  AS FULL_PHONE_NUM_1 ,PRSNA_POSTL_ADDR_1.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR , PRSNA_POSTL_ADDR_1.SUBSCRPTN_OPT_IND AS SUBSCRPTN_OPT_IND ,PRSNA_POSTL_ADDR_1.CNSMR_CHCE_DATETM  AS CNSMR_CHCE_DATETM , 'A'  CNTCT_POINT_TYPE_CODE ,'ADDRESS'  CNTCT_POINT_TYPE ,PRSNA_POSTL_ADDR_1.CNTCT_POINT_CATEG_CODE  AS CNTCT_POINT_CATEG_CODE , CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_NAME  AS CNTCT_POINT_CATEG_NAME , SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NAME FROM REGIS_PRSNA_POSTL_ADDR PRSNA_POSTL_ADDR_1 JOIN MKTNG_PGM MKTNG_PGM_1 ON PRSNA_POSTL_ADDR_1.MKTNG_PGM_NBR = MKTNG_PGM_1.MKTNG_PGM_NBR JOIN SUBSCRPTN_OPT SUBSCRPTN_OPT_1 ON PRSNA_POSTL_ADDR_1.SUBSCRPTN_OPT_NBR=SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NBR AND PRSNA_POSTL_ADDR_1.MKTNG_PGM_NBR = SUBSCRPTN_OPT_1.MKTNG_PGM_NBR JOIN CNTCT_POINT_CATEG CNTCT_POINT_CATEG_1 ON PRSNA_POSTL_ADDR_1.CNTCT_POINT_CATEG_CODE=CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_CODE WHERE    PRSNA_POSTL_ADDR_1.REGIS_PRSNA_ID IN ({$prsnaIdsFinal2}) AND PRSNA_POSTL_ADDR_1.MKTNG_PGM_NBR IN  ({$mktngIdsFinal2}) UNION ALL SELECT PRSNA_PHONE_1.REGIS_PRSNA_ID ,PRSNA_PHONE_1.MKTNG_PGM_NBR , NULL (VARCHAR(500) ) AS ADDR_LINE_1_TXT ,NULL  (VARCHAR(500) )AS ADDR_LINE_2_TXT , NULL  (VARCHAR(500) )AS ADDR_LINE_3_TXT ,NULL (VARCHAR(20))AS STRET_NUM , NULL ( VARCHAR(100) )AS STRET_NAME ,NULL (VARCHAR(20) )AS APT_NUM , NULL (VARCHAR(20) )AS PO_BOX_NUM ,NULL ( VARCHAR(100) )AS CITY_NAME , NULL ( CHAR(8) )AS TERR_CODE ,NULL ( VARCHAR(100))AS  TERR_NAME , NULL (VARCHAR(20)) AS POSTL_AREA_CODE ,NULL ( VARCHAR(100) )AS WIN_KEY , NULL  (VARCHAR(10000))  AS FULL_ADDRESS ,MKTNG_PGM_1.MKTNG_PGM_NAME , NULL (INTEGER)   AS  SYS_TARGET_ID ,NULL (VARCHAR(25))  AS SYS_AUTH_ID , NULL (VARCHAR(25))  AS SYS_SOURCE ,NULL (VARCHAR(70))  AS SYS_CREATED_BY , NULL (TIMESTAMP(0))  AS SYS_CREATION_DATE ,'ACTIVE'  (VARCHAR(25))  AS  SYS_ENT_STATE , NULL (VARCHAR(70))  AS SYS_LAST_MODIFIED_BY ,NULL (TIMESTAMP(0))  AS SYS_LAST_MODIFIED_DATE , NULL (VARCHAR(25))  AS SYS_NC_TYPE ,NULL (VARCHAR(10000))  AS SYS_ERR_CODE , NULL (VARCHAR(30))  AS SYS_ERR_SVRTY ,NULL (VARCHAR(200))  AS EMAIL_ADDR_TXT_1 , PRSNA_PHONE_1.PHONE_CNTRY_NBR AS PHONE_CNTRY_NBR_1 ,PRSNA_PHONE_1.PHONE_AREA_NBR  AS PHONE_AREA_NBR_1 , PRSNA_PHONE_1.PHONE_EXCHG_NBR AS PHONE_EXCHG_NBR_1 ,PRSNA_PHONE_1.PHONE_LINE_NBR  AS PHONE_LINE_NBR_1 , PRSNA_PHONE_1.PHONE_EXTSN_NUM AS PHONE_EXTSN_NUM_1 ,PRSNA_PHONE_1.FULL_PHONE_NUM  AS FULL_PHONE_NUM_1 , PRSNA_PHONE_1.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR ,PRSNA_PHONE_1.SUBSCRPTN_OPT_IND AS SUBSCRPTN_OPT_IND , PRSNA_PHONE_1.CNSMR_CHCE_DATETM  AS CNSMR_CHCE_DATETM ,'P'  CNTCT_POINT_TYPE_CODE , 'PHONE'  CNTCT_POINT_TYPE ,PRSNA_PHONE_1.CNTCT_POINT_CATEG_CODE  AS CNTCT_POINT_CATEG_CODE , CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_NAME  AS CNTCT_POINT_CATEG_NAME , SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NAME FROM REGIS_PRSNA_PHONE PRSNA_PHONE_1 JOIN MKTNG_PGM MKTNG_PGM_1 ON PRSNA_PHONE_1.MKTNG_PGM_NBR = MKTNG_PGM_1.MKTNG_PGM_NBR JOIN SUBSCRPTN_OPT SUBSCRPTN_OPT_1 ON PRSNA_PHONE_1.SUBSCRPTN_OPT_NBR=SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NBR AND PRSNA_PHONE_1.MKTNG_PGM_NBR = SUBSCRPTN_OPT_1.MKTNG_PGM_NBR JOIN CNTCT_POINT_CATEG CNTCT_POINT_CATEG_1 ON PRSNA_PHONE_1.CNTCT_POINT_CATEG_CODE=CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_CODE WHERE    PRSNA_PHONE_1.REGIS_PRSNA_ID IN ({$prsnaIdsFinal2}) AND PRSNA_PHONE_1.MKTNG_PGM_NBR IN ({$mktngIdsFinal2}) UNION ALL SELECT PRSNA_EMAIL_ADDR_1.REGIS_PRSNA_ID ,PRSNA_EMAIL_ADDR_1.MKTNG_PGM_NBR , NULL (VARCHAR(500) ) AS ADDR_LINE_1_TXT ,NULL  (VARCHAR(500) )AS ADDR_LINE_2_TXT , NULL  (VARCHAR(500) )AS ADDR_LINE_3_TXT ,NULL (VARCHAR(20))AS STRET_NUM , NULL ( VARCHAR(100) )AS STRET_NAME ,NULL (VARCHAR(20) )AS APT_NUM , NULL (VARCHAR(20) )AS PO_BOX_NUM ,NULL ( VARCHAR(100) )AS CITY_NAME , NULL ( CHAR(8) )AS TERR_CODE ,NULL ( VARCHAR(100))AS  TERR_NAME , NULL (VARCHAR(20)) AS POSTL_AREA_CODE ,NULL ( VARCHAR(100) )AS WIN_KEY , NULL  (VARCHAR(10000))  AS FULL_ADDRESS ,MKTNG_PGM_1.MKTNG_PGM_NAME , NULL (INTEGER)   AS  SYS_TARGET_ID ,NULL (VARCHAR(25))  AS SYS_AUTH_ID , NULL (VARCHAR(25))  AS SYS_SOURCE ,NULL (VARCHAR(70))  AS SYS_CREATED_BY , NULL (TIMESTAMP(0))  AS SYS_CREATION_DATE ,'ACTIVE'  (VARCHAR(25))  AS  SYS_ENT_STATE , NULL (VARCHAR(70))  AS SYS_LAST_MODIFIED_BY ,NULL (TIMESTAMP(0))  AS SYS_LAST_MODIFIED_DATE , NULL (VARCHAR(25))  AS SYS_NC_TYPE ,NULL (VARCHAR(10000))  AS SYS_ERR_CODE , NULL (VARCHAR(30))  AS SYS_ERR_SVRTY ,PRSNA_EMAIL_ADDR_1.EMAIL_ADDR_TXT AS EMAIL_ADDR_TXT_1 , NULL (SMALLINT) AS PHONE_CNTRY_NBR_1 ,NULL (SMALLINT) AS PHONE_AREA_NBR_1 , NULL (SMALLINT) AS PHONE_EXCHG_NBR_1 ,NULL  (BIGINT) AS PHONE_LINE_NBR_1 , NULL (VARCHAR(20)) AS PHONE_EXTSN_NUM_1 ,NULL  (VARCHAR(20))  AS FULL_PHONE_NUM_1 , PRSNA_EMAIL_ADDR_1.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR ,PRSNA_EMAIL_ADDR_1.SUBSCRPTN_OPT_IND AS SUBSCRPTN_OPT_IND , PRSNA_EMAIL_ADDR_1.CNSMR_CHCE_DATETM  AS CNSMR_CHCE_DATETM , 'E'  CNTCT_POINT_TYPE_CODE ,'EMAIL'  CNTCT_POINT_TYPE ,PRSNA_EMAIL_ADDR_1.CNTCT_POINT_CATEG_CODE  AS CNTCT_POINT_CATEG_CODE , CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_NAME  AS CNTCT_POINT_CATEG_NAME , SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NAME FROM REGIS_PRSNA_EMAIL_ADDR PRSNA_EMAIL_ADDR_1 JOIN MKTNG_PGM MKTNG_PGM_1 ON PRSNA_EMAIL_ADDR_1.MKTNG_PGM_NBR = MKTNG_PGM_1.MKTNG_PGM_NBR JOIN SUBSCRPTN_OPT SUBSCRPTN_OPT_1 ON PRSNA_EMAIL_ADDR_1.SUBSCRPTN_OPT_NBR=SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NBR AND PRSNA_EMAIL_ADDR_1.MKTNG_PGM_NBR = SUBSCRPTN_OPT_1.MKTNG_PGM_NBR JOIN CNTCT_POINT_CATEG CNTCT_POINT_CATEG_1 ON PRSNA_EMAIL_ADDR_1.CNTCT_POINT_CATEG_CODE=CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_CODE WHERE    PRSNA_EMAIL_ADDR_1.REGIS_PRSNA_ID IN ({$prsnaIdsFinal2}) AND PRSNA_EMAIL_ADDR_1.MKTNG_PGM_NBR IN ({$mktngIdsFinal2}) UNION ALL SELECT PRSNA_SOC_NET_ACCT_1.REGIS_PRSNA_ID ,PRSNA_SOC_NET_ACCT_1.MKTNG_PGM_NBR , NULL (VARCHAR(500) ) AS ADDR_LINE_1_TXT ,NULL  (VARCHAR(500) )AS ADDR_LINE_2_TXT , NULL  (VARCHAR(500) )AS ADDR_LINE_3_TXT ,NULL (VARCHAR(20))AS STRET_NUM , NULL ( VARCHAR(100) )AS STRET_NAME ,NULL (VARCHAR(20) )AS APT_NUM , NULL (VARCHAR(20) )AS PO_BOX_NUM ,NULL ( VARCHAR(100) )AS CITY_NAME , NULL ( CHAR(8) )AS TERR_CODE ,NULL ( VARCHAR(100))AS  TERR_NAME , NULL (VARCHAR(20)) AS POSTL_AREA_CODE ,NULL ( VARCHAR(100) )AS WIN_KEY , NULL  (VARCHAR(10000))  AS FULL_ADDRESS ,MKTNG_PGM_1.MKTNG_PGM_NAME , NULL (INTEGER)   AS  SYS_TARGET_ID ,NULL (VARCHAR(25))  AS SYS_AUTH_ID , NULL (VARCHAR(25))  AS SYS_SOURCE ,NULL (VARCHAR(70))  AS SYS_CREATED_BY , NULL (TIMESTAMP(0))  AS SYS_CREATION_DATE ,'ACTIVE'  (VARCHAR(25))  AS  SYS_ENT_STATE , NULL (VARCHAR(70))  AS SYS_LAST_MODIFIED_BY ,NULL (TIMESTAMP(0))  AS SYS_LAST_MODIFIED_DATE , NULL (VARCHAR(25))  AS SYS_NC_TYPE ,NULL (VARCHAR(10000))  AS SYS_ERR_CODE , NULL (VARCHAR(30))  AS SYS_ERR_SVRTY ,NULL (VARCHAR(200))  AS EMAIL_ADDR_TXT_1 , NULL (SMALLINT) AS PHONE_CNTRY_NBR_1 ,NULL (SMALLINT) AS PHONE_AREA_NBR_1 , NULL (SMALLINT) AS PHONE_EXCHG_NBR_1 ,NULL  (BIGINT) AS PHONE_LINE_NBR_1 , NULL (VARCHAR(20)) AS PHONE_EXTSN_NUM_1 ,NULL  (VARCHAR(20))  AS FULL_PHONE_NUM_1 , PRSNA_SOC_NET_ACCT_1.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR , PRSNA_SOC_NET_ACCT_1.SUBSCRPTN_OPT_IND AS SUBSCRPTN_OPT_IND , PRSNA_SOC_NET_ACCT_1.CNSMR_CHCE_DATETM  AS CNSMR_CHCE_DATETM , 'S'  CNTCT_POINT_TYPE_CODE ,'Social'  CNTCT_POINT_TYPE ,PRSNA_SOC_NET_ACCT_1.CNTCT_POINT_CATEG_CODE  AS CNTCT_POINT_CATEG_CODE , CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_NAME  AS CNTCT_POINT_CATEG_NAME , SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NAME FROM REGIS_PRSNA_SOC_NET_ACCT  PRSNA_SOC_NET_ACCT_1 JOIN MKTNG_PGM MKTNG_PGM_1 ON PRSNA_SOC_NET_ACCT_1.MKTNG_PGM_NBR = MKTNG_PGM_1.MKTNG_PGM_NBR JOIN SUBSCRPTN_OPT SUBSCRPTN_OPT_1 ON PRSNA_SOC_NET_ACCT_1.SUBSCRPTN_OPT_NBR=SUBSCRPTN_OPT_1.SUBSCRPTN_OPT_NBR AND PRSNA_SOC_NET_ACCT_1.MKTNG_PGM_NBR = SUBSCRPTN_OPT_1.MKTNG_PGM_NBR JOIN CNTCT_POINT_CATEG CNTCT_POINT_CATEG_1 ON PRSNA_SOC_NET_ACCT_1.CNTCT_POINT_CATEG_CODE=CNTCT_POINT_CATEG_1.CNTCT_POINT_CATEG_CODE WHERE    PRSNA_SOC_NET_ACCT_1.REGIS_PRSNA_ID IN ({$prsnaIdsFinal2}) AND PRSNA_SOC_NET_ACCT_1.MKTNG_PGM_NBR IN ({$mktngIdsFinal2}) )CHANNEL ON CHANNEL.REGIS_PRSNA_ID=REGIS_PRSNA_1.REGIS_PRSNA_ID AND CHANNEL.MKTNG_PGM_NBR=REGIS_PRSNA_1.MKTNG_PGM_NBR" AssignToVar="rec" ReturnRowCount="yes" MaxRows="5000"/>
              <SET Var="var1" FromValue="no"/>
              <SET Var="varMC" FromValue="Y"/>
              <SET Var="varRG" FromValue="Y"/>
            </ELSE>
          </IF_TEST>
          <SET Var="LEGAL_ENT_NAME" FromValue="{$thisParam/LEGAL_ENT_NAME/@Value}"/>
          <IF_TEST Test="$thisParam/LegalNbr/@Value=39 ">
            <THEN>
              <!--<SET Var="LEGAL_ENT_num" FromValue="{$thisParam/LegalNbr/@Value}"/>
      <EXECUTE_SQL_QUERY AssignToVar="respLegal" Value="LOCKING ROW FOR ACCESS SEL LEGAL_ENT_NAME FROM LEGAL_ENT WHERE LEGAL_ENT_NBR='{$LEGAL_ENT_num}';"/>-->
              <SET Var="LEGAL_ENT_NAME" FromValue="Russia"/>
            </THEN>
          </IF_TEST>
          <!--<IF_TEST Test="$thisParam/BUTTON_ID/@Value !='OPTOUTALL' and $thisParam/BUTTON_ID/@Value !='OPTOUT'">
    <THEN>
      <SET Var="LEGAL_ENT_num" FromValue="{$thisParam/LegalNbr/@Value}"/>
      <EXECUTE_SQL_QUERY AssignToVar="respLegal" Value="LOCKING ROW FOR ACCESS SEL LEGAL_ENT_NAME FROM LEGAL_ENT WHERE LEGAL_ENT_NBR='{$LEGAL_ENT_num}';"/>
    <SET Var="LEGAL_ENT" FromValue="{$respLegal/SQL_RESULT/LEGAL_ENT_NAME/@Value}"/>
    </THEN>
  </IF_TEST>-->
          <TO_DOCVAR AssignToVar="pglFormInput">
            <root>
              <TO_XML SelectList="$rec/*"/>
              <TO_XML SelectList="$mktngPgmDetails"/>
              <TO_XML SelectList="$subscrptnDetails"/>
              <TO_XML SelectList="$matchdCnsmrDetails"/>
              <TO_XML SelectList="$regisCnsmrDetails"/>
              <TO_XML SelectList="$searchResultOpt"/>
              <TotalRowCount Value="{$rec/@TotalRowCount}"/>
              <START_COUNT Value="{$startRow}"/>
              <Message Value="{$msg}"/>
              <DIS_TYPE Value="{$var1}"/>
              <House_hold Value="{$selectedHshldId}"/>
              <varMC1 Value="{$varMC}"/>
              <varRG1 Value="{$varRG}"/>
              <LEGAL_ENT_NAME Value="{$LEGAL_ENT_NAME}"/>
            </root>
          </TO_DOCVAR>
          <IF_TEST Test="$userAction='ManageOpts'">
            <THEN>
              <EXECUTE_SQL_QUERY AssignToVar="EndTimeWf" Value="SELECT current_timestamp as EndTime"/>
              <APPEND_TO_XML DocVar="ManageOpts">
                <End_Time Value="{$workflowName} :{$EndTimeWf/SQL_RESULT/EndTime/@Value}, user Id:{$userName}"/>
              </APPEND_TO_XML>
              <PRINT_TO_FILE File="E:\Teradata\MDM\3.05.02\custom\pngrelease3\log\ConsumerSearchIndividual.log" NewFile="no" SameLine="no" Value="{$ManageOpts}"/>
            </THEN>
          </IF_TEST>
        </action>
      </pre_actions>
      <post_actions>
        <ACTION>
          <IF_TEST Test="$userAction='OPTOUT'">
            <THEN>
              <SET Var="phoneOptOutCnt" FromValue="0"/>
              <SET Var="emailOptOutCnt" FromValue="0"/>
              <SET Var="addressOptOutCnt" FromValue="0"/>
              <SET Var="PrevselectedREGIS_PRSNA_ID" FromValue="0"/>
              <SET Var="PrevselectedMKTNG_PGM_NBR" FromValue="0"/>
              <FOR_EACH SelectList="$thisParam/SELECTED_ITEM" CurrentElement="currElement">
                <SET Var="temp" FromValue="{$currElement/@Value}"/>
                <SET Var="selectedCNTCT_POINT_TYPE_CODE" FromValue="{substringBefore($temp, '#')}"/>
                <SET Var="selectedCNTCT_POINT_TYPE_CODE" FromValue="{substringAfter($selectedCNTCT_POINT_TYPE_CODE, '=')}"/>
                <SET Var="temp" FromValue="{substringAfter($temp, '#')}"/>
                <SET Var="selectedMKTNG_PGM_NBR" FromValue="{substringBefore($temp, '#')}"/>
                <SET Var="selectedMKTNG_PGM_NBR" FromValue="{substringAfter($selectedMKTNG_PGM_NBR, '=')}"/>
                <SET Var="temp" FromValue="{substringAfter($temp, '#')}"/>
                <SET Var="selectedREGIS_PRSNA_ID" FromValue="{substringBefore($temp, '#')}"/>
                <SET Var="selectedREGIS_PRSNA_ID" FromValue="{substringAfter($selectedREGIS_PRSNA_ID, '=')}"/>
                <SET Var="temp" FromValue="{substringAfter($temp, '#')}"/>
                <SET Var="selectedSUBSCRPTN_OPT_NBR" FromValue="{substringBefore($temp, '#')}"/>
                <SET Var="selectedSUBSCRPTN_OPT_NBR" FromValue="{substringAfter($selectedSUBSCRPTN_OPT_NBR, '=')}"/>
                <SET Var="temp" FromValue="{substringAfter($temp, '#')}"/>
                <SET Var="selectedCNTCT_POINT_CATEG_CODE" FromValue="{substringBefore($temp, '#')}"/>
                <SET Var="selectedCNTCT_POINT_CATEG_CODE" FromValue="{substringAfter($selectedCNTCT_POINT_CATEG_CODE, '=')}"/>
                <TO_DOCVAR AssignToVar="WHERE_CLAUSE">
                  <WHERE_CLAUSE>
                    <REGIS_PRSNA_ID Value="{$selectedREGIS_PRSNA_ID}"/>
                    <MKTNG_PGM_NBR Value="{$selectedMKTNG_PGM_NBR}"/>
                    <SUBSCRPTN_OPT_NBR Value="{$selectedSUBSCRPTN_OPT_NBR}"/>
                    <CNTCT_POINT_CATEG_CODE Value="{$selectedCNTCT_POINT_CATEG_CODE}"/>
                  </WHERE_CLAUSE>
                </TO_DOCVAR>
                <PRINTLN Value="{$WHERE_CLAUSE}"/>
                <!--EXECUTE_SQL_QUERY Value="LOCK ROW FOR ACCESS SELECT * FROM V_MATCHD_CNSMR_PRSNA WHERE REGIS_PRSNA_ID='{$selectedREGIS_PRSNA_ID}' AND MKTNG_PGM_NBR= '{$selectedMKTNG_PGM_NBR}' AND CNTCT_POINT_CATEG_CODE='{$selectedCNTCT_POINT_CATEG_CODE}' AND SUBSCRPTN_OPT_NBR=COALESCE('{$selectedSUBSCRPTN_OPT_NBR}',0)" AssignToVar="respQuery" ReturnRowCount="yes"/-->
                <IF_TEST Test="$selectedCNTCT_POINT_TYPE_CODE='E'">
                  <THEN>
                    <PRINTLN Value="Inside Email"/>
                    <EXECUTE_SQL_QUERY Value="LOCK ROW FOR ACCESS SELECT RP.REGIS_PRSNA_ID,RP.MKTNG_PGM_NBR,RP.LEGAL_ENT_NBR,DATA_ORIGIN_SRCE_NBR,SUBSCRPTN_OPT_NBR,GVN_NAME,FAMLY_NAME,EMAIL_ADDR_TXT,NATIONAL_ID_NBR FROM REGIS_PRSNA RP JOIN REGIS_PRSNA_EMAIL_ADDR EMAIL ON RP.MKTNG_PGM_NBR=EMAIL.MKTNG_PGM_NBR AND RP.REGIS_PRSNA_ID=EMAIL.REGIS_PRSNA_ID WHERE RP.REGIS_PRSNA_ID='{$selectedREGIS_PRSNA_ID}' AND RP.MKTNG_PGM_NBR= '{$selectedMKTNG_PGM_NBR}' AND CNTCT_POINT_CATEG_CODE='{$selectedCNTCT_POINT_CATEG_CODE}' AND SUBSCRPTN_OPT_NBR=COALESCE('{$selectedSUBSCRPTN_OPT_NBR}',0)" AssignToVar="respQuery" ReturnRowCount="yes"/>
                    <!--<MODIFY_DOC_SMART Name="REGIS_PRSNA_EMAIL_ADDR" ServiceName="BCM_MASTER" AssignToVar="respEmail">
                      <DOCUMENT_CONTEXT>
                        <TO_XML SelectList="$WHERE_CLAUSE/*"/>
                      </DOCUMENT_CONTEXT>
                      <UPDATE_PROPERTIES>
                        <SUBSCRPTN_OPT_IND Value="O"/>
                        <CNSMR_CHCE_DATETM Value="{date()}"/>
                      </UPDATE_PROPERTIES>
                    </MODIFY_DOC_SMART>-->
                    <SET Var="emailOptOutCnt" FromValue="{$emailOptOutCnt+1}"/>
                    <IF_TEST Test="$respQuery/@TotalRowCount!=0">
                      <THEN>
                        <!--<ADD_DOCUMENT Name="REGIS_PRSNA_OPT_HIST" ServiceName="BCM_MASTER" AssignToVar="respADD">
                          <REGIS_PRSNA_ID Value="-{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                          <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                          <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                          <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                          <CHANNEL_IND Value="E"/>
                          <OPT_LEVEL_IND Value="R"/>
                          <OPT_TIME Value="{date()}"/>
                          <LAST_ACTIVITY_TM Value="{date()}"/>
                        </ADD_DOCUMENT>-->
                        <CREATE_DOCUMENT_ID Name="OPT_OUT_NOT_FOUND" AssignToVar="PE_OPTOUT_ID"/>
                        <ADD_DOC_SMART Name="V_PE_OPT_OUT" ServiceName="BCM_MASTER" AssignToVar="respADD">
                          <PE_OPTOUT_ID Value="{$PE_OPTOUT_ID/@Value}"/>
                          <STATUS_FLG Value="Submitted"/>
                          <REGIS_PRSNA_ID Value="{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                          <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                          <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                          <DATA_SRCE_NBR Value="{$respQuery/SQL_RESULT/DATA_ORIGIN_SRCE_NBR/@Value}"/>
                          <SUBSCRPTN_OPT_NBR Value="{$respQuery/SQL_RESULT/SUBSCRPTN_OPT_NBR/@Value}"/>
                          <GVN_NAME Value="{$respQuery/SQL_RESULT/GVN_NAME/@Value}"/>
                          <FAMLY_NAME Value="{$respQuery/SQL_RESULT/FAMLY_NAME/@Value}"/>
                          <EMAIL_ADDR_TEXT Value="{$respQuery/SQL_RESULT/EMAIL_ADDR_TXT/@Value}"/>
                          <OPT_IND Value="O"/>
                          <LOG_SOURCE_ID Value="-999999"/>
                          <LOG_UPDATE_USER Value="{$userId}"/>
                          <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                          <CHANNEL_IND Value="E"/>
                          <OPT_LEVEL_IND Value="R"/>
                          <OPT_TIME Value="{date()}"/>
                          <LAST_ACTIVITY_TM Value="{date()}"/>
                        </ADD_DOC_SMART>
                      </THEN>
                    </IF_TEST>
                  </THEN>
                </IF_TEST>
                <IF_TEST Test="$selectedCNTCT_POINT_TYPE_CODE='P'">
                  <THEN>
                    <PRINTLN Value="Inside Phone"/>
                    <EXECUTE_SQL_QUERY Value="LOCK ROW FOR ACCESS SELECT RP.REGIS_PRSNA_ID,RP.MKTNG_PGM_NBR,RP.LEGAL_ENT_NBR,DATA_ORIGIN_SRCE_NBR,SUBSCRPTN_OPT_NBR,GVN_NAME,FAMLY_NAME,FULL_PHONE_NUM,NATIONAL_ID_NBR FROM REGIS_PRSNA RP JOIN REGIS_PRSNA_PHONE PH ON RP.MKTNG_PGM_NBR=PH.MKTNG_PGM_NBR AND RP.REGIS_PRSNA_ID=PH.REGIS_PRSNA_ID WHERE RP.REGIS_PRSNA_ID='{$selectedREGIS_PRSNA_ID}' AND RP.MKTNG_PGM_NBR= '{$selectedMKTNG_PGM_NBR}' AND CNTCT_POINT_CATEG_CODE='{$selectedCNTCT_POINT_CATEG_CODE}' AND SUBSCRPTN_OPT_NBR=COALESCE('{$selectedSUBSCRPTN_OPT_NBR}',0)" AssignToVar="respQuery" ReturnRowCount="yes"/>
                    <!--<MODIFY_DOC_SMART Name="REGIS_PRSNA_PHONE" ServiceName="BCM_MASTER" AssignToVar="respPhone">
                      <DOCUMENT_CONTEXT>
                        <TO_XML SelectList="$WHERE_CLAUSE/*"/>
                      </DOCUMENT_CONTEXT>
                      <UPDATE_PROPERTIES>
                        <SUBSCRPTN_OPT_IND Value="O"/>
                        <CNSMR_CHCE_DATETM Value="{date()}"/>
                      </UPDATE_PROPERTIES>
                    </MODIFY_DOC_SMART>-->
                    <SET Var="phoneOptOutCnt" FromValue="{$phoneOptOutCnt+1}"/>
                    <IF_TEST Test="$respQuery/@TotalRowCount!=0">
                      <THEN>
                        <!--<ADD_DOCUMENT Name="REGIS_PRSNA_OPT_HIST" ServiceName="BCM_MASTER" AssignToVar="respADD">
                          <REGIS_PRSNA_ID Value="-{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                          <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                          <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                          <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                          <CHANNEL_IND Value="P"/>
                          <OPT_LEVEL_IND Value="R"/>
                          <OPT_TIME Value="{date()}"/>
                          <LAST_ACTIVITY_TM Value="{date()}"/>
                        </ADD_DOCUMENT>-->
                        <CREATE_DOCUMENT_ID Name="OPT_OUT_NOT_FOUND" AssignToVar="PE_OPTOUT_ID"/>
                        <ADD_DOC_SMART Name="V_PE_OPT_OUT" ServiceName="BCM_MASTER" AssignToVar="respADD">
                          <PE_OPTOUT_ID Value="{$PE_OPTOUT_ID/@Value}"/>
                          <STATUS_FLG Value="Submitted"/>
                          <REGIS_PRSNA_ID Value="{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                          <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                          <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                          <DATA_SRCE_NBR Value="{$respQuery/SQL_RESULT/DATA_ORIGIN_SRCE_NBR/@Value}"/>
                          <SUBSCRPTN_OPT_NBR Value="{$respQuery/SQL_RESULT/SUBSCRPTN_OPT_NBR/@Value}"/>
                          <GVN_NAME Value="{$respQuery/SQL_RESULT/GVN_NAME/@Value}"/>
                          <FAMLY_NAME Value="{$respQuery/SQL_RESULT/FAMLY_NAME/@Value}"/>
                          <FULL_PHONE_NUM Value="{$respQuery/SQL_RESULT/FULL_PHONE_NUM/@Value}"/>
                          <OPT_IND Value="O"/>
                          <LOG_SOURCE_ID Value="-999999"/>
                          <LOG_UPDATE_USER Value="{$userId}"/>
                          <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                          <CHANNEL_IND Value="P"/>
                          <OPT_LEVEL_IND Value="R"/>
                          <OPT_TIME Value="{date()}"/>
                          <LAST_ACTIVITY_TM Value="{date()}"/>
                        </ADD_DOC_SMART>
                      </THEN>
                    </IF_TEST>
                  </THEN>
                </IF_TEST>
                <IF_TEST Test="$selectedCNTCT_POINT_TYPE_CODE='A'">
                  <THEN>
                    <PRINTLN Value="Inside Postal"/>
                    <EXECUTE_SQL_QUERY Value="LOCK ROW FOR ACCESS SELECT RP.REGIS_PRSNA_ID,RP.MKTNG_PGM_NBR,RP.LEGAL_ENT_NBR,DATA_ORIGIN_SRCE_NBR,SUBSCRPTN_OPT_NBR,GVN_NAME,FAMLY_NAME,ADDR_LINE_1_TXT,ADDR_LINE_2_TXT,ADDR_LINE_3_TXT,CITY_NAME,TERR_NAME,POSTL_AREA_CODE,POST.CNTRY_CODE,NATIONAL_ID_NBR FROM REGIS_PRSNA RP JOIN REGIS_PRSNA_POSTL_ADDR POST ON RP.MKTNG_PGM_NBR=POST.MKTNG_PGM_NBR AND RP.REGIS_PRSNA_ID=POST.REGIS_PRSNA_ID WHERE RP.REGIS_PRSNA_ID='{$selectedREGIS_PRSNA_ID}' AND RP.MKTNG_PGM_NBR= '{$selectedMKTNG_PGM_NBR}' AND CNTCT_POINT_CATEG_CODE='{$selectedCNTCT_POINT_CATEG_CODE}' AND SUBSCRPTN_OPT_NBR=COALESCE('{$selectedSUBSCRPTN_OPT_NBR}',0)" AssignToVar="respQuery" ReturnRowCount="yes"/>
                    <!--<MODIFY_DOC_SMART Name="REGIS_PRSNA_POSTL_ADDR" ServiceName="BCM_MASTER" AssignToVar="respPostal">
                      <DOCUMENT_CONTEXT>
                        <TO_XML SelectList="$WHERE_CLAUSE/*"/>
                      </DOCUMENT_CONTEXT>
                      <UPDATE_PROPERTIES>
                        <SUBSCRPTN_OPT_IND Value="O"/>
                        <CNSMR_CHCE_DATETM Value="{date()}"/>
                      </UPDATE_PROPERTIES>
                    </MODIFY_DOC_SMART>-->
                    <SET Var="addressOptOutCnt" FromValue="{$addressOptOutCnt+1}"/>
                    <IF_TEST Test="$respQuery/@TotalRowCount!=0">
                      <THEN>
                        <!--<ADD_DOCUMENT Name="REGIS_PRSNA_OPT_HIST" ServiceName="BCM_MASTER" AssignToVar="respADD">
                          <REGIS_PRSNA_ID Value="-{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                          <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                          <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                          <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                          <CHANNEL_IND Value="A"/>
                          <OPT_LEVEL_IND Value="R"/>
                          <OPT_TIME Value="{date()}"/>
                          <LAST_ACTIVITY_TM Value="{date()}"/>
                        </ADD_DOCUMENT>-->
                        <CREATE_DOCUMENT_ID Name="OPT_OUT_NOT_FOUND" AssignToVar="PE_OPTOUT_ID"/>
                        <ADD_DOC_SMART Name="V_PE_OPT_OUT" ServiceName="BCM_MASTER" AssignToVar="respADD">
                          <PE_OPTOUT_ID Value="{$PE_OPTOUT_ID/@Value}"/>
                          <STATUS_FLG Value="Submitted"/>
                          <REGIS_PRSNA_ID Value="{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                          <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                          <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                          <DATA_SRCE_NBR Value="{$respQuery/SQL_RESULT/DATA_ORIGIN_SRCE_NBR/@Value}"/>
                          <SUBSCRPTN_OPT_NBR Value="{$respQuery/SQL_RESULT/SUBSCRPTN_OPT_NBR/@Value}"/>
                          <GVN_NAME Value="{$respQuery/SQL_RESULT/GVN_NAME/@Value}"/>
                          <FAMLY_NAME Value="{$respQuery/SQL_RESULT/FAMLY_NAME/@Value}"/>
                          <SRC_ADDR_LINE_1_TXT Value="{$respQuery/SQL_RESULT/ADDR_LINE_1_TXT/@Value}"/>
                          <SRC_ADDR_LINE_2_TXT Value="{$respQuery/SQL_RESULT/ADDR_LINE_2_TXT/@Value}"/>
                          <SRC_ADDR_LINE_3_TXT Value="{$respQuery/SQL_RESULT/ADDR_LINE_3_TXT/@Value}"/>
                          <SRC_CITY_NAME Value="{$respQuery/SQL_RESULT/CITY_NAME/@Value}"/>
                          <SRC_TERR_NAME Value="{$respQuery/SQL_RESULT/TERR_NAME/@Value}"/>
                          <SRC_POSTAL_AREA_CODE Value="{$respQuery/SQL_RESULT/POSTL_AREA_CODE/@Value}"/>
                          <SRC_CNTRY_NAME Value="{$respQuery/SQL_RESULT/CNTRY_CODE/@Value}"/>
                          <OPT_IND Value="O"/>
                          <LOG_SOURCE_ID Value="-999999"/>
                          <LOG_UPDATE_USER Value="{$userId}"/>
                          <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                          <CHANNEL_IND Value="A"/>
                          <OPT_LEVEL_IND Value="R"/>
                          <OPT_TIME Value="{date()}"/>
                          <LAST_ACTIVITY_TM Value="{date()}"/>
                        </ADD_DOC_SMART>
                      </THEN>
                    </IF_TEST>
                  </THEN>
                </IF_TEST>
                <!--<IF_TEST Test="$PrevselectedREGIS_PRSNA_ID != $selectedREGIS_PRSNA_ID">
                        <SYS_LAST_MODIFIED_DATE Value="{date()}"/>
                        <LATST_ACTVY_DATE Value="{date()}"/>
                      </UPDATE_PROPERTIES>
                    </MODIFY_DOC_SMART>
                  </THEN>
                </IF_TEST>-->
                <SET Var="PrevselectedREGIS_PRSNA_ID" FromValue="{$selectedREGIS_PRSNA_ID}"/>
                <SET Var="PrevselectedMKTNG_PGM_NBR" FromValue="{$selectedMKTNG_PGM_NBR}"/>
              </FOR_EACH>
              <SET Var="msg" FromValue="No. of Postal opt out count: {substringBefore($addressOptOutCnt,'.')},No. of Email opt out count: {substringBefore($emailOptOutCnt,'.')}, No. of Phone opt out count: {substringBefore($phoneOptOutCnt,'.')} :: Opt Outs submitted successfully. Opt Outs would be processed within 6 hours. To verify the status of the submitted Opt Outs, please use the Profile Editor Opt Out Report link"/>
              <REMOVE_CHILDREN ChildName="SELECTED_ITEM" DocVar="thisParam"/>
            </THEN>
          </IF_TEST>
          <IF_TEST Test="$userAction='SEARCH'">
            <THEN>
              <TO_DOCVAR AssignToVar="searchParameter">
                <ABC>
                  <TO_XML SelectList="$thisParam/MKTNG_PGM_NAME"/>
                  <TO_XML SelectList="$thisParam/SUBSCRPTN_OPT_NAME"/>
                  <TO_XML SelectList="$thisParam/CNTCT_POINT_TYPE_CODE"/>
                  <TO_XML SelectList="$thisParam/MATCHD_CNSMR_PRSNA_ID"/>
                  <TO_XML SelectList="$thisParam/REGIS_PRSNA_ID"/>
                  <HSHLD_PRSNA_ID Value="{$selectedHshldId}"/>
                </ABC>
              </TO_DOCVAR>
              <IF_TEST Test="$searchParameter/MATCHD_CNSMR_PRSNA_ID/@Value='' or $searchParameter/REGIS_PRSNA_ID/@Value=''">
                <THEN>
                  <IF_TEST Test="$searchParameter/MATCHD_CNSMR_PRSNA_ID/@Value='' and $searchParameter/REGIS_PRSNA_ID/@Value=''">
                    <THEN>
                      <REMOVE_CHILDREN ChildName="MATCHD_CNSMR_PRSNA_ID" DocVar="searchParameter"/>
                      <REMOVE_CHILDREN ChildName="REGIS_PRSNA_ID" DocVar="searchParameter"/>
                    </THEN>
                    <ELSE>
                      <THEN>
                        <IF_TEST Test="$searchParameter/MATCHD_CNSMR_PRSNA_ID/@Value=''">
                          <THEN>
                            <REMOVE_CHILDREN ChildName="MATCHD_CNSMR_PRSNA_ID" DocVar="searchParameter"/>
                          </THEN>
                          <ELSE>
                            <THEN>
                              <REMOVE_CHILDREN ChildName="REGIS_PRSNA_ID" DocVar="searchParameter"/>
                            </THEN>
                          </ELSE>
                        </IF_TEST>
                      </THEN>
                    </ELSE>
                  </IF_TEST>
                </THEN>
              </IF_TEST>
              <IF_TEST Test="$searchParameter/MKTNG_PGM_NAME/@Value=''">
                <THEN>
                  <REMOVE_CHILDREN ChildName="MKTNG_PGM_NAME" DocVar="searchParameter"/>
                </THEN>
              </IF_TEST>
              <IF_TEST Test="$searchParameter/SUBSCRPTN_OPT_NAME/@Value=''">
                <THEN>
                  <REMOVE_CHILDREN ChildName="SUBSCRPTN_OPT_NAME" DocVar="searchParameter"/>
                </THEN>
              </IF_TEST>
              <IF_TEST Test="$searchParameter/CNTCT_POINT_TYPE_CODE/@Value=''">
                <THEN>
                  <REMOVE_CHILDREN ChildName="CNTCT_POINT_TYPE_CODE" DocVar="searchParameter"/>
                </THEN>
              </IF_TEST>
              <GET_DOCUMENT Name="V_MATCHD_CNSMR_PRSNA" AssignToVar="searchResultOpt" DirtyRead="true" MaxRows="5000" HandleException="true" ReturnRowCount="yes">
                <TO_XML SelectList="$searchParameter/*"/>
                <SELECT>
                  <HSHLD_PRSNA_ID/>
                  <MATCHD_CNSMR_PRSNA_ID/>
                  <REGIS_PRSNA_ID/>
                  <GVN_NAME/>
                  <FAMLY_NAME/>
                  <NATIONAL_ID_NBR/>
                  <MKTNG_PGM_NBR/>
                  <MKTNG_PGM_NAME/>
                  <EMAIL_ADDR_TXT_1/>
                  <FULL_PHONE_NUM_1/>
                  <FULL_ADDRESS/>
                  <SUBSCRPTN_OPT_NBR/>
                  <SUBSCRPTN_OPT_NAME/>
                  <SUBSCRPTN_OPT_IND/>
                  <CNSMR_CHCE_DATETM/>
                  <CNTCT_POINT_TYPE_CODE/>
                  <CNTCT_POINT_CATEG_CODE/>
                  <CNTCT_POINT_TYPE/>
                  <CNTCT_POINT_CATEG_NAME/>
                </SELECT>
                <ORDER_BY>
                  <REGIS_PRSNA_ID Sort="Ascending"/>
                </ORDER_BY>
              </GET_DOCUMENT>
              <SET Var="var1" FromValue="yes"/>
              <SET DocVar="rec" FromDocVar=""/>
              <!--REMOVE_CHILDREN DocVar="rec" /-->
            </THEN>
          </IF_TEST>
          <IF_TEST Test="$thisParam/BUTTON_ID/@Value='LOAD_DETAILS_INDIVIDUAL'">
            <THEN>
              <IF_TEST Test="$thisParam/LEVEL/@Value='HH'">
                <THEN>
                  <TO_DOCVAR AssignToVar="matchdCnsmrDetails">
                    <mtchdDetails/>
                  </TO_DOCVAR>
                  <TO_DOCVAR AssignToVar="regisCnsmrDetails">
                    <regisDetails/>
                  </TO_DOCVAR>
                  <SET Var="varMC" FromValue="N"/>
                  <SET Var="varRG" FromValue="N"/>
                </THEN>
              </IF_TEST>
              <IF_TEST Test="$thisParam/LEVEL/@Value='MC'">
                <THEN>
                  <EXECUTE_SQL_QUERY Value="{concat('LOCK ROW FOR ACCESS SELECT DISTINCT MATCHD_CNSMR_PRSNA_ID FROM  MATCHD_CNSMR_PRSNA WHERE HSHLD_PRSNA_ID=', $selectedHshldId,' AND LEGAL_ENT_NBR=', $selectedLegalEnt,' ORDER BY MATCHD_CNSMR_PRSNA_ID')}" AssignToVar="recMatchdCnsmr" ReturnRowCount="yes" MaxRows="5000"/>
                  <TO_DOCVAR AssignToVar="matchdCnsmrDetails">
                    <mtchdDetails>
                      <TO_XML SelectList="$recMatchdCnsmr/*"/>
                    </mtchdDetails>
                  </TO_DOCVAR>
                  <SET Var="varRG" FromValue="N"/>
                  <SET Var="varMC" FromValue="Y"/>
                </THEN>
              </IF_TEST>
              <IF_TEST Test="$thisParam/LEVEL/@Value='RG'">
                <THEN>
                  <TO_DOCVAR AssignToVar="regisCnsmrDetails">
                    <regisDetails>
                      <!--   <TO_XML SelectList="$recRegisCnsmr/*" />-->
                      <TO_XML SelectList="$recRegisPrsna/SQL_RESULT/REGIS_PRSNA_ID"/>
                    </regisDetails>
                  </TO_DOCVAR>
                  <SET Var="varMC" FromValue="N"/>
                  <SET Var="varRG" FromValue="Y"/>
                </THEN>
              </IF_TEST>
            </THEN>
          </IF_TEST>
          <IF_TEST Test="$userAction='OPTOUTALL'">
            <THEN>
              <SET Var="recCnt" FromValue="{$rec/@TotalRowCount}"/>
              <SET Var="searchCnt" FromValue="{$searchResultOpt/@TotalRowCount}"/>
              <IF_TEST Test="$recCnt > 0">
                <THEN>
                  <SET Var="phoneOptOutCnt" FromValue="0"/>
                  <SET Var="emailOptOutCnt" FromValue="0"/>
                  <SET Var="addressOptOutCnt" FromValue="0"/>
                  <SET Var="PrevselectedREGIS_PRSNA_ID" FromValue="0"/>
                  <SET Var="PrevselectedMKTNG_PGM_NBR" FromValue="0"/>
                  <!--<FOR_EACH SelectList="$rec/V_MATCHD_CNSMR_PRSNA" CurrentElement="currElement">-->
                  <FOR_EACH SelectList="$rec/SQL_RESULT" CurrentElement="currElement">
                    <SET Var="selectedCNTCT_POINT_TYPE_CODE" FromValue="{$currElement/CNTCT_POINT_TYPE_CODE/@Value}"/>
                    <SET Var="selectedMKTNG_PGM_NBR" FromValue="{$currElement/MKTNG_PGM_NBR/@Value}"/>
                    <SET Var="selectedREGIS_PRSNA_ID" FromValue="{$currElement/REGIS_PRSNA_ID/@Value}"/>
                    <SET Var="selectedSUBSCRPTN_OPT_NBR" FromValue="{$currElement/SUBSCRPTN_OPT_NBR/@Value}"/>
                    <SET Var="selectedCNTCT_POINT_CATEG_CODE" FromValue="{$currElement/CNTCT_POINT_CATEG_CODE/@Value}"/>
                    <TO_DOCVAR AssignToVar="WHERE_CLAUSE">
                      <WHERE_CLAUSE>
                        <REGIS_PRSNA_ID Value="{$selectedREGIS_PRSNA_ID}"/>
                        <MKTNG_PGM_NBR Value="{$selectedMKTNG_PGM_NBR}"/>
                        <SUBSCRPTN_OPT_NBR Value="{$selectedSUBSCRPTN_OPT_NBR}"/>
                        <CNTCT_POINT_CATEG_CODE Value="{$selectedCNTCT_POINT_CATEG_CODE}"/>
                      </WHERE_CLAUSE>
                    </TO_DOCVAR>
                    <PRINTLN Value="{$WHERE_CLAUSE}"/>
                    <!--EXECUTE_SQL_QUERY Value="LOCK ROW FOR ACCESS SELECT * FROM V_MATCHD_CNSMR_PRSNA WHERE REGIS_PRSNA_ID='{$selectedREGIS_PRSNA_ID}' AND MKTNG_PGM_NBR= '{$selectedMKTNG_PGM_NBR}' AND CNTCT_POINT_CATEG_CODE='{$selectedCNTCT_POINT_CATEG_CODE}' AND SUBSCRPTN_OPT_NBR=COALESCE('{$selectedSUBSCRPTN_OPT_NBR}',0)" AssignToVar="respQuery" ReturnRowCount="yes"/-->
                    <IF_TEST Test="$selectedCNTCT_POINT_TYPE_CODE='E'">
                      <THEN>
                        <PRINTLN Value="Inside Email"/>
                        <EXECUTE_SQL_QUERY Value="LOCK ROW FOR ACCESS SELECT RP.REGIS_PRSNA_ID,RP.MKTNG_PGM_NBR,RP.LEGAL_ENT_NBR,DATA_ORIGIN_SRCE_NBR,SUBSCRPTN_OPT_NBR,GVN_NAME,FAMLY_NAME,EMAIL_ADDR_TXT,NATIONAL_ID_NBR FROM REGIS_PRSNA RP JOIN REGIS_PRSNA_EMAIL_ADDR EMAIL ON RP.MKTNG_PGM_NBR=EMAIL.MKTNG_PGM_NBR AND RP.REGIS_PRSNA_ID=EMAIL.REGIS_PRSNA_ID WHERE RP.REGIS_PRSNA_ID='{$selectedREGIS_PRSNA_ID}' AND RP.MKTNG_PGM_NBR= '{$selectedMKTNG_PGM_NBR}' AND CNTCT_POINT_CATEG_CODE='{$selectedCNTCT_POINT_CATEG_CODE}' AND SUBSCRPTN_OPT_NBR=COALESCE('{$selectedSUBSCRPTN_OPT_NBR}',0)" AssignToVar="respQuery" ReturnRowCount="yes"/>
                        <!--<MODIFY_DOC_SMART Name="REGIS_PRSNA_EMAIL_ADDR" ServiceName="BCM_MASTER" AssignToVar="respEmail">
                          <DOCUMENT_CONTEXT>
                            <TO_XML SelectList="$WHERE_CLAUSE/*"/>
                          </DOCUMENT_CONTEXT>
                          <UPDATE_PROPERTIES>
                            <SUBSCRPTN_OPT_IND Value="O"/>
                            <CNSMR_CHCE_DATETM Value="{date()}"/>
                          </UPDATE_PROPERTIES>
                        </MODIFY_DOC_SMART>-->
                        <SET Var="emailOptOutCnt" FromValue="{$emailOptOutCnt+1}"/>
                        <IF_TEST Test="$respQuery/@TotalRowCount!=0">
                          <THEN>
                            <!--<ADD_DOCUMENT Name="REGIS_PRSNA_OPT_HIST" ServiceName="BCM_MASTER" AssignToVar="respADD">
                              <REGIS_PRSNA_ID Value="-{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                              <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                              <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                              <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                              <CHANNEL_IND Value="E"/>
                              <OPT_LEVEL_IND Value="R"/>
                              <OPT_TIME Value="{date()}"/>
                              <LAST_ACTIVITY_TM Value="{date()}"/>
                            </ADD_DOCUMENT>-->
                            <CREATE_DOCUMENT_ID Name="OPT_OUT_NOT_FOUND" AssignToVar="PE_OPTOUT_ID"/>
                            <ADD_DOC_SMART Name="V_PE_OPT_OUT" ServiceName="BCM_MASTER" AssignToVar="respADD">
                              <PE_OPTOUT_ID Value="{$PE_OPTOUT_ID/@Value}"/>
                              <STATUS_FLG Value="Submitted"/>
                              <REGIS_PRSNA_ID Value="{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                              <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                              <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                              <DATA_SRCE_NBR Value="{$respQuery/SQL_RESULT/DATA_ORIGIN_SRCE_NBR/@Value}"/>
                              <SUBSCRPTN_OPT_NBR Value="{$respQuery/SQL_RESULT/SUBSCRPTN_OPT_NBR/@Value}"/>
                              <GVN_NAME Value="{$respQuery/SQL_RESULT/GVN_NAME/@Value}"/>
                              <FAMLY_NAME Value="{$respQuery/SQL_RESULT/FAMLY_NAME/@Value}"/>
                              <EMAIL_ADDR_TEXT Value="{$respQuery/SQL_RESULT/EMAIL_ADDR_TXT/@Value}"/>
                              <OPT_IND Value="O"/>
                              <LOG_SOURCE_ID Value="-999999"/>
                              <LOG_UPDATE_USER Value="{$userId}"/>
                              <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                              <CHANNEL_IND Value="E"/>
                              <OPT_LEVEL_IND Value="R"/>
                              <OPT_TIME Value="{date()}"/>
                              <LAST_ACTIVITY_TM Value="{date()}"/>
                            </ADD_DOC_SMART>
                          </THEN>
                        </IF_TEST>
                      </THEN>
                    </IF_TEST>
                    <IF_TEST Test="$selectedCNTCT_POINT_TYPE_CODE='P'">
                      <THEN>
                        <PRINTLN Value="Inside Phone"/>
                        <EXECUTE_SQL_QUERY Value="LOCK ROW FOR ACCESS SELECT RP.REGIS_PRSNA_ID,RP.MKTNG_PGM_NBR,RP.LEGAL_ENT_NBR,DATA_ORIGIN_SRCE_NBR,SUBSCRPTN_OPT_NBR,GVN_NAME,FAMLY_NAME,FULL_PHONE_NUM,NATIONAL_ID_NBR FROM REGIS_PRSNA RP JOIN REGIS_PRSNA_PHONE PH ON RP.MKTNG_PGM_NBR=PH.MKTNG_PGM_NBR AND RP.REGIS_PRSNA_ID=PH.REGIS_PRSNA_ID WHERE RP.REGIS_PRSNA_ID='{$selectedREGIS_PRSNA_ID}' AND RP.MKTNG_PGM_NBR= '{$selectedMKTNG_PGM_NBR}' AND CNTCT_POINT_CATEG_CODE='{$selectedCNTCT_POINT_CATEG_CODE}' AND SUBSCRPTN_OPT_NBR=COALESCE('{$selectedSUBSCRPTN_OPT_NBR}',0)" AssignToVar="respQuery" ReturnRowCount="yes"/>
                        <!--<MODIFY_DOC_SMART Name="REGIS_PRSNA_PHONE" ServiceName="BCM_MASTER" AssignToVar="respPhone">
                          <DOCUMENT_CONTEXT>
                            <TO_XML SelectList="$WHERE_CLAUSE/*"/>
                          </DOCUMENT_CONTEXT>
                          <UPDATE_PROPERTIES>
                            <SUBSCRPTN_OPT_IND Value="O"/>
                            <CNSMR_CHCE_DATETM Value="{date()}"/>
                          </UPDATE_PROPERTIES>
                        </MODIFY_DOC_SMART>-->
                        <SET Var="phoneOptOutCnt" FromValue="{$phoneOptOutCnt+1}"/>
                        <IF_TEST Test="$respQuery/@TotalRowCount!=0">
                          <THEN>
                            <!--<ADD_DOCUMENT Name="REGIS_PRSNA_OPT_HIST" ServiceName="BCM_MASTER" AssignToVar="respADD">
                              <REGIS_PRSNA_ID Value="-{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                              <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                              <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                              <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                              <CHANNEL_IND Value="P"/>
                              <OPT_LEVEL_IND Value="R"/>
                              <OPT_TIME Value="{date()}"/>
                              <LAST_ACTIVITY_TM Value="{date()}"/>
                            </ADD_DOCUMENT>-->
                            <CREATE_DOCUMENT_ID Name="OPT_OUT_NOT_FOUND" AssignToVar="PE_OPTOUT_ID"/>
                            <ADD_DOC_SMART Name="V_PE_OPT_OUT" ServiceName="BCM_MASTER" AssignToVar="respADD">
                              <PE_OPTOUT_ID Value="{$PE_OPTOUT_ID/@Value}"/>
                              <STATUS_FLG Value="Submitted"/>
                              <REGIS_PRSNA_ID Value="{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                              <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                              <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                              <DATA_SRCE_NBR Value="{$respQuery/SQL_RESULT/DATA_ORIGIN_SRCE_NBR/@Value}"/>
                              <SUBSCRPTN_OPT_NBR Value="{$respQuery/SQL_RESULT/SUBSCRPTN_OPT_NBR/@Value}"/>
                              <GVN_NAME Value="{$respQuery/SQL_RESULT/GVN_NAME/@Value}"/>
                              <FAMLY_NAME Value="{$respQuery/SQL_RESULT/FAMLY_NAME/@Value}"/>
                              <FULL_PHONE_NUM Value="{$respQuery/SQL_RESULT/FULL_PHONE_NUM/@Value}"/>
                              <OPT_IND Value="O"/>
                              <LOG_SOURCE_ID Value="-999999"/>
                              <LOG_UPDATE_USER Value="{$userId}"/>
                              <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                              <CHANNEL_IND Value="P"/>
                              <OPT_LEVEL_IND Value="R"/>
                              <OPT_TIME Value="{date()}"/>
                              <LAST_ACTIVITY_TM Value="{date()}"/>
                            </ADD_DOC_SMART>
                          </THEN>
                        </IF_TEST>
                      </THEN>
                    </IF_TEST>
                    <IF_TEST Test="$selectedCNTCT_POINT_TYPE_CODE='A'">
                      <THEN>
                        <PRINTLN Value="Inside Postal"/>
                        <EXECUTE_SQL_QUERY Value="LOCK ROW FOR ACCESS SELECT RP.REGIS_PRSNA_ID,RP.MKTNG_PGM_NBR,RP.LEGAL_ENT_NBR,DATA_ORIGIN_SRCE_NBR,SUBSCRPTN_OPT_NBR,GVN_NAME,FAMLY_NAME,ADDR_LINE_1_TXT,ADDR_LINE_2_TXT,ADDR_LINE_3_TXT,CITY_NAME,TERR_NAME,POSTL_AREA_CODE,POST.CNTRY_CODE,NATIONAL_ID_NBR FROM REGIS_PRSNA RP JOIN REGIS_PRSNA_POSTL_ADDR POST ON RP.MKTNG_PGM_NBR=POST.MKTNG_PGM_NBR AND RP.REGIS_PRSNA_ID=POST.REGIS_PRSNA_ID WHERE RP.REGIS_PRSNA_ID='{$selectedREGIS_PRSNA_ID}' AND RP.MKTNG_PGM_NBR= '{$selectedMKTNG_PGM_NBR}' AND CNTCT_POINT_CATEG_CODE='{$selectedCNTCT_POINT_CATEG_CODE}' AND SUBSCRPTN_OPT_NBR=COALESCE('{$selectedSUBSCRPTN_OPT_NBR}',0)" AssignToVar="respQuery" ReturnRowCount="yes"/>
                        <!--<MODIFY_DOC_SMART Name="REGIS_PRSNA_POSTL_ADDR" ServiceName="BCM_MASTER" AssignToVar="respPostal">
                          <DOCUMENT_CONTEXT>
                            <TO_XML SelectList="$WHERE_CLAUSE/*"/>
                          </DOCUMENT_CONTEXT>
                          <UPDATE_PROPERTIES>
                            <SUBSCRPTN_OPT_IND Value="O"/>
                            <CNSMR_CHCE_DATETM Value="{date()}"/>
                          </UPDATE_PROPERTIES>
                        </MODIFY_DOC_SMART>-->
                        <SET Var="addressOptOutCnt" FromValue="{$addressOptOutCnt+1}"/>
                        <IF_TEST Test="$respQuery/@TotalRowCount!=0">
                          <THEN>
                            <!--<ADD_DOCUMENT Name="REGIS_PRSNA_OPT_HIST" ServiceName="BCM_MASTER" AssignToVar="respADD">
                              <REGIS_PRSNA_ID Value="-{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                              <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                              <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                              <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                              <CHANNEL_IND Value="A"/>
                              <OPT_LEVEL_IND Value="R"/>
                              <OPT_TIME Value="{date()}"/>
                              <LAST_ACTIVITY_TM Value="{date()}"/>
                            </ADD_DOCUMENT>-->
                            <CREATE_DOCUMENT_ID Name="OPT_OUT_NOT_FOUND" AssignToVar="PE_OPTOUT_ID"/>
                            <ADD_DOC_SMART Name="V_PE_OPT_OUT" ServiceName="BCM_MASTER" AssignToVar="respADD">
                              <PE_OPTOUT_ID Value="{$PE_OPTOUT_ID/@Value}"/>
                              <STATUS_FLG Value="Submitted"/>
                              <REGIS_PRSNA_ID Value="{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                              <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                              <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                              <DATA_SRCE_NBR Value="{$respQuery/SQL_RESULT/DATA_ORIGIN_SRCE_NBR/@Value}"/>
                              <SUBSCRPTN_OPT_NBR Value="{$respQuery/SQL_RESULT/SUBSCRPTN_OPT_NBR/@Value}"/>
                              <GVN_NAME Value="{$respQuery/SQL_RESULT/GVN_NAME/@Value}"/>
                              <FAMLY_NAME Value="{$respQuery/SQL_RESULT/FAMLY_NAME/@Value}"/>
                              <SRC_ADDR_LINE_1_TXT Value="{$respQuery/SQL_RESULT/ADDR_LINE_1_TXT/@Value}"/>
                              <SRC_ADDR_LINE_2_TXT Value="{$respQuery/SQL_RESULT/ADDR_LINE_2_TXT/@Value}"/>
                              <SRC_ADDR_LINE_3_TXT Value="{$respQuery/SQL_RESULT/ADDR_LINE_3_TXT/@Value}"/>
                              <SRC_CITY_NAME Value="{$respQuery/SQL_RESULT/CITY_NAME/@Value}"/>
                              <SRC_TERR_NAME Value="{$respQuery/SQL_RESULT/TERR_NAME/@Value}"/>
                              <SRC_POSTAL_AREA_CODE Value="{$respQuery/SQL_RESULT/POSTL_AREA_CODE/@Value}"/>
                              <SRC_CNTRY_NAME Value="{$respQuery/SQL_RESULT/CNTRY_CODE/@Value}"/>
                              <OPT_IND Value="O"/>
                              <LOG_SOURCE_ID Value="-999999"/>
                              <LOG_UPDATE_USER Value="{$userId}"/>
                              <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                              <CHANNEL_IND Value="A"/>
                              <OPT_LEVEL_IND Value="R"/>
                              <OPT_TIME Value="{date()}"/>
                              <LAST_ACTIVITY_TM Value="{date()}"/>
                            </ADD_DOC_SMART>
                          </THEN>
                        </IF_TEST>
                      </THEN>
                    </IF_TEST>
                    <!--<IF_TEST Test="$PrevselectedREGIS_PRSNA_ID != $selectedREGIS_PRSNA_ID">
                            <SYS_LAST_MODIFIED_DATE Value="{date()}"/>
                            <LATST_ACTVY_DATE Value="{date()}"/>
                          </UPDATE_PROPERTIES>
                        </MODIFY_DOC_SMART>
                      </THEN>
                    </IF_TEST>-->
                    <SET Var="PrevselectedREGIS_PRSNA_ID" FromValue="{$selectedREGIS_PRSNA_ID}"/>
                    <SET Var="PrevselectedMKTNG_PGM_NBR" FromValue="{$selectedMKTNG_PGM_NBR}"/>
                  </FOR_EACH>
                  <SET Var="msg" FromValue="No. of Postal opt out count: {substringBefore($addressOptOutCnt,'.')},No. of Email opt out count: {substringBefore($emailOptOutCnt,'.')}, No. of Phone opt out count: {substringBefore($phoneOptOutCnt,'.')} :: Opt Outs submitted successfully. Opt Outs would be processed within 6 hours. To verify the status of the submitted Opt Outs, please use the Profile Editor Opt Out Report link"/>
                </THEN>
              </IF_TEST>
              <IF_TEST Test="$searchCnt > 0">
                <THEN>
                  <SET Var="phoneOptOutCnt" FromValue="0"/>
                  <SET Var="emailOptOutCnt" FromValue="0"/>
                  <SET Var="addressOptOutCnt" FromValue="0"/>
                  <SET Var="PrevselectedREGIS_PRSNA_ID" FromValue="0"/>
                  <SET Var="PrevselectedMKTNG_PGM_NBR" FromValue="0"/>
                  <FOR_EACH SelectList="$searchResultOpt/V_MATCHD_CNSMR_PRSNA" CurrentElement="currElement">
                    <SET Var="selectedCNTCT_POINT_TYPE_CODE" FromValue="{$currElement/CNTCT_POINT_TYPE_CODE/@Value}"/>
                    <SET Var="selectedMKTNG_PGM_NBR" FromValue="{$currElement/MKTNG_PGM_NBR/@Value}"/>
                    <SET Var="selectedREGIS_PRSNA_ID" FromValue="{$currElement/REGIS_PRSNA_ID/@Value}"/>
                    <SET Var="selectedSUBSCRPTN_OPT_NBR" FromValue="{$currElement/SUBSCRPTN_OPT_NBR/@Value}"/>
                    <SET Var="selectedCNTCT_POINT_CATEG_CODE" FromValue="{$currElement/CNTCT_POINT_CATEG_CODE/@Value}"/>
                    <TO_DOCVAR AssignToVar="WHERE_CLAUSE">
                      <WHERE_CLAUSE>
                        <REGIS_PRSNA_ID Value="{$selectedREGIS_PRSNA_ID}"/>
                        <MKTNG_PGM_NBR Value="{$selectedMKTNG_PGM_NBR}"/>
                        <SUBSCRPTN_OPT_NBR Value="{$selectedSUBSCRPTN_OPT_NBR}"/>
                        <CNTCT_POINT_CATEG_CODE Value="{$selectedCNTCT_POINT_CATEG_CODE}"/>
                      </WHERE_CLAUSE>
                    </TO_DOCVAR>
                    <PRINTLN Value="{$WHERE_CLAUSE}"/>
                    <!--EXECUTE_SQL_QUERY Value="LOCK ROW FOR ACCESS SELECT * FROM V_MATCHD_CNSMR_PRSNA WHERE REGIS_PRSNA_ID='{$selectedREGIS_PRSNA_ID}' AND MKTNG_PGM_NBR= '{$selectedMKTNG_PGM_NBR}' AND CNTCT_POINT_CATEG_CODE='{$selectedCNTCT_POINT_CATEG_CODE}' AND SUBSCRPTN_OPT_NBR=COALESCE('{$selectedSUBSCRPTN_OPT_NBR}',0)" AssignToVar="respQuery" ReturnRowCount="yes"/-->
                    <IF_TEST Test="$selectedCNTCT_POINT_TYPE_CODE='E'">
                      <THEN>
                        <PRINTLN Value="Inside Email"/>
                        <EXECUTE_SQL_QUERY Value="LOCK ROW FOR ACCESS SELECT RP.REGIS_PRSNA_ID,RP.MKTNG_PGM_NBR,RP.LEGAL_ENT_NBR,DATA_ORIGIN_SRCE_NBR,SUBSCRPTN_OPT_NBR,GVN_NAME,FAMLY_NAME,EMAIL_ADDR_TXT,NATIONAL_ID_NBR FROM REGIS_PRSNA RP JOIN REGIS_PRSNA_EMAIL_ADDR EMAIL ON RP.MKTNG_PGM_NBR=EMAIL.MKTNG_PGM_NBR AND RP.REGIS_PRSNA_ID=EMAIL.REGIS_PRSNA_ID WHERE RP.REGIS_PRSNA_ID='{$selectedREGIS_PRSNA_ID}' AND RP.MKTNG_PGM_NBR= '{$selectedMKTNG_PGM_NBR}' AND CNTCT_POINT_CATEG_CODE='{$selectedCNTCT_POINT_CATEG_CODE}' AND SUBSCRPTN_OPT_NBR=COALESCE('{$selectedSUBSCRPTN_OPT_NBR}',0)" AssignToVar="respQuery" ReturnRowCount="yes"/>
                        <!--<MODIFY_DOC_SMART Name="REGIS_PRSNA_EMAIL_ADDR" ServiceName="BCM_MASTER" AssignToVar="respEmail">
                          <DOCUMENT_CONTEXT>
                            <TO_XML SelectList="$WHERE_CLAUSE/*"/>
                          </DOCUMENT_CONTEXT>
                          <UPDATE_PROPERTIES>
                            <SUBSCRPTN_OPT_IND Value="O"/>
                            <CNSMR_CHCE_DATETM Value="{date()}"/>
                          </UPDATE_PROPERTIES>
                        </MODIFY_DOC_SMART>-->
                        <SET Var="emailOptOutCnt" FromValue="{$emailOptOutCnt+1}"/>
                        <IF_TEST Test="$respQuery/@TotalRowCount!=0">
                          <THEN>
                            <!--<ADD_DOCUMENT Name="REGIS_PRSNA_OPT_HIST" ServiceName="BCM_MASTER" AssignToVar="respADD">
                              <REGIS_PRSNA_ID Value="-{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                              <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                              <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                              <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                              <CHANNEL_IND Value="E"/>
                              <OPT_LEVEL_IND Value="R"/>
                              <OPT_TIME Value="{date()}"/>
                              <LAST_ACTIVITY_TM Value="{date()}"/>
                            </ADD_DOCUMENT>-->
                            <CREATE_DOCUMENT_ID Name="OPT_OUT_NOT_FOUND" AssignToVar="PE_OPTOUT_ID"/>
                            <ADD_DOC_SMART Name="V_PE_OPT_OUT" ServiceName="BCM_MASTER" AssignToVar="respADD">
                              <PE_OPTOUT_ID Value="{$PE_OPTOUT_ID/@Value}"/>
                              <STATUS_FLG Value="Submitted"/>
                              <REGIS_PRSNA_ID Value="{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                              <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                              <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                              <DATA_SRCE_NBR Value="{$respQuery/SQL_RESULT/DATA_ORIGIN_SRCE_NBR/@Value}"/>
                              <SUBSCRPTN_OPT_NBR Value="{$respQuery/SQL_RESULT/SUBSCRPTN_OPT_NBR/@Value}"/>
                              <GVN_NAME Value="{$respQuery/SQL_RESULT/GVN_NAME/@Value}"/>
                              <FAMLY_NAME Value="{$respQuery/SQL_RESULT/FAMLY_NAME/@Value}"/>
                              <EMAIL_ADDR_TEXT Value="{$respQuery/SQL_RESULT/EMAIL_ADDR_TXT/@Value}"/>
                              <OPT_IND Value="O"/>
                              <LOG_SOURCE_ID Value="-999999"/>
                              <LOG_UPDATE_USER Value="{$userId}"/>
                              <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                              <CHANNEL_IND Value="E"/>
                              <OPT_LEVEL_IND Value="R"/>
                              <OPT_TIME Value="{date()}"/>
                              <LAST_ACTIVITY_TM Value="{date()}"/>
                            </ADD_DOC_SMART>
                          </THEN>
                        </IF_TEST>
                      </THEN>
                    </IF_TEST>
                    <IF_TEST Test="$selectedCNTCT_POINT_TYPE_CODE='P'">
                      <THEN>
                        <PRINTLN Value="Inside Phone"/>
                        <EXECUTE_SQL_QUERY Value="LOCK ROW FOR ACCESS SELECT RP.REGIS_PRSNA_ID,RP.MKTNG_PGM_NBR,RP.LEGAL_ENT_NBR,DATA_ORIGIN_SRCE_NBR,SUBSCRPTN_OPT_NBR,GVN_NAME,FAMLY_NAME,FULL_PHONE_NUM,NATIONAL_ID_NBR FROM REGIS_PRSNA RP JOIN REGIS_PRSNA_PHONE PH ON RP.MKTNG_PGM_NBR=PH.MKTNG_PGM_NBR AND RP.REGIS_PRSNA_ID=PH.REGIS_PRSNA_ID WHERE RP.REGIS_PRSNA_ID='{$selectedREGIS_PRSNA_ID}' AND RP.MKTNG_PGM_NBR= '{$selectedMKTNG_PGM_NBR}' AND CNTCT_POINT_CATEG_CODE='{$selectedCNTCT_POINT_CATEG_CODE}' AND SUBSCRPTN_OPT_NBR=COALESCE('{$selectedSUBSCRPTN_OPT_NBR}',0)" AssignToVar="respQuery" ReturnRowCount="yes"/>
                        <!--<MODIFY_DOC_SMART Name="REGIS_PRSNA_PHONE" ServiceName="BCM_MASTER" AssignToVar="respPhone">
                          <DOCUMENT_CONTEXT>
                            <TO_XML SelectList="$WHERE_CLAUSE/*"/>
                          </DOCUMENT_CONTEXT>
                          <UPDATE_PROPERTIES>
                            <SUBSCRPTN_OPT_IND Value="O"/>
                            <CNSMR_CHCE_DATETM Value="{date()}"/>
                          </UPDATE_PROPERTIES>
                        </MODIFY_DOC_SMART>-->
                        <SET Var="phoneOptOutCnt" FromValue="{$phoneOptOutCnt+1}"/>
                        <IF_TEST Test="$respQuery/@TotalRowCount!=0">
                          <THEN>
                            <!--<ADD_DOCUMENT Name="REGIS_PRSNA_OPT_HIST" ServiceName="BCM_MASTER" AssignToVar="respADD">
                              <REGIS_PRSNA_ID Value="-{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                              <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                              <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                              <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                              <CHANNEL_IND Value="P"/>
                              <OPT_LEVEL_IND Value="R"/>
                              <OPT_TIME Value="{date()}"/>
                              <LAST_ACTIVITY_TM Value="{date()}"/>
                            </ADD_DOCUMENT>-->
                            <CREATE_DOCUMENT_ID Name="OPT_OUT_NOT_FOUND" AssignToVar="PE_OPTOUT_ID"/>
                            <ADD_DOC_SMART Name="V_PE_OPT_OUT" ServiceName="BCM_MASTER" AssignToVar="respADD">
                              <PE_OPTOUT_ID Value="{$PE_OPTOUT_ID/@Value}"/>
                              <STATUS_FLG Value="Submitted"/>
                              <REGIS_PRSNA_ID Value="{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                              <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                              <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                              <DATA_SRCE_NBR Value="{$respQuery/SQL_RESULT/DATA_ORIGIN_SRCE_NBR/@Value}"/>
                              <SUBSCRPTN_OPT_NBR Value="{$respQuery/SQL_RESULT/SUBSCRPTN_OPT_NBR/@Value}"/>
                              <GVN_NAME Value="{$respQuery/SQL_RESULT/GVN_NAME/@Value}"/>
                              <FAMLY_NAME Value="{$respQuery/SQL_RESULT/FAMLY_NAME/@Value}"/>
                              <FULL_PHONE_NUM Value="{$respQuery/SQL_RESULT/FULL_PHONE_NUM/@Value}"/>
                              <OPT_IND Value="O"/>
                              <LOG_SOURCE_ID Value="-999999"/>
                              <LOG_UPDATE_USER Value="{$userId}"/>
                              <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                              <CHANNEL_IND Value="P"/>
                              <OPT_LEVEL_IND Value="R"/>
                              <OPT_TIME Value="{date()}"/>
                              <LAST_ACTIVITY_TM Value="{date()}"/>
                            </ADD_DOC_SMART>
                          </THEN>
                        </IF_TEST>
                      </THEN>
                    </IF_TEST>
                    <IF_TEST Test="$selectedCNTCT_POINT_TYPE_CODE='A'">
                      <THEN>
                        <PRINTLN Value="Inside Postal"/>
                        <EXECUTE_SQL_QUERY Value="LOCK ROW FOR ACCESS SELECT RP.REGIS_PRSNA_ID,RP.MKTNG_PGM_NBR,RP.LEGAL_ENT_NBR,DATA_ORIGIN_SRCE_NBR,SUBSCRPTN_OPT_NBR,GVN_NAME,FAMLY_NAME,ADDR_LINE_1_TXT,ADDR_LINE_2_TXT,ADDR_LINE_3_TXT,CITY_NAME,TERR_NAME,POSTL_AREA_CODE,POST.CNTRY_CODE,NATIONAL_ID_NBR FROM REGIS_PRSNA RP JOIN REGIS_PRSNA_POSTL_ADDR POST ON RP.MKTNG_PGM_NBR=POST.MKTNG_PGM_NBR AND RP.REGIS_PRSNA_ID=POST.REGIS_PRSNA_ID WHERE RP.REGIS_PRSNA_ID='{$selectedREGIS_PRSNA_ID}' AND RP.MKTNG_PGM_NBR= '{$selectedMKTNG_PGM_NBR}' AND CNTCT_POINT_CATEG_CODE='{$selectedCNTCT_POINT_CATEG_CODE}' AND SUBSCRPTN_OPT_NBR=COALESCE('{$selectedSUBSCRPTN_OPT_NBR}',0)" AssignToVar="respQuery" ReturnRowCount="yes"/>
                        <!--<MODIFY_DOC_SMART Name="REGIS_PRSNA_POSTL_ADDR" ServiceName="BCM_MASTER" AssignToVar="respPostal">
                          <DOCUMENT_CONTEXT>
                            <TO_XML SelectList="$WHERE_CLAUSE/*"/>
                          </DOCUMENT_CONTEXT>
                          <UPDATE_PROPERTIES>
                            <SUBSCRPTN_OPT_IND Value="O"/>
                            <CNSMR_CHCE_DATETM Value="{date()}"/>
                          </UPDATE_PROPERTIES>
                        </MODIFY_DOC_SMART>-->
                        <SET Var="addressOptOutCnt" FromValue="{$addressOptOutCnt+1}"/>
                        <IF_TEST Test="$respQuery/@TotalRowCount!=0">
                          <THEN>
                            <!--<ADD_DOCUMENT Name="REGIS_PRSNA_OPT_HIST" ServiceName="BCM_MASTER" AssignToVar="respADD">
                              <REGIS_PRSNA_ID Value="-{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                              <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                              <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                              <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                              <CHANNEL_IND Value="A"/>
                              <OPT_LEVEL_IND Value="R"/>
                              <OPT_TIME Value="{date()}"/>
                              <LAST_ACTIVITY_TM Value="{date()}"/>
                            </ADD_DOCUMENT>-->
                            <CREATE_DOCUMENT_ID Name="OPT_OUT_NOT_FOUND" AssignToVar="PE_OPTOUT_ID"/>
                            <ADD_DOC_SMART Name="V_PE_OPT_OUT" ServiceName="BCM_MASTER" AssignToVar="respADD">
                              <PE_OPTOUT_ID Value="{$PE_OPTOUT_ID/@Value}"/>
                              <STATUS_FLG Value="Submitted"/>
                              <REGIS_PRSNA_ID Value="{$respQuery/SQL_RESULT/REGIS_PRSNA_ID/@Value}"/>
                              <MKTNG_PGM_NBR Value="{$respQuery/SQL_RESULT/MKTNG_PGM_NBR/@Value}"/>
                              <LEGAL_ENT_NBR Value="{$respQuery/SQL_RESULT/LEGAL_ENT_NBR/@Value}"/>
                              <DATA_SRCE_NBR Value="{$respQuery/SQL_RESULT/DATA_ORIGIN_SRCE_NBR/@Value}"/>
                              <SUBSCRPTN_OPT_NBR Value="{$respQuery/SQL_RESULT/SUBSCRPTN_OPT_NBR/@Value}"/>
                              <GVN_NAME Value="{$respQuery/SQL_RESULT/GVN_NAME/@Value}"/>
                              <FAMLY_NAME Value="{$respQuery/SQL_RESULT/FAMLY_NAME/@Value}"/>
                              <SRC_ADDR_LINE_1_TXT Value="{$respQuery/SQL_RESULT/ADDR_LINE_1_TXT/@Value}"/>
                              <SRC_ADDR_LINE_2_TXT Value="{$respQuery/SQL_RESULT/ADDR_LINE_2_TXT/@Value}"/>
                              <SRC_ADDR_LINE_3_TXT Value="{$respQuery/SQL_RESULT/ADDR_LINE_3_TXT/@Value}"/>
                              <SRC_CITY_NAME Value="{$respQuery/SQL_RESULT/CITY_NAME/@Value}"/>
                              <SRC_TERR_NAME Value="{$respQuery/SQL_RESULT/TERR_NAME/@Value}"/>
                              <SRC_POSTAL_AREA_CODE Value="{$respQuery/SQL_RESULT/POSTL_AREA_CODE/@Value}"/>
                              <SRC_CNTRY_NAME Value="{$respQuery/SQL_RESULT/CNTRY_CODE/@Value}"/>
                              <OPT_IND Value="O"/>
                              <LOG_SOURCE_ID Value="-999999"/>
                              <LOG_UPDATE_USER Value="{$userId}"/>
                              <NATIONAL_ID_NBR Value="{$respQuery/SQL_RESULT/NATIONAL_ID_NBR/@Value}"/>
                              <CHANNEL_IND Value="A"/>
                              <OPT_LEVEL_IND Value="R"/>
                              <OPT_TIME Value="{date()}"/>
                              <LAST_ACTIVITY_TM Value="{date()}"/>
                            </ADD_DOC_SMART>
                          </THEN>
                        </IF_TEST>
                      </THEN>
                    </IF_TEST>
                    <!--<IF_TEST Test="$PrevselectedREGIS_PRSNA_ID != $selectedREGIS_PRSNA_ID">
                            <SYS_LAST_MODIFIED_DATE Value="{date()}"/>
                            <LATST_ACTVY_DATE Value="{date()}"/>
                          </UPDATE_PROPERTIES>
                        </MODIFY_DOC_SMART>
                      </THEN>
                    </IF_TEST>-->
                    <SET Var="PrevselectedREGIS_PRSNA_ID" FromValue="{$selectedREGIS_PRSNA_ID}"/>
                    <SET Var="PrevselectedMKTNG_PGM_NBR" FromValue="{$selectedMKTNG_PGM_NBR}"/>
                  </FOR_EACH>
                  <SET Var="msg" FromValue="No. of Postal opt out count: {substringBefore($addressOptOutCnt,'.')},No. of Email opt out count: {substringBefore($emailOptOutCnt,'.')}, No. of Phone opt out count: {substringBefore($phoneOptOutCnt,'.')} :: Opt Outs submitted successfully. Opt Outs would be processed within 6 hours. To verify the status of the submitted Opt Outs, please use the Profile Editor Opt Out Report link"/>
                </THEN>
              </IF_TEST>
            </THEN>
          </IF_TEST>
        </ACTION>
      </post_actions>
      <if_cond Value="$userAction ='OPTOUT'">
        <next_nodes OutputVar="{outputXml,xml}">
          <next_node Name="Manage Opt" Description=""/>
        </next_nodes>
      </if_cond>
      <else_if_cond Value="$userAction ='SEARCH'">
        <next_nodes OutputVar="{outputXml,xml}">
          <next_node Name="Manage Opt" Description="Search Opt Out"/>
        </next_nodes>
      </else_if_cond>
      <else_if_cond Value="$userAction ='LOAD_DETAILS_INDIVIDUAL'">
        <next_nodes OutputVar="{outputXml,xml}">
          <next_node Name="Manage Opt" Description=""/>
        </next_nodes>
      </else_if_cond>
      <else_if_cond Value="$userAction ='OPTOUTALL'">
        <next_nodes OutputVar="{outputXml,xml}">
          <next_node Name="Manage Opt" Description=""/>
        </next_nodes>
      </else_if_cond>
      <else_if_cond Value="$userAction ='BACK'">
        <next_nodes OutputVar="{outputXml,xml}">
          <next_node Name="searchIndividual" Description=""/>
        </next_nodes>
      </else_if_cond>
      <else_if_cond Value="true()">
        <next_nodes OutputVar="{outputXml,xml}"/>
      </else_if_cond>
    </ui_form2>
    <sub_workflow Name="searchIndividual" Workflow="IndividualMgmt">
      <pre_actions>
        <action/>
      </pre_actions>
      <post_actions>
        <action/>
      </post_actions>
      <input>
        <action>
          <TO_XML SelectList="$thisParamBack"/>
        </action>
      </input>
      <next_nodes/>
    </sub_workflow>
  </nodes>
  <mgcview>
    <mgcdashboard location="10,10"/>
    <mgcnodes>
      <start0 font="Times New Roman,0,9" componentConnect="true" componentIconBorder="false" componentTextColor="80,80,80" componentBorderColor="255,255,255" freeze="false" visible="true" fade="false" fadeConnectors="false" shapeKey="ICONISH" snapPointKey="REGULAR" leadingEdge="5" trailingEdge="5" topGap="3" bottomGap="2" location="135,298" size="732,526">
        <iconProps iconfile="z1start.gif"/>
      </start0>
      <mgcnode Name="Manage Opt" font="Times New Roman,0,9" componentConnect="true" componentIconBorder="false" componentTextColor="80,80,80" componentBorderColor="255,255,255" freeze="false" visible="true" fade="false" fadeConnectors="false" shapeKey="ICONISH" snapPointKey="REGULAR" leadingEdge="5" trailingEdge="5" topGap="3" bottomGap="2" location="269,280" size="1364,684">
        <iconProps iconfile="x1age80.gif"/>
      </mgcnode>
      <searchIndividual location="739,262" font="Times New Roman,0,9" componentConnect="true" componentIconBorder="false" componentTextColor="80,80,80" componentBorderColor="255,255,255" freeze="false" visible="true" fade="false" fadeConnectors="false" shapeKey="ICONISH" snapPointKey="REGULAR" leadingEdge="5" trailingEdge="5" topGap="3" bottomGap="2" size="732,628">
        <iconProps iconfile="z1sub_workflow.gif"/>
      </searchIndividual>
    </mgcnodes>
    <mgcconnectors>
      <start0>
        <nextNodeView wavyConnector="true" connectorTextColor="0,0,0" connectorColor="0,178,178" connStartPointFill="false" connEndPointFill="true" connStartPointOval="true" draggable="true" startpoint="180,320" endpoint="269,302" ctrlRect1="244,318,4,4" ctrlRect2="200,300,4,4"/>
      </start0>
      <mgcnode Name="Manage Opt">
        <nextNodeView wavyConnector="true" connectorTextColor="0,0,0" connectorColor="0,178,178" connStartPointFill="false" connEndPointFill="true" connStartPointOval="true" draggable="true" startpoint="291,280" endpoint="291,280" ctrlRect1="289,203,4,4" ctrlRect2="353,204,4,4" ctrlRect2Dirty="true">
          <textProps/>
        </nextNodeView>
        <nextNodeView wavyConnector="true" connectorTextColor="0,0,0" connectorColor="0,178,178" connStartPointFill="false" connEndPointFill="true" connStartPointOval="true" draggable="true" startpoint="314,302" endpoint="314,302" ctrlRect1="387,300,4,4" ctrlRect2="359,356,4,4" ctrlRect2Dirty="true" textRect="362,326,26,8">
          <textProps text="$userAction ='SEARCH'"/>
        </nextNodeView>
        <nextNodeView wavyConnector="true" connectorTextColor="0,0,0" connectorColor="0,178,178" connStartPointFill="false" connEndPointFill="true" connStartPointOval="true" draggable="true" startpoint="314,302" endpoint="314,302" ctrlRect1="387,300,4,4" ctrlRect2="279,404,4,4" ctrlRect2Dirty="true" textRect="314,350,43,8">
          <textProps text="$userAction ='LOAD_DETAILS_INDIVIDUAL'"/>
        </nextNodeView>
        <nextNodeView wavyConnector="true" connectorTextColor="0,0,0" connectorColor="0,178,178" connStartPointFill="false" connEndPointFill="true" connStartPointOval="true" draggable="true" startpoint="291,280" endpoint="269,302" ctrlRect1="289,203,4,4" ctrlRect2="210,249,4,4" textRect="237,224,29,8" ctrlRect2Dirty="true">
          <textProps text="$userAction ='OPTOUTALL'"/>
        </nextNodeView>
        <nextNodeView wavyConnector="true" connectorTextColor="0,0,0" connectorColor="0,178,178" connStartPointFill="false" connEndPointFill="true" connStartPointOval="true" draggable="true" startpoint="314,302" endpoint="739,284" ctrlRect1="630,300,4,4" ctrlRect2="418,282,4,4" textRect="514,289,24,8">
          <textProps text="$userAction ='BACK'"/>
        </nextNodeView>
      </mgcnode>
    </mgcconnectors>
    <mgctexts/>
  </mgcview>
  <shutdown_handler>
    <pre_actions>
      <action/>
    </pre_actions>
    <post_actions>
      <action/>
    </post_actions>
    <checkcondition Value=""/>
  </shutdown_handler>
</workflow>