/***********************************************************************************************************
SCRIPT:               REGIS_PRSNA_POSTAL_ADDR.BTEQ 
DESCRIPTION:          THIS SCRIPT LOADS EDW TABLES -- This scripts takes data friom trillium output tables 
                                                      and loads USER_WORK.REGIS_PRSNA_POSTAL_ADDR
DESCRIPTION:          THIS SCRIPT ALSO LOADS INTERMIDIATE OPT TABLES -- This scripts creates opt out list
                                                      after the respective MDM STG tables have been populated
                                                      and loads MDM.REG_OPT_OUT_MDM_TEMP                                                      
DEPENDENCY:           
INPUT:                TRILLIUM OUTPUT CNTRY TABLES
OUTPUT:               EDW
ERRORS:
SPECIAL INSTRUCTIONS:

CHANGE LOG:
VERSION              DATE                 AUTHOR                          CHANGES
1.00                 10/31/2011           TERADATA                        INITIAL VERSION
4.00                 03/26/2012           TERADATA                        1. UPDATE NATIONAL ID INTO REGIS PRSNA 
                                                                          FROM PRSNA TRT.
                                                                          2. ADD STATE VALIDATION FOR US
									  3. ADD OPT OUT MODULE
R2O                  05/11/2012           TERADATA                        REMOVE ERROR PROCESSING
4.1                  06/13/2012           TERADATA                        MODULARIZE AND TUNING
4.2.1                01/14/2013           TERADATA                        INC0011026
4.4.1                06/10/2013           TERADATA                        PERFORMANCE TUNING
EUROPE               07/20/2013           TERADATA                        TERR CODE, CITY CODE INCLUSION
4.4.2                08/14/2013           TERADATA                        INCLUDE CNTCT_POINT_CATEG_CODE IN
                                                                          I2 OPTOUT
4.5                  09/26/2013           TERADATA                        POSTAL CLT OPTOUT       
4.5.1                11/26/2013           TERADATA                        TERRITORY UPDATE FOR BRA
PRB0040947           01/14/2013           TERADATA                        VALID_IND FOR ASIA UPDATE
4.5.3                02/03/2013           TERADATA                        PRB0040960         
5.0                  02/06/2013           TERADATA                        RELEASE 5.0
                                                                          1. ADDITION OF LAT/LONG
                                                                          2. ARABIAN PENINSULA TERR CODE
5.0.1                04/11/2014           TERADATA                        RELEASE 5.0.1 PRB0041004																		  
5.1                  04/08/2014           TERADATA                        RELEASE 5.1
                                                                          1. i60 PROCESSING CHANGES
5.1.1                06/27/2014           TERADATA                        1. Release 5.1.1 BR173 Response '05'
5.2                  08/08/2014           TERADATA                        RELEASE 5.2
                                                                          Change required as Database Upgrade
5.3                  01/09/2015           TERADATA                        RELEASE 5.3
                                                                          PRB0041246   
5.3.2                05/19/2015           TERADATA                        Change VALID_CNTCT_POINT_IND Logic
                                                                          for GRC
5.4                  04/07/2015           TERADATA                        RELEASE 5.4
                                                                          Addition of new countries ISR,EGY,ROU,AFR
DB Upgrade           08/09/2015	          TERADATA                        Query tuning for POSTL_OPTOUT_T2																		  
5.5                  08/10/2015           TERADATA                        RELEASE 5.5
                                                                          Addition of new countries CZE,BGR,PAK,HRV
                                                                          Insert into PRSNA_POSTL_ADDR_ORIG
5.5.1                10/07/2015           TERADATA                        PRB0041426 - I2 OPTOUT TUNING    
5.5.2                11/16/2015           TERADATA                        FRA Valid Indicator Change.
5.6                  11/16/2015           TERADATA                        RELEASE 5.6 BR362 
5.6.1                03/08/2016           TERADATA                        eCR - Fix gap in processing i10 optouts
5.7                  03/24/2016           TERADATA                        Release 5.7 - Persist POSTL_ADDR_ID
                                                                          in case of external standardization
***********************************************************************************************************/

.logon 10.36.32.8/mdm,$tdwallet(mdm)


.SET ERROROUT STDOUT;      
.SET SESSION CHARSET 'UTF8';
.SET ERRORLEVEL 3624 SEVERITY 0
SET QUERY_BAND = 'WorkFlow=MDM;Interface=i2MDM;Country=DEU;Stage=Wrapper;Step=Step06;' FOR SESSION; 
DATABASE MDM;

INS ADDR_TEMP
(MKTNG_PGM_NBR                 ,
REGIS_CNSMR_ID_VAL            ,
DR_ALIAS_CONTACT              ,
DR_FIRST_NAME                 ,
DR_MIDDLE_NAME                ,
DR_LAST_NAME                  ,
DR_MRMRS                      ,
DR_NAME_GENER                 ,
DR_NAME_SUFFIX                ,
DR_NAME_GENDER                ,
DR_COUNTRY_NAME               ,
DR_REGION_NAME                ,
DR_CITY_NAME                  ,
DR_POSTAL_CODE                ,
DR_STREET_NAME                ,
DR_HOUSE_NUMBER1              ,
DR_HOUSE_NUMBER2              ,
DR_POBOX_NUMBER               ,
DR_ADDRESS                    ,
DR_ADDRESS2                   ,
DR_ADDRESS3                   ,
CLEANSED_PHONE_1              ,
CLEANSED_EMAIL_1              ,
PR_REV_GROUP                  ,
GOUT_MATCH_LEVEL              ,
WINDOW_KEY_01                 ,
REFERENCE_HOUSEHOLD_ID        ,
REFERENCE_LEGALENTITYKEY      ,
REFERENCE_REGISTRATIONKEY     ,
LEGAL_ENT_NBR                 ,
BRTH_DATE                     ,
LANG_CODE                     ,
CNSMR_USER_NAME               ,
STATUS                        ,
FULL_NAME                     ,
DPEND_NAME                    ,
PET_NAME                      ,
PR_NAME_FORM_01               ,
DR_ALIAS_ACCOUNT              ,
REFERENCE_MATCHED_LEV1_PATTERN,
REFERENCE_MATCHED_LEV2_PATTERN,
DR_BUSINESS_NAME              ,
EMAIL_IND                     ,
REGIS_DATE                    ,
RECORD_IND                    ,
RECENT_IND                    ,
REGIS_PRSNA_ID                ,
HH_FLAG                       ,
LE_FLAG                       ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_SOURCE                    ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_LAST_MODIFIED_DATE        ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 ,
ADDRESS_CONTACT               ,
ADDRESS_SUBSCRPTN             ,
PHONE_CONTACT                 ,
PHONE_SUBSCRPTN               ,
EMAIL_CONTACT                 ,
EMAIL_SUBSCRPTN               ,
NATIONAL_ID_NBR               ,
GL_ACCURACY                   ,
GL_MATCH_FLAG                 ,
GL_LATITUDE                   ,
GL_LONGITUDE                  ,
DR_CLEANSE_LEVEL              ,
HOUSEHOLD_ID                  ,
LEGALENTITYKEY                ,
REGISTRATIONKEY               )
SEL MKTNG_PGM_NBR                 ,
REGIS_CNSMR_ID_VAL            ,
DR_ALIAS_CONTACT              ,
DR_FIRST_NAME                 ,
DR_MIDDLE_NAME                ,
DR_LAST_NAME                  ,
DR_MRMRS                      ,
DR_NAME_GENER                 ,
DR_NAME_SUFFIX                ,
DR_NAME_GENDER                ,
DR_COUNTRY_NAME               ,
DR_REGION_NAME                ,
DR_CITY_NAME                  ,
DR_POSTAL_CODE                ,
DR_STREET_NAME                ,
DR_HOUSE_NUMBER1              ,
DR_HOUSE_NUMBER2              ,
DR_POBOX_NUMBER               ,
DR_ADDRESS                    ,
DR_ADDRESS2                   ,
DR_ADDRESS3                   ,
CLEANSED_PHONE_1              ,
CLEANSED_EMAIL_1              ,
PR_REV_GROUP                  ,
GOUT_MATCH_LEVEL              ,
WINDOW_KEY_01                 ,
REFERENCE_HOUSEHOLD_ID        ,
REFERENCE_LEGALENTITYKEY      ,
REFERENCE_REGISTRATIONKEY     ,
LEGAL_ENT_NBR                 ,
BRTH_DATE                     ,
LANG_CODE                     ,
CNSMR_USER_NAME               ,
STATUS                        ,
FULL_NAME                     ,
DPEND_NAME                    ,
PET_NAME                      ,
PR_NAME_FORM_01               ,
DR_ALIAS_ACCOUNT              ,
REFERENCE_MATCHED_LEV1_PATTERN,
REFERENCE_MATCHED_LEV2_PATTERN,
DR_BUSINESS_NAME              ,
EMAIL_IND                     ,
REGIS_DATE                    ,
RECORD_IND                    ,
RECENT_IND                    ,
REGIS_PRSNA_ID                ,
HH_FLAG                       ,
LE_FLAG                       ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_SOURCE                    ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_LAST_MODIFIED_DATE        ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 ,
ADDRESS_CONTACT               ,
ADDRESS_SUBSCRPTN             ,
PHONE_CONTACT                 ,
PHONE_SUBSCRPTN               ,
EMAIL_CONTACT                 ,
EMAIL_SUBSCRPTN               ,
NATIONAL_ID_NBR               ,
GL_ACCURACY                   ,
GL_MATCH_FLAG                 ,
GL_LATITUDE                   ,
GL_LONGITUDE                  ,
DR_CLEANSE_LEVEL              ,
HOUSEHOLD_ID                  ,
LEGALENTITYKEY                ,
REGISTRATIONKEY              
FROM TRILLIUM_OUTPUT1_DEU_TEMP;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO ADDR_INPUT
(
 CNTCT_POINT_CATEG_CODE
,REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,WIN_KEY
,SUBSCRPTN_OPT_NBR
,SUBSCRPTN_OPT_IND
,CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,TERR_NAME
,CNTRY_CODE
,LAT_MEAS
,LONG_MEAS
,VALID_CNTCT_POINT_IND
,GUARDN_NAME
,GUARDN_EMAIL_ADDR_TXT
,GUARDN_CNSNT_IND
,ACNLGMT_DATE
,PR_REV_GROUP
,PR_GEOCODE_FAIL
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE 
,SYS_ERR_SVRTY
,DATA_SRCE_NBR
,POSTL_STATUS_CODE
,GL_ACCURACY
,GL_MATCH_FLAG
,GL_LATITUDE
,GL_LONGITUDE
,DR_CLEANSE_LEVEL
,CITY_CODE
,TERR_CODE
,POSTL_ADDR_ID)
SELECT
STG.CNTCT_POINT_CATEG_CODE
,COALESCE(TOUT.REGIS_PRSNA_ID,CAST(TOUT.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.WINDOW_KEY_01
,STG.CNTCT_OPTN_NBR
,STG.CNTCT_OPTN_IND
,STG.CNSMR_CHCE_DATETM
,STG.PREFR_IND
,TOUT.DR_ADDRESS
,TOUT.DR_ADDRESS2
,TOUT.DR_ADDRESS3
,TOUT.DR_HOUSE_NUMBER1
,TOUT.DR_STREET_NAME
,TOUT.DR_HOUSE_NUMBER2
,TOUT.DR_POBOX_NUMBER
,TOUT.DR_CITY_NAME
,TOUT.DR_POSTAL_CODE
,CASE WHEN TR.TERR_RECODE IS NOT NULL AND DR_COUNTRY_NAME NOT IN ('ESP','PRT')
            THEN TR.TERR_RECODE
            ELSE TOUT.DR_REGION_NAME
  END AS DR_REGION_NAME
,CASE WHEN CR.CNTRY_RECODE IS NOT NULL AND DR_COUNTRY_NAME NOT IN ('ESP','PRT')
      THEN CR.CNTRY_RECODE 
      ELSE TOUT.DR_COUNTRY_NAME
  END AS DR_COUNTRY_NAME
,STG.LAT_MEAS
,STG.LONG_MEAS
,CASE 
WHEN (GOUT_MATCH_LEVEL IN ('0','9')
      AND DR_COUNTRY_NAME IN ('JPN','TWN','KOR','AUS','MYS','SGP','USA','CAN','IDN','THA','VNM'))
      OR (GOUT_MATCH_LEVEL IN ('0','3')
      AND DR_COUNTRY_NAME IN ('NZL'))      
      OR DR_COUNTRY_NAME IN ('ARG','CHL','MEX','BRA')
      OR (TOUT.PR_REV_GROUP IN ('0','000','001','002','003','005','008','009','010','012','019')
      AND  DR_COUNTRY_NAME NOT IN ('JPN','TWN','KOR','NZL','AUS','MYS',
      'SGP','USA','CAN','BRA','MEX','FRA','BEL','NLD','ITA','GRC','AUT','CHE','DEU','ESP','IRL'
      ,'DNK','FIN','NOR','SWE','GBR','PRT','IDN','THA','VNM'))
      OR (GOUT_MATCH_LEVEL = '0' AND TOUT.PR_REV_GROUP IN ('000','002','005','007','008','009','010','014','018','020')
      AND DR_COUNTRY_NAME IN ('FRA'))
      OR (GOUT_MATCH_LEVEL IN ('0','3') AND TOUT.PR_REV_GROUP IN ('000','002','005','008','009','010','018')
      AND DR_COUNTRY_NAME IN ('IRL','AUT','ITA'))      
      /*OR (GOUT_MATCH_LEVEL = '0' AND TOUT.PR_REV_GROUP IN ('000','002','005','008','009','010')
      AND DR_COUNTRY_NAME IN ('GRC'))*/    
      OR (GOUT_MATCH_LEVEL IN ('0') AND TOUT.PR_REV_GROUP IN ('000','002','005','008','009','010','018')
      AND DR_COUNTRY_NAME IN ('CHE','DEU','BEL','NLD'))
      OR (GOUT_MATCH_LEVEL IN ('0','3','8') AND TOUT.PR_REV_GROUP IN ('000','002','005','008','009','010','018')
      AND DR_COUNTRY_NAME IN ('DNK','FIN','NOR'))   
      OR (GOUT_MATCH_LEVEL IN ('0','3','8') AND TOUT.PR_REV_GROUP IN ('000','002','005','007','008','009','010','018')
      AND DR_COUNTRY_NAME IN ('SWE'))       
      OR (GOUT_MATCH_LEVEL = '0' AND TOUT.PR_REV_GROUP IN ('000','002','005','008','009','010','014','018')
      AND DR_COUNTRY_NAME IN ('GBR')) 
THEN 'Y'
WHEN DR_COUNTRY_NAME='MYS' AND TRIM(COALESCE(DR_POSTAL_CODE,''))<>'' 
     AND (CHAR(TRIM(COALESCE(DR_POSTAL_CODE,'')))=5 
           AND SUBSTR(TRIM(COALESCE(DR_POSTAL_CODE,'')),1,2)<>'01'
           AND SUBSTR(TRIM(COALESCE(DR_POSTAL_CODE,'')),1,1)='0')
THEN 'N'
WHEN ((GOUT_MATCH_LEVEL IS NULL OR TRIM(GOUT_MATCH_LEVEL) = '') 
 AND (TOUT.PR_REV_GROUP IS NULL OR TRIM(TOUT.PR_REV_GROUP) = ''))
 OR  DR_COUNTRY_NAME IN ('HKG','GRC')
 OR  (GOUT_MATCH_LEVEL NOT IN ('0','9')
      AND DR_COUNTRY_NAME IN ('JPN','TWN','KOR','NZL','AUS','MYS','SGP','IDN','THA','VNM'))
THEN STG.VALID_IND
WHEN DR_COUNTRY_NAME IN ('ESP','PRT')
THEN COALESCE(STG.VALID_ADDR_IND,STG.VALID_IND)
ELSE 'N'
END VALID_CNTCT_POINT_IND
,STG.GUARDN_NAME
,STG.GUARDN_EMAIL_ADDR_TXT
,STG.GUARDN_CNSNT_IND
,STG.ACNLGMT_DATE
,COALESCE(STG.PR_REV_GROUP,TRIM(TOUT.PR_REV_GROUP)) PR_REV_GROUP
,COALESCE(STG.PR_GEOCODE_FAIL,STG.TQ_GOUT_MATCH_LEVEL,TOUT.GOUT_MATCH_LEVEL)
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
,STG.SYS_TARGET_ID SYS_TARGET_ID1
,'AC' POSTL_STATUS_CODE
,TOUT.GL_ACCURACY
,TOUT.GL_MATCH_FLAG
,TOUT.GL_LATITUDE
,TOUT.GL_LONGITUDE
,TOUT.DR_CLEANSE_LEVEL
,STG.CITY_CODE
,STG.TERR_CODE
,STG.POSTL_ADDR_ID
FROM
ADDR_TEMP TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND
TOUT.SYS_TARGET_ID = STG.SYS_TARGET_ID
AND TOUT.ADDRESS_CONTACT = STG.CNTCT_POINT_CATEG_CODE
AND COALESCE(TOUT.ADDRESS_SUBSCRPTN,'0') = COALESCE(STG.CNTCT_OPTN_NBR,0)
LEFT OUTER JOIN TERR_RECODE TR
ON TOUT.DR_REGION_NAME = TR.TERR
AND TOUT.DR_COUNTRY_NAME = TR.CNTRY
LEFT OUTER JOIN CNTRY_RECODE CR
ON TOUT.DR_COUNTRY_NAME = CR.CNTRY
WHERE TOUT.DR_COUNTRY_NAME NOT IN ('IND','CHN','ESP','PRT')
AND TOUT.RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY REFERENCE_REGISTRATIONKEY1,STG.CNTCT_POINT_CATEG_CODE,COALESCE(STG.CNTCT_OPTN_NBR,0)
ORDER BY STG.SYS_CREATION_DATE DESC
,STG.SYS_SOURCE DESC
,STG.SYS_NC_TYPE DESC
,STG.CNSMR_CHCE_DATETM DESC
,TOUT.DR_ADDRESS DESC
,TOUT.WINDOW_KEY_01 DESC
,TOUT.DR_ADDRESS2 DESC
,TOUT.DR_ADDRESS3 DESC
,TOUT.DR_HOUSE_NUMBER1 DESC
,TOUT.DR_STREET_NAME DESC
,TOUT.DR_HOUSE_NUMBER2 DESC
,TOUT.DR_POBOX_NUMBER DESC
,TOUT.DR_CITY_NAME DESC
,TOUT.DR_POSTAL_CODE DESC
,DR_REGION_NAME DESC
) = 1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO ADDR_INPUT
(
 CNTCT_POINT_CATEG_CODE
,REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,WIN_KEY
,SUBSCRPTN_OPT_NBR
,SUBSCRPTN_OPT_IND
,CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,TERR_NAME
,CNTRY_CODE
,LAT_MEAS
,LONG_MEAS
,VALID_CNTCT_POINT_IND
,GUARDN_NAME
,GUARDN_EMAIL_ADDR_TXT
,GUARDN_CNSNT_IND
,ACNLGMT_DATE
,PR_REV_GROUP
,PR_GEOCODE_FAIL
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE 
,SYS_ERR_SVRTY
,DATA_SRCE_NBR
,POSTL_STATUS_CODE
,GL_ACCURACY
,GL_MATCH_FLAG
,GL_LATITUDE
,GL_LONGITUDE
,DR_CLEANSE_LEVEL
,CITY_CODE
,TERR_CODE
,POSTL_ADDR_ID)
SELECT
STG.CNTCT_POINT_CATEG_CODE
,COALESCE(TOUT.REGIS_PRSNA_ID,CAST(TOUT.REFERENCE_REGISTRATIONKEY AS INTEGER)) REFERENCE_REGISTRATIONKEY1
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.WINDOW_KEY_01
,STG.CNTCT_OPTN_NBR
,STG.CNTCT_OPTN_IND
,STG.CNSMR_CHCE_DATETM
,STG.PREFR_IND
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.STRET_NUM
,STG.STRET_NAME
,STG.APT_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,CASE WHEN TR.TERR_RECODE IS NOT NULL AND DR_COUNTRY_NAME NOT IN ('ESP','PRT')
            THEN TR.TERR_RECODE
            ELSE TOUT.DR_REGION_NAME
  END AS DR_REGION_NAME
,CASE WHEN CR.CNTRY_RECODE IS NOT NULL AND DR_COUNTRY_NAME NOT IN ('ESP','PRT')
      THEN CR.CNTRY_RECODE 
      ELSE TOUT.DR_COUNTRY_NAME
  END AS DR_COUNTRY_NAME
,STG.LAT_MEAS
,STG.LONG_MEAS
,CASE 
WHEN DR_COUNTRY_NAME IN ('ESP','PRT')
THEN COALESCE(STG.VALID_ADDR_IND,STG.VALID_IND)
ELSE 'Y'
END VALID_CNTCT_POINT_IND
,STG.GUARDN_NAME
,STG.GUARDN_EMAIL_ADDR_TXT
,STG.GUARDN_CNSNT_IND
,STG.ACNLGMT_DATE
,COALESCE(STG.PR_REV_GROUP,TRIM(TOUT.PR_REV_GROUP)) PR_REV_GROUP
,COALESCE(STG.PR_GEOCODE_FAIL,STG.TQ_GOUT_MATCH_LEVEL,TOUT.GOUT_MATCH_LEVEL)
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
,STG.SYS_TARGET_ID SYS_TARGET_ID1
,'AC' POSTL_STATUS_CODE
,STG.GL_ACCURACY
,STG.GL_MATCH_FLG
,GL_LATITUDE
,GL_LONGITUDE
,STG.DR_CLEANSE_LVL
,STG.CITY_CODE
,STG.TERR_CODE
,STG.POSTL_ADDR_ID
FROM
ADDR_TEMP TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND
TOUT.SYS_TARGET_ID = STG.SYS_TARGET_ID
AND TOUT.ADDRESS_CONTACT = STG.CNTCT_POINT_CATEG_CODE
AND COALESCE(TOUT.ADDRESS_SUBSCRPTN,'0') = COALESCE(STG.CNTCT_OPTN_NBR,0)
LEFT OUTER JOIN TERR_RECODE TR
ON TOUT.DR_REGION_NAME = TR.TERR
AND TOUT.DR_COUNTRY_NAME = TR.CNTRY
LEFT OUTER JOIN CNTRY_RECODE CR
ON TOUT.DR_COUNTRY_NAME = CR.CNTRY
WHERE TOUT.DR_COUNTRY_NAME IN ('IND','CHN','ESP','PRT')
AND TOUT.RECENT_IND = 'Y'
QUALIFY RANK() OVER (PARTITION BY REFERENCE_REGISTRATIONKEY1,STG.CNTCT_POINT_CATEG_CODE,COALESCE(STG.CNTCT_OPTN_NBR,0)
ORDER BY STG.SYS_CREATION_DATE DESC
,STG.SYS_SOURCE DESC
,STG.SYS_NC_TYPE DESC
,STG.CNSMR_CHCE_DATETM DESC
,TOUT.DR_ADDRESS DESC
,TOUT.WINDOW_KEY_01 DESC
) = 1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/* **************************************************
ADDRESS UPDATES
************************************************** */
/**********************************************************************************************
TERR CODE UPDATES
**********************************************************************************************/

/*********************************************************************************************
This update is to populate the PO_BOX_NUM attribute in case the address is a PO Box Num for USA
**********************************************************************************************/
UPDATE ADDR_INPUT
SET PO_BOX_NUM = CASE WHEN ADDR_LINE_1_TXT LIKE 'PO BOX%' 
                      THEN ADDR_LINE_1_TXT
                      ELSE NULL
                  END
WHERE 
--CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL)
 CNTRY_CODE IN ('USA','CAN');
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
This update is to populate the TERR_CODE with the TERR_NAME. TERR_NAME is populated with the 
output from Trillium
**********************************************************************************************/
UPDATE ADDR_INPUT
SET TERR_CODE = TERR_NAME;
--WHERE CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;



CREATE VOLATILE TABLE CNTRY_CODE AS
 (SEL 'DEU' AS CNTRY_CODE) 
 WITH DATA 
 ON COMMIT PRESERVE ROWS;
 .IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
 
SEL 1 FROM CNTRY_CODE WHERE CNTRY_CODE NOT IN ('AUS','CHN','TUR','IND','JPN','BRA','ARB','ISR','EGY','PAK','AFR','PAK','BGR','UKR','HRV','CZE');
.IF ACTIVITYCOUNT > 0 THEN .GOTO OTHERS
SEL 1 FROM CNTRY_CODE WHERE CNTRY_CODE IN ('CHN');
.IF ACTIVITYCOUNT > 0 THEN .GOTO CHINA
SEL 1 FROM CNTRY_CODE WHERE CNTRY_CODE IN ('AUS');
.IF ACTIVITYCOUNT > 0 THEN .GOTO AUSTRALIA
SEL 1 FROM CNTRY_CODE WHERE CNTRY_CODE IN ('TUR','BRA','ARB','ISR','EGY','PAK','AFR','PAK','BGR','UKR','HRV','CZE');
.IF ACTIVITYCOUNT > 0 THEN .GOTO TURKEY
SEL 1 FROM CNTRY_CODE WHERE CNTRY_CODE IN ('IND');
.IF ACTIVITYCOUNT > 0 THEN .GOTO INDIA
SEL 1 FROM CNTRY_CODE WHERE CNTRY_CODE IN ('JPN');
.IF ACTIVITYCOUNT > 0 THEN .GOTO JAPAN

/*********************************************************************************************
This update is to populate the TERR_CODE with the BR-/IN-/JP- prefix from the reference table as 
trillium does not provide the IN-/JP- prefix.
**********************************************************************************************/
.LABEL INDIA

UPDATE ADDR_INPUT FROM TERR a
SET TERR_CODE = a.TERR_CODE
WHERE ADDR_INPUT.TERR_CODE = a.TERR_CODE_NTV
AND a.CNTRY_CODE = 'IND' and ADDR_INPUT.CNTRY_CODE = 'IND';
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
This update is to populate the CITY_CODE from the CITY reference table.
**********************************************************************************************/
UPDATE PA
FROM ADDR_INPUT PA, CITY XR
SET CITY_CODE = XR.CITY_CODE
WHERE PA.TERR_CODE = XR.TERR_CODE
AND PA.CITY_NAME = XR.CITY_NAME
AND PA.CNTRY_CODE = 'IND';
----AND CAST(PA.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
This update is to populate the TERR_NAME from the TERR reference table FOR IND
**********************************************************************************************/

UPDATE ADDR_INPUT FROM TERR T
SET TERR_NAME = T.TERR_NAME
WHERE ADDR_INPUT.TERR_CODE = T.TERR_CODE
AND ADDR_INPUT.CNTRY_CODE IN('IND');
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.GOTO L1

/*********************************************************************************************
This update is to populate the TERR_CODE with the BR-/IN-/JP- prefix from the reference table as 
trillium does not provide the IN-/JP- prefix.
**********************************************************************************************/

.LABEL JAPAN

UPDATE ADDR_INPUT FROM TERR a
SET TERR_CODE = a.TERR_CODE
WHERE ADDR_INPUT.TERR_CODE = a.TERR_CODE_NTV
AND a.CNTRY_CODE = 'JPN' and ADDR_INPUT.CNTRY_CODE = 'JPN';
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;


/*********************************************************************************************
This update is to populate the CITY_CODE from the CITY reference table.
**********************************************************************************************/
UPDATE PA
FROM ADDR_INPUT PA, CITY XR
SET CITY_CODE = XR.CITY_CODE
WHERE PA.TERR_CODE = XR.TERR_CODE
AND PA.CITY_NAME = XR.CITY_NAME_NTV
AND PA.CNTRY_CODE = 'JPN';
--AND CAST(PA.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
This update is to populate the TERR_NAME from the TERR reference table FOR JPN
**********************************************************************************************/

UPDATE ADDR_INPUT FROM TERR T
SET TERR_NAME = T.TERR_NAME
WHERE ADDR_INPUT.TERR_CODE = T.TERR_CODE
AND ADDR_INPUT.CNTRY_CODE IN('JPN');
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.GOTO L1

.LABEL AUSTRALIA

/* UPDATE TERR_CODE & CITY_CODE FOR AUS */
/*********************************************************************************************
This update is to populate the CITY_CODE from the CITY reference table and POSTL_AREA if there
is no match in the CITY table.
**********************************************************************************************/
UPDATE ADDR_INPUT
FROM(SEL DISTINCT EDW.CITY_NAME,
EDW.POSTL_AREA_CODE,
EDW.CNTRY_CODE,
CASE WHEN C.CITY_NAME IS NOT NULL
     THEN C.CITY_CODE
     WHEN PA.POSTL_AREA_CODE IS NOT NULL
     THEN PA.CITY_CODE
     ELSE NULL END AS CITY_CODE,
CASE WHEN C.CITY_NAME IS NOT NULL
     THEN C.TERR_CODE
     WHEN PA.POSTL_AREA_CODE IS NOT NULL
     THEN PA.TERR_CODE
     ELSE NULL END AS TERR_CODE
FROM ADDR_INPUT EDW
LEFT OUTER JOIN
(SEL CITY_NAME,CITY_CODE,TERR_CODE FROM
CITY 
WHERE CITY_NAME NOT IN(SEL COALESCE(A.CITY_NAME,'') FROM(SEL CITY_NAME,COUNT(*) AS CNT FROM CITY
GROUP BY 1 
HAVING CNT>1)A))C
ON EDW.CITY_NAME = C.CITY_NAME
LEFT OUTER JOIN
(SEL POSTL_AREA_CODE,CNTRY_CODE,CITY_CODE,TERR_CODE
FROM POSTL_AREA WHERE (POSTL_AREA_CODE,CNTRY_CODE) NOT IN(SEL POSTL_AREA_CODE,CNTRY_CODE FROM
(SEL CNTRY_CODE,TERR_CODE,POSTL_AREA_CODE,CITY_CODE
FROM POSTL_AREA
GROUP BY 1,2,3,4) B
GROUP BY 1,2
HAVING COUNT(*) >1))PA
ON EDW.POSTL_AREA_CODE = PA.POSTL_AREA_CODE
AND
EDW.CNTRY_CODE = PA.CNTRY_CODE
WHERE EDW.CNTRY_CODE = 'AUS'
)A
SET CITY_CODE = A.CITY_CODE
, TERR_CODE = A.TERR_CODE
WHERE 
ADDR_INPUT.CITY_NAME = A.CITY_NAME
AND ADDR_INPUT.POSTL_AREA_CODE = A.POSTL_AREA_CODE
AND ADDR_INPUT.CNTRY_CODE = A.CNTRY_CODE;
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/* UPDATE TERR CODE & CITY CODE FOR RECORDS WHERE EDW.CITY_NAME IS NULL*/
UPDATE ADDR_INPUT
FROM(SEL DISTINCT 
--EDW.CITY_NAME,
EDW.POSTL_AREA_CODE,
EDW.CNTRY_CODE,
CASE --WHEN C.CITY_NAME IS NOT NULL
     --THEN C.CITY_CODE
     WHEN PA.POSTL_AREA_CODE IS NOT NULL
     THEN PA.CITY_CODE
     ELSE NULL END AS CITY_CODE,
CASE --WHEN C.CITY_NAME IS NOT NULL
     --THEN C.TERR_CODE
     WHEN PA.POSTL_AREA_CODE IS NOT NULL
     THEN PA.TERR_CODE
     ELSE NULL END AS TERR_CODE
FROM ADDR_INPUT EDW
LEFT OUTER JOIN
(SEL POSTL_AREA_CODE,CNTRY_CODE,CITY_CODE,TERR_CODE
FROM POSTL_AREA WHERE (POSTL_AREA_CODE,CNTRY_CODE) NOT IN(SEL POSTL_AREA_CODE,CNTRY_CODE FROM
(SEL CNTRY_CODE,TERR_CODE,POSTL_AREA_CODE,CITY_CODE
FROM POSTL_AREA
GROUP BY 1,2,3,4) B
GROUP BY 1,2
HAVING COUNT(*) >1))PA
ON EDW.POSTL_AREA_CODE = PA.POSTL_AREA_CODE
AND
EDW.CNTRY_CODE = PA.CNTRY_CODE
WHERE EDW.CNTRY_CODE = 'AUS'
AND EDW.CITY_NAME IS NULL
)A
SET CITY_CODE = A.CITY_CODE
, TERR_CODE = A.TERR_CODE
WHERE 
ADDR_INPUT.CITY_NAME IS NULL
AND ADDR_INPUT.POSTL_AREA_CODE = A.POSTL_AREA_CODE
AND ADDR_INPUT.CNTRY_CODE = A.CNTRY_CODE
AND ADDR_INPUT.CITY_CODE IS NULL;
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/* UPDATE TERR CODE & CITY CODE FOR RECORDS WHERE EDW.POSTAL_AREA_CODE IS NULL*/
UPDATE ADDR_INPUT
FROM(SEL DISTINCT 
EDW.CITY_NAME,
--EDW.POSTL_AREA_CODE,
EDW.CNTRY_CODE,
CASE WHEN C.CITY_NAME IS NOT NULL
     THEN C.CITY_CODE
     --WHEN PA.POSTL_AREA_CODE IS NOT NULL
     --THEN PA.CITY_CODE
     ELSE NULL END AS CITY_CODE,
CASE WHEN C.CITY_NAME IS NOT NULL
     THEN C.TERR_CODE
     --WHEN PA.POSTL_AREA_CODE IS NOT NULL
     --THEN PA.TERR_CODE
     ELSE NULL END AS TERR_CODE
FROM ADDR_INPUT EDW
LEFT OUTER JOIN
(SEL CITY_NAME,CITY_CODE,C.TERR_CODE,CNTRY_CODE FROM
CITY C
INNER JOIN TERR T
ON C.TERR_CODE=T.TERR_CODE 
WHERE CITY_NAME NOT IN(SEL COALESCE(A.CITY_NAME,'') FROM(SEL CITY_NAME,COUNT(*) AS CNT FROM CITY
GROUP BY 1 
HAVING CNT>1)A))C
ON EDW.CITY_NAME = C.CITY_NAME
AND EDW.CNTRY_CODE = C.CNTRY_CODE
WHERE EDW.CNTRY_CODE = 'AUS'
AND EDW.POSTL_AREA_CODE IS NULL
)A
SET CITY_CODE = A.CITY_CODE
, TERR_CODE = A.TERR_CODE
WHERE 
ADDR_INPUT.POSTL_AREA_CODE IS NULL
AND ADDR_INPUT.CITY_NAME = A.CITY_NAME
AND ADDR_INPUT.CNTRY_CODE = A.CNTRY_CODE
AND ADDR_INPUT.CITY_CODE IS NULL;
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE ADDR_INPUT FROM TERR T
SET TERR_CODE = T.TERR_CODE
WHERE ADDR_INPUT.TERR_NAME = T.TERR_NAME
AND ADDR_INPUT.TERR_CODE IS NULL
AND ADDR_INPUT.LEGAL_ENT_NBR IN(6);
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
This update is to populate the TERR_CODE from the TERR_RECODE_VAL reference table as the TERR
table does not have few native values. Customization requested from P&G.
**********************************************************************************************/

UPDATE ADDR_INPUT FROM TERR_RECODE_VAL T
SET TERR_CODE = T.TERR_CODE
WHERE ADDR_INPUT.TERR_NAME = T.TERR_NAME
--AND ADDR_INPUT.TERR_CODE IS NULL
AND ADDR_INPUT.CNTRY_CODE IN('AUS');
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE ADDR_INPUT
SET TERR_CODE = TERR_NAME
WHERE ADDR_INPUT.CNTRY_CODE IN('AUS')
AND ADDR_INPUT.TERR_CODE IS NULL;
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
This update is to populate the TERR_NAME from the TERR reference table FOR AUS
**********************************************************************************************/

UPDATE ADDR_INPUT FROM TERR T
SET TERR_NAME = T.TERR_NAME
WHERE ADDR_INPUT.TERR_CODE = T.TERR_CODE
AND ADDR_INPUT.CNTRY_CODE IN('AUS');
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.GOTO L1

.LABEL CHINA

/* UPDATE TERR_CODE & CITY_CODE FOR CHINA*/
/*********************************************************************************************
This update is to populate the CITY_CODE from the CITY reference table and POSTL_AREA if there
is no match in the CITY table.

Trillium provides the city name without the district value. Hence the TRIM on city name in the 
CITY table.
**********************************************************************************************/
UPDATE ADDR_INPUT
FROM(SEL DISTINCT EDW.CITY_NAME,
EDW.POSTL_AREA_CODE,
EDW.CNTRY_CODE,
CASE WHEN C.CITY_NAME_NTV IS NOT NULL
     THEN C.CITY_CODE
     WHEN C1.CITY_NAME_NTV1 IS NOT NULL
     THEN C1.CITY_CODE
     WHEN PA.POSTL_AREA_CODE IS NOT NULL
     THEN PA.CITY_CODE
     ELSE NULL END AS CITY_CODE,
CASE WHEN C.CITY_NAME_NTV IS NOT NULL
     THEN C.TERR_CODE
     WHEN C1.CITY_NAME_NTV1 IS NOT NULL
     THEN C1.TERR_CODE
     WHEN PA.POSTL_AREA_CODE IS NOT NULL
     THEN PA.TERR_CODE
     ELSE NULL END AS TERR_CODE
FROM ADDR_INPUT EDW
LEFT OUTER JOIN
(SEL CITY_NAME_NTV,CITY_CODE,TERR_CODE FROM
CITY 
WHERE CITY_NAME_NTV NOT IN(SEL COALESCE(A.CITY_NAME_NTV,'') FROM(SEL CITY_NAME_NTV,COUNT(*) AS CNT FROM CITY
GROUP BY 1 
HAVING CNT>1)A)
)C
ON EDW.CITY_NAME = C.CITY_NAME_NTV
LEFT OUTER JOIN
(SEL TRIM(TRAILING _UNICODE '5E02'XCV FROM CITY_NAME_NTV) CITY_NAME_NTV1,CITY_CODE,TERR_CODE FROM
CITY
WHERE TRIM(TRAILING _UNICODE '5E02'XCV FROM CITY.CITY_NAME_NTV) NOT IN(SEL COALESCE(B.CITY_NAME_NTV2,'') 
FROM(SEL TRIM(TRAILING _UNICODE '5E02'XCV FROM CITY_NAME_NTV) AS CITY_NAME_NTV2,COUNT(*) AS CNT FROM CITY
GROUP BY 1
HAVING CNT>1)B)
)C1
ON EDW.CITY_NAME = C1.CITY_NAME_NTV1
LEFT OUTER JOIN
(SEL POSTL_AREA_CODE,CNTRY_CODE,CITY_CODE,TERR_CODE
FROM POSTL_AREA WHERE (POSTL_AREA_CODE,CNTRY_CODE) NOT IN(SEL POSTL_AREA_CODE,CNTRY_CODE FROM
(SEL CNTRY_CODE,TERR_CODE,POSTL_AREA_CODE,CITY_CODE
FROM POSTL_AREA
GROUP BY 1,2,3,4) B
GROUP BY 1,2
HAVING COUNT(*) >1)) PA
ON EDW.POSTL_AREA_CODE = PA.POSTL_AREA_CODE
AND
EDW.CNTRY_CODE = PA.CNTRY_CODE
WHERE EDW.MKTNG_PGM_NBR IN(53,91,55,37,54,88,97,67,66,33,36,35,38,34,49,56)
)A
SET CITY_CODE = A.CITY_CODE
, TERR_CODE = A.TERR_CODE
WHERE 
ADDR_INPUT.CITY_NAME = A.CITY_NAME
AND ADDR_INPUT.POSTL_AREA_CODE = A.POSTL_AREA_CODE
AND ADDR_INPUT.CNTRY_CODE = A.CNTRY_CODE
AND ADDR_INPUT.MKTNG_PGM_NBR IN(53,91,55,37,54,88,97,67,66,33,36,35,38,34,49,56);
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/* UPDATE TERR_CODE & CITY_CODE FOR RECORDS HAVING EDW.CITY AS NULL */
UPDATE ADDR_INPUT
FROM(SEL DISTINCT 
--EDW.CITY_NAME,
EDW.POSTL_AREA_CODE,
EDW.CNTRY_CODE,
CASE --WHEN C.CITY_NAME_NTV IS NOT NULL
     --THEN C.CITY_CODE
     --WHEN C1.CITY_NAME_NTV1 IS NOT NULL
     --THEN C1.CITY_CODE
     WHEN PA.POSTL_AREA_CODE IS NOT NULL
     THEN PA.CITY_CODE
     ELSE NULL END AS CITY_CODE,
CASE --WHEN C.CITY_NAME_NTV IS NOT NULL
     --THEN C.TERR_CODE
     --WHEN C1.CITY_NAME_NTV1 IS NOT NULL
     --THEN C1.TERR_CODE
     WHEN PA.POSTL_AREA_CODE IS NOT NULL
     THEN PA.TERR_CODE
     ELSE NULL END AS TERR_CODE
FROM ADDR_INPUT EDW
/* LEFT OUTER JOIN
(SEL CITY_NAME_NTV,CITY_CODE,TERR_CODE FROM
CITY 
WHERE CITY_NAME_NTV NOT IN(SEL COALESCE(A.CITY_NAME_NTV,'') FROM(SEL CITY_NAME_NTV,COUNT(*) AS CNT FROM CITY
GROUP BY 1 
HAVING CNT>1)A)
)C
ON EDW.CITY_NAME = C.CITY_NAME_NTV
LEFT OUTER JOIN
(SEL TRIM(TRAILING _UNICODE '5E02'XCV FROM CITY_NAME_NTV) CITY_NAME_NTV1,CITY_CODE,TERR_CODE FROM
CITY
WHERE TRIM(TRAILING _UNICODE '5E02'XCV FROM CITY.CITY_NAME_NTV) NOT IN(SEL COALESCE(B.CITY_NAME_NTV2,'') 
FROM(SEL TRIM(TRAILING _UNICODE '5E02'XCV FROM CITY_NAME_NTV) AS CITY_NAME_NTV2,COUNT(*) AS CNT FROM CITY
GROUP BY 1
HAVING CNT>1)B)
)C1
ON EDW.CITY_NAME = C1.CITY_NAME_NTV1 */
LEFT OUTER JOIN
(SEL POSTL_AREA_CODE,CNTRY_CODE,CITY_CODE,TERR_CODE
FROM POSTL_AREA WHERE (POSTL_AREA_CODE,CNTRY_CODE) NOT IN(SEL POSTL_AREA_CODE,CNTRY_CODE FROM
(SEL CNTRY_CODE,TERR_CODE,POSTL_AREA_CODE,CITY_CODE
FROM POSTL_AREA
GROUP BY 1,2,3,4) B
GROUP BY 1,2
HAVING COUNT(*) >1)) PA
ON EDW.POSTL_AREA_CODE = PA.POSTL_AREA_CODE
AND
EDW.CNTRY_CODE = PA.CNTRY_CODE
WHERE EDW.MKTNG_PGM_NBR IN(53,91,55,37,54,88,97,67,66,33,36,35,38,34,49,56)
AND EDW.CITY_NAME IS NULL
)A
SET CITY_CODE = A.CITY_CODE
, TERR_CODE = A.TERR_CODE
WHERE 
ADDR_INPUT.CITY_NAME IS NULL
AND ADDR_INPUT.POSTL_AREA_CODE = A.POSTL_AREA_CODE
AND ADDR_INPUT.CNTRY_CODE = A.CNTRY_CODE
AND ADDR_INPUT.CITY_CODE IS NULL
AND ADDR_INPUT.MKTNG_PGM_NBR IN(53,91,55,37,54,88,97,67,66,33,36,35,38,34,49,56);
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/* UPDATE TERR CODE & CITY CODE FOR RECORDS HAVING POSTAL_AREA_CODE AS NULL*/
UPDATE ADDR_INPUT
FROM(SEL DISTINCT EDW.CITY_NAME,
--EDW.POSTL_AREA_CODE,
EDW.CNTRY_CODE,
CASE WHEN C.CITY_NAME_NTV IS NOT NULL
     THEN C.CITY_CODE
     WHEN C1.CITY_NAME_NTV1 IS NOT NULL
     THEN C1.CITY_CODE
     --WHEN PA.POSTL_AREA_CODE IS NOT NULL
     --THEN PA.CITY_CODE
     ELSE NULL END AS CITY_CODE,
CASE WHEN C.CITY_NAME_NTV IS NOT NULL
     THEN C.TERR_CODE
     WHEN C1.CITY_NAME_NTV1 IS NOT NULL
     THEN C1.TERR_CODE
     --WHEN PA.POSTL_AREA_CODE IS NOT NULL
     --THEN PA.TERR_CODE
     ELSE NULL END AS TERR_CODE
FROM ADDR_INPUT EDW
LEFT OUTER JOIN
(SEL CITY_NAME_NTV,CITY_CODE,TERR_CODE FROM
CITY 
WHERE CITY_NAME_NTV NOT IN(SEL COALESCE(A.CITY_NAME_NTV,'') FROM(SEL CITY_NAME_NTV,COUNT(*) AS CNT FROM CITY
GROUP BY 1 
HAVING CNT>1)A)
)C
ON EDW.CITY_NAME = C.CITY_NAME_NTV
LEFT OUTER JOIN
(SEL TRIM(TRAILING _UNICODE '5E02'XCV FROM CITY_NAME_NTV) CITY_NAME_NTV1,CITY_CODE,TERR_CODE FROM
CITY
WHERE TRIM(TRAILING _UNICODE '5E02'XCV FROM CITY.CITY_NAME_NTV) NOT IN(SEL COALESCE(B.CITY_NAME_NTV2,'') 
FROM(SEL TRIM(TRAILING _UNICODE '5E02'XCV FROM CITY_NAME_NTV) AS CITY_NAME_NTV2,COUNT(*) AS CNT FROM CITY
GROUP BY 1
HAVING CNT>1)B)
)C1
ON EDW.CITY_NAME = C1.CITY_NAME_NTV1
/* LEFT OUTER JOIN
(SEL POSTL_AREA_CODE,CNTRY_CODE,CITY_CODE,TERR_CODE
FROM POSTL_AREA WHERE (POSTL_AREA_CODE,CNTRY_CODE) NOT IN(SEL POSTL_AREA_CODE,CNTRY_CODE FROM
(SEL CNTRY_CODE,TERR_CODE,POSTL_AREA_CODE,CITY_CODE
FROM POSTL_AREA
GROUP BY 1,2,3,4) B
GROUP BY 1,2
HAVING COUNT(*) >1)) PA
ON EDW.POSTL_AREA_CODE = PA.POSTL_AREA_CODE
AND
EDW.CNTRY_CODE = PA.CNTRY_CODE */
WHERE EDW.MKTNG_PGM_NBR IN(53,91,55,37,54,88,97,67,66,33,36,35,38,34,49,56)
AND EDW.POSTL_AREA_CODE IS NULL
)A
SET CITY_CODE = A.CITY_CODE
, TERR_CODE = A.TERR_CODE
WHERE 
ADDR_INPUT.POSTL_AREA_CODE IS NULL
AND ADDR_INPUT.CITY_NAME = A.CITY_NAME
AND ADDR_INPUT.CNTRY_CODE = A.CNTRY_CODE
AND ADDR_INPUT.CITY_CODE IS NULL
AND ADDR_INPUT.MKTNG_PGM_NBR IN(53,91,55,37,54,88,97,67,66,33,36,35,38,34,49,56);
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
This update is to populate the TERR_CODE from the TERR reference table based on the native 
value.
**********************************************************************************************/

UPDATE ADDR_INPUT FROM TERR T
SET TERR_CODE = T.TERR_CODE
WHERE ADDR_INPUT.TERR_NAME = T.TERR_NAME_NTV
AND ADDR_INPUT.TERR_CODE IS NULL
AND ADDR_INPUT.MKTNG_PGM_NBR IN(53,91,55,37,54,88,97,67,66,33,36,35,38,34,49,56);
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
This update is to populate the CITY_CODE from the CITY_RECODE_VAL reference table as the CITY
table does not have few native values. Customization requested from P&G.
**********************************************************************************************/

UPDATE ADDR_INPUT FROM CITY_RECODE_VAL C
SET CITY_CODE = C.CITY_CODE
WHERE ADDR_INPUT.CITY_NAME = C.CITY_NAME
--AND ADDR_INPUT.CITY_CODE IS NULL
AND ADDR_INPUT.CNTRY_CODE IN('CHN');
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE ADDR_INPUT FROM CITY_RECODE_VAL C
SET TERR_CODE = C.TERR_CODE
WHERE ADDR_INPUT.CITY_NAME = C.CITY_NAME
--AND ADDR_INPUT.TERR_CODE IS NULL
AND ADDR_INPUT.CNTRY_CODE IN('CHN');
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE ADDR_INPUT
SET TERR_CODE = TERR_NAME
WHERE ADDR_INPUT.CNTRY_CODE IN('CHN')
AND ADDR_INPUT.TERR_CODE IS NULL;
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.GOTO L1

.LABEL OTHERS

SEL 1 FROM CNTRY_CODE WHERE CNTRY_CODE NOT IN(
'RUS','POL','HUN','LUX','FRA',
'BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK',
'FIN','NOR','SWE','GBR','PRT');
.IF ACTIVITYCOUNT > 0 THEN .GOTO USA

/*********************************************************************************************
Update TERR_CODE from POSTL_AREA for Europe - RUS,POL,HUN,LUX,FRA,BEL,NLD,ITA,GRC,
AUT,CHE,DEU,ESP,IRL,DNK,FIN,NOR,SWE,GBR,PRT if TERR_CODE not sent by Trillium
**********************************************************************************************/
UPDATE ADDR_INPUT FROM 
(SEL T.POSTL_AREA_CODE,T.CNTRY_CODE,
--T.TERR_CODE,T.CITY_CODE,C.CITY_NAME --PRB0041004
T.TERR_CODE,T.CITY_CODE,COALESCE( NULLIF(C.CITY_NAME_NTV,''),C.CITY_NAME) AS CITY_NAME --PRB0041004
FROM
POSTL_AREA T
INNER JOIN CITY C
ON T.CITY_CODE=C.CITY_CODE
AND T.TERR_CODE=C.TERR_CODE
WHERE T.CNTRY_CODE IN(
'RUS','POL','HUN','LUX','FRA',
'BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK',
'FIN','NOR','SWE','GBR','PRT')
AND (T.POSTL_AREA_CODE,T.CNTRY_CODE) NOT IN (SEL POSTL_AREA_CODE,CNTRY_CODE FROM
(SEL CNTRY_CODE,TERR_CODE,POSTL_AREA_CODE,CITY_CODE
FROM POSTL_AREA
WHERE CNTRY_CODE IN(
'RUS','POL','HUN','LUX','FRA',
'BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK',
'FIN','NOR','SWE','GBR','PRT')
GROUP BY 1,2,3,4) B
GROUP BY 1,2
HAVING COUNT(*) >1)
GROUP BY 1,2,3,4,5
) T
SET TERR_CODE = CASE WHEN COALESCE(TRIM(ADDR_INPUT.TERR_CODE),'')=''
                     THEN T.TERR_CODE
                     ELSE ADDR_INPUT.TERR_CODE
                 END
,CITY_CODE = CASE WHEN COALESCE(TRIM(ADDR_INPUT.CITY_CODE),'')=''
                     THEN T.CITY_CODE
                     ELSE ADDR_INPUT.CITY_CODE
                 END
,CITY_NAME = CASE WHEN COALESCE(TRIM(ADDR_INPUT.CITY_NAME),'')=''
                     THEN T.CITY_NAME
                     ELSE ADDR_INPUT.CITY_NAME
                 END                 
WHERE ADDR_INPUT.POSTL_AREA_CODE = T.POSTL_AREA_CODE
AND ADDR_INPUT.CNTRY_CODE = T.CNTRY_CODE
AND ADDR_INPUT.CNTRY_CODE IN(
'RUS','POL','HUN','LUX','FRA',
'BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK',
'FIN','NOR','SWE','GBR','PRT');
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
Update TERR_CODE from POSTL_AREA for GBR - if TERR_CODE sent by Trillium does not exist
in TERR.
**********************************************************************************************/
UPDATE ADDR_INPUT FROM 
(SEL T.POSTL_AREA_CODE,T.CNTRY_CODE,
--T.TERR_CODE,T.CITY_CODE,C.CITY_NAME --PRB0041004
T.TERR_CODE,T.CITY_CODE,COALESCE( NULLIF(C.CITY_NAME_NTV,''),C.CITY_NAME) AS CITY_NAME--PRB0041004
FROM
POSTL_AREA T
INNER JOIN CITY C
ON T.CITY_CODE=C.CITY_CODE
AND T.TERR_CODE=C.TERR_CODE
WHERE T.CNTRY_CODE IN(
'RUS','POL','HUN','LUX','FRA',
'BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK',
'FIN','NOR','SWE','GBR','PRT')
AND (T.POSTL_AREA_CODE,T.CNTRY_CODE) NOT IN (SEL POSTL_AREA_CODE,CNTRY_CODE FROM
(SEL CNTRY_CODE,TERR_CODE,POSTL_AREA_CODE,CITY_CODE
FROM POSTL_AREA
WHERE CNTRY_CODE IN(
'RUS','POL','HUN','LUX','FRA',
'BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK',
'FIN','NOR','SWE','GBR','PRT')
GROUP BY 1,2,3,4) B
GROUP BY 1,2
HAVING COUNT(*) >1)
GROUP BY 1,2,3,4,5
) T
SET TERR_CODE = T.TERR_CODE
,CITY_CODE = T.CITY_CODE
,CITY_NAME = T.CITY_NAME           
WHERE ADDR_INPUT.POSTL_AREA_CODE = T.POSTL_AREA_CODE
AND ADDR_INPUT.CNTRY_CODE = T.CNTRY_CODE
AND ADDR_INPUT.TERR_CODE NOT IN 
(SEL TERR_CODE FROM TERR WHERE CNTRY_CODE IN 
('RUS','POL','HUN','LUX','FRA',
'BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK',
'FIN','NOR','SWE','GBR','PRT')) 
AND ADDR_INPUT.CNTRY_CODE IN ('RUS','POL','HUN','LUX','FRA',
'BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK',
'FIN','NOR','SWE','GBR','PRT');
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL USA
/*********************************************************************************************
This update is to populate the CITY_CODE from the CITY reference table FOR USA and CAN
Europe Included - RUS,POL,HUN,LUX,FRA,BEL,NLD,ITA,GRC,
AUT,CHE,DEU,ESP,IRL,DNK,FIN,NOR,SWE,GBR,PRT
**********************************************************************************************/
UPDATE ADDR_INPUT FROM CITY C
SET CITY_CODE = C.CITY_CODE
--WHERE ADDR_INPUT.CITY_NAME = C.CITY_NAME --PRB0041004
WHERE (ADDR_INPUT.CITY_NAME = C.CITY_NAME--PRB0041004
OR ADDR_INPUT.CITY_NAME = C.CITY_NAME_NTV)--PRB0041004
AND ADDR_INPUT.TERR_CODE = C.TERR_CODE 
AND ADDR_INPUT.CITY_CODE IS NULL
AND ADDR_INPUT.CNTRY_CODE IN('USA','CAN',
'RUS','POL','HUN','LUX','FRA',
'BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK',
'FIN','NOR','SWE','GBR','PRT');
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
This update is to populate the TERR_NAME from the TERR reference table FOR USA and CAN
Europe Included - RUS,POL,HUN,LUX,FRA,BEL,NLD,ITA,GRC,
AUT,CHE,DEU,ESP,IRL,DNK,FIN,NOR,SWE,GBR,PRT
**********************************************************************************************/

UPDATE ADDR_INPUT FROM TERR T
--SET TERR_NAME = T.TERR_NAME --PRB0041004
SET TERR_NAME = COALESCE( NULLIF(T.TERR_NAME_NTV,''),T.TERR_NAME) --PRB0041004
WHERE ADDR_INPUT.TERR_CODE = T.TERR_CODE
AND ADDR_INPUT.CNTRY_CODE IN('USA','CAN',
'RUS','POL','HUN','LUX','FRA',
'BEL','NLD','ITA','GRC','AUT',
'CHE','DEU','ESP','IRL','DNK',
'FIN','NOR','SWE','GBR','PRT');
--AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM MDM_LOAD_CONTROL);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.GOTO L1

.LABEL TURKEY
/*********************************************************************************************
Update TERR_CODE from TERR for TUR/BRA if incoming terr name matches reference data
**********************************************************************************************/

UPDATE ADDR_INPUT FROM TERR A
SET TERR_CODE = A.TERR_CODE
WHERE (ADDR_INPUT.TERR_NAME = A.TERR_NAME
OR ADDR_INPUT.TERR_NAME = A.TERR_NAME_NTV)
AND ADDR_INPUT.CNTRY_CODE = A.CNTRY_CODE
AND ADDR_INPUT.CNTRY_CODE IN ('TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM'
,'EGY','ISR','KEN','MAR','NGA','PAK','ZAF','BGR','UKR','HRV','CZE');
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
Update CITY_CODE from CITY for TUR/BRA if incoming city name matches reference data
**********************************************************************************************/

UPDATE ADDR_INPUT FROM CITY A
SET CITY_CODE = A.CITY_CODE
WHERE (ADDR_INPUT.CITY_NAME = A.CITY_NAME
OR ADDR_INPUT.CITY_NAME = A.CITY_NAME_NTV)
AND ADDR_INPUT.TERR_CODE = A.TERR_CODE
AND ADDR_INPUT.CNTRY_CODE IN ('TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM'
,'EGY','ISR','KEN','MAR','NGA','PAK','ZAF','BGR','UKR','HRV','CZE');
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
Update CITY_CODE,TERR_CODE from POSTL_AREA/CITY for TUR/BRA if incoming city name and terr name
does not match reference data but postal area code matches reference data and incoming city name
is blank.
**********************************************************************************************/

UPDATE ADDR_INPUT FROM 
(SEL T.POSTL_AREA_CODE,T.CNTRY_CODE,
--T.TERR_CODE,T.CITY_CODE,C.CITY_NAME --PRB0041004
T.TERR_CODE,T.CITY_CODE,COALESCE( NULLIF(CITY_NAME_NTV,''),CITY_NAME) AS CITY_NAME --PRB0041004
FROM
POSTL_AREA T
INNER JOIN CITY C
ON T.CITY_CODE=C.CITY_CODE
AND T.TERR_CODE=C.TERR_CODE
WHERE T.CNTRY_CODE IN(
'TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM'
,'EGY','ISR','KEN','MAR','NGA','PAK','ZAF','BGR','UKR','HRV','CZE')
AND (T.POSTL_AREA_CODE,T.CNTRY_CODE) NOT IN (SEL POSTL_AREA_CODE,CNTRY_CODE FROM
(SEL CNTRY_CODE,TERR_CODE,POSTL_AREA_CODE,CITY_CODE
FROM POSTL_AREA
WHERE CNTRY_CODE IN(
'TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM'
,'EGY','ISR','KEN','MAR','NGA','PAK','ZAF','BGR','UKR','HRV','CZE')
GROUP BY 1,2,3,4) B
GROUP BY 1,2
HAVING COUNT(*) >1)
GROUP BY 1,2,3,4,5
) T
SET TERR_CODE = CASE WHEN TRIM(COALESCE(ADDR_INPUT.TERR_CODE,''))=''
                     THEN T.TERR_CODE
                     ELSE ADDR_INPUT.TERR_CODE
                 END 
,CITY_CODE = CASE WHEN TRIM(COALESCE(ADDR_INPUT.CITY_NAME,''))=''
                     THEN T.CITY_CODE
                     ELSE ADDR_INPUT.CITY_CODE
                 END
,CITY_NAME = CASE WHEN TRIM(COALESCE(ADDR_INPUT.CITY_NAME,''))=''
                     THEN T.CITY_NAME
                     ELSE ADDR_INPUT.CITY_NAME
                 END           
WHERE ADDR_INPUT.POSTL_AREA_CODE = T.POSTL_AREA_CODE
AND ADDR_INPUT.CNTRY_CODE = T.CNTRY_CODE
AND ADDR_INPUT.CNTRY_CODE IN ('TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM'
,'EGY','ISR','KEN','MAR','NGA','PAK','ZAF','BGR','UKR','HRV','CZE');
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/*********************************************************************************************
This update is to populate the TERR_NAME from the TERR reference table FOR TUR/BRA
**********************************************************************************************/

UPDATE ADDR_INPUT FROM TERR T
--SET TERR_NAME = T.TERR_NAME --PRB0041004
SET TERR_NAME = COALESCE( NULLIF(T.TERR_NAME_NTV,''),T.TERR_NAME) --PRB0041004
WHERE ADDR_INPUT.TERR_CODE = T.TERR_CODE
AND ADDR_INPUT.CNTRY_CODE IN('TUR','BRA','ARE','BHR','KWT','OMN','QAT','SAU','YEM'
,'EGY','ISR','KEN','MAR','NGA','PAK','ZAF','BGR','UKR','HRV','CZE');
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL L1

/*****************************************************************************
i60 Processing
OPT_OUT_DEU_LIST_TEMP is a temporary table to consolidate the negative REGIS_PRSNA_IDs from 
REGIS_PRSNA_OPT_OUT_HIST to be checked for during wrapper processing
******************************************************************************/
CREATE VOLATILE TABLE REG_OPT_OUT_TIME
AS 
(
 
SEL MIN(CNSMR_CHCE_DATETM) CNSMR_CHCE_DATETM
FROM
(SELECT	
MIN(ADJ.CNSMR_CHCE_DATETM) CNSMR_CHCE_DATETM
FROM 
PRSNA_EMAIL_ADDR_STG ADJ 
WHERE CAST(ADJ.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM  LOAD_INFO 
WHERE PROCESS_NAME = 'Wrapper' and cntry_name='DEU' and status='In Progress')
UNION
SELECT	
MIN(CAST(CAST(ADJ.CNSMR_CHCE_DATETM AS DATE) AS TIMESTAMP(0))) CNSMR_CHCE_DATETM
FROM 
ADDR_INPUT ADJ 
WHERE CAST(ADJ.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM  LOAD_INFO 
WHERE PROCESS_NAME = 'Wrapper' and cntry_name='DEU' and status='In Progress')
UNION
SELECT	
MIN(ADJ.CNSMR_CHCE_DATETM) CNSMR_CHCE_DATETM
FROM 
PRSNA_PHONE_STG ADJ 
WHERE CAST(ADJ.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM  LOAD_INFO 
WHERE PROCESS_NAME = 'Wrapper' and cntry_name='DEU' and status='In Progress')
UNION
SELECT	
MIN(ADJ.CNSMR_CHCE_DATETM) CNSMR_CHCE_DATETM
FROM 
PRSNA_SOC_NETWK_ACCT_STG ADJ 
WHERE CAST(ADJ.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM  LOAD_INFO 
WHERE PROCESS_NAME = 'Wrapper' and cntry_name='DEU' and status='In Progress')
) A
)
WITH DATA
PRIMARY INDEX ( CNSMR_CHCE_DATETM )
ON COMMIT PRESERVE ROWS
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE POSTL AS (
SELECT	1 AS CNT
)
WITH DATA
PRIMARY INDEX (CNT)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

SEL 1 FROM REG_OPT_OUT_TIME
WHERE CNSMR_CHCE_DATETM IS NOT NULL;
.IF ACTIVITYCOUNT > 0 THEN .GOTO OPTPROCESS
.IF ACTIVITYCOUNT = 0 THEN .GOTO i10

.LABEL OPTPROCESS

DROP TABLE POSTL;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE POSTL AS (
SELECT	
COALESCE(TRIM(ADJ.CNTRY_CODE),'') CNTRY_NAME, 
COALESCE(TRIM(ADJ.ADDR_LINE_1_TXT),'') ADDR_LINE_1_TXT, 
COALESCE(TRIM(ADJ.ADDR_LINE_2_TXT),'') ADDR_LINE_2_TXT,
COALESCE(TRIM(ADJ.ADDR_LINE_3_TXT),'') ADDR_LINE_3_TXT,
COALESCE(TRIM(ADJ.CITY_NAME),'') CITY_NAME,
COALESCE(TRIM(ADJ.TERR_NAME),'') TERR_NAME,
COALESCE(TRIM(ADJ.POSTL_AREA_CODE),'') POSTL_AREA_CODE,
ADJ.MKTNG_PGM_NBR, 
ADJ.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR,
ADJ.LEGAL_ENT_NBR,
ADJ.SYS_TARGET_ID, 
ADJ.REGIS_PRSNA_ID,
ADJ.CNSMR_CHCE_DATETM,
CAST(ADJ.SYS_SOURCE AS INTEGER) SYS_SOURCE
FROM ADDR_INPUT ADJ
WHERE COALESCE(TRIM(ADDR_LINE_1_TXT),TRIM(ADDR_LINE_2_TXT),TRIM(ADDR_LINE_3_TXT),'') <> ''
)
WITH DATA
PRIMARY INDEX (CNTRY_NAME,ADDR_LINE_1_TXT,ADDR_LINE_2_TXT,ADDR_LINE_3_TXT,
CITY_NAME,TERR_NAME,POSTL_AREA_CODE,MKTNG_PGM_NBR,CNSMR_CHCE_DATETM,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN ADDR_LINE_1_TXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN ADDR_LINE_2_TXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN ADDR_LINE_3_TXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN CITY_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN TERR_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN POSTL_AREA_CODE;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN CNTRY_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN CNSMR_CHCE_DATETM;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL
COLUMN REGIS_PRSNA_ID;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE PHONE AS (
SELECT	
COALESCE(TRIM(ADJ.FULL_PHONE_NUM),'') FULL_PHONE_NUM,
ADJ.MKTNG_PGM_NBR, 
ADJ.CNTCT_OPTN_NBR AS SUBSCRPTN_OPT_NBR, 
B.LEGAL_ENT_NBR,
ADJ.SYS_TARGET_ID,
B.REGIS_PRSNA_ID,
ADJ.CNSMR_CHCE_DATETM,
ADJ.LOAD_ID SYS_SOURCE
FROM 
PRSNA_PHONE_STG ADJ
INNER JOIN TSS_PRSNA_IDS_DEU B
	ON	ADJ.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	ADJ.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND	ADJ.SYS_SOURCE=B.SYS_SOURCE
WHERE CAST(ADJ.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM  LOAD_INFO 
WHERE PROCESS_NAME = 'Wrapper' and cntry_name='DEU' and status='In Progress')
AND COALESCE(TRIM(FULL_PHONE_NUM),'') <> ''
)
WITH DATA
PRIMARY INDEX (FULL_PHONE_NUM,MKTNG_PGM_NBR,CNSMR_CHCE_DATETM,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS PHONE
COLUMN FULL_PHONE_NUM;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS PHONE
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS PHONE
COLUMN CNSMR_CHCE_DATETM;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS PHONE
COLUMN REGIS_PRSNA_ID;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
CREATE VOLATILE TABLE EMAIL AS (
SELECT	
COALESCE(TRIM(ADJ.EMAIL_ADDR_TXT),'') EMAIL_ADDR_TXT,
ADJ.MKTNG_PGM_NBR, 
ADJ.CNTCT_OPTN_NBR AS SUBSCRPTN_OPT_NBR, 
B.LEGAL_ENT_NBR,
ADJ.SYS_TARGET_ID,
B.REGIS_PRSNA_ID,
ADJ.CNSMR_CHCE_DATETM,
ADJ.LOAD_ID SYS_SOURCE
FROM 
PRSNA_EMAIL_ADDR_STG ADJ
INNER JOIN TSS_PRSNA_IDS_DEU B
ON	ADJ.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	ADJ.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND	ADJ.SYS_SOURCE=B.SYS_SOURCE
WHERE CAST(ADJ.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM  LOAD_INFO 
WHERE PROCESS_NAME = 'Wrapper' and cntry_name='DEU' and status='In Progress')
AND COALESCE(TRIM(ADJ.EMAIL_ADDR_TXT),'') <> ''
)
WITH DATA
PRIMARY INDEX (EMAIL_ADDR_TXT,MKTNG_PGM_NBR,CNSMR_CHCE_DATETM,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS EMAIL
COLUMN EMAIL_ADDR_TXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS EMAIL
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS EMAIL
COLUMN CNSMR_CHCE_DATETM;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS EMAIL
COLUMN REGIS_PRSNA_ID;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE ADDR_INPUT_MPN AS (
SELECT 
      REGIS_PRSNA_ID,
      MKTNG_PGM_NBR,
      LEGAL_ENT_NBR
FROM
    TSS_PRSNA_IDS_DEU
)
WITH DATA
PRIMARY INDEX  ( REGIS_PRSNA_ID ,MKTNG_PGM_NBR )
PARTITION BY MKTNG_PGM_NBR 
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS ON ADDR_INPUT_MPN COLUMN(PARTITION); 
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON ADDR_INPUT_MPN COLUMN(PARTITION,MKTNG_PGM_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON ADDR_INPUT_MPN COLUMN(MKTNG_PGM_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE NATIONAL_ID_NBR AS (
SELECT	
COALESCE(TRIM(ADJ.NATIONAL_ID_NBR),'') NATIONAL_ID_NBR, 
ADJ.MKTNG_PGM_NBR, 
ADJ.LEGAL_ENT_NBR,
ADJ.SYS_TARGET_ID,
ADJ.REGIS_PRSNA_ID,
CAST(ADJ.SYS_SOURCE AS INTEGER) SYS_SOURCE
FROM (
        SELECT
            RP.MATCHD_CNSMR_PRSNA_ID
           ,RP.LEGAL_ENT_NBR
           ,RP.REGIS_PRSNA_ID
           ,RP.MKTNG_PGM_NBR
           ,RP.DATA_SRCE_NBR 
           ,RP.NATIONAL_ID_NBR
           ,RP.SYS_TARGET_ID
           ,RP.SYS_SOURCE
        FROM
            REGIS_PRSNA RP
        JOIN 
            ADDR_INPUT_MPN TM
        ON
            RP.REGIS_PRSNA_ID = TM.REGIS_PRSNA_ID
        AND
            RP.MKTNG_PGM_NBR = TM.MKTNG_PGM_NBR
    ) ADJ 
WHERE COALESCE(TRIM(NATIONAL_ID_NBR),'') <> ''
)
WITH DATA
PRIMARY INDEX (NATIONAL_ID_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS NATIONAL_ID_NBR
COLUMN NATIONAL_ID_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS NATIONAL_ID_NBR
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
CREATE VOLATILE TABLE OPT_OUT_HIST AS (
SELECT
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
DATA_SRCE_NBR                 ,
SUBSCRIPTION_NBR              ,
FIRST_NAME                    ,
LAST_NAME                     ,
EMAIL_ADDR_TEXT              ,
CONTACT_PHONE_NBR             ,
SRC_ADDR_LINE_1_TXT           ,
SRC_ADDR_LINE_2_TXT           ,
SRC_ADDR_LINE_3_TXT           ,
SRC_CITY_NAME                 ,
SRC_STATE                     ,
SRC_ZIP                       ,
SRC_CNTRY_NAME                ,
COALESCE(TRIM(ADDR_LINE_1_TXT),'') ADDR_LINE_1_TXT              ,
COALESCE(TRIM(ADDR_LINE_2_TXT),'') ADDR_LINE_2_TXT              ,
COALESCE(TRIM(ADDR_LINE_3_TXT),'') ADDR_LINE_3_TXT              ,
COALESCE(TRIM(CITY_NAME      ),'') CITY_NAME              ,
COALESCE(TRIM(TERR_NAME      ),'') TERR_NAME              ,
COALESCE(TRIM(POSTL_AREA_CODE),'') POSTL_AREA_CODE              ,
COALESCE(TRIM(CNTRY_NAME     ),'') CNTRY_NAME              ,
OPT_IND                       ,
OPT_TIME                  ,
OPT_REASN_TXT             ,
OPT_TYPE_CODE,
LAST_ACTIVITY_TM              ,
LOG_SOURCE_ID                 ,
LOG_UPDATE_USER               ,
LOG_LOAD_ID             ,
PE_OPTOUT_ID   ,
NATIONAL_ID_NBR	,
CHANNEL_IND    , 
OPT_LEVEL_IND  
FROM REGIS_PRSNA_OPT_OUT_HIST  
WHERE OPT_LEVEL_IND IS NOT NULL 
AND OPT_IND='O' 
AND REGIS_PRSNA_ID<0
AND LEGAL_ENT_NBR IN (SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1)
AND OPT_TIME>=(SEL CNSMR_CHCE_DATETM FROM REG_OPT_OUT_TIME)
AND COALESCE(TRIM(ADDR_LINE_1_TXT),'') IN (SEL ADDR_LINE_1_TXT FROM POSTL)
AND COALESCE(TRIM(ADDR_LINE_2_TXT),'') IN (SEL ADDR_LINE_2_TXT FROM POSTL) 
AND COALESCE(TRIM(ADDR_LINE_3_TXT),'') IN (SEL ADDR_LINE_3_TXT FROM POSTL) 
AND COALESCE(TRIM(ADDR_LINE_1_TXT),TRIM(ADDR_LINE_2_TXT),TRIM(ADDR_LINE_3_TXT),'') <> ''
QUALIFY RANK() OVER(PARTITION BY COALESCE(TRIM(ADDR_LINE_1_TXT),'') ,
COALESCE(TRIM(ADDR_LINE_2_TXT),'') ,
COALESCE(TRIM(ADDR_LINE_3_TXT),'') ,
COALESCE(TRIM(CITY_NAME      ),'') ,
COALESCE(TRIM(TERR_NAME      ),'') ,
COALESCE(TRIM(POSTL_AREA_CODE),'') ,
COALESCE(TRIM(CNTRY_NAME     ),'') 
,MKTNG_PGM_NBR,SUBSCRIPTION_NBR,CHANNEL_IND,OPT_LEVEL_IND 
ORDER BY OPT_TIME DESC,LOG_SOURCE_ID DESC,REGIS_PRSNA_ID DESC)=1
)
WITH DATA
PRIMARY INDEX (CNTRY_NAME,ADDR_LINE_1_TXT,ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT,CITY_NAME,TERR_NAME,POSTL_AREA_CODE,MKTNG_PGM_NBR,OPT_TIME,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS OPT_OUT_HIST
COLUMN ADDR_LINE_1_TXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN ADDR_LINE_2_TXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN ADDR_LINE_3_TXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN CITY_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN TERR_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN POSTL_AREA_CODE;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN CNTRY_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN LAST_NAME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST
COLUMN OPT_TIME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE OPT_OUT_HIST_PHONE AS (
SELECT
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
DATA_SRCE_NBR                 ,
SUBSCRIPTION_NBR              ,
FIRST_NAME                    ,
LAST_NAME                     ,
EMAIL_ADDR_TEXT              ,
COALESCE(TRIM(CONTACT_PHONE_NBR),'') CONTACT_PHONE_NBR             ,
SRC_ADDR_LINE_1_TXT           ,
SRC_ADDR_LINE_2_TXT           ,
SRC_ADDR_LINE_3_TXT           ,
SRC_CITY_NAME                 ,
SRC_STATE                     ,
SRC_ZIP                       ,
SRC_CNTRY_NAME                ,
ADDR_LINE_1_TXT              ,
ADDR_LINE_2_TXT              ,
ADDR_LINE_3_TXT              ,
CITY_NAME              ,
TERR_NAME              ,
POSTL_AREA_CODE              ,
CNTRY_NAME              ,
OPT_IND                       ,
OPT_TIME                  ,
OPT_REASN_TXT             ,
OPT_TYPE_CODE,
LAST_ACTIVITY_TM              ,
LOG_SOURCE_ID                 ,
LOG_UPDATE_USER               ,
LOG_LOAD_ID             ,
PE_OPTOUT_ID   ,
NATIONAL_ID_NBR	,
CHANNEL_IND    ,
OPT_LEVEL_IND  
FROM REGIS_PRSNA_OPT_OUT_HIST  
WHERE OPT_LEVEL_IND IS NOT NULL 
AND OPT_IND='O'  
AND REGIS_PRSNA_ID<0
AND LEGAL_ENT_NBR IN (SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1)
AND OPT_TIME>=(SEL CNSMR_CHCE_DATETM FROM REG_OPT_OUT_TIME)
AND COALESCE(TRIM(CONTACT_PHONE_NBR),'') <> ''
AND COALESCE(TRIM(CONTACT_PHONE_NBR),'') IN (SEL FULL_PHONE_NUM FROM PHONE)
QUALIFY RANK() OVER(PARTITION BY COALESCE(TRIM(CONTACT_PHONE_NBR),'')
,MKTNG_PGM_NBR,SUBSCRIPTION_NBR,CHANNEL_IND,OPT_LEVEL_IND 
ORDER BY OPT_TIME DESC,LOG_SOURCE_ID DESC,REGIS_PRSNA_ID DESC)=1
)
WITH DATA
PRIMARY INDEX (CONTACT_PHONE_NBR,MKTNG_PGM_NBR,OPT_TIME,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST_PHONE
COLUMN CONTACT_PHONE_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST_PHONE
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST_PHONE
COLUMN OPT_TIME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE OPT_OUT_HIST_NATIONAL_ID_NBR AS (
SELECT
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
DATA_SRCE_NBR                 ,
SUBSCRIPTION_NBR              ,
FIRST_NAME                    ,
LAST_NAME                     ,
EMAIL_ADDR_TEXT              ,
CONTACT_PHONE_NBR             ,
SRC_ADDR_LINE_1_TXT           ,
SRC_ADDR_LINE_2_TXT           ,
SRC_ADDR_LINE_3_TXT           ,
SRC_CITY_NAME                 ,
SRC_STATE                     ,
SRC_ZIP                       ,
SRC_CNTRY_NAME                ,
ADDR_LINE_1_TXT              ,
ADDR_LINE_2_TXT              ,
ADDR_LINE_3_TXT              ,
CITY_NAME              ,
TERR_NAME              ,
POSTL_AREA_CODE              ,
CNTRY_NAME              ,
OPT_IND                       ,
OPT_TIME                  ,
OPT_REASN_TXT             ,
OPT_TYPE_CODE,
LAST_ACTIVITY_TM              ,
LOG_SOURCE_ID                 ,
LOG_UPDATE_USER               ,
LOG_LOAD_ID                   ,
PE_OPTOUT_ID   ,
COALESCE(TRIM(NATIONAL_ID_NBR),'') NATIONAL_ID_NBR              ,
CHANNEL_IND    ,
OPT_LEVEL_IND  
FROM REGIS_PRSNA_OPT_OUT_HIST  
WHERE OPT_LEVEL_IND IS NOT NULL 
AND OPT_IND='O'  
AND REGIS_PRSNA_ID<0
AND LEGAL_ENT_NBR IN (SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1)
AND OPT_TIME>=(SEL CNSMR_CHCE_DATETM FROM REG_OPT_OUT_TIME)
AND COALESCE(TRIM(NATIONAL_ID_NBR),'') <> ''
AND COALESCE(TRIM(NATIONAL_ID_NBR),'') IN (SEL NATIONAL_ID_NBR FROM NATIONAL_ID_NBR)
QUALIFY RANK() OVER(PARTITION BY COALESCE(TRIM(NATIONAL_ID_NBR),'')
,MKTNG_PGM_NBR,SUBSCRIPTION_NBR,CHANNEL_IND,OPT_LEVEL_IND 
ORDER BY OPT_TIME DESC,LOG_SOURCE_ID DESC,REGIS_PRSNA_ID DESC)=1
)
WITH DATA
PRIMARY INDEX (NATIONAL_ID_NBR,MKTNG_PGM_NBR,OPT_TIME,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS OPT_OUT_HIST_NATIONAL_ID_NBR
COLUMN NATIONAL_ID_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST_NATIONAL_ID_NBR
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST_NATIONAL_ID_NBR
COLUMN OPT_TIME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE OPT_OUT_HIST_EMAIL AS (
SELECT
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
DATA_SRCE_NBR                 ,
SUBSCRIPTION_NBR              ,
FIRST_NAME                    ,
LAST_NAME                     ,
COALESCE(TRIM(EMAIL_ADDR_TEXT),'') EMAIL_ADDR_TEXT              ,
CONTACT_PHONE_NBR             ,
SRC_ADDR_LINE_1_TXT           ,
SRC_ADDR_LINE_2_TXT           ,
SRC_ADDR_LINE_3_TXT           ,
SRC_CITY_NAME                 ,
SRC_STATE                     ,
SRC_ZIP                       ,
SRC_CNTRY_NAME                ,
ADDR_LINE_1_TXT              ,
ADDR_LINE_2_TXT              ,
ADDR_LINE_3_TXT              ,
CITY_NAME              ,
TERR_NAME              ,
POSTL_AREA_CODE              ,
CNTRY_NAME              ,
OPT_IND                       ,
OPT_TIME                  ,
OPT_REASN_TXT             ,
OPT_TYPE_CODE,
LAST_ACTIVITY_TM              ,
LOG_SOURCE_ID                 ,
LOG_UPDATE_USER               ,
LOG_LOAD_ID                   ,
PE_OPTOUT_ID   ,
NATIONAL_ID_NBR	,
CHANNEL_IND    ,
OPT_LEVEL_IND  
FROM REGIS_PRSNA_OPT_OUT_HIST  
WHERE OPT_LEVEL_IND IS NOT NULL 
AND OPT_IND='O'  
AND REGIS_PRSNA_ID<0
AND LEGAL_ENT_NBR IN (SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1)
AND OPT_TIME>=(SEL CNSMR_CHCE_DATETM FROM REG_OPT_OUT_TIME)
AND COALESCE(TRIM(EMAIL_ADDR_TEXT),'') <> ''
AND COALESCE(TRIM(EMAIL_ADDR_TEXT),'') IN (SEL EMAIL_ADDR_TXT FROM EMAIL)
QUALIFY RANK() OVER(PARTITION BY COALESCE(TRIM(EMAIL_ADDR_TEXT),'')
,MKTNG_PGM_NBR,SUBSCRIPTION_NBR,CHANNEL_IND,OPT_LEVEL_IND
ORDER BY OPT_TIME DESC,LOG_SOURCE_ID DESC,REGIS_PRSNA_ID DESC)=1
)
WITH DATA
PRIMARY INDEX (EMAIL_ADDR_TEXT,MKTNG_PGM_NBR,OPT_TIME,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS OPT_OUT_HIST_EMAIL
COLUMN EMAIL_ADDR_TEXT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST_EMAIL
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS OPT_OUT_HIST_EMAIL
COLUMN OPT_TIME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE TEMP1 AS (
SEL MATCHD_CNSMR_PRSNA_ID,LEGAL_ENT_NBR,
HSHLD_PRSNA_ID FROM
MATCHD_CNSMR_PRSNA 
WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1)
)
WITH DATA
PRIMARY INDEX (MATCHD_CNSMR_PRSNA_ID,LEGAL_ENT_NBR)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS ON TEMP1 COLUMN(LEGAL_ENT_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON TEMP1 COLUMN(MATCHD_CNSMR_PRSNA_ID);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON TEMP1 COLUMN(HSHLD_PRSNA_ID);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE TEMP2 AS (
SEL HSHLD_PRSNA_ID,LEGAL_ENT_NBR,
MATCHD_CNSMR_PRSNA_ID FROM
MATCHD_CNSMR_PRSNA 
WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1)
)
WITH DATA
PRIMARY INDEX (HSHLD_PRSNA_ID,LEGAL_ENT_NBR,MATCHD_CNSMR_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS ON TEMP2 COLUMN(LEGAL_ENT_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON TEMP2 COLUMN(MATCHD_CNSMR_PRSNA_ID);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON TEMP2 COLUMN(HSHLD_PRSNA_ID);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE TEMP3 AS (
SEL MATCHD_CNSMR_PRSNA_ID,LEGAL_ENT_NBR,
REGIS_PRSNA_ID,
MKTNG_PGM_NBR,DATA_SRCE_NBR FROM
REGIS_PRSNA 
WHERE MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))
)
WITH DATA
PRIMARY INDEX (MATCHD_CNSMR_PRSNA_ID,LEGAL_ENT_NBR)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS ON TEMP3 COLUMN(LEGAL_ENT_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON TEMP3 COLUMN(MATCHD_CNSMR_PRSNA_ID);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON TEMP3 COLUMN(REGIS_PRSNA_ID);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE ADDR_INPUT_MPN_MC AS (
        SELECT
            RP.MATCHD_CNSMR_PRSNA_ID
           ,RP.LEGAL_ENT_NBR
           ,RP.REGIS_PRSNA_ID
           ,RP.MKTNG_PGM_NBR
           ,RP.DATA_SRCE_NBR 
        FROM
            REGIS_PRSNA RP
        JOIN 
            ADDR_INPUT_MPN TM
        ON
            RP.REGIS_PRSNA_ID = TM.REGIS_PRSNA_ID
        AND
            RP.MKTNG_PGM_NBR = TM.MKTNG_PGM_NBR
)
WITH DATA
PRIMARY INDEX (MATCHD_CNSMR_PRSNA_ID,LEGAL_ENT_NBR,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS ON ADDR_INPUT_MPN_MC COLUMN(LEGAL_ENT_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON ADDR_INPUT_MPN_MC COLUMN(MATCHD_CNSMR_PRSNA_ID);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE OPT_OUT_PRSNA_ID AS (
SEL 
RP.REGIS_PRSNA_ID,
RP.MKTNG_PGM_NBR,
RP2.REGIS_PRSNA_ID RP2_REGIS_PRSNA_ID,
RP2.MKTNG_PGM_NBR RP2_MKTNG_PGM_NBR,
RP2.LEGAL_ENT_NBR RP2_LEGAL_ENT_NBR,
RP2.DATA_SRCE_NBR RP2_DATA_SRCE_NBR
FROM ADDR_INPUT_MPN_MC RP
INNER JOIN TEMP3 RP2
ON RP2.MATCHD_CNSMR_PRSNA_ID=RP.MATCHD_CNSMR_PRSNA_ID 
AND RP2.LEGAL_ENT_NBR = RP.LEGAL_ENT_NBR
)
WITH DATA
PRIMARY INDEX (REGIS_PRSNA_ID,MKTNG_PGM_NBR)
PARTITION BY MKTNG_PGM_NBR
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS ON OPT_OUT_PRSNA_ID COLUMN(PARTITION); 
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON OPT_OUT_PRSNA_ID COLUMN(PARTITION,MKTNG_PGM_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON OPT_OUT_PRSNA_ID COLUMN(MKTNG_PGM_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON OPT_OUT_PRSNA_ID COLUMN(REGIS_PRSNA_ID);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE OPT_OUT_PRSNA_ID2 AS (
SEL 
RP.REGIS_PRSNA_ID,
RP.MKTNG_PGM_NBR,
RP2.REGIS_PRSNA_ID RP2_REGIS_PRSNA_ID,
RP2.MKTNG_PGM_NBR RP2_MKTNG_PGM_NBR,
RP2.LEGAL_ENT_NBR RP2_LEGAL_ENT_NBR,
RP2.DATA_SRCE_NBR RP2_DATA_SRCE_NBR
FROM ADDR_INPUT_MPN_MC RP

INNER JOIN TEMP3 RP2
ON RP2.MATCHD_CNSMR_PRSNA_ID=RP.MATCHD_CNSMR_PRSNA_ID 
AND RP2.LEGAL_ENT_NBR = RP.LEGAL_ENT_NBR
AND RP2.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
)
WITH DATA
PRIMARY INDEX (REGIS_PRSNA_ID,MKTNG_PGM_NBR)
PARTITION BY MKTNG_PGM_NBR
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS ON OPT_OUT_PRSNA_ID2 COLUMN(PARTITION); 
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON OPT_OUT_PRSNA_ID2 COLUMN(PARTITION,MKTNG_PGM_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON OPT_OUT_PRSNA_ID2 COLUMN(MKTNG_PGM_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON OPT_OUT_PRSNA_ID2 COLUMN(REGIS_PRSNA_ID);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE TEMP4 AS (
SEL 
RP.REGIS_PRSNA_ID,
RP.MKTNG_PGM_NBR,
MC.HSHLD_PRSNA_ID,
MC.LEGAL_ENT_NBR,
MC.MATCHD_CNSMR_PRSNA_ID
FROM ADDR_INPUT_MPN_MC RP

INNER JOIN TEMP1 MC
ON RP.MATCHD_CNSMR_PRSNA_ID=MC.MATCHD_CNSMR_PRSNA_ID 
AND RP.LEGAL_ENT_NBR = MC.LEGAL_ENT_NBR
)
WITH DATA
PRIMARY INDEX (MKTNG_PGM_NBR,REGIS_PRSNA_ID)
PARTITION BY MKTNG_PGM_NBR
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS ON TEMP4 COLUMN(LEGAL_ENT_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON TEMP4 COLUMN(MATCHD_CNSMR_PRSNA_ID);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON TEMP4 COLUMN(HSHLD_PRSNA_ID);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS ON TEMP4 COLUMN(PARTITION); 
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON TEMP4 COLUMN(PARTITION,MKTNG_PGM_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON TEMP4 COLUMN(MKTNG_PGM_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON TEMP4 COLUMN(REGIS_PRSNA_ID);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE OPT_OUT_HSHLD_ID AS (
SEL 
RP.REGIS_PRSNA_ID,
RP.MKTNG_PGM_NBR,
RP3.REGIS_PRSNA_ID RP3_REGIS_PRSNA_ID,
RP3.MKTNG_PGM_NBR RP3_MKTNG_PGM_NBR,
RP3.LEGAL_ENT_NBR RP3_LEGAL_ENT_NBR,
RP3.DATA_SRCE_NBR RP3_DATA_SRCE_NBR
FROM TEMP4 RP

INNER JOIN TEMP2 MC1
ON MC1.HSHLD_PRSNA_ID=RP.HSHLD_PRSNA_ID 
AND MC1.LEGAL_ENT_NBR = RP.LEGAL_ENT_NBR

INNER JOIN TEMP3 RP3
ON MC1.MATCHD_CNSMR_PRSNA_ID=RP3.MATCHD_CNSMR_PRSNA_ID 
AND MC1.LEGAL_ENT_NBR = RP3.LEGAL_ENT_NBR
)
WITH DATA
PRIMARY INDEX (REGIS_PRSNA_ID,MKTNG_PGM_NBR,RP3_REGIS_PRSNA_ID)
PARTITION BY MKTNG_PGM_NBR
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS ON OPT_OUT_HSHLD_ID COLUMN(PARTITION); 
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON OPT_OUT_HSHLD_ID COLUMN(PARTITION,MKTNG_PGM_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON OPT_OUT_HSHLD_ID COLUMN(MKTNG_PGM_NBR);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS ON OPT_OUT_HSHLD_ID COLUMN(REGIS_PRSNA_ID);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

DELETE FROM OPT_OUT_LIST_DEU ALL;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'1'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

INNER JOIN OPT_OUT_PRSNA_ID RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'1'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'1'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
PH.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM PHONE PH
INNER JOIN OPT_OUT_HIST_PHONE STG 
ON STG.CONTACT_PHONE_NBR=PH.FULL_PHONE_NUM
AND STG.LEGAL_ENT_NBR= PH.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID RP
ON PH.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND PH.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'1'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM EMAIL EA
INNER JOIN OPT_OUT_HIST_EMAIL STG 
ON STG.EMAIL_ADDR_TEXT=EA.EMAIL_ADDR_TXT
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'1'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM NATIONAL_ID_NBR EA
INNER JOIN OPT_OUT_HIST_NATIONAL_ID_NBR STG 
ON STG.NATIONAL_ID_NBR=EA.NATIONAL_ID_NBR
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'2'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'2'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'2'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
PH.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM PHONE PH
INNER JOIN OPT_OUT_HIST_PHONE STG 
ON STG.CONTACT_PHONE_NBR=PH.FULL_PHONE_NUM
AND STG.LEGAL_ENT_NBR= PH.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=PH.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON PH.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND PH.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'2'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM EMAIL EA
INNER JOIN OPT_OUT_HIST_EMAIL STG 
ON STG.EMAIL_ADDR_TEXT=EA.EMAIL_ADDR_TXT
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=EA.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'2'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM NATIONAL_ID_NBR EA
INNER JOIN OPT_OUT_HIST_NATIONAL_ID_NBR STG 
ON STG.NATIONAL_ID_NBR=EA.NATIONAL_ID_NBR
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=EA.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'3'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

INNER JOIN REGIS_PRSNA RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'3'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'3'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
PH.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM PHONE PH
INNER JOIN OPT_OUT_HIST_PHONE STG 
ON STG.CONTACT_PHONE_NBR=PH.FULL_PHONE_NUM
AND STG.LEGAL_ENT_NBR= PH.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=PH.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON PH.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND PH.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'3'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM EMAIL EA
INNER JOIN OPT_OUT_HIST_EMAIL STG 
ON STG.EMAIL_ADDR_TEXT=EA.EMAIL_ADDR_TXT
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=EA.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'3'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM NATIONAL_ID_NBR EA
INNER JOIN OPT_OUT_HIST_NATIONAL_ID_NBR STG 
ON STG.NATIONAL_ID_NBR=EA.NATIONAL_ID_NBR
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=EA.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'4'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'4'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'4'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
PH.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM PHONE PH
INNER JOIN OPT_OUT_HIST_PHONE STG 
ON STG.CONTACT_PHONE_NBR=PH.FULL_PHONE_NUM
AND STG.LEGAL_ENT_NBR= PH.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=PH.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON PH.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND PH.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'4'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM EMAIL EA
INNER JOIN OPT_OUT_HIST_EMAIL STG 
ON STG.EMAIL_ADDR_TEXT=EA.EMAIL_ADDR_TXT
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=EA.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'4'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM NATIONAL_ID_NBR EA
INNER JOIN OPT_OUT_HIST_NATIONAL_ID_NBR STG 
ON STG.NATIONAL_ID_NBR=EA.NATIONAL_ID_NBR
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=EA.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID2 RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'5'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

INNER JOIN REGIS_PRSNA RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'5'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'5'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
PH.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM PHONE PH
INNER JOIN OPT_OUT_HIST_PHONE STG 
ON STG.CONTACT_PHONE_NBR=PH.FULL_PHONE_NUM
AND STG.LEGAL_ENT_NBR= PH.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=PH.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON PH.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND PH.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'5'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM EMAIL EA
INNER JOIN OPT_OUT_HIST_EMAIL STG 
ON STG.EMAIL_ADDR_TEXT=EA.EMAIL_ADDR_TXT
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=EA.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'5'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM NATIONAL_ID_NBR EA
INNER JOIN OPT_OUT_HIST_NATIONAL_ID_NBR STG 
ON STG.NATIONAL_ID_NBR=EA.NATIONAL_ID_NBR
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=EA.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'6'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

INNER JOIN REGIS_PRSNA RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'6'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=CN.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'6'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
PH.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM PHONE PH
INNER JOIN OPT_OUT_HIST_PHONE STG 
ON STG.CONTACT_PHONE_NBR=PH.FULL_PHONE_NUM
AND STG.LEGAL_ENT_NBR= PH.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=PH.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON PH.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND PH.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'6'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM EMAIL EA
INNER JOIN OPT_OUT_HIST_EMAIL STG 
ON STG.EMAIL_ADDR_TEXT=EA.EMAIL_ADDR_TXT
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=EA.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'6'					EDW_OPT_TYPE_CODE,
RP.MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR    			EDW_SUBSCRIPTION_NBR,
STG.CHANNEL_IND					EDW_CHANNEL_IND,
'R'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM NATIONAL_ID_NBR EA
INNER JOIN OPT_OUT_HIST_NATIONAL_ID_NBR STG 
ON STG.NATIONAL_ID_NBR=EA.NATIONAL_ID_NBR
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR=EA.MKTNG_PGM_NBR

AND STG.MKTNG_PGM_NBR <> 9999
AND STG.SUBSCRIPTION_NBR <> 9999
AND STG.CHANNEL_IND <> 'ALL'
AND STG.OPT_LEVEL_IND = 'R'

INNER JOIN REGIS_PRSNA RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
AND RP.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP3_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'7'					EDW_OPT_TYPE_CODE,
RP.RP3_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP3_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP3_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'H'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'H'

INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

INNER JOIN OPT_OUT_HSHLD_ID RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP3_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'7'					EDW_OPT_TYPE_CODE,
RP.RP3_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP3_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP3_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'H'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'H'

INNER JOIN OPT_OUT_HSHLD_ID RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP3_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'7'					EDW_OPT_TYPE_CODE,
RP.RP3_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP3_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP3_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'H'					EDW_OPT_LEVEL_IND,
PH.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM PHONE PH
INNER JOIN OPT_OUT_HIST_PHONE STG 
ON STG.CONTACT_PHONE_NBR=PH.FULL_PHONE_NUM
AND STG.LEGAL_ENT_NBR= PH.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'H'

INNER JOIN OPT_OUT_HSHLD_ID RP
ON PH.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND PH.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP3_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'7'					EDW_OPT_TYPE_CODE,
RP.RP3_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP3_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP3_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'H'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM EMAIL EA
INNER JOIN OPT_OUT_HIST_EMAIL STG 
ON STG.EMAIL_ADDR_TEXT=EA.EMAIL_ADDR_TXT
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'H'

INNER JOIN OPT_OUT_HSHLD_ID RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP3_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'7'					EDW_OPT_TYPE_CODE,
RP.RP3_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP3_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP3_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'ALL'					EDW_CHANNEL_IND,
'H'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM NATIONAL_ID_NBR EA
INNER JOIN OPT_OUT_HIST_NATIONAL_ID_NBR STG 
ON STG.NATIONAL_ID_NBR=EA.NATIONAL_ID_NBR
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'ALL'
AND STG.OPT_LEVEL_IND = 'H'

INNER JOIN OPT_OUT_HSHLD_ID RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'8'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'A'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'A'
AND STG.OPT_LEVEL_IND = 'M'
 
INNER JOIN REGIS_PRSNA RP1
ON CN.MKTNG_PGM_NBR=RP1.MKTNG_PGM_NBR
AND CN.REGIS_PRSNA_ID=RP1.REGIS_PRSNA_ID
AND RP1.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM
MKTNG_PGM WHERE LEGAL_ENT_NBR IN 
(SEL LEGAL_ENT_NBR FROM TSS_PRSNA_IDS_DEU GROUP BY 1))

INNER JOIN OPT_OUT_PRSNA_ID RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') <> ''
AND STG.LAST_NAME = RP1.FAMLY_NAME
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'8'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'A'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
CN.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM POSTL AS CN

INNER JOIN OPT_OUT_HIST STG 
ON  STG.ADDR_LINE_1_TXT=  CN.ADDR_LINE_1_TXT
AND STG.ADDR_LINE_2_TXT= CN.ADDR_LINE_2_TXT
AND STG.ADDR_LINE_3_TXT= CN.ADDR_LINE_3_TXT
AND STG.CITY_NAME= CN.CITY_NAME
AND STG.TERR_NAME= CN.TERR_NAME
AND STG.POSTL_AREA_CODE= CN.POSTL_AREA_CODE
AND STG.CNTRY_NAME= CN.CNTRY_NAME
AND STG.LEGAL_ENT_NBR= CN.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'A'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID RP
ON CN.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND CN.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR

WHERE COALESCE(TRIM(STG.LAST_NAME),'') = ''
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'8'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'A'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
PH.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM PHONE PH
INNER JOIN OPT_OUT_HIST_PHONE STG 
ON STG.CONTACT_PHONE_NBR=PH.FULL_PHONE_NUM
AND STG.LEGAL_ENT_NBR= PH.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'A'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID RP
ON PH.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND PH.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'8'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'A'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM EMAIL EA
INNER JOIN OPT_OUT_HIST_EMAIL STG 
ON STG.EMAIL_ADDR_TEXT=EA.EMAIL_ADDR_TXT
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'A'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO OPT_OUT_LIST_DEU
(
EDW_REGIS_PRSNA_ID            ,
EDW_OPT_TYPE_CODE             ,
EDW_MKTNG_PGM_NBR             ,
EDW_LEGAL_ENT_NBR             ,
EDW_DATA_SRCE_NBR             ,
EDW_SUBSCRIPTION_NBR          ,
EDW_CHANNEL_IND               ,
EDW_OPT_LEVEL_IND             ,
EDW_LOG_SOURCE_ID,
STG_REGIS_PRSNA_ID            ,
STG_OPT_TYPE_CODE             ,
STG_MKTNG_PGM_NBR             ,
STG_LEGAL_ENT_NBR             ,
STG_DATA_SRCE_NBR             ,
STG_SUBSCRIPTION_NBR          ,
STG_FIRST_NAME                ,
STG_LAST_NAME                 ,
STG_EMAIL_ADDR_TEXT           ,
STG_CONTACT_PHONE_NBR         ,
STG_SRC_ADDR_LINE_1_TXT       ,
STG_SRC_ADDR_LINE_2_TXT       ,
STG_SRC_ADDR_LINE_3_TXT       ,
STG_SRC_CITY_NAME             ,
STG_SRC_STATE                 ,
STG_SRC_ZIP                   ,
STG_SRC_CNTRY_NAME            ,
STG_ADDR_LINE_1_TXT           ,
STG_ADDR_LINE_2_TXT           ,
STG_ADDR_LINE_3_TXT           ,
STG_CITY_NAME                 ,
STG_TERR_NAME                 ,
STG_POSTL_AREA_CODE           ,
STG_CNTRY_NAME                ,
STG_OPT_IND                   ,
STG_OPT_TIME                  ,
STG_OPT_REASN_TXT             ,
STG_LAST_ACTIVITY_TM          ,
STG_LOG_SOURCE_ID             ,
STG_LOG_UPDATE_USER           ,
STG_LOG_LOAD_ID               ,
STG_PE_OPTOUT_ID              ,
STG_NATIONAL_ID_NBR           ,
STG_CHANNEL_IND               ,
STG_OPT_LEVEL_IND             
)
SELECT
RP.RP2_REGIS_PRSNA_ID			EDW_REGIS_PRSNA_ID,
'8'					EDW_OPT_TYPE_CODE,
RP.RP2_MKTNG_PGM_NBR			EDW_MKTNG_PGM_NBR,
RP.RP2_LEGAL_ENT_NBR			EDW_LEGAL_ENT_NBR,
RP.RP2_DATA_SRCE_NBR			EDW_DATA_SRCE_NBR,
9999             			EDW_SUBSCRIPTION_NBR,
'A'					EDW_CHANNEL_IND,
'M'					EDW_OPT_LEVEL_IND,
EA.SYS_SOURCE,       
STG.REGIS_PRSNA_ID		        STG_REGIS_PRSNA_ID,
STG.OPT_TYPE_CODE		        STG_OPT_TYPE_CODE,
STG.MKTNG_PGM_NBR			STG_MKTNG_PGM_NBR,
STG.LEGAL_ENT_NBR			STG_LEGAL_ENT_NBR,
STG.DATA_SRCE_NBR			STG_DATA_SRCE_NBR,
STG.SUBSCRIPTION_NBR			STG_SUBSCRIPTION_NBR,
STG.FIRST_NAME				STG_FIRST_NAME,
STG.LAST_NAME				STG_LAST_NAME,
STG.EMAIL_ADDR_TEXT			STG_EMAIL_ADDR_TEXT,
STG.CONTACT_PHONE_NBR			STG_CONTACT_PHONE_NBR,
STG.SRC_ADDR_LINE_1_TXT			STG_SRC_ADDR_LINE_1_TXT,
STG.SRC_ADDR_LINE_2_TXT			STG_SRC_ADDR_LINE_2_TXT,
STG.SRC_ADDR_LINE_3_TXT			STG_SRC_ADDR_LINE_3_TXT,
STG.SRC_CITY_NAME		        STG_SRC_CITY_NAME,
STG.SRC_STATE				STG_SRC_STATE,
STG.SRC_ZIP				STG_SRC_ZIP,
STG.SRC_CNTRY_NAME			STG_SRC_CNTRY_NAME,
STG.ADDR_LINE_1_TXT			STG_ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT			STG_ADDR_LINE_2_TXT,
STG.ADDR_LINE_3_TXT			STG_ADDR_LINE_3_TXT,
STG.CITY_NAME				STG_CITY_NAME,
STG.TERR_NAME				STG_TERR_NAME,
STG.POSTL_AREA_CODE			STG_POSTL_AREA_CODE,
STG.CNTRY_NAME				STG_CNTRY_NAME,
STG.OPT_IND				STG_OPT_IND,
STG.OPT_TIME				STG_OPT_TIME,
STG.OPT_REASN_TXT			STG_OPT_REASN_TXT,
STG.LAST_ACTIVITY_TM			STG_LAST_ACTIVITY_TM,
STG.LOG_SOURCE_ID			STG_LOG_SOURCE_ID,
STG.LOG_UPDATE_USER			STG_LOG_UPDATE_USER,
STG.LOG_LOAD_ID				STG_LOG_LOAD_ID,
STG.PE_OPTOUT_ID			STG_PE_OPTOUT_ID,
STG.NATIONAL_ID_NBR                     STG_NATIONAL_ID_NBR,
STG.CHANNEL_IND                         STG_CHANNEL_IND,
STG.OPT_LEVEL_IND                       STG_OPT_LEVEL_IND    
FROM NATIONAL_ID_NBR EA
INNER JOIN OPT_OUT_HIST_NATIONAL_ID_NBR STG 
ON STG.NATIONAL_ID_NBR=EA.NATIONAL_ID_NBR
AND STG.LEGAL_ENT_NBR= EA.LEGAL_ENT_NBR
AND STG.MKTNG_PGM_NBR = 9999
AND STG.SUBSCRIPTION_NBR = 9999
AND STG.CHANNEL_IND = 'A'
AND STG.OPT_LEVEL_IND = 'M'

INNER JOIN OPT_OUT_PRSNA_ID RP
ON EA.REGIS_PRSNA_ID=RP.REGIS_PRSNA_ID 
AND EA.MKTNG_PGM_NBR = RP.MKTNG_PGM_NBR
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE OPT_OUT_NOT_FOUND
SET MATCH_FLG='Y'
WHERE PE_OPTOUT_ID IN 
(SELECT STG_PE_OPTOUT_ID
FROM OPT_OUT_LIST_DEU
WHERE STG_REGIS_PRSNA_ID>0
OR EDW_REGIS_PRSNA_ID>0);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

MERGE INTO OPT_OUT_NOT_FOUND_XREF
USING
(SELECT STG_PE_OPTOUT_ID,EDW_REGIS_PRSNA_ID
FROM OPT_OUT_LIST_DEU
WHERE EDW_REGIS_PRSNA_ID>0
AND STG_PE_OPTOUT_ID IS NOT NULL
AND STG_PE_OPTOUT_ID >0)
AS SRC
(STG_PE_OPTOUT_ID,
EDW_REGIS_PRSNA_ID)
ON  PE_OPTOUT_ID = STG_PE_OPTOUT_ID
AND REGIS_PRSNA_ID= EDW_REGIS_PRSNA_ID

WHEN NOT MATCHED THEN 
INSERT
(PE_OPTOUT_ID = STG_PE_OPTOUT_ID
,REGIS_PRSNA_ID= EDW_REGIS_PRSNA_ID
);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

SELECT
COUNT(*) AS CNT 
FROM OPT_OUT_LIST_DEU
HAVING CNT>0;

.IF ACTIVITYCOUNT > 0 THEN .GOTO OPTOUT
.IF ACTIVITYCOUNT = 0 THEN .GOTO i10

.LABEL OPTOUT
/*****************************************************************************
Opt out the consumer from REGIS_PRSNA_POSTL_ADDR based on the match available 
in OPT_OUT_DEU_LIST_TEMP table populated above.

The update would need to be done only when the opt out date is the most recent
date compared to the consumer choice date in REGIS_PRSNA_POSTL_ADDR.
******************************************************************************/

UPDATE	ADDR_INPUT
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	OPT_OUT_LIST_DEU TEMP1  
WHERE EDW_CHANNEL_IND IN ('A','ALL')
AND EDW_SUBSCRIPTION_NBR = 9999
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'ETLUSER'
,CNSMR_CHCE_DATETM=TEMP.STG_OPT_TIME
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
WHERE ADDR_INPUT.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND ADDR_INPUT.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND ADDR_INPUT.CNSMR_CHCE_DATETM<=TEMP.STG_OPT_TIME
AND ADDR_INPUT.SUBSCRPTN_OPT_IND = 'I'
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	ADDR_INPUT
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,EDW_SUBSCRIPTION_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	OPT_OUT_LIST_DEU TEMP1  
WHERE EDW_CHANNEL_IND IN ('A','ALL')
AND EDW_SUBSCRIPTION_NBR <> 9999
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'ETLUSER'
,CNSMR_CHCE_DATETM=TEMP.STG_OPT_TIME
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
WHERE ADDR_INPUT.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND ADDR_INPUT.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND ADDR_INPUT.SUBSCRPTN_OPT_NBR=TEMP.EDW_SUBSCRIPTION_NBR
AND ADDR_INPUT.CNSMR_CHCE_DATETM<=TEMP.STG_OPT_TIME
AND ADDR_INPUT.SUBSCRPTN_OPT_IND = 'I'
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	REGIS_PRSNA_POSTL_ADDR
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	OPT_OUT_LIST_DEU TEMP1  
WHERE EDW_CHANNEL_IND IN ('A','ALL')
AND EDW_SUBSCRIPTION_NBR = 9999
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'ETLUSER'
,CNSMR_CHCE_DATETM=TEMP.STG_OPT_TIME
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
WHERE REGIS_PRSNA_POSTL_ADDR.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND REGIS_PRSNA_POSTL_ADDR.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND REGIS_PRSNA_POSTL_ADDR.CNSMR_CHCE_DATETM<=TEMP.STG_OPT_TIME
AND REGIS_PRSNA_POSTL_ADDR.SUBSCRPTN_OPT_IND = 'I'
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE	REGIS_PRSNA_POSTL_ADDR
FROM	(
SELECT	DISTINCT EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR,EDW_SUBSCRIPTION_NBR,
STG_OPT_TIME,
STG_LOG_SOURCE_ID 
FROM	OPT_OUT_LIST_DEU TEMP1  
WHERE EDW_CHANNEL_IND IN ('A','ALL')
AND EDW_SUBSCRIPTION_NBR <> 9999
QUALIFY RANK() OVER (PARTITION BY EDW_REGIS_PRSNA_ID,EDW_MKTNG_PGM_NBR
ORDER BY STG_OPT_TIME DESC,STG_LOG_SOURCE_ID DESC) = 1
) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'ETLUSER'
,CNSMR_CHCE_DATETM=TEMP.STG_OPT_TIME
,SYS_SOURCE=TRIM(CAST(TEMP.STG_LOG_SOURCE_ID AS INTEGER))
WHERE REGIS_PRSNA_POSTL_ADDR.REGIS_PRSNA_ID=TEMP.EDW_REGIS_PRSNA_ID
AND REGIS_PRSNA_POSTL_ADDR.MKTNG_PGM_NBR=TEMP.EDW_MKTNG_PGM_NBR
AND REGIS_PRSNA_POSTL_ADDR.SUBSCRPTN_OPT_NBR=TEMP.EDW_SUBSCRIPTION_NBR
AND REGIS_PRSNA_POSTL_ADDR.CNSMR_CHCE_DATETM<=TEMP.STG_OPT_TIME
AND REGIS_PRSNA_POSTL_ADDR.SUBSCRPTN_OPT_IND = 'I'
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL i10

/******************************************************************************************
i10 Opt Out 

Opt out the consumer from REGIS_PRSNA_POSTL_ADDR based on the match available 
in ICRM_STAGE_TBL.MAIL_CAMP_RSP_STG_R2 and ICRM_STAGE_TBL. MAIL_CAMP_RSP_STG_R2_HIST.     

The update would need to be done only when the opt out date is the most recent
date compared to the consumer choice date in REGIS_PRSNA_EMAIL_ADDR.
*******************************************************************************************/
DROP TABLE REG_OPT_OUT_TIME;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

DROP TABLE POSTL;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE REG_OPT_OUT_TIME
AS 
(

SELECT	
MIN(ADJ.CNSMR_CHCE_DATETM) CNSMR_CHCE_DATETM
FROM 
ADDR_INPUT ADJ 
WHERE CAST(ADJ.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM  LOAD_INFO 
WHERE PROCESS_NAME = 'Wrapper' and cntry_name='DEU' and status='In Progress')
)
WITH DATA
PRIMARY INDEX ( CNSMR_CHCE_DATETM )
ON COMMIT PRESERVE ROWS
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE POSTL AS (
SELECT	
COALESCE(TRIM(ADJ.ADDR_LINE_1_TXT),'') ADDR_LINE1_TXT,
COALESCE(TRIM(ADJ.ADDR_LINE_2_TXT),'') ADDR_LINE2_TXT,
COALESCE(TRIM(ADJ.ADDR_LINE_3_TXT),'') ADDR_LINE3_TXT,
COALESCE(TRIM(ADJ.CITY_NAME),'') CITY_NAME,
COALESCE(TRIM(ADJ.TERR_NAME),'') TERR_NAME,
COALESCE(TRIM(ADJ.POSTL_AREA_CODE),'') POSTL_AREA_CODE,
COALESCE(TRIM(ADJ.CNTRY_CODE),'') CNTRY_NAME,
ADJ.MKTNG_PGM_NBR, 
ADJ.SUBSCRPTN_OPT_NBR AS SUBSCRPTN_OPT_NBR, 
ADJ.LEGAL_ENT_NBR,
ADJ.SYS_TARGET_ID,
ADJ.REGIS_PRSNA_ID,
ADJ.CNSMR_CHCE_DATETM,
ADJ.SYS_SOURCE
FROM 
ADDR_INPUT ADJ
WHERE CAST(ADJ.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM  LOAD_INFO 
WHERE PROCESS_NAME = 'Wrapper' and cntry_name='DEU' and status='In Progress')
AND (COALESCE(TRIM(ADJ.ADDR_LINE_1_TXT),'') <> '' OR 
COALESCE(TRIM(ADJ.ADDR_LINE_2_TXT),'') <> '' OR 
COALESCE(TRIM(ADJ.ADDR_LINE_3_TXT),'') <> '' OR 
COALESCE(TRIM(ADJ.CITY_NAME),'') <> '' OR 
COALESCE(TRIM(ADJ.TERR_NAME),'') <> '' OR 
COALESCE(TRIM(ADJ.POSTL_AREA_CODE),'') <> '')
)
WITH DATA
PRIMARY INDEX (ADDR_LINE1_TXT,ADDR_LINE2_TXT,ADDR_LINE3_TXT,CITY_NAME,TERR_NAME,POSTL_AREA_CODE,
MKTNG_PGM_NBR,REGIS_PRSNA_ID,SUBSCRPTN_OPT_NBR,CNSMR_CHCE_DATETM)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE MULTISET TABLE OPT_OUT_i10_POSTL AS (
SELECT
TRM_LEAD_KEY                  ,
REGIS_PRSNA_ID                ,
SUBSCRPTN_OPT_NBR             ,
CNTCT_POINT_CATEG_CODE        ,
POSTL_DPLOYMT_DATE            ,
LINK_WEB_URL                  ,
COMM_ID                       ,
RUN_ID                        ,
RESP_REC_TYPE_CODE            ,
RESP_DATETM   ,
MAILING_ID                    ,
WAVE_ID                       ,
MKTNG_PGM_NBR                 ,
S_ADD1                        ,
S_ADD2                        ,
S_ADD3                        ,
S_STRET_NUM                   ,
S_STRET_NAME                  ,
S_APT_NUM                     ,
S_PO_BOX_NUM                  ,
S_CITY_NAME                   ,
S_POSTL_AREA_CODE             ,
S_TERR_NAME                   ,
S_CNTRY_NAME                  ,
COALESCE(TRIM(ADJ.ADDR_LINE_1_TXT),'') ADDR_LINE_1_TXT,
COALESCE(TRIM(ADJ.ADDR_LINE_2_TXT),'') ADDR_LINE_2_TXT,
COALESCE(TRIM(ADJ.ADDR_LINE_3_TXT),'') ADDR_LINE_3_TXT,
COALESCE(TRIM(ADJ.CITY_NAME),'') CITY_NAME,
COALESCE(TRIM(ADJ.TERR_NAME),'') TERR_NAME,
COALESCE(TRIM(ADJ.POSTL_AREA_CODE),'') POSTL_AREA_CODE,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
COALESCE(C.CNTRY_CODE,ADJ.CNTRY_NAME)      CNTRY_NAME,
POSTL_STATUS_CODE             ,
LOAD_ID                       ,
LOAD_TS                       ,
MDM_LOAD_IND                  
FROM POSTLCLT_STG ADJ   
LEFT JOIN CNTRY C ON ADJ.CNTRY_NAME=C.CNTRY_NAME
--WHERE RESP_REC_TYPE_CODE IN ('04','07')      --Commented : Release 5.1.1 BR173
WHERE RESP_REC_TYPE_CODE IN ('04','07','05')   --Added     : Release 5.1.1 BR173
AND RESP_DATETM>=(SEL CNSMR_CHCE_DATETM FROM REG_OPT_OUT_TIME)
AND (COALESCE(TRIM(ADJ.ADDR_LINE_1_TXT),'') <> '' OR 
COALESCE(TRIM(ADJ.ADDR_LINE_2_TXT),'') <> '' OR 
COALESCE(TRIM(ADJ.ADDR_LINE_3_TXT),'') <> '' OR 
COALESCE(TRIM(ADJ.CITY_NAME),'') <> '' OR 
COALESCE(TRIM(ADJ.TERR_NAME),'') <> '' OR 
COALESCE(TRIM(ADJ.POSTL_AREA_CODE),'') <> '')
AND (MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM TRILLIUM_OUTPUT1_DEU_TEMP)
OR MKTNG_PGM_NBR IS NULL)
UNION ALL
SELECT
TRM_LEAD_KEY                  ,
REGIS_PRSNA_ID                ,
SUBSCRPTN_OPT_NBR             ,
CNTCT_POINT_CATEG_CODE        ,
POSTL_DPLOYMT_DATE            ,
LINK_WEB_URL                  ,
COMM_ID                       ,
RUN_ID                        ,
RESP_REC_TYPE_CODE            ,
RESP_DATETM           ,
MAILING_ID                    ,
WAVE_ID                       ,
MKTNG_PGM_NBR                 ,
S_ADD1                        ,
S_ADD2                        ,
S_ADD3                        ,
S_STRET_NUM                   ,
S_STRET_NAME                  ,
S_APT_NUM                     ,
S_PO_BOX_NUM                  ,
S_CITY_NAME                   ,
S_POSTL_AREA_CODE             ,
S_TERR_NAME                   ,
S_CNTRY_NAME                  ,
COALESCE(TRIM(ADJ.ADDR_LINE_1_TXT),'') ADDR_LINE_1_TXT,
COALESCE(TRIM(ADJ.ADDR_LINE_2_TXT),'') ADDR_LINE_2_TXT,
COALESCE(TRIM(ADJ.ADDR_LINE_3_TXT),'') ADDR_LINE_3_TXT,
COALESCE(TRIM(ADJ.CITY_NAME),'') CITY_NAME,
COALESCE(TRIM(ADJ.TERR_NAME),'') TERR_NAME,
COALESCE(TRIM(ADJ.POSTL_AREA_CODE),'') POSTL_AREA_CODE,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
COALESCE(C.CNTRY_CODE,ADJ.CNTRY_NAME)      CNTRY_NAME,
POSTL_STATUS_CODE             ,
LOAD_ID                       ,
LOAD_TS                       ,
MDM_LOAD_IND                         
FROM POSTLCLT_STG_HIST ADJ   
LEFT JOIN CNTRY C ON ADJ.CNTRY_NAME=C.CNTRY_NAME
--WHERE RESP_REC_TYPE_CODE IN ('04','07')      --Commented : Release 5.1.1 BR173
WHERE RESP_REC_TYPE_CODE IN ('04','07','05')   --Added     : Release 5.1.1 BR173
AND RESP_DATETM>=(SEL CNSMR_CHCE_DATETM FROM REG_OPT_OUT_TIME)
AND (COALESCE(TRIM(ADJ.ADDR_LINE_1_TXT),'') <> '' OR 
COALESCE(TRIM(ADJ.ADDR_LINE_2_TXT),'') <> '' OR 
COALESCE(TRIM(ADJ.ADDR_LINE_3_TXT),'') <> '' OR 
COALESCE(TRIM(ADJ.CITY_NAME),'') <> '' OR 
COALESCE(TRIM(ADJ.TERR_NAME),'') <> '' OR 
COALESCE(TRIM(ADJ.POSTL_AREA_CODE),'') <> '')
AND (MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM TRILLIUM_OUTPUT1_DEU_TEMP)
OR MKTNG_PGM_NBR IS NULL)
)
WITH DATA
PRIMARY INDEX (ADDR_LINE_1_TXT,ADDR_LINE_2_TXT,ADDR_LINE_3_TXT,CITY_NAME,TERR_NAME,POSTL_AREA_CODE,
MKTNG_PGM_NBR,REGIS_PRSNA_ID,SUBSCRPTN_OPT_NBR,RESP_DATETM)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

DEL FROM MDM.POSTL_OPT_OUT_I10_DEU_TEMP ALL;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT	INTO MDM.POSTL_OPT_OUT_I10_DEU_TEMP
 (TRM_LEAD_KEY                  ,
REGIS_PRSNA_ID                ,
SUBSCRPTN_OPT_NBR             ,
CNTCT_POINT_CATEG_CODE        ,
POSTL_DPLOYMT_DATE            ,
LINK_WEB_URL                  ,
COMM_ID                       ,
RUN_ID                        ,
RESP_REC_TYPE_CODE            ,
RESP_DATETM                   ,
MAILING_ID                    ,
WAVE_ID                       ,
MKTNG_PGM_NBR                 ,
S_ADD1                        ,
S_ADD2                        ,
S_ADD3                        ,
S_STRET_NUM                   ,
S_STRET_NAME                  ,
S_APT_NUM                     ,
S_PO_BOX_NUM                  ,
S_CITY_NAME                   ,
S_POSTL_AREA_CODE             ,
S_TERR_NAME                   ,
S_CNTRY_NAME                  ,
ADDR_LINE_1_TXT               ,
ADDR_LINE_2_TXT               ,
ADDR_LINE_3_TXT               ,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
CITY_NAME                     ,
POSTL_AREA_CODE               ,
TERR_NAME                     ,
CNTRY_NAME                    ,
POSTL_STATUS_CODE             ,
LOAD_ID                       ,
LOAD_TS                       ,
MDM_LOAD_IND             ,          
REGIS_CNSMR_ID_VAL            ,
ICRM_STG_LOAD_ID
)

SELECT	
STG.TRM_LEAD_KEY                  ,
EA.REGIS_PRSNA_ID                ,
EA.SUBSCRPTN_OPT_NBR             ,
STG.CNTCT_POINT_CATEG_CODE        ,
STG.POSTL_DPLOYMT_DATE            ,
STG.LINK_WEB_URL                  ,
STG.COMM_ID                       ,
STG.RUN_ID                        ,
STG.RESP_REC_TYPE_CODE            ,
STG.RESP_DATETM                   ,
STG.MAILING_ID                    ,
STG.WAVE_ID                       ,
EA.MKTNG_PGM_NBR                 ,
STG.S_ADD1                        ,
STG.S_ADD2                        ,
STG.S_ADD3                        ,
STG.S_STRET_NUM                   ,
STG.S_STRET_NAME                  ,
STG.S_APT_NUM                     ,
STG.S_PO_BOX_NUM                  ,
STG.S_CITY_NAME                   ,
STG.S_POSTL_AREA_CODE             ,
STG.S_TERR_NAME                   ,
STG.S_CNTRY_NAME                  ,
EA.ADDR_LINE1_TXT               ,
EA.ADDR_LINE2_TXT               ,
EA.ADDR_LINE3_TXT               ,
STG.STRET_NUM                     ,
STG.STRET_NAME                    ,
STG.APT_NUM                       ,
STG.PO_BOX_NUM                    ,
EA.CITY_NAME                     ,
EA.POSTL_AREA_CODE               ,
EA.TERR_NAME                     ,
EA.CNTRY_NAME                      ,
STG.POSTL_STATUS_CODE             ,
STG.LOAD_ID                       ,
STG.LOAD_TS                       ,
STG.MDM_LOAD_IND             ,
EA.REGIS_PRSNA_ID            ,
EA.SYS_SOURCE AS ICRM_STG_LOAD_ID
FROM	
OPT_OUT_i10_POSTL STG 
INNER JOIN CNTRY C
ON STG.CNTRY_NAME=C.CNTRY_NAME
INNER JOIN POSTL EA
ON STG.MKTNG_PGM_NBR=EA.MKTNG_PGM_NBR
AND STG.REGIS_PRSNA_ID=EA.REGIS_PRSNA_ID
AND STG.MKTNG_PGM_NBR IS NOT NULL
AND STG.REGIS_PRSNA_ID IS NOT NULL
AND STG.RESP_DATETM>=EA.CNSMR_CHCE_DATETM
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT	INTO MDM.POSTL_OPT_OUT_I10_DEU_TEMP
 (TRM_LEAD_KEY                  ,
REGIS_PRSNA_ID                ,
SUBSCRPTN_OPT_NBR             ,
CNTCT_POINT_CATEG_CODE        ,
POSTL_DPLOYMT_DATE            ,
LINK_WEB_URL                  ,
COMM_ID                       ,
RUN_ID                        ,
RESP_REC_TYPE_CODE            ,
RESP_DATETM                   ,
MAILING_ID                    ,
WAVE_ID                       ,
MKTNG_PGM_NBR                 ,
S_ADD1                        ,
S_ADD2                        ,
S_ADD3                        ,
S_STRET_NUM                   ,
S_STRET_NAME                  ,
S_APT_NUM                     ,
S_PO_BOX_NUM                  ,
S_CITY_NAME                   ,
S_POSTL_AREA_CODE             ,
S_TERR_NAME                   ,
S_CNTRY_NAME                  ,
ADDR_LINE_1_TXT               ,
ADDR_LINE_2_TXT               ,
ADDR_LINE_3_TXT               ,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
CITY_NAME                     ,
POSTL_AREA_CODE               ,
TERR_NAME                     ,
CNTRY_NAME                    ,
POSTL_STATUS_CODE             ,
LOAD_ID                       ,
LOAD_TS                       ,
MDM_LOAD_IND             ,          
REGIS_CNSMR_ID_VAL            ,
ICRM_STG_LOAD_ID
)

SELECT	
STG.TRM_LEAD_KEY                  ,
EA.REGIS_PRSNA_ID                ,
EA.SUBSCRPTN_OPT_NBR             ,
STG.CNTCT_POINT_CATEG_CODE        ,
STG.POSTL_DPLOYMT_DATE            ,
STG.LINK_WEB_URL                  ,
STG.COMM_ID                       ,
STG.RUN_ID                        ,
STG.RESP_REC_TYPE_CODE            ,
STG.RESP_DATETM                   ,
STG.MAILING_ID                    ,
STG.WAVE_ID                       ,
EA.MKTNG_PGM_NBR                 ,
STG.S_ADD1                        ,
STG.S_ADD2                        ,
STG.S_ADD3                        ,
STG.S_STRET_NUM                   ,
STG.S_STRET_NAME                  ,
STG.S_APT_NUM                     ,
STG.S_PO_BOX_NUM                  ,
STG.S_CITY_NAME                   ,
STG.S_POSTL_AREA_CODE             ,
STG.S_TERR_NAME                   ,
STG.S_CNTRY_NAME                  ,
EA.ADDR_LINE1_TXT               ,
EA.ADDR_LINE2_TXT               ,
EA.ADDR_LINE3_TXT               ,
STG.STRET_NUM                     ,
STG.STRET_NAME                    ,
STG.APT_NUM                       ,
STG.PO_BOX_NUM                    ,
EA.CITY_NAME                     ,
EA.POSTL_AREA_CODE               ,
EA.TERR_NAME                     ,
EA.CNTRY_NAME                     ,
STG.POSTL_STATUS_CODE             ,
STG.LOAD_ID                       ,
STG.LOAD_TS                       ,
STG.MDM_LOAD_IND             ,
EA.REGIS_PRSNA_ID            ,
EA.SYS_SOURCE AS ICRM_STG_LOAD_ID
FROM	
OPT_OUT_i10_POSTL STG 
INNER JOIN POSTL EA
ON STG.ADDR_LINE_1_TXT=  EA.ADDR_LINE1_TXT
AND STG.ADDR_LINE_2_TXT= EA.ADDR_LINE2_TXT
AND STG.ADDR_LINE_3_TXT= EA.ADDR_LINE3_TXT
AND STG.CITY_NAME= EA.CITY_NAME
AND STG.TERR_NAME= EA.TERR_NAME
AND STG.POSTL_AREA_CODE= EA.POSTL_AREA_CODE
AND STG.CNTRY_NAME= EA.CNTRY_NAME
AND STG.MKTNG_PGM_NBR=EA.MKTNG_PGM_NBR
AND STG.MKTNG_PGM_NBR IS NOT NULL
AND STG.RESP_DATETM>=EA.CNSMR_CHCE_DATETM
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT	INTO MDM.POSTL_OPT_OUT_I10_DEU_TEMP
 (TRM_LEAD_KEY                  ,
REGIS_PRSNA_ID                ,
SUBSCRPTN_OPT_NBR             ,
CNTCT_POINT_CATEG_CODE        ,
POSTL_DPLOYMT_DATE            ,
LINK_WEB_URL                  ,
COMM_ID                       ,
RUN_ID                        ,
RESP_REC_TYPE_CODE            ,
RESP_DATETM                   ,
MAILING_ID                    ,
WAVE_ID                       ,
MKTNG_PGM_NBR                 ,
S_ADD1                        ,
S_ADD2                        ,
S_ADD3                        ,
S_STRET_NUM                   ,
S_STRET_NAME                  ,
S_APT_NUM                     ,
S_PO_BOX_NUM                  ,
S_CITY_NAME                   ,
S_POSTL_AREA_CODE             ,
S_TERR_NAME                   ,
S_CNTRY_NAME                  ,
ADDR_LINE_1_TXT               ,
ADDR_LINE_2_TXT               ,
ADDR_LINE_3_TXT               ,
STRET_NUM                     ,
STRET_NAME                    ,
APT_NUM                       ,
PO_BOX_NUM                    ,
CITY_NAME                     ,
POSTL_AREA_CODE               ,
TERR_NAME                     ,
CNTRY_NAME                    ,
POSTL_STATUS_CODE             ,
LOAD_ID                       ,
LOAD_TS                       ,
MDM_LOAD_IND             ,          
REGIS_CNSMR_ID_VAL            ,
ICRM_STG_LOAD_ID
)

SELECT	
STG.TRM_LEAD_KEY                  ,
EA.REGIS_PRSNA_ID                ,
EA.SUBSCRPTN_OPT_NBR             ,
STG.CNTCT_POINT_CATEG_CODE        ,
STG.POSTL_DPLOYMT_DATE            ,
STG.LINK_WEB_URL                  ,
STG.COMM_ID                       ,
STG.RUN_ID                        ,
STG.RESP_REC_TYPE_CODE            ,
STG.RESP_DATETM                   ,
STG.MAILING_ID                    ,
STG.WAVE_ID                       ,
EA.MKTNG_PGM_NBR                 ,
STG.S_ADD1                        ,
STG.S_ADD2                        ,
STG.S_ADD3                        ,
STG.S_STRET_NUM                   ,
STG.S_STRET_NAME                  ,
STG.S_APT_NUM                     ,
STG.S_PO_BOX_NUM                  ,
STG.S_CITY_NAME                   ,
STG.S_POSTL_AREA_CODE             ,
STG.S_TERR_NAME                   ,
STG.S_CNTRY_NAME                  ,
EA.ADDR_LINE1_TXT               ,
EA.ADDR_LINE2_TXT               ,
EA.ADDR_LINE3_TXT               ,
STG.STRET_NUM                     ,
STG.STRET_NAME                    ,
STG.APT_NUM                       ,
STG.PO_BOX_NUM                    ,
EA.CITY_NAME                     ,
EA.POSTL_AREA_CODE               ,
EA.TERR_NAME                     ,
EA.CNTRY_NAME                      ,
STG.POSTL_STATUS_CODE             ,
STG.LOAD_ID                       ,
STG.LOAD_TS                       ,
STG.MDM_LOAD_IND             ,
EA.REGIS_PRSNA_ID            ,
EA.SYS_SOURCE AS ICRM_STG_LOAD_ID
FROM	
OPT_OUT_i10_POSTL STG 
INNER JOIN POSTL EA
ON STG.ADDR_LINE_1_TXT=  EA.ADDR_LINE1_TXT
AND STG.ADDR_LINE_2_TXT= EA.ADDR_LINE2_TXT
AND STG.ADDR_LINE_3_TXT= EA.ADDR_LINE3_TXT
AND STG.CITY_NAME= EA.CITY_NAME
AND STG.TERR_NAME= EA.TERR_NAME
AND STG.POSTL_AREA_CODE= EA.POSTL_AREA_CODE
AND STG.CNTRY_NAME= EA.CNTRY_NAME
AND STG.MKTNG_PGM_NBR IS NULL
AND STG.RESP_DATETM>=EA.CNSMR_CHCE_DATETM
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

SELECT
COUNT(*) AS CNT 
FROM POSTL_OPT_OUT_I10_DEU_TEMP
HAVING CNT>0;

.IF ACTIVITYCOUNT > 0 THEN .GOTO i10OPTOUT
.IF ACTIVITYCOUNT = 0 THEN .GOTO EDW

.LABEL i10OPTOUT

UPDATE ADDR_INPUT
FROM	(
SEL * FROM
(SELECT	REGIS_PRSNA_ID,
MKTNG_PGM_NBR,
RESP_DATETM,
SUBSCRPTN_OPT_NBR,
ADDR_LINE_1_TXT,
ADDR_LINE_2_TXT,
ADDR_LINE_3_TXT,
CITY_NAME,
TERR_NAME,
POSTL_AREA_CODE,
CNTRY_NAME,
LOAD_ID,
ICRM_STG_LOAD_ID
FROM	MDM.POSTL_OPT_OUT_I10_DEU_TEMP TEMP1 
QUALIFY RANK() OVER (PARTITION BY REGIS_PRSNA_ID,MKTNG_PGM_NBR,ICRM_STG_LOAD_ID
ORDER BY RESP_DATETM DESC,LOAD_ID DESC) = 1) A
GROUP	BY 1,2,3,4,5,6,7,8,9,10,11,12,13) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I10ETLUSER'
,CNSMR_CHCE_DATETM=TEMP.RESP_DATETM
,SYS_SOURCE=TRIM(CAST(TEMP.LOAD_ID AS INTEGER))
WHERE ADDR_INPUT.REGIS_PRSNA_ID=TEMP.REGIS_PRSNA_ID
AND ADDR_INPUT.MKTNG_PGM_NBR=TEMP.MKTNG_PGM_NBR
AND ADDR_INPUT.SUBSCRPTN_OPT_NBR=TEMP.SUBSCRPTN_OPT_NBR
AND ADDR_INPUT.ADDR_LINE_1_TXT=TEMP.ADDR_LINE_1_TXT
AND ADDR_INPUT.ADDR_LINE_2_TXT=TEMP.ADDR_LINE_2_TXT
AND ADDR_INPUT.ADDR_LINE_3_TXT=TEMP.ADDR_LINE_3_TXT
AND ADDR_INPUT.CITY_NAME=TEMP.CITY_NAME
AND ADDR_INPUT.TERR_NAME=TEMP.TERR_NAME
AND ADDR_INPUT.POSTL_AREA_CODE=TEMP.POSTL_AREA_CODE
AND ADDR_INPUT.CNTRY_CODE=TEMP.CNTRY_NAME
AND ADDR_INPUT.CNSMR_CHCE_DATETM<=TEMP.RESP_DATETM
AND CAST(ADDR_INPUT.SYS_SOURCE AS INTEGER)=TEMP.ICRM_STG_LOAD_ID
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

/* POPULATE EDW TABLE */
.LABEL EDW


/******************************************************************************************
i2 Opt Out 
4.5.3                03/02/2013           TERADATA                        PRB0040960                                                                          

Opt out the consumer from REGIS_PRSNA_EMAIL_ADDR based on the match available 
in ICRM_STAGE_TBL.CNTCT_OPTN_CHCE_STG and ICRM_STAGE_TBL. CNTCT_OPTN_CHCE_STG_HIST.     

The update would need to be done only when the opt out date is the most recent
date compared to the consumer choice date in REGIS_PRSNA_EMAIL_ADDR.
*******************************************************************************************/

--PRB0040960 Start--

CREATE VOLATILE TABLE REG_OPT_OUT_TIME_i2
AS 
(

SEL MIN(CNSMR_CHCE_DATETM) CNSMR_CHCE_DATETM
FROM
(SELECT	
MIN(ADJ.CNSMR_CHCE_DATETM) CNSMR_CHCE_DATETM
FROM 
PRSNA_EMAIL_ADDR_STG ADJ 
WHERE CAST(ADJ.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM  LOAD_INFO 
WHERE PROCESS_NAME = 'Wrapper' and cntry_name='DEU' and status='In Progress')
UNION
SELECT	
MIN(ADJ.CNSMR_CHCE_DATETM) CNSMR_CHCE_DATETM
FROM 
PRSNA_POSTL_ADDR_STG ADJ 
WHERE CAST(ADJ.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM  LOAD_INFO 
WHERE PROCESS_NAME = 'Wrapper' and cntry_name='DEU' and status='In Progress')
UNION
SELECT	
MIN(ADJ.CNSMR_CHCE_DATETM) CNSMR_CHCE_DATETM
FROM 
PRSNA_PHONE_STG ADJ 
WHERE CAST(ADJ.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM  LOAD_INFO 
WHERE PROCESS_NAME = 'Wrapper' and cntry_name='DEU' and status='In Progress')
UNION
SELECT	
MIN(ADJ.CNSMR_CHCE_DATETM) CNSMR_CHCE_DATETM
FROM 
PRSNA_SOC_NETWK_ACCT_STG ADJ 
WHERE CAST(ADJ.SYS_SOURCE AS INTEGER) IN (SEL LOAD_ID FROM  LOAD_INFO 
WHERE PROCESS_NAME = 'Wrapper' and cntry_name='DEU' and status='In Progress')
) A
)
WITH DATA
PRIMARY INDEX ( CNSMR_CHCE_DATETM )
ON COMMIT PRESERVE ROWS
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

DEL FROM MDM.I2_Channels_DEU;

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INS MDM.I2_Channels_DEU
(
  MKTNG_PGM_NBR
 ,CNTCT_OPTN_NBR
 ,CNTCT_POINT_CATEG_CODE
 ,SYS_TARGET_ID
 ,CNSMR_CHCE_DATETM
 ,SYS_SOURCE
 ,REGIS_CNSMR_ID_VAL
	  )
SELECT	
MKTNG_PGM_NBR, 
CNTCT_OPTN_NBR, 
CNTCT_POINT_CATEG_CODE, 
LC.SOURCE_ID AS SYS_TARGET_ID,
CNSMR_CHCE_DATETM,
TRIM(CAST(CO.LOAD_ID AS INTEGER)) SYS_SOURCE,
REGIS_CNSMR_ID_VAL
FROM ICRM_STAGE.CNTCT_OPTN_CHCE_STG  CO  
JOIN LOAD_CONTROL LC
ON LC.LOAD_TYPE='ETL' AND CO.LOAD_ID=LC.LOAD_ID
WHERE CNTCT_OPTN_IND='O' 
AND CNSMR_CHCE_DATETM>=(SEL CNSMR_CHCE_DATETM FROM REG_OPT_OUT_TIME_i2)
and (REGIS_CNSMR_ID_VAL,MKTNG_PGM_NBR,LC.SOURCE_ID) IN(SELECT REGIS_CNSMR_ID_VAL,MKTNG_PGM_NBR,sys_target_id FROM TRILLIUM_OUTPUT1_DEU_TEMP )
union all
SELECT	
MKTNG_PGM_NBR, 
CNTCT_OPTN_NBR, 
CNTCT_POINT_CATEG_CODE, 
LC.SOURCE_ID AS SYS_TARGET_ID,
CNSMR_CHCE_DATETM,
TRIM(CAST(CO.LOAD_ID AS INTEGER)) SYS_SOURCE,
REGIS_CNSMR_ID_VAL
FROM ICRM_STAGE.CNTCT_OPTN_CHCE_STG_HIST  CO  
JOIN LOAD_CONTROL LC
ON LC.LOAD_TYPE='ETL' AND CO.LOAD_ID=LC.LOAD_ID
WHERE CNTCT_OPTN_IND='O' 
AND CNSMR_CHCE_DATETM>=(SEL CNSMR_CHCE_DATETM FROM REG_OPT_OUT_TIME_i2)
and (REGIS_CNSMR_ID_VAL,MKTNG_PGM_NBR,LC.SOURCE_ID) IN(SELECT REGIS_CNSMR_ID_VAL,MKTNG_PGM_NBR,sys_target_id FROM TRILLIUM_OUTPUT1_DEU_TEMP );

.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

SELECT
COUNT(*) AS CNT 
FROM I2_Channels_DEU
HAVING CNT>0;

.IF ACTIVITYCOUNT > 0 THEN .GOTO i2OPTOUT
.IF ACTIVITYCOUNT = 0 THEN .GOTO EDW2

.LABEL i2OPTOUT


UPDATE ADDR_INPUT
FROM	(
SELECT	temp1.REGIS_CNSMR_ID_VAL,
temp1.MKTNG_PGM_NBR,
COALESCE(TEMP2.REGIS_PRSNA_ID,CAST(TEMP2.REFERENCE_REGISTRATIONKEY AS INTEGER)) REGIS_PRSNA_ID,
temp1.CNTCT_POINT_CATEG_CODE,
temp1.CNTCT_OPTN_NBR,
temp1.SYS_TARGET_ID,
temp1.CNSMR_CHCE_DATETM,
temp1.SYS_SOURCE 
FROM	MDM. I2_Channels_DEU  TEMP1  
JOIN TRILLIUM_OUTPUT1_DEU_TEMP TEMP2 
ON TEMP1.REGIS_CNSMR_ID_VAL=TEMP2.REGIS_CNSMR_ID_VAL AND TEMP1.MKTNG_PGM_NBR=TEMP2.MKTNG_PGM_NBR AND TEMP1.SYS_TARGET_ID=TEMP2.SYS_TARGET_ID 
QUALIFY RANK() OVER (PARTITION BY temp1.REGIS_CNSMR_ID_VAL,temp1.MKTNG_PGM_NBR,temp1.SYS_TARGET_ID, temp1.CNTCT_OPTN_NBR, temp1.CNTCT_POINT_CATEG_CODE,COALESCE(TEMP2.REGIS_PRSNA_ID,CAST(TEMP2.REFERENCE_REGISTRATIONKEY AS INTEGER))
ORDER BY temp1.CNSMR_CHCE_DATETM DESC, temp1.SYS_SOURCE DESC) = 1
GROUP	BY 1,2,3,4,5,6,7,8) TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'I2USER'
,CNSMR_CHCE_DATETM=CAST(CAST(temp.CNSMR_CHCE_DATETM AS VARCHAR(19)) AS TIMESTAMP(0))
,SYS_SOURCE=TRIM(CAST(TEMP. SYS_SOURCE AS INTEGER))
WHERE ADDR_INPUT.REGIS_PRSNA_ID=TEMP.REGIS_PRSNA_ID
AND ADDR_INPUT.MKTNG_PGM_NBR=TEMP.MKTNG_PGM_NBR
AND ADDR_INPUT. SYS_TARGET_ID =TEMP. SYS_TARGET_ID
AND ADDR_INPUT.SUBSCRPTN_OPT_NBR=TEMP.CNTCT_OPTN_NBR
AND ADDR_INPUT. CNTCT_POINT_CATEG_CODE =TEMP.CNTCT_POINT_CATEG_CODE
AND ADDR_INPUT.CNSMR_CHCE_DATETM<=TEMP.CNSMR_CHCE_DATETM
AND ADDR_INPUT.SUBSCRPTN_OPT_IND = 'I'
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

.LABEL EDW2

--PRB0040960 End  --
CREATE VOLATILE TABLE RP1 AS (
SELECT 
TOUT.REGIS_PRSNA_ID,MKTNG_PGM_NBR
FROM
TSS_PRSNA_IDS_DEU TOUT
)
WITH DATA
PRIMARY INDEX (MKTNG_PGM_NBR,REGIS_PRSNA_ID)
PARTITION BY MKTNG_PGM_NBR
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS RP1
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS RP1
COLUMN REGIS_PRSNA_ID;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

DELETE FROM REGIS_PRSNA_POSTL_ADDR WHERE
(REGIS_PRSNA_ID,MKTNG_PGM_NBR)
IN
(
SELECT 
TOUT.REGIS_PRSNA_ID,MKTNG_PGM_NBR
FROM
RP1 TOUT
);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE ADDR_INPUT
SET VALID_CNTCT_POINT_IND = 'N'
WHERE ADDR_LINE_1_TXT IS NULL
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;


INSERT INTO REGIS_PRSNA_POSTL_ADDR
(
 CNTCT_POINT_CATEG_CODE
,REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,WIN_KEY
,SUBSCRPTN_OPT_NBR
,SUBSCRPTN_OPT_IND
,CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,TERR_NAME
,TERR_CODE
,CNTRY_CODE
,CITY_CODE
,LAT_MEAS
,LONG_MEAS
,VALID_CNTCT_POINT_IND
,GUARDN_NAME
,GUARDN_EMAIL_ADDR_TXT
,GUARDN_CNSNT_IND
,ACNLGMT_DATE
,PR_REV_GROUP
,PR_GEOCODE_FAIL
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE 
,SYS_ERR_SVRTY
,DATA_SRCE_NBR
,POSTL_STATUS_CODE
,GL_ACCURACY
,GL_MATCH_FLG
,DR_CLEANSE_LVL
,POSTL_ADDR_ID)
SELECT 
CNTCT_POINT_CATEG_CODE
,REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,WIN_KEY
,SUBSCRPTN_OPT_NBR
,SUBSCRPTN_OPT_IND
,CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND
,CASE WHEN COALESCE(TRIM(ADDR_LINE_1_TXT),'') = ''
      THEN NULL
      ELSE ADDR_LINE_1_TXT
  END
,CASE WHEN COALESCE(TRIM(ADDR_LINE_2_TXT),'') = ''
      THEN NULL
      ELSE ADDR_LINE_2_TXT
  END
,CASE WHEN COALESCE(TRIM(ADDR_LINE_3_TXT),'') = ''
      THEN NULL
      ELSE ADDR_LINE_3_TXT
  END
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,TERR_NAME
,TERR_CODE
,CNTRY_CODE
,CITY_CODE
,CASE WHEN CNTRY_CODE IN ('ESP','PRT')
THEN LAT_MEAS
WHEN NULLIF(TRIM(GL_ACCURACY),0) IS NULL 
THEN NULL
ELSE CAST(GL_LATITUDE AS DECIMAL(8,6) FORMAT '-99.999999')/1000000
END
, CASE WHEN CNTRY_CODE IN ('ESP','PRT')
THEN LONG_MEAS
WHEN NULLIF(TRIM(GL_ACCURACY),0) IS NULL 
THEN NULL
ELSE CAST(GL_LONGITUDE AS   DECIMAL(9,6) FORMAT '-999.999999')/1000000
END
,VALID_CNTCT_POINT_IND
,GUARDN_NAME
,GUARDN_EMAIL_ADDR_TXT
,GUARDN_CNSNT_IND
,ACNLGMT_DATE
,PR_REV_GROUP
,PR_GEOCODE_FAIL
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE 
,SYS_ERR_SVRTY
,DATA_SRCE_NBR
,CASE WHEN TRIM(COALESCE(ADDR_LINE_1_TXT,''))=''
AND TRIM(COALESCE(ADDR_LINE_2_TXT,''))=''
AND TRIM(COALESCE(ADDR_LINE_3_TXT,''))=''
AND TRIM(COALESCE(STRET_NUM,''))=''
AND TRIM(COALESCE(STRET_NAME,''))=''
AND SUBSCRPTN_OPT_IND = 'I'
THEN 'NV'
ELSE 'AC'
END AS POSTL_STATUS_CODE
,NULLIF(TRIM(GL_ACCURACY),0)
,GL_MATCH_FLAG
,DR_CLEANSE_LEVEL
,POSTL_ADDR_ID
FROM ADDR_INPUT;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

DELETE FROM PRSNA_POSTL_ADDR_ORIG WHERE
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR)
IN
(
SELECT 
TOUT.REGIS_PRSNA_ID,TOUT.MKTNG_PGM_NBR
FROM
TSS_PRSNA_IDS_DEU TOUT
WHERE 	CAST(TOUT.SYS_SOURCE AS INTEGER) MOD 100 <> 23);
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

INSERT INTO PRSNA_POSTL_ADDR_ORIG
(
 REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,REGIS_CNSMR_ID_VAL
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,TERR_NAME
,CNTRY_INFO_TXT
,CNTCT_POINT_CATEG_CODE
,PREF_CNTCT_POINT_IND
,VALID_CNTCT_POINT_IND
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE 
,SYS_ERR_SVRTY)
SELECT
B.REGIS_PRSNA_ID
,B.MKTNG_PGM_NBR
,B.LEGAL_ENT_NBR
,STG.REGIS_CNSMR_ID_VAL
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.STRET_NUM
,STG.STRET_NAME
,STG.APT_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,STG.TERR_NAME
,STG.CNTRY_NAME
,STG.CNTCT_POINT_CATEG_CODE
,STG.PREFR_IND
,STG.VALID_IND VALID_CNTCT_POINT_IND
,TRIM(CAST(STG.LOAD_ID AS INTEGER)) AS SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM	
PRSNA_POSTL_ADDR_STG STG
INNER JOIN TSS_PRSNA_IDS_DEU B
	ON	STG.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	STG.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND	STG.SYS_SOURCE=B.SYS_SOURCE
	AND	STG.SYS_TARGET_ID=B.SYS_TARGET_ID
WHERE 	CAST(STG.SYS_SOURCE AS INTEGER) MOD 100 <> 23
QUALIFY RANK() OVER (PARTITION BY B.REGIS_PRSNA_ID
,B.MKTNG_PGM_NBR 
ORDER BY 
 STG.SYS_CREATION_DATE DESC
,STG.SYS_SOURCE DESC
,STG.SYS_NC_TYPE DESC
,STG.CNSMR_CHCE_DATETM DESC
,STG.ADDR_LINE_1_TXT DESC
) = 1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE TABLE MPN AS (
SEL MKTNG_PGM_NBR FROM TRILLIUM_OUTPUT1_DEU_TEMP
)
WITH DATA
UNIQUE PRIMARY INDEX (MKTNG_PGM_NBR)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS MPN
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE MULTISET TABLE POSTL_OPTOUT AS (
SEL MKTNG_PGM_NBR,COALESCE(TRIM(ADDR_LINE_1_TXT),'') ADDR_LINE_1_TXT1,
COALESCE(TRIM(ADDR_LINE_2_TXT),'') ADDR_LINE_2_TXT1,
COALESCE(TRIM(ADDR_LINE_3_TXT),'') ADDR_LINE_3_TXT1,
COALESCE(TRIM(CITY_NAME),'') CITY_NAME1,
COALESCE(TRIM(TERR_NAME),'') TERR_NAME1,
COALESCE(TRIM(POSTL_AREA_CODE),'') POSTL_AREA_CODE1,
CNTRY_CODE,CNSMR_CHCE_DATETM,SYS_SOURCE
,COALESCE(SUBSCRPTN_OPT_NBR,0) SUBSCRPTN_OPT_NBR1
,REGIS_PRSNA_ID
,CNTCT_POINT_CATEG_CODE
FROM REGIS_PRSNA_POSTL_ADDR  ADJ
WHERE COALESCE(TRIM(ADDR_LINE_1_TXT),TRIM(ADDR_LINE_2_TXT),TRIM(ADDR_LINE_3_TXT),'') <> ''
AND SUBSCRPTN_OPT_IND = 'O'
AND MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM MPN)
QUALIFY RANK() OVER (PARTITION BY ADJ.MKTNG_PGM_NBR,ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,CITY_NAME1,TERR_NAME1,POSTL_AREA_CODE1,CNTRY_CODE, SUBSCRPTN_OPT_NBR1,ADJ.CNTCT_POINT_CATEG_CODE
ORDER BY ADJ.CNSMR_CHCE_DATETM DESC,ADJ.SYS_SOURCE DESC,ADJ.REGIS_PRSNA_ID DESC) = 1
)
WITH DATA
PRIMARY INDEX (MKTNG_PGM_NBR,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS POSTL_OPTOUT
COLUMN ADDR_LINE_1_TXT1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL_OPTOUT
COLUMN ADDR_LINE_2_TXT1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL_OPTOUT
COLUMN ADDR_LINE_3_TXT1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL_OPTOUT
COLUMN CNSMR_CHCE_DATETM;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL_OPTOUT
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL_OPTOUT
COLUMN SUBSCRPTN_OPT_NBR1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL_OPTOUT
COLUMN CNTCT_POINT_CATEG_CODE;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;


CREATE VOLATILE TABLE REGIS_PRSNA_POSTL_ADDR_T1 AS (
SEL COALESCE(TRIM(PA.ADDR_LINE_1_TXT),'') ADDR_LINE_1_TXT1,
COALESCE(TRIM(PA.ADDR_LINE_2_TXT),'') ADDR_LINE_2_TXT1,
COALESCE(TRIM(PA.ADDR_LINE_3_TXT),'') ADDR_LINE_3_TXT1,
COALESCE(TRIM(PA.CITY_NAME),'') CITY_NAME1,
COALESCE(TRIM(PA.TERR_NAME),'') TERR_NAME1,
COALESCE(TRIM(PA.POSTL_AREA_CODE),'') POSTL_AREA_CODE1,
PA.CNTRY_CODE ,
PA.MKTNG_PGM_NBR ,
PA.CNSMR_CHCE_DATETM,
COALESCE(PA.SUBSCRPTN_OPT_NBR,0)  SUBSCRPTN_OPT_NBR1,
PA.CNTCT_POINT_CATEG_CODE,
PA.SUBSCRPTN_OPT_IND
,PA.REGIS_PRSNA_ID
FROM REGIS_PRSNA_POSTL_ADDR PA
WHERE PA.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM MPN) AND PA.SUBSCRPTN_OPT_IND = 'I'
AND COALESCE(TRIM(PA.ADDR_LINE_1_TXT),TRIM(PA.ADDR_LINE_2_TXT),TRIM(PA.ADDR_LINE_3_TXT),'') <> ''
AND PA.CNSMR_CHCE_DATETM <= (SEL MAX(CNSMR_CHCE_DATETM) FROM POSTL_OPTOUT)
AND (ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,CITY_NAME1,TERR_NAME1
,POSTL_AREA_CODE1,CNTRY_CODE,MKTNG_PGM_NBR,SUBSCRPTN_OPT_NBR1,CNTCT_POINT_CATEG_CODE ) IN
(SEL ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,CITY_NAME1,TERR_NAME1
,POSTL_AREA_CODE1,CNTRY_CODE,MKTNG_PGM_NBR,SUBSCRPTN_OPT_NBR1,CNTCT_POINT_CATEG_CODE FROM POSTL_OPTOUT PA)
)
WITH DATA
PRIMARY INDEX (MKTNG_PGM_NBR,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS REGIS_PRSNA_POSTL_ADDR_T1
COLUMN ADDR_LINE_1_TXT1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS REGIS_PRSNA_POSTL_ADDR_T1
COLUMN ADDR_LINE_2_TXT1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS REGIS_PRSNA_POSTL_ADDR_T1
COLUMN ADDR_LINE_3_TXT1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS REGIS_PRSNA_POSTL_ADDR_T1
COLUMN CNSMR_CHCE_DATETM;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS REGIS_PRSNA_POSTL_ADDR_T1
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS REGIS_PRSNA_POSTL_ADDR_T1
COLUMN SUBSCRPTN_OPT_NBR1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS REGIS_PRSNA_POSTL_ADDR_T1
COLUMN CNTCT_POINT_CATEG_CODE;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

CREATE VOLATILE MULTISET TABLE POSTL_OPTOUT_T2 AS (
SEL 
ADJ.ADDR_LINE_1_TXT1,
ADJ.ADDR_LINE_2_TXT1,
ADJ.ADDR_LINE_3_TXT1,
ADJ.CITY_NAME1,
ADJ.TERR_NAME1,
ADJ.POSTL_AREA_CODE1,
ADJ.CNTRY_CODE,
ADJ.CNSMR_CHCE_DATETM,
ADJ.SYS_SOURCE,
ADJ.SUBSCRPTN_OPT_NBR1,
ADJ.MKTNG_PGM_NBR,
ADJ.CNTCT_POINT_CATEG_CODE,
ADJ.REGIS_PRSNA_ID
FROM POSTL_OPTOUT  ADJ
INNER JOIN REGIS_PRSNA_POSTL_ADDR_T1 PA 
ON PA.ADDR_LINE_1_TXT1=  ADJ.ADDR_LINE_1_TXT1
AND  PA.ADDR_LINE_2_TXT1= ADJ.ADDR_LINE_2_TXT1
AND  PA.ADDR_LINE_3_TXT1= ADJ.ADDR_LINE_3_TXT1
AND  PA.CITY_NAME1= ADJ.CITY_NAME1
AND  PA.TERR_NAME1= ADJ.TERR_NAME1
AND  PA.POSTL_AREA_CODE1= ADJ.POSTL_AREA_CODE1
AND  PA.CNTRY_CODE= ADJ.CNTRY_CODE
AND  PA.MKTNG_PGM_NBR=ADJ.MKTNG_PGM_NBR
AND  PA.CNSMR_CHCE_DATETM<=ADJ.CNSMR_CHCE_DATETM
AND  PA.SUBSCRPTN_OPT_NBR1 = ADJ.SUBSCRPTN_OPT_NBR1
AND  PA.CNTCT_POINT_CATEG_CODE=ADJ.CNTCT_POINT_CATEG_CODE
)
WITH DATA
PRIMARY INDEX (MKTNG_PGM_NBR,REGIS_PRSNA_ID)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

SEL 1 FROM POSTL_OPTOUT_T2 GROUP BY 1;
.IF ACTIVITYCOUNT = 0 THEN .EXIT

CREATE VOLATILE MULTISET TABLE POSTL_OPTOUT_T1 AS (
SEL 
ADDR_LINE_1_TXT1,
ADDR_LINE_2_TXT1,
ADDR_LINE_3_TXT1,
CITY_NAME1,
TERR_NAME1,
POSTL_AREA_CODE1,
CNTRY_CODE,
CNSMR_CHCE_DATETM,
SYS_SOURCE,
SUBSCRPTN_OPT_NBR1,
MKTNG_PGM_NBR,
CNTCT_POINT_CATEG_CODE
FROM POSTL_OPTOUT_T2
GROUP BY ADDR_LINE_1_TXT1,
ADDR_LINE_2_TXT1,
ADDR_LINE_3_TXT1,
CITY_NAME1,
TERR_NAME1,
POSTL_AREA_CODE1,
CNTRY_CODE,
CNSMR_CHCE_DATETM,
SYS_SOURCE,
SUBSCRPTN_OPT_NBR1,
MKTNG_PGM_NBR,
CNTCT_POINT_CATEG_CODE
)
WITH DATA
PRIMARY INDEX (MKTNG_PGM_NBR,ADDR_LINE_1_TXT1,ADDR_LINE_2_TXT1,ADDR_LINE_3_TXT1,
CITY_NAME1,TERR_NAME1,POSTL_AREA_CODE1,CNTRY_CODE,SUBSCRPTN_OPT_NBR1,CNTCT_POINT_CATEG_CODE)
ON COMMIT PRESERVE ROWS;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

COLLECT STATS POSTL_OPTOUT_T1
COLUMN ADDR_LINE_1_TXT1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL_OPTOUT_T1
COLUMN ADDR_LINE_2_TXT1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL_OPTOUT_T1
COLUMN ADDR_LINE_3_TXT1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL_OPTOUT_T1
COLUMN CNSMR_CHCE_DATETM;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL_OPTOUT_T1
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL_OPTOUT_T1
COLUMN SUBSCRPTN_OPT_NBR1;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;
COLLECT STATS POSTL_OPTOUT_T1
COLUMN CNTCT_POINT_CATEG_CODE;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;

UPDATE REGIS_PRSNA_POSTL_ADDR
FROM POSTL_OPTOUT_T1 TEMP
SET	SUBSCRPTN_OPT_IND = 'O'
,SYS_LAST_MODIFIED_DATE= CURRENT_DATE
,SYS_LAST_MODIFIED_BY = 'i2 Optout'
,CNSMR_CHCE_DATETM=TEMP.CNSMR_CHCE_DATETM
,SYS_SOURCE=TEMP.SYS_SOURCE
WHERE REGIS_PRSNA_POSTL_ADDR.MKTNG_PGM_NBR=TEMP.MKTNG_PGM_NBR
AND REGIS_PRSNA_POSTL_ADDR.CNTCT_POINT_CATEG_CODE=TEMP.CNTCT_POINT_CATEG_CODE
AND REGIS_PRSNA_POSTL_ADDR.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM MPN)
AND REGIS_PRSNA_POSTL_ADDR.CNTRY_CODE= TEMP.CNTRY_CODE
AND REGIS_PRSNA_POSTL_ADDR.SUBSCRPTN_OPT_NBR = TEMP.SUBSCRPTN_OPT_NBR1
AND REGIS_PRSNA_POSTL_ADDR.SUBSCRPTN_OPT_IND = 'I'
AND REGIS_PRSNA_POSTL_ADDR.CNSMR_CHCE_DATETM<=TEMP.CNSMR_CHCE_DATETM
AND COALESCE(TRIM(REGIS_PRSNA_POSTL_ADDR.ADDR_LINE_1_TXT),'')=  TEMP.ADDR_LINE_1_TXT1
AND COALESCE(TRIM(REGIS_PRSNA_POSTL_ADDR.ADDR_LINE_2_TXT),'')= TEMP.ADDR_LINE_2_TXT1
AND COALESCE(TRIM(REGIS_PRSNA_POSTL_ADDR.ADDR_LINE_3_TXT),'')= TEMP.ADDR_LINE_3_TXT1
AND COALESCE(TRIM(REGIS_PRSNA_POSTL_ADDR.CITY_NAME),'')= TEMP.CITY_NAME1
AND COALESCE(TRIM(REGIS_PRSNA_POSTL_ADDR.TERR_NAME),'')= TEMP.TERR_NAME1
AND COALESCE(TRIM(REGIS_PRSNA_POSTL_ADDR.POSTL_AREA_CODE),'')= TEMP.POSTL_AREA_CODE1
;
.IF ERRORLEVEL > 0 THEN .QUIT ERRORCODE;


.exit