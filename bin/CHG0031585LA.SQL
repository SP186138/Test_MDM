DATABASE MDM;

CREATE TABLE CHG0031585LA AS
(SEL SOURCE_ID,PRSNA_STG_1.MKTNG_PGM_NBR,PRSNA_STG_1.REGIS_CNSMR_ID_VAL, 
MAX(PRSNA_STG_1.LOAD_ID) AS LOAD_ID
FROM 
   (SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LOAD_ID FROM 
   ICRM_STAGE.PRSNA_STG
   WHERE MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM MDM.MKTNG_PGM WHERE LEGAL_ENT_NBR IN (17))
   UNION ALL
   SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LOAD_ID FROM
   ICRM_STAGE.PRSNA_STG_HIST
   WHERE MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM MDM.MKTNG_PGM WHERE LEGAL_ENT_NBR IN (17))) PRSNA_STG_1
   INNER JOIN MDM.LOAD_CONTROL LC  
   ON LC.LOAD_ID= PRSNA_STG_1.LOAD_ID 
   AND LC.LOAD_TYPE='ETL'
GROUP BY 1,2,3
) 
WITH DATA
PRIMARY INDEX (SOURCE_ID,MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LOAD_ID)
;

COLLECT STATS CHG0031585LA
COLUMN MKTNG_PGM_NBR;
COLLECT STATS CHG0031585LA
COLUMN REGIS_CNSMR_ID_VAL;
COLLECT STATS CHG0031585LA
COLUMN SOURCE_ID;

DEL FROM CHG0031585LA
WHERE (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SOURCE_ID)
NOT IN (SEL A.MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,A.SYS_TARGET_ID FROM MDM.REGIS_PRSNA A
INNER JOIN MDM.REGIS_PRSNA_POSTL_ADDR B
ON A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR
AND A.REGIS_PRSNA_ID=B.REGIS_PRSNA_ID
WHERE A.MKTNG_PGM_NBR IN (SEL MKTNG_PGM_NBR FROM MDM.MKTNG_PGM WHERE LEGAL_ENT_NBR IN (17))
AND CAST(B.SYS_LAST_MODIFIED_DATE AS DATE) <'2012-12-22'); 

COLLECT STATS CHG0031585LA
COLUMN MKTNG_PGM_NBR;
COLLECT STATS CHG0031585LA
COLUMN REGIS_CNSMR_ID_VAL;
COLLECT STATS CHG0031585LA
COLUMN LOAD_ID;

INS ADDR_TEMP
SEL * FROM TRILLIUM_OUTPUT1_LA;

INSERT INTO ADDR_INPUT
(
 CNTCT_POINT_CATEG_CODE
,REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,WIN_KEY
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,TERR_NAME
,CNTRY_CODE
,VALID_CNTCT_POINT_IND
,PR_REV_GROUP
,PR_GEOCODE_FAIL
,SYS_LAST_MODIFIED_DATE
,SYS_ERR_CODE )
SELECT
TOUT.ADDRESS_CONTACT
,TOUT1.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.WINDOW_KEY_01
,TOUT.DR_ADDRESS
,TOUT.DR_ADDRESS2
,TOUT.DR_ADDRESS3
,TOUT.DR_HOUSE_NUMBER1
,TOUT.DR_STREET_NAME
,TOUT.DR_HOUSE_NUMBER2
,TOUT.DR_POBOX_NUMBER
,TOUT.DR_CITY_NAME
,TOUT.DR_POSTAL_CODE
,CASE WHEN TR.TERR_RECODE IS NOT NULL
            THEN TR.TERR_RECODE
            ELSE TOUT.DR_REGION_NAME
  END AS DR_REGION_NAME
,CASE WHEN CR.CNTRY_RECODE IS NOT NULL
      THEN CR.CNTRY_RECODE 
      ELSE TOUT.DR_COUNTRY_NAME
  END AS DR_COUNTRY_NAME
,CASE 
WHEN (GOUT_MATCH_LEVEL IN ('0','9')
      AND DR_COUNTRY_NAME IN ('JPN','CHN','TWN','KOR','NZL','AUS','MYS','SGP','HKG','USA','CAN'))
      OR DR_COUNTRY_NAME IN ('ARG','CHL','MEX','BRA')
      OR (PR_REV_GROUP IN ('0','000','001','002','003','005','008','009','010','012','019')
      AND  DR_COUNTRY_NAME NOT IN ('JPN','CHN','TWN','KOR','NZL','AUS','MYS','SGP','HKG','USA','CAN','BRA','MEX'))

THEN 'Y'
ELSE 'N'
END VALID_CNTCT_POINT_IND
,TRIM(TOUT.PR_REV_GROUP) PR_REV_GROUP
,TOUT.GOUT_MATCH_LEVEL
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,'CHG0031585' SYS_ERR_CODE 
FROM
ADDR_TEMP TOUT
INNER JOIN REGIS_PRSNA TOUT1
ON TOUT.MKTNG_PGM_NBR=TOUT1.MKTNG_PGM_NBR
AND TOUT.REGIS_CNSMR_ID_VAL=TOUT1.REGIS_CNSMR_ID_VAL
AND TOUT.SYS_TARGET_ID=TOUT1.SYS_TARGET_ID
LEFT OUTER JOIN TERR_RECODE TR
ON TOUT.DR_REGION_NAME = TR.TERR
AND TOUT.DR_COUNTRY_NAME = TR.CNTRY
LEFT OUTER JOIN CNTRY_RECODE CR
ON TOUT.DR_COUNTRY_NAME = CR.CNTRY
;


UPDATE REGIS_PRSNA_POSTL_ADDR
FROM ADDR_INPUT B
SET WIN_KEY=B.WIN_KEY
,ADDR_LINE_1_TXT=B.ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT=B.ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT=B.ADDR_LINE_3_TXT
,STRET_NUM=B.STRET_NUM
,STRET_NAME=B.STRET_NAME
,APT_NUM=B.APT_NUM
,PO_BOX_NUM=B.PO_BOX_NUM
,CITY_NAME=B.CITY_NAME
,POSTL_AREA_CODE=B.POSTL_AREA_CODE
,TERR_NAME=B.TERR_NAME
,CNTRY_CODE=B.CNTRY_CODE
,VALID_CNTCT_POINT_IND=B.VALID_CNTCT_POINT_IND
,PR_REV_GROUP=B.PR_REV_GROUP
,PR_GEOCODE_FAIL=B.PR_GEOCODE_FAIL
,SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE
,SYS_ERR_CODE=B.SYS_ERR_CODE
WHERE REGIS_PRSNA_POSTL_ADDR.CNTCT_POINT_CATEG_CODE=B.CNTCT_POINT_CATEG_CODE
AND REGIS_PRSNA_POSTL_ADDR.REGIS_PRSNA_ID=B.REGIS_PRSNA_ID
AND REGIS_PRSNA_POSTL_ADDR.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR;