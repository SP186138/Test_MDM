@echo off
REM TSS Import

REM SCRIPT:               CNSMR_TSS_WINKEY_STG.FLD 
REM DESCRIPTION:          This script loads the MST WINKEY TRIGGER table from the trigger file that is given by 
REM                       Trillium
REM DEPENDENCY:           TRILLIUM WINKEY SCRIPT
REM INPUT:                TRILLIUM WINKEY FILE
REM OUTPUT:               MST WINKEY TRIGGER
REM ERRORS:
REM SPECIAL INSTRUCTIONS:
REM CHANGE LOG:
REM VERSION              DATE                 AUTHOR                          CHANGES
REM 1.00                 04/10/2013           TERADATA                        INITIAL VERSION



echo Executing TSS Import

:start
set ERR=%ERRORLEVEL%
set ERR1=%ERRORLEVEL%
FOR /F "tokens=1-6 delims=/ " %%i in ('date/t') do set currentdate=%%i-%%j-%%k-%%l
FOR /F "tokens=1-6 delims=: " %%i in ('time/t') do set currenttime=%%i-%%j-%%k
call .\mdmcustomenv-parallel.bat 

set TSSWINKEYOUTPUT="/c:%TSS_WINKEY_OUTPUT%"

set LOGONFILE="/e:%LOGON_FILE%"

set DATABASENAME="/f:%MASTER_DB%"

set CNSMRTSSWINKEYCLEANUPBTEQ="/d:%CNSMR_TSS_WINKEY_CLEANUP_BTEQ%.BTEQ"

set MSTDB="/g:%MST_DB%"

set CNTRY="/h:DNK"

set COUNTRY="DNK"

set CNTRY1=DNK

cscript %MDM_CUSTOM_DIR%\etl-scripts-parallel\bin\CNSMR_TSS_WINKEY_STG.vbs %TSSWINKEYOUTPUT% %CNSMRTSSWINKEYCLEANUPBTEQ% %LOGONFILE% %DATABASENAME% %MSTDB%  %CNTRY% > %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG

IF ERRORLEVEL 1 (
echo Exiting due to error during WINKEY TRIGGER cleanup >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
set errorlevel=1
ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG
exit 1
 )
 
set CNSMRTSSWINKEYCLEANUPBTEQ="%CNSMR_TSS_WINKEY_CLEANUP_BTEQ%.BTEQ%COUNTRY%" 

 bteq < %CNSMRTSSWINKEYCLEANUPBTEQ% >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
set ERR=%ERRORLEVEL%
set FAILUREBTEQ="/d:%TSS_WINKEY_STG_FAILURE_BTEQ%.BTEQ"
set FAILUREBTEQ1="%TSS_WINKEY_STG_FAILURE_BTEQ%.BTEQ%COUNTRY%"  
IF NOT %ERR% == 0  (
echo Exiting due to error during WINKEY LOAD >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG

cscript %MDM_CUSTOM_DIR%\etl-scripts-parallel\bin\CNSMR_TSS_WINKEY_STG.vbs %TSSWINKEYOUTPUT% %FAILUREBTEQ% %LOGONFILE% %DATABASENAME% %MSTDB%  %CNTRY% >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
IF ERRORLEVEL 1 (
echo Exiting due to error during WINKEY LOAD >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
set errorlevel=1
ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG
exit 1
)
 
bteq < %FAILUREBTEQ1% >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
set ERR1=%ERRORLEVEL%
IF NOT %ERR1% == 0 (
ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG
exit %ERR1%
)
ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG
exit %ERR%
)

set CNSMRTSSWINKEYSTGFLD="/d:%CNSMR_TSS_WINKEY_STG_FLD%.FLD"

cscript %MDM_CUSTOM_DIR%\etl-scripts-parallel\bin\CNSMR_TSS_WINKEY_STG.vbs %TSSWINKEYOUTPUT% %CNSMRTSSWINKEYSTGFLD% %LOGONFILE% %DATABASENAME% %MSTDB%  %CNTRY% >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG

 IF ERRORLEVEL 1 (
 echo Exiting due to error during WINKEY TRIGGER cleanup >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
 set errorlevel=1
ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG
exit 1
)

set CNSMRTSSWINKEYSTGFLD="%CNSMR_TSS_WINKEY_STG_FLD%.FLD%COUNTRY%"

fastload -c UTF8 < %CNSMRTSSWINKEYSTGFLD% >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
REM tbuild -f %CNSMR_TSS_WINKEY_STG_TPT% -u "TdpId='%TdpId%',UserName='%UserName%',UserPassword='%UserPassword%',MDM_DB='%MDM_DB%',ERR_DB='%ERR_DB%',LOG_DB='%LOG_DB%',WORK_DB='%WORK_DB%',DirectoryPath='%MDM_CUSTOM_DIR%\data',FileName = '%TSS_WINKEY_OUTPUT%'"
set ERR=%ERRORLEVEL%
set FAILUREBTEQ="/d:%TSS_WINKEY_STG_FAILURE_BTEQ%.BTEQ"
set FAILUREBTEQ1="%TSS_WINKEY_STG_FAILURE_BTEQ%.BTEQ%COUNTRY%"  
IF NOT %ERR% == 0  (
echo Exiting due to error during WINKEY LOAD >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
cscript %MDM_CUSTOM_DIR%\etl-scripts-parallel\bin\CNSMR_TSS_WINKEY_STG.vbs %TSSWINKEYOUTPUT% %FAILUREBTEQ% %LOGONFILE% %DATABASENAME% %MSTDB%  %CNTRY% >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
IF ERRORLEVEL 1 (
echo Exiting due to error during WINKEY LOAD >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
set errorlevel=1
ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG
exit 1
)
 
bteq < %FAILUREBTEQ1% >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
set ERR1=%ERRORLEVEL%
IF NOT %ERR1% == 0 (
ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG
exit %ERR1%
)
ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG
exit %ERR%
)

set CNSMRTSSWINKEYSTGBTEQ="/d:%CNSMR_TSS_WINKEY_STG_BTEQ%.BTEQ"

set DATABASENAME="/f:%ICRM_DB%"

cscript %MDM_CUSTOM_DIR%\etl-scripts-parallel\bin\CNSMR_TSS_WINKEY_STG.vbs %TSSWINKEYOUTPUT% %CNSMRTSSWINKEYSTGBTEQ% %LOGONFILE% %DATABASENAME% %MSTDB%  %CNTRY% >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG

IF ERRORLEVEL 1 (
echo Exiting due to error during winkey update >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
set errorlevel=1
ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG
exit 1
)

set CNSMRTSSWINKEYSTGBTEQ="%CNSMR_TSS_WINKEY_STG_BTEQ%.BTEQ%COUNTRY%"

bteq < %CNSMRTSSWINKEYSTGBTEQ% >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
set ERR=%ERRORLEVEL%
set FAILUREBTEQ="/d:%TSS_WINKEY_STG_FAILURE_BTEQ%.BTEQ"
set FAILUREBTEQ1="%TSS_WINKEY_STG_FAILURE_BTEQ%.BTEQ%COUNTRY%" 
 IF NOT %ERR% == 0  (
echo Exiting due to error during WINKEY LOAD >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG

cscript %MDM_CUSTOM_DIR%\etl-scripts-parallel\bin\CNSMR_TSS_WINKEY_STG.vbs %TSSWINKEYOUTPUT% %FAILUREBTEQ% %LOGONFILE% %DATABASENAME% %MSTDB%  %CNTRY% >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
IF ERRORLEVEL 1 (
echo Exiting due to error during WINKEY LOAD >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
set errorlevel=1
ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG
exit 1
)
 
bteq < %FAILUREBTEQ1% >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
set ERR1=%ERRORLEVEL%
IF NOT %ERR1% == 0 (
ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG
exit %ERR1%
)

ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG
exit %ERR%
)

del %TSS_WINKEY_OUTPUT%_%COUNTRY%.DAT
IF ERRORLEVEL 1 (
echo Exiting due to error during fast load >> %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG
set errorlevel=1
ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG
exit 1
)

ren %MDM_CUSTOM_DIR%\log\TSS_WINKEY_OUTPUT_%CNTRY1%.LOG TSS_WINKEY_OUTPUT_%CNTRY1%_%currentdate%_%currenttime%.LOG

:end