/***********************************************************************************************************
SCRIPT:               CNSMR_CNTCT_ORIG.BTEQ 
DESCRIPTION:          THIS SCRIPT UPDATES THE ORIGINAL TABLES
DEPENDENCY:           
INPUT:                ICRM STAGING 
OUTPUT:               ORIGINAL GOLDEN TABLES
ERRORS:
SPECIAL INSTRUCTIONS:

CHANGE LOG:
VERSION              DATE                 AUTHOR                          CHANGES
1.00                 08/21/2011           TERADATA                        INITIAL VERSION
***********************************************************************************************************/

.RUN FILE \\10.36.32.45\Teradata\MDM\3.05.02\custom\pngrelease3\logon\LOGON.txt;
.SET ERROROUT STDOUT;
.SET SESSION CHARSET 'UTF8';

DEL FROM TSS_LOAD_ORIG ALL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO TSS_LOAD_ORIG
(
LOAD_ID
) 
SEL DISTINCT LOAD_ID FROM LOAD_INFO
WHERE PROCESS_START_TIME > (SEL MAX(PROCESS_END_TIME) PROCESS_END_TIME
FROM LOAD_INFO
WHERE PROCESS_NAME = 'ORIGINAL LOADS'
)
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM PRSNA_POSTL_ADDR_ORIG WHERE
(REGIS_CNSMR_ID_VAL
,MKTNG_PGM_NBR)
IN
(
SELECT 
A.REGIS_CNSMR_ID_VAL
,A.MKTNG_PGM_NBR
FROM	
ICRM_STAGE.PRSNA_POSTL_ADDR_STG A
INNER JOIN MDM.TSS_LOAD_ORIG LOAD
ON A.LOAD_ID = LOAD.LOAD_ID
GROUP BY 1,2);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM PRSNA_PHONE_ORIG WHERE
(REGIS_CNSMR_ID_VAL
,MKTNG_PGM_NBR)
IN
(
SELECT 
A.REGIS_CNSMR_ID_VAL
,A.MKTNG_PGM_NBR
FROM	
ICRM_STAGE.PRSNA_PHONE_STG A
INNER JOIN MDM.TSS_LOAD_ORIG LOAD
ON A.LOAD_ID = LOAD.LOAD_ID
GROUP BY 1,2);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM PRSNA_EMAIL_ADDR_ORIG WHERE
(REGIS_CNSMR_ID_VAL
,MKTNG_PGM_NBR)
IN
(
SELECT 
A.REGIS_CNSMR_ID_VAL
,A.MKTNG_PGM_NBR
FROM	
ICRM_STAGE.PRSNA_EMAIL_ADDR_STG A
INNER JOIN MDM.TSS_LOAD_ORIG LOAD
ON A.LOAD_ID = LOAD.LOAD_ID
GROUP BY 1,2);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM PRSNA_SOC_NET_ACCT_ORIG WHERE
(REGIS_CNSMR_ID_VAL
,MKTNG_PGM_NBR)
IN
(
SELECT 
A.REGIS_CNSMR_ID_VAL
,A.MKTNG_PGM_NBR
FROM	
ICRM_STAGE.PRSNA_SOCIAL_NETWK_ACCT_STG A
INNER JOIN MDM.TSS_LOAD_ORIG LOAD
ON A.LOAD_ID = LOAD.LOAD_ID
GROUP BY 1,2);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO PRSNA_POSTL_ADDR_ORIG
(
 REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,REGIS_CNSMR_ID_VAL
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,TERR_CODE
,CNTRY_CODE
,GUARDN_EMAIL_ADDR_TXT
,CNTCT_POINT_CATEG_CODE
,GUARDN_NAME
,GUARDN_CNSNT_IND
,ACNLGMT_DATE
,SUBSCRPTN_OPT_NBR
,SUBSCRPTN_OPT_IND
,CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND
,VALID_CNTCT_POINT_IND
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE 
,SYS_ERR_SVRTY)
SELECT
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.REGIS_CNSMR_ID_VAL
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.STRET_NUM
,STG.STRET_NAME
,STG.APT_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,STG.TERR_NAME
,STG.CNTRY_NAME
,C.GUARDN_EMAIL_ADDR_TXT
,STG.CNTCT_POINT_CATEG_CODE
,C.GUARDN_NAME
,C.GUARDN_CNSNT_IND
,C.ACNLGMT_DATE
,C.CNTCT_OPTN_NBR
,C.CNTCT_OPTN_IND
,C.CNSMR_CHCE_DATETM
,STG.PREFR_IND
,STG.VALID_IND VALID_CNTCT_POINT_IND
,STG.LOAD_ID AS SYS_SOURCE
,'' SYS_TARGET_ID
,'' SYS_AUTH_ID
,'' SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,'' SYS_ENT_STATE
,'' SYS_LAST_MODIFIED_BY
,STG.RECORD_IND SYS_NC_TYPE
,'' SYS_ERR_CODE 
,'' SYS_ERR_SVRTY
FROM	
ICRM_STAGE.PRSNA_POSTL_ADDR_STG STG
INNER JOIN MDM.TSS_LOAD_ORIG LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON  STG.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND STG.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND STG.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
AND STG.LOAD_ID = C.LOAD_ID
AND STG.RECORD_IND = C.RECORD_IND
INNER JOIN MDM.REGIS_PRSNA TOUT
ON  STG.MKTNG_PGM_NBR = TOUT.MKTNG_PGM_NBR
AND STG.REGIS_CNSMR_ID_VAL = TOUT.REGIS_CNSMR_ID_VAL
QUALIFY RANK() OVER (PARTITION BY TOUT.MKTNG_PGM_NBR,TOUT.REGIS_CNSMR_ID_VAL  
ORDER BY STG.LOAD_ID DESC
,STG.LOAD_TS DESC
,STG.RECORD_IND DESC
,TOUT.PRSNA_STATUS_CODE DESC
) = 1;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PRSNA_PHONE_ORIG 
(
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
REGIS_CNSMR_ID_VAL            ,
PHONE_CNTRY_NBR               ,
PHONE_AREA_NBR                ,
PHONE_EXCHG_NBR               ,
PHONE_LINE_NBR                ,
PHONE_EXTSN_NUM               ,
FULL_PHONE_NUM                ,
GUARDN_EMAIL_ADDR_TXT         ,
CNTCT_POINT_CATEG_CODE,
GUARDN_NAME,
GUARDN_CNSNT_IND,
ACNLGMT_DATE,
SUBSCRPTN_OPT_NBR,
SUBSCRPTN_OPT_IND,
CNSMR_CHCE_DATETM,
PREF_CNTCT_POINT_IND,
VALID_CNTCT_POINT_IND,
SMS_PREFR_IND                 ,
SMS_AVAIL_START_TIME          ,
SMS_AVAIL_END_TIME            ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.PHONE_CNTRY_NBR               ,
A.PHONE_AREA_NBR                ,
A.PHONE_EXCHG_NBR               ,
A.PHONE_LINE_NBR                ,
A.PHONE_EXTSN_NUM               ,
A.FULL_PHONE_NUM              ,
C.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
C.GUARDN_NAME,
C.GUARDN_CNSNT_IND,
C.ACNLGMT_DATE,
C.CNTCT_OPTN_NBR,
C.CNTCT_OPTN_IND,
C.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.SMS_PREFR_IND                 ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_START_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)     SMS_AVAIL_START_TIME     ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_END_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)      SMS_AVAIL_END_TIME    
,A.LOAD_ID AS SYS_SOURCE
,'' SYS_TARGET_ID
,'' SYS_AUTH_ID
,'' SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,'' SYS_ENT_STATE
,'' SYS_LAST_MODIFIED_BY
,A.RECORD_IND SYS_NC_TYPE
,'' SYS_ERR_CODE 
,'' SYS_ERR_SVRTY
FROM	
ICRM_STAGE.PRSNA_PHONE_STG A
INNER JOIN MDM.TSS_LOAD_ORIG LOAD
ON A.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON  A.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND A.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND A.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
AND A.LOAD_ID = C.LOAD_ID
AND A.RECORD_IND = C.RECORD_IND
INNER JOIN MDM.REGIS_PRSNA B
ON  A.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND A.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
QUALIFY RANK() OVER (PARTITION BY B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL  
ORDER BY A.LOAD_ID DESC
,A.LOAD_TS DESC
,A.RECORD_IND DESC
,B.PRSNA_STATUS_CODE DESC
) = 1
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PRSNA_EMAIL_ADDR_ORIG 
(
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
REGIS_CNSMR_ID_VAL             ,
EMAIL_ADDR_TXT                ,
GUARDN_EMAIL_ADDR_TXT         ,
CNTCT_POINT_CATEG_CODE,
GUARDN_NAME,
GUARDN_CNSNT_IND,
ACNLGMT_DATE,
SUBSCRPTN_OPT_NBR,
SUBSCRPTN_OPT_IND,
CNSMR_CHCE_DATETM,
PREF_CNTCT_POINT_IND,
VALID_CNTCT_POINT_IND,
EMAIL_FORMT_CODE              ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT 
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.EMAIL_ADDR_TXT                ,
C.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
C.GUARDN_NAME,
C.GUARDN_CNSNT_IND,
C.ACNLGMT_DATE,
C.CNTCT_OPTN_NBR,
C.CNTCT_OPTN_IND,
C.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.EMAIL_FORMT_CODE              
,A.LOAD_ID AS SYS_SOURCE
,'' SYS_TARGET_ID
,'' SYS_AUTH_ID
,'' SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,'' SYS_ENT_STATE
,'' SYS_LAST_MODIFIED_BY
,A.RECORD_IND SYS_NC_TYPE
,'' SYS_ERR_CODE 
,'' SYS_ERR_SVRTY
FROM	
ICRM_STAGE.PRSNA_EMAIL_ADDR_STG A
INNER JOIN MDM.TSS_LOAD_ORIG LOAD
ON A.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON  A.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND A.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND A.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
AND A.LOAD_ID = C.LOAD_ID
AND A.RECORD_IND = C.RECORD_IND
INNER JOIN MDM.REGIS_PRSNA B
ON  A.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND A.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
QUALIFY RANK() OVER (PARTITION BY B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL  
ORDER BY A.LOAD_ID DESC
,A.LOAD_TS DESC
,A.RECORD_IND DESC
,B.PRSNA_STATUS_CODE DESC
) = 1
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PRSNA_SOC_NET_ACCT_ORIG 
(
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
REGIS_CNSMR_ID_VAL             ,
SOCIAL_NETWK_ACCT_ID_VAL      ,
GUARDN_EMAIL_ADDR_TXT         ,
CNTCT_POINT_CATEG_CODE,
GUARDN_NAME,
GUARDN_CNSNT_IND,
ACNLGMT_DATE,
SUBSCRPTN_OPT_NBR,
SUBSCRPTN_OPT_IND,
CNSMR_CHCE_DATETM,
PREF_CNTCT_POINT_IND,
VALID_CNTCT_POINT_IND,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.SOCIAL_NETWK_ACCT_ID_VAL      ,
C.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
C.GUARDN_NAME,
C.GUARDN_CNSNT_IND,
C.ACNLGMT_DATE,
C.CNTCT_OPTN_NBR,
C.CNTCT_OPTN_IND,
C.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND
,A.LOAD_ID AS SYS_SOURCE
,'' SYS_TARGET_ID
,'' SYS_AUTH_ID
,'' SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,'' SYS_ENT_STATE
,'' SYS_LAST_MODIFIED_BY
,A.RECORD_IND SYS_NC_TYPE
,'' SYS_ERR_CODE 
,'' SYS_ERR_SVRTY
FROM	
ICRM_STAGE.PRSNA_SOCIAL_NETWK_ACCT_STG A
INNER JOIN MDM.TSS_LOAD_ORIG LOAD
ON A.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON  A.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND A.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND A.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
AND A.LOAD_ID = C.LOAD_ID
AND A.RECORD_IND = C.RECORD_IND
INNER JOIN MDM.REGIS_PRSNA B
ON  A.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND A.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
QUALIFY RANK() OVER (PARTITION BY B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL  
ORDER BY A.LOAD_ID DESC
,A.LOAD_TS DESC
,A.RECORD_IND DESC
,B.PRSNA_STATUS_CODE DESC
) = 1
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO CNTCT_POINT_CATEG 
(CNTCT_POINT_CATEG_CODE,
CNTCT_POINT_CATEG_NAME,
CNTCT_POINT_TYPE_CODE)
SELECT 
A.AV_CODE AS CNTCT_POINT_CATEG_CODE,
A.AV_DESCRIPTION AS CNTCT_POINT_CATEG_NAME,
C.AV_CODE AS CNTCT_POINT_TYPE_CODE

FROM ATTRIBUTE_VALUES A
INNER JOIN ATTRIBUTE_VALUES_HIERARCHY B
ON A.AV_ID = B.AV_ID_CHILD

INNER JOIN ATTRIBUTE_VALUES C
ON B.AV_ID_PARENT = C.AV_ID

WHERE A.ATTRIBUTE_TYPE_ID=3 
  AND A.AV_CODE NOT IN (SELECT CNTCT_POINT_CATEG_CODE FROM
CNTCT_POINT_CATEG);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO LOAD_INFO
(
LOAD_ID,
PROCESS_NAME,
PROCESS_START_TIME,
PROCESS_END_TIME,
NC_TYPE,
STATUS,
SYS_CREATION_DATE,
SYS_LAST_MODIFIED_DATE) 
SELECT
0,
'ORIGINAL LOADS',
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
'INSERT',
'Success',
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19))
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

.LABEL EXIT

.IF ERRORLEVEL > 4 THEN .GOTO ERR ;
.IF ERRORLEVEL <= 4 THEN .GOTO WARN;

.LABEL ERR
.QUIT 1

.LABEL WARN
.QUIT 0

