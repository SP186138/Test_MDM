DELETE FROM CNSMR_AFFLTN_STG;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM DPEND_STG;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM DPEND_TRT_STG;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM PET_STG;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM PET_TRT_STG;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM PRSNA_EMAIL_ADDR_STG;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM PRSNA_PHONE_STG;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM PRSNA_POSTL_ADDR_STG;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM PRSNA_SOC_NETWK_ACCT_STG;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM PRSNA_STG;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM PRSNA_TRT_STG;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

/* VALIDATION FOR MISSING LEGAL ENTITY NUMBER */ 


INSERT INTO ERR_PRSNA_STG (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_ERR_CODE)
SELECT
DER.MKTNG_PGM_NBR,
DER.REGIS_CNSMR_ID_VAL,
'Missing Legal Entity Number in Marketing Program Entity' SYS_ERR_CODE
FROM
(
SELECT 
STG.MKTNG_PGM_NBR,
STG.REGIS_CNSMR_ID_VAL
FROM
ICRM_STAGE.PRSNA_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN MKTNG_PGM MKTNG_PGM_1
ON STG.MKTNG_PGM_NBR = MKTNG_PGM_1.MKTNG_PGM_NBR
WHERE MKTNG_PGM_1.MKTNG_PGM_NBR IS NULL
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
GROUP BY 1,2
)DER;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;


/* VALIDATION FOR SAME CATEG CODE COMING TWICE */ 


INSERT INTO ERR_PRSNA_STG (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_ERR_CODE)
SELECT
DER.MKTNG_PGM_NBR,
DER.REGIS_CNSMR_ID_VAL,
'Email Address having same Category Code' SYS_ERR_CODE
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
STG.LOAD_ID,
--STG.LOAD_TS,
RECORD_IND
FROM
ICRM_STAGE.PRSNA_EMAIL_ADDR_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
--GROUP BY 1,2,3,4,5,6
GROUP BY 1,2,3,4,5
HAVING COUNT(*) >1
)DER;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO ERR_PRSNA_STG (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_ERR_CODE)
SELECT
DER1.MKTNG_PGM_NBR,
DER1.REGIS_CNSMR_ID_VAL,
'Phone having same Category Code' SYS_ERR_CODE
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
STG.LOAD_ID,
--STG.LOAD_TS,
RECORD_IND
FROM
ICRM_STAGE.PRSNA_PHONE_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
--GROUP BY 1,2,3,4,5,6
GROUP BY 1,2,3,4,5
HAVING COUNT(*) >1
)DER1;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO ERR_PRSNA_STG (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_ERR_CODE)
SELECT
DER1.MKTNG_PGM_NBR,
DER1.REGIS_CNSMR_ID_VAL,
'Social having same Category Code' SYS_ERR_CODE
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
STG.LOAD_ID,
--STG.LOAD_TS,
RECORD_IND
FROM
ICRM_STAGE.PRSNA_SOCIAL_NETWK_ACCT_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID	
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
-- GROUP BY 1,2,3,4,5,6
GROUP BY 1,2,3,4,5
HAVING COUNT(*) >1
)DER1;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

/* VALIDATION FOR CHECKING CATEG CODE VALUES FROM ATT VALUES TABLE */

INSERT INTO ERR_PRSNA_STG (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_ERR_CODE)
SELECT
DER2.MKTNG_PGM_NBR,
DER2.REGIS_CNSMR_ID_VAL,
'Not a Valid Category Code Value for EMAIL' SYS_ERR_CODE
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE
FROM
ICRM_STAGE.PRSNA_EMAIL_ADDR_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN (
SEL A.AV_CODE  FROM ATTRIBUTE_VALUES A
INNER JOIN ATTRIBUTE_VALUES_HIERARCHY C
ON A.AV_ID = C.AV_ID_CHILD
INNER JOIN ATTRIBUTE_VALUES B
ON C.AV_ID_PARENT = B.AV_ID
AND B.AV_DESCRIPTION='Email Address'
) A
ON STG.CNTCT_POINT_CATEG_CODE = A.AV_CODE
WHERE A.AV_CODE IS NULL
)DER2;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO ERR_PRSNA_STG (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_ERR_CODE)
SELECT
DER3.MKTNG_PGM_NBR,
DER3.REGIS_CNSMR_ID_VAL,
'Not a Valid Category Code Value for PHONE' 
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE
FROM
ICRM_STAGE.PRSNA_PHONE_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN (
SEL A.AV_CODE  FROM ATTRIBUTE_VALUES A
INNER JOIN ATTRIBUTE_VALUES_HIERARCHY C
ON A.AV_ID = C.AV_ID_CHILD
INNER JOIN ATTRIBUTE_VALUES B
ON C.AV_ID_PARENT = B.AV_ID
AND B.AV_DESCRIPTION='Telephone Number'
) A
ON STG.CNTCT_POINT_CATEG_CODE = A.AV_CODE
WHERE A.AV_CODE IS NULL
)DER3;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO ERR_PRSNA_STG (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_ERR_CODE)
SELECT
DER4.MKTNG_PGM_NBR,
DER4.REGIS_CNSMR_ID_VAL,
'Not a Valid Category Code Value for POSTAL' SYS_ERR_CODE
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE
FROM
ICRM_STAGE.PRSNA_POSTL_ADDR_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN (
SEL A.AV_CODE  FROM ATTRIBUTE_VALUES A
INNER JOIN ATTRIBUTE_VALUES_HIERARCHY C
ON A.AV_ID = C.AV_ID_CHILD
INNER JOIN ATTRIBUTE_VALUES B
ON C.AV_ID_PARENT = B.AV_ID
AND B.AV_DESCRIPTION='Postal Address'
) A
ON STG.CNTCT_POINT_CATEG_CODE = A.AV_CODE
WHERE A.AV_CODE IS NULL
)DER4;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

/* RECORDS HAVING MORE THEN TWO POSTAL/EMAIL/PHONE */

INSERT INTO ERR_PRSNA_STG (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_ERR_CODE)
SELECT
TEMP.MKTNG_PGM_NBR,
TEMP.REGIS_CNSMR_ID_VAL,
'Too Many Values in Postal' SYS_ERR_CODE
FROM
(SELECT  MKTNG_PGM_NBR
       ,REGIS_CNSMR_ID_VAL
       ,STG.LOAD_ID
     --  ,STG.LOAD_TS
       ,RECORD_IND
FROM ICRM_STAGE.PRSNA_POSTL_ADDR_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
--GROUP BY 1,2,3,4,5
GROUP BY 1,2,3,4
HAVING COUNT(*) > 1)TEMP;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO ERR_PRSNA_STG (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_ERR_CODE)
SELECT
TEMP1.MKTNG_PGM_NBR,
TEMP1.REGIS_CNSMR_ID_VAL,
'Too Many Values in Phone' SYS_ERR_CODE
FROM
(SELECT  MKTNG_PGM_NBR
       ,REGIS_CNSMR_ID_VAL
       ,STG.LOAD_ID
  --     ,STG.LOAD_TS
       ,RECORD_IND
FROM ICRM_STAGE.PRSNA_PHONE_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
--GROUP BY 1,2,3,4,5
GROUP BY 1,2,3,4
HAVING COUNT(*) > 3)TEMP1;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO ERR_PRSNA_STG (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_ERR_CODE)
SELECT
TEMP3.MKTNG_PGM_NBR,
TEMP3.REGIS_CNSMR_ID_VAL,
'Too Many Values in Email' SYS_ERR_CODE
FROM
(SELECT  MKTNG_PGM_NBR
       ,REGIS_CNSMR_ID_VAL
       ,STG.LOAD_ID
   --    ,STG.LOAD_TS
       ,RECORD_IND
FROM ICRM_STAGE.PRSNA_EMAIL_ADDR_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
--GROUP BY 1,2,3,4,5
GROUP BY 1,2,3,4
HAVING COUNT(*) > 3)TEMP3;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;


/* RECORDS WITH INVALID CONTACT INDICATOR */

INSERT INTO ERR_PRSNA_STG (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_ERR_CODE)
SELECT
TEMP1.MKTNG_PGM_NBR,
TEMP1.REGIS_CNSMR_ID_VAL,
'CNTCT_OPTN_IND NOT VALID' SYS_ERR_CODE
FROM
(
SELECT	
  PRSNA_STG_1.MKTNG_PGM_NBR
 ,PRSNA_STG_1.REGIS_CNSMR_ID_VAL  
FROM	ICRM_STAGE.PRSNA_STG PRSNA_STG_1
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON PRSNA_STG_1.LOAD_ID = LOAD.LOAD_ID  
AND (PRSNA_STG_1.MKTNG_PGM_NBR,PRSNA_STG_1.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
 LEFT OUTER  JOIN ICRM_STAGE.CNTCT_OPTN_CHCE_STG B    
	ON	PRSNA_STG_1.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	PRSNA_STG_1.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND	PRSNA_STG_1.LOAD_ID=B.LOAD_ID
	AND B.CNTCT_POINT_TYPE_CODE IN (sel AV_CODE  from ATTRIBUTE_VALUES B
                                                    WHERE B.AV_DESCRIPTION='Email Address')
 LEFT OUTER JOIN ICRM_STAGE.CNTCT_OPTN_CHCE_STG C    
	ON	PRSNA_STG_1.MKTNG_PGM_NBR=C.MKTNG_PGM_NBR   
	AND	PRSNA_STG_1.REGIS_CNSMR_ID_VAL=C.REGIS_CNSMR_ID_VAL
	AND	PRSNA_STG_1.LOAD_ID=C.LOAD_ID
	AND C.CNTCT_POINT_TYPE_CODE IN (sel AV_CODE  from ATTRIBUTE_VALUES B
                                                    WHERE B.AV_DESCRIPTION='Telephone Number')
 LEFT OUTER JOIN ICRM_STAGE.CNTCT_OPTN_CHCE_STG D    
	ON	PRSNA_STG_1.MKTNG_PGM_NBR=D.MKTNG_PGM_NBR   
	AND	PRSNA_STG_1.REGIS_CNSMR_ID_VAL=D.REGIS_CNSMR_ID_VAL
	AND	PRSNA_STG_1.LOAD_ID=D.LOAD_ID		
	AND D.CNTCT_POINT_TYPE_CODE IN (sel AV_CODE  from ATTRIBUTE_VALUES B
                                                    WHERE B.AV_DESCRIPTION='Postal Address')
 LEFT OUTER JOIN ICRM_STAGE.CNTCT_OPTN_CHCE_STG E    
	ON	PRSNA_STG_1.MKTNG_PGM_NBR=E.MKTNG_PGM_NBR   
	AND	PRSNA_STG_1.REGIS_CNSMR_ID_VAL=E.REGIS_CNSMR_ID_VAL
	AND	PRSNA_STG_1.LOAD_ID=E.LOAD_ID				
	AND E.CNTCT_POINT_TYPE_CODE IN (sel AV_CODE  from ATTRIBUTE_VALUES B
                                                    WHERE B.AV_DESCRIPTION='Social Network Account')
WHERE (B.CNTCT_OPTN_IND IS NULL 
  AND  C.CNTCT_OPTN_IND IS NULL
  AND  D.CNTCT_OPTN_IND IS NULL
  AND  E.CNTCT_OPTN_IND IS NULL
      )
)TEMP1
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

/* Failed records for AGE */



INSERT INTO ERR_PRSNA_STG (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_ERR_CODE)
SELECT
DER5.MKTNG_PGM_NBR,
DER5.REGIS_CNSMR_ID_VAL,
'Failed because of Age Validation' SYS_ERR_CODE
FROM
(
   SEL STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL, (CURRENT_DATE - CAST(BRTH_DATE AS DATE)) YEAR(4) AS age
FROM ICRM_STAGE.PRSNA_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
JOIN
AGE_MIN_MAX M
ON
STG.CNTRY_NAME = M.country
LEFT OUTER JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
C.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
C.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND STG.LOAD_ID = C.LOAD_ID
WHERE
(age >= M.MIN_AGE AND age < M.MAX_AGE
AND
(C.GUARDN_CNSNT_IND IN('N',NULL)
OR
C.GUARDN_NAME IS NULL))
OR
(CURRENT_DATE - CAST(BRTH_DATE AS DATE)) <= 0)DER5
;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO ERR_PRSNA_STG (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_ERR_CODE)
SELECT
DER5.MKTNG_PGM_NBR,
DER5.REGIS_CNSMR_ID_VAL,
'No valid contact point' SYS_ERR_CODE
FROM
(
SEL STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL
FROM ICRM_STAGE.PRSNA_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
 LEFT OUTER  JOIN ICRM_STAGE.PRSNA_EMAIL_ADDR_STG B1    
	ON	STG.MKTNG_PGM_NBR=B1.MKTNG_PGM_NBR   
	AND	STG.REGIS_CNSMR_ID_VAL=B1.REGIS_CNSMR_ID_VAL
	AND     STG.LOAD_ID=B1.LOAD_ID
	AND     STG.RECORD_IND=B1.RECORD_IND
 LEFT OUTER JOIN ICRM_STAGE.PRSNA_PHONE_STG C1    
	ON	STG.MKTNG_PGM_NBR=C1.MKTNG_PGM_NBR   
	AND	STG.REGIS_CNSMR_ID_VAL=C1.REGIS_CNSMR_ID_VAL
	AND     STG.LOAD_ID=C1.LOAD_ID
	AND     STG.RECORD_IND=C1.RECORD_IND
 LEFT OUTER JOIN ICRM_STAGE.PRSNA_POSTL_ADDR_STG D1    
	ON	STG.MKTNG_PGM_NBR=D1.MKTNG_PGM_NBR   
	AND	STG.REGIS_CNSMR_ID_VAL=D1.REGIS_CNSMR_ID_VAL		
	AND     STG.LOAD_ID=D1.LOAD_ID
	AND     STG.RECORD_IND=D1.RECORD_IND
WHERE B1.MKTNG_PGM_NBR IS NULL
AND C1.MKTNG_PGM_NBR IS NULL
AND D1.MKTNG_PGM_NBR IS NULL
) DER5
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;


COLLECT STATS ON ERR_PRSNA_STG
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
COLLECT STATS ON ERR_PRSNA_STG
COLUMN REGIS_CNSMR_ID_VAL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
COLLECT STATS ON ERR_PRSNA_STG
COLUMN (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;


/* UPDATE ERR_PRSNA_STG */

INSERT INTO ERR_PRSNA_STG
(MKTNG_PGM_NBR
,REGIS_CNSMR_ID_VAL
,USER_NAME
,PRSNA_REG_DT 
,NAME_PREFX_TXT
,GVN_NAME
,MID_NAME
,FAMLY_NAME 
,NAME_SUFFX_TXT
,FULL_NAME
,GENDR_IND
,BRTH_DATE
,LANG_CODE
,PRSNA_STTUS_CODE
,RECORD_IND 
,LOAD_ID 
,LOAD_TS 
,MDM_LOAD_IND
,SYS_SOURCE
,SYS_NC_TYPE
,SYS_ERROR_TIME
,SYS_ERR_CODE
,SYS_DOCUMENT
,CNTRY_CODE
)
SELECT DISTINCT
ERR1.MKTNG_PGM_NBR,
ERR1.REGIS_CNSMR_ID_VAL,
ERR1.USER_NAME,
CAST(CAST(ERR1.PRSNA_REG_DT AS VARCHAR(19)) AS TIMESTAMP(0)),
ERR1.NAME_PREFX_TXT,
ERR1.GVN_NAME,
ERR1.MID_NAME,
ERR1.FAMLY_NAME,
ERR1.NAME_SUFFX_TXT,
ERR1.FULL_NAME,
ERR1.GENDR_IND,
ERR1.BRTH_DATE,
ERR1.LANG_CODE,
ERR1.PRSNA_STTUS_CODE,
ERR1.RECORD_IND,
ERR1.LOAD_ID,
ERR1.LOAD_TS,
ERR1.MDM_LOAD_IND,
TRIM(CAST(ERR1.LOAD_ID AS INTEGER)),
CASE WHEN (ERR1.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
ERR1.LOAD_TS,
ERR.SYS_ERR_CODE,
ERR.SYS_DOCUMENT,
ERR1.CNTRY_NAME
FROM ICRM_STAGE.PRSNA_STG ERR1
INNER JOIN ERR_PRSNA_STG ERR
ON ERR.MKTNG_PGM_NBR = ERR1.MKTNG_PGM_NBR
AND ERR.REGIS_CNSMR_ID_VAL = ERR1.REGIS_CNSMR_ID_VAL
INNER JOIN MDM_LOAD_CONTROL1 LOAD
ON ERR1.LOAD_ID = LOAD.LOAD_ID
AND (ERR1.MKTNG_PGM_NBR,ERR1.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM ERR_PRSNA_STG WHERE SYS_NC_TYPE IS NULL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

COLLECT STATS ON ERR_PRSNA_STG
COLUMN MKTNG_PGM_NBR;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
COLLECT STATS ON ERR_PRSNA_STG
COLUMN REGIS_CNSMR_ID_VAL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
COLLECT STATS ON ERR_PRSNA_STG
COLUMN (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT	INTO ERR_PRSNA_EMAIL_ADDR_STG
(
MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
CNTCT_POINT_CATEG_CODE,
EMAIL_ADDR_TXT, 
EMAIL_FORMT_CODE, 
PREFR_IND, 
VALID_IND, 
RECORD_IND,
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND, 
CNTCT_OPTN_NBR,
CNTCT_OPTN_IND, 
CNSMR_CHCE_DATETM,
GUARDN_NAME, 
GUARDN_EMAIL_ADDR_TXT, 
GUARDN_CNSNT_IND, 
ACNLGMT_DATE,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_ERROR_TIME
)
SELECT	
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.CNTCT_POINT_CATEG_CODE, 
STG.EMAIL_ADDR_TXT,
STG.EMAIL_FORMT_CODE, 
STG.PREFR_IND, 
STG.VALID_IND, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND, 
C.CNTCT_OPTN_NBR, 
C.CNTCT_OPTN_IND,
CAST(CAST(C.CNSMR_CHCE_DATETM AS VARCHAR(19)) AS TIMESTAMP(0)), 
C.GUARDN_NAME, 
C.GUARDN_EMAIL_ADDR_TXT, 
C.GUARDN_CNSNT_IND, 
C.ACNLGMT_DATE,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM	
ICRM_STAGE.PRSNA_EMAIL_ADDR_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
STG.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
STG.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
INNER JOIN
ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE (C.CNTCT_POINT_TYPE_CODE='E'
OR (C.MKTNG_PGM_NBR IS NULL AND C.REGIS_CNSMR_ID_VAL
 IS NULL));
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT	INTO ERR_PRSNA_PHONE_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
CNTCT_POINT_CATEG_CODE,
PHONE_CNTRY_NBR, 
PHONE_AREA_NBR, 
PHONE_EXCHG_NBR, 
PHONE_LINE_NBR,
PHONE_EXTSN_NUM, 
FULL_PHONE_NUM, 
SMS_PREFR_IND, 
SMS_AVAIL_START_TIME,
SMS_AVAIL_END_TIME, 
PREFR_IND, 
VALID_IND, 
RECORD_IND, 
LOAD_ID,
LOAD_TS, 
MDM_LOAD_IND, 
CNTCT_OPTN_IND, 
CNTCT_OPTN_NBR, 
CNSMR_CHCE_DATETM,
GUARDN_NAME, 
GUARDN_EMAIL_ADDR_TXT, 
GUARDN_CNSNT_IND, 
ACNLGMT_DATE,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_ERROR_TIME)
SELECT	
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.CNTCT_POINT_CATEG_CODE, 
STG.PHONE_CNTRY_NBR,
STG.PHONE_AREA_NBR, 
STG.PHONE_EXCHG_NBR, 
STG.PHONE_LINE_NBR, 
STG.PHONE_EXTSN_NUM, 
STG.FULL_PHONE_NUM,
STG.SMS_PREFR_IND, 
CAST(CAST(STG.SMS_AVAIL_START_TIME AS VARCHAR(19)) AS TIMESTAMP(0)),
CAST(CAST(STG.SMS_AVAIL_END_TIME AS VARCHAR(19)) AS TIMESTAMP(0)),
STG.PREFR_IND, 
STG.VALID_IND, 
STG.RECORD_IND, 
STG.LOAD_ID,
STG.LOAD_TS, 
STG.MDM_LOAD_IND, 
C.CNTCT_OPTN_IND,
C.CNTCT_OPTN_NBR, 
CAST(CAST(C.CNSMR_CHCE_DATETM AS VARCHAR(19)) AS TIMESTAMP(0)), 
C.GUARDN_NAME, 
C.GUARDN_EMAIL_ADDR_TXT, 
C.GUARDN_CNSNT_IND, 
C.ACNLGMT_DATE,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM	
ICRM_STAGE.PRSNA_PHONE_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
STG.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
STG.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
INNER JOIN
ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE (C.CNTCT_POINT_TYPE_CODE='P'
OR (C.MKTNG_PGM_NBR IS NULL AND C.REGIS_CNSMR_ID_VAL
 IS NULL));
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT	INTO ERR_PRSNA_POSTL_ADDR_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
CNTCT_POINT_CATEG_CODE,
ADDR_LINE_1_TXT, 
ADDR_LINE_2_TXT, 
ADDR_LINE_3_TXT, 
STRET_NUM,
STRET_NAME, 
APT_NUM, 
PO_BOX_NUM, 
CITY_NAME, 
TERR_NAME, 
POSTL_AREA_CODE,
GEOC_AREA_TYPE_CODE, 
GEOC_AREA_NAME, 
CNTRY_NAME, 
PREFR_IND, 
VALID_IND, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
CNTCT_OPTN_IND,
CNTCT_OPTN_NBR, 
CNSMR_CHCE_DATETM, 
GUARDN_NAME, 
GUARDN_EMAIL_ADDR_TXT,
GUARDN_CNSNT_IND, 
ACNLGMT_DATE,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_ERROR_TIME)
SELECT	
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.CNTCT_POINT_CATEG_CODE, 
STG.ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT, 
STG.ADDR_LINE_3_TXT, 
STG.STRET_NUM, 
STG.STRET_NAME, 
STG.APT_NUM, 
STG.PO_BOX_NUM, 
STG.CITY_NAME, 
STG.TERR_NAME,
STG.POSTL_AREA_CODE, 
STG.GEOC_AREA_TYPE_CODE, 
STG.GEOC_AREA_NAME, 
STG.CNTRY_NAME, 
STG.PREFR_IND, 
STG.VALID_IND, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND, 
C.CNTCT_OPTN_IND,
C.CNTCT_OPTN_NBR, 
CAST(CAST(C.CNSMR_CHCE_DATETM AS VARCHAR(19)) AS TIMESTAMP(0)), 
C.GUARDN_NAME, 
C.GUARDN_EMAIL_ADDR_TXT, 
C.GUARDN_CNSNT_IND, 
C.ACNLGMT_DATE,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM	
ICRM_STAGE.PRSNA_POSTL_ADDR_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
STG.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
STG.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
INNER JOIN
ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE (C.CNTCT_POINT_TYPE_CODE='A'
OR (C.MKTNG_PGM_NBR IS NULL AND C.REGIS_CNSMR_ID_VAL
 IS NULL));
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT	INTO ERR_PRSNA_SOC_NETWK_ACCT_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
CNTCT_POINT_CATEG_CODE,   
SOCIAL_NETWK_ACCT_ID_VAL, 
PREFR_IND, 
VALID_IND, 
RECORD_IND, 
LOAD_ID, 		
LOAD_TS, 
MDM_LOAD_IND, 
CNTCT_OPTN_NBR, 
CNTCT_OPTN_IND, 
CNSMR_CHCE_DATETM, 		
GUARDN_NAME, 
GUARDN_EMAIL_ADDR_TXT, 
GUARDN_CNSNT_IND, 
ACNLGMT_DATE,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_ERROR_TIME)
SELECT	
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.CNTCT_POINT_CATEG_CODE, 
STG.SOCIAL_NETWK_ACCT_ID_VAL,    
STG.PREFR_IND, 
STG.VALID_IND, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND, 
C.CNTCT_OPTN_NBR, 
C.CNTCT_OPTN_IND,
CAST(CAST(C.CNSMR_CHCE_DATETM AS VARCHAR(19)) AS TIMESTAMP(0)), 
C.GUARDN_NAME, 
C.GUARDN_EMAIL_ADDR_TXT, 
C.GUARDN_CNSNT_IND, 
C.ACNLGMT_DATE,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM	
ICRM_STAGE.PRSNA_SOCIAL_NETWK_ACCT_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
STG.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
STG.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
INNER JOIN
ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE (C.CNTCT_POINT_TYPE_CODE='S'
OR (C.MKTNG_PGM_NBR IS NULL AND C.REGIS_CNSMR_ID_VAL
 IS NULL));

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;


INSERT INTO ERR_CNSMR_AFFLTN_STG
(
MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
CNSMR_GRP_NBR, 
AFFLTN_START_DATE, 
AFFLTN_END_DATE, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_ERROR_TIME
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.CNSMR_GRP_NBR, 
STG.AFFLTN_START_DATE, 
STG.AFFLTN_END_DATE, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.CNSMR_AFFLTN_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
INNER JOIN
ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;


INSERT INTO ERR_DPEND_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
DPEND_SEQ_NBR, 
DPEND_NAME, 
DPEND_GENDR_IND, 
DPEND_BRTH_DATE, 
DPEND_AGE_NBR, 
DPEND_TYPE_CODE, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_ERROR_TIME
)
SELECT
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.DPEND_SEQ_NBR, 
STG.DPEND_NAME, 
STG.DPEND_GENDR_IND, 
STG.DPEND_BRTH_DATE, 
STG.DPEND_AGE_NBR, 
STG.DPEND_TYPE_CODE, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.DPEND_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
INNER JOIN
ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO ERR_DPEND_TRT_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
DPEND_SEQ_NBR, 
TRT_NBR, 
DPEND_TRT_DATE, 
DPEND_TRT_INTEGER, 
DPEND_TRT_TXT,
DPEND_TRT_SEQ_NBR, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_ERROR_TIME
)
SELECT
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.DPEND_SEQ_NBR, 
STG.TRT_NBR, 
STG.DPEND_TRT_DATE, 
STG.DPEND_TRT_INTEGER, 
STG.DPEND_TRT_TXT,
STG.DPEND_TRT_SEQ_NBR, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.DPEND_TRT_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
INNER JOIN
ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO ERR_PET_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
PET_SEQ_NBR, 
PET_NAME, 
PET_GENDR_IND, 
PET_BRTH_DATE, 
PET_AGE_NBR, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_ERROR_TIME
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.PET_SEQ_NBR, 
STG.PET_NAME, 
STG.PET_GENDR_IND, 
STG.PET_BRTH_DATE,
STG.PET_AGE_NBR, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.PET_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
INNER JOIN
ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO ERR_PET_TRT_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
PET_SEQ_NBR, 
TRT_ID, 
PET_TRT_DATE, 
PET_TRT_INTEGRE, 
PET_TRT_TXT, 
PET_TRT_SEQ_NBR, 
RECORD_IND,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_ERROR_TIME
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.PET_SEQ_NBR, 
STG.TRT_ID, 
STG.PET_TRT_DATE, 
STG.PET_TRT_INTEGRE, 
STG.PET_TRT_TXT, 
STG.PET_TRT_SEQ_NBR, 
STG.RECORD_IND,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.PET_TRT_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
INNER JOIN
ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO ERR_PRSNA_TRT_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
TRT_NBR, 
PRSNA_TRT_SEQ_NBR, 
PRSNA_TRT_DATE, 
PRSNA_TRT_INTEGER,
PRSNA_TRT_TXT, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_ERROR_TIME
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.TRT_NBR, 
STG.PRSNA_TRT_SEQ_NBR, 
STG.PRSNA_TRT_DATE,  
STG.PRSNA_TRT_INTEGER, 
STG.PRSNA_TRT_TXT, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.PRSNA_TRT_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
INNER JOIN
ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

/* INSERT INTO MST STAGE */

INSERT INTO CNSMR_AFFLTN_STG
(
MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
CNSMR_GRP_NBR, 
AFFLTN_START_DATE, 
AFFLTN_END_DATE, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.CNSMR_GRP_NBR, 
STG.AFFLTN_START_DATE, 
STG.AFFLTN_END_DATE, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.CNSMR_AFFLTN_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE ERR.MKTNG_PGM_NBR IS NULL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO DPEND_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
DPEND_SEQ_NBR, 
DPEND_NAME, 
DPEND_GENDR_IND, 
DPEND_BRTH_DATE, 
DPEND_AGE_NBR, 
DPEND_TYPE_CODE, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE
)
SELECT
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.DPEND_SEQ_NBR, 
STG.DPEND_NAME, 
STG.DPEND_GENDR_IND, 
STG.DPEND_BRTH_DATE, 
STG.DPEND_AGE_NBR, 
STG.DPEND_TYPE_CODE, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.DPEND_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE ERR.MKTNG_PGM_NBR IS NULL
AND EXTRACT(YEAR FROM STG.DPEND_BRTH_DATE) <> 1900;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO DPEND_TRT_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
DPEND_SEQ_NBR, 
TRT_NBR, 
DPEND_TRT_DATE, 
DPEND_TRT_INTEGER, 
DPEND_TRT_TXT,
DPEND_TRT_SEQ_NBR, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE
)
SELECT
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.DPEND_SEQ_NBR, 
STG.TRT_NBR, 
STG.DPEND_TRT_DATE, 
STG.DPEND_TRT_INTEGER, 
STG.DPEND_TRT_TXT,
STG.DPEND_TRT_SEQ_NBR, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND ,
'VALIDATED',
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.DPEND_TRT_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE ERR.MKTNG_PGM_NBR IS NULL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO PET_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
PET_SEQ_NBR, 
PET_NAME, 
PET_GENDR_IND, 
PET_BRTH_DATE, 
PET_AGE_NBR, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.PET_SEQ_NBR, 
STG.PET_NAME, 
STG.PET_GENDR_IND, 
STG.PET_BRTH_DATE,
STG.PET_AGE_NBR, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.PET_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE ERR.MKTNG_PGM_NBR IS NULL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO PET_TRT_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
PET_SEQ_NBR, 
TRT_ID, 
PET_TRT_DATE, 
PET_TRT_INTEGRE, 
PET_TRT_TXT, 
PET_TRT_SEQ_NBR, 
RECORD_IND,
SYNC_STATUS
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.PET_SEQ_NBR, 
STG.TRT_ID, 
STG.PET_TRT_DATE, 
STG.PET_TRT_INTEGRE, 
STG.PET_TRT_TXT, 
STG.PET_TRT_SEQ_NBR, 
STG.RECORD_IND,
'VALIDATED'
FROM ICRM_STAGE.PET_TRT_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE ERR.MKTNG_PGM_NBR IS NULL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT	INTO PRSNA_EMAIL_ADDR_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
CNTCT_POINT_CATEG_CODE,
EMAIL_ADDR_TXT, 
EMAIL_FORMT_CODE, 
PREFR_IND, 
VALID_IND, 
RECORD_IND,
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
CNTCT_OPTN_NBR,
CNTCT_OPTN_IND, 
CNSMR_CHCE_DATETM,
GUARDN_NAME, 
GUARDN_EMAIL_ADDR_TXT, 
GUARDN_CNSNT_IND, 
ACNLGMT_DATE,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE )
SELECT	
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.CNTCT_POINT_CATEG_CODE, 
STG.EMAIL_ADDR_TXT,
STG.EMAIL_FORMT_CODE, 
STG.PREFR_IND, 
STG.VALID_IND, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
C.CNTCT_OPTN_NBR, 
C.CNTCT_OPTN_IND,
CAST(CAST(C.CNSMR_CHCE_DATETM AS VARCHAR(19)) AS TIMESTAMP(0)), 
C.GUARDN_NAME, 
C.GUARDN_EMAIL_ADDR_TXT, 
C.GUARDN_CNSNT_IND, 
C.ACNLGMT_DATE,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM	
ICRM_STAGE.PRSNA_EMAIL_ADDR_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
STG.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
STG.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
AND
STG.LOAD_ID = C.LOAD_ID
AND
STG.RECORD_IND = C.RECORD_IND
LEFT OUTER JOIN ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE ERR.MKTNG_PGM_NBR IS NULL
AND (C.CNTCT_POINT_TYPE_CODE IN (sel AV_CODE  from ATTRIBUTE_VALUES B
WHERE B.AV_DESCRIPTION='Email Address')
OR (C.MKTNG_PGM_NBR IS NULL AND C.REGIS_CNSMR_ID_VAL
 IS NULL));
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO PRSNA_PHONE_STG
(MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
PHONE_CNTRY_NBR,
PHONE_AREA_NBR,
PHONE_EXCHG_NBR,
PHONE_LINE_NBR,
PHONE_EXTSN_NUM,
FULL_PHONE_NUM,
SMS_PREFR_IND,
SMS_AVAIL_START_TIME,
SMS_AVAIL_END_TIME,
PREFR_IND,
VALID_IND,
RECORD_IND,
LOAD_ID,
LOAD_TS,
MDM_LOAD_IND,
SYNC_STATUS,
CNTCT_OPTN_IND,
CNTCT_OPTN_NBR,
CNSMR_CHCE_DATETM,
GUARDN_NAME,
GUARDN_EMAIL_ADDR_TXT,
GUARDN_CNSNT_IND,
ACNLGMT_DATE,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE )
SELECT
STG.MKTNG_PGM_NBR,
STG.REGIS_CNSMR_ID_VAL,
STG.CNTCT_POINT_CATEG_CODE,
STG.PHONE_CNTRY_NBR,
STG.PHONE_AREA_NBR,
STG.PHONE_EXCHG_NBR,
STG.PHONE_LINE_NBR,
STG.PHONE_EXTSN_NUM,
STG.FULL_PHONE_NUM,
STG.SMS_PREFR_IND,
CAST(CAST(STG.SMS_AVAIL_START_TIME AS VARCHAR(19)) AS TIMESTAMP(0)),
CAST(CAST(STG.SMS_AVAIL_END_TIME AS VARCHAR(19)) AS TIMESTAMP(0)),
STG.PREFR_IND,
STG.VALID_IND,
STG.RECORD_IND,
STG.LOAD_ID,
STG.LOAD_TS,
STG.MDM_LOAD_IND,
'VALIDATED',
C.CNTCT_OPTN_IND,
C.CNTCT_OPTN_NBR,
CAST(CAST(C.CNSMR_CHCE_DATETM AS VARCHAR(19)) AS TIMESTAMP(0)),
C.GUARDN_NAME,
C.GUARDN_EMAIL_ADDR_TXT,
C.GUARDN_CNSNT_IND,
C.ACNLGMT_DATE,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM
ICRM_STAGE.PRSNA_PHONE_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER  JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
STG.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
STG.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
AND
STG.LOAD_ID = C.LOAD_ID
AND
STG.RECORD_IND = C.RECORD_IND
LEFT OUTER JOIN ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE ERR.MKTNG_PGM_NBR IS NULL
AND (C.CNTCT_POINT_TYPE_CODE IN (sel AV_CODE  from ATTRIBUTE_VALUES B
WHERE B.AV_DESCRIPTION='Telephone Number')
OR (C.MKTNG_PGM_NBR IS NULL AND C.REGIS_CNSMR_ID_VAL
 IS NULL));

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO PRSNA_POSTL_ADDR_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
CNTCT_POINT_CATEG_CODE,
ADDR_LINE_1_TXT, 
ADDR_LINE_2_TXT, 
ADDR_LINE_3_TXT, 
STRET_NUM,
STRET_NAME, 
APT_NUM, 
PO_BOX_NUM, 
CITY_NAME, 
TERR_NAME, 
POSTL_AREA_CODE,
GEOC_AREA_TYPE_CODE, 
GEOC_AREA_NAME, 
CNTRY_NAME, 
PREFR_IND, 
VALID_IND, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,	
CNTCT_OPTN_IND,
CNTCT_OPTN_NBR, 
CNSMR_CHCE_DATETM, 
GUARDN_NAME, 
GUARDN_EMAIL_ADDR_TXT,
GUARDN_CNSNT_IND, 
ACNLGMT_DATE,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE )
SELECT
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.CNTCT_POINT_CATEG_CODE, 
STG.ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT, 
STG.ADDR_LINE_3_TXT, 
STG.STRET_NUM, 
STG.STRET_NAME, 
STG.APT_NUM, 
STG.PO_BOX_NUM, 
STG.CITY_NAME, 
STG.TERR_NAME,
STG.POSTL_AREA_CODE, 
STG.GEOC_AREA_TYPE_CODE, 
STG.GEOC_AREA_NAME, 
STG.CNTRY_NAME, 
STG.PREFR_IND, 
STG.VALID_IND, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
C.CNTCT_OPTN_IND,
C.CNTCT_OPTN_NBR, 
CAST(CAST(C.CNSMR_CHCE_DATETM AS VARCHAR(19)) AS TIMESTAMP(0)), 
C.GUARDN_NAME, 
C.GUARDN_EMAIL_ADDR_TXT, 
C.GUARDN_CNSNT_IND,
C.ACNLGMT_DATE,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM	
ICRM_STAGE.PRSNA_POSTL_ADDR_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN 
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
STG.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
STG.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
AND
STG.LOAD_ID = C.LOAD_ID
AND
STG.RECORD_IND = C.RECORD_IND
LEFT OUTER JOIN ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE ERR.MKTNG_PGM_NBR IS NULL
AND (C.CNTCT_POINT_TYPE_CODE IN (sel AV_CODE  from ATTRIBUTE_VALUES B
WHERE B.AV_DESCRIPTION='Postal Address')
OR (C.MKTNG_PGM_NBR IS NULL AND C.REGIS_CNSMR_ID_VAL
 IS NULL));

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO PRSNA_SOC_NETWK_ACCT_STG	
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
CNTCT_POINT_CATEG_CODE,   
SOCIAL_NETWK_ACCT_ID_VAL, 
PREFR_IND, 
VALID_IND, 
RECORD_IND, 
LOAD_ID, 		
LOAD_TS, 
MDM_LOAD_IND, 
SYNC_STATUS,
CNTCT_OPTN_NBR, 
CNTCT_OPTN_IND, 
CNSMR_CHCE_DATETM, 		
GUARDN_NAME, 
GUARDN_EMAIL_ADDR_TXT, 
GUARDN_CNSNT_IND, 
ACNLGMT_DATE,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE )
SELECT  
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.CNTCT_POINT_CATEG_CODE, 
STG.SOCIAL_NETWK_ACCT_ID_VAL,    
STG.PREFR_IND, 
STG.VALID_IND, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND, 
'VALIDATED',
C.CNTCT_OPTN_NBR, 
C.CNTCT_OPTN_IND,
CAST(CAST(C.CNSMR_CHCE_DATETM AS VARCHAR(19)) AS TIMESTAMP(0)),   
C.GUARDN_NAME, 
C.GUARDN_EMAIL_ADDR_TXT, 
C.GUARDN_CNSNT_IND, 
C.ACNLGMT_DATE,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM	
ICRM_STAGE.PRSNA_SOCIAL_NETWK_ACCT_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN 
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
STG.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
STG.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
AND
STG.LOAD_ID = C.LOAD_ID
AND
STG.RECORD_IND = C.RECORD_IND
LEFT OUTER JOIN ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE ERR.MKTNG_PGM_NBR IS NULL
AND (C.CNTCT_POINT_TYPE_CODE IN (sel AV_CODE  from ATTRIBUTE_VALUES B
WHERE B.AV_DESCRIPTION='Social Network Account')
OR (C.MKTNG_PGM_NBR IS NULL AND C.REGIS_CNSMR_ID_VAL
 IS NULL));

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO PRSNA_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
USER_NAME, 
PRSNA_REG_DT, 
NAME_PREFX_TXT, 
GVN_NAME, 
MID_NAME, 
FAMLY_NAME, 
NAME_SUFFX_TXT, 
FULL_NAME, 
GENDR_IND, 
BRTH_DATE, 
LANG_CODE, 
PRSNA_STTUS_CODE, 
RECORD_IND,  
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE,
CNTRY_CODE
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.USER_NAME, 
CAST(CAST(STG.PRSNA_REG_DT AS VARCHAR(19)) AS TIMESTAMP(0)), 
STG.NAME_PREFX_TXT, 
STG.GVN_NAME, 
STG.MID_NAME, 
STG.FAMLY_NAME, 
STG.NAME_SUFFX_TXT, 
STG.FULL_NAME, 
STG.GENDR_IND, 
STG.BRTH_DATE, 
STG.LANG_CODE, 
STG.PRSNA_STTUS_CODE, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS,
STG.CNTRY_NAME
FROM ICRM_STAGE.PRSNA_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE ERR.MKTNG_PGM_NBR IS NULL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO PRSNA_TRT_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
TRT_NBR, 
PRSNA_TRT_SEQ_NBR, 
PRSNA_TRT_DATE, 
PRSNA_TRT_INTEGER,
PRSNA_TRT_TXT, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.TRT_NBR, 
STG.PRSNA_TRT_SEQ_NBR, 
STG.PRSNA_TRT_DATE,  
STG.PRSNA_TRT_INTEGER, 
STG.PRSNA_TRT_TXT, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
TRIM(CAST(STG.LOAD_ID AS INTEGER))D,
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.PRSNA_TRT_STG STG
INNER JOIN
MDM_LOAD_CONTROL1 LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
AND (STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL) IN 
(SEL MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
FROM TSS_LOAD_PRCS
GROUP BY 1,2
)
LEFT OUTER JOIN ERR_PRSNA_STG_VIEW1 ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
WHERE ERR.MKTNG_PGM_NBR IS NULL
;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT; 

COLLECT STATS ON ERR_PRSNA_STG COLUMN(MKTNG_PGM_NBR);
COLLECT STATS ON ERR_PRSNA_STG COLUMN(REGIS_CNSMR_ID_VAL);
COLLECT STATS ON ERR_PRSNA_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
COLLECT STATS ON ERR_PRSNA_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LOAD_ID);
COLLECT STATS ON ERR_PRSNA_STG COLUMN(MKTNG_PGM_NBR,LOAD_ID);
COLLECT STATS ON ERR_PRSNA_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LOAD_ID,SYS_ERR_CODE);
COLLECT STATS ON CNSMR_AFFLTN_STG COLUMN(MKTNG_PGM_NBR);
COLLECT STATS ON CNSMR_AFFLTN_STG COLUMN(REGIS_CNSMR_ID_VAL);
COLLECT STATS ON CNSMR_AFFLTN_STG COLUMN(CNSMR_GRP_NBR);
COLLECT STATS ON CNSMR_AFFLTN_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
COLLECT STATS ON DPEND_STG COLUMN(MKTNG_PGM_NBR);
COLLECT STATS ON DPEND_STG COLUMN(REGIS_CNSMR_ID_VAL);
COLLECT STATS ON DPEND_STG COLUMN(DPEND_NAME);
COLLECT STATS ON DPEND_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
COLLECT STATS ON DPEND_STG COLUMN(DPEND_SEQ_NBR,DPEND_NAME,DPEND_GENDR_IND,DPEND_BRTH_DATE,DPEND_AGE_NBR,DPEND_TYPE_CODE,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON DPEND_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE,SYS_NC_TYPE);
COLLECT STATS ON DPEND_TRT_STG COLUMN(MKTNG_PGM_NBR);
COLLECT STATS ON DPEND_TRT_STG COLUMN(REGIS_CNSMR_ID_VAL);
COLLECT STATS ON DPEND_TRT_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
COLLECT STATS ON DPEND_TRT_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE);
COLLECT STATS ON DPEND_TRT_STG COLUMN(DPEND_SEQ_NBR,TRT_NBR,DPEND_TRT_DATE,DPEND_TRT_TXT,DPEND_TRT_SEQ_NBR,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON DPEND_TRT_STG COLUMN(DPEND_SEQ_NBR,TRT_NBR,DPEND_TRT_SEQ_NBR);
COLLECT STATS ON PET_STG COLUMN(MKTNG_PGM_NBR);
COLLECT STATS ON PET_STG COLUMN(REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PET_STG COLUMN(PET_NAME);
COLLECT STATS ON PET_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PET_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE);
COLLECT STATS ON PET_STG COLUMN(PET_SEQ_NBR,PET_NAME,PET_GENDR_IND,PET_BRTH_DATE,PET_AGE_NBR,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON PET_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE,SYS_NC_TYPE);
COLLECT STATS ON PET_TRT_STG COLUMN(MKTNG_PGM_NBR);
COLLECT STATS ON PET_TRT_STG COLUMN(REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PET_TRT_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PET_TRT_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE);
COLLECT STATS ON PET_TRT_STG COLUMN(PET_SEQ_NBR,TRT_ID,PET_TRT_DATE,PET_TRT_TXT,PET_TRT_SEQ_NBR,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON PET_TRT_STG COLUMN(PET_SEQ_NBR,TRT_ID,PET_TRT_SEQ_NBR);
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(MKTNG_PGM_NBR);
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(CNTCT_POINT_CATEG_CODE);
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(EMAIL_ADDR_TXT);
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(CNTCT_OPTN_NBR);
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(SYS_SOURCE);
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(SYS_NC_TYPE);
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,EMAIL_ADDR_TXT,SYS_SOURCE);
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE);
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(CNTCT_POINT_CATEG_CODE,EMAIL_FORMT_CODE,CNTCT_OPTN_NBR,CNTCT_OPTN_IND,PREFR_IND,VALID_IND,CNSMR_CHCE_DATETM,GUARDN_NAME,GUARDN_EMAIL_ADDR_TXT,GUARDN_CNSNT_IND,ACNLGMT_DATE,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,EMAIL_ADDR_TXT,SYS_SOURCE,SYS_NC_TYPE);
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE,SYS_NC_TYPE);
COLLECT STATS ON PRSNA_PHONE_STG COLUMN(MKTNG_PGM_NBR);
COLLECT STATS ON PRSNA_PHONE_STG COLUMN(REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PRSNA_PHONE_STG COLUMN(FULL_PHONE_NUM);
COLLECT STATS ON PRSNA_PHONE_STG COLUMN(CNTCT_OPTN_NBR);
COLLECT STATS ON PRSNA_PHONE_STG COLUMN(SYS_SOURCE);
COLLECT STATS ON PRSNA_PHONE_STG COLUMN(SYS_NC_TYPE);
COLLECT STATS ON PRSNA_PHONE_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PRSNA_PHONE_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE);
COLLECT STATS ON PRSNA_PHONE_STG COLUMN(CNTCT_POINT_CATEG_CODE,PHONE_CNTRY_NBR,PHONE_AREA_NBR,PHONE_EXCHG_NBR,PHONE_LINE_NBR,PHONE_EXTSN_NUM,SMS_PREFR_IND,SMS_AVAIL_START_TIME,SMS_AVAIL_END_TIME,CNTCT_OPTN_IND,PREFR_IND,VALID_IND,CNTCT_OPTN_NBR,CNSMR_CHCE_DATETM,GUARDN_NAME,GUARDN_EMAIL_ADDR_TXT,GUARDN_CNSNT_IND,ACNLGMT_DATE,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON PRSNA_PHONE_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,FULL_PHONE_NUM,SYS_SOURCE,SYS_NC_TYPE);
COLLECT STATS ON PRSNA_PHONE_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE,SYS_NC_TYPE);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(MKTNG_PGM_NBR);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(CNTCT_POINT_CATEG_CODE);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(CNTCT_OPTN_NBR);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(SYS_SOURCE);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(SYS_NC_TYPE);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,CNTCT_POINT_CATEG_CODE,CNTCT_OPTN_NBR);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(CNTCT_POINT_CATEG_CODE,PREFR_IND,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(CNTCT_POINT_CATEG_CODE,ADDR_LINE_1_TXT,ADDR_LINE_2_TXT,ADDR_LINE_3_TXT,STRET_NUM,STRET_NAME,APT_NUM,PO_BOX_NUM,CITY_NAME,POSTL_AREA_CODE,PREFR_IND,VALID_IND,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(CNTCT_POINT_CATEG_CODE,CNTCT_OPTN_IND,PREFR_IND,CNTCT_OPTN_NBR,CNSMR_CHCE_DATETM,GUARDN_NAME,GUARDN_EMAIL_ADDR_TXT,GUARDN_CNSNT_IND,ACNLGMT_DATE,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(CNTCT_POINT_CATEG_CODE,ADDR_LINE_1_TXT,ADDR_LINE_2_TXT,ADDR_LINE_3_TXT,STRET_NUM,STRET_NAME,APT_NUM,PO_BOX_NUM,CITY_NAME,POSTL_AREA_CODE,CNTCT_OPTN_IND,PREFR_IND,VALID_IND,CNTCT_OPTN_NBR,CNSMR_CHCE_DATETM,GUARDN_NAME,GUARDN_EMAIL_ADDR_TXT,GUARDN_CNSNT_IND,ACNLGMT_DATE,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE,SYS_NC_TYPE);
COLLECT STATS ON PRSNA_SOC_NETWK_ACCT_STG COLUMN(MKTNG_PGM_NBR);
COLLECT STATS ON PRSNA_SOC_NETWK_ACCT_STG COLUMN(REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PRSNA_SOC_NETWK_ACCT_STG COLUMN(CNTCT_POINT_CATEG_CODE);
COLLECT STATS ON PRSNA_SOC_NETWK_ACCT_STG COLUMN(SOCIAL_NETWK_ACCT_ID_VAL);
COLLECT STATS ON PRSNA_SOC_NETWK_ACCT_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PRSNA_SOC_NETWK_ACCT_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE);
COLLECT STATS ON PRSNA_SOC_NETWK_ACCT_STG COLUMN(CNTCT_POINT_CATEG_CODE,SOCIAL_NETWK_ACCT_ID_VAL,PREFR_IND,VALID_IND,CNTCT_OPTN_NBR,CNTCT_OPTN_IND,CNSMR_CHCE_DATETM,GUARDN_NAME,GUARDN_EMAIL_ADDR_TXT,GUARDN_CNSNT_IND,ACNLGMT_DATE,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON PRSNA_STG COLUMN(MKTNG_PGM_NBR);
COLLECT STATS ON PRSNA_STG COLUMN(REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PRSNA_STG COLUMN(SYNC_STATUS);
COLLECT STATS ON PRSNA_STG COLUMN(SYS_SOURCE);
COLLECT STATS ON PRSNA_STG COLUMN(SYS_NC_TYPE);
COLLECT STATS ON PRSNA_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PRSNA_STG COLUMN(PRSNA_REG_DT,FULL_NAME,GENDR_IND);
COLLECT STATS ON PRSNA_STG COLUMN(REGIS_CNSMR_ID_VAL,RECORD_IND,LOAD_ID,LOAD_TS);
COLLECT STATS ON PRSNA_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE,SYS_NC_TYPE);
COLLECT STATS ON PRSNA_TRT_STG COLUMN(MKTNG_PGM_NBR);
COLLECT STATS ON PRSNA_TRT_STG COLUMN(REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PRSNA_TRT_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);
COLLECT STATS ON PRSNA_TRT_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE);
COLLECT STATS ON PRSNA_TRT_STG COLUMN(TRT_NBR,PRSNA_TRT_SEQ_NBR,PRSNA_TRT_DATE,PRSNA_TRT_TXT,SYS_TARGET_ID,SYS_AUTH_ID,SYS_SOURCE,SYS_CREATED_BY,SYS_ENT_STATE,SYS_LAST_MODIFIED_BY,SYS_NC_TYPE,SYS_ERR_CODE,SYS_ERR_SVRTY);
COLLECT STATS ON PRSNA_TRT_STG COLUMN(TRT_NBR,PRSNA_TRT_SEQ_NBR);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PRSNA_STG SET GENDR_IND='U'
WHERE GENDR_IND NOT IN ('F','U','M')
OR GENDR_IND IS NULL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
UPDATE PRSNA_POSTL_ADDR_STG SET PREFR_IND ='Y' 
WHERE PREFR_IND NOT IN ('N','Y')
OR PREFR_IND IS NULL; 
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
UPDATE PRSNA_POSTL_ADDR_STG SET VALID_IND ='Y' 
WHERE VALID_IND NOT IN ('N','Y')
OR VALID_IND IS NULL; 
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
UPDATE PRSNA_EMAIL_ADDR_STG SET PREFR_IND ='Y' 
WHERE PREFR_IND NOT IN ('N','Y')
OR PREFR_IND IS NULL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
UPDATE PRSNA_EMAIL_ADDR_STG SET VALID_IND ='Y' 
WHERE VALID_IND NOT IN ('N','Y')
OR VALID_IND IS NULL; 
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
UPDATE PRSNA_PHONE_STG SET PREFR_IND ='Y' 
WHERE PREFR_IND NOT IN ('N','Y')
OR PREFR_IND IS NULL; 
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
UPDATE PRSNA_PHONE_STG SET VALID_IND ='Y' 
WHERE VALID_IND NOT IN ('N','Y')
OR VALID_IND IS NULL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM TSS_ERR_PRCS ALL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

 INSERT INTO TSS_ERR_PRCS
(
LEGAL_ENT_NBR,
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
SYS_SOURCE
)
SELECT
B.LEGAL_ENT_NBR,
A.MKTNG_PGM_NBR,
A.REGIS_CNSMR_ID_VAL,
TRIM(A.SYS_SOURCE)
FROM
PRSNA_STG A
INNER JOIN MKTNG_PGM B
ON A.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
QUALIFY RANK() OVER (PARTITION BY A.MKTNG_PGM_NBR,
A.REGIS_CNSMR_ID_VAL ORDER BY A.SYS_SOURCE DESC) = 1
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
/*
 INSERT INTO TSS_ERR_PRCS
(
LEGAL_ENT_NBR,
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
SYS_SOURCE,
REGIS_PRSNA_ID,
HSHLD_PRSNA_ID,
MATCHD_CNSMR_PRSNA_ID
)
SELECT
A.LEGAL_ENT_NBR,
A.MKTNG_PGM_NBR,
A.REGIS_CNSMR_ID_VAL,
TRIM(A.SYS_SOURCE),
B.REGIS_PRSNA_ID,
C.HSHLD_PRSNA_ID,
B.MATCHD_CNSMR_PRSNA_ID
FROM
(SELECT 
LEGAL_ENT_NBR,
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
SYS_SOURCE,
SYS_NC_TYPE
FROM
CNSMR_TSS_CLEANSE_INPUT1
GROUP BY 1,2,3,4,5
MINUS
SELECT 
LEGAL_ENT_NBR,
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
SYS_SOURCE,
SYS_NC_TYPE
FROM
TRILLIUM_OUTPUT1
GROUP BY 1,2,3,4,5
) A
LEFT OUTER JOIN REGIS_PRSNA B
ON A.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND A.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND A.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
AND B.PRSNA_STATUS_CODE = 'AC'
LEFT OUTER JOIN MATCHD_CNSMR_PRSNA C
ON B.MATCHD_CNSMR_PRSNA_ID = C.MATCHD_CNSMR_PRSNA_ID
AND C.PRSNA_STATUS_CODE = 'AC'
GROUP BY 1,2,3,4,5,6,7;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
*/

COLLECT STATS TSS_ERR_PRCS
COLUMN (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
DEL FROM TRILLIUM_MDM_REFERENCE ALL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT TRILLIUM_MDM_REFERENCE 
(
 LEGAL_ENT_NBR
,MKTNG_PGM_NBR                 
,REGIS_CNSMR_ID_VAL            
,NEW_HOUSEHOLD_ID              
,NEW_LEGAL_ENTITY_KEY          
,NEW_REGISTRATION_KEY  
,SYS_SOURCE
,REFERENCE_HOUSEHOLD_ID        
,REFERENCE_LEGALENTITYKEY 
,REFERENCE_REGISTRATIONKEY  
)
SELECT
 LEGAL_ENT_NBR
,MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL            
,CASE WHEN A.HSHLD_PRSNA_ID IS NULL
      THEN TRIM(D.HSHLD_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL))
      ELSE A.HSHLD_PRSNA_ID
  END
,CASE WHEN A.MATCHD_CNSMR_PRSNA_ID IS NULL
      THEN TRIM(C.MATCHD_CNSMR_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL))
      ELSE A.MATCHD_CNSMR_PRSNA_ID
  END         
,CASE WHEN A.REGIS_PRSNA_ID IS NULL
      THEN TRIM(B.REGIS_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL))
      ELSE A.REGIS_PRSNA_ID
  END   
,SYS_SOURCE  
,CASE WHEN A.HSHLD_PRSNA_ID IS NULL
      THEN TRIM(D.HSHLD_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL))
      ELSE A.HSHLD_PRSNA_ID
  END
,CASE WHEN A.MATCHD_CNSMR_PRSNA_ID IS NULL
      THEN TRIM(C.MATCHD_CNSMR_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL))
      ELSE A.MATCHD_CNSMR_PRSNA_ID
  END         
,CASE WHEN A.REGIS_PRSNA_ID IS NULL
      THEN TRIM(B.REGIS_PRSNA_ID + RANK() OVER (PARTITION BY 1 ORDER BY MKTNG_PGM_NBR                  
,REGIS_CNSMR_ID_VAL))
      ELSE A.REGIS_PRSNA_ID
  END
FROM
TSS_ERR_PRCS A
INNER JOIN (SEL COALESCE(MAX(REGIS_PRSNA_ID),0) AS REGIS_PRSNA_ID
FROM REGIS_PRSNA) B
ON 1=1
INNER JOIN (SEL COALESCE(MAX(MATCHD_CNSMR_PRSNA_ID),0) AS MATCHD_CNSMR_PRSNA_ID
FROM MATCHD_CNSMR_PRSNA) C
ON 1=1
INNER JOIN (SEL COALESCE(MAX(HSHLD_PRSNA_ID),0) AS HSHLD_PRSNA_ID
FROM HSHLD_PRSNA) D
ON 1=1
WHERE A.REGIS_PRSNA_ID IS NULL
OR A.MATCHD_CNSMR_PRSNA_ID IS NULL
OR A.HSHLD_PRSNA_ID IS NULL
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

COLLECT STATS ON TRILLIUM_MDM_REFERENCE
COLUMN (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LEGAL_ENT_NBR,SYS_SOURCE);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;


UPDATE TSS_ERR_PRCS
FROM 
(SELECT MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
LEGAL_ENT_NBR,
SYS_SOURCE,
TRIM(MIN(NEW_HOUSEHOLD_ID)) NEW_HOUSEHOLD_ID,
TRIM(MIN(NEW_LEGAL_ENTITY_KEY)) NEW_LEGAL_ENTITY_KEY,
TRIM(MIN(NEW_REGISTRATION_KEY)) NEW_REGISTRATION_KEY
FROM
TRILLIUM_MDM_REFERENCE
GROUP BY 1,2,3,4
) B
SET HSHLD_PRSNA_ID = B.NEW_HOUSEHOLD_ID
,MATCHD_CNSMR_PRSNA_ID = B.NEW_LEGAL_ENTITY_KEY
,REGIS_PRSNA_ID = B.NEW_REGISTRATION_KEY
WHERE TSS_ERR_PRCS.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND TSS_ERR_PRCS.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
AND TSS_ERR_PRCS.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND TSS_ERR_PRCS.SYS_SOURCE = B.SYS_SOURCE
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS CNSMR_AFFLTN 
(
CNSMR_GRP_NBR                         ,
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
AFFLTN_START_DATE             ,
AFFLTN_END_DATE               ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT DISTINCT
A.CNSMR_GRP_NBR                         ,
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.AFFLTN_START_DATE             ,
A.AFFLTN_END_DATE             ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)),
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)),
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM CNSMR_AFFLTN_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE (B.REGIS_PRSNA_ID,A.CNSMR_GRP_NBR) NOT IN
(SEL REGIS_PRSNA_ID,CNSMR_GRP_NBR
FROM CNSMR_AFFLTN
GROUP BY 1,2
)
QUALIFY RANK() OVER(PARTITION BY B.REGIS_PRSNA_ID,A.CNSMR_GRP_NBR
ORDER BY A.SYS_NC_TYPE DESC, A.SYS_SOURCE DESC  ) = 1
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO HSHLD_PRSNA  
(HSHLD_PRSNA_ID
,LEGAL_ENT_NBR
,PRSNA_STATUS_CODE
,SYS_SOURCE
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
) 
SELECT *
FROM
(SELECT
HSHLD_PRSNA_ID
,LEGAL_ENT_NBR
,'ACTIVATED' PRSNA_STATUS_CODE
,SYS_SOURCE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
FROM
TSS_ERR_PRCS
WHERE HSHLD_PRSNA_ID NOT IN (SELECT TRIM(HSHLD_PRSNA_ID)
FROM HSHLD_PRSNA GROUP BY 1)
) A
GROUP BY 1,2,3,4,5,6
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO MATCHD_CNSMR_PRSNA  
(MATCHD_CNSMR_PRSNA_ID
,LEGAL_ENT_NBR
,HSHLD_PRSNA_ID
,HEAD_OF_HSHLD_IND
,UNIVERSAL_OPT_OUT
,NAME_PREFX_TXT
,GVN_NAME
,MID_NAME
,FAMLY_NAME
,NAME_SUFFX_TXT
,FULL_NAME
,GENDR_IND
,BRTH_DATE
,NOTE_TXT
,LATST_ACTVY_DATE
,PRSNA_STATUS_CODE
,CNSMR_USER_NAME
,LANG_CODE
,REGIS_DATE
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE                                                                  
,SYS_ERR_SVRTY) 
SELECT *
FROM
(SELECT
TOUT.MATCHD_CNSMR_PRSNA_ID
,TOUT.LEGAL_ENT_NBR
,TOUT.HSHLD_PRSNA_ID
,CASE WHEN RANK() OVER (PARTITION BY TOUT.HSHLD_PRSNA_ID ORDER BY TOUT.HSHLD_PRSNA_ID,TOUT.MATCHD_CNSMR_PRSNA_ID) = 1
           AND A.HSHLD_PRSNA_ID IS NULL
      THEN 'Y'
      ELSE 'N'
  END AS HEAD_OF_HSHLD_IND
,'' AS UNIVERSAL_OPT_OUT
,STG.NAME_PREFX_TXT
,STG.GVN_NAME
,STG.MID_NAME
,STG.FAMLY_NAME
,STG.NAME_SUFFX_TXT
,STG.FULL_NAME
,STG.GENDR_IND
,STG.BRTH_DATE
,'' AS NOTE_TXT
,STG.PRSNA_REG_DT LATST_ACTVY_DATE
,'ACTIVATED' AS PRSNA_STATUS_CODE
,STG.USER_NAME
,STG.LANG_CODE
,STG.PRSNA_REG_DT
,TOUT.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE                                                                  
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND TOUT.MATCHD_CNSMR_PRSNA_ID NOT IN (SELECT TRIM(MATCHD_CNSMR_PRSNA_ID)
FROM MATCHD_CNSMR_PRSNA GROUP BY 1)
LEFT OUTER JOIN (SELECT TRIM(HSHLD_PRSNA_ID) AS HSHLD_PRSNA_ID
FROM MATCHD_CNSMR_PRSNA GROUP BY 1) A
ON TOUT.HSHLD_PRSNA_ID = A.HSHLD_PRSNA_ID
QUALIFY RANK() OVER(PARTITION BY TOUT.MATCHD_CNSMR_PRSNA_ID, TOUT.HSHLD_PRSNA_ID 
ORDER BY LEGAL_ENT_NBR, STG.PRSNA_REG_DT DESC, TOUT.HSHLD_PRSNA_ID DESC, STG.SYS_CREATION_DATE DESC, STG.SYS_SOURCE DESC,STG.SYS_NC_TYPE DESC, STG.USER_NAME DESC  ) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO REGIS_PRSNA  
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,MATCHD_CNSMR_PRSNA_ID
,REFERAL_MKTNG_PGM_NBR
,TRM_LEAD_KEY
,NAME_PREFX_TXT
,GVN_NAME
,MID_NAME
,FAMLY_NAME
,NAME_SUFFX_TXT
,FULL_NAME
,GENDR_IND
,BRTH_DATE
,LANG_CODE
,CNTRY_CODE
,EMAIL_SUPRSN_IND
,PHONE_SUPRSN_IND
,POSTL_SUPRSN_IND
,SOCL_NETWK_SUPRSN_IND
,LATST_ACTVY_DATE
,REGIS_CNSMR_ID_VAL
,CNSMR_USER_NAME
,REGIS_DATE
,PRSNA_STATUS_CODE
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE                                                                  
,SYS_ERR_SVRTY) 
SELECT *
FROM
(SELECT
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.MATCHD_CNSMR_PRSNA_ID
,'' REFERAL_MKTNG_PGM_NBR
,'' TRM_LEAD_KEY
,STG.NAME_PREFX_TXT
,STG.GVN_NAME
,STG.MID_NAME
,STG.FAMLY_NAME
,STG.NAME_SUFFX_TXT
,STG.FULL_NAME
,STG.GENDR_IND
,STG.BRTH_DATE
,STG.LANG_CODE
,STG.CNTRY_CODE
,'' EMAIL_SUPRSN_IND
,'' PHONE_SUPRSN_IND
,'' POSTL_SUPRSN_IND
,'' SOCL_NETWK_SUPRSN_IND
,STG.PRSNA_REG_DT LATST_ACTVY_DATE
,TOUT.REGIS_CNSMR_ID_VAL
,STG.USER_NAME
,STG.PRSNA_REG_DT
,'ACTIVATED' PRSNA_STATUS_CODE
,TOUT.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE                                                                  
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND REGIS_PRSNA_ID NOT IN (SELECT REGIS_PRSNA_ID
FROM REGIS_PRSNA
GROUP BY 1)
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO MATCHD_CNSMR_POSTL_ADDR
(MATCHD_CNSMR_PRSNA_ID
,LEGAL_ENT_NBR
,CNTCT_POINT_CATEG_CODE
,VALID_CNTCT_POINT_IND
,PREF_CNTCT_POINT_IND
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,LAT_MEAS
,LONG_MEAS
,TERR_CODE
,CNTRY_CODE
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE
,SYS_ERR_SVRTY)
SELECT *
FROM
(SELECT 
TOUT.MATCHD_CNSMR_PRSNA_ID
,TOUT.LEGAL_ENT_NBR
,STG.CNTCT_POINT_CATEG_CODE
,STG.VALID_IND  VALID_CNTCT_POINT_IND
,STG.PREFR_IND
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.STRET_NUM
,STG.STRET_NAME
,STG.APT_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,'' LAT_MEAS
,'' LONG_MEAS
,STG.TERR_NAME
,STG.CNTRY_NAME
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND (TOUT.MATCHD_CNSMR_PRSNA_ID,CNTCT_POINT_CATEG_CODE) NOT IN (SELECT TRIM(MATCHD_CNSMR_PRSNA_ID),CNTCT_POINT_CATEG_CODE
FROM MATCHD_CNSMR_POSTL_ADDR GROUP BY 1,2)
QUALIFY RANK() OVER(PARTITION BY TOUT.MATCHD_CNSMR_PRSNA_ID,STG.CNTCT_POINT_CATEG_CODE
ORDER BY LEGAL_ENT_NBR, TOUT.HSHLD_PRSNA_ID DESC, STG.SYS_CREATION_DATE DESC, STG.SYS_SOURCE DESC,STG.SYS_NC_TYPE DESC  ) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM REGIS_PRSNA_POSTL_ADDR WHERE
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR)
IN
(
SELECT 
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
FROM
TSS_ERR_PRCS TOUT
GROUP BY 1,2,3);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM REGIS_PRSNA_PHONE WHERE
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR)
IN
(
SELECT 
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
FROM
TSS_ERR_PRCS TOUT
GROUP BY 1,2,3);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM REGIS_PRSNA_EMAIL_ADDR WHERE
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR)
IN
(
SELECT 
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
FROM
TSS_ERR_PRCS TOUT
GROUP BY 1,2,3);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

DELETE FROM REGIS_PRSNA_SOC_NET_ACCT WHERE
(REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR)
IN
(
SELECT 
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
FROM
TSS_ERR_PRCS TOUT
GROUP BY 1,2,3);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO REGIS_PRSNA_POSTL_ADDR
(
 CNTCT_POINT_CATEG_CODE
,REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,WIN_KEY
,SUBSCRPTN_OPT_NBR
,SUBSCRPTN_OPT_IND
,CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,TERR_CODE
,CNTRY_CODE
,LAT_MEAS
,LONG_MEAS
,VALID_CNTCT_POINT_IND
,GUARDN_NAME
,GUARDN_EMAIL_ADDR_TXT
,GUARDN_CNSNT_IND
,ACNLGMT_DATE
,PR_REV_GROUP
,PR_GEOCODE_FAIL
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE 
,SYS_ERR_SVRTY)
SELECT *
FROM
(SELECT
STG.CNTCT_POINT_CATEG_CODE
,TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,'' WINDOW_KEY_01
,STG.CNTCT_OPTN_NBR
,STG.CNTCT_OPTN_IND
,STG.CNSMR_CHCE_DATETM
,STG.PREFR_IND
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.STRET_NUM
,STG.STRET_NAME
,STG.APT_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,TERR_NAME
,CNTRY_NAME
,'' LAT_MEAS
,'' LONG_MEAS
,STG.VALID_IND  VALID_CNTCT_POINT_IND
,STG.GUARDN_NAME
,STG.GUARDN_EMAIL_ADDR_TXT
,STG.GUARDN_CNSNT_IND
,STG.ACNLGMT_DATE
,'' PR_REV_GROUP
,'' PR_REV_GROUP1
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR,TOUT.REGIS_PRSNA_ID,STG.CNTCT_OPTN_NBR
ORDER BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR   
,TOUT.REGIS_CNSMR_ID_VAL
,STG.SYS_CREATION_DATE DESC
,STG.SYS_SOURCE DESC
,STG.SYS_NC_TYPE DESC
,STG.CNTCT_POINT_CATEG_CODE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36,37,38,39,40;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS REGIS_PRSNA_PHONE 
(
CNTCT_POINT_CATEG_CODE        ,
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
SUBSCRPTN_OPT_NBR             ,
SUBSCRPTN_OPT_IND             ,
CNSMR_CHCE_DATETM             ,
PREF_CNTCT_POINT_IND          ,
PHONE_CNTRY_NBR               ,
PHONE_AREA_NBR                ,
PHONE_EXCHG_NBR               ,
PHONE_LINE_NBR                ,
PHONE_EXTSN_NUM               ,
FULL_PHONE_NUM                ,
SMS_PREFR_IND                 ,
SMS_AVAIL_START_TIME          ,
SMS_AVAIL_END_TIME            ,
VALID_CNTCT_POINT_IND         ,
GUARDN_NAME                   ,
GUARDN_EMAIL_ADDR_TXT         ,
GUARDN_CNSNT_IND              ,
ACNLGMT_DATE                  ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM
(SELECT
A.CNTCT_POINT_CATEG_CODE        ,
--B.REFERENCE_REGISTRATIONKEY                ,
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.CNTCT_OPTN_NBR             ,
A.CNTCT_OPTN_IND             ,
CAST(A.CNSMR_CHCE_DATETM   AS TIMESTAMP(6))     CNSMR_CHCE_DATETM    ,
A.PREFR_IND          ,
A.PHONE_CNTRY_NBR               ,
A.PHONE_AREA_NBR                ,
A.PHONE_EXCHG_NBR               ,
A.PHONE_LINE_NBR                ,
A.PHONE_EXTSN_NUM               ,
A.FULL_PHONE_NUM                ,
A.SMS_PREFR_IND                 ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_START_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)     SMS_AVAIL_START_TIME     ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_END_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)      SMS_AVAIL_END_TIME    ,
A.VALID_IND         ,
A.GUARDN_NAME                   ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.GUARDN_CNSNT_IND              ,
A.ACNLGMT_DATE                  ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_PHONE_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE,A.CNTCT_OPTN_NBR     
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS REGIS_PRSNA_EMAIL_ADDR 
(
CNTCT_POINT_CATEG_CODE        ,
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
SUBSCRPTN_OPT_NBR             ,
SUBSCRPTN_OPT_IND             ,
CNSMR_CHCE_DATETM             ,
PREF_CNTCT_POINT_IND          ,
EMAIL_ADDR_TXT                ,
EMAIL_FORMT_CODE              ,
VALID_CNTCT_POINT_IND         ,
GUARDN_NAME                   ,
GUARDN_EMAIL_ADDR_TXT         ,
GUARDN_CNSNT_IND              ,
ACNLGMT_DATE                  ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM
(SELECT 
A.CNTCT_POINT_CATEG_CODE        ,
--B.REFERENCE_REGISTRATIONKEY                ,
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.CNTCT_OPTN_NBR             ,
A.CNTCT_OPTN_IND             ,
CAST(A.CNSMR_CHCE_DATETM   AS TIMESTAMP(6))  CNSMR_CHCE_DATETM       ,
A.PREFR_IND          ,
A.EMAIL_ADDR_TXT                ,
A.EMAIL_FORMT_CODE              ,
A.VALID_IND         ,
A.GUARDN_NAME                   ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.GUARDN_CNSNT_IND              ,
A.ACNLGMT_DATE                  ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_EMAIL_ADDR_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE,A.CNTCT_OPTN_NBR  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS REGIS_PRSNA_SOC_NET_ACCT 
(
CNTCT_POINT_CATEG_CODE        ,
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
SUBSCRPTN_OPT_NBR             ,
SUBSCRPTN_OPT_IND             ,
CNSMR_CHCE_DATETM             ,
PREF_CNTCT_POINT_IND          ,
SOCIAL_NETWK_ACCT_ID_VAL      ,
VALID_CNTCT_POINT_IND         ,
GUARDN_NAME                   ,
GUARDN_EMAIL_ADDR_TXT         ,
GUARDN_CNSNT_IND              ,
ACNLGMT_DATE                  ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM 
(SELECT
A.CNTCT_POINT_CATEG_CODE        ,
--B.REFERENCE_REGISTRATIONKEY                ,
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.CNTCT_OPTN_NBR             ,
A.CNTCT_OPTN_IND             ,
CAST(A.CNSMR_CHCE_DATETM   AS TIMESTAMP(6))  CNSMR_CHCE_DATETM       ,
A.PREFR_IND          ,
A.SOCIAL_NETWK_ACCT_ID_VAL      ,
A.VALID_IND         ,
A.GUARDN_NAME                   ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.GUARDN_CNSNT_IND              ,
A.ACNLGMT_DATE                  ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_SOC_NETWK_ACCT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE,A.CNTCT_OPTN_NBR  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

/*
INSERT INTO PRSNA_POSTL_ADDR_ORIG
(
 REGIS_PRSNA_ID
,MKTNG_PGM_NBR
,LEGAL_ENT_NBR
,REGIS_CNSMR_ID_VAL
,ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT
,STRET_NUM
,STRET_NAME
,APT_NUM
,PO_BOX_NUM
,CITY_NAME
,POSTL_AREA_CODE
,TERR_CODE
,CNTRY_CODE
,GUARDN_EMAIL_ADDR_TXT
,CNTCT_POINT_CATEG_CODE
,GUARDN_NAME
,GUARDN_CNSNT_IND
,ACNLGMT_DATE
,SUBSCRPTN_OPT_NBR
,SUBSCRPTN_OPT_IND
,CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND
,VALID_CNTCT_POINT_IND
,SYS_SOURCE
,SYS_TARGET_ID
,SYS_AUTH_ID
,SYS_CREATED_BY
,SYS_CREATION_DATE
,SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE
,SYS_ERR_CODE 
,SYS_ERR_SVRTY)
SELECT *
FROM
(SELECT
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.REGIS_CNSMR_ID_VAL
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.STRET_NUM
,STG.STRET_NAME
,STG.APT_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,STG.TERR_NAME
,STG.CNTRY_NAME
,STG.GUARDN_EMAIL_ADDR_TXT
,STG.CNTCT_POINT_CATEG_CODE
,STG.GUARDN_NAME
,STG.GUARDN_CNSNT_IND
,STG.ACNLGMT_DATE
,STG.CNTCT_OPTN_NBR
,STG.CNTCT_OPTN_IND
,STG.CNSMR_CHCE_DATETM
,STG.PREFR_IND
,STG.VALID_IND
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
AND REGIS_PRSNA_ID NOT IN (SELECT REGIS_PRSNA_ID
FROM PRSNA_POSTL_ADDR_ORIG
GROUP BY 1)
QUALIFY RANK() OVER (PARTITION BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR,TOUT.REGIS_CNSMR_ID_VAL,STG.CNTCT_POINT_CATEG_CODE  
ORDER BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR   
,TOUT.REGIS_CNSMR_ID_VAL
,STG.SYS_CREATION_DATE DESC
,STG.SYS_SOURCE DESC
,STG.SYS_NC_TYPE DESC
,STG.CNTCT_OPTN_NBR DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PRSNA_PHONE_ORIG 
(
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
REGIS_CNSMR_ID_VAL            ,
PHONE_CNTRY_NBR               ,
PHONE_AREA_NBR                ,
PHONE_EXCHG_NBR               ,
PHONE_LINE_NBR                ,
PHONE_EXTSN_NUM               ,
FULL_PHONE_NUM                ,
GUARDN_EMAIL_ADDR_TXT         ,
CNTCT_POINT_CATEG_CODE,
GUARDN_NAME,
GUARDN_CNSNT_IND,
ACNLGMT_DATE,
SUBSCRPTN_OPT_NBR,
SUBSCRPTN_OPT_IND,
CNSMR_CHCE_DATETM,
PREF_CNTCT_POINT_IND,
VALID_CNTCT_POINT_IND,
SMS_PREFR_IND                 ,
SMS_AVAIL_START_TIME          ,
SMS_AVAIL_END_TIME            ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM
(SELECT
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.PHONE_CNTRY_NBR               ,
A.PHONE_AREA_NBR                ,
A.PHONE_EXCHG_NBR               ,
A.PHONE_LINE_NBR                ,
A.PHONE_EXTSN_NUM               ,
A.FULL_PHONE_NUM              ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
A.GUARDN_NAME,
A.GUARDN_CNSNT_IND,
A.ACNLGMT_DATE,
A.CNTCT_OPTN_NBR,
A.CNTCT_OPTN_IND,
A.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.SMS_PREFR_IND                 ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_START_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)     SMS_AVAIL_START_TIME     ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_END_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)      SMS_AVAIL_END_TIME    ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_PHONE_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(REGIS_PRSNA_ID,FULL_PHONE_NUM) NOT IN (SELECT REGIS_PRSNA_ID,FULL_PHONE_NUM
FROM PRSNA_PHONE_ORIG
GROUP BY 1,2)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE 
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.FULL_PHONE_NUM DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PRSNA_EMAIL_ADDR_ORIG 
(
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
REGIS_CNSMR_ID_VAL             ,
EMAIL_ADDR_TXT                ,
GUARDN_EMAIL_ADDR_TXT         ,
CNTCT_POINT_CATEG_CODE,
GUARDN_NAME,
GUARDN_CNSNT_IND,
ACNLGMT_DATE,
SUBSCRPTN_OPT_NBR,
SUBSCRPTN_OPT_IND,
CNSMR_CHCE_DATETM,
PREF_CNTCT_POINT_IND,
VALID_CNTCT_POINT_IND,
EMAIL_FORMT_CODE              ,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM
(SELECT 
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.EMAIL_ADDR_TXT                ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
A.GUARDN_NAME,
A.GUARDN_CNSNT_IND,
A.ACNLGMT_DATE,
A.CNTCT_OPTN_NBR,
A.CNTCT_OPTN_IND,
A.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.EMAIL_FORMT_CODE              ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_EMAIL_ADDR_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(REGIS_PRSNA_ID,EMAIL_ADDR_TXT) NOT IN (SELECT REGIS_PRSNA_ID,EMAIL_ADDR_TXT
FROM PRSNA_EMAIL_ADDR_ORIG
GROUP BY 1,2)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE     
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.EMAIL_ADDR_TXT DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PRSNA_SOC_NET_ACCT_ORIG 
(
REGIS_PRSNA_ID                ,
MKTNG_PGM_NBR                 ,
LEGAL_ENT_NBR                 ,
REGIS_CNSMR_ID_VAL             ,
SOCIAL_NETWK_ACCT_ID_VAL      ,
GUARDN_EMAIL_ADDR_TXT         ,
CNTCT_POINT_CATEG_CODE,
GUARDN_NAME,
GUARDN_CNSNT_IND,
ACNLGMT_DATE,
SUBSCRPTN_OPT_NBR,
SUBSCRPTN_OPT_IND,
CNSMR_CHCE_DATETM,
PREF_CNTCT_POINT_IND,
VALID_CNTCT_POINT_IND,
SYS_SOURCE                    ,
SYS_TARGET_ID                 ,
SYS_AUTH_ID                   ,
SYS_CREATED_BY                ,
SYS_CREATION_DATE             ,
SYS_LAST_MODIFIED_DATE        ,
SYS_ENT_STATE                 ,
SYS_LAST_MODIFIED_BY          ,
SYS_NC_TYPE                   ,
SYS_ERR_CODE                  ,
SYS_ERR_SVRTY                 
)
SELECT *
FROM 
(SELECT
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.SOCIAL_NETWK_ACCT_ID_VAL      ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
A.GUARDN_NAME,
A.GUARDN_CNSNT_IND,
A.ACNLGMT_DATE,
A.CNTCT_OPTN_NBR,
A.CNTCT_OPTN_IND,
A.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_SOC_NETWK_ACCT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(REGIS_PRSNA_ID,SOCIAL_NETWK_ACCT_ID_VAL) NOT IN (SELECT REGIS_PRSNA_ID,SOCIAL_NETWK_ACCT_ID_VAL
FROM PRSNA_SOC_NET_ACCT_ORIG
GROUP BY 1,2)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.CNTCT_POINT_CATEG_CODE   
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.SOCIAL_NETWK_ACCT_ID_VAL DESC
) = 1
) A

GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PRSNA_POSTL_ADDR_ORIG
FROM 
(SELECT *
FROM
(SELECT
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.REGIS_CNSMR_ID_VAL
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.STRET_NUM
,STG.STRET_NAME
,STG.APT_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,STG.TERR_NAME
,STG.CNTRY_NAME
,STG.GUARDN_EMAIL_ADDR_TXT
,STG.CNTCT_POINT_CATEG_CODE
,STG.GUARDN_NAME
,STG.GUARDN_CNSNT_IND
,STG.ACNLGMT_DATE
,STG.CNTCT_OPTN_NBR
,STG.CNTCT_OPTN_IND
,STG.CNSMR_CHCE_DATETM
,STG.PREFR_IND
,STG.VALID_IND
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR,TOUT.REGIS_CNSMR_ID_VAL  
ORDER BY TOUT.LEGAL_ENT_NBR
,TOUT.MKTNG_PGM_NBR   
,TOUT.REGIS_CNSMR_ID_VAL
,STG.SYS_CREATION_DATE DESC
,STG.SYS_SOURCE DESC
,STG.SYS_NC_TYPE DESC
,STG.CNTCT_OPTN_NBR DESC
,STG.CNTCT_POINT_CATEG_CODE DESC
) = 1
) A 
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36) B
SET ADDR_LINE_1_TXT = B.ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT = B.ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT = B.ADDR_LINE_3_TXT
,STRET_NUM = B.STRET_NUM
,STRET_NAME = B.STRET_NAME
,APT_NUM = B.APT_NUM
,PO_BOX_NUM = B.PO_BOX_NUM
,CITY_NAME = B.CITY_NAME
,POSTL_AREA_CODE = B.POSTL_AREA_CODE
,TERR_CODE = B.TERR_NAME
,CNTRY_CODE = B.CNTRY_NAME
,GUARDN_EMAIL_ADDR_TXT = B.GUARDN_EMAIL_ADDR_TXT
,CNTCT_POINT_CATEG_CODE = B.CNTCT_POINT_CATEG_CODE
,GUARDN_NAME = B.GUARDN_NAME
,GUARDN_CNSNT_IND = B.GUARDN_CNSNT_IND
,ACNLGMT_DATE = B.ACNLGMT_DATE
,SUBSCRPTN_OPT_NBR = B.CNTCT_OPTN_NBR
,SUBSCRPTN_OPT_IND = B.CNTCT_OPTN_IND
,CNSMR_CHCE_DATETM = B.CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND = B.PREFR_IND
,VALID_CNTCT_POINT_IND = B.VALID_IND
,SYS_SOURCE = B.SYS_SOURCE
,SYS_TARGET_ID = B.SYS_TARGET_ID
,SYS_AUTH_ID = B.SYS_AUTH_ID
,SYS_CREATED_BY = B.SYS_CREATED_BY
,SYS_LAST_MODIFIED_DATE = B.SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE = B.SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY = B.SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE = B.SYS_NC_TYPE
,SYS_ERR_CODE  = B.SYS_ERR_CODE
,SYS_ERR_SVRTY = B.SYS_ERR_SVRTY

WHERE PRSNA_POSTL_ADDR_ORIG.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PRSNA_POSTL_ADDR_ORIG.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PRSNA_POSTL_ADDR_ORIG.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PRSNA_POSTL_ADDR_ORIG.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PRSNA_PHONE_ORIG 
FROM
(
SELECT *
FROM
(SELECT
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.PHONE_CNTRY_NBR               ,
A.PHONE_AREA_NBR                ,
A.PHONE_EXCHG_NBR               ,
A.PHONE_LINE_NBR                ,
A.PHONE_EXTSN_NUM               ,
A.FULL_PHONE_NUM              ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
A.GUARDN_NAME,
A.GUARDN_CNSNT_IND,
A.ACNLGMT_DATE,
A.CNTCT_OPTN_NBR,
A.CNTCT_OPTN_IND,
A.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.SMS_PREFR_IND                 ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_START_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)     SMS_AVAIL_START_TIME     ,
SUBSTR(CAST(CAST(A.SMS_AVAIL_END_TIME AS TIMESTAMP(6)) AS VARCHAR(19)),12,8)      SMS_AVAIL_END_TIME    ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_PHONE_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.FULL_PHONE_NUM   
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.CNTCT_POINT_CATEG_CODE DESC
,A.CNTCT_OPTN_NBR DESC
,A.FULL_PHONE_NUM DESC
) = 1
) A GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34) B
SET PHONE_CNTRY_NBR = B.PHONE_CNTRY_NBR        
,PHONE_AREA_NBR = B.PHONE_AREA_NBR             
,PHONE_EXCHG_NBR = B.PHONE_EXCHG_NBR            
,PHONE_LINE_NBR = B.PHONE_LINE_NBR             
,PHONE_EXTSN_NUM = B.PHONE_EXTSN_NUM            
,GUARDN_EMAIL_ADDR_TXT = B.GUARDN_EMAIL_ADDR_TXT
,CNTCT_POINT_CATEG_CODE = B.CNTCT_POINT_CATEG_CODE
,GUARDN_NAME = B.GUARDN_NAME
,GUARDN_CNSNT_IND = B.GUARDN_CNSNT_IND
,ACNLGMT_DATE = B.ACNLGMT_DATE
,SUBSCRPTN_OPT_NBR = B.CNTCT_OPTN_NBR
,SUBSCRPTN_OPT_IND = B.CNTCT_OPTN_IND
,CNSMR_CHCE_DATETM = B.CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND = B.PREFR_IND
,VALID_CNTCT_POINT_IND = B.VALID_IND
,SMS_PREFR_IND = B.SMS_PREFR_IND                 
,SMS_AVAIL_START_TIME = B.SMS_AVAIL_START_TIME          
,SMS_AVAIL_END_TIME = B.SMS_AVAIL_END_TIME            
,SYS_SOURCE = B.SYS_SOURCE
,SYS_TARGET_ID = B.SYS_TARGET_ID
,SYS_AUTH_ID = B.SYS_AUTH_ID
,SYS_CREATED_BY = B.SYS_CREATED_BY
,SYS_LAST_MODIFIED_DATE = B.SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE = B.SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY = B.SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE = B.SYS_NC_TYPE
,SYS_ERR_CODE  = B.SYS_ERR_CODE
,SYS_ERR_SVRTY = B.SYS_ERR_SVRTY

WHERE PRSNA_PHONE_ORIG.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PRSNA_PHONE_ORIG.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PRSNA_PHONE_ORIG.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PRSNA_PHONE_ORIG.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
AND PRSNA_PHONE_ORIG.FULL_PHONE_NUM = B.FULL_PHONE_NUM  
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PRSNA_EMAIL_ADDR_ORIG 
FROM
(
SELECT *
FROM
(SELECT 
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.EMAIL_ADDR_TXT                ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
A.GUARDN_NAME,
A.GUARDN_CNSNT_IND,
A.ACNLGMT_DATE,
A.CNTCT_OPTN_NBR,
A.CNTCT_OPTN_IND,
A.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.EMAIL_FORMT_CODE              ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_EMAIL_ADDR_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.EMAIL_ADDR_TXT    
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.CNTCT_POINT_CATEG_CODE DESC
,A.CNTCT_OPTN_NBR DESC
,A.EMAIL_ADDR_TXT DESC
) = 1
) A 
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27) B
SET GUARDN_EMAIL_ADDR_TXT = B.GUARDN_EMAIL_ADDR_TXT
,CNTCT_POINT_CATEG_CODE = B.CNTCT_POINT_CATEG_CODE
,GUARDN_NAME = B.GUARDN_NAME
,GUARDN_CNSNT_IND = B.GUARDN_CNSNT_IND
,ACNLGMT_DATE = B.ACNLGMT_DATE
,SUBSCRPTN_OPT_NBR = B.CNTCT_OPTN_NBR
,SUBSCRPTN_OPT_IND = B.CNTCT_OPTN_IND
,CNSMR_CHCE_DATETM = B.CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND = B.PREFR_IND
,VALID_CNTCT_POINT_IND = B.VALID_IND
,EMAIL_FORMT_CODE = B.EMAIL_FORMT_CODE
,SYS_SOURCE = B.SYS_SOURCE
,SYS_TARGET_ID = B.SYS_TARGET_ID
,SYS_AUTH_ID = B.SYS_AUTH_ID
,SYS_CREATED_BY = B.SYS_CREATED_BY
,SYS_LAST_MODIFIED_DATE = B.SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE = B.SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY = B.SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE = B.SYS_NC_TYPE
,SYS_ERR_CODE  = B.SYS_ERR_CODE
,SYS_ERR_SVRTY = B.SYS_ERR_SVRTY

WHERE PRSNA_EMAIL_ADDR_ORIG.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PRSNA_EMAIL_ADDR_ORIG.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PRSNA_EMAIL_ADDR_ORIG.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PRSNA_EMAIL_ADDR_ORIG.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
AND PRSNA_EMAIL_ADDR_ORIG.EMAIL_ADDR_TXT = B.EMAIL_ADDR_TXT        
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PRSNA_SOC_NET_ACCT_ORIG 
FROM
(
SELECT *
FROM 
(SELECT
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
B.REGIS_CNSMR_ID_VAL             ,
A.SOCIAL_NETWK_ACCT_ID_VAL      ,
A.GUARDN_EMAIL_ADDR_TXT         ,
A.CNTCT_POINT_CATEG_CODE,
A.GUARDN_NAME,
A.GUARDN_CNSNT_IND,
A.ACNLGMT_DATE,
A.CNTCT_OPTN_NBR,
A.CNTCT_OPTN_IND,
A.CNSMR_CHCE_DATETM,
A.PREFR_IND,
A.VALID_IND,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM PRSNA_SOC_NETWK_ACCT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.SOCIAL_NETWK_ACCT_ID_VAL   
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.CNTCT_POINT_CATEG_CODE DESC
,A.CNTCT_OPTN_NBR DESC
,A.SOCIAL_NETWK_ACCT_ID_VAL DESC
) = 1
) A 
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26) B
SET GUARDN_EMAIL_ADDR_TXT = B.GUARDN_EMAIL_ADDR_TXT
,CNTCT_POINT_CATEG_CODE = B.CNTCT_POINT_CATEG_CODE
,GUARDN_NAME = B.GUARDN_NAME
,GUARDN_CNSNT_IND = B.GUARDN_CNSNT_IND
,ACNLGMT_DATE = B.ACNLGMT_DATE
,SUBSCRPTN_OPT_NBR = B.CNTCT_OPTN_NBR
,SUBSCRPTN_OPT_IND = B.CNTCT_OPTN_IND
,CNSMR_CHCE_DATETM = B.CNSMR_CHCE_DATETM
,PREF_CNTCT_POINT_IND = B.PREFR_IND
,VALID_CNTCT_POINT_IND = B.VALID_IND
,SYS_SOURCE = B.SYS_SOURCE
,SYS_TARGET_ID = B.SYS_TARGET_ID
,SYS_AUTH_ID = B.SYS_AUTH_ID
,SYS_CREATED_BY = B.SYS_CREATED_BY
,SYS_LAST_MODIFIED_DATE = B.SYS_LAST_MODIFIED_DATE
,SYS_ENT_STATE = B.SYS_ENT_STATE
,SYS_LAST_MODIFIED_BY = B.SYS_LAST_MODIFIED_BY
,SYS_NC_TYPE = B.SYS_NC_TYPE
,SYS_ERR_CODE  = B.SYS_ERR_CODE
,SYS_ERR_SVRTY = B.SYS_ERR_SVRTY

WHERE PRSNA_SOC_NET_ACCT_ORIG.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PRSNA_SOC_NET_ACCT_ORIG.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PRSNA_SOC_NET_ACCT_ORIG.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PRSNA_SOC_NET_ACCT_ORIG.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL
AND PRSNA_SOC_NET_ACCT_ORIG.SOCIAL_NETWK_ACCT_ID_VAL = B.SOCIAL_NETWK_ACCT_ID_VAL         
;	
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
*/
DEL FROM PRSNA_TRT_WORK ALL;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PRSNA_TRT_WORK 
(
      REGIS_PRSNA_ID ,
      PRSNA_TRT_SEQ_NBR ,
      TRT_NBR ,
      PRSNA_TRT_DATE ,
      PRSNA_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT
      REGIS_PRSNA_ID ,
      PRSNA_TRT_SEQ_NBR ,
      TRT_NBR ,
      PRSNA_TRT_DATE ,
      PRSNA_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
FROM
PRSNA_TRT
WHERE (MKTNG_PGM_NBR,LEGAL_ENT_NBR,REGIS_PRSNA_ID) IN
(SELECT MKTNG_PGM_NBR,LEGAL_ENT_NBR,REGIS_PRSNA_ID
FROM
TSS_ERR_PRCS
GROUP BY 1,2,3
)
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

COLLECT STATS PRSNA_TRT_WORK
COLUMN (LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,TRT_NBR,PRSNA_TRT_SEQ_NBR);
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;  

INS PRSNA_TRT 
(
      REGIS_PRSNA_ID ,
      PRSNA_TRT_SEQ_NBR ,
      TRT_NBR ,
      PRSNA_TRT_DATE ,
      PRSNA_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.PRSNA_TRT_SEQ_NBR,
      A.TRT_NBR,
      A.PRSNA_TRT_DATE,
     CASE WHEN A.PRSNA_TRT_TXT= '' OR A.PRSNA_TRT_TXT IS NULL
     THEN A.PRSNA_TRT_INTEGER
     ELSE A.PRSNA_TRT_TXT
     END PRSNA_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PRSNA_TRT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.TRT_NBR,A.PRSNA_TRT_SEQ_NBR) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,TRT_NBR,PRSNA_TRT_SEQ_NBR
FROM PRSNA_TRT_WORK
GROUP BY 1,2,3,4,5
)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.TRT_NBR,A.PRSNA_TRT_SEQ_NBR  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.PRSNA_TRT_TXT DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PET
(
      REGIS_PRSNA_ID ,
      PET_NAME ,
      PET_GENDR_IND ,
      PET_BRTH_DATE ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      PET_SEQ_NBR,
      PET_AGE_NBR,
--      DECEASED_IND,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.PET_NAME,
      A.PET_GENDR_IND,
      A.PET_BRTH_DATE,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.PET_SEQ_NBR,
      A.PET_AGE_NBR,
--      A.DECEASED_IND,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PET_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.PET_NAME) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,PET_NAME
FROM PET
GROUP BY 1,2,3,4
)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.PET_NAME
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.PET_NAME DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS PET_TRT 
(
      REGIS_PRSNA_ID ,
      PET_TRT_SEQ_NBR ,
      TRT_NBR ,
      PET_TRT_DATE ,
      PET_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      PET_SEQ_NBR,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM
(SELECT 
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.PET_TRT_SEQ_NBR,
      A.TRT_ID,
      A.PET_TRT_DATE,
      A.PET_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.PET_SEQ_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PET_TRT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.PET_SEQ_NBR,A.PET_TRT_SEQ_NBR,A.TRT_ID) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,PET_SEQ_NBR,PET_TRT_SEQ_NBR,TRT_NBR
FROM PET_TRT
GROUP BY 1,2,3,4,5,6
)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.PET_SEQ_NBR,A.PET_TRT_SEQ_NBR,A.TRT_ID  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS DPEND
(
      REGIS_PRSNA_ID ,
      DPEND_TYPE_CODE ,
      DPEND_NAME ,
      DPEND_GENDR_IND ,
      DPEND_BRTH_DATE ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      DPEND_SEQ_NBR,
      DPEND_AGE_NBR,
--      DECEASED_IND,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM 
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.DPEND_TYPE_CODE,
      A.DPEND_NAME,
      A.DPEND_GENDR_IND,
      A.DPEND_BRTH_DATE,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.DPEND_SEQ_NBR,
      A.DPEND_AGE_NBR,
--      A.DECEASED_IND,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM DPEND_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.DPEND_NAME) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,DPEND_NAME
FROM DPEND
GROUP BY 1,2,3,4
)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.DPEND_NAME  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.DPEND_NAME DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INS DPEND_TRT 
(
      REGIS_PRSNA_ID ,
      DPEND_TRT_SEQ_NBR ,
      TRT_NBR ,
      DPEND_TRT_DATE ,
      DPEND_TRT_TXT ,
      MKTNG_PGM_NBR ,
      LEGAL_ENT_NBR ,
      DPEND_SEQ_NBR,
      SYS_SOURCE ,
      SYS_TARGET_ID ,
      SYS_AUTH_ID ,
      SYS_CREATED_BY ,
      SYS_CREATION_DATE ,
      SYS_LAST_MODIFIED_DATE ,
      SYS_ENT_STATE ,
      SYS_LAST_MODIFIED_BY ,
      SYS_NC_TYPE ,
      SYS_ERR_CODE ,
      SYS_ERR_SVRTY 
)
SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.DPEND_TRT_SEQ_NBR,
      A.TRT_NBR,
      A.DPEND_TRT_DATE,
      A.DPEND_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.DPEND_SEQ_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM DPEND_TRT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
WHERE 
(B.LEGAL_ENT_NBR,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.DPEND_TRT_SEQ_NBR,A.TRT_NBR,A.DPEND_SEQ_NBR) NOT IN 
(SEL LEGAL_ENT_NBR,MKTNG_PGM_NBR,REGIS_PRSNA_ID,DPEND_TRT_SEQ_NBR,TRT_NBR,DPEND_SEQ_NBR
FROM DPEND_TRT
GROUP BY 1,2,3,4,5,6
)
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,B.REGIS_CNSMR_ID_VAL,A.DPEND_TRT_SEQ_NBR,A.TRT_NBR,A.DPEND_SEQ_NBR  
ORDER BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR   
,B.REGIS_CNSMR_ID_VAL
,A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PRSNA_TRT 
FROM 
(SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.PRSNA_TRT_SEQ_NBR,
      A.TRT_NBR,
      A.PRSNA_TRT_DATE,
      CASE WHEN A.PRSNA_TRT_TXT= '' OR A.PRSNA_TRT_TXT IS NULL
     THEN A.PRSNA_TRT_INTEGER
     ELSE A.PRSNA_TRT_TXT
     END PRSNA_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PRSNA_TRT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.PRSNA_TRT_SEQ_NBR,A.TRT_NBR
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
,A.PRSNA_TRT_TXT DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18
) B
SET   PRSNA_TRT_DATE=B.PRSNA_TRT_DATE ,
PRSNA_TRT_TXT=B.PRSNA_TRT_TXT ,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE PRSNA_TRT.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PRSNA_TRT.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PRSNA_TRT.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PRSNA_TRT.PRSNA_TRT_SEQ_NBR = B.PRSNA_TRT_SEQ_NBR
AND PRSNA_TRT.TRT_NBR = B.TRT_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PET
FROM
(SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.PET_NAME,
      A.PET_GENDR_IND,
      A.PET_BRTH_DATE,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.PET_SEQ_NBR,
      A.PET_AGE_NBR,
--      A.DECEASED_IND,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PET_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.PET_NAME  
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
) B
SET   PET_SEQ_NBR=B.PET_SEQ_NBR ,
PET_GENDR_IND=B.PET_GENDR_IND ,
PET_BRTH_DATE=B.PET_BRTH_DATE ,
PET_AGE_NBR=B.PET_AGE_NBR,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE PET.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PET.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PET.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PET.PET_NAME = B.PET_NAME
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE PET_TRT 
FROM
(
SELECT *
FROM
(SELECT 
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.PET_TRT_SEQ_NBR,
      A.TRT_ID,
      A.PET_TRT_DATE,
      A.PET_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.PET_SEQ_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM PET_TRT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.PET_TRT_SEQ_NBR,A.TRT_ID,A.PET_SEQ_NBR  
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
) B
SET   PET_TRT_DATE=B.PET_TRT_DATE ,
PET_TRT_TXT=B.PET_TRT_TXT ,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE PET_TRT.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND PET_TRT.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND PET_TRT.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND PET_TRT.PET_SEQ_NBR = B.PET_SEQ_NBR
AND PET_TRT.PET_TRT_SEQ_NBR = B.PET_TRT_SEQ_NBR
AND PET_TRT.TRT_NBR = B.TRT_ID
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE DPEND
FROM
(
SELECT *
FROM 
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.DPEND_TYPE_CODE,
      A.DPEND_NAME,
      A.DPEND_GENDR_IND,
      A.DPEND_BRTH_DATE,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.DPEND_SEQ_NBR,
      A.DPEND_AGE_NBR,
--      A.DECEASED_IND,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM DPEND_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.DPEND_NAME
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
) B
SET   DPEND_TYPE_CODE=B.DPEND_TYPE_CODE ,
DPEND_NAME = B.DPEND_NAME ,
DPEND_GENDR_IND=B.DPEND_GENDR_IND ,
DPEND_BRTH_DATE=B.DPEND_BRTH_DATE ,
DPEND_AGE_NBR=B.DPEND_AGE_NBR,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE DPEND.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND DPEND.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND DPEND.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND DPEND.DPEND_SEQ_NBR=B.DPEND_SEQ_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE DPEND_TRT 
FROM
(
SELECT *
FROM
(SELECT
      --B.REFERENCE_REGISTRATIONKEY,
      B.REGIS_PRSNA_ID,
      A.DPEND_TRT_SEQ_NBR,
      A.TRT_NBR,
      A.DPEND_TRT_DATE,
      A.DPEND_TRT_TXT,
      B.MKTNG_PGM_NBR,
      B.LEGAL_ENT_NBR,
      A.DPEND_SEQ_NBR,
      A.SYS_SOURCE,
      A.SYS_TARGET_ID,
      A.SYS_AUTH_ID,
      A.SYS_CREATED_BY ,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
      CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
      A.SYS_ENT_STATE,
      A.SYS_LAST_MODIFIED_BY,
      A.SYS_NC_TYPE,
      A.SYS_ERR_CODE,
      A.SYS_ERR_SVRTY
FROM DPEND_TRT_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER (PARTITION BY B.LEGAL_ENT_NBR
,B.MKTNG_PGM_NBR,REGIS_PRSNA_ID,A.DPEND_TRT_SEQ_NBR,A.TRT_NBR,A.DPEND_SEQ_NBR  
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC
) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19
) B
SET   DPEND_TRT_DATE=B.DPEND_TRT_DATE ,
DPEND_TRT_TXT=B.DPEND_TRT_TXT ,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE DPEND_TRT.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND DPEND_TRT.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND DPEND_TRT.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND DPEND_TRT.DPEND_SEQ_NBR = B.DPEND_SEQ_NBR
AND DPEND_TRT.DPEND_TRT_SEQ_NBR = B.DPEND_TRT_SEQ_NBR
AND DPEND_TRT.TRT_NBR = B.TRT_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE CNSMR_AFFLTN 
FROM
(
SELECT DISTINCT
A.CNSMR_GRP_NBR                         ,
B.REGIS_PRSNA_ID,
B.MKTNG_PGM_NBR                 ,
B.LEGAL_ENT_NBR                 ,
A.AFFLTN_START_DATE             ,
A.AFFLTN_END_DATE             ,
A.SYS_SOURCE                    ,
A.SYS_TARGET_ID                 ,
A.SYS_AUTH_ID                   ,
A.SYS_CREATED_BY                ,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE,
CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE,
A.SYS_ENT_STATE                 ,
A.SYS_LAST_MODIFIED_BY          ,
A.SYS_NC_TYPE                   ,
A.SYS_ERR_CODE                  ,
A.SYS_ERR_SVRTY 
FROM CNSMR_AFFLTN_STG A
INNER JOIN TSS_ERR_PRCS B
	ON	A.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
	AND	A.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
	AND     A.SYS_SOURCE = B.SYS_SOURCE
QUALIFY RANK() OVER(PARTITION BY REGIS_PRSNA_ID,A.CNSMR_GRP_NBR
ORDER BY A.SYS_CREATION_DATE DESC
,A.SYS_SOURCE DESC
,A.SYS_NC_TYPE DESC  ) = 1
) B
SET   AFFLTN_START_DATE=B.AFFLTN_START_DATE             ,
AFFLTN_END_DATE=B.AFFLTN_END_DATE               ,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE CNSMR_AFFLTN.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND CNSMR_AFFLTN.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND CNSMR_AFFLTN.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND CNSMR_AFFLTN.CNSMR_GRP_NBR = B.CNSMR_GRP_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE MATCHD_CNSMR_POSTL_ADDR
FROM
(
SELECT *
FROM
(SELECT 
TOUT.MATCHD_CNSMR_PRSNA_ID
,TOUT.LEGAL_ENT_NBR
,STG.CNTCT_POINT_CATEG_CODE
,STG.VALID_IND VALID_CNTCT_POINT_IND
,STG.PREFR_IND
,STG.ADDR_LINE_1_TXT
,STG.ADDR_LINE_2_TXT
,STG.ADDR_LINE_3_TXT
,STG.APT_NUM
,STG.STRET_NAME
,STG.STRET_NUM
,STG.PO_BOX_NUM
,STG.CITY_NAME
,STG.POSTL_AREA_CODE
,'' LAT_MEAS
,'' LONG_MEAS
,STG.TERR_NAME
,STG.CNTRY_NAME
,STG.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE 
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_POSTL_ADDR_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
QUALIFY RANK() OVER(PARTITION BY MATCHD_CNSMR_PRSNA_ID,STG.CNTCT_POINT_CATEG_CODE
ORDER BY LEGAL_ENT_NBR, HSHLD_PRSNA_ID DESC,
STG.SYS_CREATION_DATE DESC, STG.SYS_SOURCE DESC,STG.SYS_NC_TYPE DESC
,VALID_CNTCT_POINT_IND DESC) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29
) B
SET VALID_CNTCT_POINT_IND=B.VALID_CNTCT_POINT_IND
,PREF_CNTCT_POINT_IND=B.PREFR_IND
,ADDR_LINE_1_TXT=B.ADDR_LINE_1_TXT
,ADDR_LINE_2_TXT=B.ADDR_LINE_2_TXT
,ADDR_LINE_3_TXT=B.ADDR_LINE_3_TXT
,STRET_NUM=B.STRET_NUM
,STRET_NAME=B.STRET_NAME
,APT_NUM=B.APT_NUM
,PO_BOX_NUM=B.PO_BOX_NUM
,CITY_NAME=B.CITY_NAME
,POSTL_AREA_CODE=B.POSTL_AREA_CODE
,LAT_MEAS=B.LAT_MEAS
,LONG_MEAS=B.LONG_MEAS
,TERR_CODE=B.TERR_NAME
,CNTRY_CODE=B.CNTRY_NAME,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE MATCHD_CNSMR_POSTL_ADDR.MATCHD_CNSMR_PRSNA_ID = B.MATCHD_CNSMR_PRSNA_ID
AND MATCHD_CNSMR_POSTL_ADDR.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND MATCHD_CNSMR_POSTL_ADDR.CNTCT_POINT_CATEG_CODE=B.CNTCT_POINT_CATEG_CODE;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE MATCHD_CNSMR_PRSNA  
FROM
(SELECT *
FROM
(SELECT
TRIM(TOUT.MATCHD_CNSMR_PRSNA_ID) MATCHD_CNSMR_PRSNA_ID
,TOUT.LEGAL_ENT_NBR
,TRIM(TOUT.HSHLD_PRSNA_ID) HSHLD_PRSNA_ID
,CASE WHEN RANK() OVER (PARTITION BY TOUT.HSHLD_PRSNA_ID ORDER BY TOUT.HSHLD_PRSNA_ID,MATCHD_CNSMR_PRSNA_ID) = 1
           AND A.HSHLD_PRSNA_ID IS NULL
      THEN 'Y'
      ELSE 'N'
  END AS HEAD_OF_HSHLD_IND
,'' AS UNIVERSAL_OPT_OUT
,STG.NAME_PREFX_TXT
,STG.GVN_NAME
,STG.MID_NAME
,STG.FAMLY_NAME
,STG.NAME_SUFFX_TXT
,STG.FULL_NAME
,STG.GENDR_IND
,STG.BRTH_DATE
,'' AS NOTE_TXT
,STG.PRSNA_REG_DT LATST_ACTVY_DATE
,'ACTIVATED' AS PRSNA_STATUS_CODE
,STG.USER_NAME
,STG.LANG_CODE
,STG.PRSNA_REG_DT
,TOUT.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE                                                                  
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
LEFT OUTER JOIN (SELECT TRIM(HSHLD_PRSNA_ID) AS HSHLD_PRSNA_ID
FROM MATCHD_CNSMR_PRSNA GROUP BY 1) A
ON TOUT.HSHLD_PRSNA_ID = A.HSHLD_PRSNA_ID
QUALIFY RANK() OVER(PARTITION BY MATCHD_CNSMR_PRSNA_ID, TOUT.HSHLD_PRSNA_ID ,LEGAL_ENT_NBR
ORDER BY LEGAL_ENT_NBR, STG.PRSNA_REG_DT DESC, TOUT.REGIS_PRSNA_ID DESC,
TOUT.HSHLD_PRSNA_ID DESC, STG.SYS_CREATION_DATE DESC, STG.SYS_SOURCE DESC, 
STG.SYS_NC_TYPE DESC, STG.USER_NAME DESC 
,STG.FULL_NAME DESC) = 1
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
) B
SET HEAD_OF_HSHLD_IND=B.HEAD_OF_HSHLD_IND
,UNIVERSAL_OPT_OUT=B.UNIVERSAL_OPT_OUT
,NAME_PREFX_TXT=B.NAME_PREFX_TXT
,GVN_NAME=B.GVN_NAME
,MID_NAME=B.MID_NAME
,FAMLY_NAME=B.FAMLY_NAME
,NAME_SUFFX_TXT=B.NAME_SUFFX_TXT
,FULL_NAME=B.FULL_NAME
,GENDR_IND=B.GENDR_IND
,BRTH_DATE=B.BRTH_DATE
,NOTE_TXT=B.NOTE_TXT
,LATST_ACTVY_DATE=B.LATST_ACTVY_DATE
,PRSNA_STATUS_CODE=B.PRSNA_STATUS_CODE
,CNSMR_USER_NAME=B.USER_NAME
,LANG_CODE=B.LANG_CODE
,REGIS_DATE=B.PRSNA_REG_DT,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE MATCHD_CNSMR_PRSNA.MATCHD_CNSMR_PRSNA_ID = B.MATCHD_CNSMR_PRSNA_ID
AND MATCHD_CNSMR_PRSNA.HSHLD_PRSNA_ID = B.HSHLD_PRSNA_ID
AND MATCHD_CNSMR_PRSNA.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

UPDATE REGIS_PRSNA
FROM
( 
SELECT *
FROM
(SELECT
TOUT.REGIS_PRSNA_ID
,TOUT.MKTNG_PGM_NBR
,TOUT.LEGAL_ENT_NBR
,TOUT.MATCHD_CNSMR_PRSNA_ID
,'' REFERAL_MKTNG_PGM_NBR
,'' TRM_LEAD_KEY
,STG.NAME_PREFX_TXT
,STG.GVN_NAME
,STG.MID_NAME
,STG.FAMLY_NAME
,STG.NAME_SUFFX_TXT
,STG.FULL_NAME
,STG.GENDR_IND
,STG.BRTH_DATE
,STG.LANG_CODE
,STG.CNTRY_CODE
,'' EMAIL_SUPRSN_IND
,'' PHONE_SUPRSN_IND
,'' POSTL_SUPRSN_IND
,'' SOCL_NETWK_SUPRSN_IND
,STG.PRSNA_REG_DT LATST_ACTVY_DATE
,TOUT.REGIS_CNSMR_ID_VAL
,STG.USER_NAME
,STG.PRSNA_REG_DT
,'ACTIVATED' PRSNA_STATUS_CODE
,TOUT.SYS_SOURCE
,STG.SYS_TARGET_ID
,STG.SYS_AUTH_ID
,STG.SYS_CREATED_BY
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_CREATION_DATE
,CAST(CAST(CURRENT_TIMESTAMP AS VARCHAR(19)) AS TIMESTAMP(0)) SYS_LAST_MODIFIED_DATE
,STG.SYS_ENT_STATE
,STG.SYS_LAST_MODIFIED_BY
,STG.SYS_NC_TYPE
,STG.SYS_ERR_CODE                                                                  
,STG.SYS_ERR_SVRTY
FROM
TSS_ERR_PRCS TOUT
JOIN
PRSNA_STG STG
ON
TOUT.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
TOUT.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND
TOUT.SYS_SOURCE = STG.SYS_SOURCE
) A
GROUP BY 1,2,3,4,5,6,7,8,9,10
,11,12,13,14,15,16,17,18,19,20
,21,22,23,24,25,26,27,28,29,30
,31,32,33,34,35,36
) B
SET MATCHD_CNSMR_PRSNA_ID=B.MATCHD_CNSMR_PRSNA_ID
,REFERAL_MKTNG_PGM_NBR=B.REFERAL_MKTNG_PGM_NBR
,TRM_LEAD_KEY=B.TRM_LEAD_KEY
,NAME_PREFX_TXT=B.NAME_PREFX_TXT
,GVN_NAME=B.GVN_NAME
,MID_NAME=B.MID_NAME
,FAMLY_NAME=B.FAMLY_NAME
,NAME_SUFFX_TXT=B.NAME_SUFFX_TXT
,FULL_NAME=B.FULL_NAME
,GENDR_IND=B.GENDR_IND
,BRTH_DATE=B.BRTH_DATE
,LANG_CODE=B.LANG_CODE
,CNTRY_CODE=B.CNTRY_CODE
,EMAIL_SUPRSN_IND=B.EMAIL_SUPRSN_IND
,PHONE_SUPRSN_IND=B.PHONE_SUPRSN_IND
,POSTL_SUPRSN_IND=B.POSTL_SUPRSN_IND
,SOCL_NETWK_SUPRSN_IND=B.SOCL_NETWK_SUPRSN_IND
,LATST_ACTVY_DATE=B.LATST_ACTVY_DATE
,REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
,CNSMR_USER_NAME=B.USER_NAME
,PRSNA_STATUS_CODE=B.PRSNA_STATUS_CODE,
SYS_SOURCE=B.SYS_SOURCE ,
SYS_TARGET_ID=B.SYS_TARGET_ID ,
SYS_AUTH_ID=B.SYS_AUTH_ID ,
SYS_CREATED_BY=B.SYS_CREATED_BY ,
SYS_LAST_MODIFIED_DATE=B.SYS_LAST_MODIFIED_DATE ,
SYS_ENT_STATE=B.SYS_ENT_STATE ,
SYS_LAST_MODIFIED_BY=B.SYS_LAST_MODIFIED_BY ,
SYS_NC_TYPE=B.SYS_NC_TYPE ,
SYS_ERR_CODE=B.SYS_ERR_CODE ,
SYS_ERR_SVRTY=B.SYS_ERR_SVRTY 
WHERE REGIS_PRSNA.REGIS_PRSNA_ID = B.REGIS_PRSNA_ID
AND REGIS_PRSNA.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR
AND REGIS_PRSNA.LEGAL_ENT_NBR = B.LEGAL_ENT_NBR
AND REGIS_PRSNA.REGIS_CNSMR_ID_VAL = B.REGIS_CNSMR_ID_VAL;
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
