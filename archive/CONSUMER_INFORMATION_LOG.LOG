Microsoft (R) Windows Script Host Version 5.7
Copyright (C) Microsoft Corporation. All rights reserved.

BTEQ 13.10.00.03 Tue Feb 21 14:18:12 2012
 
+---------+---------+---------+---------+---------+---------+---------+----
/***********************************************************************************************************
SCRIPT:               Consumer Validation.BTEQ 
DESCRIPTION:          This script validates the records received from ETL Staging.
DEPENDENCY:           
INPUT:                ETL Staging
OUTPUT:               MST Staging
ERRORS:
SPECIAL INSTRUCTIONS:

CHANGE LOG:
VERSION              DATE                 AUTHOR                          CHANGES
1.00                 01/21/2011           TERADATA                        INITIAL VERSION
2.00                 08/22/2011           TERADATA                        Change OF Failure-BadFile
3.00                 10/31/2011           TERADATA                        Removal of Deletes as  part of ||elism
***********************************************************************************************************/

.RUN FILE \\10.36.32.4\Teradata\MDM\3.04.01.00\custom\pngrelease3\logon\LOGON.
txt;
+---------+---------+---------+---------+---------+---------+---------+----
.LOGON 10.36.32.14/mdm,

 *** Logon successfully completed.
 *** Teradata Database Release is 13.10.01.01                   
 *** Teradata Database Version is 13.10.01.01                     
 *** Transaction Semantics are BTET.
 *** Session Character Set Name is 'ASCII'.
 
 *** Total elapsed time was 1 second.
 
+---------+---------+---------+---------+---------+---------+---------+----
.SET ERROROUT STDOUT;
 *** Error messages now directed to STDOUT.
+---------+---------+---------+---------+---------+---------+---------+----
.SET SESSION CHARSET 'UTF8';
+---------+---------+---------+---------+---------+---------+---------+----

DATABASE MDM;

 *** New default database accepted. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

SEL LOAD_ID FROM MDM_LOAD_CONTROL
WHERE LOAD_ID NOT IN (SEL LOAD_ID FROM LOAD_INFO);

 *** Query completed. 2 rows found. One column returned. 
 *** Total elapsed time was 1 second.

             LOAD_ID
--------------------
            4077201.
            4077301.

+---------+---------+---------+---------+---------+---------+---------+----
.IF ACTIVITYCOUNT = 0 THEN .QUIT 0
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.LOAD_INFO
(
LOAD_ID,
PROCESS_NAME,
PROCESS_START_TIME,
PROCESS_END_TIME,
STATUS,
SYS_CREATION_DATE,
SYS_LAST_MODIFIED_DATE,
BATCH_ID) 
SELECT
ERR1.LOAD_ID,
'Validations',
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
'In Progress',
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
17682
FROM ICRM_STAGE.PRSNA_STG ERR1
INNER JOIN MDM.MDM_LOAD_CONTROL LOAD
ON ERR1.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN LOAD_INFO LOAD1
ON ERR1.LOAD_ID = LOAD1.LOAD_ID
WHERE LOAD1.LOAD_ID IS NULL
GROUP BY
ERR1.LOAD_ID
;

 *** Insert completed. 2 rows added. 
 *** Total elapsed time was 3 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

CREATE VOLATILE TABLE VALIDATIONS_LOAD_NBR
AS 
(

SELECT LC.LOAD_ID,LC.SOURCE_ID
FROM MDM_LOAD_CONTROL LC

INNER JOIN LOAD_INFO LII
ON LC.LOAD_ID = LII.LOAD_ID
AND LII.PROCESS_NAME='Validations'
AND LII.STATUS = 'In Progress'
GROUP BY 1,2
)
WITH DATA
PRIMARY INDEX ( LOAD_ID )
ON COMMIT PRESERVE ROWS
;

 *** Table has been created. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO REF_EMAIL_DATA_IGNORE
SEL B.EMAIL_ADDR_TXT 
FROM 
(SEL B.EMAIL_ADDR_TXT
FROM
ICRM_STAGE.PRSNA_EMAIL_ADDR_STG B
QUALIFY RANK() OVER (PARTITION BY MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
ORDER BY LOAD_ID DESC,
LOAD_TS DESC,
RECORD_IND DESC
) = 1
) B
GROUP BY 1
HAVING COUNT(*) >= 50
;

 *** Insert completed. No rows added. 
 *** Total elapsed time was one minute and 8 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO REF_PHONE_DATA_IGNORE
SEL B.FULL_PHONE_NUM 
FROM 
(SEL B.FULL_PHONE_NUM
FROM
ICRM_STAGE.PRSNA_PHONE_STG B
QUALIFY RANK() OVER (PARTITION BY MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL
ORDER BY LOAD_ID DESC,
LOAD_TS DESC,
RECORD_IND DESC
) = 1
) B
GROUP BY 1
HAVING COUNT(*) >= 50
;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 39 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO REF_POSTL_DATA_IGNORE
SEL B.WIN_KEY
FROM 
REGIS_PRSNA_POSTL_ADDR B
GROUP BY 1
HAVING COUNT(*) >= 100
;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 13 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

COLLECT STATS REF_POSTL_DATA_IGNORE
COLUMN WINKEY;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----


COLLECT STATS REF_EMAIL_DATA_IGNORE
COLUMN EMAIL_ADDR_TXT;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS REF_PHONE_DATA_IGNORE
COLUMN FULL_PHONE_NUM;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

/* VALIDATION FOR MISSING LEGAL ENTITY NUMBER */ 


INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID, SYS_ERR_CODE)
SELECT
DER.MKTNG_PGM_NBR,
DER.REGIS_CNSMR_ID_VAL,
DER.SOURCE_ID,
DER.LOAD_ID,
'Missing Legal Entity Number in Marketing Program Entity' SYS_ERR_CODE
FROM
(
SELECT 
STG.MKTNG_PGM_NBR,
STG.REGIS_CNSMR_ID_VAL,
LOAD.SOURCE_ID,
STG.LOAD_ID
FROM
ICRM_STAGE.PRSNA_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN MDM.MKTNG_PGM MKTNG_PGM_1
ON STG.MKTNG_PGM_NBR = MKTNG_PGM_1.MKTNG_PGM_NBR
WHERE MKTNG_PGM_1.MKTNG_PGM_NBR IS NULL
GROUP BY 1,2,3,4
)DER;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 3 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----


/* VALIDATION FOR SAME CATEG CODE COMING TWICE */ 


INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DER.MKTNG_PGM_NBR,
DER.REGIS_CNSMR_ID_VAL,
DER.SOURCE_ID,
DER.LOAD_ID,
'Email Address having same Category Code' SYS_ERR_CODE
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
STG.LOAD_ID,
--STG.LOAD_TS,
RECORD_IND,
SOURCE_ID
FROM
ICRM_STAGE.PRSNA_EMAIL_ADDR_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
GROUP BY 1,2,3,4,5,6
HAVING COUNT(*) >1
)DER;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DER1.MKTNG_PGM_NBR,
DER1.REGIS_CNSMR_ID_VAL,
DER1.SOURCE_ID,
DER1.LOAD_ID,
'Phone having same Category Code' SYS_ERR_CODE
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
STG.LOAD_ID,
--STG.LOAD_TS,
RECORD_IND,
SOURCE_ID
FROM
ICRM_STAGE.PRSNA_PHONE_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID 
GROUP BY 1,2,3,4,5,6
HAVING COUNT(*) >1
)DER1;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DER1.MKTNG_PGM_NBR,
DER1.REGIS_CNSMR_ID_VAL,
DER1.SOURCE_ID,
DER1.LOAD_ID,
'Social having same Category Code' SYS_ERR_CODE
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
STG.LOAD_ID,
--STG.LOAD_TS,
RECORD_IND,
SOURCE_ID
FROM
ICRM_STAGE.PRSNA_SOCIAL_NETWK_ACCT_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID 
GROUP BY 1,2,3,4,5,6
HAVING COUNT(*) >1
)DER1;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

/* VALIDATION FOR CHECKING CATEG CODE VALUES FROM ATT VALUES TABLE */

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DER2.MKTNG_PGM_NBR,
DER2.REGIS_CNSMR_ID_VAL,
DER2.SOURCE_ID,
DER2.LOAD_ID,
'Not a Valid Category Code Value for EMAIL' SYS_ERR_CODE
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
STG.LOAD_ID,
LOAD.SOURCE_ID
FROM
ICRM_STAGE.PRSNA_EMAIL_ADDR_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN (
SEL A.AV_CODE  FROM MDM.ATTRIBUTE_VALUES A
INNER JOIN MDM.ATTRIBUTE_VALUES_HIERARCHY C
ON A.AV_ID = C.AV_ID_CHILD
INNER JOIN MDM.ATTRIBUTE_VALUES B
ON C.AV_ID_PARENT = B.AV_ID
AND B.AV_DESCRIPTION='Email Address'
) A
ON STG.CNTCT_POINT_CATEG_CODE = A.AV_CODE
WHERE A.AV_CODE IS NULL
)DER2;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DER3.MKTNG_PGM_NBR,
DER3.REGIS_CNSMR_ID_VAL,
DER3.SOURCE_ID,
DER3.LOAD_ID,
'Not a Valid Category Code Value for PHONE' 
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
STG.LOAD_ID,
LOAD.SOURCE_ID
FROM
ICRM_STAGE.PRSNA_PHONE_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN (
SEL A.AV_CODE  FROM MDM.ATTRIBUTE_VALUES A
INNER JOIN MDM.ATTRIBUTE_VALUES_HIERARCHY C
ON A.AV_ID = C.AV_ID_CHILD
INNER JOIN MDM.ATTRIBUTE_VALUES B
ON C.AV_ID_PARENT = B.AV_ID
AND B.AV_DESCRIPTION='Telephone Number'
) A
ON STG.CNTCT_POINT_CATEG_CODE = A.AV_CODE
WHERE A.AV_CODE IS NULL
)DER3;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DER4.MKTNG_PGM_NBR,
DER4.REGIS_CNSMR_ID_VAL,
DER4.SOURCE_ID,
der4.LOAD_ID,
'Not a Valid Category Code Value for POSTAL' SYS_ERR_CODE
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
stg.LOAD_ID,
LOAD.SOURCE_ID
FROM
ICRM_STAGE.PRSNA_POSTL_ADDR_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN (
SEL A.AV_CODE  FROM MDM.ATTRIBUTE_VALUES A
INNER JOIN MDM.ATTRIBUTE_VALUES_HIERARCHY C
ON A.AV_ID = C.AV_ID_CHILD
INNER JOIN MDM.ATTRIBUTE_VALUES B
ON C.AV_ID_PARENT = B.AV_ID
AND B.AV_DESCRIPTION='Postal Address'
) A
ON STG.CNTCT_POINT_CATEG_CODE = A.AV_CODE
WHERE A.AV_CODE IS NULL
)DER4;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DER4.MKTNG_PGM_NBR,
DER4.REGIS_CNSMR_ID_VAL,
DER4.SOURCE_ID,
der4.LOAD_ID,
'Not a Valid Category Code Value for SOCIAL' SYS_ERR_CODE
FROM
(
SELECT 
MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
stg.LOAD_ID,
LOAD.SOURCE_ID
FROM
ICRM_STAGE.PRSNA_SOCIAL_NETWK_ACCT_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN (
SEL A.AV_CODE  FROM MDM.ATTRIBUTE_VALUES A
INNER JOIN MDM.ATTRIBUTE_VALUES_HIERARCHY C
ON A.AV_ID = C.AV_ID_CHILD
INNER JOIN MDM.ATTRIBUTE_VALUES B
ON C.AV_ID_PARENT = B.AV_ID
AND B.AV_DESCRIPTION='Social Network Account'
) A
ON STG.CNTCT_POINT_CATEG_CODE = A.AV_CODE
WHERE A.AV_CODE IS NULL
)DER4;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

/* RECORDS HAVING MORE THEN TWO POSTAL/EMAIL/PHONE */

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
TEMP.MKTNG_PGM_NBR,
TEMP.REGIS_CNSMR_ID_VAL,
TEMP.SOURCE_ID,
temp.LOAD_ID,
'Too Many Values in Postal' SYS_ERR_CODE
FROM
(SELECT  MKTNG_PGM_NBR
       ,REGIS_CNSMR_ID_VAL
       ,STG.LOAD_ID
     --  ,STG.LOAD_TS
       ,RECORD_IND
       ,LOAD.SOURCE_ID
FROM ICRM_STAGE.PRSNA_POSTL_ADDR_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
GROUP BY 1,2,3,4,5
HAVING COUNT(*) > 2)TEMP;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
TEMP1.MKTNG_PGM_NBR,
TEMP1.REGIS_CNSMR_ID_VAL,
TEMP1.SOURCE_ID,
temp1.LOAD_ID,
'Too Many Values in Phone' SYS_ERR_CODE
FROM
(SELECT  MKTNG_PGM_NBR
       ,REGIS_CNSMR_ID_VAL
       ,STG.LOAD_ID
  --     ,STG.LOAD_TS
       ,RECORD_IND
       ,LOAD.SOURCE_ID
FROM ICRM_STAGE.PRSNA_PHONE_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
GROUP BY 1,2,3,4,5
HAVING COUNT(*) > 3)TEMP1;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
TEMP3.MKTNG_PGM_NBR,
TEMP3.REGIS_CNSMR_ID_VAL,
TEMP3.SOURCE_ID,
temp3.LOAD_ID,
'Too Many Values in Email' SYS_ERR_CODE
FROM
(SELECT  MKTNG_PGM_NBR
       ,REGIS_CNSMR_ID_VAL
       ,STG.LOAD_ID
   --    ,STG.LOAD_TS
       ,RECORD_IND
       ,LOAD.SOURCE_ID
FROM ICRM_STAGE.PRSNA_EMAIL_ADDR_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
GROUP BY 1,2,3,4,5
HAVING COUNT(*) > 3)TEMP3;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----


/* RECORDS WITH INVALID CONTACT INDICATOR */

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
TEMP1.MKTNG_PGM_NBR,
TEMP1.REGIS_CNSMR_ID_VAL,
TEMP1.SOURCE_ID,
temp1.LOAD_ID,
'CNTCT_OPTN_IND NOT VALID' SYS_ERR_CODE
FROM
(
SELECT 
  PRSNA_STG_1.MKTNG_PGM_NBR
 ,PRSNA_STG_1.REGIS_CNSMR_ID_VAL  
 ,PRSNA_STG_1.LOAD_ID
 ,LOAD.SOURCE_ID
FROM ICRM_STAGE.PRSNA_STG PRSNA_STG_1
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON PRSNA_STG_1.LOAD_ID = LOAD.LOAD_ID  
 LEFT OUTER  JOIN ICRM_STAGE.CNTCT_OPTN_CHCE_STG B    
 ON PRSNA_STG_1.MKTNG_PGM_NBR=B.MKTNG_PGM_NBR   
 AND PRSNA_STG_1.REGIS_CNSMR_ID_VAL=B.REGIS_CNSMR_ID_VAL
 AND PRSNA_STG_1.LOAD_ID=B.LOAD_ID
 AND B.CNTCT_POINT_TYPE_CODE IN (sel AV_CODE  from MDM.ATTRIBUTE_VALUES B
                                                    WHERE B.AV_DESCRIPTION
='Email Address'
                                                       OR B.AV_DESCRIPTION
='Telephone Number'
                                                       OR B.AV_DESCRIPTION
='Postal Address'
                                                       OR B.AV_DESCRIPTION
='Social Network Account')
WHERE B.CNTCT_OPTN_IND IS NULL 
)TEMP1
;

 *** Insert completed. No rows added. 
 *** Total elapsed time was one minute and 10 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

/* Failed records for AGE */

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DER5.MKTNG_PGM_NBR,
DER5.REGIS_CNSMR_ID_VAL,
DER5.SOURCE_ID,
der5.LOAD_ID,
'Failed because of Age Validation' SYS_ERR_CODE
FROM
(
   SEL STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL, (CURRENT_DATE - CAST(BRTH
_DATE AS DATE)) YEAR(4) AS age,
   LOAD.SOURCE_ID,stg.LOAD_ID
FROM ICRM_STAGE.PRSNA_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
JOIN
MDM.AGE_MIN_MAX M
ON
STG.CNTRY_NAME = M.country
LEFT OUTER JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
C.MKTNG_PGM_NBR = STG.MKTNG_PGM_NBR
AND
C.REGIS_CNSMR_ID_VAL = STG.REGIS_CNSMR_ID_VAL
AND STG.LOAD_ID = C.LOAD_ID
WHERE
(age >= M.MIN_AGE AND age < M.MAX_AGE
AND
(C.GUARDN_CNSNT_IND IN('N',NULL)
OR
C.GUARDN_NAME IS NULL))
OR
(CURRENT_DATE - CAST(BRTH_DATE AS DATE)) <= 0)DER5
;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 7 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, 
SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DER5.MKTNG_PGM_NBR,
DER5.REGIS_CNSMR_ID_VAL,
DER5.SOURCE_ID,
der5.LOAD_ID,
'No valid contact point' SYS_ERR_CODE
FROM
(
SEL STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL,LOAD.SOURCE_ID,stg.LOAD_ID
FROM ICRM_STAGE.PRSNA_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
 
 LEFT OUTER  JOIN ICRM_STAGE.PRSNA_EMAIL_ADDR_STG B1    
 ON STG.MKTNG_PGM_NBR=B1.MKTNG_PGM_NBR   
 AND STG.REGIS_CNSMR_ID_VAL=B1.REGIS_CNSMR_ID_VAL
 AND     STG.LOAD_ID=B1.LOAD_ID
 AND     STG.RECORD_IND=B1.RECORD_IND
 LEFT OUTER JOIN ICRM_STAGE.PRSNA_PHONE_STG C1    
 ON STG.MKTNG_PGM_NBR=C1.MKTNG_PGM_NBR   
 AND STG.REGIS_CNSMR_ID_VAL=C1.REGIS_CNSMR_ID_VAL
 AND     STG.LOAD_ID=C1.LOAD_ID
 AND     STG.RECORD_IND=C1.RECORD_IND
 LEFT OUTER JOIN ICRM_STAGE.PRSNA_POSTL_ADDR_STG D1    
 ON STG.MKTNG_PGM_NBR=D1.MKTNG_PGM_NBR   
 AND STG.REGIS_CNSMR_ID_VAL=D1.REGIS_CNSMR_ID_VAL  
 AND     STG.LOAD_ID=D1.LOAD_ID
 AND     STG.RECORD_IND=D1.RECORD_IND
 LEFT OUTER JOIN ICRM_STAGE.PRSNA_SOCIAL_NETWK_ACCT_STG E1    
 ON STG.MKTNG_PGM_NBR=E1.MKTNG_PGM_NBR   
 AND STG.REGIS_CNSMR_ID_VAL=E1.REGIS_CNSMR_ID_VAL  
 AND     STG.LOAD_ID=E1.LOAD_ID
 AND     STG.RECORD_IND=E1.RECORD_IND
WHERE B1.MKTNG_PGM_NBR IS NULL
AND C1.MKTNG_PGM_NBR IS NULL
AND D1.MKTNG_PGM_NBR IS NULL
AND E1.MKTNG_PGM_NBR IS NULL
) DER5
;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----


/* New Validation for Marketing Program - Trait Association && Invalid Trait Values*/
/*
INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DISTINCT
DER2.MKTNG_PGM_NBR,
DER2.REGIS_CNSMR_ID_VAL,
DER2.SOURCE_ID,
der2.LOAD_ID,
'Not a Valid Trait number for Marketing Program' SYS_ERR_CODE
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
e.load_id,
LOAD.SOURCE_ID
FROM
ICRM_STAGE.PRSNA_TRT_STG E
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON E.LOAD_ID = LOAD.LOAD_ID

WHERE (E.MKTNG_PGM_NBR, E.TRT_NBR) NOT IN
(
SEL MKTNG_PGM_NBR,TRT_NBR 
FROM MDM.MKTNG_PGM_TRAIT_MAP 
))DER2;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DISTINCT
DER2.MKTNG_PGM_NBR,
DER2.REGIS_CNSMR_ID_VAL,
DER2.SOURCE_ID,
der2.LOAD_ID,
'Not a Valid Trait Text' SYS_ERR_CODE
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
e.LOAD_ID,
LOAD.SOURCE_ID
FROM
ICRM_STAGE.PRSNA_TRT_STG E
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON E.LOAD_ID = LOAD.LOAD_ID

WHERE (COALESCE(E.PRSNA_TRT_TXT,TRIM(CAST(E.PRSNA_TRT_INTEGER AS VARCHAR(100)))),e.TRT_NBR) NOT IN
(
SEL PREDFND_TRT_TXT,TRT_NBR 
FROM MDM.PREDFND_TRT_VAL 
)AND E.PRSNA_TRT_DATE IS NULL)DER2;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;*/
/*
INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DISTINCT
DER2.MKTNG_PGM_NBR,
DER2.REGIS_CNSMR_ID_VAL,
DER2.SOURCE_ID,
der2.LOAD_ID,
'Not a Valid Trait Integer' SYS_ERR_CODE
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
e.LOAD_ID,
LOAD.SOURCE_ID
FROM
ICRM_STAGE.PRSNA_TRT_STG E
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON E.LOAD_ID = LOAD.LOAD_ID

WHERE (TRIM(CAST(E.PRSNA_TRT_INTEGER AS VARCHAR(100))),e.TRT_NBR) NOT IN
(
SEL PREDFND_TRT_TXT,TRT_NBR 
FROM MDM.PREDFND_TRT_VAL 
))DER2;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
*/
/*
INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DISTINCT
DER2.MKTNG_PGM_NBR,
DER2.REGIS_CNSMR_ID_VAL,
DER2.SOURCE_ID,
der2.LOAD_ID,
'Not a Valid Trait Date' SYS_ERR_CODE
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
e.LOAD_ID,
LOAD.SOURCE_ID
FROM
ICRM_STAGE.PRSNA_TRT_STG E
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON E.LOAD_ID = LOAD.LOAD_ID

WHERE (E.PRSNA_TRT_DATE,e.TRT_NBR) NOT IN
(
SEL PREDFND_TRT_DATE,TRT_NBR 
FROM MDM.PREDFND_TRT_VAL 
))DER2;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
*/
/*
INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DISTINCT
DER2.MKTNG_PGM_NBR,
DER2.REGIS_CNSMR_ID_VAL,
DER2.SOURCE_ID,
der2.LOAD_ID,
'Not a Valid Email Option number for Marketing Program' SYS_ERR_CODE
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
e.LOAD_ID,
LOAD.SOURCE_ID
FROM
ICRM_STAGE.PRSNA_EMAIL_ADDR_STG E
INNER JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
E.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
E.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
E.CNTCT_POINT_CATEG_CODE = C.CNTCT_POINT_CATEG_CODE
AND
E.LOAD_ID = C.LOAD_ID
AND
C.CNTCT_POINT_TYPE_CODE='E'
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON E.LOAD_ID = LOAD.LOAD_ID

WHERE (E.MKTNG_PGM_NBR, C.CNTCT_OPTN_NBR)NOT IN
(
SEL MKTNG_PGM_NBR,SUBSCRPTN_OPT_NBR 
FROM MDM.SUBSCRPTN_OPT_TYPE
WHERE CNTCT_CHANL_TYPE_CODE='E'
))DER2;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;



INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_TARGET_ID, LOAD_ID,SYS_ERR_CODE)
SELECT
DISTINCT
DER3.MKTNG_PGM_NBR,
DER3.REGIS_CNSMR_ID_VAL,
DER3.SOURCE_ID,
der3.LOAD_ID,
'Not a Valid Phone Option number for Marketing Program' SYS_ERR_CODE
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
e.LOAD_ID,
LOAD.SOURCE_ID
FROM
ICRM_STAGE.PRSNA_PHONE_STG E
INNER JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
E.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
E.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
E.CNTCT_POINT_CATEG_CODE = C.CNTCT_POINT_CATEG_CODE
AND
E.LOAD_ID = C.LOAD_ID
AND
C.CNTCT_POINT_TYPE_CODE='P'
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON E.LOAD_ID = LOAD.LOAD_ID

WHERE (E.MKTNG_PGM_NBR, C.CNTCT_OPTN_NBR)NOT IN
(
SEL MKTNG_PGM_NBR,SUBSCRPTN_OPT_NBR 
FROM MDM.SUBSCRPTN_OPT_TYPE
WHERE CNTCT_CHANL_TYPE_CODE='P'
))DER3;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;



INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_TARGET_ID,LOAD_ID, SYS_ERR_CODE)
SELECT
DISTINCT
DER4.MKTNG_PGM_NBR,
DER4.REGIS_CNSMR_ID_VAL,
DER4.SOURCE_ID,
der4.LOAD_ID,
'Not a Valid Postal Option number for Marketing Program' SYS_ERR_CODE
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
e.LOAD_ID,
LOAD.SOURCE_ID
FROM
ICRM_STAGE.PRSNA_POSTL_ADDR_STG E
INNER JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
E.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
E.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
E.CNTCT_POINT_CATEG_CODE = C.CNTCT_POINT_CATEG_CODE
AND
E.LOAD_ID = C.LOAD_ID
AND
C.CNTCT_POINT_TYPE_CODE='A'
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON E.LOAD_ID = LOAD.LOAD_ID

WHERE (E.MKTNG_PGM_NBR, C.CNTCT_OPTN_NBR)NOT IN
(
SEL MKTNG_PGM_NBR,SUBSCRPTN_OPT_NBR 
FROM MDM.SUBSCRPTN_OPT_TYPE
WHERE CNTCT_CHANL_TYPE_CODE='A'
))DER4;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL, SYS_TARGET_ID,LOAD_ID, SYS_ERR_CODE)
SELECT
DISTINCT
DER5.MKTNG_PGM_NBR,
DER5.REGIS_CNSMR_ID_VAL,
DER5.SOURCE_ID,
der5.LOAD_ID,
'Not a Valid Social Option number for Marketing Program' SYS_ERR_CODE
FROM
(
SELECT
E.MKTNG_PGM_NBR,
E.REGIS_CNSMR_ID_VAL,
e.LOAD_ID,
LOAD.SOURCE_ID
FROM
ICRM_STAGE.PRSNA_SOCIAL_NETWK_ACCT_STG E
INNER JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
E.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
E.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
E.CNTCT_POINT_CATEG_CODE = C.CNTCT_POINT_CATEG_CODE
AND
E.LOAD_ID = C.LOAD_ID
AND
C.CNTCT_POINT_TYPE_CODE='S'
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON E.LOAD_ID = LOAD.LOAD_ID

WHERE (E.MKTNG_PGM_NBR, C.CNTCT_OPTN_NBR)NOT IN
(
SEL MKTNG_PGM_NBR,SUBSCRPTN_OPT_NBR 
FROM MDM.SUBSCRPTN_OPT_TYPE
WHERE CNTCT_CHANL_TYPE_CODE='S'
))DER5;

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
*/
COLLECT STATS ON MDM.ERR_PRSNA_STG_CURR_LOAD
COLUMN MKTNG_PGM_NBR;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON MDM.ERR_PRSNA_STG_CURR_LOAD
COLUMN REGIS_CNSMR_ID_VAL;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON MDM.ERR_PRSNA_STG_CURR_LOAD
COLUMN (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----


/* UPDATE ERR_PRSNA_STG */

INSERT INTO MDM.ERR_PRSNA_STG_CURR_LOAD
(MKTNG_PGM_NBR
,REGIS_CNSMR_ID_VAL
,USER_NAME
,PRSNA_REG_DT 
,NAME_PREFX_TXT
,GVN_NAME
,MID_NAME
,FAMLY_NAME 
,NAME_SUFFX_TXT
,FULL_NAME
,GENDR_IND
,BRTH_DATE
,LANG_CODE
,PRSNA_STTUS_CODE
,RECORD_IND 
,LYLTY_ACCT_NUM
,LYLTY_PGM_NBR
,LOAD_ID 
,LOAD_TS 
,MDM_LOAD_IND
,SYS_TARGET_ID
,SYS_SOURCE
,SYS_NC_TYPE
,SYS_ERROR_TIME
,SYS_ERR_CODE
,SYS_DOCUMENT
,CNTRY_CODE
)
SELECT DISTINCT
ERR1.MKTNG_PGM_NBR,
ERR1.REGIS_CNSMR_ID_VAL,
ERR1.USER_NAME,
CAST(CAST(ERR1.PRSNA_REG_DT AS VARCHAR(19)) AS TIMESTAMP(0)),
ERR1.NAME_PREFX_TXT,
ERR1.GVN_NAME,
ERR1.MID_NAME,
ERR1.FAMLY_NAME,
ERR1.NAME_SUFFX_TXT,
ERR1.FULL_NAME,
ERR1.GENDR_IND,
ERR1.BRTH_DATE,
ERR1.LANG_CODE,
ERR1.PRSNA_STTUS_CODE,
ERR1.RECORD_IND,
ERR1.LYLTY_ACCT_NUM,
ERR1.LYLTY_PGM_NBR,
ERR1.LOAD_ID,
ERR1.LOAD_TS,
ERR1.MDM_LOAD_IND,
LOAD.SOURCE_ID,
TRIM(CAST(ERR1.LOAD_ID AS INTEGER)),
CASE WHEN (ERR1.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
ERR1.LOAD_TS,
ERR.SYS_ERR_CODE,
ERR.SYS_DOCUMENT,
ERR1.CNTRY_NAME
FROM ICRM_STAGE.PRSNA_STG ERR1
INNER JOIN MDM.VALIDATIONS_LOAD_NBR LOAD
ON ERR1.LOAD_ID = LOAD.LOAD_ID
INNER JOIN MDM.ERR_PRSNA_STG_CURR_LOAD ERR
ON ERR.MKTNG_PGM_NBR = ERR1.MKTNG_PGM_NBR
AND ERR.REGIS_CNSMR_ID_VAL = ERR1.REGIS_CNSMR_ID_VAL
AND ERR.LOAD_ID = ERR1.LOAD_ID
AND ERR.SYS_TARGET_ID = LOAD.SOURCE_ID
;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

DELETE FROM MDM.ERR_PRSNA_STG_CURR_LOAD WHERE SYS_NC_TYPE IS NULL;

 *** Delete completed. No rows removed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

COLLECT STATS ON MDM.ERR_PRSNA_STG_CURR_LOAD
COLUMN MKTNG_PGM_NBR;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON MDM.ERR_PRSNA_STG_CURR_LOAD
COLUMN REGIS_CNSMR_ID_VAL;

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON MDM.ERR_PRSNA_STG_CURR_LOAD
COLUMN (MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

SEL 1
FROM VALIDATIONS_LOAD_NBR A

LEFT OUTER JOIN (SEL LOAD_ID,MKTNG_PGM_NBR,COUNT(DISTINCT REGIS_CNSMR_ID_V
AL) AS STG_CNT
FROM ICRM_STAGE.PRSNA_STG
GROUP BY 1,2
) B
ON A.LOAD_ID = B.LOAD_ID

LEFT OUTER JOIN (SEL LOAD_ID,MKTNG_PGM_NBR,COUNT(DISTINCT REGIS_CNSMR_ID_V
AL) AS ERR_CNT
FROM ERR_PRSNA_STG_CURR_LOAD
GROUP BY 1,2
) C
ON C.LOAD_ID = B.LOAD_ID
AND C.MKTNG_PGM_NBR = B.MKTNG_PGM_NBR

WHERE C.LOAD_ID IS NOT NULL
AND CAST((COALESCE(CAST(ERR_CNT AS DECIMAL(16,4)),0)/COALESCE(CAST(STG_CNT
 AS DECIMAL(16,4)),0)) AS DECIMAL(16,4))*100 >= 100
;

 *** Query completed. No rows found. 
 *** Total elapsed time was 21 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ACTIVITYCOUNT > 0 THEN .GOTO ERR1
+---------+---------+---------+---------+---------+---------+---------+----

/* INSERT INTO MST STAGE */

INSERT INTO MDM.CNSMR_AFFLTN_STG
(
MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
CNSMR_GRP_NBR, 
AFFLTN_START_DATE, 
AFFLTN_END_DATE, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
SYS_TARGET_ID,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.CNSMR_GRP_NBR, 
STG.AFFLTN_START_DATE, 
STG.AFFLTN_END_DATE, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
LOAD.SOURCE_ID,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.CNSMR_AFFLTN_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN MDM.ERR_PRSNA_STG_CURR_LOAD ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
AND
STG.LOAD_ID = ERR.LOAD_ID
WHERE ERR.MKTNG_PGM_NBR IS NULL
QUALIFY RANK() OVER(PARTITION BY STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL,
LOAD.SOURCE_ID
ORDER BY STG.LOAD_ID DESC) = 1;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.DPEND_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
DPEND_SEQ_NBR, 
DPEND_NAME, 
DPEND_GENDR_IND, 
DPEND_BRTH_DATE, 
DPEND_AGE_NBR, 
DPEND_TYPE_CODE, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
SYS_TARGET_ID,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE
)
SELECT
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.DPEND_SEQ_NBR, 
STG.DPEND_NAME, 
STG.DPEND_GENDR_IND, 
STG.DPEND_BRTH_DATE, 
STG.DPEND_AGE_NBR, 
STG.DPEND_TYPE_CODE, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
LOAD.SOURCE_ID,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.DPEND_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN MDM.ERR_PRSNA_STG_CURR_LOAD ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
AND
STG.LOAD_ID = ERR.LOAD_ID
WHERE ERR.MKTNG_PGM_NBR IS NULL
AND EXTRACT(YEAR FROM STG.DPEND_BRTH_DATE) <> 1900
QUALIFY RANK() OVER(PARTITION BY STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL,
LOAD.SOURCE_ID
ORDER BY STG.LOAD_ID DESC) = 1;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.DPEND_TRT_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
DPEND_SEQ_NBR, 
TRT_NBR, 
DPEND_TRT_DATE, 
DPEND_TRT_INTEGER, 
DPEND_TRT_TXT,
DPEND_TRT_SEQ_NBR, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
SYS_TARGET_ID,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE
)
SELECT
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.DPEND_SEQ_NBR, 
STG.TRT_NBR, 
STG.DPEND_TRT_DATE, 
STG.DPEND_TRT_INTEGER, 
STG.DPEND_TRT_TXT,
STG.DPEND_TRT_SEQ_NBR, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND ,
'VALIDATED',
LOAD.SOURCE_ID,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.DPEND_TRT_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN MDM.ERR_PRSNA_STG_CURR_LOAD ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
AND
STG.LOAD_ID = ERR.LOAD_ID
WHERE ERR.MKTNG_PGM_NBR IS NULL
QUALIFY RANK() OVER(PARTITION BY STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL,
LOAD.SOURCE_ID
ORDER BY STG.LOAD_ID DESC) = 1;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.PET_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
PET_SEQ_NBR, 
PET_NAME, 
PET_GENDR_IND, 
PET_BRTH_DATE, 
PET_AGE_NBR, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
SYS_TARGET_ID,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.PET_SEQ_NBR, 
STG.PET_NAME, 
STG.PET_GENDR_IND, 
STG.PET_BRTH_DATE,
STG.PET_AGE_NBR, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
LOAD.SOURCE_ID,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.PET_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN MDM.ERR_PRSNA_STG_CURR_LOAD ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
AND
STG.LOAD_ID = ERR.LOAD_ID
WHERE ERR.MKTNG_PGM_NBR IS NULL
QUALIFY RANK() OVER(PARTITION BY STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL,
LOAD.SOURCE_ID
ORDER BY STG.LOAD_ID DESC) = 1;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.PET_TRT_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
PET_SEQ_NBR, 
TRT_ID, 
PET_TRT_DATE, 
PET_TRT_INTEGRE, 
PET_TRT_TXT, 
PET_TRT_SEQ_NBR, 
RECORD_IND,
SYNC_STATUS,
SYS_TARGET_ID,
SYS_SOURCE
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.PET_SEQ_NBR, 
STG.TRT_ID, 
STG.PET_TRT_DATE, 
STG.PET_TRT_INTEGRE, 
STG.PET_TRT_TXT, 
STG.PET_TRT_SEQ_NBR, 
STG.RECORD_IND,
'VALIDATED',
LOAD.SOURCE_ID,
TRIM(CAST(STG.LOAD_ID AS INTEGER))
FROM ICRM_STAGE.PET_TRT_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN MDM.ERR_PRSNA_STG_CURR_LOAD ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
AND
STG.LOAD_ID = ERR.LOAD_ID
WHERE ERR.MKTNG_PGM_NBR IS NULL
QUALIFY RANK() OVER(PARTITION BY STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL,
LOAD.SOURCE_ID
ORDER BY STG.LOAD_ID DESC) = 1;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.PRSNA_EMAIL_ADDR_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
CNTCT_POINT_CATEG_CODE,
EMAIL_ADDR_TXT, 
EMAIL_FORMT_CODE, 
PREFR_IND, 
VALID_IND, 
RECORD_IND,
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
CNTCT_OPTN_NBR,
CNTCT_OPTN_IND, 
CNSMR_CHCE_DATETM,
GUARDN_NAME, 
GUARDN_EMAIL_ADDR_TXT, 
GUARDN_CNSNT_IND, 
ACNLGMT_DATE,
SYS_TARGET_ID,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE )
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.CNTCT_POINT_CATEG_CODE, 
STG.EMAIL_ADDR_TXT,
STG.EMAIL_FORMT_CODE, 
STG.PREFR_IND, 
STG.VALID_IND, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
C.CNTCT_OPTN_NBR, 
C.CNTCT_OPTN_IND,
CAST(CAST(C.CNSMR_CHCE_DATETM AS VARCHAR(19)) AS TIMESTAMP(0)), 
C.GUARDN_NAME, 
C.GUARDN_EMAIL_ADDR_TXT, 
C.GUARDN_CNSNT_IND, 
C.ACNLGMT_DATE,
LOAD.SOURCE_ID,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM 
ICRM_STAGE.PRSNA_EMAIL_ADDR_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
STG.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
STG.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
AND
STG.LOAD_ID = C.LOAD_ID
AND
STG.RECORD_IND = C.RECORD_IND
LEFT OUTER JOIN MDM.ERR_PRSNA_STG_CURR_LOAD ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
AND
STG.LOAD_ID = ERR.LOAD_ID
WHERE ERR.MKTNG_PGM_NBR IS NULL
AND (C.CNTCT_POINT_TYPE_CODE IN (sel AV_CODE  from MDM.ATTRIBUTE_VALUES B
WHERE B.AV_DESCRIPTION='Email Address')
OR (C.MKTNG_PGM_NBR IS NULL AND C.REGIS_CNSMR_ID_VAL
 IS NULL))
 QUALIFY RANK() OVER(PARTITION BY STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL
,STG.CNTCT_POINT_CATEG_CODE,LOAD.SOURCE_ID
ORDER BY STG.LOAD_ID DESC
,STG.LOAD_TS DESC
,STG.RECORD_IND DESC  ) = 1;

 *** Insert completed. 26 rows added. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.PRSNA_PHONE_STG
(MKTNG_PGM_NBR,
REGIS_CNSMR_ID_VAL,
CNTCT_POINT_CATEG_CODE,
PHONE_CNTRY_NBR,
PHONE_AREA_NBR,
PHONE_EXCHG_NBR,
PHONE_LINE_NBR,
PHONE_EXTSN_NUM,
FULL_PHONE_NUM,
SMS_PREFR_IND,
SMS_AVAIL_START_TIME,
SMS_AVAIL_END_TIME,
PREFR_IND,
VALID_IND,
RECORD_IND,
LOAD_ID,
LOAD_TS,
MDM_LOAD_IND,
SYNC_STATUS,
CNTCT_OPTN_IND,
CNTCT_OPTN_NBR,
CNSMR_CHCE_DATETM,
GUARDN_NAME,
GUARDN_EMAIL_ADDR_TXT,
GUARDN_CNSNT_IND,
ACNLGMT_DATE,
SYS_TARGET_ID,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE )
SELECT
STG.MKTNG_PGM_NBR,
STG.REGIS_CNSMR_ID_VAL,
STG.CNTCT_POINT_CATEG_CODE,
STG.PHONE_CNTRY_NBR,
STG.PHONE_AREA_NBR,
STG.PHONE_EXCHG_NBR,
STG.PHONE_LINE_NBR,
STG.PHONE_EXTSN_NUM,
STG.FULL_PHONE_NUM,
STG.SMS_PREFR_IND,
CAST(CAST(STG.SMS_AVAIL_START_TIME AS VARCHAR(19)) AS TIMESTAMP(0)),
CAST(CAST(STG.SMS_AVAIL_END_TIME AS VARCHAR(19)) AS TIMESTAMP(0)),
STG.PREFR_IND,
STG.VALID_IND,
STG.RECORD_IND,
STG.LOAD_ID,
STG.LOAD_TS,
STG.MDM_LOAD_IND,
'VALIDATED',
C.CNTCT_OPTN_IND,
C.CNTCT_OPTN_NBR,
CAST(CAST(C.CNSMR_CHCE_DATETM AS VARCHAR(19)) AS TIMESTAMP(0)),
C.GUARDN_NAME,
C.GUARDN_EMAIL_ADDR_TXT,
C.GUARDN_CNSNT_IND,
C.ACNLGMT_DATE,
LOAD.SOURCE_ID,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM
ICRM_STAGE.PRSNA_PHONE_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER  JOIN
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
STG.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
STG.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
AND
STG.LOAD_ID = C.LOAD_ID
AND
STG.RECORD_IND = C.RECORD_IND
LEFT OUTER JOIN MDM.ERR_PRSNA_STG_CURR_LOAD ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
AND
STG.LOAD_ID = ERR.LOAD_ID
WHERE ERR.MKTNG_PGM_NBR IS NULL
AND (C.CNTCT_POINT_TYPE_CODE IN (sel AV_CODE  from MDM.ATTRIBUTE_VALUES B
WHERE B.AV_DESCRIPTION='Telephone Number')
OR (C.MKTNG_PGM_NBR IS NULL AND C.REGIS_CNSMR_ID_VAL
 IS NULL))
 QUALIFY RANK() OVER(PARTITION BY STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL
,STG.CNTCT_POINT_CATEG_CODE,LOAD.SOURCE_ID
ORDER BY STG.LOAD_ID DESC
,STG.LOAD_TS DESC
,STG.RECORD_IND DESC  ) = 1;

 *** Insert completed. 25 rows added. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.PRSNA_POSTL_ADDR_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
CNTCT_POINT_CATEG_CODE,
ADDR_LINE_1_TXT, 
ADDR_LINE_2_TXT, 
ADDR_LINE_3_TXT, 
STRET_NUM,
STRET_NAME, 
APT_NUM, 
PO_BOX_NUM, 
CITY_NAME, 
TERR_NAME, 
POSTL_AREA_CODE,
GEOC_AREA_TYPE_CODE, 
GEOC_AREA_NAME, 
CNTRY_NAME, 
PREFR_IND, 
VALID_IND, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS, 
CNTCT_OPTN_IND,
CNTCT_OPTN_NBR, 
CNSMR_CHCE_DATETM, 
GUARDN_NAME, 
GUARDN_EMAIL_ADDR_TXT,
GUARDN_CNSNT_IND, 
ACNLGMT_DATE,
SYS_TARGET_ID,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE )
SELECT
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.CNTCT_POINT_CATEG_CODE, 
STG.ADDR_LINE_1_TXT,
STG.ADDR_LINE_2_TXT, 
STG.ADDR_LINE_3_TXT, 
STG.STRET_NUM, 
STG.STRET_NAME, 
STG.APT_NUM, 
STG.PO_BOX_NUM, 
STG.CITY_NAME, 
STG.TERR_NAME,
STG.POSTL_AREA_CODE, 
STG.GEOC_AREA_TYPE_CODE, 
STG.GEOC_AREA_NAME, 
STG.CNTRY_NAME, 
STG.PREFR_IND, 
STG.VALID_IND, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
C.CNTCT_OPTN_IND,
C.CNTCT_OPTN_NBR, 
CAST(CAST(C.CNSMR_CHCE_DATETM AS VARCHAR(19)) AS TIMESTAMP(0)), 
C.GUARDN_NAME, 
C.GUARDN_EMAIL_ADDR_TXT, 
C.GUARDN_CNSNT_IND,
C.ACNLGMT_DATE,
LOAD.SOURCE_ID,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM 
ICRM_STAGE.PRSNA_POSTL_ADDR_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN 
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
STG.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
STG.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
AND
STG.LOAD_ID = C.LOAD_ID
AND
STG.RECORD_IND = C.RECORD_IND
LEFT OUTER JOIN MDM.ERR_PRSNA_STG_CURR_LOAD ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
AND
STG.LOAD_ID = ERR.LOAD_ID
WHERE ERR.MKTNG_PGM_NBR IS NULL
AND (C.CNTCT_POINT_TYPE_CODE IN (sel AV_CODE  from MDM.ATTRIBUTE_VALUES B
WHERE B.AV_DESCRIPTION='Postal Address')
OR (C.MKTNG_PGM_NBR IS NULL AND C.REGIS_CNSMR_ID_VAL
 IS NULL))
 QUALIFY RANK() OVER(PARTITION BY STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL
,STG.CNTCT_POINT_CATEG_CODE,LOAD.SOURCE_ID
ORDER BY STG.LOAD_ID DESC
,STG.LOAD_TS DESC
,STG.RECORD_IND DESC  ) = 1;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.PRSNA_SOC_NETWK_ACCT_STG 
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
CNTCT_POINT_CATEG_CODE,   
SOCIAL_NETWK_ACCT_ID_VAL, 
PREFR_IND, 
VALID_IND, 
RECORD_IND, 
LOAD_ID,   
LOAD_TS, 
MDM_LOAD_IND, 
SYNC_STATUS,
CNTCT_OPTN_NBR, 
CNTCT_OPTN_IND, 
CNSMR_CHCE_DATETM,   
GUARDN_NAME, 
GUARDN_EMAIL_ADDR_TXT, 
GUARDN_CNSNT_IND, 
ACNLGMT_DATE,
SYS_TARGET_ID,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE )
SELECT  
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.CNTCT_POINT_CATEG_CODE, 
STG.SOCIAL_NETWK_ACCT_ID_VAL,    
STG.PREFR_IND, 
STG.VALID_IND, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND, 
'VALIDATED',
C.CNTCT_OPTN_NBR, 
C.CNTCT_OPTN_IND,
CAST(CAST(C.CNSMR_CHCE_DATETM AS VARCHAR(19)) AS TIMESTAMP(0)),   
C.GUARDN_NAME, 
C.GUARDN_EMAIL_ADDR_TXT, 
C.GUARDN_CNSNT_IND, 
C.ACNLGMT_DATE,
LOAD.SOURCE_ID,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM 
ICRM_STAGE.PRSNA_SOCIAL_NETWK_ACCT_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN 
ICRM_STAGE.CNTCT_OPTN_CHCE_STG C
ON
STG.MKTNG_PGM_NBR = C.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = C.REGIS_CNSMR_ID_VAL
AND
STG.CNTCT_POINT_CATEG_CODE=C.CNTCT_POINT_CATEG_CODE
AND
STG.LOAD_ID = C.LOAD_ID
AND
STG.RECORD_IND = C.RECORD_IND
LEFT OUTER JOIN MDM.ERR_PRSNA_STG_CURR_LOAD ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
AND
STG.LOAD_ID = ERR.LOAD_ID
WHERE ERR.MKTNG_PGM_NBR IS NULL
AND (C.CNTCT_POINT_TYPE_CODE IN (sel AV_CODE  from MDM.ATTRIBUTE_VALUES B
WHERE B.AV_DESCRIPTION='Social Network Account')
OR (C.MKTNG_PGM_NBR IS NULL AND C.REGIS_CNSMR_ID_VAL
 IS NULL))
 QUALIFY RANK() OVER(PARTITION BY STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL
,STG.CNTCT_POINT_CATEG_CODE,LOAD.SOURCE_ID
ORDER BY STG.LOAD_ID DESC
,STG.LOAD_TS DESC
,STG.RECORD_IND DESC  ) = 1;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.PRSNA_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
USER_NAME, 
PRSNA_REG_DT, 
NAME_PREFX_TXT, 
GVN_NAME, 
MID_NAME, 
FAMLY_NAME, 
NAME_SUFFX_TXT, 
FULL_NAME, 
GENDR_IND, 
BRTH_DATE, 
LANG_CODE, 
PRSNA_STTUS_CODE, 
RECORD_IND,  
LYLTY_ACCT_NUM,
LYLTY_PGM_NBR,
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
SYS_TARGET_ID,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE,
CNTRY_CODE
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.USER_NAME, 
CAST(CAST(STG.PRSNA_REG_DT AS VARCHAR(19)) AS TIMESTAMP(0)), 
STG.NAME_PREFX_TXT, 
STG.GVN_NAME, 
STG.MID_NAME, 
STG.FAMLY_NAME, 
STG.NAME_SUFFX_TXT, 
STG.FULL_NAME, 
STG.GENDR_IND, 
STG.BRTH_DATE, 
STG.LANG_CODE, 
STG.PRSNA_STTUS_CODE, 
STG.RECORD_IND, 
STG.LYLTY_ACCT_NUM,
STG.LYLTY_PGM_NBR,
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
LOAD.SOURCE_ID,
TRIM(CAST(STG.LOAD_ID AS INTEGER)),
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS,
STG.CNTRY_NAME
FROM ICRM_STAGE.PRSNA_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN MDM.ERR_PRSNA_STG_CURR_LOAD ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
AND
STG.LOAD_ID = ERR.LOAD_ID
WHERE ERR.MKTNG_PGM_NBR IS NULL
QUALIFY RANK() OVER(PARTITION BY STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL,
LOAD.SOURCE_ID
ORDER BY STG.LOAD_ID DESC
,STG.LOAD_TS DESC
,STG.RECORD_IND DESC  ) = 1;

 *** Insert completed. 25 rows added. 
 *** Total elapsed time was 3 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.PRSNA_TRT_STG
(MKTNG_PGM_NBR, 
REGIS_CNSMR_ID_VAL, 
TRT_NBR, 
PRSNA_TRT_SEQ_NBR, 
PRSNA_TRT_DATE, 
PRSNA_TRT_INTEGER,
PRSNA_TRT_TXT, 
RECORD_IND, 
LOAD_ID, 
LOAD_TS, 
MDM_LOAD_IND,
SYNC_STATUS,
SYS_TARGET_ID,
SYS_SOURCE,
SYS_NC_TYPE,
SYS_CREATION_DATE
)
SELECT 
STG.MKTNG_PGM_NBR, 
STG.REGIS_CNSMR_ID_VAL, 
STG.TRT_NBR, 
STG.PRSNA_TRT_SEQ_NBR, 
STG.PRSNA_TRT_DATE,  
STG.PRSNA_TRT_INTEGER, 
STG.PRSNA_TRT_TXT, 
STG.RECORD_IND, 
STG.LOAD_ID, 
STG.LOAD_TS, 
STG.MDM_LOAD_IND,
'VALIDATED',
LOAD.SOURCE_ID,
TRIM(CAST(STG.LOAD_ID AS INTEGER))D,
CASE WHEN (STG.RECORD_IND='I')
THEN 'INSERT'
ELSE 'UPDATE'
END,
STG.LOAD_TS
FROM ICRM_STAGE.PRSNA_TRT_STG STG
INNER JOIN
MDM.VALIDATIONS_LOAD_NBR LOAD
ON STG.LOAD_ID = LOAD.LOAD_ID
LEFT OUTER JOIN MDM.ERR_PRSNA_STG_CURR_LOAD ERR
ON
STG.MKTNG_PGM_NBR = ERR.MKTNG_PGM_NBR
AND
STG.REGIS_CNSMR_ID_VAL = ERR.REGIS_CNSMR_ID_VAL
AND
STG.LOAD_ID = ERR.LOAD_ID
WHERE ERR.MKTNG_PGM_NBR IS NULL
QUALIFY RANK() OVER(PARTITION BY STG.MKTNG_PGM_NBR,STG.REGIS_CNSMR_ID_VAL,
LOAD.SOURCE_ID
ORDER BY STG.LOAD_ID DESC) = 1;

 *** Insert completed. No rows added. 
 *** Total elapsed time was 4 seconds.


+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

COLLECT STATS ON ERR_PRSNA_STG COLUMN(MKTNG_PGM_NBR);

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON ERR_PRSNA_STG COLUMN(REGIS_CNSMR_ID_VAL);

 *** Update completed. One row changed. 
 *** Total elapsed time was 30 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON ERR_PRSNA_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);

 *** Update completed. One row changed. 
 *** Total elapsed time was 3 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON ERR_PRSNA_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LOAD
_ID);

 *** Update completed. One row changed. 
 *** Total elapsed time was 3 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON ERR_PRSNA_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,LOAD
_ID,SYS_ERR_CODE);

 *** Update completed. One row changed. 
 *** Total elapsed time was 5 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON CNSMR_AFFLTN_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL);


 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON DPEND_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOUR
CE);

 *** Update completed. One row changed. 
 *** Total elapsed time was 18 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON DPEND_TRT_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_
SOURCE);

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON PET_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOURCE
);

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON PET_TRT_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SO
URCE);

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON PRSNA_EMAIL_ADDR_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_V
AL,SYS_SOURCE);

 *** Update completed. One row changed. 
 *** Total elapsed time was 23 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON PRSNA_PHONE_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SY
S_SOURCE);

 *** Update completed. One row changed. 
 *** Total elapsed time was 11 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON PRSNA_POSTL_ADDR_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_V
AL,SYS_SOURCE);

 *** Update completed. One row changed. 
 *** Total elapsed time was 14 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON PRSNA_SOC_NETWK_ACCT_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_
ID_VAL,SYS_SOURCE);

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON PRSNA_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_SOUR
CE);

 *** Update completed. One row changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
COLLECT STATS ON PRSNA_TRT_STG COLUMN(MKTNG_PGM_NBR,REGIS_CNSMR_ID_VAL,SYS_
SOURCE);

 *** Update completed. One row changed. 
 *** Total elapsed time was 2 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

UPDATE MDM.PRSNA_STG SET GENDR_IND='U'
WHERE GENDR_IND NOT IN ('F','U','M')
OR GENDR_IND IS NULL;

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----
UPDATE MDM.PRSNA_POSTL_ADDR_STG SET PREFR_IND ='Y' 
WHERE PREFR_IND NOT IN ('N','Y')
OR PREFR_IND IS NULL;

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----
UPDATE MDM.PRSNA_POSTL_ADDR_STG SET VALID_IND ='Y' 
WHERE VALID_IND NOT IN ('N','Y')
OR VALID_IND IS NULL;

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----
UPDATE MDM.PRSNA_EMAIL_ADDR_STG SET PREFR_IND ='Y' 
WHERE PREFR_IND NOT IN ('N','Y')
OR PREFR_IND IS NULL;

 *** Update completed. 26 rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----
UPDATE MDM.PRSNA_EMAIL_ADDR_STG SET VALID_IND ='Y' 
WHERE VALID_IND NOT IN ('N','Y')
OR VALID_IND IS NULL;

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----
UPDATE MDM.PRSNA_PHONE_STG SET PREFR_IND ='Y' 
WHERE PREFR_IND NOT IN ('N','Y')
OR PREFR_IND IS NULL;

 *** Update completed. 25 rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----
UPDATE MDM.PRSNA_PHONE_STG SET VALID_IND ='Y' 
WHERE VALID_IND NOT IN ('N','Y')
OR VALID_IND IS NULL;

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----
UPDATE MDM.PRSNA_SOC_NETWK_ACCT_STG SET PREFR_IND ='Y' 
WHERE PREFR_IND NOT IN ('N','Y')
OR PREFR_IND IS NULL;

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----
UPDATE MDM.PRSNA_SOC_NETWK_ACCT_STG SET VALID_IND ='Y' 
WHERE VALID_IND NOT IN ('N','Y')
OR VALID_IND IS NULL;

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

UPDATE MDM.PRSNA_POSTL_ADDR_STG
SET CNTCT_OPTN_IND='I'
WHERE CNTCT_OPTN_IND='Y';

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

UPDATE MDM.PRSNA_EMAIL_ADDR_STG
SET CNTCT_OPTN_IND='I'
WHERE CNTCT_OPTN_IND='Y';

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

UPDATE MDM.PRSNA_PHONE_STG
SET CNTCT_OPTN_IND='I'
WHERE CNTCT_OPTN_IND='Y';

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

UPDATE MDM.PRSNA_SOC_NETWK_ACCT_STG
SET CNTCT_OPTN_IND='I'
WHERE CNTCT_OPTN_IND='Y';

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

UPDATE MDM.PRSNA_POSTL_ADDR_STG
SET CNTCT_OPTN_IND='O'
WHERE CNTCT_OPTN_IND='N';

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

UPDATE MDM.PRSNA_EMAIL_ADDR_STG
SET CNTCT_OPTN_IND='O'
WHERE CNTCT_OPTN_IND='N';

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

UPDATE MDM.PRSNA_PHONE_STG
SET CNTCT_OPTN_IND='O'
WHERE CNTCT_OPTN_IND='N';

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

UPDATE MDM.PRSNA_SOC_NETWK_ACCT_STG
SET CNTCT_OPTN_IND='O'
WHERE CNTCT_OPTN_IND='N';

 *** Update completed. No rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .GOTO EXIT;
+---------+---------+---------+---------+---------+---------+---------+----

.LABEL EXIT
+---------+---------+---------+---------+---------+---------+---------+----

.IF ERRORLEVEL > 4 THEN .GOTO ERR ;
+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL <= 4 THEN .GOTO WARN;
.GOTO WARN;
+---------+---------+---------+---------+---------+---------+---------+----

.LABEL ERR
+---------+---------+---------+---------+---------+---------+---------+----

UPDATE MDM.LOAD_INFO
SET STATUS = 'Failure'
,PROCESS_END_TIME = CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19))
WHERE MDM.LOAD_INFO.PROCESS_NAME='Validations'
AND MDM.LOAD_INFO.STATUS = 'In Progress'
;
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+----

.QUIT 1
 *** Skipped.
+---------+---------+---------+---------+---------+---------+---------+----

.LABEL WARN
+---------+---------+---------+---------+---------+---------+---------+----

UPDATE MDM.LOAD_INFO
SET STATUS = 'Success'
,PROCESS_END_TIME = CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19))
WHERE MDM.LOAD_INFO.PROCESS_NAME='Validations'
AND MDM.LOAD_INFO.STATUS = 'In Progress'
;

 *** Update completed. 2 rows changed. 
 *** Total elapsed time was 1 second.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .QUIT 1;
+---------+---------+---------+---------+---------+---------+---------+----

INSERT INTO MDM.LOAD_INFO
(
LOAD_ID,
PROCESS_NAME,
PROCESS_START_TIME,
PROCESS_END_TIME,
STATUS,
SYS_CREATION_DATE,
SYS_LAST_MODIFIED_DATE,
CNTRY_NAME,
BATCH_ID) 
SELECT
ERR1.LOAD_ID,
'Trillium',
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
'Ready to Process',
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
CAST(CURRENT_TIMESTAMP(0) AS VARCHAR(19)),
CASE WHEN SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3) IN ('
IDN','THA','VNM')
THEN 'OTH'
ELSE SUBSTR(MP.MKTNG_PGM_NAME,INDEX(MP.MKTNG_PGM_NAME,'-')+1,3)
END AS CNTRY,
LI.BATCH_ID
FROM ICRM_STAGE.PRSNA_STG ERR1
INNER JOIN MKTNG_PGM MP
ON ERR1.MKTNG_PGM_NBR = MP.MKTNG_PGM_NBR
INNER JOIN MDM.MDM_LOAD_CONTROL LOAD
ON ERR1.LOAD_ID = LOAD.LOAD_ID
INNER JOIN LOAD_INFO LI
ON LOAD.LOAD_ID = LI.LOAD_ID
AND LI.PROCESS_NAME='Validations'
AND LI.STATUS = 'Success'

LEFT OUTER JOIN LOAD_INFO LII
ON LOAD.LOAD_ID = LII.LOAD_ID
AND LII.PROCESS_NAME='Trillium'

WHERE LII.LOAD_ID IS NULL
GROUP BY
ERR1.LOAD_ID,
CNTRY,
LI.BATCH_ID
;

 *** Insert completed. 2 rows added. 
 *** Total elapsed time was 9 seconds.


+---------+---------+---------+---------+---------+---------+---------+----
.IF ERRORLEVEL > 0 THEN .QUIT 1;
+---------+---------+---------+---------+---------+---------+---------+----

.QUIT 0
 *** You are now logged off from the DBC.
 *** Exiting BTEQ...
 *** RC (return code) = 0 
